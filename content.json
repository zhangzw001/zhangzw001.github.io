{"meta":{"title":"Zhangzw's Blog","subtitle":null,"description":null,"author":"zhangzw","url":"https://blog.k1s.club","root":"/"},"pages":[{},{},{},{}],"posts":[{"title":"go单元测试和性能测试","date":"2020-08-12T08:44:10.000Z","path":"2020/08/12/54-go单元测试和性能测试/","text":"简单记录一下单元测试 和性能测试的例子 首先这里有三个斐波那契的函数 fib.go12345678910111213141516171819202122232425262728func Fib(n int ) int &#123; if n &lt; 2 &#123; return 1 &#125; return Fib(n-2) + Fib(n-1)&#125;func Fib2(n int) int &#123; var f = [3]int&#123;0, 1, 1&#125; for i := 2; i &lt;= n; i++ &#123; f[2] = f[0] + f[1] f[0] = f[1] f[1] = f[2] &#125; return f[2]&#125;func Fib3() func() int &#123; var n,m int return func() int &#123; if n &lt;= 1 &#123; n = 1 &#125; n,m = n+m,n return m &#125;&#125; 先做一个单元测试 fib_test.go123456789101112131415161718func TestFib(t *testing.T) &#123; for i:= 0 ; i &lt; 40 ; i++ &#123; Fib(i) &#125;&#125;func TestFib2(t *testing.T) &#123; for i:= 0 ; i &lt; 90 ; i++ &#123; Fib2(i) &#125;&#125;func TestFib3(t *testing.T) &#123; f3 := Fib3() for i:= 0 ; i &lt; 90 ; i++ &#123; f3()&#125;&#125; 命令行执行 123456789go test -v=== RUN TestFib--- PASS: TestFib (1.34s)=== RUN TestFib2--- PASS: TestFib2 (0.00s)=== RUN TestFib3--- PASS: TestFib3 (0.00s)PASSok 然后性能测试 fib_test.go123456789101112131415161718192021222324func BenchmarkFib(b *testing.B) &#123; for i:=0 ; i &lt; b.N ; i++ &#123; for i:= 0 ; i &lt; 30 ; i++ &#123; Fib(i) &#125; &#125;&#125;func BenchmarkFib2(b *testing.B) &#123; for i:=0 ; i &lt; b.N ; i++ &#123; for i:= 0 ; i &lt; 90 ; i++ &#123; Fib2(i) &#125; &#125;&#125;func BenchmarkFib3(b *testing.B) &#123; f3 := Fib3() for i:=0 ; i &lt; b.N ; i++ &#123; for i:= 0 ; i &lt; 90 ; i++ &#123; f3() &#125; &#125;&#125; 命令行执行 123456789 go test -bench=.goos: darwingoarch: amd64pkg: xxxBenchmarkFib-4 100 10504036 ns/opBenchmarkFib2-4 128184 8989 ns/opBenchmarkFib3-4 3908799 307 ns/opPASSok go.mod使用说明 目录结构 123456├── fib│ ├── fib.go│ ├── fib_test.go│ └── go.mod├── main.go└── go.mod main.go 123456789101112131415161718192021package mainimport ( \"fib\" \"fmt\")func main() &#123; for i :=0 ; i&lt; 40; i++ &#123; fmt.Printf(\"%d,\",fib.Fib(i)) &#125; fmt.Println(\"\") for i :=1 ; i&lt; 90; i++ &#123; fmt.Printf(\"%d,\",fib.Fib2(i)) &#125; fmt.Println(\"\") f3 := fib.Fib3() for i :=1 ; i&lt; 90; i++ &#123; fmt.Printf(\"%d,\",f3()) &#125;&#125; 说明 123451. go版本最好是1.13 (go1.11开始支持)2. 首先 go mod init , 并修改go.mod 增加: replace fib =&gt; ./fib3. 然后进去到fib目录, 执行go mod init 4. 在执行main.go 即可","raw":"---\ntitle: go单元测试和性能测试\ncopyright: true\ndate: 2020-08-12 16:44:10\ntags:\n  - go\ncategories:\n  - [go]\n---\n简单记录一下单元测试 和性能测试的例子\n<!--more-->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n###  首先这里有三个斐波那契的函数 fib.go\n```go\nfunc Fib(n int ) int {\n if n < 2 {\n  return 1\n }\n return Fib(n-2) + Fib(n-1)\n}\n\n\nfunc Fib2(n int) int {\n var f = [3]int{0, 1, 1}\n for i := 2; i <= n; i++ {\n  f[2] = f[0] + f[1]\n  f[0] = f[1]\n  f[1] = f[2]\n }\n return f[2]\n}\n\nfunc Fib3() func() int {\n var n,m int\n return func() int {\n  if n <= 1 {\n   n = 1\n  }\n  n,m = n+m,n\n  return m\n }\n}\n```\n\n\n\n###  先做一个单元测试 fib_test.go\n```go\nfunc TestFib(t *testing.T) {\n for i:= 0 ; i < 40 ; i++ {\n  Fib(i)\n }\n}\n\nfunc TestFib2(t *testing.T) {\n for i:= 0 ; i < 90 ; i++ {\n  Fib2(i)\n }\n}\n\nfunc TestFib3(t *testing.T) {\n f3 := Fib3()\n for i:= 0 ; i < 90 ; i++ {\n  f3()\n}\n}\n```\n\n> 命令行执行\n\n```go\ngo test -v\n=== RUN   TestFib\n--- PASS: TestFib (1.34s)\n=== RUN   TestFib2\n--- PASS: TestFib2 (0.00s)\n=== RUN   TestFib3\n--- PASS: TestFib3 (0.00s)\nPASS\nok\n```\n\n### 然后性能测试 fib_test.go\n```go\nfunc BenchmarkFib(b *testing.B) {\n for i:=0 ; i < b.N ; i++ {\n  for i:= 0 ; i < 30 ; i++ {\n   Fib(i)\n  }\n }\n}\n\nfunc BenchmarkFib2(b *testing.B) {\n for i:=0 ; i < b.N ; i++ {\n  for i:= 0 ; i < 90 ; i++ {\n   Fib2(i)\n  }\n }\n}\n\nfunc BenchmarkFib3(b *testing.B) {\n f3 := Fib3()\n for i:=0 ; i < b.N ; i++ {\n  for i:= 0 ; i < 90 ; i++ {\n   f3()\n  }\n }\n}\n\n```\n\n> 命令行执行\n```sh\n go test -bench=.\ngoos: darwin\ngoarch: amd64\npkg: xxx\nBenchmarkFib-4          100   10504036 ns/op\nBenchmarkFib2-4      128184       8989 ns/op\nBenchmarkFib3-4     3908799        307 ns/op\nPASS\nok\n```\n\n### go.mod使用说明\n\n> 目录结构\n\n```\n├── fib\n│   ├── fib.go\n│   ├── fib_test.go\n│   └── go.mod\n├── main.go\n└── go.mod\n```\n\n> main.go \n```go \npackage main\n\nimport (\n \"fib\"\n \"fmt\"\n)\n\nfunc main() {\n for i :=0 ; i< 40; i++ {\n  fmt.Printf(\"%d,\",fib.Fib(i))\n }\n fmt.Println(\"\")\n for i :=1 ; i< 90; i++ {\n  fmt.Printf(\"%d,\",fib.Fib2(i))\n }\n fmt.Println(\"\")\n f3 := fib.Fib3()\n for i :=1 ; i< 90; i++ {\n  fmt.Printf(\"%d,\",f3())\n }\n}\n```\n\n> 说明\n```\n1. go版本最好是1.13 (go1.11开始支持)\n2. 首先 go mod init , 并修改go.mod\n    增加: replace fib => ./fib\n3. 然后进去到fib目录, 执行go mod init \n4. 在执行main.go 即可\n\n```\n","content":"<p>简单记录一下单元测试 和性能测试的例子</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"首先这里有三个斐波那契的函数-fib-go\"><a href=\"#首先这里有三个斐波那契的函数-fib-go\" class=\"headerlink\" title=\"首先这里有三个斐波那契的函数 fib.go\"></a>首先这里有三个斐波那契的函数 fib.go</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib</span><span class=\"params\">(n <span class=\"keyword\">int</span> )</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> n &lt; <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">return</span> Fib(n<span class=\"number\">-2</span>) + Fib(n<span class=\"number\">-1</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib2</span><span class=\"params\">(n <span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> f = [<span class=\"number\">3</span>]<span class=\"keyword\">int</span>&#123;<span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>&#125;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i := <span class=\"number\">2</span>; i &lt;= n; i++ &#123;</span><br><span class=\"line\">  f[<span class=\"number\">2</span>] = f[<span class=\"number\">0</span>] + f[<span class=\"number\">1</span>]</span><br><span class=\"line\">  f[<span class=\"number\">0</span>] = f[<span class=\"number\">1</span>]</span><br><span class=\"line\">  f[<span class=\"number\">1</span>] = f[<span class=\"number\">2</span>]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">return</span> f[<span class=\"number\">2</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib3</span><span class=\"params\">()</span> <span class=\"title\">func</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> n,m <span class=\"keyword\">int</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> n &lt;= <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">   n = <span class=\"number\">1</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  n,m = n+m,n</span><br><span class=\"line\">  <span class=\"keyword\">return</span> m</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"先做一个单元测试-fib-test-go\"><a href=\"#先做一个单元测试-fib-test-go\" class=\"headerlink\" title=\"先做一个单元测试 fib_test.go\"></a>先做一个单元测试 fib_test.go</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TestFib</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">40</span> ; i++ &#123;</span><br><span class=\"line\">  Fib(i)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TestFib2</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">90</span> ; i++ &#123;</span><br><span class=\"line\">  Fib2(i)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TestFib3</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\"> f3 := Fib3()</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">90</span> ; i++ &#123;</span><br><span class=\"line\">  f3()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>命令行执行</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">go</span> test -v</span><br><span class=\"line\">=== RUN   TestFib</span><br><span class=\"line\">--- PASS: TestFib (<span class=\"number\">1.34</span>s)</span><br><span class=\"line\">=== RUN   TestFib2</span><br><span class=\"line\">--- PASS: TestFib2 (<span class=\"number\">0.00</span>s)</span><br><span class=\"line\">=== RUN   TestFib3</span><br><span class=\"line\">--- PASS: TestFib3 (<span class=\"number\">0.00</span>s)</span><br><span class=\"line\">PASS</span><br><span class=\"line\">ok</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"然后性能测试-fib-test-go\"><a href=\"#然后性能测试-fib-test-go\" class=\"headerlink\" title=\"然后性能测试 fib_test.go\"></a>然后性能测试 fib_test.go</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">BenchmarkFib</span><span class=\"params\">(b *testing.B)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:=<span class=\"number\">0</span> ; i &lt; b.N ; i++ &#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">30</span> ; i++ &#123;</span><br><span class=\"line\">   Fib(i)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">BenchmarkFib2</span><span class=\"params\">(b *testing.B)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:=<span class=\"number\">0</span> ; i &lt; b.N ; i++ &#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">90</span> ; i++ &#123;</span><br><span class=\"line\">   Fib2(i)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">BenchmarkFib3</span><span class=\"params\">(b *testing.B)</span></span> &#123;</span><br><span class=\"line\"> f3 := Fib3()</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i:=<span class=\"number\">0</span> ; i &lt; b.N ; i++ &#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i:= <span class=\"number\">0</span> ; i &lt; <span class=\"number\">90</span> ; i++ &#123;</span><br><span class=\"line\">   f3()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>命令行执行</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> go <span class=\"built_in\">test</span> -bench=.</span><br><span class=\"line\">goos: darwin</span><br><span class=\"line\">goarch: amd64</span><br><span class=\"line\">pkg: xxx</span><br><span class=\"line\">BenchmarkFib-4          100   10504036 ns/op</span><br><span class=\"line\">BenchmarkFib2-4      128184       8989 ns/op</span><br><span class=\"line\">BenchmarkFib3-4     3908799        307 ns/op</span><br><span class=\"line\">PASS</span><br><span class=\"line\">ok</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"go-mod使用说明\"><a href=\"#go-mod使用说明\" class=\"headerlink\" title=\"go.mod使用说明\"></a>go.mod使用说明</h3><blockquote>\n<p>目录结构</p>\n</blockquote>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── <span class=\"built_in\">fib</span></span><br><span class=\"line\">│   ├── <span class=\"built_in\">fib</span>.<span class=\"built_in\">go</span></span><br><span class=\"line\">│   ├── fib_test.<span class=\"built_in\">go</span></span><br><span class=\"line\">│   └── <span class=\"built_in\">go</span>.<span class=\"built_in\">mod</span></span><br><span class=\"line\">├── main.<span class=\"built_in\">go</span></span><br><span class=\"line\">└── <span class=\"built_in\">go</span>.<span class=\"built_in\">mod</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>main.go </p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\"> <span class=\"string\">\"fib\"</span></span><br><span class=\"line\"> <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i :=<span class=\"number\">0</span> ; i&lt; <span class=\"number\">40</span>; i++ &#123;</span><br><span class=\"line\">  fmt.Printf(<span class=\"string\">\"%d,\"</span>,fib.Fib(i))</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> fmt.Println(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i :=<span class=\"number\">1</span> ; i&lt; <span class=\"number\">90</span>; i++ &#123;</span><br><span class=\"line\">  fmt.Printf(<span class=\"string\">\"%d,\"</span>,fib.Fib2(i))</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> fmt.Println(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\"> f3 := fib.Fib3()</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i :=<span class=\"number\">1</span> ; i&lt; <span class=\"number\">90</span>; i++ &#123;</span><br><span class=\"line\">  fmt.Printf(<span class=\"string\">\"%d,\"</span>,f3())</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>说明</p>\n</blockquote>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>. <span class=\"built_in\">go</span>版本最好是<span class=\"number\">1.13</span> (go1.11开始支持)</span><br><span class=\"line\"><span class=\"number\">2</span>. 首先 <span class=\"built_in\">go</span> <span class=\"built_in\">mod</span> init , 并修改<span class=\"built_in\">go</span>.<span class=\"built_in\">mod</span></span><br><span class=\"line\">    增加: replace <span class=\"built_in\">fib</span> =&gt; ./<span class=\"built_in\">fib</span></span><br><span class=\"line\"><span class=\"number\">3</span>. 然后进去到<span class=\"built_in\">fib</span>目录, 执行<span class=\"built_in\">go</span> <span class=\"built_in\">mod</span> init </span><br><span class=\"line\"><span class=\"number\">4</span>. 在执行main.<span class=\"built_in\">go</span> 即可</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/08/12/54-go单元测试和性能测试/","categories":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/categories/go/"}],"tags":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/tags/go/"}]},{"title":"hexo部署到coding.net开启静态网站","date":"2020-08-07T08:00:08.000Z","path":"2020/08/07/53-hexo部署到coding-net开启静态网站/","text":"由于访问github会比较慢,百度抓取问题等, hexo同时部署到coding.net并开启静态网站 首先得有coding.net 网站的账户,并配置自己的公钥 右上角点击 个人账户设置 -&gt; SSH公钥 创建好项目之后, 修改hexo的_config.yml1234567deploy: type: git# repository: git@github.com:zhangzw001/zhangzw001.github.io.git repo: github: git@github.com:zhangzw001/zhangzw001.github.io.git coding: git@e.coding.net:k1s/blog/blog.git branch: master 开启 静态网站 部署功能 点击项目进去 -&gt; 左下角项目设置 -&gt; 功能开关 -&gt; 持续部署 回到项目 持续部署 -&gt; 静态网站 现在将自己的域名绑定到该项目 点击 设置 注意绑定域名前, 先去dns添加一条cname记录(记录值为你的coding-pages.com)","raw":"---\ntitle: hexo部署到coding.net开启静态网站\ncopyright: true\ndate: 2020-08-07 16:00:08\ntags:\n  - hexo6\n  - 特效\ncategories:\n  - [有趣]\n  - [博客,美化]\n---\n由于访问github会比较慢,百度抓取问题等, hexo同时部署到coding.net并开启静态网站\n<!--more-->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 首先得有coding.net 网站的账户,并配置自己的公钥\n\n> 右上角点击 个人账户设置 -> SSH公钥\n\n\n\n### 创建好项目之后, 修改hexo的_config.yml\n```yaml\ndeploy:\n  type: git\n#  repository: git@github.com:zhangzw001/zhangzw001.github.io.git\n  repo:\n    github: git@github.com:zhangzw001/zhangzw001.github.io.git\n    coding: git@e.coding.net:k1s/blog/blog.git\n  branch: master\n```\n\n\n### 开启 静态网站 部署功能\n\n> 点击项目进去 -> 左下角项目设置 -> 功能开关 -> 持续部署\n![](//zhangzw001.github.io/images/53/img1.jpg)\n\n\n> 回到项目 持续部署 -> 静态网站 \n\n![](//zhangzw001.github.io/images/53/img2.jpg)\n\n### 现在将自己的域名绑定到该项目 \n\n> 点击 设置 \n\n![](//zhangzw001.github.io/images/53/img3.jpg)\n\n> 注意绑定域名前, 先去dns添加一条cname记录(记录值为你的coding-pages.com)\n\n![](//zhangzw001.github.io/images/53/img4.jpg)\n\n\n","content":"<p>由于访问github会比较慢,百度抓取问题等, hexo同时部署到coding.net并开启静态网站</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"首先得有coding-net-网站的账户-并配置自己的公钥\"><a href=\"#首先得有coding-net-网站的账户-并配置自己的公钥\" class=\"headerlink\" title=\"首先得有coding.net 网站的账户,并配置自己的公钥\"></a>首先得有coding.net 网站的账户,并配置自己的公钥</h3><blockquote>\n<p>右上角点击 个人账户设置 -&gt; SSH公钥</p>\n</blockquote>\n<h3 id=\"创建好项目之后-修改hexo的-config-yml\"><a href=\"#创建好项目之后-修改hexo的-config-yml\" class=\"headerlink\" title=\"创建好项目之后, 修改hexo的_config.yml\"></a>创建好项目之后, 修改hexo的_config.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">deploy:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">git</span></span><br><span class=\"line\"><span class=\"comment\">#  repository: git@github.com:zhangzw001/zhangzw001.github.io.git</span></span><br><span class=\"line\"><span class=\"attr\">  repo:</span></span><br><span class=\"line\"><span class=\"attr\">    github:</span> <span class=\"string\">git@github.com:zhangzw001/zhangzw001.github.io.git</span></span><br><span class=\"line\"><span class=\"attr\">    coding:</span> <span class=\"string\">git@e.coding.net:k1s/blog/blog.git</span></span><br><span class=\"line\"><span class=\"attr\">  branch:</span> <span class=\"string\">master</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启-静态网站-部署功能\"><a href=\"#开启-静态网站-部署功能\" class=\"headerlink\" title=\"开启 静态网站 部署功能\"></a>开启 静态网站 部署功能</h3><blockquote>\n<p>点击项目进去 -&gt; 左下角项目设置 -&gt; 功能开关 -&gt; 持续部署<br><img src=\"//zhangzw001.github.io/images/53/img1.jpg\" alt></p>\n</blockquote>\n<blockquote>\n<p>回到项目 持续部署 -&gt; 静态网站 </p>\n</blockquote>\n<p><img src=\"//zhangzw001.github.io/images/53/img2.jpg\" alt></p>\n<h3 id=\"现在将自己的域名绑定到该项目\"><a href=\"#现在将自己的域名绑定到该项目\" class=\"headerlink\" title=\"现在将自己的域名绑定到该项目\"></a>现在将自己的域名绑定到该项目</h3><blockquote>\n<p>点击 设置 </p>\n</blockquote>\n<p><img src=\"//zhangzw001.github.io/images/53/img3.jpg\" alt></p>\n<blockquote>\n<p>注意绑定域名前, 先去dns添加一条cname记录(记录值为你的coding-pages.com)</p>\n</blockquote>\n<p><img src=\"//zhangzw001.github.io/images/53/img4.jpg\" alt></p>\n","comments":true,"permalink":"https://blog.k1s.club/2020/08/07/53-hexo部署到coding-net开启静态网站/","categories":[{"name":"有趣","slug":"有趣","permalink":"https://blog.k1s.club/categories/有趣/"},{"name":"博客","slug":"博客","permalink":"https://blog.k1s.club/categories/博客/"},{"name":"美化","slug":"博客/美化","permalink":"https://blog.k1s.club/categories/博客/美化/"}],"tags":[{"name":"hexo6","slug":"hexo6","permalink":"https://blog.k1s.club/tags/hexo6/"},{"name":"特效","slug":"特效","permalink":"https://blog.k1s.club/tags/特效/"}]},{"title":"istio环境下配置nginx+php","date":"2020-08-04T08:22:10.000Z","path":"2020/08/04/52-istio测试nginx-php项目/","text":"将nginx+php的环境结合istio的智能路由功能做一个简单实践 istio中文官方-协议选择 istio中文官方-virtualService 安装部署请参考官方 https://istio.io/latest/zh/docs/setup/getting-started/ 一 部署nginx+php,并设置简单智能路由 环境说明 123451. k8s: 1.15.112. istio: 1.6.73. istio-alpha ns设置了自动注入: kubectl label namespace istio-alpha istio-injection=enabled kubectl get namespaces istio-alpha --show-labels 1.1 安装部署php-fpm1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798apiVersion: apps/v1kind: Deploymentmetadata: name: php-fpm-v1 namespace: istio-alpha labels: app: php-fpm version: v1spec: replicas: 1 selector: matchLabels: app: php-fpm version: v1 template: metadata: labels: app: php-fpm version: v1 spec: containers: - name: app image: hub.xxx.com/bq/php:7.0.13-fpm imagePullPolicy: Always ports: - name: tcp protocol: TCP containerPort: 9000 resources: requests: cpu: \"50m\" limits: cpu: \"100m\" volumeMounts: - name: php-fpm-v1-data mountPath: /webwww volumes: - name: php-fpm-v1-data nfs: server: x.x.x.x path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data ---apiVersion: apps/v1kind: Deploymentmetadata: name: php-fpm-v2 namespace: istio-alpha labels: app: php-fpm version: v2spec: replicas: 1 selector: matchLabels: app: php-fpm version: v2 template: metadata: labels: app: php-fpm version: v2 spec: containers: - name: app image: hub.xxx.com/bq/php:7.0.13-fpm imagePullPolicy: Always ports: - name: tcp protocol: TCP containerPort: 9000 resources: requests: cpu: \"50m\" limits: cpu: \"100m\" volumeMounts: - name: php-fpm-v2-data mountPath: /webwww volumes: - name: php-fpm-v2-data nfs: server: x.x.x.x path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data---apiVersion: v1kind: Servicemetadata: name: php-fpm namespace: istio-alpha labels: app: php-fpmspec: ports: - name: tcp port: 9000 protocol: TCP selector: app: php-fpm 1.2 安装部署nginx123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168apiVersion: apps/v1kind: Deploymentmetadata: name: nginx-v1 labels: app: nginx version: v1 namespace: istio-alphaspec: replicas: 1 selector: matchLabels: app: nginx version: v1 template: metadata: labels: app: nginx version: v1 spec: containers: - name: nginx-v1 image: hub.xxx.com/bq/nginx:1.16 ports: - containerPort: 80 name: http protocol: TCP resources: requests: cpu: \"30m\" limits: cpu: \"100m\" volumeMounts: - name: nginx-www-dev mountPath: /webwww - name: nginx-v1-cm mountPath: /etc/nginx/conf.d/ volumes: - name: nginx-www-dev nfs: server: x.x.x.x path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data - name: nginx-v1-cm configMap: name: nginx-v1-cm---kind: ConfigMapmetadata: name: nginx-v1-cm labels: app: nginx-v1 namespace: istio-alphaapiVersion: v1data: nginx.conf: | server &#123; listen 80 default_server; server_name _; root /webwww/test-v1; add_header \"X\" \"v1\"; location = /50x.html &#123; root html; &#125; location / &#123; index index.php index.html index.htm; &#125; location ~ \\.php$ &#123; fastcgi_pass php-fpm:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param HTTP_HOST $server_name; include fastcgi_params; &#125; &#125;---apiVersion: apps/v1kind: Deploymentmetadata: name: nginx-v2 labels: app: nginx version: v2 namespace: istio-alphaspec: replicas: 1 selector: matchLabels: app: nginx version: v2 template: metadata: labels: app: nginx version: v2 spec: containers: - name: nginx-v2 image: hub.xxx.com/bq/nginx:1.16 ports: - containerPort: 80 name: http protocol: TCP resources: requests: cpu: \"30m\" limits: cpu: \"100m\" volumeMounts: - name: nginx-www-dev mountPath: /webwww - name: nginx-v2-cm mountPath: /etc/nginx/conf.d/ volumes: - name: nginx-www-dev nfs: server: x.x.x.x path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data - name: nginx-v2-cm configMap: name: nginx-v2-cm---kind: ConfigMapmetadata: name: nginx-v2-cm labels: app: nginx-v2 namespace: istio-alphaapiVersion: v1data: nginx.conf: | server &#123; listen 80 default_server; server_name _; root /webwww/test-v2; add_header \"X\" \"v2\"; location = /50x.html &#123; root html; &#125; location / &#123; index index.php index.html index.htm; &#125; location ~ \\.php$ &#123; fastcgi_pass php-fpm:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param HTTP_HOST $server_name; include fastcgi_params; &#125; &#125;---apiVersion: v1kind: Servicemetadata: name: nginx namespace: istio-alpha labels: app: nginxspec: ports: - name: http port: 80 protocol: TCP selector: app: nginx 1.3 配置默认destinationRule1234567891011121314151617181920212223242526272829apiVersion: networking.istio.io/v1alpha3kind: DestinationRulemetadata: name: nginx namespace: istio-alphaspec: host: nginx subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2---apiVersion: networking.istio.io/v1alpha3kind: DestinationRulemetadata: name: php-fpm namespace: istio-alphaspec: host: php-fpm subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 1.4 配置nginx的gateway和VirtualService12345678910111213141516171819202122232425262728293031323334353637383940414243apiVersion: networking.istio.io/v1alpha3kind: Gatewaymetadata: name: nginx-gateway namespace: istio-alphaspec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: nginx-80 protocol: HTTP hosts: - \"*\"---apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata: name: nginx-gateway namespace: istio-alphaspec: hosts: - \"*\" gateways: - nginx-gateway http: - match: - uri: exact: /phpinfo.php route: - destination: host: nginx port: number: 80 subset: v1 weight: 90 - destination: host: nginx port: number: 80 subset: v2 weight: 10 以上配置之后即可在kiali查看 graph 1.5 简单配置流量全部切到v1 或v21234567891011121314151617181920apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata: name: nginx-gateway namespace: istio-alphaspec: hosts: - \"*\" gateways: - nginx-gateway http: - match: - uri: exact: /phpinfo.php route: - destination: host: nginx port: number: 80 subset: v2 当然也可以根据uri match选择不同的路由 1234567891011121314151617181920212223242526272829apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata: name: nginx-gateway namespace: istio-alphaspec: hosts: - \"*\" gateways: - nginx-gateway http: - match: - uri: exact: /phpinfo.php route: - destination: host: nginx port: number: 80 subset: v2 - match: - uri: exact: /a.php route: - destination: host: nginx port: number: 80 subset: v1 1.6 配置php-fpm的virtualService 将流量全部转到 v1版本 1234567891011121314151617apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata: name: php-fpm namespace: istio-alphaspec: hosts: - php-fpm tcp: - match: - port: 9000 route: - destination: host: php-fpm port: number: 9000 subset: v1 将流量分成1:9 123456789101112131415161718192021222324apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata: name: php-fpm namespace: istio-alphaspec: hosts: - php-fpm tcp: - match: - port: 9000 route: - destination: host: php-fpm port: number: 9000 subset: v1 weight: 10 - destination: host: php-fpm port: number: 9000 subset: v2 weight: 90 $ 问题说明$.1 协议选择说明 通过声明一个 Service 端口，协议可以被手动指定 name: &lt;protocol&gt;[-&lt;suffix&gt;]。 下列协议是被支持的： 1234567891011grpcgrpc-webhttphttp2httpsmongomysql*redis*tcptlsudp 因此注意,我们在部署deployment和service的时候, ports.name 会被istio 认为是协议 例如下面的例子中, name: tcp, 如果配置了其他的值, 会导致nginx-&gt;php-fpm 协议异常, 可能会出现错误: upstream sent unsupported FastCGI protocol version: 72 while reading response header from upstream 1234567891011121314151617181920212223242526272829303132333435363738394041424344apiVersion: apps/v1kind: Deploymentmetadata: name: php-fpm-v1 namespace: istio-alpha labels: app: php-fpm version: v1spec: replicas: 1 selector: matchLabels: app: php-fpm version: v1 template: metadata: labels: app: php-fpm version: v1 spec: containers: - name: app image: php:7.0.13-fpm imagePullPolicy: Always ports: - name: tcp protocol: TCP containerPort: 9000 ...---apiVersion: v1kind: Servicemetadata: name: php-fpm namespace: istio-alpha labels: app: php-fpmspec: ports: - name: tcp port: 9000 protocol: TCP selector: app: php-fpm","raw":"---\ntitle: istio环境下配置nginx+php\ncopyright: true\ndate: 2020-08-04 16:22:10\ntags:\n  - istio\n  - k8s\ntop: 10\n---\n将nginx+php的环境结合istio的智能路由功能做一个简单实践\n<!--more-->\n\n\n\n\n\n- [istio中文官方-协议选择](https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/)\n- [istio中文官方-virtualService](https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/)\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n> 安装部署请参考官方 [https://istio.io/latest/zh/docs/setup/getting-started/](https://istio.io/latest/zh/docs/setup/getting-started/)\n\n### 一 部署nginx+php,并设置简单智能路由\n\n>  环境说明\n\n```sh\n1. k8s:     1.15.11\n2. istio:   1.6.7\n3. istio-alpha ns设置了自动注入:\n    kubectl label namespace istio-alpha istio-injection=enabled\n    kubectl get namespaces istio-alpha --show-labels\n```\n\n\n#### 1.1 安装部署php-fpm\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-fpm-v1\n  namespace: istio-alpha\n  labels:\n    app: php-fpm\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-fpm\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: php-fpm\n        version: v1\n    spec:\n      containers:\n      - name: app\n        image: hub.xxx.com/bq/php:7.0.13-fpm\n        imagePullPolicy: Always\n        ports:\n        - name: tcp\n          protocol: TCP\n          containerPort: 9000\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"100m\"\n        volumeMounts:\n        - name: php-fpm-v1-data\n          mountPath: /webwww\n      volumes:\n        - name: php-fpm-v1-data\n          nfs:\n            server: x.x.x.x\n            path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data        \n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-fpm-v2\n  namespace: istio-alpha\n  labels:\n    app: php-fpm\n    version: v2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-fpm\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: php-fpm\n        version: v2\n    spec:\n      containers:\n      - name: app\n        image: hub.xxx.com/bq/php:7.0.13-fpm\n        imagePullPolicy: Always\n        ports:\n        - name: tcp\n          protocol: TCP\n          containerPort: 9000\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"100m\"\n        volumeMounts:\n        - name: php-fpm-v2-data\n          mountPath: /webwww\n      volumes:\n        - name: php-fpm-v2-data\n          nfs:\n            server: x.x.x.x\n            path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: php-fpm\n  namespace: istio-alpha\n  labels:\n    app: php-fpm\nspec:\n  ports:\n    - name: tcp\n      port: 9000\n      protocol: TCP\n  selector:\n    app: php-fpm\n```\n\n\n#### 1.2 安装部署nginx\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-v1\n  labels:\n    app: nginx\n    version: v1\n  namespace: istio-alpha\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: nginx\n        version: v1\n    spec:\n      containers:\n      - name: nginx-v1\n        image: hub.xxx.com/bq/nginx:1.16\n        ports:\n        - containerPort: 80\n          name: http\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"30m\"\n          limits:\n            cpu: \"100m\"\n        volumeMounts:\n        - name: nginx-www-dev\n          mountPath: /webwww\n        - name: nginx-v1-cm\n          mountPath: /etc/nginx/conf.d/\n      volumes:\n        - name: nginx-www-dev\n          nfs:\n            server: x.x.x.x\n            path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data\n        - name: nginx-v1-cm\n          configMap:\n            name: nginx-v1-cm\n---\nkind: ConfigMap\nmetadata:\n  name: nginx-v1-cm\n  labels:\n    app: nginx-v1\n  namespace: istio-alpha\napiVersion: v1\ndata:\n  nginx.conf: |\n        server {\n                listen 80 default_server;\n                server_name  _;\n                root   /webwww/test-v1;\n                add_header \"X\" \"v1\";\n                location = /50x.html {\n                    root   html;\n                }\n\n               location / {\n                    index index.php  index.html index.htm;\n                }\n\n                location ~ \\.php$ {\n                    fastcgi_pass   php-fpm:9000;\n                    fastcgi_index  index.php;\n                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n                    fastcgi_param  HTTP_HOST          $server_name;\n                    include        fastcgi_params;\n                }\n        }\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-v2\n  labels:\n    app: nginx\n    version: v2\n  namespace: istio-alpha\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: nginx\n        version: v2\n    spec:\n      containers:\n      - name: nginx-v2\n        image: hub.xxx.com/bq/nginx:1.16\n        ports:\n        - containerPort: 80\n          name: http\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"30m\"\n          limits:\n            cpu: \"100m\"\n        volumeMounts:\n        - name: nginx-www-dev\n          mountPath: /webwww\n        - name: nginx-v2-cm\n          mountPath: /etc/nginx/conf.d/\n      volumes:\n        - name: nginx-www-dev\n          nfs:\n            server: x.x.x.x\n            path: /disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data\n        - name: nginx-v2-cm\n          configMap:\n            name: nginx-v2-cm\n---\nkind: ConfigMap\nmetadata:\n  name: nginx-v2-cm\n  labels:\n    app: nginx-v2\n  namespace: istio-alpha\napiVersion: v1\ndata:\n  nginx.conf: |\n        server {\n         listen 80 default_server;\n                server_name  _;\n                root   /webwww/test-v2;\n                add_header \"X\" \"v2\";\n                location = /50x.html {\n                    root   html;\n                }\n\n               location / {\n                    index index.php  index.html index.htm;\n                }\n\n                location ~ \\.php$ {\n                    fastcgi_pass   php-fpm:9000;\n                    fastcgi_index  index.php;\n                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n                    fastcgi_param  HTTP_HOST          $server_name;\n                    include        fastcgi_params;\n                }\n        }\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  namespace: istio-alpha\n  labels:\n    app: nginx\nspec:\n  ports:\n    - name: http\n      port: 80\n      protocol: TCP\n  selector:\n    app: nginx\n```\n\n#### 1.3 配置默认destinationRule\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: nginx\n  namespace: istio-alpha\nspec:\n  host: nginx\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: php-fpm\n  namespace: istio-alpha\nspec:\n  host: php-fpm\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n```\n\n#### 1.4 配置nginx的gateway和VirtualService\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: nginx-gateway\n  namespace: istio-alpha\nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80\n      name: nginx-80\n      protocol: HTTP\n    hosts:\n    - \"*\"\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: nginx-gateway\n  namespace: istio-alpha\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - nginx-gateway\n  http:\n  - match:\n    - uri:\n        exact: /phpinfo.php\n    route:\n    - destination:\n        host: nginx\n        port:\n          number: 80\n        subset: v1\n      weight: 90\n    - destination:\n        host: nginx\n        port:\n          number: 80\n        subset: v2\n      weight: 10\n```\n\n\n\n>  以上配置之后即可在kiali查看 graph\n\n\n\n![](//zhangzw001.github.io/images/52/img-all.png)\n\n\n\n#### 1.5 简单配置流量全部切到v1 或v2\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: nginx-gateway\n  namespace: istio-alpha\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - nginx-gateway\n  http:\n  - match:\n    - uri:\n        exact: /phpinfo.php\n    route:\n    - destination:\n        host: nginx\n        port:\n          number: 80\n        subset: v2\n```\n\n\n> 当然也可以根据uri match选择不同的路由\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: nginx-gateway\n  namespace: istio-alpha\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - nginx-gateway\n  http:\n  - match:\n    - uri:\n        exact: /phpinfo.php\n    route:\n    - destination:\n        host: nginx\n        port:\n          number: 80\n        subset: v2\n  - match:\n    - uri:\n        exact: /a.php\n    route:\n    - destination:\n        host: nginx\n        port:\n          number: 80\n        subset: v1\n```\n\n\n#### 1.6 配置php-fpm的virtualService\n\n> 将流量全部转到 v1版本\n\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: php-fpm\n  namespace: istio-alpha\nspec:\n  hosts:\n  - php-fpm\n  tcp:\n  - match:\n    - port: 9000\n    route:\n    - destination:\n        host: php-fpm\n        port:\n          number: 9000\n        subset: v1\n```\n\n> 将流量分成1:9\n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: php-fpm\n  namespace: istio-alpha\nspec:\n  hosts:\n  - php-fpm\n  tcp:\n  - match:\n    - port: 9000\n    route:\n    - destination:\n        host: php-fpm\n        port:\n          number: 9000\n        subset: v1\n      weight: 10\n    - destination:\n        host: php-fpm\n        port:\n          number: 9000\n        subset: v2\n      weight: 90\n```\n\n![](//zhangzw001.github.io/images/52/img-fpm-1-9.png)\n\n![](//zhangzw001.github.io/images/52/img-all2.jpg)\n\n---\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n\n### $ 问题说明\n#### $.1 协议选择说明\n\n\n> 通过声明一个 Service 端口，协议可以被手动指定 `name: <protocol>[-<suffix>]`。 下列协议是被支持的：\n\n\n```\ngrpc\ngrpc-web\nhttp\nhttp2\nhttps\nmongo\nmysql*\nredis*\ntcp\ntls\nudp\n```\n\n> 因此注意,我们在部署deployment和service的时候, ports.name 会被istio 认为是协议\n\n> 例如下面的例子中, name: tcp, 如果配置了其他的值, 会导致nginx->php-fpm 协议异常, 可能会出现错误:\n\n`upstream sent unsupported FastCGI protocol version: 72 while reading response header from upstream`\n\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-fpm-v1\n  namespace: istio-alpha\n  labels:\n    app: php-fpm\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-fpm\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: php-fpm\n        version: v1\n    spec:\n      containers:\n      - name: app\n        image: php:7.0.13-fpm\n        imagePullPolicy: Always\n        ports:\n        - name: tcp\n          protocol: TCP\n          containerPort: 9000\n          ...\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: php-fpm\n  namespace: istio-alpha\n  labels:\n    app: php-fpm\nspec:\n  ports:\n    - name: tcp\n      port: 9000\n      protocol: TCP\n  selector:\n    app: php-fpm\n```\n\n---\n\n","content":"<p>将nginx+php的环境结合istio的智能路由功能做一个简单实践</p>\n<a id=\"more\"></a>\n\n\n\n\n\n<ul>\n<li><a href=\"https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/\" target=\"_blank\" rel=\"noopener\">istio中文官方-协议选择</a></li>\n<li><a href=\"https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/\" target=\"_blank\" rel=\"noopener\">istio中文官方-virtualService</a></li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<blockquote>\n<p>安装部署请参考官方 <a href=\"https://istio.io/latest/zh/docs/setup/getting-started/\" target=\"_blank\" rel=\"noopener\">https://istio.io/latest/zh/docs/setup/getting-started/</a></p>\n</blockquote>\n<h3 id=\"一-部署nginx-php-并设置简单智能路由\"><a href=\"#一-部署nginx-php-并设置简单智能路由\" class=\"headerlink\" title=\"一 部署nginx+php,并设置简单智能路由\"></a>一 部署nginx+php,并设置简单智能路由</h3><blockquote>\n<p> 环境说明</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. k8s:     1.15.11</span><br><span class=\"line\">2. istio:   1.6.7</span><br><span class=\"line\">3. istio-alpha ns设置了自动注入:</span><br><span class=\"line\">    kubectl label namespace istio-alpha istio-injection=enabled</span><br><span class=\"line\">    kubectl get namespaces istio-alpha --show-labels</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-1-安装部署php-fpm\"><a href=\"#1-1-安装部署php-fpm\" class=\"headerlink\" title=\"1.1 安装部署php-fpm\"></a>1.1 安装部署php-fpm</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm-v1</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/bq/php:7.0.13-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"100m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-fpm-v1-data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-fpm-v1-data</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">x.x.x.x</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span>        </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm-v2</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/bq/php:7.0.13-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"100m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-fpm-v2-data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-fpm-v2-data</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">x.x.x.x</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-2-安装部署nginx\"><a href=\"#1-2-安装部署nginx\" class=\"headerlink\" title=\"1.2 安装部署nginx\"></a>1.2 安装部署nginx</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/bq/nginx:1.16</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"30m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"100m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-v1-cm</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/nginx/conf.d/</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">x.x.x.x</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-v1-cm</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">nginx-v1-cm</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-v1-cm</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">nginx.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        server &#123;</span></span><br><span class=\"line\"><span class=\"string\">                listen 80 default_server;</span></span><br><span class=\"line\"><span class=\"string\">                server_name  _;</span></span><br><span class=\"line\"><span class=\"string\">                root   /webwww/test-v1;</span></span><br><span class=\"line\"><span class=\"string\">                add_header \"X\" \"v1\";</span></span><br><span class=\"line\"><span class=\"string\">                location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    root   html;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">               location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    index index.php  index.html index.htm;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">                location ~ \\.php$ &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_pass   php-fpm:9000;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_index  index.php;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  HTTP_HOST          $server_name;</span></span><br><span class=\"line\"><span class=\"string\">                    include        fastcgi_params;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/bq/nginx:1.16</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"30m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"100m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-v2-cm</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/nginx/conf.d/</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">x.x.x.x</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-v2-cm</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">nginx-v2-cm</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-v2-cm</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">nginx.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        server &#123;</span></span><br><span class=\"line\"><span class=\"string\">         listen 80 default_server;</span></span><br><span class=\"line\"><span class=\"string\">                server_name  _;</span></span><br><span class=\"line\"><span class=\"string\">                root   /webwww/test-v2;</span></span><br><span class=\"line\"><span class=\"string\">                add_header \"X\" \"v2\";</span></span><br><span class=\"line\"><span class=\"string\">                location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    root   html;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">               location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    index index.php  index.html index.htm;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">                location ~ \\.php$ &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_pass   php-fpm:9000;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_index  index.php;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  HTTP_HOST          $server_name;</span></span><br><span class=\"line\"><span class=\"string\">                    include        fastcgi_params;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-3-配置默认destinationRule\"><a href=\"#1-3-配置默认destinationRule\" class=\"headerlink\" title=\"1.3 配置默认destinationRule\"></a>1.3 配置默认destinationRule</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DestinationRule</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  subsets:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DestinationRule</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  subsets:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v2</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-4-配置nginx的gateway和VirtualService\"><a href=\"#1-4-配置nginx的gateway和VirtualService\" class=\"headerlink\" title=\"1.4 配置nginx的gateway和VirtualService\"></a>1.4 配置nginx的gateway和VirtualService</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Gateway</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    istio:</span> <span class=\"string\">ingressgateway</span> <span class=\"comment\"># use istio default controller</span></span><br><span class=\"line\"><span class=\"attr\">  servers:</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span></span><br><span class=\"line\"><span class=\"attr\">      number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">nginx-80</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">  gateways:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  http:</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - uri:</span></span><br><span class=\"line\"><span class=\"attr\">        exact:</span> <span class=\"string\">/phpinfo.php</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">      weight:</span> <span class=\"number\">90</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">      weight:</span> <span class=\"number\">10</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p> 以上配置之后即可在kiali查看 graph</p>\n</blockquote>\n<p><img src=\"//zhangzw001.github.io/images/52/img-all.png\" alt></p>\n<h4 id=\"1-5-简单配置流量全部切到v1-或v2\"><a href=\"#1-5-简单配置流量全部切到v1-或v2\" class=\"headerlink\" title=\"1.5 简单配置流量全部切到v1 或v2\"></a>1.5 简单配置流量全部切到v1 或v2</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">  gateways:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  http:</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - uri:</span></span><br><span class=\"line\"><span class=\"attr\">        exact:</span> <span class=\"string\">/phpinfo.php</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v2</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>当然也可以根据uri match选择不同的路由</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">  gateways:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">nginx-gateway</span></span><br><span class=\"line\"><span class=\"attr\">  http:</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - uri:</span></span><br><span class=\"line\"><span class=\"attr\">        exact:</span> <span class=\"string\">/phpinfo.php</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - uri:</span></span><br><span class=\"line\"><span class=\"attr\">        exact:</span> <span class=\"string\">/a.php</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-6-配置php-fpm的virtualService\"><a href=\"#1-6-配置php-fpm的virtualService\" class=\"headerlink\" title=\"1.6 配置php-fpm的virtualService\"></a>1.6 配置php-fpm的virtualService</h4><blockquote>\n<p>将流量全部转到 v1版本</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  tcp:</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v1</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>将流量分成1:9</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  tcp:</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">      weight:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">    - destination:</span></span><br><span class=\"line\"><span class=\"attr\">        host:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span></span><br><span class=\"line\"><span class=\"attr\">          number:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">        subset:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">      weight:</span> <span class=\"number\">90</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"//zhangzw001.github.io/images/52/img-fpm-1-9.png\" alt></p>\n<p><img src=\"//zhangzw001.github.io/images/52/img-all2.jpg\" alt></p>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n\n<h3 id=\"问题说明\"><a href=\"#问题说明\" class=\"headerlink\" title=\"$ 问题说明\"></a>$ 问题说明</h3><h4 id=\"1-协议选择说明\"><a href=\"#1-协议选择说明\" class=\"headerlink\" title=\"$.1 协议选择说明\"></a>$.1 协议选择说明</h4><blockquote>\n<p>通过声明一个 Service 端口，协议可以被手动指定 <code>name: &lt;protocol&gt;[-&lt;suffix&gt;]</code>。 下列协议是被支持的：</p>\n</blockquote>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grpc</span><br><span class=\"line\">grpc-web</span><br><span class=\"line\"><span class=\"keyword\">http</span></span><br><span class=\"line\">http2</span><br><span class=\"line\"><span class=\"keyword\">https</span></span><br><span class=\"line\">mongo</span><br><span class=\"line\">mysql*</span><br><span class=\"line\">redis*</span><br><span class=\"line\">tcp</span><br><span class=\"line\">tls</span><br><span class=\"line\">udp</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>因此注意,我们在部署deployment和service的时候, ports.name 会被istio 认为是协议</p>\n</blockquote>\n<blockquote>\n<p>例如下面的例子中, name: tcp, 如果配置了其他的值, 会导致nginx-&gt;php-fpm 协议异常, 可能会出现错误:</p>\n</blockquote>\n<p><code>upstream sent unsupported FastCGI protocol version: 72 while reading response header from upstream</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm-v1</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">php:7.0.13-fpm</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">          <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">istio-alpha</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">tcp</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n","comments":true,"permalink":"https://blog.k1s.club/2020/08/04/52-istio测试nginx-php项目/","categories":[],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"istio","slug":"istio","permalink":"https://blog.k1s.club/tags/istio/"}]},{"title":"k8s搭建radius","date":"2020-07-27T02:19:25.000Z","path":"2020/07/27/51-k8s搭建radius/","text":"搭建lnmp+freeradius的账号认证服务 一 记录123456docker: 17.03.2-cek8s: 1.15.11php: 7.0.13mysql: 5.6freeraidus: 3.0.21daloradius: 1.1-2 / 08 Aug 2019 配置修改简单说明: 1234567891011121314151617181920212223242526272829303132333435363738391. 数据库创建说明create database radius;grant all on radius.* to radius@'%' identified by 'xxx';flush privileges;# 导入表结构mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sqlmysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/mysql-daloradius.sqlmysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/fr2-mysql-daloradius-and-freeradius.sql2. 修改freeRADIUS配置vim /etc/raddb/radiusd.conf# 这里我是配合nginx,php统一路径logdir = /nginx_logs 3. 修改为sql认证 cd /etc/raddb/mods-enabled ln -s ../mods-available/sql4. 修改FreeRADIUS中的mysql 配置文件 dialect = \"mysql\" //下列配置前的注释去掉 server = \"k8s-db-t.xxx.com\" //mysql服务器地址,如果是同一个k8s集群, 写k8s内网的svc域名即可,例如: freeradius-mysql-dev 或 freeradius-mysql-dev.radius-dev.svc.cluster.local port = 3326 //mysql 端口号 login = \"radius\" //myqsl 登录用户名 password = \"xxx\" //mysql 登录密码 read_clients = yes5. 开放daloradius服务器验证权限vim /etc/raddb/clients.confclient php-fpm &#123; ipaddr = php-fpm secret = testing123&#125;6. 修改daloradius默认php配置vim daloradius-php/library/daloradius.conf.php$configValues['CONFIG_MAINT_TEST_USER_RADIUSSERVER'] = 'radius';$configValues['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'testing123'; 二 首先搭建数据库k8s-freeradius-mysql-dev_5.6.36-configmap.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263---kind: ConfigMapmetadata: name: freeradius-mysql-dev labels: app: freeradius-mysql-dev namespace: dbapiVersion: v1data: my.cnf: | [mysqld] innodb_file_per_table=1 user=mysql datadir=/data socket=/data/mysql.sock symbolic-links=0 binlog_format=mixed #log-bin=mysql-bin log-bin=/data/mysql-bin.log #general_log = 1 #general_log_file = /data/general.log #日志 log-error=/data/mysqld.log innodb_log_file_size = 256M thread_cache_size = 50 max_allowed_packet=16M max_binlog_size=500M #old_passwords=1 character-set-server=utf8 max_connections=3000 skip-name-resolve max_allowed_packet=64M tmp_table_size=200M server-id=101 port=3306 skip_slave_start expire_logs_days=7 [mysqld_safe] log-error=/data/mysqld.log pid-file=/data/mysqld.pid [mysql] no-auto-rehash user=root default-character-set=utf8 socket=/data/mysql.sock [client] socket=/data/mysql.sock k8s-freeradius-mysql-dev_5.6.36.yml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465---apiVersion: apps/v1kind: Deploymentmetadata: labels: app: freeradius-mysql-dev name: freeradius-mysql-dev namespace: dbspec: replicas: 1 selector: matchLabels: app: freeradius-mysql-dev template: metadata: labels: app: freeradius-mysql-dev spec: containers: - name: freeradius-mysql-dev image: hub.xxx.com/mysql:5.6.36-Asia ports: - containerPort: 3306 name: db-port resources: requests: cpu: \"50m\" limits: cpu: \"1\" env: - name: MYSQL_ROOT_PASSWORD value: \"xxx\" volumeMounts: - name: freeradius-mysql-dev-data mountPath: /data - name: freeradius-mysql-dev-conf mountPath: /etc/mysql/my.cnf subPath: my.cnf volumes: - name: freeradius-mysql-dev-data nfs: server: xxx.xxx.xxx.194 path: /disk/k8s-nfs-data/k8s-db-t/freeradius-mysql-dev - name: freeradius-mysql-dev-conf configMap: name: freeradius-mysql-dev---kind: ServiceapiVersion: v1metadata: labels: app: freeradius-mysql-dev name: freeradius-mysql-dev namespace: dbspec: type: NodePort ports: - port: 3306 name: db-port targetPort: 3306 nodePort: 3326 protocol: TCP selector: app: freeradius-mysql-dev 创建库和账号123456789create database radius;grant all on radius.* to radius@'%' identified by 'xxxxxxxxxxxxxxxxxx';flush privileges;# 测试登录mysql -hk8s-db-t.xxx.com -P3326 -uradius -p# 导入表结构mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sqlmysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/mysql-daloradius.sql 三 部署freeradiusdeployment-freeradius.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103apiVersion: apps/v1kind: Deploymentmetadata: name: freeradius-dev labels: app: freeradius-dev namespace: radius-devspec: replicas: 1 selector: matchLabels: app: freeradius-dev template: metadata: labels: app: freeradius-dev spec: containers: - name: freeradius-dev image: hub.xxx.com/freeradius-server:3.0.21 ports: - containerPort: 1812 name: port-1812 protocol: UDP - containerPort: 1813 name: port-1813 protocol: UDP resources: requests: cpu: \"30m\" limits: cpu: \"1\" volumeMounts: - name: daloradius-freeradius-sql-dev mountPath: /etc/raddb/mods-available/sql subPath: sql - name: daloradius-freeradius-sql-dev mountPath: /etc/raddb/mods-enabled/sql subPath: sql - name: daloradius-freeradius-radiusd-dev mountPath: /etc/raddb/radiusd.conf subPath: radiusd.conf - name: daloradius-freeradius-clients-dev mountPath: /etc/raddb/clients.conf subPath: clients.conf - name: daloradius-freeradius-log mountPath: /nginx_logs volumes: - name: daloradius-freeradius-sql-dev configMap: name: daloradius-freeradius-sql-dev - name: daloradius-freeradius-radiusd-dev configMap: name: daloradius-freeradius-radiusd-dev - name: daloradius-freeradius-clients-dev configMap: name: daloradius-freeradius-clients-dev - name: daloradius-freeradius-log nfs: server: xxx.xxx.xxx.194 path: /disk/k8s-nfs-data/k8s1-t/daloradius-php/nginx_logs---apiVersion: v1kind: Servicemetadata: name: freeradius-dev namespace: radius-dev labels: app: freeradius-devspec: type: ClusterIP ports: - name: port-1812 port: 1812 protocol: UDP - name: port-1813 port: 1813 protocol: UDP selector: app: freeradius-dev---kind: ServiceapiVersion: v1metadata: name: freeradius-dev-svc namespace: radius-dev labels: app: freeradius-devspec: type: NodePort ports: - name: port-1812 port: 1812 targetPort: 1812 nodePort: 1812 protocol: UDP - name: port-1813 port: 1813 targetPort: 1813 nodePort: 1813 protocol: UDP selector: app: freeradius-dev configmap-freeradius-radiusd-conf.yaml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127---kind: ConfigMapmetadata: name: daloradius-freeradius-radiusd-dev labels: app: daloradius-freeradius-radiusd-dev namespace: radius-devapiVersion: v1data: radiusd.conf: | prefix = /usr exec_prefix = /usr sysconfdir = /etc localstatedir = /var sbindir = $&#123;exec_prefix&#125;/sbin logdir = /nginx_logs raddbdir = /etc/freeradius radacctdir = $&#123;logdir&#125;/radacct name = freeradius confdir = $&#123;raddbdir&#125; modconfdir = $&#123;confdir&#125;/mods-config certdir = $&#123;confdir&#125;/certs cadir = $&#123;confdir&#125;/certs run_dir = $&#123;localstatedir&#125;/run/$&#123;name&#125; # Should likely be $&#123;localstatedir&#125;/lib/radiusd db_dir = $&#123;raddbdir&#125; libdir = /usr/lib/freeradius pidfile = $&#123;run_dir&#125;/$&#123;name&#125;.pid correct_escapes = true max_request_time = 30 cleanup_delay = 5 max_requests = 16384 hostname_lookups = no log &#123; destination = files colourise = yes file = $&#123;logdir&#125;/radius.log syslog_facility = daemon stripped_names = no auth = yes # auth_accept = no # auth_reject = no auth_badpass = yes auth_goodpass = yes msg_denied = \"You are already logged in - access denied\" &#125; checkrad = $&#123;sbindir&#125;/checkrad ENV &#123; &#125; security &#123; user = freerad group = freerad allow_core_dumps = no max_attributes = 200 reject_delay = 1 status_server = yes &#125; proxy_requests = yes $INCLUDE proxy.conf $INCLUDE clients.conf thread pool &#123; start_servers = 5 max_servers = 32 min_spare_servers = 3 max_spare_servers = 10 max_requests_per_server = 0 auto_limit_acct = no &#125; modules &#123; $INCLUDE mods-enabled/ &#125; instantiate &#123; &#125; policy &#123; $INCLUDE policy.d/ &#125; $INCLUDE sites-enabled/ configmap-freeradius-clients-conf.yaml123456789101112131415161718192021222324252627282930---kind: ConfigMapmetadata: name: daloradius-freeradius-clients-dev labels: app: daloradius-freeradius-clients-dev namespace: radius-devapiVersion: v1data: clients.conf: | client php-fpm &#123; ipaddr = php-fpm secret = testing123 &#125; client localhost &#123; ipaddr = 127.0.0.1 proto = * secret = testing123 require_message_authenticator = no nas_type = other # localhost isn't usually a NAS... limit &#123; max_connections = 16 lifetime = 0 idle_timeout = 30 &#125; &#125; client localhost_ipv6 &#123; ipv6addr = ::1 secret = testing123 &#125; configmap-freeradius-sql.yaml 主要是修改 Connection info 的内容 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071---kind: ConfigMapmetadata: name: daloradius-freeradius-sql-dev labels: app: daloradius-freeradius-sql-dev namespace: radius-devapiVersion: v1data: sql: | sql &#123; dialect = \"mysql\" driver = \"rlm_sql_mysql\" sqlite &#123; filename = \"/tmp/freeradius.db\" busy_timeout = 200 bootstrap = \"$&#123;modconfdir&#125;/$&#123;..:name&#125;/main/sqlite/schema.sql\" &#125; mysql &#123; &#125; warnings = auto &#125; postgresql &#123; send_application_name = yes &#125; mongo &#123; appname = \"freeradius\" tls &#123; certificate_file = /path/to/file certificate_password = \"password\" ca_file = /path/to/file ca_dir = /path/to/directory crl_file = /path/to/file weak_cert_validation = false allow_invalid_hostname = false &#125; &#125; server = \"k8s-db-t.xxx.com\" port = 3326 login = \"radius\" password = \"xxxxxxxxxxxxxxxxxx\" read_clients = yes radius_db = \"radius\" acct_table1 = \"radacct\" acct_table2 = \"radacct\" postauth_table = \"radpostauth\" authcheck_table = \"radcheck\" groupcheck_table = \"radgroupcheck\" authreply_table = \"radreply\" groupreply_table = \"radgroupreply\" usergroup_table = \"radusergroup\" delete_stale_sessions = yes pool &#123; start = $&#123;thread[pool].start_servers&#125; min = $&#123;thread[pool].min_spare_servers&#125; max = $&#123;thread[pool].max_servers&#125; spare = $&#123;thread[pool].max_spare_servers&#125; uses = 0 retry_delay = 30 lifetime = 0 idle_timeout = 60 &#125; client_table = \"nas\" group_attribute = \"SQL-Group\" $INCLUDE $&#123;modconfdir&#125;/$&#123;.:name&#125;/main/$&#123;dialect&#125;/queries.conf &#125; 四 部署nignx+php7的daloradius web管理后台php7部署配置php镜像安装扩展 Dockerfile1234567from hub.xxx.com/php:developuser rootRUN pear install DB \\ &amp;&amp; pear install -a Mail \\ &amp;&amp; pear install -a Mail_Mime deployment-php.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990---apiVersion: apps/v1kind: Deploymentmetadata: name: daloradius-php-dev labels: app: daloradius-php-dev namespace: radius-devspec: replicas: 1 strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate selector: matchLabels: app: daloradius-php-dev template: metadata: labels: app: daloradius-php-dev spec: containers: - name: daloradius-php-dev image: hub.xxx.com/php:radius imagePullPolicy: Always ports: - containerPort: 9000 name: fpm-9000 protocol: TCP resources: requests: cpu: \"50m\" limits: cpu: \"600m\" volumeMounts: - name: daloradius-nginx-dev mountPath: /webwww - name: daloradius-php-cfg-dev mountPath: \"/usr/local/etc/php/php.ini\" subPath: php.ini - name: daloradius-fpm-cfg-dev mountPath: \"/usr/local/etc/php-fpm.d/www.conf\" subPath: www.conf volumes: - name: daloradius-nginx-dev nfs: server: xxx.xxx.xxx.194 path: /disk/k8s-nfs-data/k8s1-t/daloradius-php - name: daloradius-php-cfg-dev configMap: name: daloradius-php-cfg-dev - name: daloradius-fpm-cfg-dev configMap: name: daloradius-fpm-cfg-dev---apiVersion: v1kind: Servicemetadata: name: daloradius-php-dev namespace: radius-dev labels: app: daloradius-php-devspec: type: ClusterIP ports: - name: fpm-9000 port: 9000 protocol: TCP selector: app: daloradius-php-dev---apiVersion: v1kind: Servicemetadata: name: daloradius-php-dev-svc namespace: radius-dev labels: app: daloradius-php-devspec: type: NodePort selector: app: daloradius-php-dev ports: - name: fpm-9000 port: 9000 targetPort: 9000 nodePort: 32101 protocol: TCP configmap-php-fpm.yaml12345678910111213141516171819---kind: ConfigMapmetadata: name: daloradius-fpm-cfg-dev labels: app: daloradius-fpm-cfg-dev namespace: radius-devapiVersion: v1data: www.conf: | [www] user = 101 group = 101 listen = 127.0.0.1:9000 pm = static pm.max_children = 20 pm.start_servers = 10 pm.min_spare_servers = 5 pm.max_spare_servers = 5 configmap-php.yaml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149---kind: ConfigMapmetadata: name: daloradius-php-cfg-dev labels: app: daloradius-php-cfg-dev namespace: radius-devapiVersion: v1data: php.ini: | [PHP] engine = On short_open_tag = Off precision = 14 output_buffering = 4096 zlib.output_compression = Off implicit_flush = Off unserialize_callback_func = serialize_precision = 17 disable_functions = disable_classes = zend.enable_gc = On expose_php = On max_execution_time = 30 max_input_time = 60 memory_limit = 128M max_input_vars = 10000 error_reporting = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT display_errors = On display_startup_errors = Off log_errors = On log_errors_max_len = 1024 ignore_repeated_errors = Off ignore_repeated_source = Off report_memleaks = On track_errors = Off html_errors = On error_log = php_errors.log variables_order = \"GPCS\" request_order = \"GP\" register_argc_argv = Off auto_globals_jit = On post_max_size = 8M auto_prepend_file = auto_append_file = default_mimetype = \"text/html\" default_charset = \"UTF-8\" doc_root = user_dir = enable_dl = Off file_uploads = On upload_max_filesize = 2M max_file_uploads = 20 allow_url_fopen = On allow_url_include = Off default_socket_timeout = 60 [CLI Server] cli_server.color = On [Date] date.timezone =Asia/Shanghai [filter] [iconv] [intl] [sqlite3] [Pcre] [Pdo] [Pdo_mysql] pdo_mysql.cache_size = 2000 pdo_mysql.default_socket= [Phar] [mail function] SMTP = localhost smtp_port = 25 mail.add_x_header = On [SQL] sql.safe_mode = Off [ODBC] odbc.allow_persistent = On odbc.check_persistent = On odbc.max_persistent = -1 odbc.max_links = -1 odbc.defaultlrl = 4096 odbc.defaultbinmode = 1 [Interbase] ibase.allow_persistent = 1 ibase.max_persistent = -1 ibase.max_links = -1 ibase.timestampformat = \"%Y-%m-%d %H:%M:%S\" ibase.dateformat = \"%Y-%m-%d\" ibase.timeformat = \"%H:%M:%S\" [MySQLi] mysqli.max_persistent = -1 mysqli.allow_persistent = On mysqli.max_links = -1 mysqli.cache_size = 2000 mysqli.default_port = 3306 mysqli.default_socket = mysqli.default_host = mysqli.default_user = mysqli.default_pw = mysqli.reconnect = Off [mysqlnd] mysqlnd.collect_statistics = On mysqlnd.collect_memory_statistics = Off [OCI8] [PostgreSQL] pgsql.allow_persistent = On pgsql.auto_reset_persistent = Off pgsql.max_persistent = -1 pgsql.max_links = -1 pgsql.ignore_notice = 0 pgsql.log_notice = 0 [bcmath] bcmath.scale = 0 [browscap] [Session] session.save_handler = redis session.save_path = \"tcp://xxx.xxx.xxx.194:6399\" session.use_strict_mode = 0 session.use_cookies = 1 session.use_only_cookies = 1 session.name = PHPSESSID session.auto_start = 0 session.cookie_lifetime = 0 session.cookie_path = / session.cookie_domain = session.cookie_httponly = session.serialize_handler = php session.gc_probability = 1 session.gc_divisor = 1000 session.gc_maxlifetime = 1440 session.referer_check = session.cache_limiter = nocache session.cache_expire = 180 session.use_trans_sid = 0 session.hash_function = 0 session.hash_bits_per_character = 5 url_rewriter.tags = \"a=href,area=href,frame=src,input=src,form=fakeentry\" [Assertion] zend.assertions = -1 tidy.clean_output = Off [soap] soap.wsdl_cache_enabled=1 soap.wsdl_cache_dir=\"/tmp\" soap.wsdl_cache_ttl=86400 soap.wsdl_cache_limit = 5 [sysvshm] [ldap] ldap.max_links = -1 nginx部署配置deployment-nginx.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263---apiVersion: apps/v1kind: Deploymentmetadata: name: daloradius-nginx-dev labels: app: daloradius-nginx-dev namespace: radius-devspec: replicas: 1 selector: matchLabels: app: daloradius-nginx-dev template: metadata: labels: app: daloradius-nginx-dev spec: containers: - name: daloradius-nginx-dev image: hub.xxx.com/nginx:1.16.0-develop ports: - containerPort: 80 name: nginx-80 protocol: TCP resources: requests: cpu: \"30m\" limits: cpu: \"500m\" volumeMounts: - name: nginx-www-dev mountPath: /webwww - name: daloradius-nginx-dev-cm mountPath: /etc/nginx/nginx.conf subPath: nginx.conf volumes: - name: nginx-www-dev nfs: server: xxx.xxx.xxx.194 path: /disk/k8s-nfs-data/k8s1-t/daloradius-php - name: daloradius-nginx-dev-cm configMap: name: daloradius-nginx-dev-cm---kind: ServiceapiVersion: v1metadata: labels: app: daloradius-nginx-dev name: daloradius-nginx-dev namespace: radius-devspec: type: NodePort ports: - name: nginx-80 port: 80 targetPort: 80 nodePort: 32100 protocol: TCP selector: app: daloradius-nginx-dev--- configmap-php-nginx.yaml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162---kind: ConfigMapmetadata: name: daloradius-nginx-dev-cm labels: app: daloradius-nginx-dev namespace: radius-devapiVersion: v1data: nginx.conf: | user www-data; worker_processes 1; error_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid; events &#123; worker_connections 1024; &#125; http &#123; include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; include /etc/nginx/conf.d/*.conf; server &#123; listen 80 default_server; server_name radius.xxx.com ; root /webwww; location = /50x.html &#123; root html; &#125; location / &#123; index index.php index.html index.htm; &#125; location ~ \\.php$ &#123; fastcgi_pass daloradius-php-dev:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param HTTP_HOST $server_name; include fastcgi_params; &#125; &#125; &#125; 五 测试通过前端nginx代理转发到nodeport端口1234567891011121314151617181920212223242526server &#123; listen 80; charset utf-8; listen 443 ssl http2; server_name radius.xxx.com; ssl_certificate /etc/nginx/server.pem; ssl_certificate_key /etc/nginx/server.key; ssl_session_timeout 5m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL; ssl_prefer_server_ciphers on; #转向预发布环境 location / &#123; proxy_pass http://xxx.xxx.xxx.221:32100/; proxy_redirect http://$host:32100 http://$host; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125; 配置k8s的ingress12345678910111213141516171819---apiVersion: extensions/v1beta1kind: Ingressmetadata: name: daloradius-nginx-dev labels: app: daloradius-nginx-dev namespace: radius-dev annotations: kubernetes.io/ingress.class: \"traefik\"spec: rules: - host: radius.xxx.com http: paths: - path: / backend: serviceName: daloradius-nginx-dev servicePort: 80 登录测试12登录地址: radius.xxx.com账号密码: administrator/radius 通过后台新建账号之后, 测试账号连通性命令行12# 在freeradius 容器内支线radtest xxx xxx 127.0.0.1 0 testing123 通过radius.xxx.com 管理页面测试连通性 这是认证通过的 这是被rejected","raw":"---\ntitle: k8s搭建radius\ncopyright: true\ndate: 2020-07-27 10:19:25\ntags:\n  - k8s\n  - freeradius\n  - daloradius\ncategories:\n  - [k8s]\n  - radius\n---\n\n搭建lnmp+freeradius的账号认证服务\n\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 一 记录\n```\ndocker:   17.03.2-ce\nk8s:   1.15.11\nphp:   7.0.13\nmysql:   5.6\nfreeraidus:  3.0.21\ndaloradius:  1.1-2 / 08 Aug 2019\n\n```\n\n> 配置修改简单说明:\n\n```\n1. 数据库创建说明\ncreate database radius;\ngrant all on radius.* to radius@'%' identified by 'xxx';\nflush privileges;\n\n# 导入表结构\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p < mods-config/sql/main/mysql/schema.sql\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p < daloradius-php/contrib/db/mysql-daloradius.sql\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p < daloradius-php/contrib/db/fr2-mysql-daloradius-and-freeradius.sql\n\n2. 修改freeRADIUS配置\nvim /etc/raddb/radiusd.conf\n# 这里我是配合nginx,php统一路径\nlogdir = /nginx_logs \n\n3. 修改为sql认证\n cd /etc/raddb/mods-enabled\n ln -s ../mods-available/sql\n\n4. 修改FreeRADIUS中的mysql 配置文件\n dialect = \"mysql\"\n //下列配置前的注释去掉\n server = \"k8s-db-t.xxx.com\" //mysql服务器地址,如果是同一个k8s集群, 写k8s内网的svc域名即可,例如: freeradius-mysql-dev 或 freeradius-mysql-dev.radius-dev.svc.cluster.local\n port = 3326 //mysql 端口号\n login = \"radius\" //myqsl 登录用户名\n password = \"xxx\" //mysql 登录密码\n read_clients = yes\n\n5. 开放daloradius服务器验证权限\nvim /etc/raddb/clients.conf\nclient php-fpm {\n ipaddr = php-fpm\n secret  = testing123\n}\n\n6. 修改daloradius默认php配置\nvim daloradius-php/library/daloradius.conf.php\n$configValues['CONFIG_MAINT_TEST_USER_RADIUSSERVER'] = 'radius';\n$configValues['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'testing123';\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 二 首先搭建数据库\n\n#### k8s-freeradius-mysql-dev_5.6.36-configmap.yml\n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: freeradius-mysql-dev\n  labels:\n    app: freeradius-mysql-dev\n  namespace: db\napiVersion: v1\ndata:\n  my.cnf: |\n\n    [mysqld]\n    innodb_file_per_table=1\n    user=mysql\n\n    datadir=/data\n    socket=/data/mysql.sock\n    symbolic-links=0\n\n    binlog_format=mixed\n\n    #log-bin=mysql-bin\n    log-bin=/data/mysql-bin.log\n\n    #general_log   = 1\n    #general_log_file = /data/general.log\n\n\n    #日志\n    log-error=/data/mysqld.log\n\n    innodb_log_file_size = 256M\n    thread_cache_size = 50\n\n\n    max_allowed_packet=16M\n    max_binlog_size=500M\n    #old_passwords=1\n    character-set-server=utf8\n    max_connections=3000\n    skip-name-resolve\n    max_allowed_packet=64M\n    tmp_table_size=200M\n\n    server-id=101\n    port=3306\n\n    skip_slave_start\n    expire_logs_days=7\n\n\n    [mysqld_safe]\n    log-error=/data/mysqld.log\n    pid-file=/data/mysqld.pid\n\n    [mysql]\n    no-auto-rehash\n    user=root\n    default-character-set=utf8\n    socket=/data/mysql.sock\n\n    [client]\n    socket=/data/mysql.sock\n```\n\n#### k8s-freeradius-mysql-dev_5.6.36.yml\n\n```yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: freeradius-mysql-dev\n  name: freeradius-mysql-dev\n  namespace: db\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: freeradius-mysql-dev\n  template:\n    metadata:\n      labels:\n        app: freeradius-mysql-dev\n    spec:\n      containers:\n       - name: freeradius-mysql-dev\n         image: hub.xxx.com/mysql:5.6.36-Asia\n         ports:\n         - containerPort: 3306\n           name: db-port\n         resources:\n           requests:\n             cpu: \"50m\"\n           limits:\n             cpu: \"1\"\n         env:\n         - name: MYSQL_ROOT_PASSWORD\n           value: \"xxx\"\n         volumeMounts:\n         - name: freeradius-mysql-dev-data\n           mountPath: /data\n         - name: freeradius-mysql-dev-conf\n           mountPath: /etc/mysql/my.cnf\n           subPath: my.cnf\n      volumes:\n        - name: freeradius-mysql-dev-data\n          nfs:\n            server: xxx.xxx.xxx.194\n            path: /disk/k8s-nfs-data/k8s-db-t/freeradius-mysql-dev\n        - name: freeradius-mysql-dev-conf\n          configMap:\n            name: freeradius-mysql-dev\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: freeradius-mysql-dev\n  name: freeradius-mysql-dev\n  namespace: db\nspec:\n  type: NodePort\n  ports:\n    - port: 3306\n      name: db-port\n      targetPort: 3306\n      nodePort: 3326\n      protocol: TCP\n  selector:\n    app: freeradius-mysql-dev\n```\n\n#### 创建库和账号\n\n```shell\ncreate database radius;\ngrant all on radius.* to radius@'%' identified by 'xxxxxxxxxxxxxxxxxx';\nflush privileges;\n\n# 测试登录\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p\n# 导入表结构\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p < mods-config/sql/main/mysql/schema.sql\nmysql -hk8s-db-t.xxx.com -P3326 -uradius -p < daloradius-php/contrib/db/mysql-daloradius.sql\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 三 部署freeradius\n\n#### deployment-freeradius.yml\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: freeradius-dev\n  labels:\n    app: freeradius-dev\n  namespace: radius-dev\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: freeradius-dev\n  template:\n    metadata:\n      labels:\n        app: freeradius-dev\n    spec:\n      containers:\n      - name: freeradius-dev\n        image: hub.xxx.com/freeradius-server:3.0.21\n        ports:\n        - containerPort: 1812\n          name: port-1812\n          protocol: UDP\n        - containerPort: 1813\n          name: port-1813\n          protocol: UDP\n        resources:\n          requests:\n            cpu: \"30m\"\n          limits:\n            cpu: \"1\"\n        volumeMounts:\n        - name: daloradius-freeradius-sql-dev\n          mountPath: /etc/raddb/mods-available/sql\n          subPath: sql\n        - name: daloradius-freeradius-sql-dev\n          mountPath: /etc/raddb/mods-enabled/sql\n          subPath: sql\n        - name: daloradius-freeradius-radiusd-dev\n          mountPath: /etc/raddb/radiusd.conf\n          subPath: radiusd.conf\n        - name: daloradius-freeradius-clients-dev\n          mountPath: /etc/raddb/clients.conf\n          subPath: clients.conf\n        - name: daloradius-freeradius-log\n          mountPath: /nginx_logs\n      volumes:\n        - name: daloradius-freeradius-sql-dev\n          configMap:\n            name: daloradius-freeradius-sql-dev\n        - name: daloradius-freeradius-radiusd-dev\n          configMap:\n            name: daloradius-freeradius-radiusd-dev\n        - name: daloradius-freeradius-clients-dev\n          configMap:\n            name: daloradius-freeradius-clients-dev\n        - name: daloradius-freeradius-log\n          nfs:\n            server: xxx.xxx.xxx.194\n            path: /disk/k8s-nfs-data/k8s1-t/daloradius-php/nginx_logs\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: freeradius-dev\n  namespace: radius-dev\n  labels:\n    app: freeradius-dev\nspec:\n  type: ClusterIP\n  ports:\n    - name: port-1812\n      port: 1812\n      protocol: UDP\n    - name: port-1813\n      port: 1813\n      protocol: UDP\n  selector:\n    app: freeradius-dev\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: freeradius-dev-svc\n  namespace: radius-dev\n  labels:\n    app: freeradius-dev\nspec:\n  type: NodePort\n  ports:\n    - name: port-1812\n      port: 1812\n      targetPort: 1812\n      nodePort: 1812\n      protocol: UDP\n    - name: port-1813\n      port: 1813\n      targetPort: 1813\n      nodePort: 1813\n      protocol: UDP\n  selector:\n    app: freeradius-dev\n```\n\n#### configmap-freeradius-radiusd-conf.yaml \n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-freeradius-radiusd-dev\n  labels:\n    app: daloradius-freeradius-radiusd-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  radiusd.conf: |\n    prefix = /usr\n    exec_prefix = /usr\n    sysconfdir = /etc\n    localstatedir = /var\n    sbindir = ${exec_prefix}/sbin\n    logdir = /nginx_logs\n    raddbdir = /etc/freeradius\n    radacctdir = ${logdir}/radacct\n\n\n    name = freeradius\n    confdir = ${raddbdir}\n    modconfdir = ${confdir}/mods-config\n    certdir = ${confdir}/certs\n    cadir   = ${confdir}/certs\n    run_dir = ${localstatedir}/run/${name}\n\n    # Should likely be ${localstatedir}/lib/radiusd\n    db_dir = ${raddbdir}\n\n\n    libdir = /usr/lib/freeradius\n\n\n    pidfile = ${run_dir}/${name}.pid\n\n    correct_escapes = true\n\n\n    max_request_time = 30\n\n    cleanup_delay = 5\n\n    max_requests = 16384\n\n    hostname_lookups = no\n\n\n    log {\n\n     destination = files\n\n     colourise = yes\n\n     file = ${logdir}/radius.log\n\n     syslog_facility = daemon\n\n     stripped_names = no\n\n     auth = yes\n\n     # auth_accept = no\n     # auth_reject = no\n     auth_badpass = yes\n     auth_goodpass = yes\n     msg_denied = \"You are already logged in - access denied\"\n    }\n\n    checkrad = ${sbindir}/checkrad\n\n    ENV {\n\n    }\n\n\n    security {\n\n     user = freerad\n     group = freerad\n\n     allow_core_dumps = no\n\n     max_attributes = 200\n\n     reject_delay = 1\n\n     status_server = yes\n\n\n    }\n\n    proxy_requests  = yes\n    $INCLUDE proxy.conf\n\n    $INCLUDE clients.conf\n\n    thread pool {\n\n     start_servers = 5\n\n     max_servers = 32\n\n     min_spare_servers = 3\n     max_spare_servers = 10\n\n     max_requests_per_server = 0\n\n     auto_limit_acct = no\n    }\n\n    modules {\n\n     $INCLUDE mods-enabled/\n    }\n\n\n    instantiate {\n\n    }\n\n\n    policy {\n     $INCLUDE policy.d/\n    }\n\n    $INCLUDE sites-enabled/\n\n\n```\n\n#### configmap-freeradius-clients-conf.yaml\n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-freeradius-clients-dev\n  labels:\n    app: daloradius-freeradius-clients-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  clients.conf: |\n    client php-fpm {\n     ipaddr = php-fpm\n     secret  = testing123\n    }\n    client localhost {\n     ipaddr = 127.0.0.1\n     proto = *\n     secret = testing123\n     require_message_authenticator = no\n     nas_type  = other # localhost isn't usually a NAS...\n     limit {\n      max_connections = 16\n      lifetime = 0\n      idle_timeout = 30\n     }\n    }\n    client localhost_ipv6 {\n     ipv6addr = ::1\n     secret  = testing123\n    }\n```\n\n\n#### configmap-freeradius-sql.yaml\n\n> 主要是修改 Connection info 的内容\n\n```\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-freeradius-sql-dev\n  labels:\n    app: daloradius-freeradius-sql-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  sql: |\n    sql {\n        dialect = \"mysql\"\n        driver = \"rlm_sql_mysql\"\n        sqlite {\n            filename = \"/tmp/freeradius.db\"\n            busy_timeout = 200\n            bootstrap = \"${modconfdir}/${..:name}/main/sqlite/schema.sql\"\n    }\n\n    mysql {\n        }\n        warnings = auto\n    }\n\n    postgresql {\n        send_application_name = yes\n    }\n\n    mongo {\n        appname = \"freeradius\"\n        tls {\n             certificate_file = /path/to/file\n             certificate_password = \"password\"\n             ca_file = /path/to/file\n             ca_dir = /path/to/directory\n             crl_file = /path/to/file\n             weak_cert_validation = false\n             allow_invalid_hostname = false\n            }\n    }\n\n    server = \"k8s-db-t.xxx.com\"\n    port = 3326\n    login = \"radius\"\n    password = \"xxxxxxxxxxxxxxxxxx\"\n    read_clients = yes\n    radius_db = \"radius\"\n    acct_table1 = \"radacct\"\n    acct_table2 = \"radacct\"\n    postauth_table = \"radpostauth\"\n    authcheck_table = \"radcheck\"\n    groupcheck_table = \"radgroupcheck\"\n    authreply_table = \"radreply\"\n    groupreply_table = \"radgroupreply\"\n    usergroup_table = \"radusergroup\"\n    delete_stale_sessions = yes\n\n    pool {\n        start = ${thread[pool].start_servers}\n        min = ${thread[pool].min_spare_servers}\n        max = ${thread[pool].max_servers}\n        spare = ${thread[pool].max_spare_servers}\n        uses = 0\n        retry_delay = 30\n        lifetime = 0\n        idle_timeout = 60\n    }\n    client_table = \"nas\"\n    group_attribute = \"SQL-Group\"\n    $INCLUDE ${modconfdir}/${.:name}/main/${dialect}/queries.conf\n    }\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 四 部署nignx+php7的daloradius web管理后台\n\n#### php7部署配置\n\n##### php镜像安装扩展 Dockerfile\n\n```yaml\nfrom hub.xxx.com/php:develop\n\nuser root\n\nRUN pear install DB \\\n  && pear install -a Mail \\\n  && pear install -a Mail_Mime\n```\n\n##### deployment-php.yml\n\n```yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: daloradius-php-dev\n  labels:\n    app: daloradius-php-dev\n  namespace: radius-dev\nspec:\n  replicas: 1\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  selector:\n    matchLabels:\n      app: daloradius-php-dev\n  template:\n    metadata:\n      labels:\n        app: daloradius-php-dev\n    spec:\n      containers:\n      - name: daloradius-php-dev\n        image: hub.xxx.com/php:radius\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 9000\n          name: fpm-9000\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"600m\"\n        volumeMounts:\n        - name: daloradius-nginx-dev\n          mountPath: /webwww\n        - name: daloradius-php-cfg-dev\n          mountPath: \"/usr/local/etc/php/php.ini\"\n          subPath: php.ini\n        - name: daloradius-fpm-cfg-dev\n          mountPath: \"/usr/local/etc/php-fpm.d/www.conf\"\n          subPath: www.conf\n      volumes:\n        - name: daloradius-nginx-dev\n          nfs:\n            server: xxx.xxx.xxx.194\n            path: /disk/k8s-nfs-data/k8s1-t/daloradius-php\n        - name: daloradius-php-cfg-dev\n          configMap:\n            name: daloradius-php-cfg-dev\n        - name: daloradius-fpm-cfg-dev\n          configMap:\n            name: daloradius-fpm-cfg-dev\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: daloradius-php-dev\n  namespace: radius-dev\n  labels:\n    app: daloradius-php-dev\nspec:\n  type: ClusterIP\n  ports:\n    - name: fpm-9000\n      port: 9000\n      protocol: TCP\n  selector:\n    app: daloradius-php-dev\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: daloradius-php-dev-svc\n  namespace: radius-dev\n  labels:\n    app: daloradius-php-dev\nspec:\n  type: NodePort\n  selector:\n    app: daloradius-php-dev\n  ports:\n   - name: fpm-9000\n     port: 9000\n     targetPort: 9000\n     nodePort: 32101\n     protocol: TCP\n```\n\n##### configmap-php-fpm.yaml\n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-fpm-cfg-dev\n  labels:\n    app: daloradius-fpm-cfg-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  www.conf: |\n        [www]\n        user = 101\n        group = 101\n        listen = 127.0.0.1:9000\n        pm = static\n        pm.max_children = 20\n        pm.start_servers = 10\n        pm.min_spare_servers = 5\n        pm.max_spare_servers = 5\n```\n\n\n##### configmap-php.yaml\n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-php-cfg-dev\n  labels:\n    app: daloradius-php-cfg-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  php.ini: |\n        [PHP]\n        engine = On\n        short_open_tag = Off\n        precision = 14\n        output_buffering = 4096\n        zlib.output_compression = Off\n        implicit_flush = Off\n        unserialize_callback_func =\n        serialize_precision = 17\n        disable_functions =\n        disable_classes =\n        zend.enable_gc = On\n        expose_php = On\n        max_execution_time = 30\n        max_input_time = 60\n        memory_limit = 128M\n        max_input_vars = 10000\n        error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT\n        display_errors = On\n        display_startup_errors = Off\n        log_errors = On\n        log_errors_max_len = 1024\n        ignore_repeated_errors = Off\n        ignore_repeated_source = Off\n        report_memleaks = On\n        track_errors = Off\n        html_errors = On\n        error_log = php_errors.log\n        variables_order = \"GPCS\"\n        request_order = \"GP\"\n        register_argc_argv = Off\n        auto_globals_jit = On\n        post_max_size = 8M\n        auto_prepend_file =\n        auto_append_file =\n        default_mimetype = \"text/html\"\n        default_charset = \"UTF-8\"\n        doc_root =\n        user_dir =\n        enable_dl = Off\n        file_uploads = On\n        upload_max_filesize = 2M\n        max_file_uploads = 20\n        allow_url_fopen = On\n        allow_url_include = Off\n        default_socket_timeout = 60\n        [CLI Server]\n        cli_server.color = On\n        [Date]\n        date.timezone =Asia/Shanghai\n        [filter]\n        [iconv]\n        [intl]\n        [sqlite3]\n        [Pcre]\n        [Pdo]\n        [Pdo_mysql]\n        pdo_mysql.cache_size = 2000\n        pdo_mysql.default_socket=\n        [Phar]\n        [mail function]\n        SMTP = localhost\n        smtp_port = 25\n        mail.add_x_header = On\n        [SQL]\n        sql.safe_mode = Off\n        [ODBC]\n        odbc.allow_persistent = On\n        odbc.check_persistent = On\n        odbc.max_persistent = -1\n        odbc.max_links = -1\n        odbc.defaultlrl = 4096\n        odbc.defaultbinmode = 1\n        [Interbase]\n        ibase.allow_persistent = 1\n        ibase.max_persistent = -1\n        ibase.max_links = -1\n        ibase.timestampformat = \"%Y-%m-%d %H:%M:%S\"\n        ibase.dateformat = \"%Y-%m-%d\"\n        ibase.timeformat = \"%H:%M:%S\"\n        [MySQLi]\n        mysqli.max_persistent = -1\n        mysqli.allow_persistent = On\n        mysqli.max_links = -1\n        mysqli.cache_size = 2000\n        mysqli.default_port = 3306\n        mysqli.default_socket =\n        mysqli.default_host =\n        mysqli.default_user =\n        mysqli.default_pw =\n        mysqli.reconnect = Off\n        [mysqlnd]\n        mysqlnd.collect_statistics = On\n        mysqlnd.collect_memory_statistics = Off\n        [OCI8]\n        [PostgreSQL]\n        pgsql.allow_persistent = On\n        pgsql.auto_reset_persistent = Off\n        pgsql.max_persistent = -1\n        pgsql.max_links = -1\n        pgsql.ignore_notice = 0\n        pgsql.log_notice = 0\n        [bcmath]\n        bcmath.scale = 0\n        [browscap]\n        [Session]\n        session.save_handler = redis\n        session.save_path = \"tcp://xxx.xxx.xxx.194:6399\"\n        session.use_strict_mode = 0\n        session.use_cookies = 1\n        session.use_only_cookies = 1\n        session.name = PHPSESSID\n        session.auto_start = 0\n        session.cookie_lifetime = 0\n        session.cookie_path = /\n        session.cookie_domain =\n        session.cookie_httponly =\n        session.serialize_handler = php\n        session.gc_probability = 1\n        session.gc_divisor = 1000\n        session.gc_maxlifetime = 1440\n        session.referer_check =\n        session.cache_limiter = nocache\n        session.cache_expire = 180\n        session.use_trans_sid = 0\n        session.hash_function = 0\n        session.hash_bits_per_character = 5\n        url_rewriter.tags = \"a=href,area=href,frame=src,input=src,form=fakeentry\"\n        [Assertion]\n        zend.assertions = -1\n        tidy.clean_output = Off\n        [soap]\n        soap.wsdl_cache_enabled=1\n        soap.wsdl_cache_dir=\"/tmp\"\n        soap.wsdl_cache_ttl=86400\n        soap.wsdl_cache_limit = 5\n        [sysvshm]\n        [ldap]\n        ldap.max_links = -1\n```\n\n\n#### nginx部署配置\n\n##### deployment-nginx.yml\n\n```yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: daloradius-nginx-dev\n  labels:\n    app: daloradius-nginx-dev\n  namespace: radius-dev\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: daloradius-nginx-dev\n  template:\n    metadata:\n      labels:\n        app: daloradius-nginx-dev\n    spec:\n      containers:\n      - name: daloradius-nginx-dev\n        image: hub.xxx.com/nginx:1.16.0-develop\n        ports:\n        - containerPort: 80\n          name: nginx-80\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"30m\"\n          limits:\n            cpu: \"500m\"\n        volumeMounts:\n        - name: nginx-www-dev\n          mountPath: /webwww\n        - name: daloradius-nginx-dev-cm\n          mountPath: /etc/nginx/nginx.conf\n          subPath: nginx.conf\n      volumes:\n        - name: nginx-www-dev\n          nfs:\n            server: xxx.xxx.xxx.194\n            path: /disk/k8s-nfs-data/k8s1-t/daloradius-php\n        - name: daloradius-nginx-dev-cm\n          configMap:\n            name: daloradius-nginx-dev-cm\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   app: daloradius-nginx-dev\n name: daloradius-nginx-dev\n namespace: radius-dev\nspec:\n type: NodePort\n ports:\n   - name: nginx-80\n     port: 80\n     targetPort: 80\n     nodePort: 32100\n     protocol: TCP\n selector:\n   app: daloradius-nginx-dev\n---\n```\n\n##### configmap-php-nginx.yaml\n\n```yaml\n---\nkind: ConfigMap\nmetadata:\n  name: daloradius-nginx-dev-cm\n  labels:\n    app: daloradius-nginx-dev\n  namespace: radius-dev\napiVersion: v1\ndata:\n  nginx.conf: |\n    user  www-data;\n    worker_processes  1;\n\n    error_log  /var/log/nginx/error.log warn;\n    pid        /var/run/nginx.pid;\n\n\n    events {\n        worker_connections  1024;\n    }\n\n\n    http {\n        include       /etc/nginx/mime.types;\n        default_type  application/octet-stream;\n\n        log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                          '$status $body_bytes_sent \"$http_referer\" '\n                          '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n        access_log  /var/log/nginx/access.log  main;\n\n        sendfile        on;\n        #tcp_nopush     on;\n\n        keepalive_timeout  65;\n\n        #gzip  on;\n\n        include /etc/nginx/conf.d/*.conf;\n        server {\n                listen 80 default_server;\n                server_name  radius.xxx.com ;\n                root   /webwww;\n\n                location = /50x.html {\n                    root   html;\n                }\n\n               location / {\n                    index index.php  index.html index.htm;\n                }\n\n                location ~ \\.php$ {\n                    fastcgi_pass   daloradius-php-dev:9000;\n                    fastcgi_index  index.php;\n                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n                    fastcgi_param  HTTP_HOST          $server_name;\n                    include        fastcgi_params;\n                }\n        }\n    }\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 五 测试\n\n#### 通过前端nginx代理转发到nodeport端口\n```\n server {\n        listen  80;\n        charset utf-8;\n        listen 443 ssl http2;\n        server_name radius.xxx.com;\n\n        ssl_certificate   /etc/nginx/server.pem;\n        ssl_certificate_key   /etc/nginx/server.key;\n        ssl_session_timeout 5m;\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n        ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;\n        ssl_prefer_server_ciphers on;\n\n        #转向预发布环境\n        location / {\n            proxy_pass http://xxx.xxx.xxx.221:32100/;\n            proxy_redirect http://$host:32100  http://$host;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n```\n\n#### 配置k8s的ingress\n\n```yaml\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: daloradius-nginx-dev\n  labels:\n    app: daloradius-nginx-dev\n  namespace: radius-dev\n  annotations:\n    kubernetes.io/ingress.class: \"traefik\"\nspec:\n  rules:\n  - host: radius.xxx.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: daloradius-nginx-dev\n          servicePort: 80\n```\n\n#### 登录测试\n\n```\n登录地址: radius.xxx.com\n账号密码: administrator/radius\n```\n\n#### 通过后台新建账号之后, 测试账号连通性\n\n##### 命令行\n```\n# 在freeradius 容器内支线\nradtest xxx xxx 127.0.0.1 0 testing123\n\n\n```\n\n#### 通过radius.xxx.com 管理页面测试连通性\n> 这是认证通过的\n![](//zhangzw001.github.io/images/51/img22.jpg)\n\n> 这是被rejected\n![](//zhangzw001.github.io/images/51/img.jpg)\n","content":"<p>搭建lnmp+freeradius的账号认证服务</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"一-记录\"><a href=\"#一-记录\" class=\"headerlink\" title=\"一 记录\"></a>一 记录</h3><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">docker:</span>   <span class=\"number\">17.03</span><span class=\"number\">.2</span>-ce</span><br><span class=\"line\"><span class=\"symbol\">k8s:</span>   <span class=\"number\">1.15</span><span class=\"number\">.11</span></span><br><span class=\"line\"><span class=\"symbol\">php:</span>   <span class=\"number\">7.0</span><span class=\"number\">.13</span></span><br><span class=\"line\"><span class=\"symbol\">mysql:</span>   <span class=\"number\">5.6</span></span><br><span class=\"line\"><span class=\"symbol\">freeraidus:</span>  <span class=\"number\">3.0</span><span class=\"number\">.21</span></span><br><span class=\"line\"><span class=\"symbol\">daloradius:</span>  <span class=\"number\">1.1</span><span class=\"number\">-2</span> / <span class=\"number\">08</span> Aug <span class=\"number\">2019</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>配置修改简单说明:</p>\n</blockquote>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 数据库创建说明</span><br><span class=\"line\">create database radius;</span><br><span class=\"line\">grant all <span class=\"keyword\">on</span> radius.* to radius@'%' identified <span class=\"keyword\">by</span> 'xxx';</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\"># 导入表结构</span><br><span class=\"line\">mysql -hk8s-<span class=\"keyword\">db</span>-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sql</span><br><span class=\"line\">mysql -hk8s-<span class=\"keyword\">db</span>-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/<span class=\"keyword\">db</span>/mysql-daloradius.sql</span><br><span class=\"line\">mysql -hk8s-<span class=\"keyword\">db</span>-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/<span class=\"keyword\">db</span>/fr2-mysql-daloradius-and-freeradius.sql</span><br><span class=\"line\"></span><br><span class=\"line\">2. 修改freeRADIUS配置</span><br><span class=\"line\">vim /etc/raddb/radiusd.<span class=\"keyword\">conf</span></span><br><span class=\"line\"># 这里我是配合nginx,php统一路径</span><br><span class=\"line\">logdir = /nginx_logs </span><br><span class=\"line\"></span><br><span class=\"line\">3. 修改为sql认证</span><br><span class=\"line\"> <span class=\"keyword\">cd</span> /etc/raddb/mods-enabled</span><br><span class=\"line\"> ln -s ../mods-available/sql</span><br><span class=\"line\"></span><br><span class=\"line\">4. 修改FreeRADIUS中的mysql 配置文件</span><br><span class=\"line\"> dialect = <span class=\"string\">\"mysql\"</span></span><br><span class=\"line\"> <span class=\"comment\">//下列配置前的注释去掉</span></span><br><span class=\"line\"> server = <span class=\"string\">\"k8s-db-t.xxx.com\"</span> <span class=\"comment\">//mysql服务器地址,如果是同一个k8s集群, 写k8s内网的svc域名即可,例如: freeradius-mysql-dev 或 freeradius-mysql-dev.radius-dev.svc.cluster.local</span></span><br><span class=\"line\"> port = 3326 <span class=\"comment\">//mysql 端口号</span></span><br><span class=\"line\"> login = <span class=\"string\">\"radius\"</span> <span class=\"comment\">//myqsl 登录用户名</span></span><br><span class=\"line\"> password = <span class=\"string\">\"xxx\"</span> <span class=\"comment\">//mysql 登录密码</span></span><br><span class=\"line\"> read_clients = yes</span><br><span class=\"line\"></span><br><span class=\"line\">5. 开放daloradius服务器验证权限</span><br><span class=\"line\">vim /etc/raddb/clients.<span class=\"keyword\">conf</span></span><br><span class=\"line\">client php-fpm &#123;</span><br><span class=\"line\"> ipaddr = php-fpm</span><br><span class=\"line\"> secret  = testing123</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">6. 修改daloradius默认php配置</span><br><span class=\"line\">vim daloradius-php/library/daloradius.<span class=\"keyword\">conf</span>.php</span><br><span class=\"line\"><span class=\"variable\">$configValues</span>['CONFIG_MAINT_TEST_USER_RADIUSSERVER'] = 'radius';</span><br><span class=\"line\"><span class=\"variable\">$configValues</span>['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'testing123';</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"二-首先搭建数据库\"><a href=\"#二-首先搭建数据库\" class=\"headerlink\" title=\"二 首先搭建数据库\"></a>二 首先搭建数据库</h3><h4 id=\"k8s-freeradius-mysql-dev-5-6-36-configmap-yml\"><a href=\"#k8s-freeradius-mysql-dev-5-6-36-configmap-yml\" class=\"headerlink\" title=\"k8s-freeradius-mysql-dev_5.6.36-configmap.yml\"></a>k8s-freeradius-mysql-dev_5.6.36-configmap.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">my.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    [mysqld]</span></span><br><span class=\"line\"><span class=\"string\">    innodb_file_per_table=1</span></span><br><span class=\"line\"><span class=\"string\">    user=mysql</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    datadir=/data</span></span><br><span class=\"line\"><span class=\"string\">    socket=/data/mysql.sock</span></span><br><span class=\"line\"><span class=\"string\">    symbolic-links=0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    binlog_format=mixed</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    #log-bin=mysql-bin</span></span><br><span class=\"line\"><span class=\"string\">    log-bin=/data/mysql-bin.log</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    #general_log   = 1</span></span><br><span class=\"line\"><span class=\"string\">    #general_log_file = /data/general.log</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    #日志</span></span><br><span class=\"line\"><span class=\"string\">    log-error=/data/mysqld.log</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    innodb_log_file_size = 256M</span></span><br><span class=\"line\"><span class=\"string\">    thread_cache_size = 50</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    max_allowed_packet=16M</span></span><br><span class=\"line\"><span class=\"string\">    max_binlog_size=500M</span></span><br><span class=\"line\"><span class=\"string\">    #old_passwords=1</span></span><br><span class=\"line\"><span class=\"string\">    character-set-server=utf8</span></span><br><span class=\"line\"><span class=\"string\">    max_connections=3000</span></span><br><span class=\"line\"><span class=\"string\">    skip-name-resolve</span></span><br><span class=\"line\"><span class=\"string\">    max_allowed_packet=64M</span></span><br><span class=\"line\"><span class=\"string\">    tmp_table_size=200M</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    server-id=101</span></span><br><span class=\"line\"><span class=\"string\">    port=3306</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    skip_slave_start</span></span><br><span class=\"line\"><span class=\"string\">    expire_logs_days=7</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    [mysqld_safe]</span></span><br><span class=\"line\"><span class=\"string\">    log-error=/data/mysqld.log</span></span><br><span class=\"line\"><span class=\"string\">    pid-file=/data/mysqld.pid</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    [mysql]</span></span><br><span class=\"line\"><span class=\"string\">    no-auto-rehash</span></span><br><span class=\"line\"><span class=\"string\">    user=root</span></span><br><span class=\"line\"><span class=\"string\">    default-character-set=utf8</span></span><br><span class=\"line\"><span class=\"string\">    socket=/data/mysql.sock</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    [client]</span></span><br><span class=\"line\"><span class=\"string\">    socket=/data/mysql.sock</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"k8s-freeradius-mysql-dev-5-6-36-yml\"><a href=\"#k8s-freeradius-mysql-dev-5-6-36-yml\" class=\"headerlink\" title=\"k8s-freeradius-mysql-dev_5.6.36.yml\"></a>k8s-freeradius-mysql-dev_5.6.36.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">         image:</span> <span class=\"string\">hub.xxx.com/mysql:5.6.36-Asia</span></span><br><span class=\"line\"><span class=\"attr\">         ports:</span></span><br><span class=\"line\"><span class=\"attr\">         - containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">           name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">         resources:</span></span><br><span class=\"line\"><span class=\"attr\">           requests:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">           limits:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"attr\">         env:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"xxx\"</span></span><br><span class=\"line\"><span class=\"attr\">         volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">freeradius-mysql-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">freeradius-mysql-dev-conf</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/etc/mysql/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">           subPath:</span> <span class=\"string\">my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">freeradius-mysql-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">xxx.xxx.xxx.194</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s-db-t/freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">freeradius-mysql-dev-conf</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">3326</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-mysql-dev</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建库和账号\"><a href=\"#创建库和账号\" class=\"headerlink\" title=\"创建库和账号\"></a>创建库和账号</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create database radius;</span><br><span class=\"line\">grant all on radius.* to radius@'%' identified by 'xxxxxxxxxxxxxxxxxx';</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 测试登录</span></span><br><span class=\"line\">mysql -hk8s-db-t.xxx.com -P3326 -uradius -p</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 导入表结构</span></span><br><span class=\"line\">mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sql</span><br><span class=\"line\">mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/mysql-daloradius.sql</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"三-部署freeradius\"><a href=\"#三-部署freeradius\" class=\"headerlink\" title=\"三 部署freeradius\"></a>三 部署freeradius</h3><h4 id=\"deployment-freeradius-yml\"><a href=\"#deployment-freeradius-yml\" class=\"headerlink\" title=\"deployment-freeradius.yml\"></a>deployment-freeradius.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/freeradius-server:3.0.21</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">1812</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">port-1812</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">1813</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">port-1813</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"30m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-sql-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/raddb/mods-available/sql</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">sql</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-sql-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/raddb/mods-enabled/sql</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">sql</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-radiusd-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/raddb/radiusd.conf</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">radiusd.conf</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-clients-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/raddb/clients.conf</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">clients.conf</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-log</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/nginx_logs</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-sql-dev</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-freeradius-sql-dev</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-radiusd-dev</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-freeradius-radiusd-dev</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-clients-dev</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-freeradius-clients-dev</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-freeradius-log</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">xxx.xxx.xxx.194</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/daloradius-php/nginx_logs</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">port-1812</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">1812</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">port-1813</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">1813</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">freeradius-dev-svc</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">port-1812</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">1812</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">1812</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">1812</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">port-1813</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">1813</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">1813</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">1813</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">freeradius-dev</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"configmap-freeradius-radiusd-conf-yaml\"><a href=\"#configmap-freeradius-radiusd-conf-yaml\" class=\"headerlink\" title=\"configmap-freeradius-radiusd-conf.yaml\"></a>configmap-freeradius-radiusd-conf.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-freeradius-radiusd-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-freeradius-radiusd-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">radiusd.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    prefix = /usr</span></span><br><span class=\"line\"><span class=\"string\">    exec_prefix = /usr</span></span><br><span class=\"line\"><span class=\"string\">    sysconfdir = /etc</span></span><br><span class=\"line\"><span class=\"string\">    localstatedir = /var</span></span><br><span class=\"line\"><span class=\"string\">    sbindir = $&#123;exec_prefix&#125;/sbin</span></span><br><span class=\"line\"><span class=\"string\">    logdir = /nginx_logs</span></span><br><span class=\"line\"><span class=\"string\">    raddbdir = /etc/freeradius</span></span><br><span class=\"line\"><span class=\"string\">    radacctdir = $&#123;logdir&#125;/radacct</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    name = freeradius</span></span><br><span class=\"line\"><span class=\"string\">    confdir = $&#123;raddbdir&#125;</span></span><br><span class=\"line\"><span class=\"string\">    modconfdir = $&#123;confdir&#125;/mods-config</span></span><br><span class=\"line\"><span class=\"string\">    certdir = $&#123;confdir&#125;/certs</span></span><br><span class=\"line\"><span class=\"string\">    cadir   = $&#123;confdir&#125;/certs</span></span><br><span class=\"line\"><span class=\"string\">    run_dir = $&#123;localstatedir&#125;/run/$&#123;name&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # Should likely be $&#123;localstatedir&#125;/lib/radiusd</span></span><br><span class=\"line\"><span class=\"string\">    db_dir = $&#123;raddbdir&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    libdir = /usr/lib/freeradius</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    pidfile = $&#123;run_dir&#125;/$&#123;name&#125;.pid</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    correct_escapes = true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    max_request_time = 30</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    cleanup_delay = 5</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    max_requests = 16384</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    hostname_lookups = no</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    log &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     destination = files</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     colourise = yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     file = $&#123;logdir&#125;/radius.log</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     syslog_facility = daemon</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     stripped_names = no</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     auth = yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     # auth_accept = no</span></span><br><span class=\"line\"><span class=\"string\">     # auth_reject = no</span></span><br><span class=\"line\"><span class=\"string\">     auth_badpass = yes</span></span><br><span class=\"line\"><span class=\"string\">     auth_goodpass = yes</span></span><br><span class=\"line\"><span class=\"string\">     msg_denied = \"You are already logged in - access denied\"</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    checkrad = $&#123;sbindir&#125;/checkrad</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    ENV &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    security &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     user = freerad</span></span><br><span class=\"line\"><span class=\"string\">     group = freerad</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     allow_core_dumps = no</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     max_attributes = 200</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     reject_delay = 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     status_server = yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    proxy_requests  = yes</span></span><br><span class=\"line\"><span class=\"string\">    $INCLUDE proxy.conf</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    $INCLUDE clients.conf</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    thread pool &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     start_servers = 5</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     max_servers = 32</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     min_spare_servers = 3</span></span><br><span class=\"line\"><span class=\"string\">     max_spare_servers = 10</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     max_requests_per_server = 0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     auto_limit_acct = no</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    modules &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     $INCLUDE mods-enabled/</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    instantiate &#123;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    policy &#123;</span></span><br><span class=\"line\"><span class=\"string\">     $INCLUDE policy.d/</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    $INCLUDE sites-enabled/</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"configmap-freeradius-clients-conf-yaml\"><a href=\"#configmap-freeradius-clients-conf-yaml\" class=\"headerlink\" title=\"configmap-freeradius-clients-conf.yaml\"></a>configmap-freeradius-clients-conf.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-freeradius-clients-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-freeradius-clients-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">clients.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    client php-fpm &#123;</span></span><br><span class=\"line\"><span class=\"string\">     ipaddr = php-fpm</span></span><br><span class=\"line\"><span class=\"string\">     secret  = testing123</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    client localhost &#123;</span></span><br><span class=\"line\"><span class=\"string\">     ipaddr = 127.0.0.1</span></span><br><span class=\"line\"><span class=\"string\">     proto = *</span></span><br><span class=\"line\"><span class=\"string\">     secret = testing123</span></span><br><span class=\"line\"><span class=\"string\">     require_message_authenticator = no</span></span><br><span class=\"line\"><span class=\"string\">     nas_type  = other # localhost isn't usually a NAS...</span></span><br><span class=\"line\"><span class=\"string\">     limit &#123;</span></span><br><span class=\"line\"><span class=\"string\">      max_connections = 16</span></span><br><span class=\"line\"><span class=\"string\">      lifetime = 0</span></span><br><span class=\"line\"><span class=\"string\">      idle_timeout = 30</span></span><br><span class=\"line\"><span class=\"string\">     &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    client localhost_ipv6 &#123;</span></span><br><span class=\"line\"><span class=\"string\">     ipv6addr = ::1</span></span><br><span class=\"line\"><span class=\"string\">     secret  = testing123</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"configmap-freeradius-sql-yaml\"><a href=\"#configmap-freeradius-sql-yaml\" class=\"headerlink\" title=\"configmap-freeradius-sql.yaml\"></a>configmap-freeradius-sql.yaml</h4><blockquote>\n<p>主要是修改 Connection info 的内容</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: daloradius-freeradius-sql-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: daloradius-freeradius-sql-dev</span><br><span class=\"line\">  namespace: radius-dev</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  sql: |</span><br><span class=\"line\">    sql &#123;</span><br><span class=\"line\">        dialect = <span class=\"string\">\"mysql\"</span></span><br><span class=\"line\">        driver = <span class=\"string\">\"rlm_sql_mysql\"</span></span><br><span class=\"line\">        sqlite &#123;</span><br><span class=\"line\">            filename = <span class=\"string\">\"/tmp/freeradius.db\"</span></span><br><span class=\"line\">            busy_timeout = 200</span><br><span class=\"line\">            bootstrap = <span class=\"string\">\"<span class=\"variable\">$&#123;modconfdir&#125;</span>/<span class=\"variable\">$&#123;..:name&#125;</span>/main/sqlite/schema.sql\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mysql &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        warnings = auto</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    postgresql &#123;</span><br><span class=\"line\">        send_application_name = <span class=\"literal\">yes</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    mongo &#123;</span><br><span class=\"line\">        appname = <span class=\"string\">\"freeradius\"</span></span><br><span class=\"line\">        tls &#123;</span><br><span class=\"line\">             certificate_file = /path/<span class=\"keyword\">to</span>/file</span><br><span class=\"line\">             certificate_password = <span class=\"string\">\"password\"</span></span><br><span class=\"line\">             ca_file = /path/<span class=\"keyword\">to</span>/file</span><br><span class=\"line\">             ca_dir = /path/<span class=\"keyword\">to</span>/directory</span><br><span class=\"line\">             crl_file = /path/<span class=\"keyword\">to</span>/file</span><br><span class=\"line\">             weak_cert_validation = <span class=\"literal\">false</span></span><br><span class=\"line\">             allow_invalid_hostname = <span class=\"literal\">false</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"built_in\"> server </span>= <span class=\"string\">\"k8s-db-t.xxx.com\"</span></span><br><span class=\"line\">   <span class=\"built_in\"> port </span>= 3326</span><br><span class=\"line\">    login = <span class=\"string\">\"radius\"</span></span><br><span class=\"line\">    password = <span class=\"string\">\"xxxxxxxxxxxxxxxxxx\"</span></span><br><span class=\"line\">    read_clients = <span class=\"literal\">yes</span></span><br><span class=\"line\">    radius_db = <span class=\"string\">\"radius\"</span></span><br><span class=\"line\">    acct_table1 = <span class=\"string\">\"radacct\"</span></span><br><span class=\"line\">    acct_table2 = <span class=\"string\">\"radacct\"</span></span><br><span class=\"line\">    postauth_table = <span class=\"string\">\"radpostauth\"</span></span><br><span class=\"line\">    authcheck_table = <span class=\"string\">\"radcheck\"</span></span><br><span class=\"line\">    groupcheck_table = <span class=\"string\">\"radgroupcheck\"</span></span><br><span class=\"line\">    authreply_table = <span class=\"string\">\"radreply\"</span></span><br><span class=\"line\">    groupreply_table = <span class=\"string\">\"radgroupreply\"</span></span><br><span class=\"line\">    usergroup_table = <span class=\"string\">\"radusergroup\"</span></span><br><span class=\"line\">    delete_stale_sessions = <span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"built_in\"> pool </span>&#123;</span><br><span class=\"line\">        start = <span class=\"variable\">$&#123;thread[pool].start_servers&#125;</span></span><br><span class=\"line\">        min = <span class=\"variable\">$&#123;thread[pool].min_spare_servers&#125;</span></span><br><span class=\"line\">        max = <span class=\"variable\">$&#123;thread[pool].max_servers&#125;</span></span><br><span class=\"line\">        spare = <span class=\"variable\">$&#123;thread[pool].max_spare_servers&#125;</span></span><br><span class=\"line\">        uses = 0</span><br><span class=\"line\">        retry_delay = 30</span><br><span class=\"line\">        lifetime = 0</span><br><span class=\"line\">        idle_timeout = 60</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    client_table = <span class=\"string\">\"nas\"</span></span><br><span class=\"line\">    group_attribute = <span class=\"string\">\"SQL-Group\"</span></span><br><span class=\"line\">    <span class=\"variable\">$INCLUDE</span> <span class=\"variable\">$&#123;modconfdir&#125;</span>/<span class=\"variable\">$&#123;.:name&#125;</span>/main/<span class=\"variable\">$&#123;dialect&#125;</span>/queries.conf</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"四-部署nignx-php7的daloradius-web管理后台\"><a href=\"#四-部署nignx-php7的daloradius-web管理后台\" class=\"headerlink\" title=\"四 部署nignx+php7的daloradius web管理后台\"></a>四 部署nignx+php7的daloradius web管理后台</h3><h4 id=\"php7部署配置\"><a href=\"#php7部署配置\" class=\"headerlink\" title=\"php7部署配置\"></a>php7部署配置</h4><h5 id=\"php镜像安装扩展-Dockerfile\"><a href=\"#php镜像安装扩展-Dockerfile\" class=\"headerlink\" title=\"php镜像安装扩展 Dockerfile\"></a>php镜像安装扩展 Dockerfile</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">from</span> <span class=\"string\">hub.xxx.com/php:develop</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">user</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">pear</span> <span class=\"string\">install</span> <span class=\"string\">DB</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">&amp;&amp;</span> <span class=\"string\">pear</span> <span class=\"string\">install</span> <span class=\"bullet\">-a</span> <span class=\"string\">Mail</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">&amp;&amp;</span> <span class=\"string\">pear</span> <span class=\"string\">install</span> <span class=\"bullet\">-a</span> <span class=\"string\">Mail_Mime</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"deployment-php-yml\"><a href=\"#deployment-php-yml\" class=\"headerlink\" title=\"deployment-php.yml\"></a>deployment-php.yml</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  strategy:</span></span><br><span class=\"line\"><span class=\"attr\">    rollingUpdate:</span></span><br><span class=\"line\"><span class=\"attr\">      maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">      maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/php:radius</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">fpm-9000</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"600m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/etc/php/php.ini\"</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">php.ini</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/etc/php-fpm.d/www.conf\"</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">www.conf</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">xxx.xxx.xxx.194</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/daloradius-php</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">fpm-9000</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-php-dev-svc</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-dev</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">fpm-9000</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">32101</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"configmap-php-fpm-yaml\"><a href=\"#configmap-php-fpm-yaml\" class=\"headerlink\" title=\"configmap-php-fpm.yaml\"></a>configmap-php-fpm.yaml</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">www.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        [www]</span></span><br><span class=\"line\"><span class=\"string\">        user = 101</span></span><br><span class=\"line\"><span class=\"string\">        group = 101</span></span><br><span class=\"line\"><span class=\"string\">        listen = 127.0.0.1:9000</span></span><br><span class=\"line\"><span class=\"string\">        pm = static</span></span><br><span class=\"line\"><span class=\"string\">        pm.max_children = 20</span></span><br><span class=\"line\"><span class=\"string\">        pm.start_servers = 10</span></span><br><span class=\"line\"><span class=\"string\">        pm.min_spare_servers = 5</span></span><br><span class=\"line\"><span class=\"string\">        pm.max_spare_servers = 5</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"configmap-php-yaml\"><a href=\"#configmap-php-yaml\" class=\"headerlink\" title=\"configmap-php.yaml\"></a>configmap-php.yaml</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">php.ini:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        [PHP]</span></span><br><span class=\"line\"><span class=\"string\">        engine = On</span></span><br><span class=\"line\"><span class=\"string\">        short_open_tag = Off</span></span><br><span class=\"line\"><span class=\"string\">        precision = 14</span></span><br><span class=\"line\"><span class=\"string\">        output_buffering = 4096</span></span><br><span class=\"line\"><span class=\"string\">        zlib.output_compression = Off</span></span><br><span class=\"line\"><span class=\"string\">        implicit_flush = Off</span></span><br><span class=\"line\"><span class=\"string\">        unserialize_callback_func =</span></span><br><span class=\"line\"><span class=\"string\">        serialize_precision = 17</span></span><br><span class=\"line\"><span class=\"string\">        disable_functions =</span></span><br><span class=\"line\"><span class=\"string\">        disable_classes =</span></span><br><span class=\"line\"><span class=\"string\">        zend.enable_gc = On</span></span><br><span class=\"line\"><span class=\"string\">        expose_php = On</span></span><br><span class=\"line\"><span class=\"string\">        max_execution_time = 30</span></span><br><span class=\"line\"><span class=\"string\">        max_input_time = 60</span></span><br><span class=\"line\"><span class=\"string\">        memory_limit = 128M</span></span><br><span class=\"line\"><span class=\"string\">        max_input_vars = 10000</span></span><br><span class=\"line\"><span class=\"string\">        error_reporting = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT</span></span><br><span class=\"line\"><span class=\"string\">        display_errors = On</span></span><br><span class=\"line\"><span class=\"string\">        display_startup_errors = Off</span></span><br><span class=\"line\"><span class=\"string\">        log_errors = On</span></span><br><span class=\"line\"><span class=\"string\">        log_errors_max_len = 1024</span></span><br><span class=\"line\"><span class=\"string\">        ignore_repeated_errors = Off</span></span><br><span class=\"line\"><span class=\"string\">        ignore_repeated_source = Off</span></span><br><span class=\"line\"><span class=\"string\">        report_memleaks = On</span></span><br><span class=\"line\"><span class=\"string\">        track_errors = Off</span></span><br><span class=\"line\"><span class=\"string\">        html_errors = On</span></span><br><span class=\"line\"><span class=\"string\">        error_log = php_errors.log</span></span><br><span class=\"line\"><span class=\"string\">        variables_order = \"GPCS\"</span></span><br><span class=\"line\"><span class=\"string\">        request_order = \"GP\"</span></span><br><span class=\"line\"><span class=\"string\">        register_argc_argv = Off</span></span><br><span class=\"line\"><span class=\"string\">        auto_globals_jit = On</span></span><br><span class=\"line\"><span class=\"string\">        post_max_size = 8M</span></span><br><span class=\"line\"><span class=\"string\">        auto_prepend_file =</span></span><br><span class=\"line\"><span class=\"string\">        auto_append_file =</span></span><br><span class=\"line\"><span class=\"string\">        default_mimetype = \"text/html\"</span></span><br><span class=\"line\"><span class=\"string\">        default_charset = \"UTF-8\"</span></span><br><span class=\"line\"><span class=\"string\">        doc_root =</span></span><br><span class=\"line\"><span class=\"string\">        user_dir =</span></span><br><span class=\"line\"><span class=\"string\">        enable_dl = Off</span></span><br><span class=\"line\"><span class=\"string\">        file_uploads = On</span></span><br><span class=\"line\"><span class=\"string\">        upload_max_filesize = 2M</span></span><br><span class=\"line\"><span class=\"string\">        max_file_uploads = 20</span></span><br><span class=\"line\"><span class=\"string\">        allow_url_fopen = On</span></span><br><span class=\"line\"><span class=\"string\">        allow_url_include = Off</span></span><br><span class=\"line\"><span class=\"string\">        default_socket_timeout = 60</span></span><br><span class=\"line\"><span class=\"string\">        [CLI Server]</span></span><br><span class=\"line\"><span class=\"string\">        cli_server.color = On</span></span><br><span class=\"line\"><span class=\"string\">        [Date]</span></span><br><span class=\"line\"><span class=\"string\">        date.timezone =Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"string\">        [filter]</span></span><br><span class=\"line\"><span class=\"string\">        [iconv]</span></span><br><span class=\"line\"><span class=\"string\">        [intl]</span></span><br><span class=\"line\"><span class=\"string\">        [sqlite3]</span></span><br><span class=\"line\"><span class=\"string\">        [Pcre]</span></span><br><span class=\"line\"><span class=\"string\">        [Pdo]</span></span><br><span class=\"line\"><span class=\"string\">        [Pdo_mysql]</span></span><br><span class=\"line\"><span class=\"string\">        pdo_mysql.cache_size = 2000</span></span><br><span class=\"line\"><span class=\"string\">        pdo_mysql.default_socket=</span></span><br><span class=\"line\"><span class=\"string\">        [Phar]</span></span><br><span class=\"line\"><span class=\"string\">        [mail function]</span></span><br><span class=\"line\"><span class=\"string\">        SMTP = localhost</span></span><br><span class=\"line\"><span class=\"string\">        smtp_port = 25</span></span><br><span class=\"line\"><span class=\"string\">        mail.add_x_header = On</span></span><br><span class=\"line\"><span class=\"string\">        [SQL]</span></span><br><span class=\"line\"><span class=\"string\">        sql.safe_mode = Off</span></span><br><span class=\"line\"><span class=\"string\">        [ODBC]</span></span><br><span class=\"line\"><span class=\"string\">        odbc.allow_persistent = On</span></span><br><span class=\"line\"><span class=\"string\">        odbc.check_persistent = On</span></span><br><span class=\"line\"><span class=\"string\">        odbc.max_persistent = -1</span></span><br><span class=\"line\"><span class=\"string\">        odbc.max_links = -1</span></span><br><span class=\"line\"><span class=\"string\">        odbc.defaultlrl = 4096</span></span><br><span class=\"line\"><span class=\"string\">        odbc.defaultbinmode = 1</span></span><br><span class=\"line\"><span class=\"string\">        [Interbase]</span></span><br><span class=\"line\"><span class=\"string\">        ibase.allow_persistent = 1</span></span><br><span class=\"line\"><span class=\"string\">        ibase.max_persistent = -1</span></span><br><span class=\"line\"><span class=\"string\">        ibase.max_links = -1</span></span><br><span class=\"line\"><span class=\"string\">        ibase.timestampformat = \"%Y-%m-%d %H:%M:%S\"</span></span><br><span class=\"line\"><span class=\"string\">        ibase.dateformat = \"%Y-%m-%d\"</span></span><br><span class=\"line\"><span class=\"string\">        ibase.timeformat = \"%H:%M:%S\"</span></span><br><span class=\"line\"><span class=\"string\">        [MySQLi]</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.max_persistent = -1</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.allow_persistent = On</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.max_links = -1</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.cache_size = 2000</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.default_port = 3306</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.default_socket =</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.default_host =</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.default_user =</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.default_pw =</span></span><br><span class=\"line\"><span class=\"string\">        mysqli.reconnect = Off</span></span><br><span class=\"line\"><span class=\"string\">        [mysqlnd]</span></span><br><span class=\"line\"><span class=\"string\">        mysqlnd.collect_statistics = On</span></span><br><span class=\"line\"><span class=\"string\">        mysqlnd.collect_memory_statistics = Off</span></span><br><span class=\"line\"><span class=\"string\">        [OCI8]</span></span><br><span class=\"line\"><span class=\"string\">        [PostgreSQL]</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.allow_persistent = On</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.auto_reset_persistent = Off</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.max_persistent = -1</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.max_links = -1</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.ignore_notice = 0</span></span><br><span class=\"line\"><span class=\"string\">        pgsql.log_notice = 0</span></span><br><span class=\"line\"><span class=\"string\">        [bcmath]</span></span><br><span class=\"line\"><span class=\"string\">        bcmath.scale = 0</span></span><br><span class=\"line\"><span class=\"string\">        [browscap]</span></span><br><span class=\"line\"><span class=\"string\">        [Session]</span></span><br><span class=\"line\"><span class=\"string\">        session.save_handler = redis</span></span><br><span class=\"line\"><span class=\"string\">        session.save_path = \"tcp://xxx.xxx.xxx.194:6399\"</span></span><br><span class=\"line\"><span class=\"string\">        session.use_strict_mode = 0</span></span><br><span class=\"line\"><span class=\"string\">        session.use_cookies = 1</span></span><br><span class=\"line\"><span class=\"string\">        session.use_only_cookies = 1</span></span><br><span class=\"line\"><span class=\"string\">        session.name = PHPSESSID</span></span><br><span class=\"line\"><span class=\"string\">        session.auto_start = 0</span></span><br><span class=\"line\"><span class=\"string\">        session.cookie_lifetime = 0</span></span><br><span class=\"line\"><span class=\"string\">        session.cookie_path = /</span></span><br><span class=\"line\"><span class=\"string\">        session.cookie_domain =</span></span><br><span class=\"line\"><span class=\"string\">        session.cookie_httponly =</span></span><br><span class=\"line\"><span class=\"string\">        session.serialize_handler = php</span></span><br><span class=\"line\"><span class=\"string\">        session.gc_probability = 1</span></span><br><span class=\"line\"><span class=\"string\">        session.gc_divisor = 1000</span></span><br><span class=\"line\"><span class=\"string\">        session.gc_maxlifetime = 1440</span></span><br><span class=\"line\"><span class=\"string\">        session.referer_check =</span></span><br><span class=\"line\"><span class=\"string\">        session.cache_limiter = nocache</span></span><br><span class=\"line\"><span class=\"string\">        session.cache_expire = 180</span></span><br><span class=\"line\"><span class=\"string\">        session.use_trans_sid = 0</span></span><br><span class=\"line\"><span class=\"string\">        session.hash_function = 0</span></span><br><span class=\"line\"><span class=\"string\">        session.hash_bits_per_character = 5</span></span><br><span class=\"line\"><span class=\"string\">        url_rewriter.tags = \"a=href,area=href,frame=src,input=src,form=fakeentry\"</span></span><br><span class=\"line\"><span class=\"string\">        [Assertion]</span></span><br><span class=\"line\"><span class=\"string\">        zend.assertions = -1</span></span><br><span class=\"line\"><span class=\"string\">        tidy.clean_output = Off</span></span><br><span class=\"line\"><span class=\"string\">        [soap]</span></span><br><span class=\"line\"><span class=\"string\">        soap.wsdl_cache_enabled=1</span></span><br><span class=\"line\"><span class=\"string\">        soap.wsdl_cache_dir=\"/tmp\"</span></span><br><span class=\"line\"><span class=\"string\">        soap.wsdl_cache_ttl=86400</span></span><br><span class=\"line\"><span class=\"string\">        soap.wsdl_cache_limit = 5</span></span><br><span class=\"line\"><span class=\"string\">        [sysvshm]</span></span><br><span class=\"line\"><span class=\"string\">        [ldap]</span></span><br><span class=\"line\"><span class=\"string\">        ldap.max_links = -1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"nginx部署配置\"><a href=\"#nginx部署配置\" class=\"headerlink\" title=\"nginx部署配置\"></a>nginx部署配置</h4><h5 id=\"deployment-nginx-yml\"><a href=\"#deployment-nginx-yml\" class=\"headerlink\" title=\"deployment-nginx.yml\"></a>deployment-nginx.yml</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.xxx.com/nginx:1.16.0-develop</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">nginx-80</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"30m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-nginx-dev-cm</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/nginx/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"string\">xxx.xxx.xxx.194</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s1-t/daloradius-php</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">daloradius-nginx-dev-cm</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">daloradius-nginx-dev-cm</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">nginx-80</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">32100</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"configmap-php-nginx-yaml\"><a href=\"#configmap-php-nginx-yaml\" class=\"headerlink\" title=\"configmap-php-nginx.yaml\"></a>configmap-php-nginx.yaml</h5><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-nginx-dev-cm</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">nginx.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    user  www-data;</span></span><br><span class=\"line\"><span class=\"string\">    worker_processes  1;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    error_log  /var/log/nginx/error.log warn;</span></span><br><span class=\"line\"><span class=\"string\">    pid        /var/run/nginx.pid;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    events &#123;</span></span><br><span class=\"line\"><span class=\"string\">        worker_connections  1024;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    http &#123;</span></span><br><span class=\"line\"><span class=\"string\">        include       /etc/nginx/mime.types;</span></span><br><span class=\"line\"><span class=\"string\">        default_type  application/octet-stream;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span></span><br><span class=\"line\"><span class=\"string\">                          '$status $body_bytes_sent \"$http_referer\" '</span></span><br><span class=\"line\"><span class=\"string\">                          '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        access_log  /var/log/nginx/access.log  main;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        sendfile        on;</span></span><br><span class=\"line\"><span class=\"string\">        #tcp_nopush     on;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        keepalive_timeout  65;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        #gzip  on;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        include /etc/nginx/conf.d/*.conf;</span></span><br><span class=\"line\"><span class=\"string\">        server &#123;</span></span><br><span class=\"line\"><span class=\"string\">                listen 80 default_server;</span></span><br><span class=\"line\"><span class=\"string\">                server_name  radius.xxx.com ;</span></span><br><span class=\"line\"><span class=\"string\">                root   /webwww;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">                location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    root   html;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">               location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    index index.php  index.html index.htm;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">                location ~ \\.php$ &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_pass   daloradius-php-dev:9000;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_index  index.php;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span></span><br><span class=\"line\"><span class=\"string\">                    fastcgi_param  HTTP_HOST          $server_name;</span></span><br><span class=\"line\"><span class=\"string\">                    include        fastcgi_params;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"五-测试\"><a href=\"#五-测试\" class=\"headerlink\" title=\"五 测试\"></a>五 测试</h3><h4 id=\"通过前端nginx代理转发到nodeport端口\"><a href=\"#通过前端nginx代理转发到nodeport端口\" class=\"headerlink\" title=\"通过前端nginx代理转发到nodeport端口\"></a>通过前端nginx代理转发到nodeport端口</h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>  <span class=\"number\">80</span>;</span><br><span class=\"line\">       <span class=\"attribute\">charset</span> utf-<span class=\"number\">8</span>;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl http2;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span> radius.xxx.com;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate</span>   /etc/nginx/server.pem;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate_key</span>   /etc/nginx/server.key;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#转向预发布环境</span></span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">proxy_pass</span> http://xxx.xxx.xxx.221:32100/;</span><br><span class=\"line\">           <span class=\"attribute\">proxy_redirect</span> http://<span class=\"variable\">$host</span>:32100  http://<span class=\"variable\">$host</span>;</span><br><span class=\"line\">           <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">           <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">           <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> = /50x.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置k8s的ingress\"><a href=\"#配置k8s的ingress\" class=\"headerlink\" title=\"配置k8s的ingress\"></a>配置k8s的ingress</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">radius-dev</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">kubernetes.io/ingress.class:</span> <span class=\"string\">\"traefik\"</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">radius.xxx.com</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          serviceName:</span> <span class=\"string\">daloradius-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">          servicePort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"登录测试\"><a href=\"#登录测试\" class=\"headerlink\" title=\"登录测试\"></a>登录测试</h4><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录地址: radius<span class=\"selector-class\">.xxx</span><span class=\"selector-class\">.com</span></span><br><span class=\"line\">账号密码: administrator/radius</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"通过后台新建账号之后-测试账号连通性\"><a href=\"#通过后台新建账号之后-测试账号连通性\" class=\"headerlink\" title=\"通过后台新建账号之后, 测试账号连通性\"></a>通过后台新建账号之后, 测试账号连通性</h4><h5 id=\"命令行\"><a href=\"#命令行\" class=\"headerlink\" title=\"命令行\"></a>命令行</h5><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在freeradius 容器内支线</span><br><span class=\"line\">radtest xxx xxx <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"number\">0</span> testing123</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"通过radius-xxx-com-管理页面测试连通性\"><a href=\"#通过radius-xxx-com-管理页面测试连通性\" class=\"headerlink\" title=\"通过radius.xxx.com 管理页面测试连通性\"></a>通过radius.xxx.com 管理页面测试连通性</h4><blockquote>\n<p>这是认证通过的<br><img src=\"//zhangzw001.github.io/images/51/img22.jpg\" alt></p>\n</blockquote>\n<blockquote>\n<p>这是被rejected<br><img src=\"//zhangzw001.github.io/images/51/img.jpg\" alt></p>\n</blockquote>\n","comments":true,"permalink":"https://blog.k1s.club/2020/07/27/51-k8s搭建radius/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"radius","slug":"radius","permalink":"https://blog.k1s.club/categories/radius/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"freeradius","slug":"freeradius","permalink":"https://blog.k1s.club/tags/freeradius/"},{"name":"daloradius","slug":"daloradius","permalink":"https://blog.k1s.club/tags/daloradius/"}]},{"title":"记一次windows安装OpenSSH问题","date":"2020-06-12T10:06:26.000Z","path":"2020/06/12/50-记一次windows安装OpenSSH问题/","text":"windows一次安装openssh server问题 首先是安装官方教程官方releases版本 这里直接下载最新 : OpenSSH-Win64.zip, Symbols应该是ddl SSH-2.0-OpenSSH_for_Windows_8.1 解压包放在目录: C:\\Program Files\\OpenSSH12345# 进入到解压目录cd C:\\Program Files\\OpenSSH# 执行安装命令powershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1 配置sshd_config123456789101112131415# 首先创建authorized_keys文件cd C:\\ProgramData\\sshecho \"&lt;you ssh public key&gt;\" &gt; authorized_keys# 使用icacls命令修改权限(仅允许SYSTEM和Administrators组有权限写,其他用户只读)icacls authorized_keys /inheritance:ricacls authorized_keys /grant SYSTEM:(F)icacls authorized_keys /grant BUILTIN\\Administrators:(F)# sshd_config修改开启密钥访问：PubkeyAuthentication yes禁用密码访问：PasswordAuthentication no禁用空密码：PermitEmptyPasswords no关闭DNS查找: UseDNS no设置authorized_keys路径: AuthorizedKeysFile C:/ProgramData/ssh/authorized_keys 这里配置AuthorizedKeysFile 为全路径, 之前配置变量导致报错 启动12net start sshdnet stop sshd 卸载1powershell.exe -ExecutionPolicy Bypass -File uninstall-sshd.ps1 错误1 Read from socket failed: Connection reset by peer1AuthorizedKeysFile 的路径配置的变量, 之后改成绝对路径缺成功了","raw":"---\ntitle: 记一次windows安装OpenSSH问题\ncopyright: true\ndate: 2020-06-12 18:06:26\ntags:\n  - windows\n  - ssh\ncategories:\n  - [windows]\n\n---\n\nwindows一次安装openssh server问题\n\n<!--more-->\n\n\n### 首先是安装\n[官方教程](https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH)\n[官方releases版本](https://github.com/PowerShell/Win32-OpenSSH/releases)\n\n> 这里直接下载最新 : OpenSSH-Win64.zip, Symbols应该是ddl\n\n\nSSH-2.0-OpenSSH_for_Windows_8.1\n\n#### 解压包放在目录: C:\\Program Files\\OpenSSH\n```\n# 进入到解压目录\ncd C:\\Program Files\\OpenSSH\n\n# 执行安装命令\npowershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1\n\n```\n\n#### 配置sshd_config\n```\n# 首先创建authorized_keys文件\ncd C:\\ProgramData\\ssh\necho \"<you ssh public key>\" > authorized_keys\n\n# 使用icacls命令修改权限(仅允许SYSTEM和Administrators组有权限写,其他用户只读)\nicacls authorized_keys /inheritance:r\nicacls authorized_keys /grant SYSTEM:(F)\nicacls authorized_keys /grant BUILTIN\\Administrators:(F)\n\n# sshd_config修改\n开启密钥访问：PubkeyAuthentication yes\n禁用密码访问：PasswordAuthentication no\n禁用空密码：PermitEmptyPasswords no\n关闭DNS查找: UseDNS no\n设置authorized_keys路径: AuthorizedKeysFile C:/ProgramData/ssh/authorized_keys  \n```\n\n> 这里配置AuthorizedKeysFile 为全路径, 之前配置变量导致报错\n\n#### 启动\n```\nnet start sshd\nnet stop sshd\n\n```\n\n####  卸载\n```\npowershell.exe -ExecutionPolicy Bypass -File uninstall-sshd.ps1\n\n```\n\n\n### 错误1 Read from socket failed: Connection reset by peer\n```\nAuthorizedKeysFile 的路径配置的变量, 之后改成绝对路径缺成功了\n```\n","content":"<p>windows一次安装openssh server问题</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"首先是安装\"><a href=\"#首先是安装\" class=\"headerlink\" title=\"首先是安装\"></a>首先是安装</h3><p><a href=\"https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH\" target=\"_blank\" rel=\"noopener\">官方教程</a><br><a href=\"https://github.com/PowerShell/Win32-OpenSSH/releases\" target=\"_blank\" rel=\"noopener\">官方releases版本</a></p>\n<blockquote>\n<p>这里直接下载最新 : OpenSSH-Win64.zip, Symbols应该是ddl</p>\n</blockquote>\n<p>SSH-2.0-OpenSSH_for_Windows_8.1</p>\n<h4 id=\"解压包放在目录-C-Program-Files-OpenSSH\"><a href=\"#解压包放在目录-C-Program-Files-OpenSSH\" class=\"headerlink\" title=\"解压包放在目录: C:\\Program Files\\OpenSSH\"></a>解压包放在目录: C:\\Program Files\\OpenSSH</h4><figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入到解压目录</span></span><br><span class=\"line\">cd C:\\Program Files\\OpenSSH</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行安装命令</span></span><br><span class=\"line\">powershell.exe -ExecutionPolicy Bypass -<span class=\"keyword\">File</span> <span class=\"keyword\">install</span>-sshd.ps1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置sshd-config\"><a href=\"#配置sshd-config\" class=\"headerlink\" title=\"配置sshd_config\"></a>配置sshd_config</h4><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 首先创建authorized_keys文件</span></span><br><span class=\"line\"><span class=\"keyword\">cd</span> C:\\ProgramData\\ssh</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;you ssh public key&gt;\"</span> &gt; authorized_keys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用icacls命令修改权限(仅允许SYSTEM和Administrators组有权限写,其他用户只读)</span></span><br><span class=\"line\">icacls authorized_keys <span class=\"string\">/inheritance</span><span class=\"function\">:r</span></span><br><span class=\"line\">icacls authorized_keys <span class=\"string\">/grant</span> SYSTEM:<span class=\"params\">(F)</span></span><br><span class=\"line\">icacls authorized_keys <span class=\"string\">/grant</span> BUILTIN\\Administrators:<span class=\"params\">(F)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sshd_config修改</span></span><br><span class=\"line\">开启密钥访问：PubkeyAuthentication yes</span><br><span class=\"line\">禁用密码访问：PasswordAuthentication no</span><br><span class=\"line\">禁用空密码：PermitEmptyPasswords no</span><br><span class=\"line\">关闭DNS查找: UseDNS no</span><br><span class=\"line\">设置authorized_keys路径: AuthorizedKeysFile C:<span class=\"string\">/ProgramData/ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里配置AuthorizedKeysFile 为全路径, 之前配置变量导致报错</p>\n</blockquote>\n<h4 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h4><figure class=\"highlight dos\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">net</span> <span class=\"built_in\">start</span> sshd</span><br><span class=\"line\"><span class=\"built_in\">net</span> stop sshd</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h4><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">powershell</span><span class=\"selector-class\">.exe</span> <span class=\"selector-tag\">-ExecutionPolicy</span> <span class=\"selector-tag\">Bypass</span> <span class=\"selector-tag\">-File</span> <span class=\"selector-tag\">uninstall-sshd</span><span class=\"selector-class\">.ps1</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"错误1-Read-from-socket-failed-Connection-reset-by-peer\"><a href=\"#错误1-Read-from-socket-failed-Connection-reset-by-peer\" class=\"headerlink\" title=\"错误1 Read from socket failed: Connection reset by peer\"></a>错误1 Read from socket failed: Connection reset by peer</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">AuthorizedKeysFile</span> 的路径配置的变量, 之后改成绝对路径缺成功了</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/06/12/50-记一次windows安装OpenSSH问题/","categories":[{"name":"windows","slug":"windows","permalink":"https://blog.k1s.club/categories/windows/"}],"tags":[{"name":"windows","slug":"windows","permalink":"https://blog.k1s.club/tags/windows/"},{"name":"ssh","slug":"ssh","permalink":"https://blog.k1s.club/tags/ssh/"}]},{"title":"go简单记录","date":"2020-05-27T09:25:31.000Z","path":"2020/05/27/49-go简单记录/","text":"go的一些简单记录 1. go中’…’的用法 第一个用法: 用于函数有多个不定参数的情况,可以接受多个不确定个数参数, 将多个参数作为slice传递了 第二个用法: 用于slice打散进行传递 例一1234567891011121314151617func sum(nums ...int) &#123; fmt.Println(nums) totols :=0 for i, num := range nums&#123; totols +=num &#125; fmt.Println(totols)&#125;func main() &#123; slice1 := []int&#123;1,3,4&#125; //切片被打散传入 sum(slice1...) slice2 := make([]int,3) //元素被打散一个个append slice2 = append(slice2,slice1...)&#125; 2. golang中引用类型 slice(切片)、map(字典)、channel(管道) int类型的零值是0,string类型的零值是””，引用类型的零值是nil 值类型 这里a数组是值类型, 赋值给b,修改b不会导致a改变 12345a := [3]int&#123;1,2,3&#125;b := afmt.Println(a,b)b[2] = 4fmt.Println(a,b) 引用类型 这里a是个slice引用类型,修改b会改变a, slice的复制是引用类型 1234567a := []int&#123;1,2,3&#125;b := afmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,b,b) //[1 2 3]: 0xc000090020,[1 2 3]: 0xc000090020b[2] = 4fmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,b,b) //[1 2 4]: 0xc000090020,[1 2 4]: 0xc000090020c := a[1:]fmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,c,c) //[1 2 4]: 0xc000090020,[2 4]: 0xc000090028 3. golang查看变量类型 第一种123arr := [3]int&#123;1,2,3&#125;sli := []int&#123;1,2,3&#125;fmt.Printf(\"%T,%T\\n\",arr,sli) //[3]int,[]int 显示的结果可以看到, 一个是数组, 一个是切片 第二种1234arr := [3]int&#123;1,2,3&#125;sli := []int&#123;1,2,3&#125;fmt.Println(\"type:\",reflect.TypeOf(arr) ) //type: [3]intfmt.Println(\"type:\",reflect.TypeOf(sli) ) //type: []int 4. go中内置分配内存函数new和make的用法原文: go语言值类型与引用类型理解 make 仅用于 slice, map, channel, 返回类型是本身 1func make(t Type, size ...IntegerType) Type new 返回类型是指针(引用类型) 12345// The new built-in function allocates memory. The first argument is a type,// not a value, and the value returned is a pointer to a newly// allocated zero value of that type.func new(Type) *Type//它只接受一个参数，这个参数是一个类型，分配好内存后，返回一个指向该类型内存地址的指针。同时请注意它同时把分配的内存置为零，也就是类型的零值。 5. 查看slice的长度和容量12345// 初始化一个3个0的slice,分配内容的容量是10个ints3 := make([]int,3,10)fmt.Println(s3)fmt.Println(len(s3))fmt.Println(cap(s3)) 6. 闭包的说明原文: 闭包与匿名函数 闭包与外部函数的生命周期 内函数对外函数的修改 是对变量的引用, 所以内函数结束后变量不会释放, 变量的内存地址不变 1234567891011121314151617181920212223242526func A(n int) func() &#123; n++ return func() &#123; fmt.Println(n) &#125;&#125;func B(n int) func() &#123; return func() &#123; n++ fmt.Println(n) &#125;&#125;func main() &#123; A1:=A(20) fmt.Println(A1) //0x48e3d0 在这儿已经定义了n=20 ，然后执行++ 操作，所以是21 。 A1() //21 后面对闭包的调用，没有对n执行加一操作，所以一直是21 A1() //21 B1:=B(10) fmt.Println(B1) //0x48e340 这儿定义了n 为10 B1() //11 后面对闭包的调用，每次都对n进行加1操作。 B1() //12&#125; 7. 反引号 反引号会原样输出, 不能使用转义, \\n也会原样输出 \\r 类似python里面的 \\r ，每次都覆盖上一次输出的内容 123456789func spinner(delay time.Duration) &#123; for &#123; //for _, r := range `-\\|/` &#123; for _, r := range \"-\\\\|/\" &#123; fmt.Printf(\"\\r%c\",r) time.Sleep(delay) &#125; &#125;&#125; 8. 编译不同平台可执行文件1、Mac下编译Linux, Windows平台的64位可执行程序：12CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build test.goCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go 2、Linux下编译Mac, Windows平台的64位可执行程序：12CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build test.goCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go 3、Windows下编译Mac, Linux平台的64位可执行程序：12SET CGO_ENABLED=0SET GOOS=darwin3 SET GOARCH=amd64 go build test.goSET CGO_ENABLED=0 SET GOOS=linux SET GOARCH=amd64 go build test.go 9. 斐波那契数列1 递归写法(n 越大 就贼慢)1234func Fib(n int ) int &#123; if n &lt;=1 &#123; return 1 &#125; return fib(n-1)+fib(n-2)&#125; 2 循环的写法12345678910func Fib2(n int ) int &#123; f := [3]int&#123;0,1,0&#125; for i := 2 ; i &lt; n ; i++ &#123; f[2] = f[0] + f[1] f[0] = f[1] f[1] = f[2] &#125; return f[2]&#125; 3 匿名函数写法12345678910func Fib3() func() int &#123; var n,m int return func() int &#123; if n &lt;= 1 &#123; n = 1 &#125; n,m = n+m,n return m &#125;&#125; 10. String()方法 go中如果类型A实现了String()方法(string() 不行),那么在输出A的时候,会自动调用String() 方法 1234567891011type A struct &#123; string&#125;func (a A) String() string &#123; return fmt.Sprintf(\"this is String() : %v\\n\",a.string)&#125;func main() &#123; a := A&#123;\"test\"&#125; fmt.Println(a) //this is String() : test&#125; 11. Printf用法12345//第一, 通常Printf格式化字符串包含多个%参数时将会包含对应相同数量的额外操作数，但是%之后的[1]副词告诉Printf函数再次使用第一个操作数。//第二, %后的#副词告诉Printf在用%o、%x或%X输出时生成0、0x或0X前缀。o := 0666x := int64(0xdeadbeef)fmt.Printf(\"%d %[1]o %#[1]o , %d %[2]x %#[2]x %#[2]X\\n\", o,x) // \"438 666 0666 , 3735928559 deadbeef 0xdeadbeef 0XDEADBEEF\" 12. fmt.Printf12%p -&gt; 内存地址%q -&gt; 该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示 13. 类型断言转Go-类型断言 问题转Go-类型断言 最佳实践 类型断言：由于接口是一般类型，不知道具体类型，如果要转成具体类型，就需要使用类型断言。 struct 是相同的属性, interface 是相同的方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556package mainimport ( \"fmt\")type Usb interface &#123; Connect() Disconnect()&#125;type Phone struct&#123; Name string &#125;type Camera struct&#123; Name string &#125;func (p Phone) Connect() &#123; fmt.Printf(\"%s连接中...\\n\", p.Name) &#125;func (p Phone) Disconnect() &#123; fmt.Printf(\"%s断开连接中...\\n\", p.Name) &#125;func (c Camera) Connect() &#123; fmt.Printf(\"%s连接中...\\n\", c.Name) &#125;func (c Camera) Disconnect() &#123; fmt.Printf(\"%s断开连接中...\\n\", c.Name) &#125;// Phone结构体特有的方法Callfunc (p Phone) Call() &#123; fmt.Printf(\"正在使用%s打电话...\\n\", p.Name) &#125;// Camerafunc (c Camera) Photograph() &#123; fmt.Printf(\"正在使用%s拍照...\\n\",c.Name)&#125;type Computer struct&#123;&#125;func (c Computer) Working(usb Usb) &#123; usb.Connect() usb.Disconnect() // 如果 usb 是指向 Phone 结构体变量，则还需要调用 Call 方法 //phone, ok := usb.(Phone) // 类型断言 //if ok &#123; // phone.Call() //&#125; switch v := usb.(type)&#123; case Phone: v.Call() case Camera: v.Photograph() default: fmt.Println(\"不支持的设备\") &#125;&#125;func main() &#123; // 定义一个 Usb 接口数组，可以存放 Phone 和 Camera 结构体的实例 var usbArr [2]Usb usbArr[0] = Phone&#123;\"苹果\"&#125; usbArr[1] = Camera&#123;\"尼康\"&#125; var computer Computer for _, v := range usbArr &#123; computer.Working(v) &#125; fmt.Println() fmt.Println(usbArr)&#125; 14 select 和switchselect 操作语句只能是【IO 操作】,一般用于channel 12345678910111213141516171819func main() &#123; timeout := make(chan struct&#123;&#125;) go func() &#123; time.Sleep(5 * time.Second) timeout &lt;- struct&#123;&#125;&#123;&#125; &#125;() ch := time.Tick(1 * time.Second) for &#123; select &#123; case &lt;-ch: fmt.Println(&lt;-ch) case &lt;-timeout: fmt.Println(\"timeout!\") return &#125; &#125;&#125; 15 channel简单例子12345678910111213141516171819202122232425262728293031323334func main() &#123; // 设置一个超时时间 timeout := make(chan struct&#123;&#125;) go func() &#123; time.Sleep(5 * time.Second) timeout &lt;- struct&#123;&#125;&#123;&#125; &#125;() // 设置一个脚本, 如果运行超过timeout时间,则中断(这里模拟程序执行时间) ch := make( chan struct &#123;&#125; ) go func() &#123; fmt.Println(\"ch 的子进程开始...\") rand.Seed(time.Now().Unix()) r := rand.Intn(10) fmt.Printf(\"模拟延迟 %ds\\n\",r) time.Sleep(time.Duration(r) * time.Second) fmt.Println(\"ch 的子进程结束...\") ch &lt;- struct&#123;&#125;&#123;&#125; &#125;() for &#123; select &#123; case &lt;-ch: fmt.Println(\"任务正常结束\") close(ch) return case &lt;-timeout: fmt.Println(\"timeout!\") close(timeout) return &#125; &#125;&#125; 16 sync.WaitGroup 使用12345678910111213141516171819202122232425func main() &#123; wg := sync.WaitGroup&#123;&#125; wg.Add(2) go fun1(&amp;wg) go fun2(&amp;wg) fmt.Println(\"main 等待子程序执行完毕, 等待中...\") wg.Wait() fmt.Println(\"子程序全部执行完毕\")&#125;//func fun1(wg *sync.WaitGroup) &#123; for i := 0 ; i &lt; 5 ; i ++ &#123; log.Printf(\"func1 : %d\\n\",i) time.Sleep(time.Duration(i) * time.Second) &#125; wg.Done()&#125;func fun2(wg *sync.WaitGroup) &#123; defer wg.Done() for i := 0 ; i &lt; 2 ; i ++ &#123; log.Printf(\"func2 : %d\\n\",i) time.Sleep(time.Duration(i) * time.Second) &#125;&#125;","raw":"---\ntitle: go简单记录\ncopyright: true\ndate: 2020-05-27 17:25:31\ntags:\n  - go\ncategories:\n  - [go]\n\n---\n\ngo的一些简单记录\n<!--more-->\n\n\n### 1. go中'...'的用法\n- 第一个用法: 用于函数有多个不定参数的情况,可以接受多个不确定个数参数, 将多个参数作为slice传递了\n- 第二个用法: 用于slice打散进行传递\n\n#### 例一\n``` go\nfunc sum(nums ...int) {\n fmt.Println(nums)\n totols :=0\n for i, num := range nums{\n  totols +=num\n }\n fmt.Println(totols)\n}\n\nfunc main() {\n slice1 := []int{1,3,4}\n //切片被打散传入\n sum(slice1...)\n slice2 := make([]int,3)\n //元素被打散一个个append\n slice2 = append(slice2,slice1...)\n}\n```\n\n\n---\n\n### 2. golang中引用类型 slice(切片)、map(字典)、channel(管道)\n\n> int类型的零值是0,string类型的零值是\"\"，引用类型的零值是nil\n\n- 值类型\n\n> 这里a数组是值类型, 赋值给b,修改b不会导致a改变\n\n``` go\na := [3]int{1,2,3}\nb := a\nfmt.Println(a,b)\nb[2] = 4\nfmt.Println(a,b)\n```\n\n- 引用类型\n\n> 这里a是个slice引用类型,修改b会改变a, slice的复制是引用类型\n\n``` go\n a := []int{1,2,3}\n b := a\n fmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,b,b)\t//[1 2 3]:        0xc000090020,[1 2 3]:   0xc000090020\n b[2] = 4\n fmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,b,b)\t//[1 2 4]:        0xc000090020,[1 2 4]:   0xc000090020\n c := a[1:]\n fmt.Printf(\"%v:\\t%p,%v:\\t%p\\n\",a,a,c,c)\t//[1 2 4]:        0xc000090020,[2 4]:     0xc000090028\n\n```\n\n---\n\n### 3. golang查看变量类型\n- 第一种\n``` go\narr := [3]int{1,2,3}\nsli := []int{1,2,3}\nfmt.Printf(\"%T,%T\\n\",arr,sli)  //[3]int,[]int\n```\n> 显示的结果可以看到, 一个是数组, 一个是切片\n\n- 第二种\n```go\n arr := [3]int{1,2,3}\n sli := []int{1,2,3}\n fmt.Println(\"type:\",reflect.TypeOf(arr) )  //type: [3]int\n fmt.Println(\"type:\",reflect.TypeOf(sli) )  //type: []int\n```\n\n\n\n### 4. go中内置分配内存函数new和make的用法\n原文: [go语言值类型与引用类型理解](https://www.cnblogs.com/xhhgo/p/10916254.html)\n\n- make 仅用于 slice, map, channel, 返回类型是本身\n\n```go\nfunc make(t Type, size ...IntegerType) Type\n```\n\n- new 返回类型是指针(引用类型)\n\n```go\n// The new built-in function allocates memory. The first argument is a type,\n// not a value, and the value returned is a pointer to a newly\n// allocated zero value of that type.\nfunc new(Type) *Type\n//它只接受一个参数，这个参数是一个类型，分配好内存后，返回一个指向该类型内存地址的指针。同时请注意它同时把分配的内存置为零，也就是类型的零值。\n```\n\n### 5. 查看slice的长度和容量\n\n```go\n // 初始化一个3个0的slice,分配内容的容量是10个int\n s3 := make([]int,3,10)\n fmt.Println(s3)\n fmt.Println(len(s3))\n fmt.Println(cap(s3))\n```\n\n### 6. 闭包的说明\n\n原文: [闭包与匿名函数](https://www.jianshu.com/p/faf7ef7fbcf8)\n\n#### 闭包与外部函数的生命周期\n\n> 内函数对外函数的修改 是对变量的引用, 所以内函数结束后变量不会释放, 变量的内存地址不变\n\n``` go\nfunc A(n int) func() {\n    n++\n    return func() {\n        fmt.Println(n)\n    }\n}\n\nfunc B(n int) func() {\n    return func() {\n        n++\n        fmt.Println(n)\n    }\n}\n\nfunc main() {\n    A1:=A(20)\n    fmt.Println(A1)  //0x48e3d0  在这儿已经定义了n=20 ，然后执行++ 操作，所以是21 。\n    A1()     //21 后面对闭包的调用，没有对n执行加一操作，所以一直是21\n    A1()     //21\n\n    B1:=B(10)\n    fmt.Println(B1)  //0x48e340   这儿定义了n 为10\n    B1()       //11  后面对闭包的调用，每次都对n进行加1操作。\n    B1()       //12\n\n}\n```\n\n### 7. 反引号\n- 反引号会原样输出, 不能使用转义, \\n也会原样输出\n- \\r 类似python里面的 \\r ，每次都覆盖上一次输出的内容\n\n```go\nfunc spinner(delay time.Duration) {\n for {\n  //for _, r := range `-\\|/` {\n  for _, r := range \"-\\\\|/\" {\n   fmt.Printf(\"\\r%c\",r)\n   time.Sleep(delay)\n  }\n }\n}\n```\n\n---\n\n### 8. 编译不同平台可执行文件\n\n#### 1、Mac下编译Linux, Windows平台的64位可执行程序：\n```go\nCGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build test.go\nCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go\n```\n#### 2、Linux下编译Mac, Windows平台的64位可执行程序：\n\n```go\nCGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build test.go\nCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go\n```\n\n#### 3、Windows下编译Mac, Linux平台的64位可执行程序：\n```go\nSET CGO_ENABLED=0SET GOOS=darwin3 SET GOARCH=amd64 go build test.go\nSET CGO_ENABLED=0 SET GOOS=linux SET GOARCH=amd64 go build  test.go\n```\n\n---\n\n### 9. 斐波那契数列\n#### 1 递归写法(n 越大 就贼慢)\n```go\nfunc Fib(n int ) int {\n\tif n <=1 { return 1 }\n\treturn fib(n-1)+fib(n-2)\n}\n\n```\n\n#### 2 循环的写法\n```go\nfunc Fib2(n int ) int {\n\tf := [3]int{0,1,0}\n\tfor i := 2 ; i < n ; i++ {\n\t\tf[2] = f[0] + f[1]\n\t\tf[0] = f[1]\n\t\tf[1] = f[2]\n\t}\n\treturn f[2]\n\n}\n```\n\n#### 3 匿名函数写法\n```go\nfunc Fib3() func() int {\n var n,m int\n return func() int {\n  if n <= 1 {\n   n = 1\n  }\n  n,m = n+m,n\n  return m\n }\n}\n```\n\n\n### 10. String()方法\n\n> go中如果类型A实现了String()方法(string() 不行),那么在输出A的时候,会自动调用String() 方法\n```go\ntype A struct {\n  string\n}\nfunc (a A) String() string {\n  return fmt.Sprintf(\"this is String() : %v\\n\",a.string)\n}\nfunc main() {\n  a := A{\"test\"}\n  fmt.Println(a)  //this is String() : test\n\n}\n\n```\n\n### 11. Printf用法\n``` go\n//第一, 通常Printf格式化字符串包含多个%参数时将会包含对应相同数量的额外操作数，但是%之后的[1]副词告诉Printf函数再次使用第一个操作数。\n//第二, %后的#副词告诉Printf在用%o、%x或%X输出时生成0、0x或0X前缀。\no := 0666\nx := int64(0xdeadbeef)\nfmt.Printf(\"%d %[1]o %#[1]o , %d %[2]x %#[2]x %#[2]X\\n\", o,x) // \"438 666 0666 , 3735928559 deadbeef 0xdeadbeef 0XDEADBEEF\"\n\n```\n\n### 12. fmt.Printf\n```go\n%p\t-> 内存地址\n%q\t-> 该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示\n```\n\n### 13. 类型断言\n转[Go-类型断言 问题](https://blog.csdn.net/cbmljs/article/details/82966907)\n转[Go-类型断言 最佳实践](https://www.cnblogs.com/believepd/p/10945700.html)\n\n> 类型断言：由于接口是一般类型，不知道具体类型，如果要转成具体类型，就需要使用类型断言。\n\n> struct 是相同的属性, interface 是相同的方法\n```go\npackage main\n\nimport (\n \"fmt\"\n)\n\ntype Usb interface {\n Connect()\n Disconnect()\n}\n\ntype Phone struct{ Name string }\ntype Camera struct{ Name string }\n\nfunc (p Phone) Connect()     { fmt.Printf(\"%s连接中...\\n\", p.Name) }\nfunc (p Phone) Disconnect()  { fmt.Printf(\"%s断开连接中...\\n\", p.Name) }\nfunc (c Camera) Connect()    { fmt.Printf(\"%s连接中...\\n\", c.Name) }\nfunc (c Camera) Disconnect() { fmt.Printf(\"%s断开连接中...\\n\", c.Name) }\n\n// Phone结构体特有的方法Call\nfunc (p Phone) Call() { fmt.Printf(\"正在使用%s打电话...\\n\", p.Name) }\n// Camera\nfunc (c Camera) Photograph() { fmt.Printf(\"正在使用%s拍照...\\n\",c.Name)}\ntype Computer struct{}\n\nfunc (c Computer) Working(usb Usb) {\n usb.Connect()\n usb.Disconnect()\n // 如果 usb 是指向 Phone 结构体变量，则还需要调用 Call 方法\n //phone, ok := usb.(Phone) // 类型断言\n //if ok {\n // phone.Call()\n //}\n switch v := usb.(type){\n case Phone:\n  v.Call()\n case Camera:\n  v.Photograph()\n default:\n  fmt.Println(\"不支持的设备\")\n\n }\n}\n\nfunc main() {\n // 定义一个 Usb 接口数组，可以存放 Phone 和 Camera 结构体的实例\n var usbArr [2]Usb\n usbArr[0] = Phone{\"苹果\"}\n usbArr[1] = Camera{\"尼康\"}\n var computer Computer\n for _, v := range usbArr {\n  computer.Working(v)\n }\n fmt.Println()\n fmt.Println(usbArr)\n}\n\n```\n\n### 14 select 和switch\nselect 操作语句只能是【IO 操作】,一般用于channel\n\n```go\nfunc main() {\n timeout := make(chan struct{})\n\n go func() {\n  time.Sleep(5 * time.Second)\n  timeout <- struct{}{}\n }()\n\n ch := time.Tick(1 * time.Second)\n for {\n  select {\n  case <-ch:\n   fmt.Println(<-ch)\n  case <-timeout:\n   fmt.Println(\"timeout!\")\n   return\n  }\n }\n}\n```\n\n### 15 channel简单例子\n```go\n\nfunc main() {\n // 设置一个超时时间\n timeout := make(chan struct{})\n go func() {\n  time.Sleep(5 * time.Second)\n  timeout <- struct{}{}\n }()\n\n // 设置一个脚本, 如果运行超过timeout时间,则中断(这里模拟程序执行时间)\n ch := make( chan struct {} )\n go func() {\n  fmt.Println(\"ch 的子进程开始...\")\n  rand.Seed(time.Now().Unix())\n  r := rand.Intn(10)\n  fmt.Printf(\"模拟延迟 %ds\\n\",r)\n  time.Sleep(time.Duration(r) * time.Second)\n  fmt.Println(\"ch 的子进程结束...\")\n  ch <- struct{}{}\n }()\n\n for {\n  select {\n  case <-ch:\n   fmt.Println(\"任务正常结束\")\n   close(ch)\n   return\n  case <-timeout:\n   fmt.Println(\"timeout!\")\n   close(timeout)\n   return\n  }\n }\n}\n\n```\n\n### 16 sync.WaitGroup 使用\n```go\n\nfunc main() {\n wg := sync.WaitGroup{}\n wg.Add(2)\n go fun1(&wg)\n go fun2(&wg)\n fmt.Println(\"main 等待子程序执行完毕, 等待中...\")\n wg.Wait()\n fmt.Println(\"子程序全部执行完毕\")\n}\n//\nfunc fun1(wg *sync.WaitGroup) {\n for i := 0 ; i < 5 ; i ++ {\n  log.Printf(\"func1 : %d\\n\",i)\n  time.Sleep(time.Duration(i) * time.Second)\n }\n wg.Done()\n}\nfunc fun2(wg *sync.WaitGroup) {\n defer wg.Done()\n for i := 0 ; i < 2 ; i ++ {\n  log.Printf(\"func2 : %d\\n\",i)\n  time.Sleep(time.Duration(i) * time.Second)\n }\n}\n```\n","content":"<p>go的一些简单记录</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"1-go中’…’的用法\"><a href=\"#1-go中’…’的用法\" class=\"headerlink\" title=\"1. go中’…’的用法\"></a>1. go中’…’的用法</h3><ul>\n<li>第一个用法: 用于函数有多个不定参数的情况,可以接受多个不确定个数参数, 将多个参数作为slice传递了</li>\n<li>第二个用法: 用于slice打散进行传递</li>\n</ul>\n<h4 id=\"例一\"><a href=\"#例一\" class=\"headerlink\" title=\"例一\"></a>例一</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">sum</span><span class=\"params\">(nums ...<span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\"> fmt.Println(nums)</span><br><span class=\"line\"> totols :=<span class=\"number\">0</span></span><br><span class=\"line\"> <span class=\"keyword\">for</span> i, num := <span class=\"keyword\">range</span> nums&#123;</span><br><span class=\"line\">  totols +=num</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> fmt.Println(totols)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> slice1 := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>&#125;</span><br><span class=\"line\"> <span class=\"comment\">//切片被打散传入</span></span><br><span class=\"line\"> sum(slice1...)</span><br><span class=\"line\"> slice2 := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>,<span class=\"number\">3</span>)</span><br><span class=\"line\"> <span class=\"comment\">//元素被打散一个个append</span></span><br><span class=\"line\"> slice2 = <span class=\"built_in\">append</span>(slice2,slice1...)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"2-golang中引用类型-slice-切片-、map-字典-、channel-管道\"><a href=\"#2-golang中引用类型-slice-切片-、map-字典-、channel-管道\" class=\"headerlink\" title=\"2. golang中引用类型 slice(切片)、map(字典)、channel(管道)\"></a>2. golang中引用类型 slice(切片)、map(字典)、channel(管道)</h3><blockquote>\n<p>int类型的零值是0,string类型的零值是””，引用类型的零值是nil</p>\n</blockquote>\n<ul>\n<li>值类型</li>\n</ul>\n<blockquote>\n<p>这里a数组是值类型, 赋值给b,修改b不会导致a改变</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a := [<span class=\"number\">3</span>]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">b := a</span><br><span class=\"line\">fmt.Println(a,b)</span><br><span class=\"line\">b[<span class=\"number\">2</span>] = <span class=\"number\">4</span></span><br><span class=\"line\">fmt.Println(a,b)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>引用类型</li>\n</ul>\n<blockquote>\n<p>这里a是个slice引用类型,修改b会改变a, slice的复制是引用类型</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">b := a</span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"%v:\\t%p,%v:\\t%p\\n\"</span>,a,a,b,b)\t<span class=\"comment\">//[1 2 3]:        0xc000090020,[1 2 3]:   0xc000090020</span></span><br><span class=\"line\">b[<span class=\"number\">2</span>] = <span class=\"number\">4</span></span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"%v:\\t%p,%v:\\t%p\\n\"</span>,a,a,b,b)\t<span class=\"comment\">//[1 2 4]:        0xc000090020,[1 2 4]:   0xc000090020</span></span><br><span class=\"line\">c := a[<span class=\"number\">1</span>:]</span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"%v:\\t%p,%v:\\t%p\\n\"</span>,a,a,c,c)\t<span class=\"comment\">//[1 2 4]:        0xc000090020,[2 4]:     0xc000090028</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"3-golang查看变量类型\"><a href=\"#3-golang查看变量类型\" class=\"headerlink\" title=\"3. golang查看变量类型\"></a>3. golang查看变量类型</h3><ul>\n<li>第一种<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arr := [<span class=\"number\">3</span>]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">sli := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"%T,%T\\n\"</span>,arr,sli)  <span class=\"comment\">//[3]int,[]int</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<blockquote>\n<p>显示的结果可以看到, 一个是数组, 一个是切片</p>\n</blockquote>\n<ul>\n<li>第二种<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arr := [<span class=\"number\">3</span>]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">sli := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"type:\"</span>,reflect.TypeOf(arr) )  <span class=\"comment\">//type: [3]int</span></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"type:\"</span>,reflect.TypeOf(sli) )  <span class=\"comment\">//type: []int</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"4-go中内置分配内存函数new和make的用法\"><a href=\"#4-go中内置分配内存函数new和make的用法\" class=\"headerlink\" title=\"4. go中内置分配内存函数new和make的用法\"></a>4. go中内置分配内存函数new和make的用法</h3><p>原文: <a href=\"https://www.cnblogs.com/xhhgo/p/10916254.html\" target=\"_blank\" rel=\"noopener\">go语言值类型与引用类型理解</a></p>\n<ul>\n<li>make 仅用于 slice, map, channel, 返回类型是本身</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">make</span><span class=\"params\">(t Type, size ...IntegerType)</span> <span class=\"title\">Type</span></span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>new 返回类型是指针(引用类型)</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The new built-in function allocates memory. The first argument is a type,</span></span><br><span class=\"line\"><span class=\"comment\">// not a value, and the value returned is a pointer to a newly</span></span><br><span class=\"line\"><span class=\"comment\">// allocated zero value of that type.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">new</span><span class=\"params\">(Type)</span> *<span class=\"title\">Type</span></span></span><br><span class=\"line\"><span class=\"function\">//它只接受一个参数，这个参数是一个类型，分配好内存后，返回一个指向该类型内存地址的指针。同时请注意它同时把分配的内存置为零，也就是类型的零值。</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-查看slice的长度和容量\"><a href=\"#5-查看slice的长度和容量\" class=\"headerlink\" title=\"5. 查看slice的长度和容量\"></a>5. 查看slice的长度和容量</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 初始化一个3个0的slice,分配内容的容量是10个int</span></span><br><span class=\"line\">s3 := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>,<span class=\"number\">3</span>,<span class=\"number\">10</span>)</span><br><span class=\"line\">fmt.Println(s3)</span><br><span class=\"line\">fmt.Println(<span class=\"built_in\">len</span>(s3))</span><br><span class=\"line\">fmt.Println(<span class=\"built_in\">cap</span>(s3))</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-闭包的说明\"><a href=\"#6-闭包的说明\" class=\"headerlink\" title=\"6. 闭包的说明\"></a>6. 闭包的说明</h3><p>原文: <a href=\"https://www.jianshu.com/p/faf7ef7fbcf8\" target=\"_blank\" rel=\"noopener\">闭包与匿名函数</a></p>\n<h4 id=\"闭包与外部函数的生命周期\"><a href=\"#闭包与外部函数的生命周期\" class=\"headerlink\" title=\"闭包与外部函数的生命周期\"></a>闭包与外部函数的生命周期</h4><blockquote>\n<p>内函数对外函数的修改 是对变量的引用, 所以内函数结束后变量不会释放, 变量的内存地址不变</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">A</span><span class=\"params\">(n <span class=\"keyword\">int</span>)</span> <span class=\"title\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    n++</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">        fmt.Println(n)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">B</span><span class=\"params\">(n <span class=\"keyword\">int</span>)</span> <span class=\"title\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">        n++</span><br><span class=\"line\">        fmt.Println(n)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    A1:=A(<span class=\"number\">20</span>)</span><br><span class=\"line\">    fmt.Println(A1)  <span class=\"comment\">//0x48e3d0  在这儿已经定义了n=20 ，然后执行++ 操作，所以是21 。</span></span><br><span class=\"line\">    A1()     <span class=\"comment\">//21 后面对闭包的调用，没有对n执行加一操作，所以一直是21</span></span><br><span class=\"line\">    A1()     <span class=\"comment\">//21</span></span><br><span class=\"line\"></span><br><span class=\"line\">    B1:=B(<span class=\"number\">10</span>)</span><br><span class=\"line\">    fmt.Println(B1)  <span class=\"comment\">//0x48e340   这儿定义了n 为10</span></span><br><span class=\"line\">    B1()       <span class=\"comment\">//11  后面对闭包的调用，每次都对n进行加1操作。</span></span><br><span class=\"line\">    B1()       <span class=\"comment\">//12</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-反引号\"><a href=\"#7-反引号\" class=\"headerlink\" title=\"7. 反引号\"></a>7. 反引号</h3><ul>\n<li>反引号会原样输出, 不能使用转义, \\n也会原样输出</li>\n<li>\\r 类似python里面的 \\r ，每次都覆盖上一次输出的内容</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">spinner</span><span class=\"params\">(delay time.Duration)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//for _, r := range `-\\|/` &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> _, r := <span class=\"keyword\">range</span> <span class=\"string\">\"-\\\\|/\"</span> &#123;</span><br><span class=\"line\">   fmt.Printf(<span class=\"string\">\"\\r%c\"</span>,r)</span><br><span class=\"line\">   time.Sleep(delay)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"8-编译不同平台可执行文件\"><a href=\"#8-编译不同平台可执行文件\" class=\"headerlink\" title=\"8. 编译不同平台可执行文件\"></a>8. 编译不同平台可执行文件</h3><h4 id=\"1、Mac下编译Linux-Windows平台的64位可执行程序：\"><a href=\"#1、Mac下编译Linux-Windows平台的64位可执行程序：\" class=\"headerlink\" title=\"1、Mac下编译Linux, Windows平台的64位可执行程序：\"></a>1、Mac下编译Linux, Windows平台的64位可执行程序：</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CGO_ENABLED=<span class=\"number\">0</span> GOOS=linux GOARCH=amd64 <span class=\"keyword\">go</span> build test.<span class=\"keyword\">go</span></span><br><span class=\"line\">CGO_ENABLED=<span class=\"number\">0</span> GOOS=windows GOARCH=amd64 <span class=\"keyword\">go</span> build test.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2、Linux下编译Mac-Windows平台的64位可执行程序：\"><a href=\"#2、Linux下编译Mac-Windows平台的64位可执行程序：\" class=\"headerlink\" title=\"2、Linux下编译Mac, Windows平台的64位可执行程序：\"></a>2、Linux下编译Mac, Windows平台的64位可执行程序：</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CGO_ENABLED=<span class=\"number\">0</span> GOOS=darwin GOARCH=amd64 <span class=\"keyword\">go</span> build test.<span class=\"keyword\">go</span></span><br><span class=\"line\">CGO_ENABLED=<span class=\"number\">0</span> GOOS=windows GOARCH=amd64 <span class=\"keyword\">go</span> build test.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3、Windows下编译Mac-Linux平台的64位可执行程序：\"><a href=\"#3、Windows下编译Mac-Linux平台的64位可执行程序：\" class=\"headerlink\" title=\"3、Windows下编译Mac, Linux平台的64位可执行程序：\"></a>3、Windows下编译Mac, Linux平台的64位可执行程序：</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SET CGO_ENABLED=<span class=\"number\">0</span>SET GOOS=darwin3 SET GOARCH=amd64 <span class=\"keyword\">go</span> build test.<span class=\"keyword\">go</span></span><br><span class=\"line\">SET CGO_ENABLED=<span class=\"number\">0</span> SET GOOS=linux SET GOARCH=amd64 <span class=\"keyword\">go</span> build  test.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"9-斐波那契数列\"><a href=\"#9-斐波那契数列\" class=\"headerlink\" title=\"9. 斐波那契数列\"></a>9. 斐波那契数列</h3><h4 id=\"1-递归写法-n-越大-就贼慢\"><a href=\"#1-递归写法-n-越大-就贼慢\" class=\"headerlink\" title=\"1 递归写法(n 越大 就贼慢)\"></a>1 递归写法(n 越大 就贼慢)</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib</span><span class=\"params\">(n <span class=\"keyword\">int</span> )</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> n &lt;=<span class=\"number\">1</span> &#123; <span class=\"keyword\">return</span> <span class=\"number\">1</span> &#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> fib(n<span class=\"number\">-1</span>)+fib(n<span class=\"number\">-2</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-循环的写法\"><a href=\"#2-循环的写法\" class=\"headerlink\" title=\"2 循环的写法\"></a>2 循环的写法</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib2</span><span class=\"params\">(n <span class=\"keyword\">int</span> )</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tf := [<span class=\"number\">3</span>]<span class=\"keyword\">int</span>&#123;<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">2</span> ; i &lt; n ; i++ &#123;</span><br><span class=\"line\">\t\tf[<span class=\"number\">2</span>] = f[<span class=\"number\">0</span>] + f[<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\tf[<span class=\"number\">0</span>] = f[<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\tf[<span class=\"number\">1</span>] = f[<span class=\"number\">2</span>]</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> f[<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-匿名函数写法\"><a href=\"#3-匿名函数写法\" class=\"headerlink\" title=\"3 匿名函数写法\"></a>3 匿名函数写法</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Fib3</span><span class=\"params\">()</span> <span class=\"title\">func</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> n,m <span class=\"keyword\">int</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> n &lt;= <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">   n = <span class=\"number\">1</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  n,m = n+m,n</span><br><span class=\"line\">  <span class=\"keyword\">return</span> m</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"10-String-方法\"><a href=\"#10-String-方法\" class=\"headerlink\" title=\"10. String()方法\"></a>10. String()方法</h3><blockquote>\n<p>go中如果类型A实现了String()方法(string() 不行),那么在输出A的时候,会自动调用String() 方法</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> A <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(a A)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> fmt.Sprintf(<span class=\"string\">\"this is String() : %v\\n\"</span>,a.<span class=\"keyword\">string</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  a := A&#123;<span class=\"string\">\"test\"</span>&#125;</span><br><span class=\"line\">  fmt.Println(a)  <span class=\"comment\">//this is String() : test</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"11-Printf用法\"><a href=\"#11-Printf用法\" class=\"headerlink\" title=\"11. Printf用法\"></a>11. Printf用法</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//第一, 通常Printf格式化字符串包含多个%参数时将会包含对应相同数量的额外操作数，但是%之后的[1]副词告诉Printf函数再次使用第一个操作数。</span></span><br><span class=\"line\"><span class=\"comment\">//第二, %后的#副词告诉Printf在用%o、%x或%X输出时生成0、0x或0X前缀。</span></span><br><span class=\"line\">o := <span class=\"number\">0666</span></span><br><span class=\"line\">x := <span class=\"keyword\">int64</span>(<span class=\"number\">0xdeadbeef</span>)</span><br><span class=\"line\">fmt.Printf(<span class=\"string\">\"%d %[1]o %#[1]o , %d %[2]x %#[2]x %#[2]X\\n\"</span>, o,x) <span class=\"comment\">// \"438 666 0666 , 3735928559 deadbeef 0xdeadbeef 0XDEADBEEF\"</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"12-fmt-Printf\"><a href=\"#12-fmt-Printf\" class=\"headerlink\" title=\"12. fmt.Printf\"></a>12. fmt.Printf</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%p\t-&gt; 内存地址</span><br><span class=\"line\">%q\t-&gt; 该值对应的单引号括起来的<span class=\"keyword\">go</span>语法字符字面值，必要时会采用安全的转义表示</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"13-类型断言\"><a href=\"#13-类型断言\" class=\"headerlink\" title=\"13. 类型断言\"></a>13. 类型断言</h3><p>转<a href=\"https://blog.csdn.net/cbmljs/article/details/82966907\" target=\"_blank\" rel=\"noopener\">Go-类型断言 问题</a><br>转<a href=\"https://www.cnblogs.com/believepd/p/10945700.html\" target=\"_blank\" rel=\"noopener\">Go-类型断言 最佳实践</a></p>\n<blockquote>\n<p>类型断言：由于接口是一般类型，不知道具体类型，如果要转成具体类型，就需要使用类型断言。</p>\n</blockquote>\n<blockquote>\n<p>struct 是相同的属性, interface 是相同的方法</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\"> <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Usb <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\"> Connect()</span><br><span class=\"line\"> Disconnect()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Phone <span class=\"keyword\">struct</span>&#123; Name <span class=\"keyword\">string</span> &#125;</span><br><span class=\"line\"><span class=\"keyword\">type</span> Camera <span class=\"keyword\">struct</span>&#123; Name <span class=\"keyword\">string</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p Phone)</span> <span class=\"title\">Connect</span><span class=\"params\">()</span></span>     &#123; fmt.Printf(<span class=\"string\">\"%s连接中...\\n\"</span>, p.Name) &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p Phone)</span> <span class=\"title\">Disconnect</span><span class=\"params\">()</span></span>  &#123; fmt.Printf(<span class=\"string\">\"%s断开连接中...\\n\"</span>, p.Name) &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c Camera)</span> <span class=\"title\">Connect</span><span class=\"params\">()</span></span>    &#123; fmt.Printf(<span class=\"string\">\"%s连接中...\\n\"</span>, c.Name) &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c Camera)</span> <span class=\"title\">Disconnect</span><span class=\"params\">()</span></span> &#123; fmt.Printf(<span class=\"string\">\"%s断开连接中...\\n\"</span>, c.Name) &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Phone结构体特有的方法Call</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p Phone)</span> <span class=\"title\">Call</span><span class=\"params\">()</span></span> &#123; fmt.Printf(<span class=\"string\">\"正在使用%s打电话...\\n\"</span>, p.Name) &#125;</span><br><span class=\"line\"><span class=\"comment\">// Camera</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c Camera)</span> <span class=\"title\">Photograph</span><span class=\"params\">()</span></span> &#123; fmt.Printf(<span class=\"string\">\"正在使用%s拍照...\\n\"</span>,c.Name)&#125;</span><br><span class=\"line\"><span class=\"keyword\">type</span> Computer <span class=\"keyword\">struct</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c Computer)</span> <span class=\"title\">Working</span><span class=\"params\">(usb Usb)</span></span> &#123;</span><br><span class=\"line\"> usb.Connect()</span><br><span class=\"line\"> usb.Disconnect()</span><br><span class=\"line\"> <span class=\"comment\">// 如果 usb 是指向 Phone 结构体变量，则还需要调用 Call 方法</span></span><br><span class=\"line\"> <span class=\"comment\">//phone, ok := usb.(Phone) // 类型断言</span></span><br><span class=\"line\"> <span class=\"comment\">//if ok &#123;</span></span><br><span class=\"line\"> <span class=\"comment\">// phone.Call()</span></span><br><span class=\"line\"> <span class=\"comment\">//&#125;</span></span><br><span class=\"line\"> <span class=\"keyword\">switch</span> v := usb.(<span class=\"keyword\">type</span>)&#123;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> Phone:</span><br><span class=\"line\">  v.Call()</span><br><span class=\"line\"> <span class=\"keyword\">case</span> Camera:</span><br><span class=\"line\">  v.Photograph()</span><br><span class=\"line\"> <span class=\"keyword\">default</span>:</span><br><span class=\"line\">  fmt.Println(<span class=\"string\">\"不支持的设备\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> <span class=\"comment\">// 定义一个 Usb 接口数组，可以存放 Phone 和 Camera 结构体的实例</span></span><br><span class=\"line\"> <span class=\"keyword\">var</span> usbArr [<span class=\"number\">2</span>]Usb</span><br><span class=\"line\"> usbArr[<span class=\"number\">0</span>] = Phone&#123;<span class=\"string\">\"苹果\"</span>&#125;</span><br><span class=\"line\"> usbArr[<span class=\"number\">1</span>] = Camera&#123;<span class=\"string\">\"尼康\"</span>&#125;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> computer Computer</span><br><span class=\"line\"> <span class=\"keyword\">for</span> _, v := <span class=\"keyword\">range</span> usbArr &#123;</span><br><span class=\"line\">  computer.Working(v)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> fmt.Println()</span><br><span class=\"line\"> fmt.Println(usbArr)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"14-select-和switch\"><a href=\"#14-select-和switch\" class=\"headerlink\" title=\"14 select 和switch\"></a>14 select 和switch</h3><p>select 操作语句只能是【IO 操作】,一般用于channel</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> timeout := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  time.Sleep(<span class=\"number\">5</span> * time.Second)</span><br><span class=\"line\">  timeout &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125;</span><br><span class=\"line\"> &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\"> ch := time.Tick(<span class=\"number\">1</span> * time.Second)</span><br><span class=\"line\"> <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> &lt;-ch:</span><br><span class=\"line\">   fmt.Println(&lt;-ch)</span><br><span class=\"line\">  <span class=\"keyword\">case</span> &lt;-timeout:</span><br><span class=\"line\">   fmt.Println(<span class=\"string\">\"timeout!\"</span>)</span><br><span class=\"line\">   <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"15-channel简单例子\"><a href=\"#15-channel简单例子\" class=\"headerlink\" title=\"15 channel简单例子\"></a>15 channel简单例子</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> <span class=\"comment\">// 设置一个超时时间</span></span><br><span class=\"line\"> timeout := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"> <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  time.Sleep(<span class=\"number\">5</span> * time.Second)</span><br><span class=\"line\">  timeout &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125;</span><br><span class=\"line\"> &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">// 设置一个脚本, 如果运行超过timeout时间,则中断(这里模拟程序执行时间)</span></span><br><span class=\"line\"> ch := <span class=\"built_in\">make</span>( <span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span> &#123;&#125; )</span><br><span class=\"line\"> <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  fmt.Println(<span class=\"string\">\"ch 的子进程开始...\"</span>)</span><br><span class=\"line\">  rand.Seed(time.Now().Unix())</span><br><span class=\"line\">  r := rand.Intn(<span class=\"number\">10</span>)</span><br><span class=\"line\">  fmt.Printf(<span class=\"string\">\"模拟延迟 %ds\\n\"</span>,r)</span><br><span class=\"line\">  time.Sleep(time.Duration(r) * time.Second)</span><br><span class=\"line\">  fmt.Println(<span class=\"string\">\"ch 的子进程结束...\"</span>)</span><br><span class=\"line\">  ch &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125;</span><br><span class=\"line\"> &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> &lt;-ch:</span><br><span class=\"line\">   fmt.Println(<span class=\"string\">\"任务正常结束\"</span>)</span><br><span class=\"line\">   <span class=\"built_in\">close</span>(ch)</span><br><span class=\"line\">   <span class=\"keyword\">return</span></span><br><span class=\"line\">  <span class=\"keyword\">case</span> &lt;-timeout:</span><br><span class=\"line\">   fmt.Println(<span class=\"string\">\"timeout!\"</span>)</span><br><span class=\"line\">   <span class=\"built_in\">close</span>(timeout)</span><br><span class=\"line\">   <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"16-sync-WaitGroup-使用\"><a href=\"#16-sync-WaitGroup-使用\" class=\"headerlink\" title=\"16 sync.WaitGroup 使用\"></a>16 sync.WaitGroup 使用</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"> wg := sync.WaitGroup&#123;&#125;</span><br><span class=\"line\"> wg.Add(<span class=\"number\">2</span>)</span><br><span class=\"line\"> <span class=\"keyword\">go</span> fun1(&amp;wg)</span><br><span class=\"line\"> <span class=\"keyword\">go</span> fun2(&amp;wg)</span><br><span class=\"line\"> fmt.Println(<span class=\"string\">\"main 等待子程序执行完毕, 等待中...\"</span>)</span><br><span class=\"line\"> wg.Wait()</span><br><span class=\"line\"> fmt.Println(<span class=\"string\">\"子程序全部执行完毕\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">fun1</span><span class=\"params\">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i := <span class=\"number\">0</span> ; i &lt; <span class=\"number\">5</span> ; i ++ &#123;</span><br><span class=\"line\">  log.Printf(<span class=\"string\">\"func1 : %d\\n\"</span>,i)</span><br><span class=\"line\">  time.Sleep(time.Duration(i) * time.Second)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> wg.Done()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">fun2</span><span class=\"params\">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\"> <span class=\"keyword\">for</span> i := <span class=\"number\">0</span> ; i &lt; <span class=\"number\">2</span> ; i ++ &#123;</span><br><span class=\"line\">  log.Printf(<span class=\"string\">\"func2 : %d\\n\"</span>,i)</span><br><span class=\"line\">  time.Sleep(time.Duration(i) * time.Second)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/05/27/49-go简单记录/","categories":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/categories/go/"}],"tags":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/tags/go/"}]},{"title":"k8s升级(1.10->1.15)","date":"2020-05-18T09:43:27.000Z","path":"2020/05/18/48-k8s升级-1-10-1-15/","text":"k8s升级一般不能跨版本升级, 所以这里间断介绍升级过程, 每次升级一个大版本 k8s升级kubernetes集群版本升级攻略kuboard网址k8s升级攻略官方kubeadm升级文档官方k8s版本changelog 版本关系Kubernetes 1.18.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03Kubernetes 1.17.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03Kubernetes 1.16.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09Kubernetes 1.15.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09Kubernetes 1.14.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09Kubernetes 1.13.0 –&gt;Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06Kubernetes 1.12.0 –&gt;Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06Kubernetes 1.11.* –&gt;Docker版本1.11.2 to 1.13.1 and 17.03.x (ref)Kubernetes 1.10.* –&gt;Docker版本1.11.2 to 1.13.1 and 17.03.x (ref) k8s1.10 -> k8s1.11 k8s1.10 -&gt; k8s1.11 注意我这里是单机,所以没有禁止调度,集群在升级前需要禁止调度: kubectl taint node master-01 node-role.kubernetes.io/master=””:NoExecutekubectl taint node –all node-role.kubernetes.io/master- 注意备份etcd 12345export ETCDCTL_API=3# 备份etcdctl snapshot save backup-$(date +%Y%m%d_%H).db# 恢复etcdctl snapshot restore backup-xxxx.db --data-dir=/data/etcd/data 更稳妥的方法应该是先 k8s1.10 -&gt; k8s1.10.13(小版本最后一个版本) -&gt; k8s1.11.0 kubeadm升级准备12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576# 保存配置export k8s_old_version=1.10.0export k8s_version=1.11.0export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.confkubeadm config view &gt; $&#123;kubeadm_config&#125;# k8s1.10版本要求cni必须是低于kubernetes-cni-0.6.0-0版本yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')echo $version# 这里执行不会升级kubeletyum install kubeadm-$&#123;version&#125; --disableexcludes=kubernetes -y# 查看是否可以更新kubeadm upgrade plan[preflight] Running pre-flight checks.[upgrade] Making sure the cluster is healthy:[upgrade/config] Making sure the configuration is correct:[upgrade/config] Reading configuration from the cluster...[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'I0520 09:32:03.264259 30047 feature_gate.go:230] feature gates: &amp;&#123;map[]&#125;[upgrade] Fetching available versions to upgrade to[upgrade/versions] Cluster version: v1.10.0[upgrade/versions] kubeadm version: v1.11.0[upgrade/versions] WARNING: Couldn't fetch latest stable version from the internet: unable to get URL \"https://dl.k8s.io/release/stable.txt\": Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: dial tcp 34.64.4.80:443: i/o timeout[upgrade/versions] WARNING: Falling back to current kubeadm version as latest stable version[upgrade/versions] Latest version in the v1.10 series: v1.10.13External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':COMPONENT CURRENT AVAILABLEEtcd 3.3.11 3.1.12Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT CURRENT AVAILABLEKubelet 1 x v1.10.1 v1.10.13Upgrade to the latest version in the v1.10 series:COMPONENT CURRENT AVAILABLEAPI Server v1.10.0 v1.10.13Controller Manager v1.10.0 v1.10.13Scheduler v1.10.0 v1.10.13Kube Proxy v1.10.0 v1.10.13CoreDNS 1.0.6 1.1.3You can now apply the upgrade by executing the following command: kubeadm upgrade apply v1.10.13_____________________________________________________________________External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':COMPONENT CURRENT AVAILABLEEtcd 3.3.11 3.2.18Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT CURRENT AVAILABLEKubelet 1 x v1.10.1 v1.11.0Upgrade to the latest stable version:COMPONENT CURRENT AVAILABLEAPI Server v1.10.0 v1.11.0Controller Manager v1.10.0 v1.11.0Scheduler v1.10.0 v1.11.0Kube Proxy v1.10.0 v1.11.0CoreDNS 1.0.6 1.1.3You can now apply the upgrade by executing the following command: kubeadm upgrade apply v1.11.0_____________________________________________________________________ 执行升级操作12345678910111213141516kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-run# 修改下kubeadmin-10-view.conf配置 imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sthvim $&#123;kubeadm_config&#125;imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sthdocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-controller-manager-amd64:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-scheduler-amd64:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-apiserver-amd64:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/coredns:1.1.3kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; 升级kubelet kubectl123456789101112yum install -y kubectl-$&#123;version&#125; kubelet-$&#123;version&#125; --disableexcludes=kubernetes# 修改下kubelet配置(否则集群会报错)vim /var/lib/kubelet/kubeadm-flags.env增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1systemctl daemon-reloadsystemctl stop kubeletsystemctl start kubeletkubectl versionkubelet --versionkubectl get nodes 这里执行完, 我的pod mysql和redis等服务器并没有被重启 k8s1.11 -> k8s1.12 k8s1.11 -&gt; k8s1.121234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465# 在这之前先停一下指标 metrics-server 和 prometheus-adapter (我这里会导致api-server无法启动成功,找不到metrics.k8s.io/v1beta1 等)kubectl delete -f /data/k8s-config/prometheus/prometheus-adapter kubectl delete -f /data/k8s-config/metrics-server/metrics-server-0.3.2/deploy/1.8+/# 保存配置export k8s_old_version=1.11.0export k8s_version=1.12.0export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.confkubeadm config view &gt; $&#123;kubeadm_config&#125;# 或者通过configmap (注意是 ClusterConfiguration)kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.MasterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')echo $versionyum install -y kubeadm-$&#123;version&#125; --disableexcludes=kuberneteskubeadm upgrade planCOMPONENT CURRENT AVAILABLEEtcd 3.3.11 3.2.24Upgrade to the latest version in the v1.11 series:COMPONENT CURRENT AVAILABLEAPI Server v1.11.0 v1.12.0Controller Manager v1.11.0 v1.12.0Scheduler v1.11.0 v1.12.0Kube Proxy v1.11.0 v1.12.0CoreDNS 1.1.3 1.2.2#修改image地址(之前是registry.cn-hangzhou.aliyuncs.com/k8sth)vim $&#123;kubeadm_config&#125;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containerskubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-rundocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.2docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.2.24kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;yum install -y kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kubernetessystemctl daemon-reloadsystemctl restart kubeletkubectl versionkubelet --versionkubectl get nodes k8s1.12 -> k8s1.13 k8s1.12 -&gt; k8s1.131234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253# 保存配置export k8s_old_version=1.12.0export k8s_version=1.13.0export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf# 通过configmapkubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')echo $versionyum install -y kubeadm-$&#123;version&#125; --disableexcludes=kuberneteskubeadm upgrade planExternal components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':COMPONENT CURRENT AVAILABLEEtcd 3.3.11 3.2.24Upgrade to the latest stable version:COMPONENT CURRENT AVAILABLEAPI Server v1.12.0 v1.13.0Controller Manager v1.12.0 v1.13.0Scheduler v1.12.0 v1.13.0Kube Proxy v1.12.0 v1.13.0CoreDNS 1.2.2 1.2.6kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-rundocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.6kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;yum install -y kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kubernetessystemctl daemon-reloadsystemctl restart kubeletkubectl versionkubelet --versionkubectl get nodes k8s1.13 -> k8s1.14 k8s1.13 -&gt; k8s1.1412345678910111213141516171819202122232425262728293031323334353637383940# 保存配置export k8s_old_version=1.13.0export k8s_version=1.14.0export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf# config view或者通过configmap(2选1)kubeadm config view &gt; $&#123;kubeadm_config&#125;kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')echo $version# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) # (这里1.14会依赖kubernetes-cni:0.7.5-0)yum install -y kubeadm-$&#123;version&#125; kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kuberneteskubeadm upgrade plankubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-rundocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;systemctl daemon-reloadsystemctl restart kubeletkubectl versionkubelet --versionkubectl get nodes k8s1.14 -> k8s1.15 k8s1.14 -&gt; k8s1.151234567891011121314151617181920212223242526272829303132333435# 保存配置export k8s_old_version=1.14.0export k8s_version=1.15.0export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf# config view或者通过configmap(2选1)kubeadm config view &gt; $&#123;kubeadm_config&#125;kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) yum install -y kubeadm-$&#123;version&#125; kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kuberneteskubeadm upgrade plankubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-rundocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;systemctl daemon-reloadsystemctl restart kubeletkubectl versionkubelet --versionkubectl get nodes k8s1.15.0 -> k8s1.15.11 k8s1.15.0 -&gt; k8s1.15.11 (选择11是因为google_containers/kube-proxy:v1.15.12 not found)123456789101112131415161718192021222324252627282930313233343536373839404142434445# 保存配置export k8s_old_version=1.15.0export k8s_version=1.15.11export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf# config view或者通过configmap(2选1)kubeadm config view &gt; $&#123;kubeadm_config&#125;kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;yum makecache allversion=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) yum install -y kubeadm-$&#123;version&#125; --disableexcludes=kuberneteskubeadm upgrade planCOMPONENT CURRENT AVAILABLEEtcd 3.3.11 3.3.10COMPONENT CURRENT AVAILABLEAPI Server v1.15.0 v1.15.11Controller Manager v1.15.0 v1.15.11Scheduler v1.15.0 v1.15.11Kube Proxy v1.15.0 v1.15.11CoreDNS 1.3.1 1.3.1kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125; --dry-rundocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;yum install -y kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kubernetessystemctl daemon-reloadsystemctl restart kubeletkubectl versionkubelet --versionkubectl get nodes 升级docker 升级docker (慎用)1234yum install docker-ce-18.09.9 docker-ce-cli-18.09.9# 重启docker, k8s集群会间断(如果是多台, 将重启的节点taint剔除集群重启即可)service docker restart 升级单机版rancher 升级单机版rancher 这里之前是2.1.9版本, 更新为stable(2.4.3) ,我这里rancher只是用导入方式,rancher宕机不影响k8s集群 首先将swarm启动的rancher停用:docker service rm rancher_rancher 其次将data目录备份cp -ra /data/rancher /data/rancher_2.1.9_2020-05-20_bak 修改docker-compose.yml重新启动docker stack deploy -c docker-compose.yml rancher 查看日志docker logs -f $(docker ps|grep rancher_rancher|awk &#39;{print $1}&#39;) 恢复(停止服务,将备份的目录还原重新启动即可) docker-compose.yml 123456789101112131415161718version: '3'services: rancher: hostname: rancher image: rancher/rancher:stable deploy: replicas: 1 restart_policy: condition: on-failure volumes: - /data/rancher/data/:/var/lib/rancher/ ports: - 10080:80 - 10443:443 networks: - rancher_netnetworks: rancher_net: 问题 问题1. 版本选择的image配置问题1开始选择升级到k8s1.11.10版本, 但是镜像版本只有registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1.11.0 , 没有找到v1.11.10 2. 1.12版本开始阿里云镜像地址变化12registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.12.0registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 3. 如果执行升级中断或停止, 可以1kubeadm upgrade --force。 4. 如果跨版本升级12- Specified version to upgrade to \"v1.16.2\" is too high; kubeadm can upgrade only 1 minor version at a time- Specified version to upgrade to \"v1.16.2\" is at least one minor release higher than the kubeadm minor release (16 &gt; 11). Such an upgrade is not supported 5. k8s1.11 开启使用了pause:3.1123k8s1.11开始kubelet的配置文件修改为:vim /var/lib/kubelet/kubeadm-flags.env增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 6. 在1.12-&gt;1.13升级完成后报错: OpenAPI spec for “v1beta1.metrics.k8s.io” failed with: OpenAPI spec does not exists1234567891011121314# 1.11 -&gt; 1.12 k8s_kube-apiserver日志E0520 06:21:09.369346 1 memcache.go:134] couldn't get resource list for crd.projectcalico.org/v1: the server could not find the requested resourceE0520 06:21:09.369725 1 memcache.go:134] couldn't get resource list for authentication.istio.io/v1alpha1: the server could not find the requested resourceE0520 06:21:09.370842 1 memcache.go:134] couldn't get resource list for certmanager.k8s.io/v1alpha1: the server could not find the requested resourceE0520 06:21:09.371925 1 memcache.go:134] couldn't get resource list for rbac.istio.io/v1alpha1: the server could not find the requested resourceE0520 06:21:09.373016 1 memcache.go:134] couldn't get resource list for config.istio.io/v1alpha2: the server could not find the requested resourceE0520 06:21:09.374083 1 memcache.go:134] couldn't get resource list for networking.istio.io/v1alpha3: the server could not find the requested resourceE0520 06:21:09.375179 1 memcache.go:134] couldn't get resource list for metrics.k8s.io/v1beta1: the server could not find the requested resource# 1.12-&gt;1.13 k8s_kube-apiserver日志OpenAPI spec for \"v1beta1.metrics.k8s.io\" failed with: OpenAPI spec does not exists原因是我这边metrics-server 和prometheus-adapter 部署的时候用到了metrics.k8s.io/v1beta1但是升级之后这个api-version丢失了, 所以导致apiserver一直报错, 无法启动成功 7. 单机k8s升级会造成服务中断1234567891011# 1.10 ~ 1.13升级会导致核心组件apiserver,scheduler,controller,coredns,网络calico等由于版本升级都需要重新启动了一次, 部分其他业务pod也会重启其中nodejs服务会pm2重启,mysql等也会重启 ,会导致服务器压力上升这里检测到有状态statefulset的服务并没有重启, 而无状态的deployment会重启, 由于单机1个pod的服务重启会导致中断所以避免业务中断必须是多主机集群, 在升级之前先taint机器升级# 1.13 -&gt; 1.14这期间有状态statefulset的服务也重启了# 1.14 ~ 1.15.11这期间有状态statefulset的服务没有重启 8. 注意1.13-&gt;1.14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本123# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) # (这里1.14会依赖kubernetes-cni:0.7.5-0)yum install -y kubeadm-$&#123;version&#125; kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kubernetes","raw":"---\ntitle: k8s升级(1.10->1.15)\ncopyright: true\ndate: 2020-05-18 17:43:27\ntags:\n  - k8s\ncategories:\n  - [k8s]\n\n---\n\nk8s升级一般不能跨版本升级, 所以这里间断介绍升级过程, 每次升级一个大版本\n<!--more-->\n\n\n### k8s升级\n\n\n[kubernetes集群版本升级攻略](https://blog.51cto.com/newfly/2440901?source=dra)\n[kuboard网址k8s升级攻略](https://kuboard.cn/install/upgrade-k8s/1.15.x-1.16.x.html)\n[官方kubeadm升级文档](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)\n[官方k8s版本changelog](https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG)\n\n\n### 版本关系\nKubernetes 1.18.0 -->Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03\nKubernetes 1.17.0 -->Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03\nKubernetes 1.16.0 -->Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09\nKubernetes 1.15.0 -->Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09\nKubernetes 1.14.0 -->Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09\nKubernetes 1.13.0 -->Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06\nKubernetes 1.12.0 -->Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06\nKubernetes 1.11.* -->Docker版本1.11.2 to 1.13.1 and 17.03.x (ref)\nKubernetes 1.10.* -->Docker版本1.11.2 to 1.13.1 and 17.03.x (ref)\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.10 -> k8s1.11 </font>\n</center>\n\n\n### k8s1.10 -> k8s1.11\n\n-  注意我这里是单机,所以没有禁止调度,集群在升级前需要禁止调度:\n\n> kubectl taint node master-01 node-role.kubernetes.io/master=\"\":NoExecute\n> kubectl taint node --all node-role.kubernetes.io/master-\n\n-  注意备份etcd\n\n```\nexport ETCDCTL_API=3\n# 备份\netcdctl snapshot save backup-$(date +%Y%m%d_%H).db\n# 恢复\netcdctl snapshot restore backup-xxxx.db --data-dir=/data/etcd/data\n\n```\n\n-  更稳妥的方法应该是先 k8s1.10 -> k8s1.10.13(小版本最后一个版本) -> k8s1.11.0\n\n\n\n#### kubeadm升级准备\n```\n# 保存配置\nexport k8s_old_version=1.10.0\nexport k8s_version=1.11.0\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\nkubeadm config view > ${kubeadm_config}\n\n# k8s1.10版本要求cni必须是低于kubernetes-cni-0.6.0-0版本\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\necho $version\n\n# 这里执行不会升级kubelet\nyum install  kubeadm-${version} --disableexcludes=kubernetes -y\n\n\n# 查看是否可以更新\nkubeadm upgrade plan\n[preflight] Running pre-flight checks.\n[upgrade] Making sure the cluster is healthy:\n[upgrade/config] Making sure the configuration is correct:\n[upgrade/config] Reading configuration from the cluster...\n[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\nI0520 09:32:03.264259   30047 feature_gate.go:230] feature gates: &{map[]}\n[upgrade] Fetching available versions to upgrade to\n[upgrade/versions] Cluster version: v1.10.0\n[upgrade/versions] kubeadm version: v1.11.0\n[upgrade/versions] WARNING: Couldn't fetch latest stable version from the internet: unable to get URL \"https://dl.k8s.io/release/stable.txt\": Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: dial tcp 34.64.4.80:443: i/o timeout\n[upgrade/versions] WARNING: Falling back to current kubeadm version as latest stable version\n[upgrade/versions] Latest version in the v1.10 series: v1.10.13\n\nExternal components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT   AVAILABLE\nEtcd        3.3.11    3.1.12\n\nComponents that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT       AVAILABLE\nKubelet     1 x v1.10.1   v1.10.13\n\nUpgrade to the latest version in the v1.10 series:\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v1.10.0   v1.10.13\nController Manager   v1.10.0   v1.10.13\nScheduler            v1.10.0   v1.10.13\nKube Proxy           v1.10.0   v1.10.13\nCoreDNS              1.0.6     1.1.3\n\nYou can now apply the upgrade by executing the following command:\n\n kubeadm upgrade apply v1.10.13\n\n_____________________________________________________________________\n\nExternal components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT   AVAILABLE\nEtcd        3.3.11    3.2.18\n\nComponents that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT       AVAILABLE\nKubelet     1 x v1.10.1   v1.11.0\n\nUpgrade to the latest stable version:\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v1.10.0   v1.11.0\nController Manager   v1.10.0   v1.11.0\nScheduler            v1.10.0   v1.11.0\nKube Proxy           v1.10.0   v1.11.0\nCoreDNS              1.0.6     1.1.3\n\nYou can now apply the upgrade by executing the following command:\n\n kubeadm upgrade apply v1.11.0\n\n_____________________________________________________________________\n\n\n```\n\n\n#### 执行升级操作\n```\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\n\n# 修改下kubeadmin-10-view.conf配置 imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth\nvim ${kubeadm_config}\nimageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth\n\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-controller-manager-amd64:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-scheduler-amd64:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-apiserver-amd64:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/k8sth/coredns:1.1.3\n\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\n```\n\n#### 升级kubelet kubectl\n\n```\nyum install -y kubectl-${version} kubelet-${version} --disableexcludes=kubernetes\n\n# 修改下kubelet配置(否则集群会报错)\nvim /var/lib/kubelet/kubeadm-flags.env\n增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\nsystemctl daemon-reload\nsystemctl stop kubelet\nsystemctl start kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n```\n\n> 这里执行完, 我的pod mysql和redis等服务器并没有被重启\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.11 -> k8s1.12 </font>\n</center>\n\n\n### k8s1.11 -> k8s1.12\n```\n# 在这之前先停一下指标 metrics-server 和 prometheus-adapter (我这里会导致api-server无法启动成功,找不到metrics.k8s.io/v1beta1 等)\nkubectl delete -f /data/k8s-config/prometheus/prometheus-adapter \nkubectl delete -f /data/k8s-config/metrics-server/metrics-server-0.3.2/deploy/1.8+/\n\n\n# 保存配置\nexport k8s_old_version=1.11.0\nexport k8s_version=1.12.0\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\nkubeadm config view > ${kubeadm_config}\n# 或者通过configmap (注意是 ClusterConfiguration)\nkubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.MasterConfiguration} > ${kubeadm_config}\n\n\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\necho $version\n\nyum install -y kubeadm-${version} --disableexcludes=kubernetes\n\n\nkubeadm upgrade plan\nCOMPONENT   CURRENT   AVAILABLE\nEtcd        3.3.11    3.2.24\n\nUpgrade to the latest version in the v1.11 series:\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v1.11.0   v1.12.0\nController Manager   v1.11.0   v1.12.0\nScheduler            v1.11.0   v1.12.0\nKube Proxy           v1.11.0   v1.12.0\nCoreDNS              1.1.3     1.2.2\n\n\n\n\n\n\n#修改image地址(之前是registry.cn-hangzhou.aliyuncs.com/k8sth)\nvim ${kubeadm_config}\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\n\n\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.2\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.2.24\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\n\nyum install -y kubelet-${version} kubectl-${version} --disableexcludes=kubernetes\n\nsystemctl daemon-reload\nsystemctl restart kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.12 -> k8s1.13 </font>\n</center>\n\n\n\n### k8s1.12 -> k8s1.13\n```\n\n\n# 保存配置\nexport k8s_old_version=1.12.0\nexport k8s_version=1.13.0\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\n# 通过configmap\nkubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}\n\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\necho $version\n\nyum install -y kubeadm-${version} --disableexcludes=kubernetes\n\nkubeadm upgrade plan\nExternal components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT   AVAILABLE\nEtcd        3.3.11    3.2.24\n\nUpgrade to the latest stable version:\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v1.12.0   v1.13.0\nController Manager   v1.12.0   v1.13.0\nScheduler            v1.12.0   v1.13.0\nKube Proxy           v1.12.0   v1.13.0\nCoreDNS              1.2.2     1.2.6\n\n\n\n\n\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.6\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\nyum install -y kubelet-${version} kubectl-${version} --disableexcludes=kubernetes\n\n\nsystemctl daemon-reload\nsystemctl restart kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.13 -> k8s1.14 </font>\n</center>\n\n### k8s1.13 -> k8s1.14\n```\n# 保存配置\nexport k8s_old_version=1.13.0\nexport k8s_version=1.14.0\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\n# config view或者通过configmap(2选1)\nkubeadm config view > ${kubeadm_config}\nkubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}\n\n\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\necho $version\n\n\n# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) \n# (这里1.14会依赖kubernetes-cni:0.7.5-0)\nyum install -y kubeadm-${version} kubelet-${version} kubectl-${version}  --disableexcludes=kubernetes\n\n\nkubeadm upgrade plan\n\n\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\n\nsystemctl daemon-reload\nsystemctl restart kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.14 -> k8s1.15 </font>\n</center>\n\n\n\n### k8s1.14 -> k8s1.15\n```\n# 保存配置\nexport k8s_old_version=1.14.0\nexport k8s_version=1.15.0\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\n# config view或者通过configmap(2选1)\nkubeadm config view > ${kubeadm_config}\nkubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}\n\n\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\n\n# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) \nyum install -y kubeadm-${version} kubelet-${version} kubectl-${version}  --disableexcludes=kubernetes\n\nkubeadm upgrade plan\n\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\n\nsystemctl daemon-reload\nsystemctl restart kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s1.15.0 -> k8s1.15.11 </font>\n</center>\n\n\n\n### k8s1.15.0 -> k8s1.15.11 (选择11是因为google_containers/kube-proxy:v1.15.12 not found)\n```\n# 保存配置\nexport k8s_old_version=1.15.0\nexport k8s_version=1.15.11\nexport kubeadm_config=kubeadmin-${k8s_old_version}-view.conf\n\n# config view或者通过configmap(2选1)\nkubeadm config view > ${kubeadm_config}\nkubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}\n\n\nyum makecache all\nversion=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')\n\n# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) \nyum install -y kubeadm-${version}  --disableexcludes=kubernetes\n\nkubeadm upgrade plan\nCOMPONENT   CURRENT   AVAILABLE\nEtcd        3.3.11    3.3.10\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v1.15.0   v1.15.11\nController Manager   v1.15.0   v1.15.11\nScheduler            v1.15.0   v1.15.11\nKube Proxy           v1.15.0   v1.15.11\nCoreDNS              1.3.1     1.3.1\n\nkubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\n\nkubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}\n\nyum install -y kubelet-${version} kubectl-${version}  --disableexcludes=kubernetes\n\nsystemctl daemon-reload\nsystemctl restart kubelet\nkubectl version\nkubelet --version\nkubectl get nodes\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 升级docker </font>\n</center>\n\n\n### 升级docker (慎用)\n```\nyum install docker-ce-18.09.9 docker-ce-cli-18.09.9\n\n# 重启docker, k8s集群会间断(如果是多台, 将重启的节点taint剔除集群重启即可)\nservice docker restart\n\n```\n\n---\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 升级单机版rancher </font>\n</center>\n\n### 升级单机版rancher\n>  这里之前是2.1.9版本, 更新为stable(2.4.3) ,我这里rancher只是用导入方式,rancher宕机不影响k8s集群\n\n1. 首先将swarm启动的rancher停用:\n `docker service rm rancher_rancher`\n2. 其次将data目录备份 \n `cp -ra /data/rancher /data/rancher_2.1.9_2020-05-20_bak`\n3. 修改docker-compose.yml重新启动\n `docker stack deploy -c docker-compose.yml rancher`\n4. 查看日志\n `docker logs -f $(docker ps|grep rancher_rancher|awk '{print $1}')`\n5. 恢复(停止服务,将备份的目录还原重新启动即可)\n\n- docker-compose.yml \n```\nversion: '3'\nservices:\n  rancher:\n    hostname: rancher\n    image: rancher/rancher:stable\n    deploy:\n      replicas: 1\n      restart_policy:\n        condition: on-failure\n    volumes:\n      - /data/rancher/data/:/var/lib/rancher/\n    ports:\n      - 10080:80\n      - 10443:443\n    networks:\n      - rancher_net\nnetworks:\n  rancher_net:\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 问题 </font>\n</center>\n\n---\n\n\n\n### 问题\n#### 1. 版本选择的image配置问题\n```\n开始选择升级到k8s1.11.10版本, 但是镜像版本只有registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1.11.0 , 没有找到v1.11.10\n```\n\n#### 2. 1.12版本开始阿里云镜像地址变化\n```\nregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.12.0\nregistry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\n```\n\n#### 3. 如果执行升级中断或停止, 可以\n```\nkubeadm upgrade --force。\n```\n\n#### 4. 如果跨版本升级\n```\n - Specified version to upgrade to \"v1.16.2\" is too high; kubeadm can upgrade only 1 minor version at a time\n - Specified version to upgrade to \"v1.16.2\" is at least one minor release higher than the kubeadm minor release (16 > 11). Such an upgrade is not supported\n```\n\n#### 5. k8s1.11 开启使用了pause:3.1\n```\nk8s1.11开始kubelet的配置文件修改为:\nvim /var/lib/kubelet/kubeadm-flags.env\n增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\n\n```\n\n#### 6. 在1.12->1.13升级完成后报错: OpenAPI spec for \"v1beta1.metrics.k8s.io\" failed with: OpenAPI spec does not exists\n```\n# 1.11 -> 1.12 k8s_kube-apiserver日志\nE0520 06:21:09.369346       1 memcache.go:134] couldn't get resource list for crd.projectcalico.org/v1: the server could not find the requested resource\nE0520 06:21:09.369725       1 memcache.go:134] couldn't get resource list for authentication.istio.io/v1alpha1: the server could not find the requested resource\nE0520 06:21:09.370842       1 memcache.go:134] couldn't get resource list for certmanager.k8s.io/v1alpha1: the server could not find the requested resource\nE0520 06:21:09.371925       1 memcache.go:134] couldn't get resource list for rbac.istio.io/v1alpha1: the server could not find the requested resource\nE0520 06:21:09.373016       1 memcache.go:134] couldn't get resource list for config.istio.io/v1alpha2: the server could not find the requested resource\nE0520 06:21:09.374083       1 memcache.go:134] couldn't get resource list for networking.istio.io/v1alpha3: the server could not find the requested resource\nE0520 06:21:09.375179       1 memcache.go:134] couldn't get resource list for metrics.k8s.io/v1beta1: the server could not find the requested resource\n\n# 1.12->1.13 k8s_kube-apiserver日志\nOpenAPI spec for \"v1beta1.metrics.k8s.io\" failed with: OpenAPI spec does not exists\n\n原因是我这边metrics-server 和prometheus-adapter 部署的时候用到了metrics.k8s.io/v1beta1\n但是升级之后这个api-version丢失了, 所以导致apiserver一直报错, 无法启动成功\n\n\n```\n\n#### 7. 单机k8s升级会造成服务中断\n```\n# 1.10 ~ 1.13\n升级会导致核心组件apiserver,scheduler,controller,coredns,网络calico等由于版本升级都需要重新启动了一次, 部分其他业务pod也会重启\n其中nodejs服务会pm2重启,mysql等也会重启 ,会导致服务器压力上升\n这里检测到有状态statefulset的服务并没有重启, 而无状态的deployment会重启, 由于单机1个pod的服务重启会导致中断\n所以避免业务中断必须是多主机集群, 在升级之前先taint机器升级\n\n# 1.13 -> 1.14\n这期间有状态statefulset的服务也重启了\n\n# 1.14 ~ 1.15.11\n这期间有状态statefulset的服务没有重启\n\n```\n\n#### 8. 注意1.13->1.14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本\n```\n# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) \n# (这里1.14会依赖kubernetes-cni:0.7.5-0)\nyum install -y kubeadm-${version} kubelet-${version} kubectl-${version}  --disableexcludes=kubernetes\n\n```\n","content":"<p>k8s升级一般不能跨版本升级, 所以这里间断介绍升级过程, 每次升级一个大版本</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"k8s升级\"><a href=\"#k8s升级\" class=\"headerlink\" title=\"k8s升级\"></a>k8s升级</h3><p><a href=\"https://blog.51cto.com/newfly/2440901?source=dra\" target=\"_blank\" rel=\"noopener\">kubernetes集群版本升级攻略</a><br><a href=\"https://kuboard.cn/install/upgrade-k8s/1.15.x-1.16.x.html\" target=\"_blank\" rel=\"noopener\">kuboard网址k8s升级攻略</a><br><a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/\" target=\"_blank\" rel=\"noopener\">官方kubeadm升级文档</a><br><a href=\"https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG\" target=\"_blank\" rel=\"noopener\">官方k8s版本changelog</a></p>\n<h3 id=\"版本关系\"><a href=\"#版本关系\" class=\"headerlink\" title=\"版本关系\"></a>版本关系</h3><p>Kubernetes 1.18.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03<br>Kubernetes 1.17.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03<br>Kubernetes 1.16.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09<br>Kubernetes 1.15.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09<br>Kubernetes 1.14.0 –&gt;Docker版本1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09<br>Kubernetes 1.13.0 –&gt;Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06<br>Kubernetes 1.12.0 –&gt;Docker版本1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06<br>Kubernetes 1.11.* –&gt;Docker版本1.11.2 to 1.13.1 and 17.03.x (ref)<br>Kubernetes 1.10.* –&gt;Docker版本1.11.2 to 1.13.1 and 17.03.x (ref)</p>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.10 -> k8s1.11 </font>\n</center>\n\n\n<h3 id=\"k8s1-10-gt-k8s1-11\"><a href=\"#k8s1-10-gt-k8s1-11\" class=\"headerlink\" title=\"k8s1.10 -&gt; k8s1.11\"></a>k8s1.10 -&gt; k8s1.11</h3><ul>\n<li>注意我这里是单机,所以没有禁止调度,集群在升级前需要禁止调度:</li>\n</ul>\n<blockquote>\n<p>kubectl taint node master-01 node-role.kubernetes.io/master=””:NoExecute<br>kubectl taint node –all node-role.kubernetes.io/master-</p>\n</blockquote>\n<ul>\n<li>注意备份etcd</li>\n</ul>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export ETCDCTL_API=<span class=\"number\">3</span></span><br><span class=\"line\"># 备份</span><br><span class=\"line\">etcdctl <span class=\"keyword\">snapshot</span> save backup-$(<span class=\"keyword\">date</span> +%Y%m%d_%H).db</span><br><span class=\"line\"># 恢复</span><br><span class=\"line\">etcdctl <span class=\"keyword\">snapshot</span> restore backup-xxxx.db --data-dir=/data/etcd/data</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>更稳妥的方法应该是先 k8s1.10 -&gt; k8s1.10.13(小版本最后一个版本) -&gt; k8s1.11.0</li>\n</ul>\n<h4 id=\"kubeadm升级准备\"><a href=\"#kubeadm升级准备\" class=\"headerlink\" title=\"kubeadm升级准备\"></a>kubeadm升级准备</h4><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 保存配置</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> k8s_old_version=<span class=\"number\">1.10</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> k8s_version=<span class=\"number\">1.11</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm config view &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># k8s1.10版本要求cni必须是低于kubernetes-cni-0.6.0-0版本</span></span><br><span class=\"line\">yum makecache all</span><br><span class=\"line\">version=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk <span class=\"string\">'&#123;print $2&#125;'</span>)</span><br><span class=\"line\">echo $version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这里执行不会升级kubelet</span></span><br><span class=\"line\">yum install  kubeadm-$&#123;version&#125; --disableexcludes=kubernetes -y</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看是否可以更新</span></span><br><span class=\"line\">kubeadm upgrade plan</span><br><span class=\"line\">[preflight] Running pre-flight checks.</span><br><span class=\"line\">[upgrade] Making sure the cluster <span class=\"keyword\">is</span> healthy:</span><br><span class=\"line\">[upgrade/config] Making sure the configuration <span class=\"keyword\">is</span> correct:</span><br><span class=\"line\">[upgrade/config] Reading configuration <span class=\"keyword\">from</span> the cluster...</span><br><span class=\"line\">[upgrade/config] FYI: You can look at <span class=\"keyword\">this</span> config file <span class=\"keyword\">with</span> <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\">I0520 <span class=\"number\">09</span>:<span class=\"number\">32</span>:<span class=\"number\">03.264259</span>   <span class=\"number\">30047</span> feature_gate.go:<span class=\"number\">230</span>] feature gates: &amp;&#123;map[]&#125;</span><br><span class=\"line\">[upgrade] Fetching available versions <span class=\"keyword\">to</span> upgrade <span class=\"keyword\">to</span></span><br><span class=\"line\">[upgrade/versions] Cluster version: v1.<span class=\"number\">10.0</span></span><br><span class=\"line\">[upgrade/versions] kubeadm version: v1.<span class=\"number\">11.0</span></span><br><span class=\"line\">[upgrade<span class=\"regexp\">/versions] WARNING: Couldn't fetch latest stable version from the internet: unable to get URL \"https:/</span><span class=\"regexp\">/dl.k8s.io/release/stable.txt\": Get https:/</span>/storage.googleapis.com/kubernetes-release/release/stable.txt: dial tcp <span class=\"number\">34.64</span>.<span class=\"number\">4.80</span>:<span class=\"number\">443</span>: i/o timeout</span><br><span class=\"line\">[upgrade/versions] WARNING: Falling back <span class=\"keyword\">to</span> current kubeadm version as latest stable version</span><br><span class=\"line\">[upgrade/versions] Latest version <span class=\"keyword\">in</span> the v1.<span class=\"number\">10</span> series: v1.<span class=\"number\">10.13</span></span><br><span class=\"line\"></span><br><span class=\"line\">External components <span class=\"literal\">that</span> should be upgraded manually before you upgrade the control plane <span class=\"keyword\">with</span> <span class=\"string\">'kubeadm upgrade apply'</span>:</span><br><span class=\"line\">COMPONENT   CURRENT   AVAILABLE</span><br><span class=\"line\">Etcd        <span class=\"number\">3.3</span>.<span class=\"number\">11</span>    <span class=\"number\">3.1</span>.<span class=\"number\">12</span></span><br><span class=\"line\"></span><br><span class=\"line\">Components <span class=\"literal\">that</span> must be upgraded manually after you have upgraded the control plane <span class=\"keyword\">with</span> <span class=\"string\">'kubeadm upgrade apply'</span>:</span><br><span class=\"line\">COMPONENT   CURRENT       AVAILABLE</span><br><span class=\"line\">Kubelet     <span class=\"number\">1</span> x v1.<span class=\"number\">10.1</span>   v1.<span class=\"number\">10.13</span></span><br><span class=\"line\"></span><br><span class=\"line\">Upgrade <span class=\"keyword\">to</span> the latest version <span class=\"keyword\">in</span> the v1.<span class=\"number\">10</span> series:</span><br><span class=\"line\"></span><br><span class=\"line\">COMPONENT            CURRENT   AVAILABLE</span><br><span class=\"line\">API Server           v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">10.13</span></span><br><span class=\"line\">Controller Manager   v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">10.13</span></span><br><span class=\"line\">Scheduler            v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">10.13</span></span><br><span class=\"line\">Kube Proxy           v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">10.13</span></span><br><span class=\"line\">CoreDNS              <span class=\"number\">1.0</span>.<span class=\"number\">6</span>     <span class=\"number\">1.1</span>.<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">You can now apply the upgrade <span class=\"keyword\">by</span> executing the following command:</span><br><span class=\"line\"></span><br><span class=\"line\"> kubeadm upgrade apply v1.<span class=\"number\">10.13</span></span><br><span class=\"line\"></span><br><span class=\"line\">_____________________________________________________________________</span><br><span class=\"line\"></span><br><span class=\"line\">External components <span class=\"literal\">that</span> should be upgraded manually before you upgrade the control plane <span class=\"keyword\">with</span> <span class=\"string\">'kubeadm upgrade apply'</span>:</span><br><span class=\"line\">COMPONENT   CURRENT   AVAILABLE</span><br><span class=\"line\">Etcd        <span class=\"number\">3.3</span>.<span class=\"number\">11</span>    <span class=\"number\">3.2</span>.<span class=\"number\">18</span></span><br><span class=\"line\"></span><br><span class=\"line\">Components <span class=\"literal\">that</span> must be upgraded manually after you have upgraded the control plane <span class=\"keyword\">with</span> <span class=\"string\">'kubeadm upgrade apply'</span>:</span><br><span class=\"line\">COMPONENT   CURRENT       AVAILABLE</span><br><span class=\"line\">Kubelet     <span class=\"number\">1</span> x v1.<span class=\"number\">10.1</span>   v1.<span class=\"number\">11.0</span></span><br><span class=\"line\"></span><br><span class=\"line\">Upgrade <span class=\"keyword\">to</span> the latest stable version:</span><br><span class=\"line\"></span><br><span class=\"line\">COMPONENT            CURRENT   AVAILABLE</span><br><span class=\"line\">API Server           v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">11.0</span></span><br><span class=\"line\">Controller Manager   v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">11.0</span></span><br><span class=\"line\">Scheduler            v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">11.0</span></span><br><span class=\"line\">Kube Proxy           v1.<span class=\"number\">10.0</span>   v1.<span class=\"number\">11.0</span></span><br><span class=\"line\">CoreDNS              <span class=\"number\">1.0</span>.<span class=\"number\">6</span>     <span class=\"number\">1.1</span>.<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">You can now apply the upgrade <span class=\"keyword\">by</span> executing the following command:</span><br><span class=\"line\"></span><br><span class=\"line\"> kubeadm upgrade apply v1.<span class=\"number\">11.0</span></span><br><span class=\"line\"></span><br><span class=\"line\">_____________________________________________________________________</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"执行升级操作\"><a href=\"#执行升级操作\" class=\"headerlink\" title=\"执行升级操作\"></a>执行升级操作</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm<span class=\"built_in\"> upgrade </span>apply v<span class=\"variable\">$&#123;k8s_version&#125;</span>  --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span> --dry-run</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改下kubeadmin-10-view.conf配置 imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth</span></span><br><span class=\"line\">vim <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-controller-manager-amd64:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-scheduler-amd64:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-apiserver-amd64:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/coredns:1.1.3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm<span class=\"built_in\"> upgrade </span>apply v<span class=\"variable\">$&#123;k8s_version&#125;</span> --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"升级kubelet-kubectl\"><a href=\"#升级kubelet-kubectl\" class=\"headerlink\" title=\"升级kubelet kubectl\"></a>升级kubelet kubectl</h4><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubectl-$&#123;version&#125; kubelet-$&#123;version&#125; --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改下kubelet配置(否则集群会报错)</span></span><br><span class=\"line\">vim /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">kubelet</span>/<span class=\"title\">kubeadm</span>-<span class=\"title\">flags</span>.<span class=\"title\">env</span></span></span><br><span class=\"line\">增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/<span class=\"symbol\">pause:</span><span class=\"number\">3.1</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl stop kubelet</span><br><span class=\"line\">systemctl start kubelet</span><br><span class=\"line\">kubectl version</span><br><span class=\"line\">kubelet --version</span><br><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里执行完, 我的pod mysql和redis等服务器并没有被重启</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.11 -> k8s1.12 </font>\n</center>\n\n\n<h3 id=\"k8s1-11-gt-k8s1-12\"><a href=\"#k8s1-11-gt-k8s1-12\" class=\"headerlink\" title=\"k8s1.11 -&gt; k8s1.12\"></a>k8s1.11 -&gt; k8s1.12</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在这之前先停一下指标 metrics-server 和 prometheus-adapter (我这里会导致api-server无法启动成功,找不到metrics.k8s.io/v1beta1 等)</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">delete</span> -f /<span class=\"keyword\">data</span>/k8s-config/prometheus/prometheus-adapter </span><br><span class=\"line\">kubectl <span class=\"keyword\">delete</span> -f /<span class=\"keyword\">data</span>/k8s-config/metrics-<span class=\"keyword\">server</span>/metrics-<span class=\"keyword\">server</span><span class=\"number\">-0.3</span><span class=\"number\">.2</span>/deploy/<span class=\"number\">1.8</span>+/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存配置</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> k8s_old_version=<span class=\"number\">1.11</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> k8s_version=<span class=\"number\">1.12</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm config <span class=\"keyword\">view</span> &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\"><span class=\"comment\"># 或者通过configmap (注意是 ClusterConfiguration)</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">get</span> configmap -n kube-<span class=\"keyword\">system</span> kubeadm-config -o jsonpath=&#123;.data.MasterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum makecache <span class=\"keyword\">all</span></span><br><span class=\"line\"><span class=\"keyword\">version</span>=$(yum <span class=\"keyword\">list</span> kubeadm <span class=\"comment\">--showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')</span></span><br><span class=\"line\">echo $<span class=\"keyword\">version</span></span><br><span class=\"line\"></span><br><span class=\"line\">yum <span class=\"keyword\">install</span> -y kubeadm-$&#123;<span class=\"keyword\">version</span>&#125; <span class=\"comment\">--disableexcludes=kubernetes</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"keyword\">upgrade</span> plan</span><br><span class=\"line\">COMPONENT   <span class=\"keyword\">CURRENT</span>   AVAILABLE</span><br><span class=\"line\">Etcd        <span class=\"number\">3.3</span><span class=\"number\">.11</span>    <span class=\"number\">3.2</span><span class=\"number\">.24</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Upgrade</span> <span class=\"keyword\">to</span> the latest <span class=\"keyword\">version</span> <span class=\"keyword\">in</span> the v1<span class=\"number\">.11</span> series:</span><br><span class=\"line\"></span><br><span class=\"line\">COMPONENT            <span class=\"keyword\">CURRENT</span>   AVAILABLE</span><br><span class=\"line\">API <span class=\"keyword\">Server</span>           v1<span class=\"number\">.11</span><span class=\"number\">.0</span>   v1<span class=\"number\">.12</span><span class=\"number\">.0</span></span><br><span class=\"line\">Controller Manager   v1<span class=\"number\">.11</span><span class=\"number\">.0</span>   v1<span class=\"number\">.12</span><span class=\"number\">.0</span></span><br><span class=\"line\">Scheduler            v1<span class=\"number\">.11</span><span class=\"number\">.0</span>   v1<span class=\"number\">.12</span><span class=\"number\">.0</span></span><br><span class=\"line\">Kube Proxy           v1<span class=\"number\">.11</span><span class=\"number\">.0</span>   v1<span class=\"number\">.12</span><span class=\"number\">.0</span></span><br><span class=\"line\">CoreDNS              <span class=\"number\">1.1</span><span class=\"number\">.3</span>     <span class=\"number\">1.2</span><span class=\"number\">.2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改image地址(之前是registry.cn-hangzhou.aliyuncs.com/k8sth)</span></span><br><span class=\"line\">vim $&#123;kubeadm_config&#125;</span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"keyword\">upgrade</span> <span class=\"keyword\">apply</span> v$&#123;k8s_version&#125;  <span class=\"comment\">--config $&#123;kubeadm_config&#125; --dry-run</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class=\"number\">3.1</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class=\"number\">1.2</span><span class=\"number\">.2</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:<span class=\"number\">3.2</span><span class=\"number\">.24</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"keyword\">upgrade</span> <span class=\"keyword\">apply</span> v$&#123;k8s_version&#125; <span class=\"comment\">--config $&#123;kubeadm_config&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum <span class=\"keyword\">install</span> -y kubelet-$&#123;<span class=\"keyword\">version</span>&#125; kubectl-$&#123;<span class=\"keyword\">version</span>&#125; <span class=\"comment\">--disableexcludes=kubernetes</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\">kubectl <span class=\"keyword\">version</span></span><br><span class=\"line\">kubelet <span class=\"comment\">--version</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">get</span> nodes</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.12 -> k8s1.13 </font>\n</center>\n\n\n\n<h3 id=\"k8s1-12-gt-k8s1-13\"><a href=\"#k8s1-12-gt-k8s1-13\" class=\"headerlink\" title=\"k8s1.12 -&gt; k8s1.13\"></a>k8s1.12 -&gt; k8s1.13</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 保存配置</span><br><span class=\"line\">export k8s_old_version=1.12.0</span><br><span class=\"line\">export k8s_version=1.13.0</span><br><span class=\"line\">export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-view.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># 通过configmap</span><br><span class=\"line\">kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">yum makecache all</span><br><span class=\"line\">version=$(yum list kubeadm --showduplicates | sort -r|grep $&#123;k8s_version&#125;|awk '&#123;print $2&#125;')</span><br><span class=\"line\">echo $version</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubeadm-$&#123;version&#125; --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade plan</span><br><span class=\"line\">External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':</span><br><span class=\"line\">COMPONENT   CURRENT   AVAILABLE</span><br><span class=\"line\">Etcd        3.3.11    3.2.24</span><br><span class=\"line\"></span><br><span class=\"line\">Upgrade to the latest stable version:</span><br><span class=\"line\"></span><br><span class=\"line\">COMPONENT            CURRENT   AVAILABLE</span><br><span class=\"line\">API Server           v1.12.0   v1.13.0</span><br><span class=\"line\">Controller Manager   v1.12.0   v1.13.0</span><br><span class=\"line\">Scheduler            v1.12.0   v1.13.0</span><br><span class=\"line\">Kube Proxy           v1.12.0   v1.13.0</span><br><span class=\"line\">CoreDNS              1.2.2     1.2.6</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v$&#123;k8s_version&#125;  --config $&#123;kubeadm_config&#125; --dry-run</span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.6</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubelet-$&#123;version&#125; kubectl-$&#123;version&#125; --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\">kubectl version</span><br><span class=\"line\">kubelet --version</span><br><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.13 -> k8s1.14 </font>\n</center>\n\n<h3 id=\"k8s1-13-gt-k8s1-14\"><a href=\"#k8s1-13-gt-k8s1-14\" class=\"headerlink\" title=\"k8s1.13 -&gt; k8s1.14\"></a>k8s1.13 -&gt; k8s1.14</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 保存配置</span><br><span class=\"line\">export k8s_old_version=<span class=\"number\">1.13</span>.<span class=\"number\">0</span></span><br><span class=\"line\">export k8s_version=<span class=\"number\">1.14</span>.<span class=\"number\">0</span></span><br><span class=\"line\">export kubeadm_config=kubeadmin-$&#123;k8s_old_version&#125;-<span class=\"keyword\">view</span>.<span class=\"keyword\">conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"># config <span class=\"keyword\">view</span>或者通过configmap(<span class=\"number\">2</span>选<span class=\"number\">1</span>)</span><br><span class=\"line\">kubeadm config <span class=\"keyword\">view</span> &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\">kubectl <span class=\"built_in\">get</span> configmap -n kube-<span class=\"built_in\">system</span> kubeadm-config -<span class=\"keyword\">o</span> jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum makecache <span class=\"keyword\">all</span></span><br><span class=\"line\"><span class=\"keyword\">version</span>=$(yum <span class=\"keyword\">list</span> kubeadm --showduplicates | <span class=\"keyword\">sort</span> -r|<span class=\"keyword\">grep</span> $&#123;k8s_version&#125;|awk <span class=\"string\">'&#123;print $2&#125;'</span>)</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $<span class=\"keyword\">version</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(<span class=\"number\">1.18</span>.<span class=\"number\">2</span>) </span><br><span class=\"line\"># (这里<span class=\"number\">1.14</span>会依赖kubernetes-cni:<span class=\"number\">0.7</span>.<span class=\"number\">5</span>-<span class=\"number\">0</span>)</span><br><span class=\"line\">yum install -<span class=\"keyword\">y</span> kubeadm-$&#123;<span class=\"keyword\">version</span>&#125; kubelet-$&#123;<span class=\"keyword\">version</span>&#125; kubectl-$&#123;<span class=\"keyword\">version</span>&#125;  --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade plan</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v$&#123;k8s_version&#125;  --config $&#123;kubeadm_config&#125; --dry-run</span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.<span class=\"keyword\">cn</span>-hangzhou.aliyuncs.<span class=\"keyword\">com</span>/google_containers/kube-proxy:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.<span class=\"keyword\">cn</span>-hangzhou.aliyuncs.<span class=\"keyword\">com</span>/google_containers/kube-controller-manager:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.<span class=\"keyword\">cn</span>-hangzhou.aliyuncs.<span class=\"keyword\">com</span>/google_containers/kube-scheduler:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.<span class=\"keyword\">cn</span>-hangzhou.aliyuncs.<span class=\"keyword\">com</span>/google_containers/kube-apiserver:v$&#123;k8s_version&#125;</span><br><span class=\"line\">docker pull registry.<span class=\"keyword\">cn</span>-hangzhou.aliyuncs.<span class=\"keyword\">com</span>/google_containers/pause:<span class=\"number\">3.1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v$&#123;k8s_version&#125; --config $&#123;kubeadm_config&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\">kubectl <span class=\"keyword\">version</span></span><br><span class=\"line\">kubelet --<span class=\"keyword\">version</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">get</span> nodes</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.14 -> k8s1.15 </font>\n</center>\n\n\n\n<h3 id=\"k8s1-14-gt-k8s1-15\"><a href=\"#k8s1-14-gt-k8s1-15\" class=\"headerlink\" title=\"k8s1.14 -&gt; k8s1.15\"></a>k8s1.14 -&gt; k8s1.15</h3><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 保存配置</span><br><span class=\"line\">export k8s_old_version=1.14.0</span><br><span class=\"line\">export k8s_version=1.15.0</span><br><span class=\"line\">export kubeadm_config=kubeadmin-<span class=\"variable\">$&#123;k8s_old_version&#125;</span>-<span class=\"keyword\">view</span>.<span class=\"keyword\">conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"># config <span class=\"keyword\">view</span>或者通过configmap(2选1)</span><br><span class=\"line\">kubeadm config <span class=\"keyword\">view</span> &gt; <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\">kubectl get configmap -<span class=\"keyword\">n</span> kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum makecache all</span><br><span class=\"line\"><span class=\"keyword\">version</span>=$(yum <span class=\"keyword\">list</span> kubeadm --showduplicates | <span class=\"keyword\">sort</span> -r|grep <span class=\"variable\">$&#123;k8s_version&#125;</span>|awk '&#123;<span class=\"keyword\">print</span> <span class=\"variable\">$2&#125;</span>')</span><br><span class=\"line\"></span><br><span class=\"line\"># 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) </span><br><span class=\"line\">yum install -y kubeadm-<span class=\"variable\">$&#123;version&#125;</span> kubelet-<span class=\"variable\">$&#123;version&#125;</span> kubectl-<span class=\"variable\">$&#123;version&#125;</span>  --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade plan</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v<span class=\"variable\">$&#123;k8s_version&#125;</span>  --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span> --dry-<span class=\"keyword\">run</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class=\"keyword\">pause</span>:3.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v<span class=\"variable\">$&#123;k8s_version&#125;</span> --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\">kubectl <span class=\"keyword\">version</span></span><br><span class=\"line\">kubelet --<span class=\"keyword\">version</span></span><br><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s1.15.0 -> k8s1.15.11 </font>\n</center>\n\n\n\n<h3 id=\"k8s1-15-0-gt-k8s1-15-11-选择11是因为google-containers-kube-proxy-v1-15-12-not-found\"><a href=\"#k8s1-15-0-gt-k8s1-15-11-选择11是因为google-containers-kube-proxy-v1-15-12-not-found\" class=\"headerlink\" title=\"k8s1.15.0 -&gt; k8s1.15.11 (选择11是因为google_containers/kube-proxy:v1.15.12 not found)\"></a>k8s1.15.0 -&gt; k8s1.15.11 (选择11是因为google_containers/kube-proxy:v1.15.12 not found)</h3><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 保存配置</span><br><span class=\"line\">export k8s_old_version=1.15.0</span><br><span class=\"line\">export k8s_version=1.15.11</span><br><span class=\"line\">export kubeadm_config=kubeadmin-<span class=\"variable\">$&#123;k8s_old_version&#125;</span>-<span class=\"keyword\">view</span>.<span class=\"keyword\">conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"># config <span class=\"keyword\">view</span>或者通过configmap(2选1)</span><br><span class=\"line\">kubeadm config <span class=\"keyword\">view</span> &gt; <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\">kubectl get configmap -<span class=\"keyword\">n</span> kube-system kubeadm-config -o jsonpath=&#123;.data.ClusterConfiguration&#125; &gt; <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum makecache all</span><br><span class=\"line\"><span class=\"keyword\">version</span>=$(yum <span class=\"keyword\">list</span> kubeadm --showduplicates | <span class=\"keyword\">sort</span> -r|grep <span class=\"variable\">$&#123;k8s_version&#125;</span>|awk '&#123;<span class=\"keyword\">print</span> <span class=\"variable\">$2&#125;</span>')</span><br><span class=\"line\"></span><br><span class=\"line\"># 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) </span><br><span class=\"line\">yum install -y kubeadm-<span class=\"variable\">$&#123;version&#125;</span>  --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade plan</span><br><span class=\"line\">COMPONENT   CURRENT   AVAILABLE</span><br><span class=\"line\">Etcd        3.3.11    3.3.10</span><br><span class=\"line\"></span><br><span class=\"line\">COMPONENT            CURRENT   AVAILABLE</span><br><span class=\"line\">API Server           v1.15.0   v1.15.11</span><br><span class=\"line\">Controller Manager   v1.15.0   v1.15.11</span><br><span class=\"line\">Scheduler            v1.15.0   v1.15.11</span><br><span class=\"line\">Kube Proxy           v1.15.0   v1.15.11</span><br><span class=\"line\">CoreDNS              1.3.1     1.3.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v<span class=\"variable\">$&#123;k8s_version&#125;</span>  --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span> --dry-<span class=\"keyword\">run</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class=\"variable\">$&#123;k8s_version&#125;</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class=\"keyword\">pause</span>:3.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm upgrade apply v<span class=\"variable\">$&#123;k8s_version&#125;</span> --config <span class=\"variable\">$&#123;kubeadm_config&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubelet-<span class=\"variable\">$&#123;version&#125;</span> kubectl-<span class=\"variable\">$&#123;version&#125;</span>  --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\">kubectl <span class=\"keyword\">version</span></span><br><span class=\"line\">kubelet --<span class=\"keyword\">version</span></span><br><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 升级docker </font>\n</center>\n\n\n<h3 id=\"升级docker-慎用\"><a href=\"#升级docker-慎用\" class=\"headerlink\" title=\"升级docker (慎用)\"></a>升级docker (慎用)</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install docker-ce-18.09.9 docker-ce-cli-18.09.9</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启docker, k8s集群会间断(如果是多台, 将重启的节点taint剔除集群重启即可)</span></span><br><span class=\"line\">service docker restart</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 升级单机版rancher </font>\n</center>\n\n<h3 id=\"升级单机版rancher\"><a href=\"#升级单机版rancher\" class=\"headerlink\" title=\"升级单机版rancher\"></a>升级单机版rancher</h3><blockquote>\n<p> 这里之前是2.1.9版本, 更新为stable(2.4.3) ,我这里rancher只是用导入方式,rancher宕机不影响k8s集群</p>\n</blockquote>\n<ol>\n<li>首先将swarm启动的rancher停用:<br><code>docker service rm rancher_rancher</code></li>\n<li>其次将data目录备份<br><code>cp -ra /data/rancher /data/rancher_2.1.9_2020-05-20_bak</code></li>\n<li>修改docker-compose.yml重新启动<br><code>docker stack deploy -c docker-compose.yml rancher</code></li>\n<li>查看日志<br><code>docker logs -f $(docker ps|grep rancher_rancher|awk &#39;{print $1}&#39;)</code></li>\n<li>恢复(停止服务,将备份的目录还原重新启动即可)</li>\n</ol>\n<ul>\n<li>docker-compose.yml <figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"><span class=\"symbol\">services:</span></span><br><span class=\"line\"><span class=\"symbol\">  rancher:</span></span><br><span class=\"line\"><span class=\"symbol\">    hostname:</span> rancher</span><br><span class=\"line\"><span class=\"symbol\">    image:</span> rancher/rancher:stable</span><br><span class=\"line\"><span class=\"symbol\">    deploy:</span></span><br><span class=\"line\"><span class=\"symbol\">      replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"symbol\">      restart_policy:</span></span><br><span class=\"line\"><span class=\"symbol\">        condition:</span> on-failure</span><br><span class=\"line\"><span class=\"symbol\">    volumes:</span></span><br><span class=\"line\">      - <span class=\"meta-keyword\">/data/</span>rancher<span class=\"meta-keyword\">/data/</span>:<span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/rancher/</span></span><br><span class=\"line\"><span class=\"symbol\">    ports:</span></span><br><span class=\"line\">      - <span class=\"number\">10080</span>:<span class=\"number\">80</span></span><br><span class=\"line\">      - <span class=\"number\">10443</span>:<span class=\"number\">443</span></span><br><span class=\"line\"><span class=\"symbol\">    networks:</span></span><br><span class=\"line\">      - rancher_net</span><br><span class=\"line\"><span class=\"symbol\">networks:</span></span><br><span class=\"line\"><span class=\"symbol\">  rancher_net:</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 问题 </font>\n</center>\n\n<hr>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><h4 id=\"1-版本选择的image配置问题\"><a href=\"#1-版本选择的image配置问题\" class=\"headerlink\" title=\"1. 版本选择的image配置问题\"></a>1. 版本选择的image配置问题</h4><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">开始选择升级到k8s1<span class=\"meta\">.11</span><span class=\"meta\">.10</span>版本, 但是镜像版本只有registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1<span class=\"meta\">.11</span><span class=\"meta\">.0</span> , 没有找到v1<span class=\"meta\">.11</span><span class=\"meta\">.10</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-1-12版本开始阿里云镜像地址变化\"><a href=\"#2-1-12版本开始阿里云镜像地址变化\" class=\"headerlink\" title=\"2. 1.12版本开始阿里云镜像地址变化\"></a>2. 1.12版本开始阿里云镜像地址变化</h4><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">registry<span class=\"selector-class\">.cn-hangzhou</span><span class=\"selector-class\">.aliyuncs</span><span class=\"selector-class\">.com</span>/google_containers/kube-proxy:v1.<span class=\"number\">12.0</span></span><br><span class=\"line\">registry<span class=\"selector-class\">.cn-hangzhou</span><span class=\"selector-class\">.aliyuncs</span><span class=\"selector-class\">.com</span>/google_containers/pause:<span class=\"number\">3.1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-如果执行升级中断或停止-可以\"><a href=\"#3-如果执行升级中断或停止-可以\" class=\"headerlink\" title=\"3. 如果执行升级中断或停止, 可以\"></a>3. 如果执行升级中断或停止, 可以</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm<span class=\"built_in\"> upgrade </span>--force。</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-如果跨版本升级\"><a href=\"#4-如果跨版本升级\" class=\"headerlink\" title=\"4. 如果跨版本升级\"></a>4. 如果跨版本升级</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- Specified version <span class=\"keyword\">to</span><span class=\"built_in\"> upgrade </span><span class=\"keyword\">to</span> <span class=\"string\">\"v1.16.2\"</span> is too high; kubeadm can<span class=\"built_in\"> upgrade </span>only 1 minor version at a time</span><br><span class=\"line\">- Specified version <span class=\"keyword\">to</span><span class=\"built_in\"> upgrade </span><span class=\"keyword\">to</span> <span class=\"string\">\"v1.16.2\"</span> is at least one minor release higher than the kubeadm minor release (16 &gt; 11). Such an<span class=\"built_in\"> upgrade </span>is <span class=\"keyword\">not</span> supported</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-k8s1-11-开启使用了pause-3-1\"><a href=\"#5-k8s1-11-开启使用了pause-3-1\" class=\"headerlink\" title=\"5. k8s1.11 开启使用了pause:3.1\"></a>5. k8s1.11 开启使用了pause:3.1</h4><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k8s1.<span class=\"number\">11</span>开始kubelet的配置文件修改为:</span><br><span class=\"line\">vim /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">kubelet</span>/<span class=\"title\">kubeadm</span>-<span class=\"title\">flags</span>.<span class=\"title\">env</span></span></span><br><span class=\"line\">增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/<span class=\"symbol\">pause:</span><span class=\"number\">3.1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-在1-12-gt-1-13升级完成后报错-OpenAPI-spec-for-“v1beta1-metrics-k8s-io”-failed-with-OpenAPI-spec-does-not-exists\"><a href=\"#6-在1-12-gt-1-13升级完成后报错-OpenAPI-spec-for-“v1beta1-metrics-k8s-io”-failed-with-OpenAPI-spec-does-not-exists\" class=\"headerlink\" title=\"6. 在1.12-&gt;1.13升级完成后报错: OpenAPI spec for “v1beta1.metrics.k8s.io” failed with: OpenAPI spec does not exists\"></a>6. 在1.12-&gt;1.13升级完成后报错: OpenAPI spec for “v1beta1.metrics.k8s.io” failed with: OpenAPI spec does not exists</h4><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.11 -&gt; 1.12 k8s_kube-apiserver日志</span></span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.369346</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> crd.projectcalico.org/v1: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.369725</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> authentication.istio.io/v1alpha1: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.370842</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> certmanager.k8s.io/v1alpha1: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.371925</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> rbac.istio.io/v1alpha1: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.373016</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> config.istio.io/v1alpha2: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.374083</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> networking.istio.io/v1alpha3: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\">E0520 <span class=\"number\">06</span>:<span class=\"number\">21</span>:<span class=\"number\">09.375179</span>       <span class=\"number\">1</span> memcache.go:<span class=\"number\">134</span>] couldn't <span class=\"keyword\">get</span> resource <span class=\"built_in\">list</span> <span class=\"keyword\">for</span> metrics.k8s.io/v1beta1: <span class=\"keyword\">the</span> server could <span class=\"keyword\">not</span> find <span class=\"keyword\">the</span> requested resource</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.12-&gt;1.13 k8s_kube-apiserver日志</span></span><br><span class=\"line\">OpenAPI spec <span class=\"keyword\">for</span> <span class=\"string\">\"v1beta1.metrics.k8s.io\"</span> failed <span class=\"keyword\">with</span>: OpenAPI spec <span class=\"keyword\">does</span> <span class=\"keyword\">not</span> exists</span><br><span class=\"line\"></span><br><span class=\"line\">原因是我这边metrics-server 和prometheus-adapter 部署的时候用到了metrics.k8s.io/v1beta1</span><br><span class=\"line\">但是升级之后这个api-<span class=\"built_in\">version</span>丢失了, 所以导致apiserver一直报错, 无法启动成功</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-单机k8s升级会造成服务中断\"><a href=\"#7-单机k8s升级会造成服务中断\" class=\"headerlink\" title=\"7. 单机k8s升级会造成服务中断\"></a>7. 单机k8s升级会造成服务中断</h4><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"number\">1.10</span> ~ <span class=\"number\">1.13</span></span><br><span class=\"line\">升级会导致核心组件apiserver,scheduler,controller,coredns,网络calico等由于版本升级都需要重新启动了一次, 部分其他业务pod也会重启</span><br><span class=\"line\">其中nodejs服务会pm2重启,mysql等也会重启 ,会导致服务器压力上升</span><br><span class=\"line\">这里检测到有状态statefulset的服务并没有重启, 而无状态的deployment会重启, 由于单机<span class=\"number\">1</span>个pod的服务重启会导致中断</span><br><span class=\"line\">所以避免业务中断必须是多主机集群, 在升级之前先taint机器升级</span><br><span class=\"line\"></span><br><span class=\"line\"># <span class=\"number\">1.13</span> -&gt; <span class=\"number\">1.14</span></span><br><span class=\"line\">这期间有状态statefulset的服务也重启了</span><br><span class=\"line\"></span><br><span class=\"line\"># <span class=\"number\">1.14</span> ~ <span class=\"number\">1.15</span><span class=\"number\">.11</span></span><br><span class=\"line\">这期间有状态statefulset的服务没有重启</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"8-注意1-13-gt-1-14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本\"><a href=\"#8-注意1-13-gt-1-14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本\" class=\"headerlink\" title=\"8. 注意1.13-&gt;1.14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本\"></a>8. 注意1.13-&gt;1.14的时候安装kubeadm可能会依赖kubelet自动安装了最新版本</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) </span></span><br><span class=\"line\"><span class=\"comment\"># (这里1.14会依赖kubernetes-cni:0.7.5-0)</span></span><br><span class=\"line\">yum install -y kubeadm-<span class=\"variable\">$&#123;version&#125;</span> kubelet-<span class=\"variable\">$&#123;version&#125;</span> kubectl-<span class=\"variable\">$&#123;version&#125;</span>  <span class=\"attribute\">--disableexcludes</span>=kubernetes</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/05/18/48-k8s升级-1-10-1-15/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"k8s安装promethues+alertmanager+grafana","date":"2020-05-14T10:34:47.000Z","path":"2020/05/14/47-k8s安装promethues-alertmanager-grafana/","text":"本文主要是针对prometheus 简单部署 , 考虑到测试资源有限,为更精简自定义按照监控,减少多余资源占用, 也同时更了解prometheus的更多细节, 这里没有使用prometheus-operator 1 K8s上部署原生的prometheus 2 prometheus-operator 方式部署 3 docker-compose快速搭建 Prometheus+Grafana监控系统 4 一套prometheus监控多个k8s集群,详细讲解配置 5 使用prometheus监控traefik、redis、k8s集群各节点、各节点kubelet 6 grafana 监控模板下载 搭建prometheus创建ns123456789tee ns.yml &lt;&lt;- EOFapiVersion: v1kind: Namespacemetadata: name: monitoringEOFkubectl apply -f ns.yml prometheus-clusterRole.yml1234567891011121314151617tee prometheus-clusterRole.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: prometheus-k8srules: - apiGroups: - \"\" resources: - nodes/metrics verbs: - get - nonResourceURLs: - /metrics verbs: - getEOF prometheus-clusterRoleBinding.yml1234567891011121314tee prometheus-clusterRoleBinding.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: prometheus-k8sroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: prometheus-k8ssubjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoringEOF prometheus-serviceAccount.yml1234567tee prometheus-serviceAccount.yml &lt;&lt;- EOFapiVersion: v1kind: ServiceAccountmetadata: name: prometheus-k8s namespace: monitoringEOF 创建角色123kubectl apply -f prometheus-clusterRole.ymlkubectl apply -f prometheus-clusterRoleBinding.ymlkubectl apply -f prometheus-serviceAccount.yml 这样我们就创建了一个 ServiceAccount，名为 prometheus-k8s，这个 ServiceAccount 不仅现在可以用来获取 kubelet 的监控指标，后续 Prometheus 也会使用这个 serviceAccount 启动。 创建完成后，会自动在生成一个 secret，里面包含了 token：123kubectl get secret -n monitoringNAME TYPE DATA AGEprometheus-k8s-token-6v9m9 kubernetes.io/service-account-token 3 13s 获取token12token=$(kubectl get secret prometheus-k8s-token-6v9m9 -n monitoring -o json|jq -r '.data.token'|base64 -d)token=$(kubectl get secret prometheus-k8s-token-pl2wx -n monitoring -o json|jq -r '.data.token'|base64 -d) 通过token查看metrics1curl https://127.0.0.1:10250/metrics/cadvisor -k -H \"Authorization: Bearer $token\" kubelet 除了 /metrics/cadvisor 这个 url 之外，还有一个 /metrics，这是它本身的监控指标而非 pod 的 查看etc指标页面etcd 的指标页面的 url 也是 /metrics，但是你想要访问它需要提供证书，因为它会验证客户端证书。当然你可以在它的启动参数中通过 –listen-metrics-urls http://ip:port 让监控指标页使用 http 而非 https，这样就不用提供证书了。etcd 虽然部署在容器中，但是由于使用了 hostNetwork，所以我们可以通过直接访问 master 的 2379 端口访问它。默认它会采用了 https，因此我们需要提供它的 peer 证书。如果 k8s 是使用 kubeadm 安装的，etcd 的证书在 /etc/kubernetes/pki/etcd/ 目录下。因此访问 etcd 的命令为：curl https://127.0.0.1:2379/metrics –cacert /etc/kubernetes/pki/etcd/ca.crt –cert /etc/kubernetes/pki/etcd/healthcheck-client.crt –key /etc/kubernetes/pki/etcd/healthcheck-client.key复制代码后面我们需要将这三个文件挂载到 Prometheus 容器中，以便它能收集 etcd 监控数据。 如果你并非容器部署的etcd,请使用你的etcd端口访问 安装 Prometheus我们先创建两个 configmap，一个是 Prometheus 的配置文件，另一个是告警的规则文件12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152tee prometheus-configmap.yml &lt;&lt;- EOFapiVersion: v1data: prometheus.yml: | global: evaluation_interval: 30s scrape_interval: 30s external_labels: prometheus: monitoring/k8s rule_files: - /etc/prometheus/rules/*.yml scrape_configs: - job_name: prometheus honor_labels: false kubernetes_sd_configs: - role: endpoints namespaces: names: - monitoring scrape_interval: 30s relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_prometheus regex: k8s - source_labels: - __meta_kubernetes_endpoint_address_target_kind - __meta_kubernetes_endpoint_address_target_name separator: ; regex: Pod;(.*) replacement: $&#123;1&#125; target_label: pod - source_labels: - __meta_kubernetes_namespace target_label: namespace - source_labels: - __meta_kubernetes_service_name target_label: service - source_labels: - __meta_kubernetes_pod_name target_label: pod - source_labels: - __meta_kubernetes_service_name target_label: job replacement: $&#123;1&#125; - target_label: endpoint replacement: webkind: ConfigMapmetadata: name: prometheus namespace: monitoringEOF 首先看这段配置 123456kubernetes_sd_configs:- role: endpoints namespaces: names: - monitoringscrape_interval: 30s 这段配置使用的是 endpoint 的方式对 Prometheus 本身进行自动发现，你可以有疑问了，为什么不直接对自身的 127.0.0.1:9090 进行采集呢？因为考虑到 Prometheus 可能会有多台，这样即使有多台，它们也都在一个 job 下面。 kubernetes_sd_configs 配置可以自动发现 k8s 中 node、service、pod、endpoint、ingress，并为其添加监控, 详见: kubernetes_sd_configs官方文档 再看下面这段配置 1234- action: keep source_labels: - __meta_kubernetes_service_label_prometheus regex: k8s 表示并非所有的endpoint 都会被抓取, 这里只抓取label 是 prometheus=k8s的标签, 所以只会监控prometheus的endpoint 默认不指定url 就是/metrics 接着看这段配置 1234567- source_labels: - __meta_kubernetes_endpoint_address_target_kind - __meta_kubernetes_endpoint_address_target_name separator: ; regex: Pod;(.*) replacement: $&#123;1&#125; target_label: pod 如果 meta_kubernetes_endpoint_address_target_kind 的值为 Pod，meta_kubernetes_endpoint_address_target_name 的值为 prometheus-0，在它们之间加上一个 ; 之后，它们合起来就是 Pod;prometheus-0。使用正则表达式 Pod;(.*) 对其进行匹配，那么 ${1} 就是取第一个分组，它值就是 prometheus-0，最后将这个值交给 pod 这个标签。因此这一段配置就是为所有采集到的监控指标增加一个 pod=prometheus-0 的标签。 以上配置其实可以去掉, 这里prometheus=k8s的匹配条件以及唯一,这段kind和name配置去掉影响不大 创建configmap1kubectl apply -f prometheus-configmap.yml Prometheus 规则文件 (后面会更新)123456789101112tee prometheus-config-rulefiles.yml &lt;&lt;- EOFapiVersion: v1data: k8s.yml: \"\"kind: ConfigMapmetadata: name: prometheus-rulefiles namespace: monitoringEOFkubectl apply -f prometheus-config-rulefiles.yml role 和 roleBinding因为 Prometheus 会使用之前创建的 sa（serviceAccount）prometheus-k8s 运行，那么光现在 prometheus-k8s 这个 sa 的权限是没有办法查看 service 以及 endpoint 的。我们使用 kubernetes_sd_config 主要会使用 endpoint 进行发现，因此 prometheus-k8s 必须具备更多的权限。我们需要创建更多的 role，并通过 roleBinding 将这些权限绑定到 prometheus-k8s 这个 sa 上，之所以不使用 clusterRole 是为了权限最小化。这里会创建 prometheus-roleConfig.yml、prometheus-roleBindingConfig.yml、prometheus-roleSpecificNamespaces.yml、prometheus-roleBindingSpecificNamespaces.yml 这四个文件，它们的内容如下。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130tee prometheus-roleConfig.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: prometheus-k8s-config namespace: monitoringrules: - apiGroups: - \"\" resources: - configmaps verbs: - getEOFtee prometheus-roleBindingConfig.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: prometheus-k8s-config namespace: monitoringroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s-configsubjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoringEOFtee prometheus-roleSpecificNamespaces.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: RoleListitems: - apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: prometheus-k8s namespace: default rules: - apiGroups: - \"\" resources: - services - endpoints - pods verbs: - get - list - watch - apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: prometheus-k8s namespace: kube-system rules: - apiGroups: - \"\" resources: - services - endpoints - pods verbs: - get - list - watch - apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: prometheus-k8s namespace: monitoring rules: - apiGroups: - \"\" resources: - services - endpoints - pods verbs: - get - list - watchEOFtee prometheus-roleBindingSpecificNamespaces.yml &lt;&lt;- EOFapiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingListitems: - apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: default roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoring - apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: kube-system roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoring - apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: monitoring roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoringEOF 上面的权限中，config 是用来读 configmap 的，后面的就是 Prometheus 用来进行 k8s 发现时必须要的权限了，最后使用 rulebinding 将这些所有的权限都绑定到 prometheus-k8s 这个 sa 上。 12345678910kubectl delete -f prometheus-roleBindingConfig.ymlkubectl delete -f prometheus-roleBindingSpecificNamespaces.ymlkubectl delete -f prometheus-roleConfig.ymlkubectl delete -f prometheus-roleSpecificNamespaces.ymlkubectl apply -f prometheus-roleBindingConfig.ymlkubectl apply -f prometheus-roleBindingSpecificNamespaces.ymlkubectl apply -f prometheus-roleConfig.ymlkubectl apply -f prometheus-roleSpecificNamespaces.yml 手动创建pv (我这里没用上, 用的是storageclass)1234567891011121314151617tee prometheus-pv.yml &lt;&lt;- EOFapiVersion: v1kind: PersistentVolumemetadata: name: prometheus labels: name: prometheusspec: nfs: path: /disk/k8s-nfs-data/k8s-db-t/prometheus server: 172.16.xx.xx accessModes: [\"ReadWriteMany\", \"ReadWriteOnce\"] capacity: storage: 50GiEOFkubectl apply -f prometheus-pv.yml 创建 service12345678910111213141516171819202122tee prometheus-service.yml &lt;&lt;- EOFapiVersion: v1kind: Servicemetadata: name: prometheus namespace: monitoring labels: prometheus: k8sspec: clusterIP: None ports: - name: web port: 9090 protocol: TCP targetPort: web selector: app: prometheus type: ClusterIPEOFkubectl apply -f prometheus-service.yml 这里service定义了 app=prometheus 这样的标签选择器，因此 Prometheus 容器StatefulSet的时候必须存在这个标签。 部署 Prometheus123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108tee prometheus-statefulset.yml &lt;&lt;- EOFapiVersion: apps/v1kind: StatefulSetmetadata: labels: app: prometheus prometheus: k8s name: prometheus namespace: monitoringspec: replicas: 1 volumeClaimTemplates: - metadata: name: prometheus-data annotations: volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称 spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 20Gi revisionHistoryLimit: 10 selector: matchLabels: app: prometheus prometheus: k8s serviceName: prometheus updateStrategy: type: RollingUpdate template: metadata: creationTimestamp: null labels: app: prometheus prometheus: k8s spec: serviceAccount: prometheus-k8s containers: - args: - --web.console.templates=/etc/prometheus/consoles - --web.console.libraries=/etc/prometheus/console_libraries - --config.file=/etc/prometheus/config/prometheus.yml - --storage.tsdb.path=/prometheus - --web.enable-admin-api - --storage.tsdb.retention.time=20d - --web.enable-lifecycle - --storage.tsdb.no-lockfile - --web.external-url=http://promethes-dev.k1s.club/ - --web.route-prefix=/ image: prom/prometheus:v2.11.1 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 6 httpGet: path: /-/healthy port: web scheme: HTTP periodSeconds: 5 successThreshold: 1 timeoutSeconds: 3 name: prometheus ports: - containerPort: 9090 name: web protocol: TCP readinessProbe: failureThreshold: 120 httpGet: path: /-/ready port: web scheme: HTTP periodSeconds: 5 successThreshold: 1 timeoutSeconds: 3 resources: requests: memory: 400Mi terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /etc/prometheus/config name: config readOnly: true - mountPath: /prometheus name: prometheus-data #subPath: prometheus-db - mountPath: /etc/prometheus/rules/ name: prometheus-rulefiles - mountPath: /etc/prometheus/secrets/etcd-client-cert name: secret-etcd-client-cert readOnly: true volumes: - name: config configMap: defaultMode: 420 name: prometheus - name: prometheus-rulefiles configMap: defaultMode: 420 name: prometheus-rulefiles - name: secret-etcd-client-cert secret: defaultMode: 420 secretName: etcd-client-certEOFkubectl apply -f prometheus-statefulset.yml 注意下这里如果你并非容器安装的etcd, 则mount的secret-etcd-client-cert可能不存在, 请自行挂载正确的目录, 如果etcd是http访问, 则不需要证书挂载 基础的 statfulset 相关的知识我就不多提了，说几个重点吧： 1 –storage.tsdb.retention.time=20d 这个启动选项表示 Prometheus 所收集的监控数据只保留 20 天，这个值最好不要太大。如果历史数据保存很久，建议写到持久存储中，比如 VictoriaMetrics、thanos、influxdb、opentsdb 等；2 –web.enable-admin-api 这个启动选项表示启动管理员 api，你可以通过 api 对监控数据进行删除等；3 serviceAccount 它的值必须是 prometheus-k8s，不然前面的赋权操作都白干了；4 pod 必须存在 app: prometheus 这个标签，不然无法被前面创建的 service 选择到；5 挂载了两个 configmap、一个 secret 还有一个存储卷。(我这里是采用storageclass, 当然你也可以用上面的手动创建pv) 创建一个ingress12345678910111213141516171819tee prometheus-ingress.yml &lt;&lt;- EOFapiVersion: extensions/v1beta1kind: Ingressmetadata: name: prometheus namespace: monitoringspec: rules: - host: prometheus-dev.k1s.club http: paths: - path: / backend: serviceName: prometheus servicePort: 9090EOFkubectl apply -f prometheus-ingress.yml 至此, 我们就监控了prometheus本身 问题1 k8s1.10报错rbac权限错误 level=error ts=2020-05-11T10:00:03.091Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=”/app/discovery/kubernetes/kubernetes.go:335: Failed to list *v1.Node: nodes is forbidden: User &quot;system:serviceaccount:monitoring:prometheus-k8s&quot; cannot list nodes at the cluster scope” 按照以下rbac增加了权限,则正常 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556prometheus-rbac.ymlapiVersion: v1kind: ServiceAccountmetadata: name: prometheus-k8s namespace: monitoring labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: prometheus-k8s labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcilerules: - apiGroups: - \"\" resources: - nodes - nodes/metrics - services - endpoints - pods verbs: - get - list - watch - apiGroups: - \"\" resources: - configmaps verbs: - get - nonResourceURLs: - \"/metrics\" verbs: - get---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: prometheus-k8s labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: ReconcileroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: prometheus-k8ssubjects:- kind: ServiceAccount name: prometheus-k8s namespace: monitoring 监控etcd如果是容器安装的etcd集群1234567891011121314151617181920tee kube-etcd-service.yml &lt;&lt;- EOFapiVersion: v1kind: Servicemetadata: name: kube-etcd labels: k8s-app: kube-etcd namespace: kube-systemspec: clusterIP: None ports: - name: http-metrics port: 2379 protocol: TCP targetPort: 2379 selector: component: etcd type: ClusterIPEOF 由于 etcd 处于 kube-system 名称空间，所以这里的 namespace 也应该是 kube-system； 因为 etcd pod 本身会存在 component=etcd 这个标签，所以这里的选择器使用的就是这个。 12kubectl apply -f kube-etcd-service.ymlkubectl -n kube-system get endpoints kube-etcd 现在通过这个 endpoint 就能够访问到后面三台 etcd，现在只需要在 Prometheus 中添加对应的配置即可，配置内容如下。 12345678910111213141516171819202122232425262728293031323334- job_name: kube-etcd honor_labels: false kubernetes_sd_configs: - role: endpoints namespaces: names: - kube-system scheme: https tls_config: insecure_skip_verify: false ca_file: /etc/prometheus/secrets/etcd-client-cert/ca.crt cert_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.crt key_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.key relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_k8s_app regex: kube-etcd - source_labels: - __meta_kubernetes_namespace target_label: namespace - source_labels: - __meta_kubernetes_service_name target_label: service - source_labels: - __meta_kubernetes_pod_name target_label: pod - target_label: endpoint replacement: http-metrics metric_relabel_configs: - action: drop regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).* source_labels: - __name__ 我这里有一个环境是http访问的, 则直接通过http://172.16.xx.xx:2379/metrics 监控即可123456789- job_name: 'etcd' scrape_interval: 60s static_configs: - targets: ['172.16.xx.xx:2379'] metric_relabel_configs: - action: drop regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).* source_labels: - __name__ 然后重新加载configmap 1234kubectl apply -f prometheus-configmap.yml# 该配置不用重启prometheus即可重新加载配置curl -XPOST prometheus-dev.k1s.club/-/reload 监控 apiserverapiserver 的监控方式更简单，因为它的 service 已经自动创建了。但你需要注意的是，它的 service 创建在 default 名称空间，名为 kubernetes。 1234567891011121314151617181920212223- job_name: kube-apiserver honor_labels: false kubernetes_sd_configs: - role: endpoints namespaces: names: - default scrape_interval: 30s scheme: https tls_config: insecure_skip_verify: false ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: keep source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name] separator: ; regex: default;kubernetes;https metric_relabel_configs: - source_labels: - __name__ action: drop regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket) 监控 podpod 的监控指标是 kubelet 提供的，前面也已经使用 curl 命令看到了，因此这里也是直接干。prometheus-operator 使用的同样是 endpoints 发现的方式，但是 kubelet 是操作系统的进程，并不是 pod，因此通过创建 service 的方式是不可能创建对应的 endpoint 的，也不知道它为啥可以做到。为了更通用，我们这里是通过 node 发现的方式进行的。使用 node 发现，你无法指定端口，prometheus 会自动访问发现 node 的 10250 端口。 12345678910- job_name: pods honor_labels: true kubernetes_sd_configs: - role: node scrape_interval: 30s metrics_path: /metrics/cadvisor scheme: https tls_config: insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token k8s 的其他组件我就不继续监控了，包括 kubelet、controller manager、coredns 等，它们监控的手段和之前的几个组件都差不多 安装 kube-state-metrics 常见应用使用kube-state-metrics后的常用场景有： 存在执行失败的Job: kube_job_status_failed{job=”kubernetes-service-endpoints”,k8s_app=”kube-state-metrics”}==1 集群节点状态错误: kube_node_status_condition{condition=”Ready”,status!=”true”}==1 集群中存在启动失败的Pod：kube_pod_status_phase{phase=~”Failed|Unknown”}==1 最近30分钟内有Pod容器重启: changes(kube_pod_container_status_restarts[30m])&gt;0配合报警可以更好地监控集群的运行 RBAC 权限 因为它要访问集群内的所有资源，才能将它们的信息提供出去，因此部署它之前，先为它创建一些权限。这些权限都会绑定到一个 serviceAccount 上，然后我们用这个 sa 运行 kube-state-metrics 就行 kube-state-metrics-clusterRole.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: kube-state-metricsrules: - apiGroups: - \"\" resources: - configmaps - secrets - nodes - pods - services - resourcequotas - replicationcontrollers - limitranges - persistentvolumeclaims - persistentvolumes - namespaces - endpoints verbs: - list - watch - apiGroups: - extensions resources: - daemonsets - deployments - replicasets - ingresses verbs: - list - watch - apiGroups: - apps resources: - statefulsets - daemonsets - deployments - replicasets verbs: - list - watch - apiGroups: - batch resources: - cronjobs - jobs verbs: - list - watch - apiGroups: - autoscaling resources: - horizontalpodautoscalers verbs: - list - watch - apiGroups: - authentication.k8s.io resources: - tokenreviews verbs: - create - apiGroups: - authorization.k8s.io resources: - subjectaccessreviews verbs: - create - apiGroups: - policy resources: - poddisruptionbudgets verbs: - list - watch - apiGroups: - certificates.k8s.io resources: - certificatesigningrequests verbs: - list - watch kube-state-metrics-clusterRoleBinding.yml12345678910111213apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: kube-state-metricsroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kube-state-metricssubjects: - kind: ServiceAccount name: kube-state-metrics namespace: monitoring kube-state-metrics-role.yml123456789101112131415161718192021222324252627282930apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: kube-state-metrics namespace: monitoringrules: - apiGroups: - \"\" resources: - pods verbs: - get - apiGroups: - extensions resourceNames: - kube-state-metrics resources: - deployments verbs: - get - update - apiGroups: - apps resourceNames: - kube-state-metrics resources: - deployments verbs: - get - update kube-state-metrics-roleBinding.yml12345678910111213apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: kube-state-metrics namespace: monitoringroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: kube-state-metricssubjects: - kind: ServiceAccount name: kube-state-metrics kube-state-metrics-serviceAccount.yml123456apiVersion: v1kind: ServiceAccountmetadata: name: kube-state-metrics namespace: monitoring 12345kubectl apply -f kube-state-metrics-clusterRole.ymlkubectl apply -f kube-state-metrics-clusterRoleBinding.ymlkubectl apply -f kube-state-metrics-role.ymlkubectl apply -f kube-state-metrics-roleBinding.ymlkubectl apply -f kube-state-metrics-serviceAccount.yml deployment 和 service kube-state-metrics 会提供两个指标页面，一个是暴露集群内资源的，另一个是它自身的，它自身的可以选择性的关注 kube-state-metrics-deployment.yml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465apiVersion: apps/v1kind: Deploymentmetadata: labels: app: kube-state-metrics name: kube-state-metrics namespace: monitoringspec: replicas: 1 selector: matchLabels: app: kube-state-metrics template: metadata: labels: app: kube-state-metrics spec: containers: - args: - --port=10000 - --telemetry-port=10001 image: quay.io/coreos/kube-state-metrics:v1.6.0 name: kube-state-metrics resources: limits: cpu: 100m memory: 150Mi requests: cpu: 100m memory: 150Mi - command: - /pod_nanny - --container=kube-state-metrics - --cpu=100m - --extra-cpu=2m - --memory=150Mi - --extra-memory=30Mi - --threshold=5 - --deployment=kube-state-metrics env: - name: MY_POD_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.name - name: MY_POD_NAMESPACE valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.namespace image: k8s.gcr.io/addon-resizer:1.8.4 name: addon-resizer resources: limits: cpu: 50m memory: 30Mi requests: cpu: 10m memory: 30Mi nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 65534 serviceAccountName: kube-state-metrics 指定了两个启动参数，也就是两个端口，其中 10000 是暴露集群资源指标的端口，10001 就是它自身了。除了 kube-state-metrics 之外，还启动了 addon-resizer 这个容器 最后是 service 文件 kube-state-metrics-service.yml123456789101112131415161718apiVersion: v1kind: Servicemetadata: labels: k8s-app: kube-state-metrics name: kube-state-metrics namespace: monitoringspec: clusterIP: None ports: - name: http-main port: 10000 targetPort: 10000 - name: http-self port: 10001 targetPort: 10001 selector: app: kube-state-metrics 12docker pull registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4docker tag registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4 k8s.gcr.io/addon-resizer:1.8.4 12kubectl apply -f kube-state-metrics-deployment.ymlkubectl apply -f kube-state-metrics-service.yml 两个端口都暴露出来，你可以都收集或者只收集 10000 端口。如果只收集 10000，你可以只暴露一个端口，也可以两个都暴露，然后在 Prometheus 配置中过滤掉一个端口即可。 收集监控数据将上面所有的文件都 apply 之后，就可以直接配置 Prometheus 进行收集了。在此之前，你可以使用 curl 命令访问它的指标页面，看看里面都有啥： 123456kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools -n monitoring# 首先看一下健康情况curl kube-state-metrics:10000/healthz# 在看看指标 (这里有非常多指标)curl kube-state-metrics:10000/metrics 修改下prometheus-configmap.yml 文件1234567891011121314151617181920212223242526- job_name: kube-state-metrics honor_labels: true kubernetes_sd_configs: - role: endpoints namespaces: names: - monitoring scrape_interval: 30s scrape_timeout: 30s tls_config: insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_k8s_app regex: kube-state-metrics - action: keep source_labels: - __meta_kubernetes_endpoint_port_name regex: http-main metric_relabel_configs: - source_labels: - __name__ regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready) action: keep 这里是只关注匹配到的指标, 其他指标忽略(白名单) 123kubectl apply -f prometheus-configmap.yml# 该配置不用重启prometheus即可重新加载配置curl -XPOST prometheus-dev.k1s.club/-/reload 配置一个grafana首先查看一下你是否配置了storageclass1234kubectl get storageclassNAME PROVISIONER AGEnfs (default) nfs.com/nfs-ssd 248dnfs-retain nfs.com/nfs-ssd 248d k8s-StatefulSet_grafana.yml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273---apiVersion: apps/v1beta1kind: StatefulSetmetadata: name: grafana-dev namespace: monitoringspec: serviceName: \"grafana-dev\" updateStrategy: type: RollingUpdate replicas: 1 volumeClaimTemplates: - metadata: name: grafana-data annotations: volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称 spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 5Gi template: metadata: labels: app: grafana-dev spec: containers: - name: grafana-dev image: grafana/grafana ports: - containerPort: 3000 name: grafana-port resources: requests: cpu: \"50m\" limits: cpu: \"512m\" volumeMounts: - mountPath: /var/lib/grafana name: grafana-data---kind: ServiceapiVersion: v1metadata: labels: app: grafana-dev name: grafana-dev-service namespace: monitoringspec: clusterIP: None type: ClusterIP ports: - port: 3000 name: grafana-port protocol: TCP targetPort: 3000 selector: app: grafana-dev---apiVersion: extensions/v1beta1kind: Ingressmetadata: name: grafana-dev namespace: monitoringspec: rules: - host: grafana-dev.k1s.club http: paths: - path: / backend: serviceName: grafana-dev-service servicePort: 3000 通过 k8s grafana dashboard模板 监控效果如下 通过以上的经验, 如果我希望通过A集群的Prometheus 来监控 B集群, 所以一些指标的可通过token访问B api12345678910111213141516# 查看B集群的apikubectl cluster-infokubectl create serviceaccount --namespace=monitoring prometheus-devkubectl create clusterrolebinding prometheus-k8s --clusterrole=cluster-admin --serviceaccount=monitoring:prometheus-dev# 创建一个叫admin的serviceaccountkubectl -n kube-system create serviceaccount admin# 给这个admin的serviceaccount绑上cluser-admin的clusterrolekubectl -n kube-system create clusterrolebinding sa-cluster-admin --serviceaccount kube-system:admin --clusterrole cluser-admin# 查询admin的secretkubectl -n kube-system get serviceaccounts admin -o json|jq -r '.secrets[0].name'admin-token-h4zz4# 查看tokenkubectl get secret admin-token-h4zz4 -n kube-system -o json|jq -r \".data.token\"|base64 -d &gt;&gt;/etc/kubernetes/pki/admin-token-9dg92 然后在A集群的prometheus配置如下123456789101112131415161718192021222324252627282930- job_name: k8s_B-kube-state-metrics honor_labels: true kubernetes_sd_configs: - role: endpoints api_server: https://172.16.xx.xx:6443 tls_config: insecure_skip_verify: true bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg' namespaces: names: - monitoring scrape_interval: 30s scrape_timeout: 30s tls_config: insecure_skip_verify: true bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg' relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_k8s_app regex: kube-state-metrics - action: keep source_labels: - __meta_kubernetes_endpoint_port_name regex: http-main metric_relabel_configs: - source_labels: - __name__ regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed) action: keep 部署alertmanageralertmanager-configmap.yml123456789101112131415161718192021222324252627282930313233apiVersion: v1kind: ConfigMapmetadata: name: alertmanager-config namespace: monitoringdata: config.yml: |- global: # 在没有报警的情况下声明为已解决的时间 resolve_timeout: 5m # 配置邮件发送信息 smtp_smarthost: 'smtp.163.com:25' smtp_from: 'xxx@163.com' smtp_auth_username: 'xxx@163.com' smtp_auth_password: 'xxx' smtp_require_tls: false # 所有报警信息进入后的根路由，用来设置报警的分发策略 route: # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面 group_by: ['alertname', 'cluster'] # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。 group_wait: 30s # 当第一个报警发送后，等待'group_interval'时间来发送新的一组报警信息。 group_interval: 1m # 如果一个报警信息已经发送成功了，等待'repeat_interval'时间来重新发送他们 repeat_interval: 2h # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器 receiver: default receivers: - name: 'default' email_configs: - to: 'zhangzw@xxx.com' send_resolved: true alertmanager-deployment.yml12345678910111213141516171819202122232425262728293031323334353637383940414243444546apiVersion: apps/v1kind: Deploymentmetadata: name: alertmanager namespace: monitoringspec: replicas: 1 selector: matchLabels: app: alertmanager selector: matchLabels: app: alertmanager template: metadata: labels: app: alertmanager spec: containers: - name: alertmanager image: prom/alertmanager args: - \"--config.file=/etc/alertmanager/config.yml\" - \"--storage.path=/alertmanager\" ports: - name: alertmanager containerPort: 9093 volumeMounts: - name: alertmanager-cm mountPath: /etc/alertmanager volumes: - name: alertmanager-cm configMap: name: alertmanager-config---apiVersion: v1kind: Servicemetadata: name: alertmanager namespace: monitoringspec: selector: app: alertmanager ports: - port: 80 targetPort: 9093 最后配置prometheus的rule文件 prometheus-config-rulefiles.yml (修改) 这里仅针对我这里prometheus部署的时候是通过configmap挂载的rule文件 123456789101112131415161718kind: ConfigMapmetadata: name: prometheus-rulefiles namespace: monitoringapiVersion: v1data: k8s.yml: | groups: - name: cpu-load-rule rules: - alert: cpu-load-high expr: irate(container_cpu_usage_seconds_total&#123;image!=\"\"&#125;[1m]) &gt; 0.1 for: 1m labels: serverity: warning annotations: summary: \"&#123;&#123; $labels.instance &#125;&#125; container_name: &#123;&#123; $labels.container_name &#125;&#125; pod_name: &#123;&#123; $labels.pod_name &#125;&#125; , namespace: &#123;&#123; $labels.namespace&#125;&#125;\" 也贴上prometheus的StatefulSet 配置12&gt; prometheus-statefulset.yml 配置可以看到prometheus-rulefiles 这个configmap是 挂载到 /etc/prometheus/rules/ 目录&gt; prometheus-configmap.yml 配置可以看到 rule_files: - /etc/prometheus/rules/*.yml, 所以 以上prometheus-rulefiles 这个configmap 的k8s.yml就被prometheus当做rule文件了 prometheus-statefulset.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596apiVersion: apps/v1kind: StatefulSetmetadata: labels: app: prometheus prometheus: k8s name: prometheus namespace: monitoringspec: replicas: 1 volumeClaimTemplates: - metadata: name: prometheus-data annotations: volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称 spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 20Gi revisionHistoryLimit: 10 selector: matchLabels: app: prometheus prometheus: k8s serviceName: prometheus updateStrategy: type: RollingUpdate template: metadata: creationTimestamp: null labels: app: prometheus prometheus: k8s spec: serviceAccount: prometheus-k8s containers: - args: - --web.console.templates=/etc/prometheus/consoles - --web.console.libraries=/etc/prometheus/console_libraries - --config.file=/etc/prometheus/config/prometheus.yml - --storage.tsdb.path=/prometheus - --web.enable-admin-api - --storage.tsdb.retention.time=20d - --web.enable-lifecycle - --storage.tsdb.no-lockfile - --web.external-url=http://prometheus1-dev.xxx.com/ - --web.route-prefix=/ image: prom/prometheus:v2.11.1 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 6 httpGet: path: /-/healthy port: web scheme: HTTP periodSeconds: 5 successThreshold: 1 timeoutSeconds: 3 name: prometheus ports: - containerPort: 9090 name: web protocol: TCP readinessProbe: failureThreshold: 120 httpGet: path: /-/ready port: web scheme: HTTP periodSeconds: 5 successThreshold: 1 timeoutSeconds: 3 resources: requests: memory: 400Mi terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /etc/prometheus/config name: config readOnly: true - mountPath: /prometheus name: prometheus-data #subPath: prometheus-db - mountPath: /etc/prometheus/rules/ name: prometheus-rulefiles volumes: - name: config configMap: defaultMode: 420 name: prometheus - name: prometheus-rulefiles configMap: defaultMode: 420 name: prometheus-rulefiles prometheus-configmap.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110kind: ConfigMapmetadata: name: prometheus namespace: monitoringapiVersion: v1data: prometheus.yml: | global: evaluation_interval: 30s scrape_interval: 30s external_labels: prometheus: monitoring/k8s alerting: alertmanagers: - static_configs: - targets: ['alertmanager:80'] rule_files: - /etc/prometheus/rules/*.yml scrape_configs: - job_name: prometheus honor_labels: false kubernetes_sd_configs: - role: endpoints namespaces: names: - monitoring scrape_interval: 30s relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_prometheus regex: k8s - source_labels: - __meta_kubernetes_namespace target_label: namespace - source_labels: - __meta_kubernetes_service_name target_label: service - source_labels: - __meta_kubernetes_pod_name target_label: pod - source_labels: - __meta_kubernetes_service_name target_label: job replacement: - target_label: endpoint replacement: web - job_name: k8s-db-t-kube-apiserver honor_labels: false kubernetes_sd_configs: - role: endpoints namespaces: names: - default scrape_interval: 30s scheme: https tls_config: insecure_skip_verify: false ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: keep source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name] separator: ; regex: default;kubernetes;https metric_relabel_configs: - source_labels: - __name__ action: drop regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket) - job_name: k8s-db-t-pods honor_labels: true kubernetes_sd_configs: - role: node scrape_interval: 30s metrics_path: /metrics/cadvisor scheme: https tls_config: insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token - job_name: k8s-db-t-kube-state-metrics honor_labels: true kubernetes_sd_configs: - role: endpoints namespaces: names: - monitoring scrape_interval: 30s scrape_timeout: 30s tls_config: insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: keep source_labels: - __meta_kubernetes_service_label_k8s_app regex: kube-state-metrics - action: keep source_labels: - __meta_kubernetes_endpoint_port_name regex: http-main metric_relabel_configs: - source_labels: - __name__ regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed) action: keep","raw":"---\ntitle: k8s安装promethues+alertmanager+grafana\ncopyright: true\ndate: 2020-05-14 18:34:47\ntags:\n  - k8s\n  - promethues\ncategories:\n  - [k8s, prometheus]\n\n---\n本文主要是针对prometheus 简单部署 , 考虑到测试资源有限,为更精简自定义按照监控,减少多余资源占用, 也同时更了解prometheus的更多细节, 这里没有使用prometheus-operator\n<!-- more -->\n\n\n\n- 1 [K8s上部署原生的prometheus](https://juejin.im/post/5d4ac8e9f265da03e921b463)\n- 2 [prometheus-operator 方式部署](https://www.qikqiak.com/post/first-use-prometheus-operator/)\n- 3 [docker-compose快速搭建 Prometheus+Grafana监控系统](https://blog.51cto.com/msiyuetian/2369130)\n- 4 [一套prometheus监控多个k8s集群,详细讲解配置](https://jeremy-xu.oschina.io/2018/11/%E4%BD%BF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E5%A4%9Ak8s%E9%9B%86%E7%BE%A4/)\n- 5 [使用prometheus监控traefik、redis、k8s集群各节点、各节点kubelet](https://blog.csdn.net/ywq935/article/details/80847161)\n- 6 [grafana 监控模板下载](https://grafana.com/grafana/dashboards?dataSource=prometheus&search=docker&orderBy=name&direction=asc)\n\n\n---\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 搭建prometheus\n\n#### 创建ns\n```\ntee ns.yml <<- EOF\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: monitoring\nEOF\n\n\nkubectl apply -f ns.yml\n\n```\n\n#### prometheus-clusterRole.yml\n```\ntee prometheus-clusterRole.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus-k8s\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes/metrics\n    verbs:\n      - get\n  - nonResourceURLs:\n      - /metrics\n    verbs:\n      - get\nEOF\n```\n\n#### prometheus-clusterRoleBinding.yml\n```\ntee prometheus-clusterRoleBinding.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus-k8s\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus-k8s\nsubjects:\n  - kind: ServiceAccount\n    name: prometheus-k8s\n    namespace: monitoring\nEOF\n```\n\n#### prometheus-serviceAccount.yml\n```\ntee prometheus-serviceAccount.yml <<- EOF\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus-k8s\n  namespace: monitoring\nEOF\n```\n\n\n\n#### 创建角色\n```\nkubectl apply -f prometheus-clusterRole.yml\nkubectl apply -f prometheus-clusterRoleBinding.yml\nkubectl apply -f prometheus-serviceAccount.yml\n\n```\n\n> 这样我们就创建了一个 ServiceAccount，名为 prometheus-k8s，这个 ServiceAccount 不仅现在可以用来获取 kubelet 的监控指标，后续 Prometheus 也会使用这个 serviceAccount 启动。\n\n\n#### 创建完成后，会自动在生成一个 secret，里面包含了 token：\n\n```\nkubectl get secret -n monitoring\nNAME                         TYPE                                  DATA      AGE\nprometheus-k8s-token-6v9m9   kubernetes.io/service-account-token   3         13s\n```\n\n#### 获取token\n```\ntoken=$(kubectl get secret prometheus-k8s-token-6v9m9 -n monitoring -o json|jq -r '.data.token'|base64 -d)\ntoken=$(kubectl get secret prometheus-k8s-token-pl2wx -n monitoring -o json|jq -r '.data.token'|base64 -d)\n```\n\n\n\n#### 通过token查看metrics\n```\ncurl https://127.0.0.1:10250/metrics/cadvisor -k -H \"Authorization: Bearer $token\"\n```\n\n> kubelet 除了 /metrics/cadvisor 这个 url 之外，还有一个 /metrics，这是它本身的监控指标而非 pod 的\n\n\n### 查看etc指标页面\n\netcd 的指标页面的 url 也是 /metrics，但是你想要访问它需要提供证书，因为它会验证客户端证书。当然你可以在它的启动参数中通过 --listen-metrics-urls http://ip:port 让监控指标页使用 http 而非 https，这样就不用提供证书了。\netcd 虽然部署在容器中，但是由于使用了 hostNetwork，所以我们可以通过直接访问 master 的 2379 端口访问它。默认它会采用了 https，因此我们需要提供它的 peer 证书。如果 k8s 是使用 kubeadm 安装的，etcd 的证书在 /etc/kubernetes/pki/etcd/ 目录下。\n因此访问 etcd 的命令为：\ncurl https://127.0.0.1:2379/metrics --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/healthcheck-client.crt --key /etc/kubernetes/pki/etcd/healthcheck-client.key\n复制代码后面我们需要将这三个文件挂载到 Prometheus 容器中，以便它能收集 etcd 监控数据。\n\n如果你并非容器部署的etcd,请使用你的etcd端口访问\n\n\n\n\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 安装 Prometheus\n\n#### 我们先创建两个 configmap，一个是 Prometheus 的配置文件，另一个是告警的规则文件\n\n```\ntee prometheus-configmap.yml <<- EOF\napiVersion: v1\ndata:\n  prometheus.yml: |\n    global:\n      evaluation_interval: 30s\n      scrape_interval: 30s\n      external_labels:\n        prometheus: monitoring/k8s\n    rule_files:\n    - /etc/prometheus/rules/*.yml\n    scrape_configs:\n    - job_name: prometheus\n      honor_labels: false\n      kubernetes_sd_configs:\n      - role: endpoints\n        namespaces:\n          names:\n          - monitoring\n      scrape_interval: 30s\n      relabel_configs:\n      - action: keep\n        source_labels:\n        - __meta_kubernetes_service_label_prometheus\n        regex: k8s\n      - source_labels:\n        - __meta_kubernetes_endpoint_address_target_kind\n        - __meta_kubernetes_endpoint_address_target_name\n        separator: ;\n        regex: Pod;(.*)\n        replacement: ${1}\n        target_label: pod\n      - source_labels:\n        - __meta_kubernetes_namespace\n        target_label: namespace\n      - source_labels:\n        - __meta_kubernetes_service_name\n        target_label: service\n      - source_labels:\n        - __meta_kubernetes_pod_name\n        target_label: pod\n      - source_labels:\n        - __meta_kubernetes_service_name\n        target_label: job\n        replacement: ${1}\n      - target_label: endpoint\n        replacement: web\nkind: ConfigMap\nmetadata:\n  name: prometheus\n  namespace: monitoring\nEOF\n```\n\n\n> 首先看这段配置\n```\nkubernetes_sd_configs:\n- role: endpoints\n  namespaces:\n    names:\n    - monitoring\nscrape_interval: 30s\n```\n这段配置使用的是 endpoint 的方式对 Prometheus 本身进行自动发现，你可以有疑问了，为什么不直接对自身的 127.0.0.1:9090 进行采集呢？因为考虑到 Prometheus 可能会有多台，这样即使有多台，它们也都在一个 job 下面。\n\n kubernetes_sd_configs 配置可以自动发现 k8s 中 node、service、pod、endpoint、ingress，并为其添加监控, 详见:  [kubernetes_sd_configs官方文档](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config)\n\n\n\n> 再看下面这段配置\n```\n- action: keep\n  source_labels:\n    - __meta_kubernetes_service_label_prometheus\n  regex: k8s\n```\n\n表示并非所有的endpoint 都会被抓取,  这里只抓取label 是 prometheus=k8s的标签, 所以只会监控prometheus的endpoint\n\n默认不指定url 就是/metrics\n\n\n> 接着看这段配置\n```\n- source_labels:\n    - __meta_kubernetes_endpoint_address_target_kind\n    - __meta_kubernetes_endpoint_address_target_name\n  separator: ;\n  regex: Pod;(.*)\n  replacement: ${1}\n  target_label: pod\n\n```\n\n\n如果 __meta_kubernetes_endpoint_address_target_kind 的值为 Pod，__meta_kubernetes_endpoint_address_target_name 的值为 prometheus-0，在它们之间加上一个 ; 之后，它们合起来就是 Pod;prometheus-0。使用正则表达式 Pod;(.*) 对其进行匹配，那么 ${1} 就是取第一个分组，它值就是 prometheus-0，最后将这个值交给 pod 这个标签。\n因此这一段配置就是为所有采集到的监控指标增加一个 pod=prometheus-0 的标签。\n\n> 以上配置其实可以去掉, 这里prometheus=k8s的匹配条件以及唯一,这段kind和name配置去掉影响不大\n\n#### 创建configmap\n\n```\nkubectl apply -f prometheus-configmap.yml\n```\n\n\n#### Prometheus 规则文件 (后面会更新)\n```\ntee prometheus-config-rulefiles.yml <<- EOF\napiVersion: v1\ndata:\n  k8s.yml: \"\"\nkind: ConfigMap\nmetadata:\n  name: prometheus-rulefiles\n  namespace: monitoring\nEOF\n\n\nkubectl apply -f prometheus-config-rulefiles.yml\n\n```\n\n\n\n### role 和 roleBinding\n\n因为 Prometheus 会使用之前创建的 sa（serviceAccount）prometheus-k8s 运行，那么光现在 prometheus-k8s 这个 sa 的权限是没有办法查看 service 以及 endpoint 的。\n我们使用 kubernetes_sd_config 主要会使用 endpoint 进行发现，因此 prometheus-k8s 必须具备更多的权限。\n我们需要创建更多的 role，并通过 roleBinding 将这些权限绑定到 prometheus-k8s 这个 sa 上，之所以不使用 clusterRole 是为了权限最小化。\n这里会创建 prometheus-roleConfig.yml、prometheus-roleBindingConfig.yml、prometheus-roleSpecificNamespaces.yml、prometheus-roleBindingSpecificNamespaces.yml 这四个文件，它们的内容如下。\n\n\n```\ntee prometheus-roleConfig.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: prometheus-k8s-config\n  namespace: monitoring\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n    verbs:\n      - get\nEOF\n\n\ntee prometheus-roleBindingConfig.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: prometheus-k8s-config\n  namespace: monitoring\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: prometheus-k8s-config\nsubjects:\n  - kind: ServiceAccount\n    name: prometheus-k8s\n    namespace: monitoring\nEOF\n\ntee prometheus-roleSpecificNamespaces.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleList\nitems:\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: Role\n    metadata:\n      name: prometheus-k8s\n      namespace: default\n    rules:\n      - apiGroups:\n          - \"\"\n        resources:\n          - services\n          - endpoints\n          - pods\n        verbs:\n          - get\n          - list\n          - watch\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: Role\n    metadata:\n      name: prometheus-k8s\n      namespace: kube-system\n    rules:\n      - apiGroups:\n          - \"\"\n        resources:\n          - services\n          - endpoints\n          - pods\n        verbs:\n          - get\n          - list\n          - watch\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: Role\n    metadata:\n      name: prometheus-k8s\n      namespace: monitoring\n    rules:\n      - apiGroups:\n          - \"\"\n        resources:\n          - services\n          - endpoints\n          - pods\n        verbs:\n          - get\n          - list\n          - watch\nEOF\n\ntee prometheus-roleBindingSpecificNamespaces.yml <<- EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBindingList\nitems:\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: RoleBinding\n    metadata:\n      name: prometheus-k8s\n      namespace: default\n    roleRef:\n      apiGroup: rbac.authorization.k8s.io\n      kind: Role\n      name: prometheus-k8s\n    subjects:\n      - kind: ServiceAccount\n        name: prometheus-k8s\n        namespace: monitoring\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: RoleBinding\n    metadata:\n      name: prometheus-k8s\n      namespace: kube-system\n    roleRef:\n      apiGroup: rbac.authorization.k8s.io\n      kind: Role\n      name: prometheus-k8s\n    subjects:\n      - kind: ServiceAccount\n        name: prometheus-k8s\n        namespace: monitoring\n  - apiVersion: rbac.authorization.k8s.io/v1\n    kind: RoleBinding\n    metadata:\n      name: prometheus-k8s\n      namespace: monitoring\n    roleRef:\n      apiGroup: rbac.authorization.k8s.io\n      kind: Role\n      name: prometheus-k8s\n    subjects:\n      - kind: ServiceAccount\n        name: prometheus-k8s\n        namespace: monitoring\nEOF\n\n```\n上面的权限中，config 是用来读 configmap 的，后面的就是 Prometheus 用来进行 k8s 发现时必须要的权限了，最后使用 rulebinding 将这些所有的权限都绑定到 prometheus-k8s 这个 sa 上。\n\n\n```\nkubectl delete -f prometheus-roleBindingConfig.yml\nkubectl delete -f prometheus-roleBindingSpecificNamespaces.yml\nkubectl delete -f prometheus-roleConfig.yml\nkubectl delete -f prometheus-roleSpecificNamespaces.yml\n\n\nkubectl apply -f prometheus-roleBindingConfig.yml\nkubectl apply -f prometheus-roleBindingSpecificNamespaces.yml\nkubectl apply -f prometheus-roleConfig.yml\nkubectl apply -f prometheus-roleSpecificNamespaces.yml\n\n```\n\n\n#### 手动创建pv (我这里没用上, 用的是storageclass)\n```\ntee prometheus-pv.yml <<- EOF\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus\n  labels:\n    name: prometheus\nspec:\n  nfs:\n    path: /disk/k8s-nfs-data/k8s-db-t/prometheus\n    server: 172.16.xx.xx\n  accessModes: [\"ReadWriteMany\", \"ReadWriteOnce\"]\n  capacity:\n    storage: 50Gi\nEOF\n\nkubectl apply -f prometheus-pv.yml\n\n```\n\n#### 创建 service\n```\ntee prometheus-service.yml <<- EOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: monitoring\n  labels:\n    prometheus: k8s\nspec:\n  clusterIP: None\n  ports:\n    - name: web\n      port: 9090\n      protocol: TCP\n      targetPort: web\n  selector:\n    app: prometheus\n  type: ClusterIP\n\nEOF\n\nkubectl apply -f prometheus-service.yml\n```\n\n这里service定义了 app=prometheus 这样的标签选择器，因此 Prometheus 容器StatefulSet的时候必须存在这个标签。\n\n\n#### 部署 Prometheus\n```\ntee prometheus-statefulset.yml <<- EOF\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: prometheus\n    prometheus: k8s\n  name: prometheus\n  namespace: monitoring\nspec:\n  replicas: 1\n  volumeClaimTemplates:\n  - metadata:\n      name: prometheus-data\n      annotations:\n        volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 20Gi\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: prometheus\n      prometheus: k8s\n  serviceName: prometheus\n  updateStrategy:\n    type: RollingUpdate\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: prometheus\n        prometheus: k8s\n    spec:\n      serviceAccount: prometheus-k8s\n      containers:\n        - args:\n            - --web.console.templates=/etc/prometheus/consoles\n            - --web.console.libraries=/etc/prometheus/console_libraries\n            - --config.file=/etc/prometheus/config/prometheus.yml\n            - --storage.tsdb.path=/prometheus\n            - --web.enable-admin-api\n            - --storage.tsdb.retention.time=20d\n            - --web.enable-lifecycle\n            - --storage.tsdb.no-lockfile\n            - --web.external-url=http://promethes-dev.k1s.club/\n            - --web.route-prefix=/\n          image: prom/prometheus:v2.11.1\n          imagePullPolicy: IfNotPresent\n          livenessProbe:\n            failureThreshold: 6\n            httpGet:\n              path: /-/healthy\n              port: web\n              scheme: HTTP\n            periodSeconds: 5\n            successThreshold: 1\n            timeoutSeconds: 3\n          name: prometheus\n          ports:\n            - containerPort: 9090\n              name: web\n              protocol: TCP\n          readinessProbe:\n            failureThreshold: 120\n            httpGet:\n              path: /-/ready\n              port: web\n              scheme: HTTP\n            periodSeconds: 5\n            successThreshold: 1\n            timeoutSeconds: 3\n          resources:\n            requests:\n              memory: 400Mi\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n          volumeMounts:\n            - mountPath: /etc/prometheus/config\n              name: config\n              readOnly: true\n            - mountPath: /prometheus\n              name: prometheus-data\n              #subPath: prometheus-db\n            - mountPath: /etc/prometheus/rules/\n              name: prometheus-rulefiles\n            - mountPath: /etc/prometheus/secrets/etcd-client-cert\n              name: secret-etcd-client-cert\n              readOnly: true\n      volumes:\n        - name: config\n          configMap:\n            defaultMode: 420\n            name: prometheus\n        - name: prometheus-rulefiles\n          configMap:\n            defaultMode: 420\n            name: prometheus-rulefiles\n        - name: secret-etcd-client-cert\n          secret:\n            defaultMode: 420\n            secretName: etcd-client-cert\n\nEOF\n\nkubectl apply -f prometheus-statefulset.yml\n```\n\n> 注意下这里如果你并非容器安装的etcd, 则mount的secret-etcd-client-cert可能不存在, 请自行挂载正确的目录, 如果etcd是http访问, 则不需要证书挂载\n\n基础的 statfulset 相关的知识我就不多提了，说几个重点吧：\n\n1 --storage.tsdb.retention.time=20d 这个启动选项表示 Prometheus 所收集的监控数据只保留 20 天，这个值最好不要太大。如果历史数据保存很久，建议写到持久存储中，比如 VictoriaMetrics、thanos、influxdb、opentsdb 等；\n2 --web.enable-admin-api 这个启动选项表示启动管理员 api，你可以通过 api 对监控数据进行删除等；\n3 serviceAccount 它的值必须是 prometheus-k8s，不然前面的赋权操作都白干了；\n4 pod 必须存在 app: prometheus 这个标签，不然无法被前面创建的 service 选择到；\n5 挂载了两个 configmap、一个 secret 还有一个存储卷。(我这里是采用storageclass, 当然你也可以用上面的手动创建pv)\n\n\n\n#### 创建一个ingress\n\n```\ntee prometheus-ingress.yml <<- EOF\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: prometheus\n  namespace: monitoring\nspec:\n  rules:\n    - host: prometheus-dev.k1s.club\n      http:\n        paths:\n          - path: /\n            backend:\n              serviceName: prometheus\n              servicePort: 9090\n\nEOF\n\nkubectl apply -f prometheus-ingress.yml\n```\n\n至此, 我们就监控了prometheus本身\n![](assets/prometheus-01-01.png)\n\n\n\n\n\n---\n\n\n### 问题1 k8s1.10报错rbac权限错误\n> level=error ts=2020-05-11T10:00:03.091Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=\"/app/discovery/kubernetes/kubernetes.go:335: Failed to list *v1.Node: nodes is forbidden: User \\\"system:serviceaccount:monitoring:prometheus-k8s\\\" cannot list nodes at the cluster scope\"\n\n按照以下rbac增加了权限,则正常\n```\nprometheus-rbac.yml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n name: prometheus-k8s\n namespace: monitoring\n labels:\n   kubernetes.io/cluster-service: \"true\"\n   addonmanager.kubernetes.io/mode: Reconcile\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n name: prometheus-k8s\n labels:\n   kubernetes.io/cluster-service: \"true\"\n   addonmanager.kubernetes.io/mode: Reconcile\nrules:\n - apiGroups:\n     - \"\"\n   resources:\n     - nodes\n     - nodes/metrics\n     - services\n     - endpoints\n     - pods\n   verbs:\n     - get\n     - list\n     - watch\n - apiGroups:\n     - \"\"\n   resources:\n     - configmaps\n   verbs:\n     - get\n - nonResourceURLs:\n     - \"/metrics\"\n   verbs:\n     - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n name: prometheus-k8s\n labels:\n   kubernetes.io/cluster-service: \"true\"\n   addonmanager.kubernetes.io/mode: Reconcile\nroleRef:\n apiGroup: rbac.authorization.k8s.io\n kind: ClusterRole\n name: prometheus-k8s\nsubjects:\n- kind: ServiceAccount\n name: prometheus-k8s\n namespace: monitoring\n\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 监控etcd\n\n\n#### 如果是容器安装的etcd集群\n```\ntee kube-etcd-service.yml <<- EOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-etcd\n  labels:\n    k8s-app: kube-etcd\n  namespace: kube-system\nspec:\n  clusterIP: None\n  ports:\n    - name: http-metrics\n      port: 2379\n      protocol: TCP\n      targetPort: 2379\n  selector:\n    component: etcd\n  type: ClusterIP\n\nEOF\n```\n\n- 由于 etcd 处于 kube-system 名称空间，所以这里的 namespace 也应该是 kube-system；\n- 因为 etcd pod 本身会存在 component=etcd 这个标签，所以这里的选择器使用的就是这个。\n\n```\nkubectl apply -f kube-etcd-service.yml\nkubectl -n kube-system get endpoints kube-etcd\n\n```\n\n现在通过这个 endpoint 就能够访问到后面三台 etcd，现在只需要在 Prometheus 中添加对应的配置即可，配置内容如下。\n\n```\n- job_name: kube-etcd\n  honor_labels: false\n  kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n          - kube-system\n  scheme: https\n  tls_config:\n    insecure_skip_verify: false\n    ca_file: /etc/prometheus/secrets/etcd-client-cert/ca.crt\n    cert_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.crt\n    key_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.key\n  relabel_configs:\n    - action: keep\n      source_labels:\n        - __meta_kubernetes_service_label_k8s_app\n      regex: kube-etcd\n    - source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - target_label: endpoint\n      replacement: http-metrics\n  metric_relabel_configs:\n    - action: drop\n      regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*\n      source_labels:\n        - __name__\n\n```\n\n\n\n\n\n#### 我这里有一个环境是http访问的, 则直接通过http://172.16.xx.xx:2379/metrics 监控即可\n```\n- job_name: 'etcd'\n  scrape_interval: 60s\n  static_configs:\n    - targets: ['172.16.xx.xx:2379']\n  metric_relabel_configs:\n  - action: drop\n    regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*\n    source_labels:\n      - __name__\n```\n\n> 然后重新加载configmap\n```\nkubectl apply -f prometheus-configmap.yml\n\n# 该配置不用重启prometheus即可重新加载配置\ncurl -XPOST prometheus-dev.k1s.club/-/reload\n```\n\n\n\n### 监控 apiserver\n\napiserver 的监控方式更简单，因为它的 service 已经自动创建了。但你需要注意的是，它的 service 创建在 default 名称空间，名为 kubernetes。\n\n\n```\n- job_name: kube-apiserver\n  honor_labels: false\n  kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n          - default\n  scrape_interval: 30s\n  scheme: https\n  tls_config:\n    insecure_skip_verify: false\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n    - action: keep\n      source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: default;kubernetes;https\n  metric_relabel_configs:\n    - source_labels:\n        - __name__\n      action: drop\n      regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)\n```\n\n\n\n\n\n\n### 监控 pod\npod 的监控指标是 kubelet 提供的，前面也已经使用 curl 命令看到了，因此这里也是直接干。\nprometheus-operator 使用的同样是 endpoints 发现的方式，但是 kubelet 是操作系统的进程，并不是 pod，因此通过创建 service 的方式是不可能创建对应的 endpoint 的，也不知道它为啥可以做到。\n为了更通用，我们这里是通过 node 发现的方式进行的。使用 node 发现，你无法指定端口，prometheus 会自动访问发现 node 的 10250 端口。\n\n\n```\n- job_name: pods\n  honor_labels: true\n  kubernetes_sd_configs:\n  - role: node\n  scrape_interval: 30s\n  metrics_path: /metrics/cadvisor\n  scheme: https\n  tls_config:\n    insecure_skip_verify: true\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n\n```\n\n> k8s 的其他组件我就不继续监控了，包括 kubelet、controller manager、coredns 等，它们监控的手段和之前的几个组件都差不多\n\n\n### 安装 kube-state-metrics\n\n> 常见应用\n使用kube-state-metrics后的常用场景有：\n\n存在执行失败的Job:\n- kube_job_status_failed{job=\"kubernetes-service-endpoints\",k8s_app=\"kube-state-metrics\"}==1\n- 集群节点状态错误: kube_node_status_condition{condition=\"Ready\",status!=\"true\"}==1\n- 集群中存在启动失败的Pod：kube_pod_status_phase{phase=~\"Failed|Unknown\"}==1\n- 最近30分钟内有Pod容器重启: changes(kube_pod_container_status_restarts[30m])>0\n配合报警可以更好地监控集群的运行\n\n\n#### RBAC 权限\n> 因为它要访问集群内的所有资源，才能将它们的信息提供出去，因此部署它之前，先为它创建一些权限。这些权限都会绑定到一个 serviceAccount 上，然后我们用这个 sa 运行 kube-state-metrics 就行\n\n#### kube-state-metrics-clusterRole.yml\n```\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: kube-state-metrics\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - secrets\n      - nodes\n      - pods\n      - services\n      - resourcequotas\n      - replicationcontrollers\n      - limitranges\n      - persistentvolumeclaims\n      - persistentvolumes\n      - namespaces\n      - endpoints\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n    resources:\n      - daemonsets\n      - deployments\n      - replicasets\n      - ingresses\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - apps\n    resources:\n      - statefulsets\n      - daemonsets\n      - deployments\n      - replicasets\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - batch\n    resources:\n      - cronjobs\n      - jobs\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - autoscaling\n    resources:\n      - horizontalpodautoscalers\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - authentication.k8s.io\n    resources:\n      - tokenreviews\n    verbs:\n      - create\n  - apiGroups:\n      - authorization.k8s.io\n    resources:\n      - subjectaccessreviews\n    verbs:\n      - create\n  - apiGroups:\n      - policy\n    resources:\n      - poddisruptionbudgets\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - certificates.k8s.io\n    resources:\n      - certificatesigningrequests\n    verbs:\n      - list\n      - watch\n\n```\n\n\n#### kube-state-metrics-clusterRoleBinding.yml\n```\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kube-state-metrics\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kube-state-metrics\nsubjects:\n  - kind: ServiceAccount\n    name: kube-state-metrics\n    namespace: monitoring\n\n```\n\n#### kube-state-metrics-role.yml\n```\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: kube-state-metrics\n  namespace: monitoring\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - pods\n    verbs:\n      - get\n  - apiGroups:\n      - extensions\n    resourceNames:\n      - kube-state-metrics\n    resources:\n      - deployments\n    verbs:\n      - get\n      - update\n  - apiGroups:\n      - apps\n    resourceNames:\n      - kube-state-metrics\n    resources:\n      - deployments\n    verbs:\n      - get\n      - update\n\n```\n\n#### kube-state-metrics-roleBinding.yml\n```\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: kube-state-metrics\n  namespace: monitoring\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: kube-state-metrics\nsubjects:\n  - kind: ServiceAccount\n    name: kube-state-metrics\n\n```\n\n#### kube-state-metrics-serviceAccount.yml\n```\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: kube-state-metrics\n  namespace: monitoring\n\n```\n\n```\nkubectl apply -f kube-state-metrics-clusterRole.yml\nkubectl apply -f kube-state-metrics-clusterRoleBinding.yml\nkubectl apply -f kube-state-metrics-role.yml\nkubectl apply -f kube-state-metrics-roleBinding.yml\nkubectl apply -f kube-state-metrics-serviceAccount.yml\n```\n\n### deployment 和 service\n\n> kube-state-metrics 会提供两个指标页面，一个是暴露集群内资源的，另一个是它自身的，它自身的可以选择性的关注\n\n\n#### kube-state-metrics-deployment.yml\n```\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: kube-state-metrics\n  name: kube-state-metrics\n  namespace: monitoring\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kube-state-metrics\n  template:\n    metadata:\n      labels:\n        app: kube-state-metrics\n    spec:\n      containers:\n        - args:\n            - --port=10000\n            - --telemetry-port=10001\n          image: quay.io/coreos/kube-state-metrics:v1.6.0\n          name: kube-state-metrics\n          resources:\n            limits:\n              cpu: 100m\n              memory: 150Mi\n            requests:\n              cpu: 100m\n              memory: 150Mi\n        - command:\n            - /pod_nanny\n            - --container=kube-state-metrics\n            - --cpu=100m\n            - --extra-cpu=2m\n            - --memory=150Mi\n            - --extra-memory=30Mi\n            - --threshold=5\n            - --deployment=kube-state-metrics\n          env:\n            - name: MY_POD_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: MY_POD_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.namespace\n          image: k8s.gcr.io/addon-resizer:1.8.4\n          name: addon-resizer\n          resources:\n            limits:\n              cpu: 50m\n              memory: 30Mi\n            requests:\n              cpu: 10m\n              memory: 30Mi\n      nodeSelector:\n        kubernetes.io/os: linux\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 65534\n      serviceAccountName: kube-state-metrics\n```\n\n指定了两个启动参数，也就是两个端口，其中 10000 是暴露集群资源指标的端口，10001 就是它自身了。除了 kube-state-metrics 之外，还启动了 addon-resizer 这个容器\n\n\n#### 最后是 service 文件 kube-state-metrics-service.yml\n```\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    k8s-app: kube-state-metrics\n  name: kube-state-metrics\n  namespace: monitoring\nspec:\n  clusterIP: None\n  ports:\n    - name: http-main\n      port: 10000\n      targetPort: 10000\n    - name: http-self\n      port: 10001\n      targetPort: 10001\n  selector:\n    app: kube-state-metrics\n\n```\n\n```\ndocker pull registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4\ndocker tag registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4 k8s.gcr.io/addon-resizer:1.8.4\n```\n\n```\nkubectl apply -f kube-state-metrics-deployment.yml\nkubectl apply -f kube-state-metrics-service.yml\n```\n\n两个端口都暴露出来，你可以都收集或者只收集 10000 端口。如果只收集 10000，你可以只暴露一个端口，也可以两个都暴露，然后在 Prometheus 配置中过滤掉一个端口即可。\n\n#### 收集监控数据\n将上面所有的文件都 apply 之后，就可以直接配置 Prometheus 进行收集了。在此之前，你可以使用 curl 命令访问它的指标页面，看看里面都有啥：\n```\nkubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools -n monitoring\n\n# 首先看一下健康情况\ncurl kube-state-metrics:10000/healthz\n# 在看看指标 (这里有非常多指标)\ncurl kube-state-metrics:10000/metrics\n```\n\n\n\n#### 修改下prometheus-configmap.yml 文件\n```\n- job_name: kube-state-metrics\n  honor_labels: true\n  kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n          - monitoring\n  scrape_interval: 30s\n  scrape_timeout: 30s\n  tls_config:\n    insecure_skip_verify: true\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n    - action: keep\n      source_labels:\n        - __meta_kubernetes_service_label_k8s_app\n      regex: kube-state-metrics\n    - action: keep\n      source_labels:\n        - __meta_kubernetes_endpoint_port_name\n      regex: http-main\n  metric_relabel_configs:\n    - source_labels:\n        - __name__\n      regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready)\n      action: keep\n\n```\n\n> 这里是只关注匹配到的指标, 其他指标忽略(白名单)\n\n```\nkubectl apply -f prometheus-configmap.yml\n# 该配置不用重启prometheus即可重新加载配置\ncurl -XPOST prometheus-dev.k1s.club/-/reload\n```\n\n\n### 配置一个grafana\n\n#### 首先查看一下你是否配置了storageclass\n\n```\nkubectl get storageclass\nNAME            PROVISIONER       AGE\nnfs (default)   nfs.com/nfs-ssd   248d\nnfs-retain      nfs.com/nfs-ssd   248d\n```\n\n#### k8s-StatefulSet_grafana.yml\n```\n---\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  name: grafana-dev\n  namespace: monitoring\nspec:\n  serviceName: \"grafana-dev\"\n  updateStrategy:\n    type: RollingUpdate\n  replicas: 1\n  volumeClaimTemplates:\n  - metadata:\n      name: grafana-data\n      annotations:\n        volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 5Gi\n  template:\n    metadata:\n      labels:\n        app: grafana-dev\n    spec:\n      containers:\n      - name: grafana-dev\n        image: grafana/grafana\n        ports:\n        - containerPort: 3000\n          name: grafana-port\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"512m\"\n        volumeMounts:\n        - mountPath: /var/lib/grafana\n          name: grafana-data\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: grafana-dev\n  name: grafana-dev-service\n  namespace: monitoring\nspec:\n  clusterIP: None\n  type: ClusterIP\n  ports:\n    - port: 3000\n      name: grafana-port\n      protocol: TCP\n      targetPort: 3000\n  selector:\n    app: grafana-dev\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: grafana-dev\n  namespace: monitoring\nspec:\n  rules:\n    - host: grafana-dev.k1s.club\n      http:\n        paths:\n          - path: /\n            backend:\n              serviceName: grafana-dev-service\n              servicePort: 3000\n```\n\n\n#### 通过 [k8s grafana dashboard模板](https://grafana.com/grafana/dashboards/8588)  监控效果如下\n![](assets/prometheus-02-01.png)\n\n\n\n\n\n\n\n\n#### 通过以上的经验, 如果我希望通过A集群的Prometheus 来监控 B集群, 所以一些指标的可通过token访问B api\n```\n# 查看B集群的api\nkubectl cluster-info\n\nkubectl create serviceaccount --namespace=monitoring prometheus-dev\nkubectl create clusterrolebinding prometheus-k8s --clusterrole=cluster-admin --serviceaccount=monitoring:prometheus-dev\n\n# 创建一个叫admin的serviceaccount\nkubectl -n kube-system create serviceaccount admin\n# 给这个admin的serviceaccount绑上cluser-admin的clusterrole\nkubectl -n kube-system create clusterrolebinding sa-cluster-admin --serviceaccount kube-system:admin --clusterrole cluser-admin\n# 查询admin的secret\nkubectl -n kube-system get serviceaccounts admin -o json|jq -r '.secrets[0].name'\nadmin-token-h4zz4\n\n# 查看token\nkubectl get secret admin-token-h4zz4 -n kube-system -o json|jq -r \".data.token\"|base64 -d >>/etc/kubernetes/pki/admin-token-9dg92\n```\n\n\n\n#### 然后在A集群的prometheus配置如下\n```\n- job_name: k8s_B-kube-state-metrics\n   honor_labels: true\n   kubernetes_sd_configs:\n     - role: endpoints\n       api_server: https://172.16.xx.xx:6443\n       tls_config:\n         insecure_skip_verify: true\n       bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'\n       namespaces:\n         names:\n           - monitoring\n   scrape_interval: 30s\n   scrape_timeout: 30s\n   tls_config:\n     insecure_skip_verify: true\n   bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'\n   relabel_configs:\n     - action: keep\n       source_labels:\n         - __meta_kubernetes_service_label_k8s_app\n       regex: kube-state-metrics\n     - action: keep\n       source_labels:\n         - __meta_kubernetes_endpoint_port_name\n       regex: http-main\n   metric_relabel_configs:\n     - source_labels:\n         - __name__\n       regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed)\n       action: keep\n```\n\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 部署alertmanager\n\n#### alertmanager-configmap.yml\n\n```\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alertmanager-config\n  namespace: monitoring\ndata:\n  config.yml: |-\n    global:\n      # 在没有报警的情况下声明为已解决的时间\n      resolve_timeout: 5m\n      # 配置邮件发送信息\n      smtp_smarthost: 'smtp.163.com:25'\n      smtp_from: 'xxx@163.com'\n      smtp_auth_username: 'xxx@163.com'\n      smtp_auth_password: 'xxx'\n      smtp_require_tls: false\n      # 所有报警信息进入后的根路由，用来设置报警的分发策略\n    route:\n      # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面\n      group_by: ['alertname', 'cluster']\n      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。\n      group_wait: 30s\n      # 当第一个报警发送后，等待'group_interval'时间来发送新的一组报警信息。\n      group_interval: 1m\n      # 如果一个报警信息已经发送成功了，等待'repeat_interval'时间来重新发送他们\n      repeat_interval: 2h\n      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器\n      receiver: default\n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: 'zhangzw@xxx.com'\n        send_resolved: true\n```\n\n\n\n\n#### alertmanager-deployment.yml\n```\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: alertmanager\n  namespace: monitoring\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: alertmanager\n  selector:\n    matchLabels:\n      app: alertmanager\n  template:\n    metadata:\n      labels:\n        app: alertmanager\n    spec:\n      containers:\n      - name: alertmanager\n        image: prom/alertmanager\n        args:\n          - \"--config.file=/etc/alertmanager/config.yml\"\n          - \"--storage.path=/alertmanager\"\n        ports:\n        - name: alertmanager\n          containerPort: 9093\n        volumeMounts:\n        - name: alertmanager-cm\n          mountPath: /etc/alertmanager\n      volumes:\n      - name: alertmanager-cm\n        configMap:\n          name: alertmanager-config\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: alertmanager\n  namespace: monitoring\nspec:\n  selector:\n    app: alertmanager\n  ports:\n    - port: 80\n      targetPort: 9093\n```\n\n#### 最后配置prometheus的rule文件 prometheus-config-rulefiles.yml (修改)\n\n> 这里仅针对我这里prometheus部署的时候是通过configmap挂载的rule文件\n```\n\nkind: ConfigMap\nmetadata:\n  name: prometheus-rulefiles\n  namespace: monitoring\napiVersion: v1\ndata:\n  k8s.yml: |\n    groups:\n    - name: cpu-load-rule\n      rules:\n      - alert: cpu-load-high\n        expr: irate(container_cpu_usage_seconds_total{image!=\"\"}[1m]) > 0.1\n        for: 1m\n        labels:\n          serverity: warning\n        annotations:\n          summary: \"{{ $labels.instance }} container_name: {{ $labels.container_name }}  pod_name: {{ $labels.pod_name }} , namespace: {{ $labels.namespace}}\"\n\n\n```\n\n\n\n\n#### 也贴上prometheus的StatefulSet 配置\n```\n>  prometheus-statefulset.yml 配置可以看到prometheus-rulefiles 这个configmap是 挂载到 /etc/prometheus/rules/ 目录\n>  prometheus-configmap.yml 配置可以看到     rule_files: - /etc/prometheus/rules/*.yml,  所以 以上prometheus-rulefiles 这个configmap 的k8s.yml就被prometheus当做rule文件了\n```\n\n- prometheus-statefulset.yml\n```\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n labels:\n   app: prometheus\n   prometheus: k8s\n name: prometheus\n namespace: monitoring\nspec:\n replicas: 1\n volumeClaimTemplates:\n - metadata:\n     name: prometheus-data\n     annotations:\n       volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称\n   spec:\n     accessModes: [ \"ReadWriteOnce\" ]\n     resources:\n       requests:\n         storage: 20Gi\n revisionHistoryLimit: 10\n selector:\n   matchLabels:\n     app: prometheus\n     prometheus: k8s\n serviceName: prometheus\n updateStrategy:\n   type: RollingUpdate\n template:\n   metadata:\n     creationTimestamp: null\n     labels:\n       app: prometheus\n       prometheus: k8s\n   spec:\n     serviceAccount: prometheus-k8s\n     containers:\n       - args:\n           - --web.console.templates=/etc/prometheus/consoles\n           - --web.console.libraries=/etc/prometheus/console_libraries\n           - --config.file=/etc/prometheus/config/prometheus.yml\n           - --storage.tsdb.path=/prometheus\n           - --web.enable-admin-api\n           - --storage.tsdb.retention.time=20d\n           - --web.enable-lifecycle\n           - --storage.tsdb.no-lockfile\n           - --web.external-url=http://prometheus1-dev.xxx.com/\n           - --web.route-prefix=/\n         image: prom/prometheus:v2.11.1\n         imagePullPolicy: IfNotPresent\n         livenessProbe:\n           failureThreshold: 6\n           httpGet:\n             path: /-/healthy\n             port: web\n             scheme: HTTP\n           periodSeconds: 5\n           successThreshold: 1\n           timeoutSeconds: 3\n         name: prometheus\n         ports:\n           - containerPort: 9090\n             name: web\n             protocol: TCP\n         readinessProbe:\n           failureThreshold: 120\n           httpGet:\n             path: /-/ready\n             port: web\n             scheme: HTTP\n           periodSeconds: 5\n           successThreshold: 1\n           timeoutSeconds: 3\n         resources:\n           requests:\n             memory: 400Mi\n         terminationMessagePath: /dev/termination-log\n         terminationMessagePolicy: File\n         volumeMounts:\n           - mountPath: /etc/prometheus/config\n             name: config\n             readOnly: true\n           - mountPath: /prometheus\n             name: prometheus-data\n             #subPath: prometheus-db\n           - mountPath: /etc/prometheus/rules/\n             name: prometheus-rulefiles\n     volumes:\n       - name: config\n         configMap:\n           defaultMode: 420\n           name: prometheus\n       - name: prometheus-rulefiles\n         configMap:\n           defaultMode: 420\n           name: prometheus-rulefiles\n```\n\n\n\n- prometheus-configmap.yml\n```\nkind: ConfigMap\nmetadata:\n  name: prometheus\n  namespace: monitoring\napiVersion: v1\ndata:\n  prometheus.yml: |\n    global:\n      evaluation_interval: 30s\n      scrape_interval: 30s\n      external_labels:\n        prometheus: monitoring/k8s\n    alerting:\n      alertmanagers:\n      - static_configs:\n        - targets: ['alertmanager:80']\n    rule_files:\n    - /etc/prometheus/rules/*.yml\n    scrape_configs:\n    - job_name: prometheus\n      honor_labels: false\n      kubernetes_sd_configs:\n      - role: endpoints\n        namespaces:\n          names:\n          - monitoring\n      scrape_interval: 30s\n      relabel_configs:\n      - action: keep\n        source_labels:\n        - __meta_kubernetes_service_label_prometheus\n        regex: k8s\n      - source_labels:\n        - __meta_kubernetes_namespace\n        target_label: namespace\n      - source_labels:\n        - __meta_kubernetes_service_name\n        target_label: service\n      - source_labels:\n        - __meta_kubernetes_pod_name\n        target_label: pod\n      - source_labels:\n        - __meta_kubernetes_service_name\n        target_label: job\n        replacement:\n      - target_label: endpoint\n        replacement: web\n\n    - job_name: k8s-db-t-kube-apiserver\n      honor_labels: false\n      kubernetes_sd_configs:\n        - role: endpoints\n          namespaces:\n            names:\n              - default\n      scrape_interval: 30s\n      scheme: https\n      tls_config:\n        insecure_skip_verify: false\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n        - action: keep\n          source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n          separator: ;\n          regex: default;kubernetes;https\n      metric_relabel_configs:\n        - source_labels:\n            - __name__\n          action: drop\n          regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)\n\n    - job_name: k8s-db-t-pods\n      honor_labels: true\n      kubernetes_sd_configs:\n      - role: node\n      scrape_interval: 30s\n      metrics_path: /metrics/cadvisor\n      scheme: https\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n\n    - job_name: k8s-db-t-kube-state-metrics\n      honor_labels: true\n      kubernetes_sd_configs:\n        - role: endpoints\n          namespaces:\n            names:\n              - monitoring\n      scrape_interval: 30s\n      scrape_timeout: 30s\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n        - action: keep\n          source_labels:\n            - __meta_kubernetes_service_label_k8s_app\n          regex: kube-state-metrics\n        - action: keep\n          source_labels:\n            - __meta_kubernetes_endpoint_port_name\n          regex: http-main\n      metric_relabel_configs:\n        - source_labels:\n            - __name__\n          regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed)\n          action: keep\n\n\n```\n\n\n","content":"<p>本文主要是针对prometheus 简单部署 , 考虑到测试资源有限,为更精简自定义按照监控,减少多余资源占用, 也同时更了解prometheus的更多细节, 这里没有使用prometheus-operator</p>\n<a id=\"more\"></a>\n\n\n\n<ul>\n<li>1 <a href=\"https://juejin.im/post/5d4ac8e9f265da03e921b463\" target=\"_blank\" rel=\"noopener\">K8s上部署原生的prometheus</a></li>\n<li>2 <a href=\"https://www.qikqiak.com/post/first-use-prometheus-operator/\" target=\"_blank\" rel=\"noopener\">prometheus-operator 方式部署</a></li>\n<li>3 <a href=\"https://blog.51cto.com/msiyuetian/2369130\" target=\"_blank\" rel=\"noopener\">docker-compose快速搭建 Prometheus+Grafana监控系统</a></li>\n<li>4 <a href=\"https://jeremy-xu.oschina.io/2018/11/%E4%BD%BF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E5%A4%9Ak8s%E9%9B%86%E7%BE%A4/\" target=\"_blank\" rel=\"noopener\">一套prometheus监控多个k8s集群,详细讲解配置</a></li>\n<li>5 <a href=\"https://blog.csdn.net/ywq935/article/details/80847161\" target=\"_blank\" rel=\"noopener\">使用prometheus监控traefik、redis、k8s集群各节点、各节点kubelet</a></li>\n<li>6 <a href=\"https://grafana.com/grafana/dashboards?dataSource=prometheus&search=docker&orderBy=name&direction=asc\" target=\"_blank\" rel=\"noopener\">grafana 监控模板下载</a></li>\n</ul>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"搭建prometheus\"><a href=\"#搭建prometheus\" class=\"headerlink\" title=\"搭建prometheus\"></a>搭建prometheus</h3><h4 id=\"创建ns\"><a href=\"#创建ns\" class=\"headerlink\" title=\"创建ns\"></a>创建ns</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">ns.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">ns.yml</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"prometheus-clusterRole-yml\"><a href=\"#prometheus-clusterRole-yml\" class=\"headerlink\" title=\"prometheus-clusterRole.yml\"></a>prometheus-clusterRole.yml</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee prometheus-clusterRole.yml &lt;&lt;- EOF</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadat<span class=\"variable\">a:</span></span><br><span class=\"line\">  name: prometheus-k8s</span><br><span class=\"line\">rule<span class=\"variable\">s:</span></span><br><span class=\"line\">  - apiGroup<span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"string\">\"\"</span></span><br><span class=\"line\">    resource<span class=\"variable\">s:</span></span><br><span class=\"line\">      - nodes/metrics</span><br><span class=\"line\">    <span class=\"keyword\">verb</span><span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"built_in\">get</span></span><br><span class=\"line\">  - nonResourceURL<span class=\"variable\">s:</span></span><br><span class=\"line\">      - /metrics</span><br><span class=\"line\">    <span class=\"keyword\">verb</span><span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"built_in\">get</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"prometheus-clusterRoleBinding-yml\"><a href=\"#prometheus-clusterRoleBinding-yml\" class=\"headerlink\" title=\"prometheus-clusterRoleBinding.yml\"></a>prometheus-clusterRoleBinding.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-clusterRoleBinding.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"prometheus-serviceAccount-yml\"><a href=\"#prometheus-serviceAccount-yml\" class=\"headerlink\" title=\"prometheus-serviceAccount.yml\"></a>prometheus-serviceAccount.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-serviceAccount.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建角色\"><a href=\"#创建角色\" class=\"headerlink\" title=\"创建角色\"></a>创建角色</h4><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f prometheus-clusterRole.yml</span><br><span class=\"line\">kubectl apply -f prometheus-clusterRoleBinding.yml</span><br><span class=\"line\">kubectl apply -f prometheus-serviceAccount.yml</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这样我们就创建了一个 ServiceAccount，名为 prometheus-k8s，这个 ServiceAccount 不仅现在可以用来获取 kubelet 的监控指标，后续 Prometheus 也会使用这个 serviceAccount 启动。</p>\n</blockquote>\n<h4 id=\"创建完成后，会自动在生成一个-secret，里面包含了-token：\"><a href=\"#创建完成后，会自动在生成一个-secret，里面包含了-token：\" class=\"headerlink\" title=\"创建完成后，会自动在生成一个 secret，里面包含了 token：\"></a>创建完成后，会自动在生成一个 secret，里面包含了 token：</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"builtin-name\">get</span><span class=\"built_in\"> secret </span>-n monitoring</span><br><span class=\"line\">NAME                        <span class=\"built_in\"> TYPE </span>                                 DATA      AGE</span><br><span class=\"line\">prometheus-k8s-token-6v9m9   kubernetes.io/service-account-token   3         13s</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取token\"><a href=\"#获取token\" class=\"headerlink\" title=\"获取token\"></a>获取token</h4><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">token</span>=$(kubectl <span class=\"built_in\">get</span> secret prometheus-k8s-<span class=\"keyword\">token</span><span class=\"number\">-6</span>v9m9 -n monitoring -o json|jq -r <span class=\"string\">'.data.token'</span>|base64 -d)</span><br><span class=\"line\"><span class=\"keyword\">token</span>=$(kubectl <span class=\"built_in\">get</span> secret prometheus-k8s-<span class=\"keyword\">token</span>-pl2wx -n monitoring -o json|jq -r <span class=\"string\">'.data.token'</span>|base64 -d)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"通过token查看metrics\"><a href=\"#通过token查看metrics\" class=\"headerlink\" title=\"通过token查看metrics\"></a>通过token查看metrics</h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">curl</span> https://127.0.0.1:10250/metrics/cadvisor -k -H <span class=\"string\">\"Authorization: Bearer <span class=\"variable\">$token</span>\"</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>kubelet 除了 /metrics/cadvisor 这个 url 之外，还有一个 /metrics，这是它本身的监控指标而非 pod 的</p>\n</blockquote>\n<h3 id=\"查看etc指标页面\"><a href=\"#查看etc指标页面\" class=\"headerlink\" title=\"查看etc指标页面\"></a>查看etc指标页面</h3><p>etcd 的指标页面的 url 也是 /metrics，但是你想要访问它需要提供证书，因为它会验证客户端证书。当然你可以在它的启动参数中通过 –listen-metrics-urls <a href=\"http://ip:port\" target=\"_blank\" rel=\"noopener\">http://ip:port</a> 让监控指标页使用 http 而非 https，这样就不用提供证书了。<br>etcd 虽然部署在容器中，但是由于使用了 hostNetwork，所以我们可以通过直接访问 master 的 2379 端口访问它。默认它会采用了 https，因此我们需要提供它的 peer 证书。如果 k8s 是使用 kubeadm 安装的，etcd 的证书在 /etc/kubernetes/pki/etcd/ 目录下。<br>因此访问 etcd 的命令为：<br>curl <a href=\"https://127.0.0.1:2379/metrics\" target=\"_blank\" rel=\"noopener\">https://127.0.0.1:2379/metrics</a> –cacert /etc/kubernetes/pki/etcd/ca.crt –cert /etc/kubernetes/pki/etcd/healthcheck-client.crt –key /etc/kubernetes/pki/etcd/healthcheck-client.key<br>复制代码后面我们需要将这三个文件挂载到 Prometheus 容器中，以便它能收集 etcd 监控数据。</p>\n<p>如果你并非容器部署的etcd,请使用你的etcd端口访问</p>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"安装-Prometheus\"><a href=\"#安装-Prometheus\" class=\"headerlink\" title=\"安装 Prometheus\"></a>安装 Prometheus</h3><h4 id=\"我们先创建两个-configmap，一个是-Prometheus-的配置文件，另一个是告警的规则文件\"><a href=\"#我们先创建两个-configmap，一个是-Prometheus-的配置文件，另一个是告警的规则文件\" class=\"headerlink\" title=\"我们先创建两个 configmap，一个是 Prometheus 的配置文件，另一个是告警的规则文件\"></a>我们先创建两个 configmap，一个是 Prometheus 的配置文件，另一个是告警的规则文件</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-configmap.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">prometheus.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    global:</span></span><br><span class=\"line\"><span class=\"attr\">      evaluation_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      external_labels:</span></span><br><span class=\"line\"><span class=\"attr\">        prometheus:</span> <span class=\"string\">monitoring/k8s</span></span><br><span class=\"line\"><span class=\"attr\">    rule_files:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/etc/prometheus/rules/*.yml</span></span><br><span class=\"line\"><span class=\"attr\">    scrape_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - job_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">      honor_labels:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">        namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">          names:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">        source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_label_prometheus</span></span><br><span class=\"line\"><span class=\"attr\">        regex:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_endpoint_address_target_kind</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_endpoint_address_target_name</span></span><br><span class=\"line\"><span class=\"attr\">        separator:</span> <span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"attr\">        regex:</span> <span class=\"string\">Pod;(.*)</span></span><br><span class=\"line\"><span class=\"attr\">        replacement:</span> <span class=\"string\">$&#123;1&#125;</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">pod</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">namespace</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_pod_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">pod</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">job</span></span><br><span class=\"line\"><span class=\"attr\">        replacement:</span> <span class=\"string\">$&#123;1&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      - target_label:</span> <span class=\"string\">endpoint</span></span><br><span class=\"line\"><span class=\"attr\">        replacement:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>首先看这段配置</p>\n</blockquote>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubernetes_sd_configs</span>:</span><br><span class=\"line\">- <span class=\"attribute\">role</span>: endpoints</span><br><span class=\"line\">  <span class=\"attribute\">namespaces</span>:</span><br><span class=\"line\">    <span class=\"attribute\">names</span>:</span><br><span class=\"line\">    - monitoring</span><br><span class=\"line\"><span class=\"attribute\">scrape_interval</span>: <span class=\"number\">30s</span></span><br></pre></td></tr></table></figure>\n\n<p>这段配置使用的是 endpoint 的方式对 Prometheus 本身进行自动发现，你可以有疑问了，为什么不直接对自身的 127.0.0.1:9090 进行采集呢？因为考虑到 Prometheus 可能会有多台，这样即使有多台，它们也都在一个 job 下面。</p>\n<p> kubernetes_sd_configs 配置可以自动发现 k8s 中 node、service、pod、endpoint、ingress，并为其添加监控, 详见:  <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config\" target=\"_blank\" rel=\"noopener\">kubernetes_sd_configs官方文档</a></p>\n<blockquote>\n<p>再看下面这段配置</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">  source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">__meta_kubernetes_service_label_prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  regex:</span> <span class=\"string\">k8s</span></span><br></pre></td></tr></table></figure>\n\n<p>表示并非所有的endpoint 都会被抓取,  这里只抓取label 是 prometheus=k8s的标签, 所以只会监控prometheus的endpoint</p>\n<p>默认不指定url 就是/metrics</p>\n<blockquote>\n<p>接着看这段配置</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">__meta_kubernetes_endpoint_address_target_kind</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">__meta_kubernetes_endpoint_address_target_name</span></span><br><span class=\"line\"><span class=\"attr\">  separator:</span> <span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"attr\">  regex:</span> <span class=\"string\">Pod;(.*)</span></span><br><span class=\"line\"><span class=\"attr\">  replacement:</span> <span class=\"string\">$&#123;1&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  target_label:</span> <span class=\"string\">pod</span></span><br></pre></td></tr></table></figure>\n\n<p>如果 <strong>meta_kubernetes_endpoint_address_target_kind 的值为 Pod，</strong>meta_kubernetes_endpoint_address_target_name 的值为 prometheus-0，在它们之间加上一个 ; 之后，它们合起来就是 Pod;prometheus-0。使用正则表达式 Pod;(.*) 对其进行匹配，那么 ${1} 就是取第一个分组，它值就是 prometheus-0，最后将这个值交给 pod 这个标签。<br>因此这一段配置就是为所有采集到的监控指标增加一个 pod=prometheus-0 的标签。</p>\n<blockquote>\n<p>以上配置其实可以去掉, 这里prometheus=k8s的匹配条件以及唯一,这段kind和name配置去掉影响不大</p>\n</blockquote>\n<h4 id=\"创建configmap\"><a href=\"#创建configmap\" class=\"headerlink\" title=\"创建configmap\"></a>创建configmap</h4><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f prometheus-configmap.yml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Prometheus-规则文件-后面会更新\"><a href=\"#Prometheus-规则文件-后面会更新\" class=\"headerlink\" title=\"Prometheus 规则文件 (后面会更新)\"></a>Prometheus 规则文件 (后面会更新)</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee prometheus-config-rulefiles.yml &lt;&lt;- EOF</span><br><span class=\"line\"><span class=\"string\">apiVersion:</span> v1</span><br><span class=\"line\"><span class=\"string\">data:</span></span><br><span class=\"line\">  k8s.<span class=\"string\">yml:</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"string\">kind:</span> ConfigMap</span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> prometheus-rulefiles</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> monitoring</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f prometheus-config-rulefiles.yml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"role-和-roleBinding\"><a href=\"#role-和-roleBinding\" class=\"headerlink\" title=\"role 和 roleBinding\"></a>role 和 roleBinding</h3><p>因为 Prometheus 会使用之前创建的 sa（serviceAccount）prometheus-k8s 运行，那么光现在 prometheus-k8s 这个 sa 的权限是没有办法查看 service 以及 endpoint 的。<br>我们使用 kubernetes_sd_config 主要会使用 endpoint 进行发现，因此 prometheus-k8s 必须具备更多的权限。<br>我们需要创建更多的 role，并通过 roleBinding 将这些权限绑定到 prometheus-k8s 这个 sa 上，之所以不使用 clusterRole 是为了权限最小化。<br>这里会创建 prometheus-roleConfig.yml、prometheus-roleBindingConfig.yml、prometheus-roleSpecificNamespaces.yml、prometheus-roleBindingSpecificNamespaces.yml 这四个文件，它们的内容如下。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-roleConfig.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s-config</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-roleBindingConfig.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s-config</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-k8s-config</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-roleSpecificNamespaces.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleList</span></span><br><span class=\"line\"><span class=\"attr\">items:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">    rules:</span></span><br><span class=\"line\"><span class=\"attr\">      - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">services</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">pods</span></span><br><span class=\"line\"><span class=\"attr\">        verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">list</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">    rules:</span></span><br><span class=\"line\"><span class=\"attr\">      - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">services</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">pods</span></span><br><span class=\"line\"><span class=\"attr\">        verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">list</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">    rules:</span></span><br><span class=\"line\"><span class=\"attr\">      - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">services</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">pods</span></span><br><span class=\"line\"><span class=\"attr\">        verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">list</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-roleBindingSpecificNamespaces.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBindingList</span></span><br><span class=\"line\"><span class=\"attr\">items:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">    roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">      apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">      kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    subjects:</span></span><br><span class=\"line\"><span class=\"attr\">      - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">        namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">    roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">      apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">      kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    subjects:</span></span><br><span class=\"line\"><span class=\"attr\">      - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">        namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">  - apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">    kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">    roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">      apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">      kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    subjects:</span></span><br><span class=\"line\"><span class=\"attr\">      - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">        namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p>上面的权限中，config 是用来读 configmap 的，后面的就是 Prometheus 用来进行 k8s 发现时必须要的权限了，最后使用 rulebinding 将这些所有的权限都绑定到 prometheus-k8s 这个 sa 上。</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete -f prometheus-roleBindingConfig.yml</span><br><span class=\"line\">kubectl delete -f prometheus-roleBindingSpecificNamespaces.yml</span><br><span class=\"line\">kubectl delete -f prometheus-roleConfig.yml</span><br><span class=\"line\">kubectl delete -f prometheus-roleSpecificNamespaces.yml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f prometheus-roleBindingConfig.yml</span><br><span class=\"line\">kubectl apply -f prometheus-roleBindingSpecificNamespaces.yml</span><br><span class=\"line\">kubectl apply -f prometheus-roleConfig.yml</span><br><span class=\"line\">kubectl apply -f prometheus-roleSpecificNamespaces.yml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"手动创建pv-我这里没用上-用的是storageclass\"><a href=\"#手动创建pv-我这里没用上-用的是storageclass\" class=\"headerlink\" title=\"手动创建pv (我这里没用上, 用的是storageclass)\"></a>手动创建pv (我这里没用上, 用的是storageclass)</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-pv.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  nfs:</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/disk/k8s-nfs-data/k8s-db-t/prometheus</span></span><br><span class=\"line\"><span class=\"attr\">    server:</span> <span class=\"number\">172.16</span><span class=\"string\">.xx.xx</span></span><br><span class=\"line\"><span class=\"attr\">  accessModes:</span> <span class=\"string\">[\"ReadWriteMany\",</span> <span class=\"string\">\"ReadWriteOnce\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  capacity:</span></span><br><span class=\"line\"><span class=\"attr\">    storage:</span> <span class=\"number\">50</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">prometheus-pv.yml</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建-service\"><a href=\"#创建-service\" class=\"headerlink\" title=\"创建 service\"></a>创建 service</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-service.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">prometheus-service.yml</span></span><br></pre></td></tr></table></figure>\n\n<p>这里service定义了 app=prometheus 这样的标签选择器，因此 Prometheus 容器StatefulSet的时候必须存在这个标签。</p>\n<h4 id=\"部署-Prometheus\"><a href=\"#部署-Prometheus\" class=\"headerlink\" title=\"部署 Prometheus\"></a>部署 Prometheus</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-statefulset.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">    prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">prometheus-data</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span></span><br><span class=\"line\">        <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs-retain\"</span> <span class=\"comment\"># 这里配置 上面创建的 storageclass 的名称</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">20</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">      prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  updateStrategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">        prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccount:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - args:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.console.templates=/etc/prometheus/consoles</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.console.libraries=/etc/prometheus/console_libraries</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--config.file=/etc/prometheus/config/prometheus.yml</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--storage.tsdb.path=/prometheus</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.enable-admin-api</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--storage.tsdb.retention.time=20d</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.enable-lifecycle</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--storage.tsdb.no-lockfile</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.external-url=http://promethes-dev.k1s.club/</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--web.route-prefix=/</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">prom/prometheus:v2.11.1</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">          livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">            failureThreshold:</span> <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"attr\">            httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">              path:</span> <span class=\"string\">/-/healthy</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">              scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">            periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"attr\">            successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">            timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          readinessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">            failureThreshold:</span> <span class=\"number\">120</span></span><br><span class=\"line\"><span class=\"attr\">            httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">              path:</span> <span class=\"string\">/-/ready</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">              scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">            periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"attr\">            successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">            timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              memory:</span> <span class=\"number\">400</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">          terminationMessagePath:</span> <span class=\"string\">/dev/termination-log</span></span><br><span class=\"line\"><span class=\"attr\">          terminationMessagePolicy:</span> <span class=\"string\">File</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - mountPath:</span> <span class=\"string\">/etc/prometheus/config</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">config</span></span><br><span class=\"line\"><span class=\"attr\">              readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">            - mountPath:</span> <span class=\"string\">/prometheus</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">prometheus-data</span></span><br><span class=\"line\">              <span class=\"comment\">#subPath: prometheus-db</span></span><br><span class=\"line\"><span class=\"attr\">            - mountPath:</span> <span class=\"string\">/etc/prometheus/rules/</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">            - mountPath:</span> <span class=\"string\">/etc/prometheus/secrets/etcd-client-cert</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">secret-etcd-client-cert</span></span><br><span class=\"line\"><span class=\"attr\">              readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">config</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">secret-etcd-client-cert</span></span><br><span class=\"line\"><span class=\"attr\">          secret:</span></span><br><span class=\"line\"><span class=\"attr\">            defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">            secretName:</span> <span class=\"string\">etcd-client-cert</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">prometheus-statefulset.yml</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意下这里如果你并非容器安装的etcd, 则mount的secret-etcd-client-cert可能不存在, 请自行挂载正确的目录, 如果etcd是http访问, 则不需要证书挂载</p>\n</blockquote>\n<p>基础的 statfulset 相关的知识我就不多提了，说几个重点吧：</p>\n<p>1 –storage.tsdb.retention.time=20d 这个启动选项表示 Prometheus 所收集的监控数据只保留 20 天，这个值最好不要太大。如果历史数据保存很久，建议写到持久存储中，比如 VictoriaMetrics、thanos、influxdb、opentsdb 等；<br>2 –web.enable-admin-api 这个启动选项表示启动管理员 api，你可以通过 api 对监控数据进行删除等；<br>3 serviceAccount 它的值必须是 prometheus-k8s，不然前面的赋权操作都白干了；<br>4 pod 必须存在 app: prometheus 这个标签，不然无法被前面创建的 service 选择到；<br>5 挂载了两个 configmap、一个 secret 还有一个存储卷。(我这里是采用storageclass, 当然你也可以用上面的手动创建pv)</p>\n<h4 id=\"创建一个ingress\"><a href=\"#创建一个ingress\" class=\"headerlink\" title=\"创建一个ingress\"></a>创建一个ingress</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">prometheus-ingress.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">prometheus-dev.k1s.club</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">          - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">            backend:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceName:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">              servicePort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">prometheus-ingress.yml</span></span><br></pre></td></tr></table></figure>\n\n<p>至此, 我们就监控了prometheus本身<br><img src=\"assets/prometheus-01-01.png\" alt></p>\n<hr>\n<h3 id=\"问题1-k8s1-10报错rbac权限错误\"><a href=\"#问题1-k8s1-10报错rbac权限错误\" class=\"headerlink\" title=\"问题1 k8s1.10报错rbac权限错误\"></a>问题1 k8s1.10报错rbac权限错误</h3><blockquote>\n<p>level=error ts=2020-05-11T10:00:03.091Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=”/app/discovery/kubernetes/kubernetes.go:335: Failed to list *v1.Node: nodes is forbidden: User &quot;system:serviceaccount:monitoring:prometheus-k8s&quot; cannot list nodes at the cluster scope”</p>\n</blockquote>\n<p>按照以下rbac增加了权限,则正常</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">prometheus-rbac.yml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\">   <span class=\"string\">kubernetes.io/cluster-service:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\">   <span class=\"string\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\">   <span class=\"string\">kubernetes.io/cluster-service:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\">   <span class=\"string\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\"> - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">   resources:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">nodes</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">nodes/metrics</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">services</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">pods</span></span><br><span class=\"line\"><span class=\"attr\">   verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">list</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"attr\"> - apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">   resources:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\"><span class=\"attr\">   verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"attr\"> - nonResourceURLs:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">\"/metrics\"</span></span><br><span class=\"line\"><span class=\"attr\">   verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">get</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\">   <span class=\"string\">kubernetes.io/cluster-service:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\">   <span class=\"string\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\"> apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\"> kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">- kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">monitoring</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"监控etcd\"><a href=\"#监控etcd\" class=\"headerlink\" title=\"监控etcd\"></a>监控etcd</h3><h4 id=\"如果是容器安装的etcd集群\"><a href=\"#如果是容器安装的etcd集群\" class=\"headerlink\" title=\"如果是容器安装的etcd集群\"></a>如果是容器安装的etcd集群</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">kube-etcd-service.yml</span> <span class=\"string\">&lt;&lt;-</span> <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">kube-etcd</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    k8s-app:</span> <span class=\"string\">kube-etcd</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">http-metrics</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">2379</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">2379</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    component:</span> <span class=\"string\">etcd</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>由于 etcd 处于 kube-system 名称空间，所以这里的 namespace 也应该是 kube-system；</li>\n<li>因为 etcd pod 本身会存在 component=etcd 这个标签，所以这里的选择器使用的就是这个。</li>\n</ul>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f kube-etcd-service.yml</span><br><span class=\"line\">kubectl -n kube-<span class=\"built_in\">system</span> <span class=\"built_in\">get</span> endpoints kube-etcd</span><br></pre></td></tr></table></figure>\n\n<p>现在通过这个 endpoint 就能够访问到后面三台 etcd，现在只需要在 Prometheus 中添加对应的配置即可，配置内容如下。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">kube-etcd</span></span><br><span class=\"line\"><span class=\"attr\">  honor_labels:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">  kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">      namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">        names:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">  scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">    insecure_skip_verify:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">    ca_file:</span> <span class=\"string\">/etc/prometheus/secrets/etcd-client-cert/ca.crt</span></span><br><span class=\"line\"><span class=\"attr\">    cert_file:</span> <span class=\"string\">/etc/prometheus/secrets/etcd-client-cert/healthcheck-client.crt</span></span><br><span class=\"line\"><span class=\"attr\">    key_file:</span> <span class=\"string\">/etc/prometheus/secrets/etcd-client-cert/healthcheck-client.key</span></span><br><span class=\"line\"><span class=\"attr\">  relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">      source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_label_k8s_app</span></span><br><span class=\"line\"><span class=\"attr\">      regex:</span> <span class=\"string\">kube-etcd</span></span><br><span class=\"line\"><span class=\"attr\">    - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"attr\">      target_label:</span> <span class=\"string\">namespace</span></span><br><span class=\"line\"><span class=\"attr\">    - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_name</span></span><br><span class=\"line\"><span class=\"attr\">      target_label:</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\">    - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_pod_name</span></span><br><span class=\"line\"><span class=\"attr\">      target_label:</span> <span class=\"string\">pod</span></span><br><span class=\"line\"><span class=\"attr\">    - target_label:</span> <span class=\"string\">endpoint</span></span><br><span class=\"line\"><span class=\"attr\">      replacement:</span> <span class=\"string\">http-metrics</span></span><br><span class=\"line\"><span class=\"attr\">  metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - action:</span> <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">      regex:</span> <span class=\"string\">(etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*</span></span><br><span class=\"line\"><span class=\"attr\">      source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__name__</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"我这里有一个环境是http访问的-则直接通过http-172-16-xx-xx-2379-metrics-监控即可\"><a href=\"#我这里有一个环境是http访问的-则直接通过http-172-16-xx-xx-2379-metrics-监控即可\" class=\"headerlink\" title=\"我这里有一个环境是http访问的, 则直接通过http://172.16.xx.xx:2379/metrics 监控即可\"></a>我这里有一个环境是http访问的, 则直接通过<a href=\"http://172.16.xx.xx:2379/metrics\" target=\"_blank\" rel=\"noopener\">http://172.16.xx.xx:2379/metrics</a> 监控即可</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'etcd'</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">60</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - targets:</span> <span class=\"string\">['172.16.xx.xx:2379']</span></span><br><span class=\"line\"><span class=\"attr\">  metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - action:</span> <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span> <span class=\"string\">(etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*</span></span><br><span class=\"line\"><span class=\"attr\">    source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">__name__</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>然后重新加载configmap</p>\n</blockquote>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f prometheus-configmap.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 该配置不用重启prometheus即可重新加载配置</span></span><br><span class=\"line\">curl -XPOST prometheus-dev.k1s.club<span class=\"regexp\">/-/</span>reload</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"监控-apiserver\"><a href=\"#监控-apiserver\" class=\"headerlink\" title=\"监控 apiserver\"></a>监控 apiserver</h3><p>apiserver 的监控方式更简单，因为它的 service 已经自动创建了。但你需要注意的是，它的 service 创建在 default 名称空间，名为 kubernetes。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">kube-apiserver</span></span><br><span class=\"line\"><span class=\"attr\">  honor_labels:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">  kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">      namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">        names:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">    insecure_skip_verify:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">    ca_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"attr\">  bearer_token_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"attr\">  relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">      source_labels:</span> <span class=\"string\">[__meta_kubernetes_namespace,</span> <span class=\"string\">__meta_kubernetes_service_name,</span> <span class=\"string\">__meta_kubernetes_endpoint_port_name]</span></span><br><span class=\"line\"><span class=\"attr\">      separator:</span> <span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"attr\">      regex:</span> <span class=\"string\">default;kubernetes;https</span></span><br><span class=\"line\"><span class=\"attr\">  metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__name__</span></span><br><span class=\"line\"><span class=\"attr\">      action:</span> <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">      regex:</span> <span class=\"string\">(apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"监控-pod\"><a href=\"#监控-pod\" class=\"headerlink\" title=\"监控 pod\"></a>监控 pod</h3><p>pod 的监控指标是 kubelet 提供的，前面也已经使用 curl 命令看到了，因此这里也是直接干。<br>prometheus-operator 使用的同样是 endpoints 发现的方式，但是 kubelet 是操作系统的进程，并不是 pod，因此通过创建 service 的方式是不可能创建对应的 endpoint 的，也不知道它为啥可以做到。<br>为了更通用，我们这里是通过 node 发现的方式进行的。使用 node 发现，你无法指定端口，prometheus 会自动访问发现 node 的 10250 端口。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">pods</span></span><br><span class=\"line\"><span class=\"attr\">  honor_labels:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - role:</span> <span class=\"string\">node</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">/metrics/cadvisor</span></span><br><span class=\"line\"><span class=\"attr\">  scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">    insecure_skip_verify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  bearer_token_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>k8s 的其他组件我就不继续监控了，包括 kubelet、controller manager、coredns 等，它们监控的手段和之前的几个组件都差不多</p>\n</blockquote>\n<h3 id=\"安装-kube-state-metrics\"><a href=\"#安装-kube-state-metrics\" class=\"headerlink\" title=\"安装 kube-state-metrics\"></a>安装 kube-state-metrics</h3><blockquote>\n<p>常见应用<br>使用kube-state-metrics后的常用场景有：</p>\n</blockquote>\n<p>存在执行失败的Job:</p>\n<ul>\n<li>kube_job_status_failed{job=”kubernetes-service-endpoints”,k8s_app=”kube-state-metrics”}==1</li>\n<li>集群节点状态错误: kube_node_status_condition{condition=”Ready”,status!=”true”}==1</li>\n<li>集群中存在启动失败的Pod：kube_pod_status_phase{phase=~”Failed|Unknown”}==1</li>\n<li>最近30分钟内有Pod容器重启: changes(kube_pod_container_status_restarts[30m])&gt;0<br>配合报警可以更好地监控集群的运行</li>\n</ul>\n<h4 id=\"RBAC-权限\"><a href=\"#RBAC-权限\" class=\"headerlink\" title=\"RBAC 权限\"></a>RBAC 权限</h4><blockquote>\n<p>因为它要访问集群内的所有资源，才能将它们的信息提供出去，因此部署它之前，先为它创建一些权限。这些权限都会绑定到一个 serviceAccount 上，然后我们用这个 sa 运行 kube-state-metrics 就行</p>\n</blockquote>\n<h4 id=\"kube-state-metrics-clusterRole-yml\"><a href=\"#kube-state-metrics-clusterRole-yml\" class=\"headerlink\" title=\"kube-state-metrics-clusterRole.yml\"></a>kube-state-metrics-clusterRole.yml</h4><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  -<span class=\"ruby\"> <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">\"\"</span></span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - configmaps</span></span><br><span class=\"line\"><span class=\"ruby\">      - secrets</span></span><br><span class=\"line\"><span class=\"ruby\">      - nodes</span></span><br><span class=\"line\"><span class=\"ruby\">      - pods</span></span><br><span class=\"line\"><span class=\"ruby\">      - services</span></span><br><span class=\"line\"><span class=\"ruby\">      - resourcequotas</span></span><br><span class=\"line\"><span class=\"ruby\">      - replicationcontrollers</span></span><br><span class=\"line\"><span class=\"ruby\">      - limitranges</span></span><br><span class=\"line\"><span class=\"ruby\">      - persistentvolumeclaims</span></span><br><span class=\"line\"><span class=\"ruby\">      - persistentvolumes</span></span><br><span class=\"line\"><span class=\"ruby\">      - namespaces</span></span><br><span class=\"line\"><span class=\"ruby\">      - endpoints</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - extensions</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - daemonsets</span></span><br><span class=\"line\"><span class=\"ruby\">      - deployments</span></span><br><span class=\"line\"><span class=\"ruby\">      - replicasets</span></span><br><span class=\"line\"><span class=\"ruby\">      - ingresses</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - apps</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - statefulsets</span></span><br><span class=\"line\"><span class=\"ruby\">      - daemonsets</span></span><br><span class=\"line\"><span class=\"ruby\">      - deployments</span></span><br><span class=\"line\"><span class=\"ruby\">      - replicasets</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - batch</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - cronjobs</span></span><br><span class=\"line\"><span class=\"ruby\">      - jobs</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - autoscaling</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - horizontalpodautoscalers</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - authentication.k8s.io</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - tokenreviews</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - create</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - subjectaccessreviews</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - create</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - policy</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - poddisruptionbudgets</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br><span class=\"line\"><span class=\"ruby\">  - <span class=\"symbol\">apiGroups:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - certificates.k8s.io</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">resources:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - certificatesigningrequests</span></span><br><span class=\"line\"><span class=\"ruby\">    <span class=\"symbol\">verbs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - list</span></span><br><span class=\"line\"><span class=\"ruby\">      - watch</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"kube-state-metrics-clusterRoleBinding-yml\"><a href=\"#kube-state-metrics-clusterRoleBinding-yml\" class=\"headerlink\" title=\"kube-state-metrics-clusterRoleBinding.yml\"></a>kube-state-metrics-clusterRoleBinding.yml</h4><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span>: rbac.authorization.k8s.io/v1</span><br><span class=\"line\"><span class=\"attribute\">kind</span>: ClusterRoleBinding</span><br><span class=\"line\"><span class=\"attribute\">metadata</span>:</span><br><span class=\"line\">  <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\"><span class=\"attribute\">roleRef</span>:</span><br><span class=\"line\">  <span class=\"attribute\">apiGroup</span>: rbac.authorization.k8s.io</span><br><span class=\"line\">  <span class=\"attribute\">kind</span>: ClusterRole</span><br><span class=\"line\">  <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\"><span class=\"attribute\">subjects</span>:</span><br><span class=\"line\">  - <span class=\"attribute\">kind</span>: ServiceAccount</span><br><span class=\"line\">    <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\">    <span class=\"attribute\">namespace</span>: monitoring</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"kube-state-metrics-role-yml\"><a href=\"#kube-state-metrics-role-yml\" class=\"headerlink\" title=\"kube-state-metrics-role.yml\"></a>kube-state-metrics-role.yml</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: Role</span><br><span class=\"line\">metadat<span class=\"variable\">a:</span></span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">rule<span class=\"variable\">s:</span></span><br><span class=\"line\">  - apiGroup<span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"string\">\"\"</span></span><br><span class=\"line\">    resource<span class=\"variable\">s:</span></span><br><span class=\"line\">      - pods</span><br><span class=\"line\">    <span class=\"keyword\">verb</span><span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"built_in\">get</span></span><br><span class=\"line\">  - apiGroup<span class=\"variable\">s:</span></span><br><span class=\"line\">      - extensions</span><br><span class=\"line\">    resourceName<span class=\"variable\">s:</span></span><br><span class=\"line\">      - kube-state-metrics</span><br><span class=\"line\">    resource<span class=\"variable\">s:</span></span><br><span class=\"line\">      - deployments</span><br><span class=\"line\">    <span class=\"keyword\">verb</span><span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"built_in\">get</span></span><br><span class=\"line\">      - <span class=\"keyword\">update</span></span><br><span class=\"line\">  - apiGroup<span class=\"variable\">s:</span></span><br><span class=\"line\">      - apps</span><br><span class=\"line\">    resourceName<span class=\"variable\">s:</span></span><br><span class=\"line\">      - kube-state-metrics</span><br><span class=\"line\">    resource<span class=\"variable\">s:</span></span><br><span class=\"line\">      - deployments</span><br><span class=\"line\">    <span class=\"keyword\">verb</span><span class=\"variable\">s:</span></span><br><span class=\"line\">      - <span class=\"built_in\">get</span></span><br><span class=\"line\">      - <span class=\"keyword\">update</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"kube-state-metrics-roleBinding-yml\"><a href=\"#kube-state-metrics-roleBinding-yml\" class=\"headerlink\" title=\"kube-state-metrics-roleBinding.yml\"></a>kube-state-metrics-roleBinding.yml</h4><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span>: rbac.authorization.k8s.io/v1</span><br><span class=\"line\"><span class=\"attribute\">kind</span>: RoleBinding</span><br><span class=\"line\"><span class=\"attribute\">metadata</span>:</span><br><span class=\"line\">  <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\">  <span class=\"attribute\">namespace</span>: monitoring</span><br><span class=\"line\"><span class=\"attribute\">roleRef</span>:</span><br><span class=\"line\">  <span class=\"attribute\">apiGroup</span>: rbac.authorization.k8s.io</span><br><span class=\"line\">  <span class=\"attribute\">kind</span>: Role</span><br><span class=\"line\">  <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\"><span class=\"attribute\">subjects</span>:</span><br><span class=\"line\">  - <span class=\"attribute\">kind</span>: ServiceAccount</span><br><span class=\"line\">    <span class=\"attribute\">name</span>: kube-state-metrics</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"kube-state-metrics-serviceAccount-yml\"><a href=\"#kube-state-metrics-serviceAccount-yml\" class=\"headerlink\" title=\"kube-state-metrics-serviceAccount.yml\"></a>kube-state-metrics-serviceAccount.yml</h4><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">apiVersion:</span> v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> ServiceAccount</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> kube-state-metrics</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> monitoring</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kube-state-metrics-clusterRole.yml</span><br><span class=\"line\">kubectl apply -f kube-state-metrics-clusterRoleBinding.yml</span><br><span class=\"line\">kubectl apply -f kube-state-metrics-role.yml</span><br><span class=\"line\">kubectl apply -f kube-state-metrics-roleBinding.yml</span><br><span class=\"line\">kubectl apply -f kube-state-metrics-serviceAccount.yml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"deployment-和-service\"><a href=\"#deployment-和-service\" class=\"headerlink\" title=\"deployment 和 service\"></a>deployment 和 service</h3><blockquote>\n<p>kube-state-metrics 会提供两个指标页面，一个是暴露集群内资源的，另一个是它自身的，它自身的可以选择性的关注</p>\n</blockquote>\n<h4 id=\"kube-state-metrics-deployment-yml\"><a href=\"#kube-state-metrics-deployment-yml\" class=\"headerlink\" title=\"kube-state-metrics-deployment.yml\"></a>kube-state-metrics-deployment.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - args:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--port=10000</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--telemetry-port=10001</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">quay.io/coreos/kube-state-metrics:v1.6.0</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"number\">100</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">              memory:</span> <span class=\"number\">150</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"number\">100</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">              memory:</span> <span class=\"number\">150</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">        - command:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">/pod_nanny</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--container=kube-state-metrics</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--cpu=100m</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--extra-cpu=2m</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--memory=150Mi</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--extra-memory=30Mi</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--threshold=5</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"bullet\">--deployment=kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">MY_POD_NAME</span></span><br><span class=\"line\"><span class=\"attr\">              valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">                fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">                  apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">                  fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">MY_POD_NAMESPACE</span></span><br><span class=\"line\"><span class=\"attr\">              valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">                fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">                  apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">                  fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">k8s.gcr.io/addon-resizer:1.8.4</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">addon-resizer</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"number\">50</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">              memory:</span> <span class=\"number\">30</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"number\">10</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">              memory:</span> <span class=\"number\">30</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">      nodeSelector:</span></span><br><span class=\"line\">        <span class=\"string\">kubernetes.io/os:</span> <span class=\"string\">linux</span></span><br><span class=\"line\"><span class=\"attr\">      securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">        runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">        runAsUser:</span> <span class=\"number\">65534</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccountName:</span> <span class=\"string\">kube-state-metrics</span></span><br></pre></td></tr></table></figure>\n\n<p>指定了两个启动参数，也就是两个端口，其中 10000 是暴露集群资源指标的端口，10001 就是它自身了。除了 kube-state-metrics 之外，还启动了 addon-resizer 这个容器</p>\n<h4 id=\"最后是-service-文件-kube-state-metrics-service-yml\"><a href=\"#最后是-service-文件-kube-state-metrics-service-yml\" class=\"headerlink\" title=\"最后是 service 文件 kube-state-metrics-service.yml\"></a>最后是 service 文件 kube-state-metrics-service.yml</h4><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">apiVersion</span>: v1</span><br><span class=\"line\"><span class=\"attribute\">kind</span>: Service</span><br><span class=\"line\"><span class=\"attribute\">metadata</span>:</span><br><span class=\"line\">  <span class=\"attribute\">labels</span>:</span><br><span class=\"line\">    <span class=\"attribute\">k8s-app</span>: kube-state-metrics</span><br><span class=\"line\">  <span class=\"attribute\">name</span>: kube-state-metrics</span><br><span class=\"line\">  <span class=\"attribute\">namespace</span>: monitoring</span><br><span class=\"line\"><span class=\"attribute\">spec</span>:</span><br><span class=\"line\">  <span class=\"attribute\">clusterIP</span>: None</span><br><span class=\"line\">  <span class=\"attribute\">ports</span>:</span><br><span class=\"line\">    - <span class=\"attribute\">name</span>: http-main</span><br><span class=\"line\">      <span class=\"attribute\">port</span>: <span class=\"number\">10000</span></span><br><span class=\"line\">      <span class=\"attribute\">targetPort</span>: <span class=\"number\">10000</span></span><br><span class=\"line\">    - <span class=\"attribute\">name</span>: http-self</span><br><span class=\"line\">      <span class=\"attribute\">port</span>: <span class=\"number\">10001</span></span><br><span class=\"line\">      <span class=\"attribute\">targetPort</span>: <span class=\"number\">10001</span></span><br><span class=\"line\">  <span class=\"attribute\">selector</span>:</span><br><span class=\"line\">    <span class=\"attribute\">app</span>: kube-state-metrics</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull registry<span class=\"selector-class\">.cn-beijing</span><span class=\"selector-class\">.aliyuncs</span><span class=\"selector-class\">.com</span>/minminmsn/addon-resizer:<span class=\"number\">1.8</span>.<span class=\"number\">4</span></span><br><span class=\"line\">docker tag registry<span class=\"selector-class\">.cn-beijing</span><span class=\"selector-class\">.aliyuncs</span><span class=\"selector-class\">.com</span>/minminmsn/addon-resizer:<span class=\"number\">1.8</span>.<span class=\"number\">4</span> k8s<span class=\"selector-class\">.gcr</span><span class=\"selector-class\">.io</span>/addon-resizer:<span class=\"number\">1.8</span>.<span class=\"number\">4</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f kube-state-metrics-deployment.yml</span><br><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f kube-state-metrics-service.yml</span><br></pre></td></tr></table></figure>\n\n<p>两个端口都暴露出来，你可以都收集或者只收集 10000 端口。如果只收集 10000，你可以只暴露一个端口，也可以两个都暴露，然后在 Prometheus 配置中过滤掉一个端口即可。</p>\n<h4 id=\"收集监控数据\"><a href=\"#收集监控数据\" class=\"headerlink\" title=\"收集监控数据\"></a>收集监控数据</h4><p>将上面所有的文件都 apply 之后，就可以直接配置 Prometheus 进行收集了。在此之前，你可以使用 curl 命令访问它的指标页面，看看里面都有啥：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"builtin-name\">run</span> -it --rm <span class=\"attribute\">--restart</span>=Never <span class=\"attribute\">--image</span>=infoblox/dnstools:latest dnstools -n monitoring</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 首先看一下健康情况</span></span><br><span class=\"line\">curl kube-state-metrics:10000/healthz</span><br><span class=\"line\"><span class=\"comment\"># 在看看指标 (这里有非常多指标)</span></span><br><span class=\"line\">curl kube-state-metrics:10000/metrics</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改下prometheus-configmap-yml-文件\"><a href=\"#修改下prometheus-configmap-yml-文件\" class=\"headerlink\" title=\"修改下prometheus-configmap.yml 文件\"></a>修改下prometheus-configmap.yml 文件</h4><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- job_name: kube-state-metrics</span><br><span class=\"line\">  honor_labels: true</span><br><span class=\"line\">  kubernetes_sd_configs:</span><br><span class=\"line\">    - role: endpoints</span><br><span class=\"line\">      namespaces:</span><br><span class=\"line\">        names:</span><br><span class=\"line\">          - monitoring</span><br><span class=\"line\">  scrape_interval: <span class=\"number\">30</span>s</span><br><span class=\"line\">  scrape_timeout: <span class=\"number\">30</span>s</span><br><span class=\"line\">  tls_config:</span><br><span class=\"line\">    insecure_skip_verify: true</span><br><span class=\"line\">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">  relabel_configs:</span><br><span class=\"line\">    - action: keep</span><br><span class=\"line\">      source_labels:</span><br><span class=\"line\">        - __meta_kubernetes_service_label_k8s_app</span><br><span class=\"line\">      regex: kube-state-metrics</span><br><span class=\"line\">    - action: keep</span><br><span class=\"line\">      source_labels:</span><br><span class=\"line\">        - __meta_kubernetes_endpoint_port_name</span><br><span class=\"line\">      regex: http-main</span><br><span class=\"line\">  metric_relabel_configs:</span><br><span class=\"line\">    - source_labels:</span><br><span class=\"line\">        - __name__</span><br><span class=\"line\">      regex: (kube_daemonset_status_number_ready|<span class=\"type\">kube_daemonset_status_number_unavailable</span>|<span class=\"type\">kube_deployment_status_replicas_unavailable</span>|<span class=\"type\">kube_deployment_spec_paused</span>|<span class=\"type\">kube_deployment_spec_strategy_rollingupdate_max_surge</span>|<span class=\"type\">kube_deployment_spec_strategy_rollingupdate_max_unavailable</span>|<span class=\"type\">kube_endpoint_address_available</span>|<span class=\"type\">kube_endpoint_address_not_ready</span>|<span class=\"type\">kube_node_info</span>|<span class=\"type\">kube_node_spec_unschedulable</span>|<span class=\"type\">kube_node_status_condition</span>|<span class=\"type\">kube_node_status_capacity</span>|<span class=\"type\">kube_node_status_capacity</span>|<span class=\"type\">kube_node_status_allocatable</span>|<span class=\"type\">kube_persistentvolumeclaim_info</span>|<span class=\"type\">kube_persistentvolumeclaim_status_phase</span>|<span class=\"type\">kube_persistentvolumeclaim_resource_requests_storage_bytes</span>|<span class=\"type\">kube_persistentvolume_status_phase</span>|<span class=\"type\">kube_persistentvolume_info</span>|<span class=\"type\">kube_persistentvolume_capacity_bytes</span>|<span class=\"type\">kube_pod_info</span>|<span class=\"type\">kube_pod_status_phase</span>|<span class=\"type\">kube_pod_status_ready</span>|<span class=\"type\">kube_pod_container_info</span>|<span class=\"type\">kube_pod_container_status_waiting</span>|<span class=\"type\">kube_pod_container_status_waiting_reason</span>|<span class=\"type\">kube_pod_container_status_running</span>|<span class=\"type\">kube_pod_container_status_terminated_reason</span>|<span class=\"type\">kube_pod_container_status_last_terminated_reason</span>|<span class=\"type\">kube_pod_container_status_restarts_total</span>|<span class=\"type\">kube_pod_container_resource_limits</span>|<span class=\"type\">kube_service_info</span>|<span class=\"type\">kube_statefulset_status_replicas_current</span>|<span class=\"type\">kube_statefulset_status_replicas_ready</span>)</span><br><span class=\"line\">      action: keep</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里是只关注匹配到的指标, 其他指标忽略(白名单)</p>\n</blockquote>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f prometheus-configmap.yml</span><br><span class=\"line\"><span class=\"comment\"># 该配置不用重启prometheus即可重新加载配置</span></span><br><span class=\"line\">curl -XPOST prometheus-dev.k1s.club<span class=\"regexp\">/-/</span>reload</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置一个grafana\"><a href=\"#配置一个grafana\" class=\"headerlink\" title=\"配置一个grafana\"></a>配置一个grafana</h3><h4 id=\"首先查看一下你是否配置了storageclass\"><a href=\"#首先查看一下你是否配置了storageclass\" class=\"headerlink\" title=\"首先查看一下你是否配置了storageclass\"></a>首先查看一下你是否配置了storageclass</h4><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> storageclass</span><br><span class=\"line\">NAME            PROVISIONER       AGE</span><br><span class=\"line\"><span class=\"built_in\">nfs</span> (<span class=\"keyword\">default</span>)   <span class=\"built_in\">nfs</span>.com/<span class=\"built_in\">nfs</span>-ssd   <span class=\"number\">248</span>d</span><br><span class=\"line\"><span class=\"built_in\">nfs</span>-retain      <span class=\"built_in\">nfs</span>.com/<span class=\"built_in\">nfs</span>-ssd   <span class=\"number\">248</span>d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"k8s-StatefulSet-grafana-yml\"><a href=\"#k8s-StatefulSet-grafana-yml\" class=\"headerlink\" title=\"k8s-StatefulSet_grafana.yml\"></a>k8s-StatefulSet_grafana.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"grafana-dev\"</span></span><br><span class=\"line\"><span class=\"attr\">  updateStrategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">grafana-data</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span></span><br><span class=\"line\">        <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs-retain\"</span> <span class=\"comment\"># 这里配置 上面创建的 storageclass 的名称</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">5</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">grafana/grafana</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">grafana-port</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"512m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - mountPath:</span> <span class=\"string\">/var/lib/grafana</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">grafana-data</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">grafana-dev-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">grafana-port</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">grafana-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">grafana-dev.k1s.club</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">          - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">            backend:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceName:</span> <span class=\"string\">grafana-dev-service</span></span><br><span class=\"line\"><span class=\"attr\">              servicePort:</span> <span class=\"number\">3000</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"通过-k8s-grafana-dashboard模板-监控效果如下\"><a href=\"#通过-k8s-grafana-dashboard模板-监控效果如下\" class=\"headerlink\" title=\"通过 k8s grafana dashboard模板  监控效果如下\"></a>通过 <a href=\"https://grafana.com/grafana/dashboards/8588\" target=\"_blank\" rel=\"noopener\">k8s grafana dashboard模板</a>  监控效果如下</h4><p><img src=\"assets/prometheus-02-01.png\" alt></p>\n<h4 id=\"通过以上的经验-如果我希望通过A集群的Prometheus-来监控-B集群-所以一些指标的可通过token访问B-api\"><a href=\"#通过以上的经验-如果我希望通过A集群的Prometheus-来监控-B集群-所以一些指标的可通过token访问B-api\" class=\"headerlink\" title=\"通过以上的经验, 如果我希望通过A集群的Prometheus 来监控 B集群, 所以一些指标的可通过token访问B api\"></a>通过以上的经验, 如果我希望通过A集群的Prometheus 来监控 B集群, 所以一些指标的可通过token访问B api</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看B集群的api</span></span><br><span class=\"line\">kubectl cluster-info</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl <span class=\"keyword\">create</span> serviceaccount <span class=\"comment\">--namespace=monitoring prometheus-dev</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">create</span> clusterrolebinding prometheus-k8s <span class=\"comment\">--clusterrole=cluster-admin --serviceaccount=monitoring:prometheus-dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个叫admin的serviceaccount</span></span><br><span class=\"line\">kubectl -n kube-<span class=\"keyword\">system</span> <span class=\"keyword\">create</span> serviceaccount <span class=\"keyword\">admin</span></span><br><span class=\"line\"><span class=\"comment\"># 给这个admin的serviceaccount绑上cluser-admin的clusterrole</span></span><br><span class=\"line\">kubectl -n kube-<span class=\"keyword\">system</span> <span class=\"keyword\">create</span> clusterrolebinding sa-cluster-<span class=\"keyword\">admin</span> <span class=\"comment\">--serviceaccount kube-system:admin --clusterrole cluser-admin</span></span><br><span class=\"line\"><span class=\"comment\"># 查询admin的secret</span></span><br><span class=\"line\">kubectl -n kube-<span class=\"keyword\">system</span> <span class=\"keyword\">get</span> serviceaccounts <span class=\"keyword\">admin</span> -o <span class=\"keyword\">json</span>|jq -r <span class=\"string\">'.secrets[0].name'</span></span><br><span class=\"line\"><span class=\"keyword\">admin</span>-token-h4zz4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看token</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">get</span> secret <span class=\"keyword\">admin</span>-token-h4zz4 -n kube-<span class=\"keyword\">system</span> -o <span class=\"keyword\">json</span>|jq -r <span class=\"string\">\".data.token\"</span>|base64 -d &gt;&gt;/etc/kubernetes/pki/<span class=\"keyword\">admin</span>-token<span class=\"number\">-9</span>dg92</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"然后在A集群的prometheus配置如下\"><a href=\"#然后在A集群的prometheus配置如下\" class=\"headerlink\" title=\"然后在A集群的prometheus配置如下\"></a>然后在A集群的prometheus配置如下</h4><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- job_name: k8s_B-kube-state-metrics</span><br><span class=\"line\">   honor_labels: true</span><br><span class=\"line\">   kubernetes_sd_configs:</span><br><span class=\"line\">     - role: endpoints</span><br><span class=\"line\">       api_server: https://<span class=\"number\">172.16</span>.xx.xx:<span class=\"number\">6443</span></span><br><span class=\"line\">       tls_config:</span><br><span class=\"line\">         insecure_skip_verify: true</span><br><span class=\"line\">       bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh<span class=\"number\">-7</span>qT6JInt308AA<span class=\"number\">-21</span>vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG<span class=\"number\">-13</span>RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'</span><br><span class=\"line\">       namespaces:</span><br><span class=\"line\">         names:</span><br><span class=\"line\">           - monitoring</span><br><span class=\"line\">   scrape_interval: <span class=\"number\">30</span>s</span><br><span class=\"line\">   scrape_timeout: <span class=\"number\">30</span>s</span><br><span class=\"line\">   tls_config:</span><br><span class=\"line\">     insecure_skip_verify: true</span><br><span class=\"line\">   bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh<span class=\"number\">-7</span>qT6JInt308AA<span class=\"number\">-21</span>vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG<span class=\"number\">-13</span>RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'</span><br><span class=\"line\">   relabel_configs:</span><br><span class=\"line\">     - action: keep</span><br><span class=\"line\">       source_labels:</span><br><span class=\"line\">         - __meta_kubernetes_service_label_k8s_app</span><br><span class=\"line\">       regex: kube-state-metrics</span><br><span class=\"line\">     - action: keep</span><br><span class=\"line\">       source_labels:</span><br><span class=\"line\">         - __meta_kubernetes_endpoint_port_name</span><br><span class=\"line\">       regex: http-main</span><br><span class=\"line\">   metric_relabel_configs:</span><br><span class=\"line\">     - source_labels:</span><br><span class=\"line\">         - __name__</span><br><span class=\"line\">       regex: (kube_daemonset_status_number_ready|<span class=\"type\">kube_daemonset_status_number_unavailable</span>|<span class=\"type\">kube_deployment_status_replicas_unavailable</span>|<span class=\"type\">kube_deployment_spec_paused</span>|<span class=\"type\">kube_deployment_spec_strategy_rollingupdate_max_surge</span>|<span class=\"type\">kube_deployment_spec_strategy_rollingupdate_max_unavailable</span>|<span class=\"type\">kube_endpoint_address_available</span>|<span class=\"type\">kube_endpoint_address_not_ready</span>|<span class=\"type\">kube_node_info</span>|<span class=\"type\">kube_node_spec_unschedulable</span>|<span class=\"type\">kube_node_status_condition</span>|<span class=\"type\">kube_node_status_capacity</span>|<span class=\"type\">kube_node_status_capacity</span>|<span class=\"type\">kube_node_status_allocatable</span>|<span class=\"type\">kube_persistentvolumeclaim_info</span>|<span class=\"type\">kube_persistentvolumeclaim_status_phase</span>|<span class=\"type\">kube_persistentvolumeclaim_resource_requests_storage_bytes</span>|<span class=\"type\">kube_persistentvolume_status_phase</span>|<span class=\"type\">kube_persistentvolume_info</span>|<span class=\"type\">kube_persistentvolume_capacity_bytes</span>|<span class=\"type\">kube_pod_info</span>|<span class=\"type\">kube_pod_status_phase</span>|<span class=\"type\">kube_pod_status_ready</span>|<span class=\"type\">kube_pod_container_info</span>|<span class=\"type\">kube_pod_container_status_waiting</span>|<span class=\"type\">kube_pod_container_status_waiting_reason</span>|<span class=\"type\">kube_pod_container_status_running</span>|<span class=\"type\">kube_pod_container_status_terminated_reason</span>|<span class=\"type\">kube_pod_container_status_last_terminated_reason</span>|<span class=\"type\">kube_pod_container_status_restarts_total</span>|<span class=\"type\">kube_pod_container_resource_limits</span>|<span class=\"type\">kube_service_info</span>|<span class=\"type\">kube_statefulset_status_replicas_current</span>|<span class=\"type\">kube_statefulset_status_replicas_ready</span>|<span class=\"type\">kube_deployment_status_replicas_available</span>|<span class=\"type\">kube_deployment_status_replicas</span>|<span class=\"type\">kube_node_status_allocatable_memory_bytes</span>|<span class=\"type\">kube_deployment_status_replicas</span>|<span class=\"type\">kube_statefulset_replicas</span>|<span class=\"type\">kube_daemonset_status_desired_number_scheduled</span>|<span class=\"type\">kube_statefulset_status_replicas</span>|<span class=\"type\">changes</span>|<span class=\"type\">kube_job_status_failed</span>)</span><br><span class=\"line\">       action: keep</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"部署alertmanager\"><a href=\"#部署alertmanager\" class=\"headerlink\" title=\"部署alertmanager\"></a>部署alertmanager</h3><h4 id=\"alertmanager-configmap-yml\"><a href=\"#alertmanager-configmap-yml\" class=\"headerlink\" title=\"alertmanager-configmap.yml\"></a>alertmanager-configmap.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">alertmanager-config</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">config.yml:</span> <span class=\"string\">|-</span></span><br><span class=\"line\"><span class=\"attr\">    global:</span></span><br><span class=\"line\">      <span class=\"comment\"># 在没有报警的情况下声明为已解决的时间</span></span><br><span class=\"line\"><span class=\"attr\">      resolve_timeout:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\">      <span class=\"comment\"># 配置邮件发送信息</span></span><br><span class=\"line\"><span class=\"attr\">      smtp_smarthost:</span> <span class=\"string\">'smtp.163.com:25'</span></span><br><span class=\"line\"><span class=\"attr\">      smtp_from:</span> <span class=\"string\">'xxx@163.com'</span></span><br><span class=\"line\"><span class=\"attr\">      smtp_auth_username:</span> <span class=\"string\">'xxx@163.com'</span></span><br><span class=\"line\"><span class=\"attr\">      smtp_auth_password:</span> <span class=\"string\">'xxx'</span></span><br><span class=\"line\"><span class=\"attr\">      smtp_require_tls:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"comment\"># 所有报警信息进入后的根路由，用来设置报警的分发策略</span></span><br><span class=\"line\"><span class=\"attr\">    route:</span></span><br><span class=\"line\">      <span class=\"comment\"># 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span></span><br><span class=\"line\"><span class=\"attr\">      group_by:</span> <span class=\"string\">['alertname',</span> <span class=\"string\">'cluster'</span><span class=\"string\">]</span></span><br><span class=\"line\">      <span class=\"comment\"># 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span></span><br><span class=\"line\"><span class=\"attr\">      group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\">      <span class=\"comment\"># 当第一个报警发送后，等待'group_interval'时间来发送新的一组报警信息。</span></span><br><span class=\"line\"><span class=\"attr\">      group_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\">      <span class=\"comment\"># 如果一个报警信息已经发送成功了，等待'repeat_interval'时间来重新发送他们</span></span><br><span class=\"line\"><span class=\"attr\">      repeat_interval:</span> <span class=\"number\">2</span><span class=\"string\">h</span></span><br><span class=\"line\">      <span class=\"comment\"># 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">    receivers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">'default'</span></span><br><span class=\"line\"><span class=\"attr\">      email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - to:</span> <span class=\"string\">'zhangzw@xxx.com'</span></span><br><span class=\"line\"><span class=\"attr\">        send_resolved:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"alertmanager-deployment-yml\"><a href=\"#alertmanager-deployment-yml\" class=\"headerlink\" title=\"alertmanager-deployment.yml\"></a>alertmanager-deployment.yml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">prom/alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">        args:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"--config.file=/etc/alertmanager/config.yml\"</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"--storage.path=/alertmanager\"</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">9093</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">alertmanager-cm</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">alertmanager-cm</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">alertmanager-config</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">9093</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"最后配置prometheus的rule文件-prometheus-config-rulefiles-yml-修改\"><a href=\"#最后配置prometheus的rule文件-prometheus-config-rulefiles-yml-修改\" class=\"headerlink\" title=\"最后配置prometheus的rule文件 prometheus-config-rulefiles.yml (修改)\"></a>最后配置prometheus的rule文件 prometheus-config-rulefiles.yml (修改)</h4><blockquote>\n<p>这里仅针对我这里prometheus部署的时候是通过configmap挂载的rule文件</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">k8s.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    groups:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">cpu-load-rule</span></span><br><span class=\"line\"><span class=\"attr\">      rules:</span></span><br><span class=\"line\"><span class=\"attr\">      - alert:</span> <span class=\"string\">cpu-load-high</span></span><br><span class=\"line\"><span class=\"attr\">        expr:</span> <span class=\"string\">irate(container_cpu_usage_seconds_total&#123;image!=\"\"&#125;[1m])</span> <span class=\"string\">&gt; 0.1</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">        for:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">        labels:</span></span><br><span class=\"line\"><span class=\"attr\">          serverity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">        annotations:</span></span><br><span class=\"line\"><span class=\"attr\">          summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> container_name: <span class=\"template-variable\">&#123;&#123; $labels.container_name &#125;&#125;</span>  pod_name: <span class=\"template-variable\">&#123;&#123; $labels.pod_name &#125;&#125;</span> , namespace: <span class=\"template-variable\">&#123;&#123; $labels.namespace&#125;&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"也贴上prometheus的StatefulSet-配置\"><a href=\"#也贴上prometheus的StatefulSet-配置\" class=\"headerlink\" title=\"也贴上prometheus的StatefulSet 配置\"></a>也贴上prometheus的StatefulSet 配置</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;  prometheus-statefulset.yml 配置可以看到prometheus-rulefiles 这个configmap是 挂载到 <span class=\"regexp\">/etc/</span>prometheus<span class=\"regexp\">/rules/</span> 目录</span><br><span class=\"line\">&gt;  prometheus-configmap.yml 配置可以看到     <span class=\"string\">rule_files:</span> - <span class=\"regexp\">/etc/</span>prometheus<span class=\"regexp\">/rules/</span>*.yml,  所以 以上prometheus-rulefiles 这个configmap 的k8s.yml就被prometheus当做rule文件了</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>prometheus-statefulset.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">   prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\"> volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\"> - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">     name:</span> <span class=\"string\">prometheus-data</span></span><br><span class=\"line\"><span class=\"attr\">     annotations:</span></span><br><span class=\"line\">       <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs-retain\"</span> <span class=\"comment\"># 这里配置 上面创建的 storageclass 的名称</span></span><br><span class=\"line\"><span class=\"attr\">   spec:</span></span><br><span class=\"line\"><span class=\"attr\">     accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">     resources:</span></span><br><span class=\"line\"><span class=\"attr\">       requests:</span></span><br><span class=\"line\"><span class=\"attr\">         storage:</span> <span class=\"number\">20</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\"> revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">     app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">     prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\"> serviceName:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\"> updateStrategy:</span></span><br><span class=\"line\"><span class=\"attr\">   type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\"> template:</span></span><br><span class=\"line\"><span class=\"attr\">   metadata:</span></span><br><span class=\"line\"><span class=\"attr\">     creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"attr\">     labels:</span></span><br><span class=\"line\"><span class=\"attr\">       app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">       prometheus:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">   spec:</span></span><br><span class=\"line\"><span class=\"attr\">     serviceAccount:</span> <span class=\"string\">prometheus-k8s</span></span><br><span class=\"line\"><span class=\"attr\">     containers:</span></span><br><span class=\"line\"><span class=\"attr\">       - args:</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.console.templates=/etc/prometheus/consoles</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.console.libraries=/etc/prometheus/console_libraries</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--config.file=/etc/prometheus/config/prometheus.yml</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--storage.tsdb.path=/prometheus</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.enable-admin-api</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--storage.tsdb.retention.time=20d</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.enable-lifecycle</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--storage.tsdb.no-lockfile</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.external-url=http://prometheus1-dev.xxx.com/</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"bullet\">--web.route-prefix=/</span></span><br><span class=\"line\"><span class=\"attr\">         image:</span> <span class=\"string\">prom/prometheus:v2.11.1</span></span><br><span class=\"line\"><span class=\"attr\">         imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">         livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">           failureThreshold:</span> <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"attr\">           httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">             path:</span> <span class=\"string\">/-/healthy</span></span><br><span class=\"line\"><span class=\"attr\">             port:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">             scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">           periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"attr\">           successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">           timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">         name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">         ports:</span></span><br><span class=\"line\"><span class=\"attr\">           - containerPort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"attr\">             name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">             protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">         readinessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">           failureThreshold:</span> <span class=\"number\">120</span></span><br><span class=\"line\"><span class=\"attr\">           httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">             path:</span> <span class=\"string\">/-/ready</span></span><br><span class=\"line\"><span class=\"attr\">             port:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">             scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">           periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"attr\">           successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">           timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">         resources:</span></span><br><span class=\"line\"><span class=\"attr\">           requests:</span></span><br><span class=\"line\"><span class=\"attr\">             memory:</span> <span class=\"number\">400</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">         terminationMessagePath:</span> <span class=\"string\">/dev/termination-log</span></span><br><span class=\"line\"><span class=\"attr\">         terminationMessagePolicy:</span> <span class=\"string\">File</span></span><br><span class=\"line\"><span class=\"attr\">         volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">           - mountPath:</span> <span class=\"string\">/etc/prometheus/config</span></span><br><span class=\"line\"><span class=\"attr\">             name:</span> <span class=\"string\">config</span></span><br><span class=\"line\"><span class=\"attr\">             readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">           - mountPath:</span> <span class=\"string\">/prometheus</span></span><br><span class=\"line\"><span class=\"attr\">             name:</span> <span class=\"string\">prometheus-data</span></span><br><span class=\"line\">             <span class=\"comment\">#subPath: prometheus-db</span></span><br><span class=\"line\"><span class=\"attr\">           - mountPath:</span> <span class=\"string\">/etc/prometheus/rules/</span></span><br><span class=\"line\"><span class=\"attr\">             name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">     volumes:</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">config</span></span><br><span class=\"line\"><span class=\"attr\">         configMap:</span></span><br><span class=\"line\"><span class=\"attr\">           defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">           name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br><span class=\"line\"><span class=\"attr\">         configMap:</span></span><br><span class=\"line\"><span class=\"attr\">           defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">           name:</span> <span class=\"string\">prometheus-rulefiles</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>prometheus-configmap.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">prometheus.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    global:</span></span><br><span class=\"line\"><span class=\"attr\">      evaluation_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      external_labels:</span></span><br><span class=\"line\"><span class=\"attr\">        prometheus:</span> <span class=\"string\">monitoring/k8s</span></span><br><span class=\"line\"><span class=\"attr\">    alerting:</span></span><br><span class=\"line\"><span class=\"attr\">      alertmanagers:</span></span><br><span class=\"line\"><span class=\"attr\">      - static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - targets:</span> <span class=\"string\">['alertmanager:80']</span></span><br><span class=\"line\"><span class=\"attr\">    rule_files:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/etc/prometheus/rules/*.yml</span></span><br><span class=\"line\"><span class=\"attr\">    scrape_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - job_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">      honor_labels:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">        namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">          names:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">        source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_label_prometheus</span></span><br><span class=\"line\"><span class=\"attr\">        regex:</span> <span class=\"string\">k8s</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">namespace</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_pod_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">pod</span></span><br><span class=\"line\"><span class=\"attr\">      - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">__meta_kubernetes_service_name</span></span><br><span class=\"line\"><span class=\"attr\">        target_label:</span> <span class=\"string\">job</span></span><br><span class=\"line\"><span class=\"attr\">        replacement:</span></span><br><span class=\"line\"><span class=\"attr\">      - target_label:</span> <span class=\"string\">endpoint</span></span><br><span class=\"line\"><span class=\"attr\">        replacement:</span> <span class=\"string\">web</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - job_name:</span> <span class=\"string\">k8s-db-t-kube-apiserver</span></span><br><span class=\"line\"><span class=\"attr\">      honor_labels:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">          namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">            names:</span></span><br><span class=\"line\"><span class=\"bullet\">              -</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">      tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">        insecure_skip_verify:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">        ca_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"attr\">      bearer_token_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"attr\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">          source_labels:</span> <span class=\"string\">[__meta_kubernetes_namespace,</span> <span class=\"string\">__meta_kubernetes_service_name,</span> <span class=\"string\">__meta_kubernetes_endpoint_port_name]</span></span><br><span class=\"line\"><span class=\"attr\">          separator:</span> <span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"attr\">          regex:</span> <span class=\"string\">default;kubernetes;https</span></span><br><span class=\"line\"><span class=\"attr\">      metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">__name__</span></span><br><span class=\"line\"><span class=\"attr\">          action:</span> <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">          regex:</span> <span class=\"string\">(apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - job_name:</span> <span class=\"string\">k8s-db-t-pods</span></span><br><span class=\"line\"><span class=\"attr\">      honor_labels:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">      - role:</span> <span class=\"string\">node</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      metrics_path:</span> <span class=\"string\">/metrics/cadvisor</span></span><br><span class=\"line\"><span class=\"attr\">      scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">      tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">        insecure_skip_verify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      bearer_token_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - job_name:</span> <span class=\"string\">k8s-db-t-kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">      honor_labels:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">          namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">            names:</span></span><br><span class=\"line\"><span class=\"bullet\">              -</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      scrape_timeout:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">      tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">        insecure_skip_verify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      bearer_token_file:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"attr\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">          source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">__meta_kubernetes_service_label_k8s_app</span></span><br><span class=\"line\"><span class=\"attr\">          regex:</span> <span class=\"string\">kube-state-metrics</span></span><br><span class=\"line\"><span class=\"attr\">        - action:</span> <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">          source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">__meta_kubernetes_endpoint_port_name</span></span><br><span class=\"line\"><span class=\"attr\">          regex:</span> <span class=\"string\">http-main</span></span><br><span class=\"line\"><span class=\"attr\">      metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">        - source_labels:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">__name__</span></span><br><span class=\"line\"><span class=\"attr\">          regex:</span> <span class=\"string\">(kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed)</span></span><br><span class=\"line\"><span class=\"attr\">          action:</span> <span class=\"string\">keep</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2020/05/14/47-k8s安装promethues-alertmanager-grafana/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"prometheus","slug":"k8s/prometheus","permalink":"https://blog.k1s.club/categories/k8s/prometheus/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"promethues","slug":"promethues","permalink":"https://blog.k1s.club/tags/promethues/"}]},{"title":"docker安装nginx第三方模块","date":"2020-05-13T03:12:01.000Z","path":"2020/05/13/46-docker安装nginx第三方模块/","text":"由于hub.docker.com 官方的nginx 并不会包括第三方包, 这里简要说明如何安装nginx_upstream_check_module模块 健康检查 nginx_upstream_check_module github 地址 docker安装nginx 如果使用官方的nginx镜像, 这里无法安装第三方模块,并没有像php的docker-php-ext-install 工具, 因此这里采用源码安装 这里镜像的大小也控制的还可以 12345# 自己源码安装的镜像hub.xxx.com/nginx 1.16.1-debian-buster-slim 5b5884f7927e 34 seconds ago 120MB# 官方镜像nginx 1.16 588bb5d559c2 6 weeks ago 127MB dockerfile123456789101112131415161718192021222324252627282930FROM debian:buster-slimLABEL maintainer=\"zhangzw zhangzw@xxx.com\"ENV NGINX_VERSION 1.16.1workdir /optRUN apt-get update \\ &amp;&amp; apt-get install wget unzip gcc make openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev net-tools patch -y\\ &amp;&amp; wget http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz \\ &amp;&amp; wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master \\ &amp;&amp; tar -xvf nginx-$&#123;NGINX_VERSION&#125;.tar.gz \\ &amp;&amp; unzip master \\ &amp;&amp; cd nginx-$&#123;NGINX_VERSION&#125; \\ &amp;&amp; patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.16.1+.patch \\ &amp;&amp; ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --add-module=../nginx_upstream_check_module-master/ &amp;&amp; make &amp;&amp; make install \\ &amp;&amp; rm -rf /opt/* \\ &amp;&amp; apt-get remove --purge -y wget unzip gcc make patch \\ &amp;&amp; apt-get autoremove -y \\ &amp;&amp; apt-get clean \\ &amp;&amp; rm -rf /var/lib/apt/lists/* \\ &amp;&amp; useradd nginxrun ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\ &amp;&amp; echo 'Asia/Shanghai' &gt;/etc/timezoneexpose 80CMD [\"/usr/sbin/nginx\", \"-c\", \"/etc/nginx/nginx.conf\", \"-g\", \"daemon off;\"]","raw":"---\ntitle: docker安装nginx第三方模块\ncopyright: true\ndate: 2020-05-13 11:12:01\ntags:\n  - docker \n---\n\n由于hub.docker.com 官方的nginx 并不会包括第三方包, 这里简要说明如何安装nginx_upstream_check_module模块\n\n<!--more-->\n\n\n\n\n\n### 健康检查\n- [nginx_upstream_check_module github 地址](https://github.com/yaoweibin/nginx_upstream_check_module)\n\n\n\n\n### docker安装nginx\n> 如果使用官方的nginx镜像, 这里无法安装第三方模块,并没有像php的docker-php-ext-install 工具,  因此这里采用源码安装\n\n> 这里镜像的大小也控制的还可以\n\n```\n# 自己源码安装的镜像\nhub.xxx.com/nginx  1.16.1-debian-buster-slim    5b5884f7927e        34 seconds ago      120MB\n\n# 官方镜像\nnginx              1.16                         588bb5d559c2        6 weeks ago         127MB\n```\n\n#### dockerfile\n```\nFROM debian:buster-slim\n\nLABEL maintainer=\"zhangzw zhangzw@xxx.com\"\n\nENV NGINX_VERSION   1.16.1\nworkdir /opt\n\n\nRUN apt-get update \\\n   && apt-get install wget unzip gcc make openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev net-tools patch -y\\\n   && wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \\\n   && wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master \\\n   && tar -xvf  nginx-${NGINX_VERSION}.tar.gz \\\n   && unzip master \\\n   && cd nginx-${NGINX_VERSION} \\\n   && patch -p1 < ../nginx_upstream_check_module-master/check_1.16.1+.patch \\\n   && ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module  --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module  --add-module=../nginx_upstream_check_module-master/ && make && make install \\\n  && rm -rf /opt/* \\\n  && apt-get remove --purge -y wget unzip gcc make patch \\\n  && apt-get autoremove -y \\\n  && apt-get clean \\\n  && rm -rf /var/lib/apt/lists/* \\\n  && useradd nginx\n\nrun  ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\\n && echo 'Asia/Shanghai' >/etc/timezone\n\nexpose 80\n\nCMD [\"/usr/sbin/nginx\", \"-c\", \"/etc/nginx/nginx.conf\", \"-g\", \"daemon off;\"]\n```\n\n\n\n","content":"<p>由于hub.docker.com 官方的nginx 并不会包括第三方包, 这里简要说明如何安装nginx_upstream_check_module模块</p>\n<a id=\"more\"></a>\n\n\n\n\n\n<h3 id=\"健康检查\"><a href=\"#健康检查\" class=\"headerlink\" title=\"健康检查\"></a>健康检查</h3><ul>\n<li><a href=\"https://github.com/yaoweibin/nginx_upstream_check_module\" target=\"_blank\" rel=\"noopener\">nginx_upstream_check_module github 地址</a></li>\n</ul>\n<h3 id=\"docker安装nginx\"><a href=\"#docker安装nginx\" class=\"headerlink\" title=\"docker安装nginx\"></a>docker安装nginx</h3><blockquote>\n<p>如果使用官方的nginx镜像, 这里无法安装第三方模块,并没有像php的docker-php-ext-install 工具,  因此这里采用源码安装</p>\n</blockquote>\n<blockquote>\n<p>这里镜像的大小也控制的还可以</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 自己源码安装的镜像</span><br><span class=\"line\">hub.xxx.com/nginx  <span class=\"number\">1.16</span><span class=\"number\">.1</span>-debian-buster-slim    <span class=\"number\">5</span>b5884f7927e        <span class=\"number\">34</span> seconds ago      <span class=\"number\">120</span>MB</span><br><span class=\"line\"></span><br><span class=\"line\"># 官方镜像</span><br><span class=\"line\">nginx              <span class=\"number\">1.16</span>                         <span class=\"number\">588</span>bb5d559c2        <span class=\"number\">6</span> weeks ago         <span class=\"number\">127</span>MB</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"dockerfile\"><a href=\"#dockerfile\" class=\"headerlink\" title=\"dockerfile\"></a>dockerfile</h4><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM debian<span class=\"function\">:buster-slim</span></span><br><span class=\"line\"></span><br><span class=\"line\">LABEL maintainer=<span class=\"string\">\"zhangzw zhangzw@xxx.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">ENV NGINX_VERSION   1.16.1</span><br><span class=\"line\">workdir <span class=\"string\">/opt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RUN apt-get update \\</span><br><span class=\"line\">   &amp;&amp; apt-get install wget unzip gcc make openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev net-tools <span class=\"keyword\">patch</span> -y\\</span><br><span class=\"line\">   &amp;&amp; wget http:<span class=\"string\">//nginx.org/download/nginx-</span>$&#123;NGINX_VERSION&#125;<span class=\"string\">.tar.gz</span> \\</span><br><span class=\"line\">   &amp;&amp; wget https:<span class=\"string\">//codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master</span> \\</span><br><span class=\"line\">   &amp;&amp; tar -xvf  nginx-$&#123;NGINX_VERSION&#125;<span class=\"string\">.tar.gz</span> \\</span><br><span class=\"line\">   &amp;&amp; unzip master \\</span><br><span class=\"line\">   &amp;&amp; <span class=\"keyword\">cd</span> nginx-$&#123;NGINX_VERSION&#125; \\</span><br><span class=\"line\">   &amp;&amp; <span class=\"keyword\">patch</span> -p1 &lt; <span class=\"string\">../nginx_upstream_check_module-master/check_1.16.1</span>+<span class=\"string\">.patch</span> \\</span><br><span class=\"line\">   &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/etc/nginx</span> <span class=\"params\">--sbin-path=/usr/sbin/nginx</span> <span class=\"params\">--modules-path=/usr/lib/nginx/modules</span> <span class=\"params\">--conf-path=/etc/nginx/nginx</span>.conf <span class=\"params\">--error-log-path=/var/log/nginx/error</span>.log <span class=\"params\">--http-log-path=/var/log/nginx/access</span>.log <span class=\"params\">--pid-path=/var/run/nginx</span>.pid <span class=\"params\">--lock-path=/var/run/nginx</span>.lock <span class=\"params\">--user=nginx</span> <span class=\"params\">--group=nginx</span> <span class=\"params\">--with-compat</span> <span class=\"params\">--with-file-aio</span> <span class=\"params\">--with-threads</span> <span class=\"params\">--with-http_addition_module</span> <span class=\"params\">--with-http_auth_request_module</span> <span class=\"params\">--with-http_dav_module</span> <span class=\"params\">--with-http_flv_module</span> <span class=\"params\">--with-http_gunzip_module</span> <span class=\"params\">--with-http_gzip_static_module</span> <span class=\"params\">--with-http_mp4_module</span> <span class=\"params\">--with-http_random_index_module</span> <span class=\"params\">--with-http_realip_module</span> <span class=\"params\">--with-http_secure_link_module</span> <span class=\"params\">--with-http_slice_module</span> <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-http_stub_status_module</span> <span class=\"params\">--with-http_sub_module</span> <span class=\"params\">--with-http_v2_module</span>  <span class=\"params\">--with-mail_ssl_module</span> <span class=\"params\">--with-stream</span> <span class=\"params\">--with-stream_realip_module</span> <span class=\"params\">--with-stream_ssl_module</span> <span class=\"params\">--with-stream_ssl_preread_module</span>  <span class=\"params\">--add-module=</span><span class=\"string\">../nginx_upstream_check_module-master/</span> &amp;&amp; make &amp;&amp; make install \\</span><br><span class=\"line\">  &amp;&amp; rm -rf <span class=\"string\">/opt/</span>* \\</span><br><span class=\"line\">  &amp;&amp; apt-get remove <span class=\"params\">--purge</span> -y wget unzip gcc make <span class=\"keyword\">patch</span> \\</span><br><span class=\"line\">  &amp;&amp; apt-get autoremove -y \\</span><br><span class=\"line\">  &amp;&amp; apt-get clean \\</span><br><span class=\"line\">  &amp;&amp; rm -rf <span class=\"string\">/var/lib/apt/lists/</span>* \\</span><br><span class=\"line\">  &amp;&amp; useradd nginx</span><br><span class=\"line\"></span><br><span class=\"line\">run  ln -sf <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span> <span class=\"string\">/etc/localtime</span> \\</span><br><span class=\"line\"> &amp;&amp; <span class=\"keyword\">echo</span> 'Asia/Shanghai' &gt;<span class=\"string\">/etc/timezone</span></span><br><span class=\"line\"></span><br><span class=\"line\">expose 80</span><br><span class=\"line\"></span><br><span class=\"line\">CMD [<span class=\"string\">\"/usr/sbin/nginx\"</span>, <span class=\"string\">\"-c\"</span>, <span class=\"string\">\"/etc/nginx/nginx.conf\"</span>, <span class=\"string\">\"-g\"</span>, <span class=\"string\">\"daemon off;\"</span>]</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/05/13/46-docker安装nginx第三方模块/","categories":[],"tags":[{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/tags/docker/"}]},{"title":"gitlab-ci与k8s结合","date":"2020-04-23T08:20:33.000Z","path":"2020/04/23/45-gitlab-ci与k8s结合/","text":"本文介绍如何通过gitlab-ci整合k8s实现流水线部署 https://www.cnblogs.com/Sinte-Beuve/p/11739196.html https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/ 环境版本统计123451 gitlab/gitlab-runner 0.15.02 helm 2.163 k8s 1.16.44 gitlab 11.55 CentOS Linux release 7.7 /kernel 5.2 小节 1231. gitlab 通过admin管理页面的runner配置, 安装gitlab-runner, 安装方式可以是二进制, docker 或k8s (这里是k8s)2. gitlab 项目目录的 Operations -&gt; kubernetes -&gt; Add Kubernetes Cluster -&gt; Add existing cluster 是结合k8s, 每个项目都需要设置一个k8s集群,k8s集群需要配置rbac权限3. ci 在提交到私有harbor上是需要验证账号密码, 私有仓库拉取也需要验证 安装方法一 k8s yaml直接部署gitlab-ci-token-secret.yaml 具体token值 请查看 gitlab的admin页面-&gt; Overview -&gt; Runners 查看, 然后base64加密 123456789apiVersion: v1kind: Secretmetadata: name: gitlab-ci-token namespace: kube-ops labels: app: gitlab-ci-runnerdata: GITLAB_CI_TOKEN: $(echo \"gitlab_ci_token\"|base64) runner-configmap.yaml1234567891011121314151617181920212223242526apiVersion: v1kind: ConfigMapmetadata: labels: app: gitlab-ci-runner name: gitlab-ci-runner-cm namespace: kube-opsdata: REGISTER_NON_INTERACTIVE: \"true\" REGISTER_LOCKED: \"false\" METRICS_SERVER: \"0.0.0.0:9100\" CI_SERVER_URL: \"http://gitlab.xxx.com/ci\" RUNNER_REQUEST_CONCURRENCY: \"4\" RUNNER_EXECUTOR: \"kubernetes\" KUBERNETES_NAMESPACE: \"kube-ops\" KUBERNETES_PRIVILEGED: \"true\" KUBERNETES_CPU_LIMIT: \"1\" KUBERNETES_MEMORY_LIMIT: \"1Gi\" KUBERNETES_SERVICE_CPU_LIMIT: \"1\" KUBERNETES_SERVICE_MEMORY_LIMIT: \"1Gi\" KUBERNETES_HELPER_CPU_LIMIT: \"500m\" KUBERNETES_HELPER_MEMORY_LIMIT: \"100Mi\" KUBERNETES_PULL_POLICY: \"if-not-present\" KUBERNETES_TERMINATIONGRACEPERIODSECONDS: \"10\" KUBERNETES_POLL_INTERVAL: \"5\" KUBERNETES_POLL_TIMEOUT: \"360\" runner-rbac.yaml1234567891011121314151617181920212223242526272829apiVersion: v1kind: ServiceAccountmetadata: name: gitlab-ci namespace: kube-ops---kind: RoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: gitlab-ci namespace: kube-opsrules: - apiGroups: [\"\"] resources: [\"*\"] verbs: [\"*\"]---kind: RoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: gitlab-ci namespace: kube-opssubjects: - kind: ServiceAccount name: gitlab-ci namespace: kube-opsroleRef: kind: Role name: gitlab-ci apiGroup: rbac.authorization.k8s.io runner-scripts-cm.yaml1234567891011121314151617181920212223apiVersion: v1data: run.sh: | #!/bin/bash unregister() &#123; kill %1 echo \"Unregistering runner $&#123;RUNNER_NAME&#125; ...\" /usr/bin/gitlab-ci-multi-runner unregister -t \"$(/usr/bin/gitlab-ci-multi-runner list 2&gt;&amp;1 | tail -n1 | awk '&#123;print $4&#125;' | cut -d'=' -f2)\" -n $&#123;RUNNER_NAME&#125; exit $? &#125; trap 'unregister' EXIT HUP INT QUIT PIPE TERM echo \"Registering runner $&#123;RUNNER_NAME&#125; ...\" /usr/bin/gitlab-ci-multi-runner register -r $&#123;GITLAB_CI_TOKEN&#125; sed -i 's/^concurrent.*/concurrent = '\"$&#123;RUNNER_REQUEST_CONCURRENCY&#125;\"'/' /home/gitlab-runner/.gitlab-runner/config.toml echo \"Starting runner $&#123;RUNNER_NAME&#125; ...\" /usr/bin/gitlab-ci-multi-runner run -n $&#123;RUNNER_NAME&#125; &amp; waitkind: ConfigMapmetadata: labels: app: gitlab-ci-runner name: gitlab-ci-runner-scripts namespace: kube-ops runner-statefulset.yaml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061apiVersion: apps/v1beta1kind: StatefulSetmetadata: name: gitlab-ci-runner namespace: kube-ops labels: app: gitlab-ci-runnerspec: updateStrategy: type: RollingUpdate replicas: 2 serviceName: gitlab-ci-runner template: metadata: labels: app: gitlab-ci-runner spec: volumes: - name: gitlab-ci-runner-scripts projected: sources: - configMap: name: gitlab-ci-runner-scripts items: - key: run.sh path: run.sh mode: 0755 serviceAccountName: gitlab-ci securityContext: runAsNonRoot: true runAsUser: 999 supplementalGroups: [999] containers: - image: gitlab/gitlab-runner:latest name: gitlab-ci-runner resources: requests: cpu: \"50m\" limits: cpu: \"800m\" command: - /scripts/run.sh envFrom: - configMapRef: name: gitlab-ci-runner-cm - secretRef: name: gitlab-ci-token env: - name: RUNNER_NAME valueFrom: fieldRef: fieldPath: metadata.name ports: - containerPort: 9100 name: http-metrics protocol: TCP volumeMounts: - name: gitlab-ci-runner-scripts mountPath: \"/scripts\" readOnly: true restartPolicy: Always 部署和检查12kubectl apply -f ../kubectl get all -n kube-ops 安装方法二 helm2.16安装12345678wget https://get.helm.sh/helm-v2.16.2-linux-amd64.tar.gztar -xvf helm-v2.16.2-linux-amd64.tar.gzmv linux-amd64/helm /usr/local/bin/helmkubectl create serviceaccount --namespace=kube-system tillerkubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tillerhelm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.2 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --service-account tiller 从官方拉取helm2 配置文件1234567891011121314151617181920212223242526272829303132333435363738394041424344# 添加源helm repo add gitlab https://charts.gitlab.io# 查看helm search runnergitlab/gitlab-runner 0.15.0 12.9.0 GitLab Runner# 下载charts压缩包gitlab-runner-0.15.0.tgzhelm fetch gitlab/gitlab-runner# 创建gitlab-runner的rbac账号kubectl create serviceaccount gitlab-cluster-adminkubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default# 然后修改 values.yamlgitlabUrl: http://gitlab.zhangzw.com #gitlab服务器上管理页面上的URLrunnerRegistrationToken: #gitlab服务器管理页面的tokenserviceAccountName: gitlab-cluster-admin# 修改 templates/configmap.yaml (如果后面配置dind采用tcp://0.0.0.0:2375的方式应该不用挂载sock文件) # if ! sh /scripts/register-the-runner; then exit 1 fi # add new config start cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF [[runners.kubernetes.volumes.host_path]] name = \"docker\" mount_path = \"/var/run/docker.sock\" read_only = false host_path = \"/var/run/docker.sock\" EOF # add new config end # Start the runner exec /entrypoint run --user=gitlab-runner \\ --working-directory=/home/gitlab-runner# helm启动,更新,删除gitlab-runnerhelm install --name gitlab-runner .helm upgrade gitlab-runner .helm delete --purge gitlab-runner 登录到gitlab-runner 镜像register注册 以下大部分都是回车, 只有token需要手动输入(输入values.yaml中的runnerRegistrationToken即可) 123456789101112131415161718192021bash-5.0$ gitlab-runner registerRuntime platform arch=amd64 os=linux pid=4257 revision=4c96e5ad version=12.9.0WARNING: Running in user-mode. WARNING: The user-mode requires you to manually start builds processing:WARNING: $ gitlab-runner run WARNING: Use sudo for system-mode: WARNING: $ sudo gitlab-runner... Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.zhangzw.com/):[http://gitlab.zhangzw.com]:Please enter the gitlab-ci token for this runner:djs47LiKFy-64FxAACp5Please enter the gitlab-ci description for this runner:[gitlab-runner-gitlab-runner-6cf8c6bff4-rhhs5]:Please enter the gitlab-ci tags for this runner (comma separated):Registering runner... succeeded runner=djs47LiKPlease enter the executor: docker+machine, docker-ssh+machine, kubernetes, docker, docker-ssh, shell, ssh, virtualbox, custom, parallels:[kubernetes]:Runner registered successfully. Feel free to start it, but if its running already the config should be automatically reloaded!bash-5.0$ 在项目的页面点击 Add Kubernetes Cluster -&gt; Add existing cluster API URL 是你的集群的apiserver的地址， 一般可以通过输入kubectl cluster-info获取 12345kubectl cluster-infoKubernetes master is running at https://master.k8s.io:16443KubeDNS is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxyMetrics-server is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy CA证书 由于我们在部署阶段需要去创建、删除一些资源对象，所以我们也需要对象的 RBAC 权限，这里为了简单，我们直接新建一个 ServiceAccount，绑定上一个cluster-admin的权限(gitlab-serviceAccount.yaml) 123456789101112131415161718192021---apiVersion: v1kind: ServiceAccountmetadata: name: gitlab namespace: gitlab---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRoleBindingmetadata: name: gitlab namespace: gitlabsubjects: - kind: ServiceAccount name: gitlab namespace: gitlabroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin 1234567891011#可以通过上面创建的 ServiceAccount 获取 CA 证书和 Token：kubectl get serviceaccount gitlab -n gitlab -o json | jq -r '.secrets[0].name'gitlab-token-9jlpr# 然后根据上面的Secret找到CA证书kubectl get secret gitlab-token-9jlpr -n gitlab -o json | jq -r '.data[\"ca.crt\"]' | base64 -dxxxxxCA证书内容xxxxx# 当然要找到对应的 Token 也很简单kubectl get secret gitlab-token-9jlpr -n gitlab -o json | jq -r '.data.token' | base64 -dxxxxxxtoken值xxxx 然后复制对应的值贴到项目的k8s配置中即可 简单测试123456789101112131415161718#.gitlab-ci.ymlimage: busyboxstages: - build - deployJob1: stage: build script: - echo \"go go go !!!~\" only: - masterdeploy: stage: deploy script: - echo \"部署开始\" only: - master .gitlab-ci.yaml配置 以下一些配置写到gitlab项目页面-&gt; Settings -&gt; CI/CD -&gt; Variables其实也可以写到.gitlab-ca.yaml中, 我在deployment.yaml也无法用如下变量 1234CI_REGISTRY_USER: adminCI_REGISTRY_PASSWORD: xxxxxCI_REGISTRY: hub.xxx.comCI_REGISTRY_IMAGE: hub.xxx.com/public/nginx 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293variables: GIT_CURL_VERBOSE: 1 GIT_TRACE: 1stages: - release - review - deploybuildPushImage: stage: release image: docker:latest services: - name: docker:dind command: [\"--insecure-registry=hub.zhangzw.com\"] variables: DOCKER_DRIVER: overlay2 DOCKER_HOST: tcp://192.168.0.136:2375 script: - docker login -u \"$&#123;CI_REGISTRY_USER&#125;\" -p \"$&#123;CI_REGISTRY_PASSWORD&#125;\" \"$&#123;CI_REGISTRY&#125;\" - docker build -t \"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;\" . - docker push \"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;\"deploy_review: image: bitnami/kubectl:1.16.3 stage: review only: - branches except: - tags environment: name: dev url: http://dev-gitlab-k8s-demo.zhangzw.com on_stop: stop_review script: - kubectl version - cd deploy/ - sed -i \"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/\" deployment.yaml ingress.yaml service.yaml - sed -i \"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/\" deployment.yaml ingress.yaml service.yaml - | if kubectl apply -f deployment.yaml | grep -q unchanged; then echo \"=&gt; Patching deployment to force image update.\" kubectl patch -f deployment.yaml -p \"&#123;\\\"spec\\\":&#123;\\\"template\\\":&#123;\\\"metadata\\\":&#123;\\\"annotations\\\":&#123;\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"&#125;&#125;&#125;&#125;&#125;\" else echo \"=&gt; Deployment apply has changed the object, no need to force image update.\" fi - kubectl apply -f service.yaml || true - kubectl apply -f ingress.yaml - kubectl rollout status -f deployment.yaml - kubectl get all,ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;stop_review: image: bitnami/kubectl:1.16.3 stage: review variables: GIT_STRATEGY: none when: manual only: - branches except: - master - tags environment: name: dev action: stop script: - kubectl version - kubectl delete ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125; - kubectl delete all -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;deploy_live: image: bitnami/kubectl:1.16.3 stage: deploy environment: name: live url: http://live-gitlab-k8s-demo.zhangzw.com script: - echo \"部署开始\" - cd deploy - sed -i \"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/\" deployment.yaml ingress.yaml service.yaml - sed -i \"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/\" deployment.yaml ingress.yaml service.yaml - kubectl apply -f deployment.yaml - kubectl apply -f service.yaml - kubectl apply -f ingress.yaml - kubectl rollout status -f deployment.yaml - kubectl get all,ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125; only: - tags when: manual deploy/deployment.yaml1234567891011121314151617181920212223242526272829303132333435363738394041424344---apiVersion: apps/v1kind: Deploymentmetadata: name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__ labels: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ track: stablespec: replicas: 2 selector: matchLabels: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ template: metadata: labels: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ track: stable spec: imagePullSecrets: - name: myregistry containers: - name: app image: hub.zhangzw.com/bq/nginx:__VERSION__ imagePullPolicy: Always ports: - name: http-metrics protocol: TCP containerPort: 80 livenessProbe: httpGet: path: / port: 80 initialDelaySeconds: 3 timeoutSeconds: 2 readinessProbe: httpGet: path: / port: 80 initialDelaySeconds: 3 timeoutSeconds: 2 如果我们harbor中设置的是私有镜像, 则需要设置imagePullSecret 才能拉取镜像1kubectl create secret docker-registry gitlab-hub-secret --docker-server=hub.zhangzw.com --docker-username=xxx --docker-password=xxx --docker-email=zhangzw@zhangzw.com deploy/service.yaml12345678910111213141516171819202122---apiVersion: v1kind: Servicemetadata: name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__ labels: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ annotations: prometheus.io/scrape: \"true\" prometheus.io/port: \"80\" prometheus.io/scheme: \"http\" prometheus.io/path: \"/\"spec: type: ClusterIP ports: - name: http-metrics port: 80 protocol: TCP selector: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ deploy/ingress.yaml12345678910111213141516171819---apiVersion: extensions/v1beta1kind: Ingressmetadata: name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__ labels: app: gitlab-k8s-demo ref: __CI_ENVIRONMENT_SLUG__ annotations: kubernetes.io/ingress.class: \"traefik\"spec: rules: - host: __CI_ENVIRONMENT_SLUG__-gitlab-k8s-demo.zhangzw.com http: paths: - path: / backend: serviceName: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__ servicePort: 80 遇到的问题err1. 流水线打包的时候提示没有权限12345ERROR: Job failed (system failure): pods is forbidden: User \"system:serviceaccount:default:default\" cannot create resource \"pods\" in API group \"\" in the namespace \"default\"kubectl create serviceaccount gitlab-cluster-adminkubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default err2. 流水线打包提示无法拉取项目123fatal: unable to access 'http://gitlab.zhangzw.com/k8s/rancher-dev-php.git/': Failed to connect to gitlab.zhangzw.com port 80: Connection refusedUploading artifacts for failed jobERROR: Job failed: command terminated with exit code 1 难道是因为我们的项目是私有项目? 显然我们在官网 https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html 这里看到下面一句话 1234Only if the clone_url is set, the runner will construct a clone URL in the form of http://gitlab-ci-token:s3cr3tt0k3n@192.168.1.23/namespace/project.git.# 尝试修改 values.yamlcloneUrl: http://gitlab.zhangzw.com 之后还是出现了该问题 所以这应该是gitlab-runner register的问题 但是这里诡异的是, 我三个步骤,前两个都是正常, 第三个一直是报错connection refused, 但是我重试了三遍又正常了, 这么不稳定的吗? 看日志错误有点像是这么回事, 我的nginx反向代理了gitlab.zhangzw.com proxy_pass的是ip:10080, 而日志中看起来报错提示是链接到ip:80 我这里试着将helm安装gitlab-runner的配置文件values.yaml修改如下: 12gitlabUrl: http://192.168.0.65:10080 cloneUrl: http://192.168.0.65:10080 测试之后还是会出现无法连接, 所以也不是这个问题, 这里git clone http 方式经过nginx代理是没问题的 如果是项目权限问题, 那我新建一个public项目应该不会报错 测试之后还是会出现无法连接, 看起问题还是网络方面问题, 为什么会网络无法连接呢? 嗯??? 我查看了下 gitlab admin -&gt; runners -&gt; 点击Runner token 进入 -&gt; Assigned projects 这里我之前是加过的, 但是helm 安装的gitlab-runner upgrade之后就好像丢失了, 可能是我这边没有mount数据存储到nfs, 不过这里可以不用按照分配的方式, 就设置为share即可,如果有多个runner,需要更细致的权限部署划分,可以设置 所以现在这个问题就变成, 有可能第一次会成功, 有可能会失败, 有可能第二个步骤失败 , 然后retry 2次?3次或6次又成功了, 蛋疼中… 2020-04-24 15:58:40 补: 我这边测试的gitlab-runner安装的网段和gitlab的网段之间网络问题, 现在新搭建的gitlab-runner和gitlab在同一网段就不在报错了... err3. k8s1.16安装helm2.14的有报错: Error: error installing: the server could not find the requested resource, 这是由于 extensions/v1beta1 已经被 apps/v1 替代。相信在2.15 或者 3 版本发布之后, 应该就不会遇到这个问题了。还是生态比较慢的原因。1helm init -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.3 --stable-repo-url http://mirror.azure.cn/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.'name'='tiller',spec.selector.matchLabels.'app'='helm' --output yaml | sed 's@apiVersion: extensions/v1beta1@apiVersion: apps/v1@' | kubectl apply -f - err4. Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?1不确定为什么会报这个错误, 第二次启动又没问题了 err5. time=”2020-04-22T02:39:12Z” level=error msg=”failed to dial gRPC: cannot connect to the Docker daemon. Is ‘docker daemon’ running on this host?: dial tcp 127.0.0.1:2375: connect: connection refused”123这种情况需要docker或者k8s的docker启动方式添加tcp方式vim /usr/lib/systemd/system/docker.serviceExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock -H fd:// --containerd=/run/containerd/containerd.sock","raw":"---\ntitle: gitlab-ci与k8s结合\ncopyright: true\ndate: 2020-04-23 16:20:33\ntags:\n  - gitlab-runner\n  - k8s\ncategories:\n  - [k8s]\n  - [gitlab-ci]\n---\n本文介绍如何通过gitlab-ci整合k8s实现流水线部署\n\n<!--more -->\n\n\n> 1. https://www.cnblogs.com/Sinte-Beuve/p/11739196.html\n> 2. https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/\n\n### 环境版本统计\n```\n1 gitlab/gitlab-runner 0.15.0\n2 helm 2.16\n3 k8s 1.16.4\n4 gitlab 11.5\n5 CentOS Linux release 7.7 /kernel 5.2\n```\n\n> 小节\n```\n1. gitlab 通过admin管理页面的runner配置, 安装gitlab-runner, 安装方式可以是二进制, docker 或k8s (这里是k8s)\n2. gitlab 项目目录的 Operations -> kubernetes -> Add Kubernetes Cluster -> Add existing cluster 是结合k8s, 每个项目都需要设置一个k8s集群,k8s集群需要配置rbac权限\n3. ci 在提交到私有harbor上是需要验证账号密码, 私有仓库拉取也需要验证\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 安装方法一 </font>\n</center>\n\n### k8s yaml直接部署\n#### gitlab-ci-token-secret.yaml\n\n> 具体token值 请查看 gitlab的admin页面-> Overview -> Runners 查看, 然后base64加密\n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: gitlab-ci-token\n  namespace: kube-ops\n  labels:\n    app: gitlab-ci-runner\ndata:\n  GITLAB_CI_TOKEN: $(echo \"gitlab_ci_token\"|base64)\n```\n\n\n#### runner-configmap.yaml\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  labels:\n    app: gitlab-ci-runner\n  name: gitlab-ci-runner-cm\n  namespace: kube-ops\ndata:\n  REGISTER_NON_INTERACTIVE: \"true\"\n  REGISTER_LOCKED: \"false\"\n  METRICS_SERVER: \"0.0.0.0:9100\"\n  CI_SERVER_URL: \"http://gitlab.xxx.com/ci\"\n  RUNNER_REQUEST_CONCURRENCY: \"4\"\n  RUNNER_EXECUTOR: \"kubernetes\"\n  KUBERNETES_NAMESPACE: \"kube-ops\"\n  KUBERNETES_PRIVILEGED: \"true\"\n  KUBERNETES_CPU_LIMIT: \"1\"\n  KUBERNETES_MEMORY_LIMIT: \"1Gi\"\n  KUBERNETES_SERVICE_CPU_LIMIT: \"1\"\n  KUBERNETES_SERVICE_MEMORY_LIMIT: \"1Gi\"\n  KUBERNETES_HELPER_CPU_LIMIT: \"500m\"\n  KUBERNETES_HELPER_MEMORY_LIMIT: \"100Mi\"\n  KUBERNETES_PULL_POLICY: \"if-not-present\"\n  KUBERNETES_TERMINATIONGRACEPERIODSECONDS: \"10\"\n  KUBERNETES_POLL_INTERVAL: \"5\"\n  KUBERNETES_POLL_TIMEOUT: \"360\"\n```\n\n#### runner-rbac.yaml\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: gitlab-ci\n  namespace: kube-ops\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: gitlab-ci\n  namespace: kube-ops\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"*\"]\n    verbs: [\"*\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: gitlab-ci\n  namespace: kube-ops\nsubjects:\n  - kind: ServiceAccount\n    name: gitlab-ci\n    namespace: kube-ops\nroleRef:\n  kind: Role\n  name: gitlab-ci\n  apiGroup: rbac.authorization.k8s.io\n```\n\n#### runner-scripts-cm.yaml\n\n```yaml\napiVersion: v1\ndata:\n  run.sh: |\n    #!/bin/bash\n    unregister() {\n        kill %1\n        echo \"Unregistering runner ${RUNNER_NAME} ...\"\n        /usr/bin/gitlab-ci-multi-runner unregister -t \"$(/usr/bin/gitlab-ci-multi-runner list 2>&1 | tail -n1 | awk '{print $4}' | cut -d'=' -f2)\" -n ${RUNNER_NAME}\n        exit $?\n    }\n    trap 'unregister' EXIT HUP INT QUIT PIPE TERM\n    echo \"Registering runner ${RUNNER_NAME} ...\"\n    /usr/bin/gitlab-ci-multi-runner register -r ${GITLAB_CI_TOKEN}\n    sed -i 's/^concurrent.*/concurrent = '\"${RUNNER_REQUEST_CONCURRENCY}\"'/' /home/gitlab-runner/.gitlab-runner/config.toml\n    echo \"Starting runner ${RUNNER_NAME} ...\"\n    /usr/bin/gitlab-ci-multi-runner run -n ${RUNNER_NAME} &\n    wait\nkind: ConfigMap\nmetadata:\n  labels:\n    app: gitlab-ci-runner\n  name: gitlab-ci-runner-scripts\n  namespace: kube-ops\n```\n\n\n#### runner-statefulset.yaml\n\n```yaml\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  name: gitlab-ci-runner\n  namespace: kube-ops\n  labels:\n    app: gitlab-ci-runner\nspec:\n  updateStrategy:\n    type: RollingUpdate\n  replicas: 2\n  serviceName: gitlab-ci-runner\n  template:\n    metadata:\n      labels:\n        app: gitlab-ci-runner\n    spec:\n      volumes:\n      - name: gitlab-ci-runner-scripts\n        projected:\n          sources:\n          - configMap:\n              name: gitlab-ci-runner-scripts\n              items:\n              - key: run.sh\n                path: run.sh\n                mode: 0755\n      serviceAccountName: gitlab-ci\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 999\n        supplementalGroups: [999]\n      containers:\n      - image: gitlab/gitlab-runner:latest\n        name: gitlab-ci-runner\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"800m\"\n        command:\n        - /scripts/run.sh\n        envFrom:\n        - configMapRef:\n            name: gitlab-ci-runner-cm\n        - secretRef:\n            name: gitlab-ci-token\n        env:\n        - name: RUNNER_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        ports:\n        - containerPort: 9100\n          name: http-metrics\n          protocol: TCP\n        volumeMounts:\n        - name: gitlab-ci-runner-scripts\n          mountPath: \"/scripts\"\n          readOnly: true\n      restartPolicy: Always\n```\n\n#### 部署和检查\n\n```yaml \nkubectl apply -f ../\nkubectl get all -n kube-ops\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 安装方法二 </font>\n</center>\n\n### helm2.16安装\n\n```\nwget https://get.helm.sh/helm-v2.16.2-linux-amd64.tar.gz\ntar -xvf helm-v2.16.2-linux-amd64.tar.gz\nmv linux-amd64/helm /usr/local/bin/helm\n\nkubectl create serviceaccount --namespace=kube-system tiller\nkubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller\n\nhelm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.2 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --service-account tiller\n\n\n```\n\n\n![](//zhangzw001.github.io/images/45/02.png)\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 从官方拉取helm2 配置文件\n```\n# 添加源\nhelm repo add gitlab https://charts.gitlab.io\n\n# 查看\nhelm search runner\ngitlab/gitlab-runner 0.15.0        12.9.0      GitLab Runner\n\n# 下载charts压缩包gitlab-runner-0.15.0.tgz\nhelm fetch gitlab/gitlab-runner\n\n# 创建gitlab-runner的rbac账号\nkubectl create serviceaccount  gitlab-cluster-admin\nkubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default\n\n# 然后修改 values.yaml\ngitlabUrl: http://gitlab.zhangzw.com #gitlab服务器上管理页面上的URL\nrunnerRegistrationToken: #gitlab服务器管理页面的token\nserviceAccountName: gitlab-cluster-admin\n\n# 修改 templates/configmap.yaml (如果后面配置dind采用tcp://0.0.0.0:2375的方式应该不用挂载sock文件)\n    #\n    if ! sh /scripts/register-the-runner; then\n      exit 1\n    fi\n\n    # add new config start\n    cat >>/home/gitlab-runner/.gitlab-runner/config.toml <<EOF\n      [[runners.kubernetes.volumes.host_path]]\n            name = \"docker\"\n            mount_path = \"/var/run/docker.sock\"\n            read_only = false\n            host_path = \"/var/run/docker.sock\"\n    EOF\n    # add new config end\n\n    # Start the runner\n    exec /entrypoint run --user=gitlab-runner \\\n      --working-directory=/home/gitlab-runner\n\n\n# helm启动,更新,删除gitlab-runner\nhelm install  --name gitlab-runner .\nhelm upgrade gitlab-runner .\nhelm delete --purge gitlab-runner\n```\n\n\n\n### 登录到gitlab-runner 镜像register注册\n> 以下大部分都是回车, 只有token需要手动输入(输入values.yaml中的runnerRegistrationToken即可)\n```\nbash-5.0$ gitlab-runner register\nRuntime platform                                    arch=amd64 os=linux pid=4257 revision=4c96e5ad version=12.9.0\nWARNING: Running in user-mode.                     \nWARNING: The user-mode requires you to manually start builds processing:\nWARNING: $ gitlab-runner run                       \nWARNING: Use sudo for system-mode:                 \nWARNING: $ sudo gitlab-runner...                   \n\nPlease enter the gitlab-ci coordinator URL (e.g. https://gitlab.zhangzw.com/):\n[http://gitlab.zhangzw.com]:\nPlease enter the gitlab-ci token for this runner:\ndjs47LiKFy-64FxAACp5\nPlease enter the gitlab-ci description for this runner:\n[gitlab-runner-gitlab-runner-6cf8c6bff4-rhhs5]:\nPlease enter the gitlab-ci tags for this runner (comma separated):\n\nRegistering runner... succeeded                     runner=djs47LiK\nPlease enter the executor: docker+machine, docker-ssh+machine, kubernetes, docker, docker-ssh, shell, ssh, virtualbox, custom, parallels:\n[kubernetes]:\nRunner registered successfully. Feel free to start it, but if its running already the config should be automatically reloaded!\nbash-5.0$\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 在项目的页面点击 Add Kubernetes Cluster -> Add existing cluster\n\n- 1. API URL 是你的集群的apiserver的地址， 一般可以通过输入kubectl cluster-info获取\n\n```\nkubectl cluster-info\n\nKubernetes master is running at https://master.k8s.io:16443\nKubeDNS is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\nMetrics-server is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy\n```\n\n- 2. CA证书\n\n> 由于我们在部署阶段需要去创建、删除一些资源对象，所以我们也需要对象的 RBAC 权限，这里为了简单，我们直接新建一个 ServiceAccount，绑定上一个cluster-admin的权限(gitlab-serviceAccount.yaml)\n```\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: gitlab\n  namespace: gitlab\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: gitlab\n  namespace: gitlab\nsubjects:\n  - kind: ServiceAccount\n    name: gitlab\n    namespace: gitlab\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\n```\n\n```\n#可以通过上面创建的 ServiceAccount 获取 CA 证书和 Token：\nkubectl get serviceaccount gitlab -n gitlab -o json | jq -r '.secrets[0].name'\ngitlab-token-9jlpr\n\n# 然后根据上面的Secret找到CA证书\nkubectl get secret gitlab-token-9jlpr -n gitlab -o json | jq -r '.data[\"ca.crt\"]' | base64 -d\nxxxxxCA证书内容xxxxx\n\n# 当然要找到对应的 Token 也很简单\nkubectl get secret gitlab-token-9jlpr  -n gitlab -o json | jq -r '.data.token' | base64 -d\nxxxxxxtoken值xxxx\n```\n\n> 然后复制对应的值贴到项目的k8s配置中即可\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n\n### 简单测试\n```\n#.gitlab-ci.yml\nimage: busybox\nstages:\n  - build\n  - deploy\nJob1:\n  stage: build\n  script:\n    - echo \"go go go !!!~\"\n  only:\n    - master\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"部署开始\"\n  only:\n    - master\n\n```\n\n![](//zhangzw001.github.io/images/45/03.png)\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### .gitlab-ci.yaml配置\n\n> 以下一些配置写到gitlab项目页面-> Settings -> CI/CD -> Variables\n> 其实也可以写到.gitlab-ca.yaml中, 我在deployment.yaml也无法用如下变量\n\n```\nCI_REGISTRY_USER: admin\nCI_REGISTRY_PASSWORD: xxxxx\nCI_REGISTRY: hub.xxx.com\nCI_REGISTRY_IMAGE: hub.xxx.com/public/nginx\n```\n\n\n```\nvariables:\n  GIT_CURL_VERBOSE: 1\n  GIT_TRACE: 1\n\nstages:\n  - release\n  - review\n  - deploy\n\n\n\nbuildPushImage:\n  stage: release\n  image: docker:latest\n  services:\n    - name: docker:dind\n      command: [\"--insecure-registry=hub.zhangzw.com\"]\n  variables:\n    DOCKER_DRIVER: overlay2\n    DOCKER_HOST: tcp://192.168.0.136:2375\n  script:\n    - docker login -u \"${CI_REGISTRY_USER}\" -p \"${CI_REGISTRY_PASSWORD}\" \"${CI_REGISTRY}\"\n    - docker build -t \"${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}\" .\n    - docker push \"${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}\"\n\ndeploy_review:\n  image: bitnami/kubectl:1.16.3\n  stage: review\n  only:\n    - branches\n  except:\n    - tags\n  environment:\n    name: dev\n    url: http://dev-gitlab-k8s-demo.zhangzw.com\n    on_stop: stop_review\n  script:\n    - kubectl version\n    - cd deploy/\n    - sed -i \"s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/\" deployment.yaml ingress.yaml service.yaml\n    - sed -i \"s/__VERSION__/${CI_COMMIT_REF_NAME}/\" deployment.yaml ingress.yaml service.yaml\n    - |\n      if kubectl apply -f deployment.yaml | grep -q unchanged; then\n          echo \"=> Patching deployment to force image update.\"\n          kubectl patch -f deployment.yaml -p \"{\\\"spec\\\":{\\\"template\\\":{\\\"metadata\\\":{\\\"annotations\\\":{\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"}}}}}\"\n      else\n          echo \"=> Deployment apply has changed the object, no need to force image update.\"\n      fi\n    - kubectl apply -f service.yaml || true\n    - kubectl apply -f ingress.yaml\n    - kubectl rollout status -f deployment.yaml\n    - kubectl get all,ing -l ref=${CI_ENVIRONMENT_SLUG}\n\n\nstop_review:\n  image: bitnami/kubectl:1.16.3\n  stage: review\n  variables:\n    GIT_STRATEGY: none\n  when: manual\n  only:\n    - branches\n  except:\n    - master\n    - tags\n  environment:\n    name: dev\n    action: stop\n  script:\n    - kubectl version\n    - kubectl delete ing -l ref=${CI_ENVIRONMENT_SLUG}\n    - kubectl delete all -l ref=${CI_ENVIRONMENT_SLUG}\n\n\ndeploy_live:\n  image: bitnami/kubectl:1.16.3\n  stage: deploy\n  environment:\n    name: live\n    url: http://live-gitlab-k8s-demo.zhangzw.com\n  script:\n    - echo \"部署开始\"\n    - cd deploy\n    - sed -i \"s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/\" deployment.yaml ingress.yaml service.yaml\n    - sed -i \"s/__VERSION__/${CI_COMMIT_REF_NAME}/\" deployment.yaml ingress.yaml service.yaml\n    - kubectl apply -f deployment.yaml\n    - kubectl apply -f service.yaml\n    - kubectl apply -f ingress.yaml\n    - kubectl rollout status -f deployment.yaml\n    - kubectl get all,ing -l ref=${CI_ENVIRONMENT_SLUG}\n  only:\n    - tags\n  when: manual\n\n```\n\n\n### deploy/deployment.yaml\n```\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__\n  labels:\n    app: gitlab-k8s-demo\n    ref: __CI_ENVIRONMENT_SLUG__\n    track: stable\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: gitlab-k8s-demo\n      ref: __CI_ENVIRONMENT_SLUG__\n  template:\n    metadata:\n      labels:\n        app: gitlab-k8s-demo\n        ref: __CI_ENVIRONMENT_SLUG__\n        track: stable\n    spec:\n      imagePullSecrets:\n        - name: myregistry\n      containers:\n      - name: app\n        image: hub.zhangzw.com/bq/nginx:__VERSION__\n        imagePullPolicy: Always\n        ports:\n        - name: http-metrics\n          protocol: TCP\n          containerPort: 80\n        livenessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 3\n          timeoutSeconds: 2\n        readinessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 3\n          timeoutSeconds: 2\n```\n\n\n### 如果我们harbor中设置的是私有镜像, 则需要设置imagePullSecret 才能拉取镜像\n```\nkubectl create secret docker-registry gitlab-hub-secret --docker-server=hub.zhangzw.com --docker-username=xxx --docker-password=xxx --docker-email=zhangzw@zhangzw.com\n```\n\n\n\n### deploy/service.yaml\n```\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__\n  labels:\n    app: gitlab-k8s-demo\n    ref: __CI_ENVIRONMENT_SLUG__\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"80\"\n    prometheus.io/scheme: \"http\"\n    prometheus.io/path: \"/\"\nspec:\n  type: ClusterIP\n  ports:\n    - name: http-metrics\n      port: 80\n      protocol: TCP\n  selector:\n    app: gitlab-k8s-demo\n    ref: __CI_ENVIRONMENT_SLUG__\n```\n\n### deploy/ingress.yaml\n```\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__\n  labels:\n    app: gitlab-k8s-demo\n    ref: __CI_ENVIRONMENT_SLUG__\n  annotations:\n    kubernetes.io/ingress.class: \"traefik\"\nspec:\n  rules:\n  - host: __CI_ENVIRONMENT_SLUG__-gitlab-k8s-demo.zhangzw.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__\n          servicePort: 80\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n\n\n### 遇到的问题\n\n#### err1.  流水线打包的时候提示没有权限\n\n```\nERROR: Job failed (system failure): pods is forbidden: User \"system:serviceaccount:default:default\" cannot create resource \"pods\" in API group \"\" in the namespace \"default\"\n\n\nkubectl create serviceaccount  gitlab-cluster-admin\nkubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default\n```\n\n\n#### err2. 流水线打包提示无法拉取项目\n\n```\nfatal: unable to access 'http://gitlab.zhangzw.com/k8s/rancher-dev-php.git/': Failed to connect to gitlab.zhangzw.com port 80: Connection refused\nUploading artifacts for failed job\nERROR: Job failed: command terminated with exit code 1\n```\n\n> 难道是因为我们的项目是私有项目?\n\n显然我们在官网 https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html 这里看到下面一句话\n```\nOnly if the clone_url is set, the runner will construct a clone URL in the form of http://gitlab-ci-token:s3cr3tt0k3n@192.168.1.23/namespace/project.git.\n\n# 尝试修改 values.yaml\ncloneUrl: http://gitlab.zhangzw.com\n```\n\n> 之后还是出现了该问题\n\n> 所以这应该是gitlab-runner register的问题\n\n> 但是这里诡异的是, 我三个步骤,前两个都是正常, 第三个一直是报错connection refused, 但是我重试了三遍又正常了, 这么不稳定的吗?\n\n![](//zhangzw001.github.io/images/45/01.png)\n\n> 看日志错误有点像是这么回事, 我的nginx反向代理了gitlab.zhangzw.com proxy_pass的是ip:10080, 而日志中看起来报错提示是链接到ip:80\n\n我这里试着将helm安装gitlab-runner的配置文件values.yaml修改如下:\n\n```\ngitlabUrl: http://192.168.0.65:10080\n  cloneUrl: http://192.168.0.65:10080\n```\n\n> 测试之后还是会出现无法连接, 所以也不是这个问题, 这里git clone http 方式经过nginx代理是没问题的\n\n如果是项目权限问题, 那我新建一个public项目应该不会报错\n\n> 测试之后还是会出现无法连接, 看起问题还是网络方面问题, 为什么会网络无法连接呢?\n\n嗯??? 我查看了下 gitlab admin -> runners -> 点击Runner token 进入 -> Assigned projects  这里我之前是加过的, 但是helm 安装的gitlab-runner upgrade之后就好像丢失了, 可能是我这边没有mount数据存储到nfs, 不过这里可以不用按照分配的方式, 就设置为share即可,如果有多个runner,需要更细致的权限部署划分,可以设置\n\n所以现在这个问题就变成, 有可能第一次会成功, 有可能会失败, 有可能第二个步骤失败 , 然后retry 2次?3次或6次又成功了, 蛋疼中...\n\n`2020-04-24 15:58:40 补:  我这边测试的gitlab-runner安装的网段和gitlab的网段之间网络问题,  现在新搭建的gitlab-runner和gitlab在同一网段就不在报错了...`\n\n\n\n#### err3. k8s1.16安装helm2.14的有报错: Error: error installing: the server could not find the requested resource, 这是由于 extensions/v1beta1 已经被 apps/v1 替代。相信在2.15 或者 3 版本发布之后, 应该就不会遇到这个问题了。还是生态比较慢的原因。\n\n```\nhelm init -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.3 --stable-repo-url http://mirror.azure.cn/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.'name'='tiller',spec.selector.matchLabels.'app'='helm' --output yaml | sed 's@apiVersion: extensions/v1beta1@apiVersion: apps/v1@' | kubectl apply -f -\n```\n\n#### err4. Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?\n```\n不确定为什么会报这个错误, 第二次启动又没问题了\n```\n\n\n#### err5. time=\"2020-04-22T02:39:12Z\" level=error msg=\"failed to dial gRPC: cannot connect to the Docker daemon. Is 'docker daemon' running on this host?: dial tcp 127.0.0.1:2375: connect: connection refused\"\n```\n这种情况需要docker或者k8s的docker启动方式添加tcp方式\nvim /usr/lib/systemd/system/docker.service\nExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock -H fd:// --containerd=/run/containerd/containerd.sock\n```\n\n","content":"<p>本文介绍如何通过gitlab-ci整合k8s实现流水线部署</p>\n<a id=\"more\"></a>\n\n\n<blockquote>\n<ol>\n<li><a href=\"https://www.cnblogs.com/Sinte-Beuve/p/11739196.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/Sinte-Beuve/p/11739196.html</a></li>\n<li><a href=\"https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/\" target=\"_blank\" rel=\"noopener\">https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/</a></li>\n</ol>\n</blockquote>\n<h3 id=\"环境版本统计\"><a href=\"#环境版本统计\" class=\"headerlink\" title=\"环境版本统计\"></a>环境版本统计</h3><figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>gitlab/gitlab-runner <span class=\"number\">0.15.0</span></span><br><span class=\"line\"><span class=\"symbol\">2 </span>helm <span class=\"number\">2.16</span></span><br><span class=\"line\"><span class=\"symbol\">3 </span>k8s <span class=\"number\">1.16.4</span></span><br><span class=\"line\"><span class=\"symbol\">4 </span>gitlab <span class=\"number\">11.5</span></span><br><span class=\"line\"><span class=\"symbol\">5 </span>CentOS Linux release <span class=\"number\">7.7</span> /kernel <span class=\"number\">5.2</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>小节</p>\n</blockquote>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>. gitlab 通过admin管理页面的runner配置, 安装gitlab-runner, 安装方式可以是二进制, docker 或k8s (这里是k8s)</span><br><span class=\"line\"><span class=\"number\">2</span>. <span class=\"function\"><span class=\"title\">gitlab</span> 项目目录的 Operations -&gt;</span> <span class=\"function\"><span class=\"title\">kubernetes</span> -&gt;</span> A<span class=\"function\"><span class=\"title\">dd</span> Kubernetes Cluster -&gt;</span> Add existing cluster 是结合k8s, 每个项目都需要设置一个k8s集群,k8s集群需要配置rbac权限</span><br><span class=\"line\"><span class=\"number\">3</span>. ci 在提交到私有harbor上是需要验证账号密码, 私有仓库拉取也需要验证</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 安装方法一 </font>\n</center>\n\n<h3 id=\"k8s-yaml直接部署\"><a href=\"#k8s-yaml直接部署\" class=\"headerlink\" title=\"k8s yaml直接部署\"></a>k8s yaml直接部署</h3><h4 id=\"gitlab-ci-token-secret-yaml\"><a href=\"#gitlab-ci-token-secret-yaml\" class=\"headerlink\" title=\"gitlab-ci-token-secret.yaml\"></a>gitlab-ci-token-secret.yaml</h4><blockquote>\n<p>具体token值 请查看 gitlab的admin页面-&gt; Overview -&gt; Runners 查看, 然后base64加密</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci-token</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  GITLAB_CI_TOKEN:</span> <span class=\"string\">$(echo</span> <span class=\"string\">\"gitlab_ci_token\"</span><span class=\"string\">|base64)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"runner-configmap-yaml\"><a href=\"#runner-configmap-yaml\" class=\"headerlink\" title=\"runner-configmap.yaml\"></a>runner-configmap.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci-runner-cm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  REGISTER_NON_INTERACTIVE:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">  REGISTER_LOCKED:</span> <span class=\"string\">\"false\"</span></span><br><span class=\"line\"><span class=\"attr\">  METRICS_SERVER:</span> <span class=\"string\">\"0.0.0.0:9100\"</span></span><br><span class=\"line\"><span class=\"attr\">  CI_SERVER_URL:</span> <span class=\"string\">\"http://gitlab.xxx.com/ci\"</span></span><br><span class=\"line\"><span class=\"attr\">  RUNNER_REQUEST_CONCURRENCY:</span> <span class=\"string\">\"4\"</span></span><br><span class=\"line\"><span class=\"attr\">  RUNNER_EXECUTOR:</span> <span class=\"string\">\"kubernetes\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_NAMESPACE:</span> <span class=\"string\">\"kube-ops\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_PRIVILEGED:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_CPU_LIMIT:</span> <span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_MEMORY_LIMIT:</span> <span class=\"string\">\"1Gi\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_SERVICE_CPU_LIMIT:</span> <span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_SERVICE_MEMORY_LIMIT:</span> <span class=\"string\">\"1Gi\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_HELPER_CPU_LIMIT:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_HELPER_MEMORY_LIMIT:</span> <span class=\"string\">\"100Mi\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_PULL_POLICY:</span> <span class=\"string\">\"if-not-present\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_TERMINATIONGRACEPERIODSECONDS:</span> <span class=\"string\">\"10\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_POLL_INTERVAL:</span> <span class=\"string\">\"5\"</span></span><br><span class=\"line\"><span class=\"attr\">  KUBERNETES_POLL_TIMEOUT:</span> <span class=\"string\">\"360\"</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"runner-rbac-yaml\"><a href=\"#runner-rbac-yaml\" class=\"headerlink\" title=\"runner-rbac.yaml\"></a>runner-rbac.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"*\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"*\"]</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"runner-scripts-cm-yaml\"><a href=\"#runner-scripts-cm-yaml\" class=\"headerlink\" title=\"runner-scripts-cm.yaml\"></a>runner-scripts-cm.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">run.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    #!/bin/bash</span></span><br><span class=\"line\"><span class=\"string\">    unregister() &#123;</span></span><br><span class=\"line\"><span class=\"string\">        kill %1</span></span><br><span class=\"line\"><span class=\"string\">        echo \"Unregistering runner $&#123;RUNNER_NAME&#125; ...\"</span></span><br><span class=\"line\"><span class=\"string\">        /usr/bin/gitlab-ci-multi-runner unregister -t \"$(/usr/bin/gitlab-ci-multi-runner list 2&gt;&amp;1 | tail -n1 | awk '&#123;print $4&#125;' | cut -d'=' -f2)\" -n $&#123;RUNNER_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">        exit $?</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    trap 'unregister' EXIT HUP INT QUIT PIPE TERM</span></span><br><span class=\"line\"><span class=\"string\">    echo \"Registering runner $&#123;RUNNER_NAME&#125; ...\"</span></span><br><span class=\"line\"><span class=\"string\">    /usr/bin/gitlab-ci-multi-runner register -r $&#123;GITLAB_CI_TOKEN&#125;</span></span><br><span class=\"line\"><span class=\"string\">    sed -i 's/^concurrent.*/concurrent = '\"$&#123;RUNNER_REQUEST_CONCURRENCY&#125;\"'/' /home/gitlab-runner/.gitlab-runner/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    echo \"Starting runner $&#123;RUNNER_NAME&#125; ...\"</span></span><br><span class=\"line\"><span class=\"string\">    /usr/bin/gitlab-ci-multi-runner run -n $&#123;RUNNER_NAME&#125; &amp;</span></span><br><span class=\"line\"><span class=\"string\">    wait</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci-runner-scripts</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"runner-statefulset-yaml\"><a href=\"#runner-statefulset-yaml\" class=\"headerlink\" title=\"runner-statefulset.yaml\"></a>runner-statefulset.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">kube-ops</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  updateStrategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">gitlab-ci-runner-scripts</span></span><br><span class=\"line\"><span class=\"attr\">        projected:</span></span><br><span class=\"line\"><span class=\"attr\">          sources:</span></span><br><span class=\"line\"><span class=\"attr\">          - configMap:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">gitlab-ci-runner-scripts</span></span><br><span class=\"line\"><span class=\"attr\">              items:</span></span><br><span class=\"line\"><span class=\"attr\">              - key:</span> <span class=\"string\">run.sh</span></span><br><span class=\"line\"><span class=\"attr\">                path:</span> <span class=\"string\">run.sh</span></span><br><span class=\"line\"><span class=\"attr\">                mode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccountName:</span> <span class=\"string\">gitlab-ci</span></span><br><span class=\"line\"><span class=\"attr\">      securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">        runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">        runAsUser:</span> <span class=\"number\">999</span></span><br><span class=\"line\"><span class=\"attr\">        supplementalGroups:</span> <span class=\"string\">[999]</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - image:</span> <span class=\"string\">gitlab/gitlab-runner:latest</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">gitlab-ci-runner</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"800m\"</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">/scripts/run.sh</span></span><br><span class=\"line\"><span class=\"attr\">        envFrom:</span></span><br><span class=\"line\"><span class=\"attr\">        - configMapRef:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">gitlab-ci-runner-cm</span></span><br><span class=\"line\"><span class=\"attr\">        - secretRef:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">gitlab-ci-token</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">RUNNER_NAME</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">9100</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">http-metrics</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">gitlab-ci-runner-scripts</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/scripts\"</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      restartPolicy:</span> <span class=\"string\">Always</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"部署和检查\"><a href=\"#部署和检查\" class=\"headerlink\" title=\"部署和检查\"></a>部署和检查</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span> <span class=\"string\">../</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">all</span> <span class=\"bullet\">-n</span> <span class=\"string\">kube-ops</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 安装方法二 </font>\n</center>\n\n<h3 id=\"helm2-16安装\"><a href=\"#helm2-16安装\" class=\"headerlink\" title=\"helm2.16安装\"></a>helm2.16安装</h3><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https:<span class=\"comment\">//get.helm.sh/helm-v2.16.2-linux-amd64.tar.gz</span></span><br><span class=\"line\">tar -xvf helm-v2.<span class=\"number\">16.2</span>-linux-amd64<span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create serviceaccount --namespace=kube-system tiller</span><br><span class=\"line\">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class=\"line\"></span><br><span class=\"line\">helm init --upgrade -<span class=\"selector-tag\">i</span> registry<span class=\"selector-class\">.cn-hangzhou</span><span class=\"selector-class\">.aliyuncs</span><span class=\"selector-class\">.com</span>/google_containers/tiller:v2.<span class=\"number\">16.2</span> --stable-repo-url https:<span class=\"comment\">//kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --service-account tiller</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"//zhangzw001.github.io/images/45/02.png\" alt></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"从官方拉取helm2-配置文件\"><a href=\"#从官方拉取helm2-配置文件\" class=\"headerlink\" title=\"从官方拉取helm2 配置文件\"></a>从官方拉取helm2 配置文件</h3><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加源</span></span><br><span class=\"line\">helm repo <span class=\"built_in\">add</span> gitlab <span class=\"keyword\">https</span>://charts.gitlab.io</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\">helm search runner</span><br><span class=\"line\">gitlab/gitlab-runner <span class=\"number\">0.15</span><span class=\"number\">.0</span>        <span class=\"number\">12.9</span><span class=\"number\">.0</span>      GitLab Runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载charts压缩包gitlab-runner-0.15.0.tgz</span></span><br><span class=\"line\">helm fetch gitlab/gitlab-runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建gitlab-runner的rbac账号</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">create</span> serviceaccount  gitlab-cluster-admin</span><br><span class=\"line\">kubectl <span class=\"built_in\">create</span> clusterrolebinding gitlab-cluster-admin <span class=\"comment\">--clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 然后修改 values.yaml</span></span><br><span class=\"line\">gitlabUrl: <span class=\"keyword\">http</span>://gitlab.zhangzw.com <span class=\"comment\">#gitlab服务器上管理页面上的URL</span></span><br><span class=\"line\">runnerRegistrationToken: <span class=\"comment\">#gitlab服务器管理页面的token</span></span><br><span class=\"line\">serviceAccountName: gitlab-cluster-admin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改 templates/configmap.yaml (如果后面配置dind采用tcp://0.0.0.0:2375的方式应该不用挂载sock文件)</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! sh /scripts/register-<span class=\"keyword\">the</span>-runner; <span class=\"keyword\">then</span></span><br><span class=\"line\">      exit <span class=\"number\">1</span></span><br><span class=\"line\">    fi</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># add new config start</span></span><br><span class=\"line\">    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;<span class=\"literal\">EOF</span></span><br><span class=\"line\">      [[runners.kubernetes.volumes.host_path]]</span><br><span class=\"line\">            name = <span class=\"string\">\"docker\"</span></span><br><span class=\"line\">            mount_path = <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">            read_only = <span class=\"literal\">false</span></span><br><span class=\"line\">            host_path = <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">    <span class=\"literal\">EOF</span></span><br><span class=\"line\">    <span class=\"comment\"># add new config end</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Start the runner</span></span><br><span class=\"line\">    exec /entrypoint run <span class=\"comment\">--user=gitlab-runner \\</span></span><br><span class=\"line\">      <span class=\"comment\">--working-directory=/home/gitlab-runner</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># helm启动,更新,删除gitlab-runner</span></span><br><span class=\"line\">helm install  <span class=\"comment\">--name gitlab-runner .</span></span><br><span class=\"line\">helm upgrade gitlab-runner .</span><br><span class=\"line\">helm <span class=\"built_in\">delete</span> <span class=\"comment\">--purge gitlab-runner</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"登录到gitlab-runner-镜像register注册\"><a href=\"#登录到gitlab-runner-镜像register注册\" class=\"headerlink\" title=\"登录到gitlab-runner 镜像register注册\"></a>登录到gitlab-runner 镜像register注册</h3><blockquote>\n<p>以下大部分都是回车, 只有token需要手动输入(输入values.yaml中的runnerRegistrationToken即可)</p>\n</blockquote>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bash-5.0$ gitlab-runner register</span><br><span class=\"line\">Runtime platform                                    arch=amd64 os=linux pid=4257 revision=4c96e5ad version=12.9.0</span><br><span class=\"line\"><span class=\"symbol\">WARNING: </span>Running in user-mode.                     </span><br><span class=\"line\"><span class=\"symbol\">WARNING: </span>The user-mode requires you to manually start builds processing:</span><br><span class=\"line\"><span class=\"symbol\">WARNING: </span>$ gitlab-runner run                       </span><br><span class=\"line\"><span class=\"symbol\">WARNING: </span>Use sudo for system-mode:                 </span><br><span class=\"line\"><span class=\"symbol\">WARNING: </span>$ sudo gitlab-runner...                   </span><br><span class=\"line\"></span><br><span class=\"line\">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.zhangzw.com/):</span><br><span class=\"line\">[http://gitlab.zhangzw.com]:</span><br><span class=\"line\">Please enter the gitlab-ci token for this runner:</span><br><span class=\"line\">djs47LiKFy-64FxAACp5</span><br><span class=\"line\">Please enter the gitlab-ci description for this runner:</span><br><span class=\"line\">[gitlab-runner-gitlab-runner-6cf8c6bff4-rhhs5]:</span><br><span class=\"line\">Please enter the gitlab-ci tags for this runner (comma separated):</span><br><span class=\"line\"></span><br><span class=\"line\">Registering runner... succeeded                     runner=djs47LiK</span><br><span class=\"line\">Please enter the executor: docker<span class=\"code\">+machine, docker-ssh+</span>machine, kubernetes, docker, docker-ssh, shell, ssh, virtualbox, custom, parallels:</span><br><span class=\"line\">[kubernetes]:</span><br><span class=\"line\">Runner registered successfully. Feel free to start it, but if its running already the config should be automatically reloaded!</span><br><span class=\"line\">bash-5.0$</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"在项目的页面点击-Add-Kubernetes-Cluster-gt-Add-existing-cluster\"><a href=\"#在项目的页面点击-Add-Kubernetes-Cluster-gt-Add-existing-cluster\" class=\"headerlink\" title=\"在项目的页面点击 Add Kubernetes Cluster -&gt; Add existing cluster\"></a>在项目的页面点击 Add Kubernetes Cluster -&gt; Add existing cluster</h3><ul>\n<li><ol>\n<li>API URL 是你的集群的apiserver的地址， 一般可以通过输入kubectl cluster-info获取</li>\n</ol>\n</li>\n</ul>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl cluster-info</span><br><span class=\"line\"></span><br><span class=\"line\">Kubernetes master <span class=\"keyword\">is</span> running at http<span class=\"variable\">s:</span>//master.k8s.io:<span class=\"number\">16443</span></span><br><span class=\"line\">KubeDNS <span class=\"keyword\">is</span> running at http<span class=\"variable\">s:</span>//master.k8s.io:<span class=\"number\">16443</span>/api/v1/namespaces/kube-<span class=\"built_in\">system</span>/services/kube-dn<span class=\"variable\">s:dns</span>/proxy</span><br><span class=\"line\">Metrics-server <span class=\"keyword\">is</span> running at http<span class=\"variable\">s:</span>//master.k8s.io:<span class=\"number\">16443</span>/api/v1/namespaces/kube-<span class=\"built_in\">system</span>/services/http<span class=\"variable\">s:metrics</span>-server:/proxy</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><ol start=\"2\">\n<li>CA证书</li>\n</ol>\n</li>\n</ul>\n<blockquote>\n<p>由于我们在部署阶段需要去创建、删除一些资源对象，所以我们也需要对象的 RBAC 权限，这里为了简单，我们直接新建一个 ServiceAccount，绑定上一个cluster-admin的权限(gitlab-serviceAccount.yaml)</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">gitlab</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">cluster-admin</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#可以通过上面创建的 ServiceAccount 获取 CA 证书和 Token：</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">get</span> serviceaccount gitlab -n gitlab -o json | jq -r <span class=\"string\">'.secrets[0].name'</span></span><br><span class=\"line\">gitlab-<span class=\"keyword\">token</span><span class=\"number\">-9</span>jlpr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 然后根据上面的Secret找到CA证书</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">get</span> secret gitlab-<span class=\"keyword\">token</span><span class=\"number\">-9</span>jlpr -n gitlab -o json | jq -r <span class=\"string\">'.data[\"ca.crt\"]'</span> | base64 -d</span><br><span class=\"line\">xxxxxCA证书内容xxxxx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当然要找到对应的 Token 也很简单</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">get</span> secret gitlab-<span class=\"keyword\">token</span><span class=\"number\">-9</span>jlpr  -n gitlab -o json | jq -r <span class=\"string\">'.data.token'</span> | base64 -d</span><br><span class=\"line\">xxxxxxtoken值xxxx</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>然后复制对应的值贴到项目的k8s配置中即可</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n\n<h3 id=\"简单测试\"><a href=\"#简单测试\" class=\"headerlink\" title=\"简单测试\"></a>简单测试</h3><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#.gitlab-ci.yml</span></span><br><span class=\"line\"><span class=\"symbol\">image:</span> busybox</span><br><span class=\"line\"><span class=\"symbol\">stages:</span></span><br><span class=\"line\">  - build</span><br><span class=\"line\">  - deploy</span><br><span class=\"line\"><span class=\"symbol\">Job1:</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> build</span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - echo <span class=\"string\">\"go go go !!!~\"</span></span><br><span class=\"line\"><span class=\"symbol\">  only:</span></span><br><span class=\"line\">    - master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">deploy:</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> deploy</span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - echo <span class=\"string\">\"部署开始\"</span></span><br><span class=\"line\"><span class=\"symbol\">  only:</span></span><br><span class=\"line\">    - master</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"//zhangzw001.github.io/images/45/03.png\" alt></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"gitlab-ci-yaml配置\"><a href=\"#gitlab-ci-yaml配置\" class=\"headerlink\" title=\".gitlab-ci.yaml配置\"></a>.gitlab-ci.yaml配置</h3><blockquote>\n<p>以下一些配置写到gitlab项目页面-&gt; Settings -&gt; CI/CD -&gt; Variables<br>其实也可以写到.gitlab-ca.yaml中, 我在deployment.yaml也无法用如下变量</p>\n</blockquote>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CI_REGISTRY_USER: admin</span><br><span class=\"line\">CI_REGISTRY_PASSWORD: xxxxx</span><br><span class=\"line\">CI_REGISTRY: hub<span class=\"selector-class\">.xxx</span><span class=\"selector-class\">.com</span></span><br><span class=\"line\">CI_REGISTRY_IMAGE: hub<span class=\"selector-class\">.xxx</span><span class=\"selector-class\">.com</span>/public/nginx</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">variables:</span></span><br><span class=\"line\"><span class=\"symbol\">  GIT_CURL_VERBOSE:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"symbol\">  GIT_TRACE:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">stages:</span></span><br><span class=\"line\">  - release</span><br><span class=\"line\">  - review</span><br><span class=\"line\">  - deploy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">buildPushImage:</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> release</span><br><span class=\"line\"><span class=\"symbol\">  image:</span> docker:latest</span><br><span class=\"line\"><span class=\"symbol\">  services:</span></span><br><span class=\"line\">    - name: docker:dind</span><br><span class=\"line\"><span class=\"symbol\">      command:</span> [<span class=\"string\">\"--insecure-registry=hub.zhangzw.com\"</span>]</span><br><span class=\"line\"><span class=\"symbol\">  variables:</span></span><br><span class=\"line\"><span class=\"symbol\">    DOCKER_DRIVER:</span> overlay2</span><br><span class=\"line\"><span class=\"symbol\">    DOCKER_HOST:</span> tcp:<span class=\"comment\">//192.168.0.136:2375</span></span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - docker login -u <span class=\"string\">\"$&#123;CI_REGISTRY_USER&#125;\"</span> -p <span class=\"string\">\"$&#123;CI_REGISTRY_PASSWORD&#125;\"</span> <span class=\"string\">\"$&#123;CI_REGISTRY&#125;\"</span></span><br><span class=\"line\">    - docker build -t <span class=\"string\">\"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;\"</span> .</span><br><span class=\"line\">    - docker push <span class=\"string\">\"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">deploy_review:</span></span><br><span class=\"line\"><span class=\"symbol\">  image:</span> bitnami/kubectl:<span class=\"number\">1.16</span><span class=\"number\">.3</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> review</span><br><span class=\"line\"><span class=\"symbol\">  only:</span></span><br><span class=\"line\">    - branches</span><br><span class=\"line\"><span class=\"symbol\">  except:</span></span><br><span class=\"line\">    - tags</span><br><span class=\"line\"><span class=\"symbol\">  environment:</span></span><br><span class=\"line\"><span class=\"symbol\">    name:</span> dev</span><br><span class=\"line\"><span class=\"symbol\">    url:</span> http:<span class=\"comment\">//dev-gitlab-k8s-demo.zhangzw.com</span></span><br><span class=\"line\"><span class=\"symbol\">    on_stop:</span> stop_review</span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - kubectl version</span><br><span class=\"line\">    - cd deploy/</span><br><span class=\"line\">    - sed -i <span class=\"string\">\"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/\"</span> deployment.yaml ingress.yaml service.yaml</span><br><span class=\"line\">    - sed -i <span class=\"string\">\"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/\"</span> deployment.yaml ingress.yaml service.yaml</span><br><span class=\"line\">    - |</span><br><span class=\"line\">      if kubectl apply -f deployment.yaml | grep -q unchanged; then</span><br><span class=\"line\">          echo <span class=\"string\">\"=&gt; Patching deployment to force image update.\"</span></span><br><span class=\"line\">          kubectl patch -f deployment.yaml -p <span class=\"string\">\"&#123;\\\"spec\\\":&#123;\\\"template\\\":&#123;\\\"metadata\\\":&#123;\\\"annotations\\\":&#123;\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"&#125;&#125;&#125;&#125;&#125;\"</span></span><br><span class=\"line\">      else</span><br><span class=\"line\">          echo <span class=\"string\">\"=&gt; Deployment apply has changed the object, no need to force image update.\"</span></span><br><span class=\"line\">      fi</span><br><span class=\"line\">    - kubectl apply -f service.yaml || true</span><br><span class=\"line\">    - kubectl apply -f ingress.yaml</span><br><span class=\"line\">    - kubectl rollout status -f deployment.yaml</span><br><span class=\"line\">    - kubectl get all,ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">stop_review:</span></span><br><span class=\"line\"><span class=\"symbol\">  image:</span> bitnami/kubectl:<span class=\"number\">1.16</span><span class=\"number\">.3</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> review</span><br><span class=\"line\"><span class=\"symbol\">  variables:</span></span><br><span class=\"line\"><span class=\"symbol\">    GIT_STRATEGY:</span> none</span><br><span class=\"line\"><span class=\"symbol\">  when:</span> manual</span><br><span class=\"line\"><span class=\"symbol\">  only:</span></span><br><span class=\"line\">    - branches</span><br><span class=\"line\"><span class=\"symbol\">  except:</span></span><br><span class=\"line\">    - master</span><br><span class=\"line\">    - tags</span><br><span class=\"line\"><span class=\"symbol\">  environment:</span></span><br><span class=\"line\"><span class=\"symbol\">    name:</span> dev</span><br><span class=\"line\"><span class=\"symbol\">    action:</span> stop</span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - kubectl version</span><br><span class=\"line\">    - kubectl delete ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span><br><span class=\"line\">    - kubectl delete all -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"symbol\">deploy_live:</span></span><br><span class=\"line\"><span class=\"symbol\">  image:</span> bitnami/kubectl:<span class=\"number\">1.16</span><span class=\"number\">.3</span></span><br><span class=\"line\"><span class=\"symbol\">  stage:</span> deploy</span><br><span class=\"line\"><span class=\"symbol\">  environment:</span></span><br><span class=\"line\"><span class=\"symbol\">    name:</span> live</span><br><span class=\"line\"><span class=\"symbol\">    url:</span> http:<span class=\"comment\">//live-gitlab-k8s-demo.zhangzw.com</span></span><br><span class=\"line\"><span class=\"symbol\">  script:</span></span><br><span class=\"line\">    - echo <span class=\"string\">\"部署开始\"</span></span><br><span class=\"line\">    - cd deploy</span><br><span class=\"line\">    - sed -i <span class=\"string\">\"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/\"</span> deployment.yaml ingress.yaml service.yaml</span><br><span class=\"line\">    - sed -i <span class=\"string\">\"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/\"</span> deployment.yaml ingress.yaml service.yaml</span><br><span class=\"line\">    - kubectl apply -f deployment.yaml</span><br><span class=\"line\">    - kubectl apply -f service.yaml</span><br><span class=\"line\">    - kubectl apply -f ingress.yaml</span><br><span class=\"line\">    - kubectl rollout status -f deployment.yaml</span><br><span class=\"line\">    - kubectl get all,ing -l ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span><br><span class=\"line\"><span class=\"symbol\">  only:</span></span><br><span class=\"line\">    - tags</span><br><span class=\"line\"><span class=\"symbol\">  when:</span> manual</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"deploy-deployment-yaml\"><a href=\"#deploy-deployment-yaml\" class=\"headerlink\" title=\"deploy/deployment.yaml\"></a>deploy/deployment.yaml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">    ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">    track:</span> <span class=\"string\">stable</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">      ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">        ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">        track:</span> <span class=\"string\">stable</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      imagePullSecrets:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">myregistry</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.zhangzw.com/bq/nginx:__VERSION__</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">http-metrics</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">          httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          initialDelaySeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">          timeoutSeconds:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">        readinessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">          httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          initialDelaySeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">          timeoutSeconds:</span> <span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如果我们harbor中设置的是私有镜像-则需要设置imagePullSecret-才能拉取镜像\"><a href=\"#如果我们harbor中设置的是私有镜像-则需要设置imagePullSecret-才能拉取镜像\" class=\"headerlink\" title=\"如果我们harbor中设置的是私有镜像, 则需要设置imagePullSecret 才能拉取镜像\"></a>如果我们harbor中设置的是私有镜像, 则需要设置imagePullSecret 才能拉取镜像</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create<span class=\"built_in\"> secret </span>docker-registry gitlab-hub-secret <span class=\"attribute\">--docker-server</span>=hub.zhangzw.com <span class=\"attribute\">--docker-username</span>=xxx <span class=\"attribute\">--docker-password</span>=xxx <span class=\"attribute\">--docker-email</span>=zhangzw@zhangzw.com</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"deploy-service-yaml\"><a href=\"#deploy-service-yaml\" class=\"headerlink\" title=\"deploy/service.yaml\"></a>deploy/service.yaml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">    ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">prometheus.io/scrape:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    <span class=\"string\">prometheus.io/port:</span> <span class=\"string\">\"80\"</span></span><br><span class=\"line\">    <span class=\"string\">prometheus.io/scheme:</span> <span class=\"string\">\"http\"</span></span><br><span class=\"line\">    <span class=\"string\">prometheus.io/path:</span> <span class=\"string\">\"/\"</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">http-metrics</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">    ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"deploy-ingress-yaml\"><a href=\"#deploy-ingress-yaml\" class=\"headerlink\" title=\"deploy/ingress.yaml\"></a>deploy/ingress.yaml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">gitlab-k8s-demo</span></span><br><span class=\"line\"><span class=\"attr\">    ref:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">kubernetes.io/ingress.class:</span> <span class=\"string\">\"traefik\"</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">__CI_ENVIRONMENT_SLUG__-gitlab-k8s-demo.zhangzw.com</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          serviceName:</span> <span class=\"string\">gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span></span><br><span class=\"line\"><span class=\"attr\">          servicePort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n\n\n<h3 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h3><h4 id=\"err1-流水线打包的时候提示没有权限\"><a href=\"#err1-流水线打包的时候提示没有权限\" class=\"headerlink\" title=\"err1.  流水线打包的时候提示没有权限\"></a>err1.  流水线打包的时候提示没有权限</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Job failed (system failure): pods is forbidden:<span class=\"built_in\"> User </span><span class=\"string\">\"system:serviceaccount:default:default\"</span> cannot create<span class=\"built_in\"> resource </span><span class=\"string\">\"pods\"</span> <span class=\"keyword\">in</span> API<span class=\"built_in\"> group </span><span class=\"string\">\"\"</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">\"default\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create serviceaccount  gitlab-cluster-admin</span><br><span class=\"line\">kubectl create clusterrolebinding gitlab-cluster-admin <span class=\"attribute\">--clusterrole</span>=cluster-admin <span class=\"attribute\">--group</span>=system:serviceaccounts <span class=\"attribute\">--namespace</span>=default</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"err2-流水线打包提示无法拉取项目\"><a href=\"#err2-流水线打包提示无法拉取项目\" class=\"headerlink\" title=\"err2. 流水线打包提示无法拉取项目\"></a>err2. 流水线打包提示无法拉取项目</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fatal: unable to access <span class=\"string\">'http://gitlab.zhangzw.com/k8s/rancher-dev-php.git/'</span>: Failed to connect to gitlab.zhangzw.com port <span class=\"number\">80</span>: Connection refused</span><br><span class=\"line\">Uploading artifacts <span class=\"keyword\">for</span> failed job</span><br><span class=\"line\">ERROR: Job failed: command terminated with <span class=\"keyword\">exit</span> code <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>难道是因为我们的项目是私有项目?</p>\n</blockquote>\n<p>显然我们在官网 <a href=\"https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html</a> 这里看到下面一句话</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Only <span class=\"keyword\">if</span> <span class=\"keyword\">the</span> clone_url is <span class=\"built_in\">set</span>, <span class=\"keyword\">the</span> runner will construct <span class=\"keyword\">a</span> clone <span class=\"built_in\">URL</span> <span class=\"keyword\">in</span> <span class=\"keyword\">the</span> form <span class=\"keyword\">of</span> <span class=\"keyword\">http</span>://gitlab-ci-<span class=\"keyword\">token</span>:s3cr3tt0k3n@<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.23</span>/namespace/project.git.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 尝试修改 values.yaml</span></span><br><span class=\"line\">cloneUrl: <span class=\"keyword\">http</span>://gitlab.zhangzw.com</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>之后还是出现了该问题</p>\n</blockquote>\n<blockquote>\n<p>所以这应该是gitlab-runner register的问题</p>\n</blockquote>\n<blockquote>\n<p>但是这里诡异的是, 我三个步骤,前两个都是正常, 第三个一直是报错connection refused, 但是我重试了三遍又正常了, 这么不稳定的吗?</p>\n</blockquote>\n<p><img src=\"//zhangzw001.github.io/images/45/01.png\" alt></p>\n<blockquote>\n<p>看日志错误有点像是这么回事, 我的nginx反向代理了gitlab.zhangzw.com proxy_pass的是ip:10080, 而日志中看起来报错提示是链接到ip:80</p>\n</blockquote>\n<p>我这里试着将helm安装gitlab-runner的配置文件values.yaml修改如下:</p>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gitlabUrl</span>: <span class=\"attribute\">http</span>:<span class=\"comment\">//192.168.0.65:10080</span></span><br><span class=\"line\">  <span class=\"attribute\">cloneUrl</span>: <span class=\"attribute\">http</span>:<span class=\"comment\">//192.168.0.65:10080</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>测试之后还是会出现无法连接, 所以也不是这个问题, 这里git clone http 方式经过nginx代理是没问题的</p>\n</blockquote>\n<p>如果是项目权限问题, 那我新建一个public项目应该不会报错</p>\n<blockquote>\n<p>测试之后还是会出现无法连接, 看起问题还是网络方面问题, 为什么会网络无法连接呢?</p>\n</blockquote>\n<p>嗯??? 我查看了下 gitlab admin -&gt; runners -&gt; 点击Runner token 进入 -&gt; Assigned projects  这里我之前是加过的, 但是helm 安装的gitlab-runner upgrade之后就好像丢失了, 可能是我这边没有mount数据存储到nfs, 不过这里可以不用按照分配的方式, 就设置为share即可,如果有多个runner,需要更细致的权限部署划分,可以设置</p>\n<p>所以现在这个问题就变成, 有可能第一次会成功, 有可能会失败, 有可能第二个步骤失败 , 然后retry 2次?3次或6次又成功了, 蛋疼中…</p>\n<p><code>2020-04-24 15:58:40 补:  我这边测试的gitlab-runner安装的网段和gitlab的网段之间网络问题,  现在新搭建的gitlab-runner和gitlab在同一网段就不在报错了...</code></p>\n<h4 id=\"err3-k8s1-16安装helm2-14的有报错-Error-error-installing-the-server-could-not-find-the-requested-resource-这是由于-extensions-v1beta1-已经被-apps-v1-替代。相信在2-15-或者-3-版本发布之后-应该就不会遇到这个问题了。还是生态比较慢的原因。\"><a href=\"#err3-k8s1-16安装helm2-14的有报错-Error-error-installing-the-server-could-not-find-the-requested-resource-这是由于-extensions-v1beta1-已经被-apps-v1-替代。相信在2-15-或者-3-版本发布之后-应该就不会遇到这个问题了。还是生态比较慢的原因。\" class=\"headerlink\" title=\"err3. k8s1.16安装helm2.14的有报错: Error: error installing: the server could not find the requested resource, 这是由于 extensions/v1beta1 已经被 apps/v1 替代。相信在2.15 或者 3 版本发布之后, 应该就不会遇到这个问题了。还是生态比较慢的原因。\"></a>err3. k8s1.16安装helm2.14的有报错: Error: error installing: the server could not find the requested resource, 这是由于 extensions/v1beta1 已经被 apps/v1 替代。相信在2.15 或者 3 版本发布之后, 应该就不会遇到这个问题了。还是生态比较慢的原因。</h4><figure class=\"highlight dsconfig\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">helm </span><span class=\"string\">init </span>-i <span class=\"string\">registry.</span><span class=\"string\">cn-hangzhou.</span><span class=\"string\">aliyuncs.</span><span class=\"string\">com/</span><span class=\"string\">google_containers/</span><span class=\"string\">tiller:v2.</span><span class=\"string\">14.</span>3 <span class=\"built_in\">--stable-repo-url</span> <span class=\"string\">http:</span>//<span class=\"string\">mirror.</span><span class=\"string\">azure.</span><span class=\"string\">cn/</span><span class=\"string\">kubernetes/</span><span class=\"string\">charts/</span> <span class=\"built_in\">--service-account</span> <span class=\"string\">tiller </span><span class=\"built_in\">--override</span> <span class=\"string\">spec.</span><span class=\"string\">selector.</span><span class=\"string\">matchLabels.</span><span class=\"string\">'name'</span>=<span class=\"string\">'tiller'</span>,<span class=\"string\">spec.</span><span class=\"string\">selector.</span><span class=\"string\">matchLabels.</span><span class=\"string\">'app'</span>=<span class=\"string\">'helm'</span> <span class=\"built_in\">--output</span> <span class=\"string\">yaml </span>| <span class=\"string\">sed </span><span class=\"string\">'s@apiVersion: extensions/v1beta1@apiVersion: apps/v1@'</span> | <span class=\"string\">kubectl </span><span class=\"string\">apply </span>-f -</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"err4-Cannot-connect-to-the-Docker-daemon-at-unix-var-run-docker-sock-Is-the-docker-daemon-running\"><a href=\"#err4-Cannot-connect-to-the-Docker-daemon-at-unix-var-run-docker-sock-Is-the-docker-daemon-running\" class=\"headerlink\" title=\"err4. Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?\"></a>err4. Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">不确定为什么会报这个错误, 第二次启动又没问题了</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"err5-time-”2020-04-22T02-39-12Z”-level-error-msg-”failed-to-dial-gRPC-cannot-connect-to-the-Docker-daemon-Is-‘docker-daemon’-running-on-this-host-dial-tcp-127-0-0-1-2375-connect-connection-refused”\"><a href=\"#err5-time-”2020-04-22T02-39-12Z”-level-error-msg-”failed-to-dial-gRPC-cannot-connect-to-the-Docker-daemon-Is-‘docker-daemon’-running-on-this-host-dial-tcp-127-0-0-1-2375-connect-connection-refused”\" class=\"headerlink\" title=\"err5. time=”2020-04-22T02:39:12Z” level=error msg=”failed to dial gRPC: cannot connect to the Docker daemon. Is ‘docker daemon’ running on this host?: dial tcp 127.0.0.1:2375: connect: connection refused”\"></a>err5. time=”2020-04-22T02:39:12Z” level=error msg=”failed to dial gRPC: cannot connect to the Docker daemon. Is ‘docker daemon’ running on this host?: dial tcp 127.0.0.1:2375: connect: connection refused”</h4><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这种情况需要docker或者k8s的docker启动方式添加tcp方式</span><br><span class=\"line\">vim /usr/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">systemd</span>/<span class=\"title\">system</span>/<span class=\"title\">docker</span>.<span class=\"title\">service</span></span></span><br><span class=\"line\">ExecStart=<span class=\"regexp\">/usr/bin</span><span class=\"regexp\">/dockerd -H tcp:/</span><span class=\"regexp\">/0.0.0.0:2375 -H unix:/</span><span class=\"regexp\">//var</span><span class=\"regexp\">/run/docker</span>.sock -H <span class=\"symbol\">fd:</span>/<span class=\"regexp\">/ --containerd=/run</span><span class=\"regexp\">/containerd/containerd</span>.sock</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/04/23/45-gitlab-ci与k8s结合/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"gitlab-ci","slug":"gitlab-ci","permalink":"https://blog.k1s.club/categories/gitlab-ci/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"gitlab-runner","slug":"gitlab-runner","permalink":"https://blog.k1s.club/tags/gitlab-runner/"}]},{"title":"k8s部署fluentd+kafka+logstash+es","date":"2020-04-09T09:40:58.000Z","path":"2020/04/09/44-k8s部署fluentd-kafka-logstash-es/","text":"客户端采集数据的软件比较多, 有logstash,flume,fluentd/fluent-bit,filebeat等,这里在k8s集群中部署fluentd开启UDP端口接收代码写入的json日志,并写入到kafka中 1. 一些服务版本123docker镜像: docker pull fluentd:v1.9.1-1.0kafka: kafka-server-0.10.0+kafka2.1.0-1.2.1.0.p0.63.el6.noarchfluent-plugin-kafka: 0.5.7 2. fluentd 镜像安装kafka扩展 Dockerfile 由于fluent-plugin-kafka版本要求我们的kafka是0.10, 所以高版本有问题, 安装了fluent-plugin-kafka 0.5.7 则正常 官方文档: https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7 123456789from fluentd:v1.9.1-1.0MAINTAINER zhangzw &lt;zhangzw@xxx.com&gt;USER rootRUN fluent-gem install fluent-plugin-kafka -v 0.5.7USER fluent 3. fluentd配置文件 fluent-udp-to-kafka.conf12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849&lt;source&gt; @type udp @label @mainstream tag udplog # required &lt;parse&gt; @type regexp expression /^(?&lt;message&gt;.*)$/ &lt;/parse&gt; port 12301 # optional. 5160 by default bind 0.0.0.0 # optional. 0.0.0.0 by default message_length_limit 1MB # optional. 4096 bytes by default&lt;/source&gt;&lt;filter **&gt; @type stdout&lt;/filter&gt;&lt;label @mainstream&gt; &lt;match **&gt; @type kafka2 # list of seed brokers，这个地方可以通过逗号写多个地址比如 host1:9092,host2:9092 brokers 192.168.xxx.142:9092 use_event_time true # buffer settings &lt;buffer topic&gt; @type file # 下面的path可能需要手动创建目录，并给写入权限，我直接给了777 path /fluentd/log/td-agent/buffer/td flush_interval 3s &lt;/buffer&gt; # data type settings &lt;format&gt; @type json &lt;/format&gt; # kafka中创建的topic topic_key udplog # 默认topic default_topic udplog get_kafka_client_log true # producer settings required_acks -1 compression_codec gzip &lt;/match&gt;&lt;/label&gt; 4. k8s部署 开启input udp 12301接收数据, 并output给kafka123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263k8s-fluentd-udplog-udp-to-kafka.yml---kind: DeploymentapiVersion: apps/v1beta2metadata: labels: elastic-app: fluentd-udplog name: fluentd-udplog namespace: ns-elastic7spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: elastic-app: fluentd-udplog template: metadata: labels: elastic-app: fluentd-udplog spec: containers: - name: fluentd-udplog image: hub.xxx.com/bq/fluentd:v1.9.1-1.0-kafka-0.10 ports: - containerPort: 12301 name: port12301 protocol: UDP resources: requests: cpu: \"50m\" limits: cpu: \"500m\" volumeMounts: - name: fluentd-udplog-logs mountPath: /fluentd/log - name: fluentd-udplog-cfg mountPath: /fluentd/etc/fluent.conf volumes: - name: fluentd-udplog-logs hostPath: path: /data/k8s-container/elk-7.2.0/fluentd/logs/ - name: fluentd-udplog-cfg hostPath: path: /data/k8s-container/elk-7.2.0/fluentd/fluent-udp-to-kafka.conf---kind: ServiceapiVersion: v1metadata: labels: elastic-app: fluentd-udplog name: fluentd-udplog-service-nodeport namespace: ns-elastic7spec: type: NodePort ports: - name: port12301 port: 12301 targetPort: 12301 nodePort: 12301 protocol: UDP selector: elastic-app: fluentd-udplog 5. 修改logstash的配置12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576config/pipeline/logstash.confinput &#123; kafka&#123; type =&gt;\"php-mysql-dev-252-log\" bootstrap_servers =&gt; \"192.168.xxx.142:9092\" topics =&gt; \"php-mysql-dev-0-slowlog\" &#125; kafka&#123; type =&gt;\"udplog\" bootstrap_servers =&gt; \"192.168.xxx.142:9092\" topics =&gt; \"udplog\" &#125;&#125;filter&#123;############### if [type] == \"php-mysql-dev-252-log\" &#123; json &#123; source =&gt; \"message\" &#125; mutate &#123; gsub =&gt; [ \"message\", \"\\n\", \"\" ] &#125; grok &#123; match =&gt; [\"message\",\"(?m)^# User@Host: %&#123;USER:user&#125;\\[[^\\]]+\\] @ \\[%&#123;IP:clientip&#125;\\]# Query_time: %&#123;NUMBER:query_time:float&#125;\\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;(?&lt;dbnameall&gt;.*)SET\\s+timestamp=%&#123;NUMBER:timestamp_mysql:int&#125;;(?&lt;query&gt;.*)\"] &#125; date &#123; match =&gt; [\"timestamp_mysql\", \"UNIX\"] target =&gt; \"@timestamp\" &#125; &#125;###### if [type] == \"udplog\" &#123; grok &#123; match =&gt; &#123; \"message\" =&gt; \"&lt;%&#123;NUMBER:id:int&#125;&gt;%&#123;NUMBER:id_N:int&#125; (?&lt;http_time&gt;\\S+) %&#123;DATA:hostname&#125; %&#123;DATA:ident&#125; %&#123;NUMBER:pid:int&#125; - - %&#123;DATA:logLevel&#125;: X-Request-Id:%&#123;DATA:Request_Id&#125; module:%&#123;DATA:moduleName&#125; act:%&#123;DATA:Act&#125; sql:(?&lt;sql&gt;(.*)) cost:%&#123;NUMBER:sqlDuring:int&#125;ms \\[\\] \\[\\]\" &#125; &#125; grok &#123; match =&gt; &#123;\"sql\" =&gt;\" %&#123;DATA:operation&#125; \"&#125; &#125; if \"_grokparsefailure\" not in [tags] &#123; if [sqlDuring] &lt; 5 &#123; drop &#123;&#125; &#125; &#125; else &#123; drop &#123;&#125; &#125; &#125;&#125;output &#123;### if [type] == \"php-mysql-dev-252-log\" &#123; elasticsearch &#123; hosts =&gt; [ \"http://192.168.xxx.120:19230\" ] index =&gt; \"php-mysql-dev-252-%&#123;+YYYY.MM.dd&#125;\" &#125; &#125;### if [type] == \"udplog\" &#123; elasticsearch &#123; hosts =&gt; [ \"http://192.168.xxx.120:19230\" ] index =&gt; \"udplog-%&#123;+YYYY.MM.dd&#125;\" &#125; &#125;&#125; 6. 部署k8s logstash 分析后写入到es中 k8s-logstash-7.2.0-kafka-to-es.yml12345678910111213141516171819202122232425262728293031323334353637---kind: DeploymentapiVersion: apps/v1beta2metadata: labels: elastic-app: slowlog-logstash-kafka-to-es name: slowlog-logstash-kafka-to-es namespace: ns-elastic7spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: elastic-app: slowlog-logstash-kafka-to-es template: metadata: labels: elastic-app: slowlog-logstash-kafka-to-es spec: containers: - name: slowlog-logstash-kafka-to-es image: hub.xxx.com/bq/logstash:7.2.0 resources: requests: cpu: \"50m\" limits: cpu: \"500m\" volumeMounts: - name: slowlog-toes-cfg mountPath: /usr/share/logstash/config volumes: - name: slowlog-toes-cfg hostPath: path: /data/k8s-container/elk-7.2.0/mysqlslowlog-logstash-7.2.0/config tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule","raw":"---\ntitle: k8s部署fluentd+kafka+logstash+es\ncopyright: true\ndate: 2020-04-09 17:40:58\ntags:\n  - fluentd\ncategories:\n  - [elk7]\n  - [fluentd]\n---\n\n客户端采集数据的软件比较多, 有logstash,flume,fluentd/fluent-bit,filebeat等,这里在k8s集群中部署fluentd开启UDP端口接收代码写入的json日志,并写入到kafka中\n<!--more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 1. 一些服务版本\n```\ndocker镜像: docker pull fluentd:v1.9.1-1.0\nkafka: kafka-server-0.10.0+kafka2.1.0-1.2.1.0.p0.63.el6.noarch\nfluent-plugin-kafka: 0.5.7\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 2. fluentd 镜像安装kafka扩展 Dockerfile\n> 由于fluent-plugin-kafka版本要求\n> 我们的kafka是0.10, 所以高版本有问题, 安装了fluent-plugin-kafka 0.5.7 则正常\n\n官方文档: [https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7](https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7)\n\n```\nfrom fluentd:v1.9.1-1.0\n\nMAINTAINER zhangzw <zhangzw@xxx.com>\n\nUSER root\n\nRUN fluent-gem install fluent-plugin-kafka -v 0.5.7\n\nUSER fluent\n\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 3. fluentd配置文件 fluent-udp-to-kafka.conf\n```\n\n<source>\n  @type udp\n  @label @mainstream\n  tag udplog # required\n  <parse>\n    @type regexp\n    expression /^(?<message>.*)$/\n  </parse>\n  port 12301               # optional. 5160 by default\n  bind 0.0.0.0             # optional. 0.0.0.0 by default\n  message_length_limit 1MB # optional. 4096 bytes by default\n</source>\n\n<filter **>\n  @type stdout\n</filter>\n\n<label @mainstream>\n  <match **>\n    @type kafka2\n\n    # list of seed brokers，这个地方可以通过逗号写多个地址比如 host1:9092,host2:9092\n    brokers 192.168.xxx.142:9092\n    use_event_time true\n\n    # buffer settings\n    <buffer topic>\n    @type file\n    # 下面的path可能需要手动创建目录，并给写入权限，我直接给了777\n    path /fluentd/log/td-agent/buffer/td\n    flush_interval 3s\n    </buffer>\n\n    # data type settings\n    <format>\n    @type json\n    </format>\n\n    # kafka中创建的topic\n    topic_key udplog\n    # 默认topic\n    default_topic udplog\n    get_kafka_client_log true\n    # producer settings\n    required_acks -1\n    compression_codec gzip\n  </match>\n</label>\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 4. k8s部署 开启input udp 12301接收数据, 并output给kafka\n```\nk8s-fluentd-udplog-udp-to-kafka.yml\n---\nkind: Deployment\napiVersion: apps/v1beta2\nmetadata:\n  labels:\n    elastic-app: fluentd-udplog\n  name: fluentd-udplog\n  namespace: ns-elastic7\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      elastic-app: fluentd-udplog\n  template:\n    metadata:\n      labels:\n        elastic-app: fluentd-udplog\n    spec:\n      containers:\n        - name: fluentd-udplog\n          image: hub.xxx.com/bq/fluentd:v1.9.1-1.0-kafka-0.10\n          ports:\n            - containerPort: 12301\n              name: port12301\n              protocol: UDP\n          resources:\n            requests:\n              cpu: \"50m\"\n            limits:\n              cpu: \"500m\"\n          volumeMounts:\n            - name: fluentd-udplog-logs\n              mountPath: /fluentd/log\n            - name: fluentd-udplog-cfg\n              mountPath: /fluentd/etc/fluent.conf\n      volumes:\n        - name: fluentd-udplog-logs\n          hostPath:\n            path: /data/k8s-container/elk-7.2.0/fluentd/logs/\n        - name: fluentd-udplog-cfg\n          hostPath:\n            path: /data/k8s-container/elk-7.2.0/fluentd/fluent-udp-to-kafka.conf\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   elastic-app: fluentd-udplog\n name: fluentd-udplog-service-nodeport\n namespace: ns-elastic7\nspec:\n type: NodePort\n ports:\n   - name: port12301\n     port: 12301\n     targetPort: 12301\n     nodePort: 12301\n     protocol: UDP\n selector:\n   elastic-app: fluentd-udplog\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 5. 修改logstash的配置\n\n```\nconfig/pipeline/logstash.conf\ninput {\n kafka{\n  type =>\"php-mysql-dev-252-log\"\n  bootstrap_servers => \"192.168.xxx.142:9092\"\n  topics => \"php-mysql-dev-0-slowlog\"\n }\n\n        kafka{\n                type =>\"udplog\"\n                bootstrap_servers => \"192.168.xxx.142:9092\"\n                topics => \"udplog\"\n        }\n\n}\n\n\n\nfilter{\n\n###############\n    if [type] == \"php-mysql-dev-252-log\" {\n \tjson {\n  \t\tsource => \"message\"\n \t}\n\n \tmutate {\n     \t\tgsub => [ \"message\", \"\\n\", \"\" ]\n  \t}\n \tgrok {\n  \t\tmatch => [\"message\",\"(?m)^# User@Host: %{USER:user}\\[[^\\]]+\\] @  \\[%{IP:clientip}\\]# Query_time: %{NUMBER:query_time:float}\\s+Lock_time: %{NUMBER:lock_time:float}\\s+Rows_sent: %{NUMBER:rows_sent:int}\\s+Rows_examined: %{NUMBER:rows_examined:int}(?<dbnameall>.*)SET\\s+timestamp=%{NUMBER:timestamp_mysql:int};(?<query>.*)\"]\n \t}\n \tdate {\n  \t\tmatch => [\"timestamp_mysql\", \"UNIX\"]\n  \t\ttarget => \"@timestamp\"\n \t}\n    }\n######\n    if [type] == \"udplog\" {\n \tgrok {\n          match => {\n            \"message\" => \"<%{NUMBER:id:int}>%{NUMBER:id_N:int} (?<http_time>\\S+) %{DATA:hostname} %{DATA:ident} %{NUMBER:pid:int} - - %{DATA:logLevel}: X-Request-Id:%{DATA:Request_Id} module:%{DATA:moduleName} act:%{DATA:Act} sql:(?<sql>(.*)) cost:%{NUMBER:sqlDuring:int}ms \\[\\] \\[\\]\"\n                }\n     \t}\n       \tgrok {\n         match => {\"sql\" =>\" %{DATA:operation} \"}\n       \t}\n\n   \tif \"_grokparsefailure\" not in [tags] {\n      \t if [sqlDuring] < 5 {\n          drop {}\n        }\n   }\n   else {\n    \t drop {}\n   \t}\n    }\n\n}\n\noutput {\n###\n   if [type] == \"php-mysql-dev-252-log\" {\n      elasticsearch {\n        hosts =>  [ \"http://192.168.xxx.120:19230\" ]\n        index => \"php-mysql-dev-252-%{+YYYY.MM.dd}\"\n      }\n   }\n###\n    if [type] == \"udplog\" {\n      elasticsearch {\n        hosts =>  [ \"http://192.168.xxx.120:19230\" ]\n        index => \"udplog-%{+YYYY.MM.dd}\"\n      }\n    }\n}\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 6. 部署k8s logstash 分析后写入到es中 k8s-logstash-7.2.0-kafka-to-es.yml\n```\n---\nkind: Deployment\napiVersion: apps/v1beta2\nmetadata:\n  labels:\n    elastic-app:  slowlog-logstash-kafka-to-es\n  name: slowlog-logstash-kafka-to-es\n  namespace: ns-elastic7\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      elastic-app: slowlog-logstash-kafka-to-es\n  template:\n    metadata:\n      labels:\n        elastic-app: slowlog-logstash-kafka-to-es\n    spec:\n      containers:\n        - name: slowlog-logstash-kafka-to-es\n          image: hub.xxx.com/bq/logstash:7.2.0\n          resources:\n            requests:\n              cpu: \"50m\"\n            limits:\n              cpu: \"500m\"\n          volumeMounts:\n            - name: slowlog-toes-cfg\n              mountPath: /usr/share/logstash/config\n      volumes:\n        - name: slowlog-toes-cfg\n          hostPath:\n            path: /data/k8s-container/elk-7.2.0/mysqlslowlog-logstash-7.2.0/config\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n\n```\n","content":"<p>客户端采集数据的软件比较多, 有logstash,flume,fluentd/fluent-bit,filebeat等,这里在k8s集群中部署fluentd开启UDP端口接收代码写入的json日志,并写入到kafka中</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"1-一些服务版本\"><a href=\"#1-一些服务版本\" class=\"headerlink\" title=\"1. 一些服务版本\"></a>1. 一些服务版本</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">docker</span>镜像: <span class=\"selector-tag\">docker</span> <span class=\"selector-tag\">pull</span> <span class=\"selector-tag\">fluentd</span><span class=\"selector-pseudo\">:v1.9.1-1.0</span></span><br><span class=\"line\"><span class=\"selector-tag\">kafka</span>: <span class=\"selector-tag\">kafka-server-0</span><span class=\"selector-class\">.10</span><span class=\"selector-class\">.0</span>+<span class=\"selector-tag\">kafka2</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.0-1</span><span class=\"selector-class\">.2</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.0</span><span class=\"selector-class\">.p0</span><span class=\"selector-class\">.63</span><span class=\"selector-class\">.el6</span><span class=\"selector-class\">.noarch</span></span><br><span class=\"line\"><span class=\"selector-tag\">fluent-plugin-kafka</span>: 0<span class=\"selector-class\">.5</span><span class=\"selector-class\">.7</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"2-fluentd-镜像安装kafka扩展-Dockerfile\"><a href=\"#2-fluentd-镜像安装kafka扩展-Dockerfile\" class=\"headerlink\" title=\"2. fluentd 镜像安装kafka扩展 Dockerfile\"></a>2. fluentd 镜像安装kafka扩展 Dockerfile</h3><blockquote>\n<p>由于fluent-plugin-kafka版本要求<br>我们的kafka是0.10, 所以高版本有问题, 安装了fluent-plugin-kafka 0.5.7 则正常</p>\n</blockquote>\n<p>官方文档: <a href=\"https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7\" target=\"_blank\" rel=\"noopener\">https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7</a></p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> fluentd:v1.9.1-1.0</span><br><span class=\"line\"></span><br><span class=\"line\">MAINTAINER zhangzw &lt;zhangzw@xxx.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">USER root</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"builtin-name\">RUN</span> fluent-gem install fluent-plugin-kafka -v 0.5.7</span><br><span class=\"line\"></span><br><span class=\"line\">USER fluent</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"3-fluentd配置文件-fluent-udp-to-kafka-conf\"><a href=\"#3-fluentd配置文件-fluent-udp-to-kafka-conf\" class=\"headerlink\" title=\"3. fluentd配置文件 fluent-udp-to-kafka.conf\"></a>3. fluentd配置文件 fluent-udp-to-kafka.conf</h3><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">&lt;source&gt;</span></span><br><span class=\"line\">  <span class=\"meta\">@type</span> udp</span><br><span class=\"line\">  <span class=\"meta\">@label</span> <span class=\"meta\">@mainstream</span></span><br><span class=\"line\">  tag udplog <span class=\"comment\"># required</span></span><br><span class=\"line\">  <span class=\"variable\">&lt;parse&gt;</span></span><br><span class=\"line\">    <span class=\"meta\">@type</span> regexp</span><br><span class=\"line\">    expression /^(?<span class=\"variable\">&lt;message&gt;</span>.<span class=\"symbol\">*</span>)$/</span><br><span class=\"line\">  <span class=\"variable\">&lt;/parse&gt;</span></span><br><span class=\"line\">  port 12301               <span class=\"comment\"># optional. 5160 by default</span></span><br><span class=\"line\">  bind 0.0.0.0             <span class=\"comment\"># optional. 0.0.0.0 by default</span></span><br><span class=\"line\">  message_length_limit 1MB <span class=\"comment\"># optional. 4096 bytes by default</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/source&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">&lt;filter **&gt;</span></span><br><span class=\"line\">  <span class=\"meta\">@type</span> stdout</span><br><span class=\"line\"><span class=\"variable\">&lt;/filter&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">&lt;label @mainstream&gt;</span></span><br><span class=\"line\">  <span class=\"variable\">&lt;match **&gt;</span></span><br><span class=\"line\">    <span class=\"meta\">@type</span> kafka2</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># list of seed brokers，这个地方可以通过逗号写多个地址比如 host1:9092,host2:9092</span></span><br><span class=\"line\">    brokers 192.168.xxx.142:9092</span><br><span class=\"line\">    use_event_time true</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># buffer settings</span></span><br><span class=\"line\">    <span class=\"variable\">&lt;buffer topic&gt;</span></span><br><span class=\"line\">    <span class=\"meta\">@type</span> file</span><br><span class=\"line\">    <span class=\"comment\"># 下面的path可能需要手动创建目录，并给写入权限，我直接给了777</span></span><br><span class=\"line\">    path /fluentd/log/td-agent/buffer/td</span><br><span class=\"line\">    flush_interval 3s</span><br><span class=\"line\">    <span class=\"variable\">&lt;/buffer&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># data type settings</span></span><br><span class=\"line\">    <span class=\"variable\">&lt;format&gt;</span></span><br><span class=\"line\">    <span class=\"meta\">@type</span> json</span><br><span class=\"line\">    <span class=\"variable\">&lt;/format&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># kafka中创建的topic</span></span><br><span class=\"line\">    topic_key udplog</span><br><span class=\"line\">    <span class=\"comment\"># 默认topic</span></span><br><span class=\"line\">    default_topic udplog</span><br><span class=\"line\">    get_kafka_client_log true</span><br><span class=\"line\">    <span class=\"comment\"># producer settings</span></span><br><span class=\"line\">    required_acks -1</span><br><span class=\"line\">    compression_codec gzip</span><br><span class=\"line\">  <span class=\"variable\">&lt;/match&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/label&gt;</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"4-k8s部署-开启input-udp-12301接收数据-并output给kafka\"><a href=\"#4-k8s部署-开启input-udp-12301接收数据-并output给kafka\" class=\"headerlink\" title=\"4. k8s部署 开启input udp 12301接收数据, 并output给kafka\"></a>4. k8s部署 开启input udp 12301接收数据, 并output给kafka</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">k8s-fluentd-udplog-udp-to-kafka.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta2</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      elastic-app:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        elastic-app:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">hub.xxx.com/bq/fluentd:v1.9.1-1.0-kafka-0.10</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">12301</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">port12301</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">fluentd-udplog-logs</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/fluentd/log</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">fluentd-udplog-cfg</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/fluentd/etc/fluent.conf</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">fluentd-udplog-logs</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/elk-7.2.0/fluentd/logs/</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">fluentd-udplog-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/elk-7.2.0/fluentd/fluent-udp-to-kafka.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   elastic-app:</span> <span class=\"string\">fluentd-udplog</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">fluentd-udplog-service-nodeport</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">port12301</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">12301</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">12301</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">12301</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   elastic-app:</span> <span class=\"string\">fluentd-udplog</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"5-修改logstash的配置\"><a href=\"#5-修改logstash的配置\" class=\"headerlink\" title=\"5. 修改logstash的配置\"></a>5. 修改logstash的配置</h3><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config/pipeline/logstash.conf</span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\"> kafka&#123;</span><br><span class=\"line\">  <span class=\"attr\">type</span> =&gt;<span class=\"string\">\"php-mysql-dev-252-log\"</span></span><br><span class=\"line\">  <span class=\"attr\">bootstrap_servers</span> =&gt; <span class=\"string\">\"192.168.xxx.142:9092\"</span></span><br><span class=\"line\">  <span class=\"attr\">topics</span> =&gt; <span class=\"string\">\"php-mysql-dev-0-slowlog\"</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">kafka</span>&#123;</span><br><span class=\"line\">                <span class=\"attr\">type</span> =&gt;<span class=\"string\">\"udplog\"</span></span><br><span class=\"line\">                <span class=\"attr\">bootstrap_servers</span> =&gt; <span class=\"string\">\"192.168.xxx.142:9092\"</span></span><br><span class=\"line\">                <span class=\"attr\">topics</span> =&gt; <span class=\"string\">\"udplog\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">filter&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">###############</span></span><br><span class=\"line\">    if [type] == <span class=\"string\">\"php-mysql-dev-252-log\"</span> &#123;</span><br><span class=\"line\"> \t<span class=\"keyword\">json</span> &#123;</span><br><span class=\"line\">  \t\t<span class=\"attr\">source</span> =&gt; <span class=\"string\">\"message\"</span></span><br><span class=\"line\"> \t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> \t<span class=\"keyword\">mutate</span> &#123;</span><br><span class=\"line\">     \t\t<span class=\"attr\">gsub</span> =&gt; [ <span class=\"string\">\"message\"</span>, <span class=\"string\">\"\\n\"</span>, <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\">  \t&#125;</span><br><span class=\"line\"> \t<span class=\"keyword\">grok</span> &#123;</span><br><span class=\"line\">  \t\t<span class=\"attr\">match</span> =&gt; [<span class=\"string\">\"message\"</span>,<span class=\"string\">\"(?m)^# User@Host: %&#123;USER:user&#125;\\[[^\\]]+\\] @  \\[%&#123;IP:clientip&#125;\\]# Query_time: %&#123;NUMBER:query_time:float&#125;\\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;(?&lt;dbnameall&gt;.*)SET\\s+timestamp=%&#123;NUMBER:timestamp_mysql:int&#125;;(?&lt;query&gt;.*)\"</span>]</span><br><span class=\"line\"> \t&#125;</span><br><span class=\"line\"> \t<span class=\"keyword\">date</span> &#123;</span><br><span class=\"line\">  \t\t<span class=\"attr\">match</span> =&gt; [<span class=\"string\">\"timestamp_mysql\"</span>, <span class=\"string\">\"UNIX\"</span>]</span><br><span class=\"line\">  \t\t<span class=\"attr\">target</span> =&gt; <span class=\"string\">\"@timestamp\"</span></span><br><span class=\"line\"> \t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\">######</span></span><br><span class=\"line\">    if [type] == <span class=\"string\">\"udplog\"</span> &#123;</span><br><span class=\"line\"> \t<span class=\"keyword\">grok</span> &#123;</span><br><span class=\"line\">          <span class=\"attr\">match</span> =&gt; &#123;</span><br><span class=\"line\">            <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"&lt;%&#123;NUMBER:id:int&#125;&gt;%&#123;NUMBER:id_N:int&#125; (?&lt;http_time&gt;\\S+) %&#123;DATA:hostname&#125; %&#123;DATA:ident&#125; %&#123;NUMBER:pid:int&#125; - - %&#123;DATA:logLevel&#125;: X-Request-Id:%&#123;DATA:Request_Id&#125; module:%&#123;DATA:moduleName&#125; act:%&#123;DATA:Act&#125; sql:(?&lt;sql&gt;(.*)) cost:%&#123;NUMBER:sqlDuring:int&#125;ms \\[\\] \\[\\]\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">     \t&#125;</span><br><span class=\"line\">       \t<span class=\"keyword\">grok</span> &#123;</span><br><span class=\"line\">         <span class=\"attr\">match</span> =&gt; &#123;<span class=\"string\">\"sql\"</span> =&gt;<span class=\"string\">\" %&#123;DATA:operation&#125; \"</span>&#125;</span><br><span class=\"line\">       \t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   \tif <span class=\"string\">\"_grokparsefailure\"</span> not in [tags] &#123;</span><br><span class=\"line\">      \t if [sqlDuring] &lt; 5 &#123;</span><br><span class=\"line\">          <span class=\"keyword\">drop</span> &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    \t drop &#123;&#125;</span><br><span class=\"line\">   \t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">###</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"php-mysql-dev-252-log\"</span> &#123;</span><br><span class=\"line\">      elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt;  [ <span class=\"string\">\"http://192.168.xxx.120:19230\"</span> ]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"php-mysql-dev-252-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"><span class=\"comment\">###</span></span><br><span class=\"line\">    if [type] == <span class=\"string\">\"udplog\"</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">elasticsearch</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt;  [ <span class=\"string\">\"http://192.168.xxx.120:19230\"</span> ]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"udplog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"6-部署k8s-logstash-分析后写入到es中-k8s-logstash-7-2-0-kafka-to-es-yml\"><a href=\"#6-部署k8s-logstash-分析后写入到es中-k8s-logstash-7-2-0-kafka-to-es-yml\" class=\"headerlink\" title=\"6. 部署k8s logstash 分析后写入到es中 k8s-logstash-7.2.0-kafka-to-es.yml\"></a>6. 部署k8s logstash 分析后写入到es中 k8s-logstash-7.2.0-kafka-to-es.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta2</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span>  <span class=\"string\">slowlog-logstash-kafka-to-es</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">slowlog-logstash-kafka-to-es</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      elastic-app:</span> <span class=\"string\">slowlog-logstash-kafka-to-es</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        elastic-app:</span> <span class=\"string\">slowlog-logstash-kafka-to-es</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">slowlog-logstash-kafka-to-es</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">hub.xxx.com/bq/logstash:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">slowlog-toes-cfg</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/usr/share/logstash/config</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">slowlog-toes-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/elk-7.2.0/mysqlslowlog-logstash-7.2.0/config</span></span><br><span class=\"line\"><span class=\"attr\">      tolerations:</span></span><br><span class=\"line\"><span class=\"attr\">        - key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\"><span class=\"attr\">          effect:</span> <span class=\"string\">NoSchedule</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/04/09/44-k8s部署fluentd-kafka-logstash-es/","categories":[{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/categories/elk7/"},{"name":"fluentd","slug":"fluentd","permalink":"https://blog.k1s.club/categories/fluentd/"}],"tags":[{"name":"fluentd","slug":"fluentd","permalink":"https://blog.k1s.club/tags/fluentd/"}]},{"title":"k8s的yaml配置名词解释(模板)","date":"2020-03-31T09:21:23.000Z","path":"2020/03/31/43-k8s的yaml配置名词解释-模板/","text":"针对Deployment的yaml配置解释说明 原文: K8s Deployment YAML 名词解释 Deployment API 版本对照表123456Kubernetes 版本 Deployment 版本v1.5-v1.15 extensions/v1beta1v1.7-v1.15 apps/v1beta1v1.8-v1.15 apps/v1beta2v1.9+ apps/v1 Deployment yaml 名词解释：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384apiVersion: apps/v1 # 指定api版本，此值必须在kubectl api-versions中 kind: Deployment # 指定创建资源的角色/类型 metadata: # 资源的元数据/属性 name: demo # 资源的名字，在同一个namespace中必须唯一 namespace: default # 部署在哪个namespace中 labels: # 设定资源的标签 app: demo version: stablespec: # 资源规范字段 replicas: 1 # 声明副本数目 revisionHistoryLimit: 3 # 保留历史版本 selector: # 选择器 matchLabels: # 匹配标签 app: demo version: stable strategy: # 策略 rollingUpdate: # 滚动更新 maxSurge: 30% # 最大额外可以存在的副本数，可以为百分比，也可以为整数 maxUnavailable: 30% # 示在更新过程中能够进入不可用状态的 Pod 的最大值，可以为百分比，也可以为整数 type: RollingUpdate # 滚动更新策略 template: # 模版 metadata: # 资源的元数据/属性 annotations: # 自定义注解列表 sidecar.istio.io/inject: \"false\" # 自定义注解名字 labels: # 设定资源的标签 app: demo version: stable spec: # 资源规范字段 containers: - name: demo # 容器的名字 image: demo:v1 # 容器使用的镜像地址 imagePullPolicy: IfNotPresent # 每次Pod启动拉取镜像策略，三个选择 Always、Never、IfNotPresent # Always，每次都检查；Never，每次都不检查（不管本地是否有）；IfNotPresent，如果本地有就不检查，如果没有就拉取 resources: # 资源管理 limits: # 最大使用 cpu: 300m # CPU，1核心 = 1000m memory: 500Mi # 内存，1G = 1000Mi requests: # 容器运行时，最低资源需求，也就是说最少需要多少资源容器才能正常运行 cpu: 100m memory: 100Mi livenessProbe: # pod 内部健康检查的设置 httpGet: # 通过httpget检查健康，返回200-399之间，则认为容器正常 path: /healthCheck # URI地址 port: 8080 # 端口 scheme: HTTP # 协议 # host: 127.0.0.1 # 主机地址 initialDelaySeconds: 30 # 表明第一次检测在容器启动后多长时间后开始 timeoutSeconds: 5 # 检测的超时时间 periodSeconds: 30 # 检查间隔时间 successThreshold: 1 # 成功门槛 failureThreshold: 5 # 失败门槛，连接失败5次，pod杀掉，重启一个新的pod readinessProbe: # Pod 准备服务健康检查设置 httpGet: path: /healthCheck port: 8080 scheme: HTTP initialDelaySeconds: 30 timeoutSeconds: 5 periodSeconds: 10 successThreshold: 1 failureThreshold: 5 #也可以用这种方法 #exec: 执行命令的方法进行监测，如果其退出码不为0，则认为容器正常 # command: # - cat # - /tmp/health #也可以用这种方法 #tcpSocket: # 通过tcpSocket检查健康 # port: number ports: - name: http # 名称 containerPort: 8080 # 容器开发对外的端口 protocol: TCP # 协议 imagePullSecrets: # 镜像仓库拉取密钥 - name: harbor-certification affinity: # 亲和性调试 nodeAffinity: # 节点亲和力 requiredDuringSchedulingIgnoredDuringExecution: # pod 必须部署到满足条件的节点上 nodeSelectorTerms: # 节点满足任何一个条件就可以 - matchExpressions: # 有多个选项，则只有同时满足这些逻辑选项的节点才能运行 pod - key: beta.kubernetes.io/arch operator: In values: - amd64 Service yaml 名词解释：12345678910111213141516apiVersion: v1 # 指定api版本，此值必须在kubectl api-versions中 kind: Service # 指定创建资源的角色/类型 metadata: # 资源的元数据/属性 name: demo # 资源的名字，在同一个namespace中必须唯一 namespace: default # 部署在哪个namespace中 labels: # 设定资源的标签 app: demospec: # 资源规范字段 type: ClusterIP # ClusterIP 类型 ports: - port: 8080 # service 端口 targetPort: http # 容器暴露的端口 protocol: TCP # 协议 name: http # 端口名称 selector: # 选择器 app: demo","raw":"---\ntitle: k8s的yaml配置名词解释(模板)\ncopyright: true\ndate: 2020-03-31 17:21:23\ntags:\n  - k8s\ncategories:\n  - [k8s]\n---\n针对Deployment的yaml配置解释说明\n\n<!--more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n> 原文: [K8s Deployment YAML 名词解释](https://zhuanlan.zhihu.com/p/100237194)\n\n### Deployment API 版本对照表\n``` \nKubernetes 版本 Deployment 版本\n\nv1.5-v1.15 extensions/v1beta1\nv1.7-v1.15 apps/v1beta1\nv1.8-v1.15 apps/v1beta2\nv1.9+ apps/v1\n```\n\n\n### Deployment yaml 名词解释：\n``` yaml\napiVersion: apps/v1  # 指定api版本，此值必须在kubectl api-versions中  \nkind: Deployment  # 指定创建资源的角色/类型   \nmetadata:  # 资源的元数据/属性\n  name: demo  # 资源的名字，在同一个namespace中必须唯一\n  namespace: default # 部署在哪个namespace中\n  labels:  # 设定资源的标签\n    app: demo\n    version: stable\nspec: # 资源规范字段\n  replicas: 1 # 声明副本数目\n  revisionHistoryLimit: 3 # 保留历史版本\n  selector: # 选择器\n    matchLabels: # 匹配标签\n      app: demo\n      version: stable\n  strategy: # 策略\n    rollingUpdate: # 滚动更新\n      maxSurge: 30% # 最大额外可以存在的副本数，可以为百分比，也可以为整数\n      maxUnavailable: 30% # 示在更新过程中能够进入不可用状态的 Pod 的最大值，可以为百分比，也可以为整数\n    type: RollingUpdate # 滚动更新策略\n  template: # 模版\n    metadata: # 资源的元数据/属性\n      annotations: # 自定义注解列表\n        sidecar.istio.io/inject: \"false\" # 自定义注解名字\n      labels: # 设定资源的标签\n        app: demo\n        version: stable\n    spec: # 资源规范字段\n      containers:\n      - name: demo # 容器的名字   \n        image: demo:v1 # 容器使用的镜像地址   \n        imagePullPolicy: IfNotPresent # 每次Pod启动拉取镜像策略，三个选择 Always、Never、IfNotPresent\n                                      # Always，每次都检查；Never，每次都不检查（不管本地是否有）；IfNotPresent，如果本地有就不检查，如果没有就拉取\n        resources: # 资源管理\n          limits: # 最大使用\n            cpu: 300m # CPU，1核心 = 1000m\n            memory: 500Mi # 内存，1G = 1000Mi\n          requests:  # 容器运行时，最低资源需求，也就是说最少需要多少资源容器才能正常运行\n            cpu: 100m\n            memory: 100Mi\n        livenessProbe: # pod 内部健康检查的设置\n          httpGet: # 通过httpget检查健康，返回200-399之间，则认为容器正常\n            path: /healthCheck # URI地址\n            port: 8080 # 端口\n            scheme: HTTP # 协议\n            # host: 127.0.0.1 # 主机地址\n          initialDelaySeconds: 30 # 表明第一次检测在容器启动后多长时间后开始\n          timeoutSeconds: 5 # 检测的超时时间\n          periodSeconds: 30 # 检查间隔时间\n          successThreshold: 1 # 成功门槛\n          failureThreshold: 5 # 失败门槛，连接失败5次，pod杀掉，重启一个新的pod\n        readinessProbe: # Pod 准备服务健康检查设置\n          httpGet:\n            path: /healthCheck\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 30\n          timeoutSeconds: 5\n          periodSeconds: 10\n          successThreshold: 1\n          failureThreshold: 5\n       #也可以用这种方法   \n       #exec: 执行命令的方法进行监测，如果其退出码不为0，则认为容器正常   \n       #  command:   \n       #    - cat   \n       #    - /tmp/health   \n       #也可以用这种方法   \n       #tcpSocket: # 通过tcpSocket检查健康  \n       #  port: number\n        ports:\n          - name: http # 名称\n            containerPort: 8080 # 容器开发对外的端口\n            protocol: TCP # 协议\n      imagePullSecrets: # 镜像仓库拉取密钥\n        - name: harbor-certification\n      affinity: # 亲和性调试\n        nodeAffinity: # 节点亲和力\n          requiredDuringSchedulingIgnoredDuringExecution: # pod 必须部署到满足条件的节点上\n            nodeSelectorTerms: # 节点满足任何一个条件就可以\n            - matchExpressions: # 有多个选项，则只有同时满足这些逻辑选项的节点才能运行 pod\n              - key: beta.kubernetes.io/arch\n                operator: In\n                values:\n                - amd64\n```\n\n\n### Service yaml 名词解释：\n``` yaml\napiVersion: v1 # 指定api版本，此值必须在kubectl api-versions中 \nkind: Service # 指定创建资源的角色/类型 \nmetadata: # 资源的元数据/属性\n  name: demo # 资源的名字，在同一个namespace中必须唯一\n  namespace: default # 部署在哪个namespace中\n  labels: # 设定资源的标签\n    app: demo\nspec: # 资源规范字段\n  type: ClusterIP # ClusterIP 类型\n  ports:\n    - port: 8080 # service 端口\n      targetPort: http # 容器暴露的端口\n      protocol: TCP # 协议\n      name: http # 端口名称\n  selector: # 选择器\n    app: demo\n```\n\n","content":"<p>针对Deployment的yaml配置解释说明</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<blockquote>\n<p>原文: <a href=\"https://zhuanlan.zhihu.com/p/100237194\" target=\"_blank\" rel=\"noopener\">K8s Deployment YAML 名词解释</a></p>\n</blockquote>\n<h3 id=\"Deployment-API-版本对照表\"><a href=\"#Deployment-API-版本对照表\" class=\"headerlink\" title=\"Deployment API 版本对照表\"></a>Deployment API 版本对照表</h3><figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Kubernetes 版本 Deployment 版本</span><br><span class=\"line\"></span><br><span class=\"line\">v1.5-v1.15 extensions/v1beta1</span><br><span class=\"line\">v1.7-v1.15 apps/v1beta1</span><br><span class=\"line\">v1.8-v1.15 apps/v1beta2</span><br><span class=\"line\">v1.9+ apps/v1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Deployment-yaml-名词解释：\"><a href=\"#Deployment-yaml-名词解释：\" class=\"headerlink\" title=\"Deployment yaml 名词解释：\"></a>Deployment yaml 名词解释：</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span>  <span class=\"comment\"># 指定api版本，此值必须在kubectl api-versions中  </span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span>  <span class=\"comment\"># 指定创建资源的角色/类型   </span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span>  <span class=\"comment\"># 资源的元数据/属性</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">demo</span>  <span class=\"comment\"># 资源的名字，在同一个namespace中必须唯一</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">default</span> <span class=\"comment\"># 部署在哪个namespace中</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span>  <span class=\"comment\"># 设定资源的标签</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"string\">stable</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> <span class=\"comment\"># 资源规范字段</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span> <span class=\"comment\"># 声明副本数目</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">3</span> <span class=\"comment\"># 保留历史版本</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span> <span class=\"comment\"># 选择器</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span> <span class=\"comment\"># 匹配标签</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">      version:</span> <span class=\"string\">stable</span></span><br><span class=\"line\"><span class=\"attr\">  strategy:</span> <span class=\"comment\"># 策略</span></span><br><span class=\"line\"><span class=\"attr\">    rollingUpdate:</span> <span class=\"comment\"># 滚动更新</span></span><br><span class=\"line\"><span class=\"attr\">      maxSurge:</span> <span class=\"number\">30</span><span class=\"string\">%</span> <span class=\"comment\"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span><br><span class=\"line\"><span class=\"attr\">      maxUnavailable:</span> <span class=\"number\">30</span><span class=\"string\">%</span> <span class=\"comment\"># 示在更新过程中能够进入不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">RollingUpdate</span> <span class=\"comment\"># 滚动更新策略</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span> <span class=\"comment\"># 模版</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span> <span class=\"comment\"># 资源的元数据/属性</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span> <span class=\"comment\"># 自定义注解列表</span></span><br><span class=\"line\">        <span class=\"string\">sidecar.istio.io/inject:</span> <span class=\"string\">\"false\"</span> <span class=\"comment\"># 自定义注解名字</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span> <span class=\"comment\"># 设定资源的标签</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">        version:</span> <span class=\"string\">stable</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span> <span class=\"comment\"># 资源规范字段</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">demo</span> <span class=\"comment\"># 容器的名字   </span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">demo:v1</span> <span class=\"comment\"># 容器使用的镜像地址   </span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span> <span class=\"comment\"># 每次Pod启动拉取镜像策略，三个选择 Always、Never、IfNotPresent</span></span><br><span class=\"line\">                                      <span class=\"comment\"># Always，每次都检查；Never，每次都不检查（不管本地是否有）；IfNotPresent，如果本地有就不检查，如果没有就拉取</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span> <span class=\"comment\"># 资源管理</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span> <span class=\"comment\"># 最大使用</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"number\">300</span><span class=\"string\">m</span> <span class=\"comment\"># CPU，1核心 = 1000m</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">500</span><span class=\"string\">Mi</span> <span class=\"comment\"># 内存，1G = 1000Mi</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span>  <span class=\"comment\"># 容器运行时，最低资源需求，也就是说最少需要多少资源容器才能正常运行</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"number\">100</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">100</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">        livenessProbe:</span> <span class=\"comment\"># pod 内部健康检查的设置</span></span><br><span class=\"line\"><span class=\"attr\">          httpGet:</span> <span class=\"comment\"># 通过httpget检查健康，返回200-399之间，则认为容器正常</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/healthCheck</span> <span class=\"comment\"># URI地址</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"number\">8080</span> <span class=\"comment\"># 端口</span></span><br><span class=\"line\"><span class=\"attr\">            scheme:</span> <span class=\"string\">HTTP</span> <span class=\"comment\"># 协议</span></span><br><span class=\"line\">            <span class=\"comment\"># host: 127.0.0.1 # 主机地址</span></span><br><span class=\"line\"><span class=\"attr\">          initialDelaySeconds:</span> <span class=\"number\">30</span> <span class=\"comment\"># 表明第一次检测在容器启动后多长时间后开始</span></span><br><span class=\"line\"><span class=\"attr\">          timeoutSeconds:</span> <span class=\"number\">5</span> <span class=\"comment\"># 检测的超时时间</span></span><br><span class=\"line\"><span class=\"attr\">          periodSeconds:</span> <span class=\"number\">30</span> <span class=\"comment\"># 检查间隔时间</span></span><br><span class=\"line\"><span class=\"attr\">          successThreshold:</span> <span class=\"number\">1</span> <span class=\"comment\"># 成功门槛</span></span><br><span class=\"line\"><span class=\"attr\">          failureThreshold:</span> <span class=\"number\">5</span> <span class=\"comment\"># 失败门槛，连接失败5次，pod杀掉，重启一个新的pod</span></span><br><span class=\"line\"><span class=\"attr\">        readinessProbe:</span> <span class=\"comment\"># Pod 准备服务健康检查设置</span></span><br><span class=\"line\"><span class=\"attr\">          httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/healthCheck</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">            scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\"><span class=\"attr\">          initialDelaySeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"attr\">          timeoutSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"attr\">          periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">          successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">          failureThreshold:</span> <span class=\"number\">5</span></span><br><span class=\"line\">       <span class=\"comment\">#也可以用这种方法   </span></span><br><span class=\"line\">       <span class=\"comment\">#exec: 执行命令的方法进行监测，如果其退出码不为0，则认为容器正常   </span></span><br><span class=\"line\">       <span class=\"comment\">#  command:   </span></span><br><span class=\"line\">       <span class=\"comment\">#    - cat   </span></span><br><span class=\"line\">       <span class=\"comment\">#    - /tmp/health   </span></span><br><span class=\"line\">       <span class=\"comment\">#也可以用这种方法   </span></span><br><span class=\"line\">       <span class=\"comment\">#tcpSocket: # 通过tcpSocket检查健康  </span></span><br><span class=\"line\">       <span class=\"comment\">#  port: number</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">http</span> <span class=\"comment\"># 名称</span></span><br><span class=\"line\"><span class=\"attr\">            containerPort:</span> <span class=\"number\">8080</span> <span class=\"comment\"># 容器开发对外的端口</span></span><br><span class=\"line\"><span class=\"attr\">            protocol:</span> <span class=\"string\">TCP</span> <span class=\"comment\"># 协议</span></span><br><span class=\"line\"><span class=\"attr\">      imagePullSecrets:</span> <span class=\"comment\"># 镜像仓库拉取密钥</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">harbor-certification</span></span><br><span class=\"line\"><span class=\"attr\">      affinity:</span> <span class=\"comment\"># 亲和性调试</span></span><br><span class=\"line\"><span class=\"attr\">        nodeAffinity:</span> <span class=\"comment\"># 节点亲和力</span></span><br><span class=\"line\"><span class=\"attr\">          requiredDuringSchedulingIgnoredDuringExecution:</span> <span class=\"comment\"># pod 必须部署到满足条件的节点上</span></span><br><span class=\"line\"><span class=\"attr\">            nodeSelectorTerms:</span> <span class=\"comment\"># 节点满足任何一个条件就可以</span></span><br><span class=\"line\"><span class=\"attr\">            - matchExpressions:</span> <span class=\"comment\"># 有多个选项，则只有同时满足这些逻辑选项的节点才能运行 pod</span></span><br><span class=\"line\"><span class=\"attr\">              - key:</span> <span class=\"string\">beta.kubernetes.io/arch</span></span><br><span class=\"line\"><span class=\"attr\">                operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\"><span class=\"attr\">                values:</span></span><br><span class=\"line\"><span class=\"bullet\">                -</span> <span class=\"string\">amd64</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Service-yaml-名词解释：\"><a href=\"#Service-yaml-名词解释：\" class=\"headerlink\" title=\"Service yaml 名词解释：\"></a>Service yaml 名词解释：</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> <span class=\"comment\"># 指定api版本，此值必须在kubectl api-versions中 </span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span> <span class=\"comment\"># 指定创建资源的角色/类型 </span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span> <span class=\"comment\"># 资源的元数据/属性</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">demo</span> <span class=\"comment\"># 资源的名字，在同一个namespace中必须唯一</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">default</span> <span class=\"comment\"># 部署在哪个namespace中</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span> <span class=\"comment\"># 设定资源的标签</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> <span class=\"comment\"># 资源规范字段</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span> <span class=\"comment\"># ClusterIP 类型</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">8080</span> <span class=\"comment\"># service 端口</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"string\">http</span> <span class=\"comment\"># 容器暴露的端口</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span> <span class=\"comment\"># 协议</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">http</span> <span class=\"comment\"># 端口名称</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span> <span class=\"comment\"># 选择器</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">demo</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/31/43-k8s的yaml配置名词解释-模板/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"kubeadm安装高可用k8s集群","date":"2020-03-24T03:10:41.000Z","path":"2020/03/24/42-kubeadm安装高可用k8s集群/","text":"简单记录kubeadm方式安装k8s1.16.4高可用集群,haproxy通过keepalived绑定的vip来负载均衡到三台master, 其中keepalived则反之单机故障,haproxy则让三台master可以同时提供服务. Centos7.6部署k8s v1.16.4高可用集群(主备模式)使用kubeadm搭建高可用k8s v1.16.3集群(keepalived+haproxy) 一、 安装准备 1.1 主机名 1234192.168.53.106 master01.k8s.io192.168.53.107 master02.k8s.io192.168.53.108 master03.k8s.io192.168.53.137 master.k8s.io 1.2 同步时间, 设置时区 12345* * * * * /usr/sbin/ntpdate time.nist.govtimedatectl set-timezone Asia/Shanghai或者ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime 1.3 关闭SElinux 12345setenforce 0sed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/sysconfig/selinuxsed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/configsed -i \"s/^SELINUX=permissive/SELINUX=disabled/g\" /etc/sysconfig/selinuxsed -i \"s/^SELINUX=permissive/SELINUX=disabled/g\" /etc/selinux/config 1.4 关闭swap(否则kubeadm init或join会报错) 1234567&gt; swapoff -a &amp;&amp; sysctl -w vm.swappiness=0vm.swappiness = 0或 swapoff -a#/etc/fstab也要注解掉SWAP挂载。sed -i.$(date +%F).bak '/swap/s/^/#/' /etc/fstab#sed -i 's/.*swap.*/#&amp;/' /etc/fstab 1.5 配置系统内核参数 1234567使流过网桥的流量也进入iptables/netfilter框架中，在/etc/sysctl.conf中添加以下配置cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.confnet.bridge.bridge-nf-call-iptables = 1net.bridge.bridge-nf-call-ip6tables = 1EOFsysctl -p /etc/sysctl.d/k8s.conf 如果出现报错 12sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directorysysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory 报错解决: 1234# 执行以下命令1 modprobe br_netfilter2 ls /proc/sys/net/bridge3 sysctl -p /etc/sysctl.d/k8s.conf 1.6 设置k8s源 123456789101112cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOFyum clean allyum makecache -y 1234567[] 中括号中的是repository id，唯一，用来标识不同仓库name 仓库名称，自定义baseurl 仓库地址enable 是否启用该仓库，默认为1表示启用gpgcheck 是否验证从该仓库获得程序包的合法性，1为验证repo_gpgcheck 是否验证元数据的合法性 元数据就是程序包列表，1为验证gpgkey=URL 数字签名的公钥文件所在位置，如果gpgcheck值为1，此处就需要指定gpgkey文件的位置，如果gpgcheck值为0就不需要此项了 1.7 免密登录配置 略 二、 docker版本安装 2.1 配置源 123456yum install -y yum-utils device-mapper-persistent-data lvm2 bash-completionyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoyum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y# 高版本降级yum downgrade --setopt=obsoletes=0 -y docker-ce-18.09.9 docker-ce-cli-18.09.9 2.2 配置阿里云镜像加速器 登陆地址为：https://cr.console.aliyun.com ,未注册的可以先注册阿里云账户 123456mkdir -p /etc/dockertee /etc/docker/daemon.json &lt;&lt;-'EOF'&#123; \"registry-mirrors\": [\"https://0aqwccdy.mirror.aliyuncs.com\"]&#125;EOF 2.3 启动docker 12systemctl restart dockersystemctl enable docker 2.4 修改Cgroup Driver 修改daemon.json，新增‘”exec-opts”: [“native.cgroupdriver=systemd”’ 12345cat /etc/docker/daemon.json&#123; \"registry-mirrors\": [\"https://0aqwccdy.mirror.aliyuncs.com\"], \"exec-opts\": [\"native.cgroupdriver=systemd\"]&#125; 重新加载docker 12systemctl restart dockersystemctl enable docker 修改cgroupdriver是为了消除告警： 1[WARNING IsDockerSystemdCheck]: detected “cgroupfs” as the Docker cgroup driver. The recommended driver is “systemd”. Please follow the guide at https://kubernetes.io/docs/setup/cri/ 三、 keepalived安装 3.1 安装 1yum -y install keepalived 3.2 master01.k8s.io上配置 1234567891011121314151617181920212223242526272829303132tee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'! Configuration File for keepalivedglobal_defs &#123; router_id master01.k8s.io&#125;vrrp_script check_haproxy &#123; script \"killall -0 haproxy\" interval 3 weight -2 fall 10 rise 2&#125;vrrp_instance VI_1 &#123; state MASTER interface enp0s3 virtual_router_id 51 priority 250 advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.53.137 &#125; track_script &#123; check_haproxy &#125;&#125;EOF 3.3 master02.k8s.io,master03.k8s.io上配置 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566tee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'! Configuration File for keepalivedglobal_defs &#123; router_id master02.k8s.io&#125;vrrp_script check_haproxy &#123; script \"killall -0 haproxy\" interval 3 weight -2 fall 10 rise 2&#125;vrrp_instance VI_1 &#123; state BACKUP interface enp0s3 virtual_router_id 51 priority 200 advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.53.137 &#125; track_script &#123; check_haproxy &#125;&#125;EOFtee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'! Configuration File for keepalivedglobal_defs &#123; router_id master03.k8s.io&#125;vrrp_script check_haproxy &#123; script \"killall -0 haproxy\" interval 3 weight -2 fall 10 rise 2&#125;vrrp_instance VI_1 &#123; state BACKUP interface enp0s3 virtual_router_id 51 priority 150 advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.53.137 &#125; track_script &#123; check_haproxy &#125;&#125;EOF 3.4 master02.k8s.io,master03.k8s.io上启动keepalived 12service keepalived startsystemctl enable keepalived 3.5 测试 1234567# 首先 ip a查看ip否则绑定成功# ping 192.168.53.137 是否正常# 在master01.k8s.io上 停止服务 service keepalived stop# 在master02.k8s.io或master03.k8s.io上查看ip a是否存在192.168.53.137, 检查ping 192.168.53.137 是否正常 四、 haproxy安装 4.1 安装 1yum install -y haproxy 4.2 配置 三台master节点的配置均相同，配置中声明了后端代理的三个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口，其他的配置不做赘述。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475tee /etc/haproxy/haproxy.cfg &lt;&lt;- 'EOF'#---------------------------------------------------------------------# Global settings#---------------------------------------------------------------------global # to have these messages end up in /var/log/haproxy.log you will # need to: # 1) configure syslog to accept network log events. This is done # by adding the '-r' option to the SYSLOGD_OPTIONS in # /etc/sysconfig/syslog # 2) configure local2 events to go to the /var/log/haproxy.log # file. A line like the following can be added to # /etc/sysconfig/syslog # # local2.* /var/log/haproxy.log # log 127.0.0.1 local2 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn 4000 user haproxy group haproxy daemon # turn on stats unix socket stats socket /var/lib/haproxy/stats#---------------------------------------------------------------------# common defaults that all the 'listen' and 'backend' sections will# use if not designated in their block#--------------------------------------------------------------------- defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000#---------------------------------------------------------------------# kubernetes apiserver frontend which proxys to the backends#---------------------------------------------------------------------frontend kubernetes-apiserver mode tcp bind *:16443 option tcplog default_backend kubernetes-apiserver #---------------------------------------------------------------------# round robin balancing between the various backends#---------------------------------------------------------------------backend kubernetes-apiserver mode tcp balance roundrobin server master01.k8s.io 192.168.53.106:6443 check server master02.k8s.io 192.168.53.107:6443 check server master03.k8s.io 192.168.53.108:6443 check#---------------------------------------------------------------------# collection haproxy statistics message#---------------------------------------------------------------------listen stats bind *:1080 stats auth admin:awesomePassword stats refresh 5s stats realm HAProxy\\ Statistics stats uri /admin?statsEOF 4.3 启动 1234systemctl enable haproxysystemctl start haproxysystemctl status haproxynetstat -lnptu|grep haproxy 五、 k8s安装 5.1 版本查看 1yum list kubelet --showduplicates | sort -r 本文安装的kubelet版本是1.16.4，该版本支持的docker版本为1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09。 5.2 安装kubelet、kubeadm和kubectl 1yum install -y kubelet-1.16.4 kubeadm-1.16.4 kubectl-1.16.4 kubelet 运行在集群所有节点上，用于启动Pod和容器等对象的工具kubeadm 用于初始化集群，启动集群的命令工具kubectl 用于和集群通信的命令行，通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 5.3 启动kubelet 12systemctl enable kubeletsystemctl start kubelet 5.4 kubectl命令补全 123456# bashecho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bash_profilesource ~/.bash_profile# zshecho \"source &lt;(kubectl completion zsh)\" &gt;&gt; ~/.zshrcsource ~/.zshrc 5.5 下载镜像 外网的慢, 从阿里云下载后打个官方tag即可 1234567891011121314151617181920212223242526tee /root/image.sh &lt;&lt;- 'EOF'#!/bin/bash#url=registry.cn-hangzhou.aliyuncs.com/loong576url=registry.aliyuncs.com/google_containersversion=v1.16.4images=(`kubeadm config images list --kubernetes-version=$version|awk -F '/' '&#123;print $2&#125;'`)for imagename in $&#123;images[@]&#125; ; do docker pull $url/$imagename docker tag $url/$imagename k8s.gcr.io/$imagename docker rmi -f $url/$imagenamedoneEOF# 下载sh /root/image.sh# 验证docker images|grep 1.16.4k8s.gcr.io/kube-apiserver v1.16.4 3722a80984a0 3 months ago 217MBk8s.gcr.io/kube-controller-manager v1.16.4 fb4cca6b4e4c 3 months ago 163MBk8s.gcr.io/kube-proxy v1.16.4 091df896d78f 3 months ago 86.1MBk8s.gcr.io/kube-scheduler v1.16.4 2984964036c8 3 months ago 87.3MBk8s.gcr.io/metrics-server-amd64 v0.3.5 abf04c0f54ff 6 months ago 39.9MBk8s.gcr.io/etcd 3.3.15-0 b2756210eeab 6 months ago 247MBk8s.gcr.io/coredns 1.6.2 bf261d157914 7 months ago 44.1MBk8s.gcr.io/pause 3.1 da86e6ba6ca1 2 years ago 742kB 六、初始化master 6.1 kubeadm.1.16.4.conf 在具有vip的master上操作，这里为master01.k8s.io 123456789101112131415161718192021tee /data/k8s-config/kubeadm.1.16.4.conf &lt;&lt;- 'EOF'apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationkubernetesVersion: v1.16.4apiServer: certSANs: #填写所有kube-apiserver节点的hostname、IP、VIP - master01.k8s.io - master02.k8s.io - master03.k8s.io - master.k8s.io - dk-node1 - 192.168.53.106 - 192.168.53.107 - 192.168.53.108 - 192.168.53.137 - 192.168.0.136 - 127.0.0.1controlPlaneEndpoint: \"master.k8s.io:16443\"networking: podSubnet: \"10.244.0.0/16\"EOF 6.2 master初始化 1kubeadm init --config=kubeadm.1.16.4.conf 1234567891011You can now join any number of control-plane nodes by copying certificate authoritiesand service account keys on each node and then running the following as root: kubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\ --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac \\ --control-planeThen you can join any number of worker nodes by running the following on each as root:kubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\ --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac 6.3 加载环境变量 12echo \"export KUBECONFIG=/etc/kubernetes/admin.conf\" &gt;&gt; ~/.zshrcsource ~/.zshrc 本文所有操作都在root用户下执行，若为非root用户，则执行如下操作： 123mkdir -p $HOME/.kubecp -i /etc/kubernetes/admin.conf $HOME/.kube/configchown $(id -u):$(id -g) $HOME/.kube/config 6.4 安装flannel网络 123456789101112kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.ymlpodsecuritypolicy.policy/psp.flannel.unprivileged createdclusterrole.rbac.authorization.k8s.io/flannel createdclusterrolebinding.rbac.authorization.k8s.io/flannel createdserviceaccount/flannel createdconfigmap/kube-flannel-cfg createddaemonset.apps/kube-flannel-ds-amd64 createddaemonset.apps/kube-flannel-ds-arm64 createddaemonset.apps/kube-flannel-ds-arm createddaemonset.apps/kube-flannel-ds-ppc64le createddaemonset.apps/kube-flannel-ds-s390x created 七、control plane节点加入集群 7.1 证书分发 在master01.k8s.io上运行脚本cert-main-master.sh，将证书分发至master02.k8s.io 1234567891011121314151617181920tee /root/cert-main-master.sh &lt;&lt;- 'EOF'USER=root # customizableCONTROL_PLANE_IPS=\"192.168.53.107 192.168.53.108\"CONTROL_PLANE_pkidir=\"/etc/kubernetes/pki\"for host in $&#123;CONTROL_PLANE_IPS&#125;; do ssh root@$&#123;host&#125; \"mkdir -p $&#123;CONTROL_PLANE_pkidir&#125;/etcd\" scp /etc/kubernetes/pki/ca.crt \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/ca.key \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/sa.key \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/sa.pub \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/front-proxy-ca.crt \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/front-proxy-ca.key \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/ scp /etc/kubernetes/pki/etcd/ca.crt \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/etcd/ca.crt # Quote this line if you are using external etcd scp /etc/kubernetes/pki/etcd/ca.key \"$&#123;USER&#125;\"@$host:$&#123;CONTROL_PLANE_pkidir&#125;/etcd/ca.keydoneEOFsh /root/cert-main-master.sh 7.2 master02.k8s.io,master03.k8s.io加入集群 123kubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\ --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac \\ --control-plane 6.3 master02.k8s.io,master03.k8s.io加载环境变量 12echo \"export KUBECONFIG=/etc/kubernetes/admin.conf\" &gt;&gt; ~/.zshrcsource ~/.zshrc 本文所有操作都在root用户下执行，若为非root用户，则执行如下操作： 123mkdir -p $HOME/.kubecp -i /etc/kubernetes/admin.conf $HOME/.kube/configchown $(id -u):$(id -g) $HOME/.kube/config 7.4 集群节点查看 1234567891011121314151617181920212223242526272829303132333435363738# kubectl get nodesNAME STATUS ROLES AGE VERSIONmaster01.k8s.io Ready master 6m v1.16.4master02.k8s.io Ready master 99s v1.16.4master03.k8s.io Ready master 46s v1.16.4# kubectl get pod -n kube-systemNAME READY STATUS RESTARTS AGEcoredns-5644d7b6d9-fz77l 1/1 Running 0 4hcoredns-5644d7b6d9-qvh6b 1/1 Running 0 4hetcd-master01.k8s.io 1/1 Running 1 4h15metcd-master02.k8s.io 1/1 Running 0 4h12metcd-master03.k8s.io 1/1 Running 0 4h11mkube-apiserver-master01.k8s.io 1/1 Running 1 4h15mkube-apiserver-master02.k8s.io 1/1 Running 0 4h12mkube-apiserver-master03.k8s.io 1/1 Running 0 4h10mkube-controller-manager-master01.k8s.io 1/1 Running 2 4h15mkube-controller-manager-master02.k8s.io 1/1 Running 1 4h12mkube-controller-manager-master03.k8s.io 1/1 Running 0 4h10mkube-flannel-ds-amd64-84b6w 1/1 Running 1 4h15mkube-flannel-ds-amd64-df99l 1/1 Running 0 4h11mkube-flannel-ds-amd64-jzt62 1/1 Running 1 4h12mkube-flannel-ds-amd64-lwd8m 1/1 Running 0 12mkube-proxy-fgcmg 1/1 Running 0 4h11mkube-proxy-mss74 1/1 Running 0 12mkube-proxy-r9rz2 1/1 Running 1 4h16mkube-proxy-s47gj 1/1 Running 0 4h12mkube-scheduler-master01.k8s.io 1/1 Running 2 4h15mkube-scheduler-master02.k8s.io 1/1 Running 1 4h12mkube-scheduler-master03.k8s.io 1/1 Running 0 4h10m# kubectl get csNAME AGEscheduler &lt;unknown&gt;controller-manager &lt;unknown&gt;etcd-0 &lt;unknown&gt; 执行kubectl get cs显示&lt;unknown&gt;是一个1.16版本已知的bug，后续官方应该会解决处理，有大佬分析了源码并且提交了pr，可点此参考 7.5 测试集群 12345678910111213141516171819# 1 查看leader# kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentitycontrol-plane.alpha.kubernetes.io/leader: '&#123;\"holderIdentity\":\"master01.k8s.io_4b4f63f3-551e-4514-8aa9-a8fdbb13f1b4\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2020-03-24T02:40:32Z\",\"renewTime\":\"2020-03-24T02:45:47Z\",\"leaderTransitions\":1&#125;'# 2 在master01.k8s.io 上执行 init 0 关机 模拟宕机# 3 controller-manager和scheduler也发生了迁移# kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentitycontrol-plane.alpha.kubernetes.io/leader: '&#123;\"holderIdentity\":\"master02.k8s.io_457a8d6d-d0e4-4a8e-afbe-0c37f0dadf8d\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2020-03-24T02:46:03Z\",\"renewTime\":\"2020-03-24T02:50:50Z\",\"leaderTransitions\":2&#125;'# 4 集群此时还是能正常操作# kubectl get nodesNAME STATUS ROLES AGE VERSIONmaster01.k8s.io NotReady master 17m v1.16.4master02.k8s.io Ready master 12m v1.16.4master03.k8s.io Ready master 11m v1.16.4 7.6 导入集群到rancher 12# 这里请自行在rancher界面生成(我这里是rancherv2.3.5)curl --insecure -sfL https://rancher-dev.xxx.com/v3/import/68nzw8nlch92gshktcx2v5d8xvlvlk57nfgffz9jr7hxwfkwcbbtpz.yaml | kubectl apply -f -","raw":"---\ntitle: kubeadm安装高可用k8s集群\ncopyright: true\ndate: 2020-03-24 11:10:41\ntags:\n  - k8s\ncategories:\n  - [技术文档]\n  - [k8s]\n\n---\n简单记录kubeadm方式安装k8s1.16.4高可用集群,haproxy通过keepalived绑定的vip来负载均衡到三台master, 其中keepalived则反之单机故障,haproxy则让三台master可以同时提供服务.\n\n![](//zhangzw001.github.io/images/42/01.png)\n\n<!--more -->\n\n\n\n> [Centos7.6部署k8s v1.16.4高可用集群(主备模式)](https://www.kubernetes.org.cn/6632.html)\n> [使用kubeadm搭建高可用k8s v1.16.3集群(keepalived+haproxy)](https://www.cnblogs.com/ssgeek/p/11942062.html)\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 一、 安装准备\n- 1.1 主机名\n```\n192.168.53.106 master01.k8s.io\n192.168.53.107 master02.k8s.io\n192.168.53.108 master03.k8s.io\n192.168.53.137 master.k8s.io\n```\n\n- 1.2 同步时间, 设置时区\n```\n* * * * * /usr/sbin/ntpdate time.nist.gov\n\ntimedatectl set-timezone Asia/Shanghai\n或者\nln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n```\n\n- 1.3 关闭SElinux\n```\nsetenforce  0\nsed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/sysconfig/selinux\nsed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\nsed -i \"s/^SELINUX=permissive/SELINUX=disabled/g\" /etc/sysconfig/selinux\nsed -i \"s/^SELINUX=permissive/SELINUX=disabled/g\" /etc/selinux/config  \n```\n\n- 1.4 关闭swap(否则kubeadm init或join会报错)\n```\n> swapoff -a && sysctl -w vm.swappiness=0\nvm.swappiness = 0\n或 swapoff -a\n\n#/etc/fstab也要注解掉SWAP挂载。\nsed -i.$(date +%F).bak '/swap/s/^/#/' /etc/fstab\n#sed -i 's/.*swap.*/#&/' /etc/fstab\n\n```\n\n- 1.5 配置系统内核参数\n```\n使流过网桥的流量也进入iptables/netfilter框架中，在/etc/sysctl.conf中添加以下配置\ncat <<EOF > /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\nsysctl -p /etc/sysctl.d/k8s.conf\n```\n\n  > 如果出现报错\n\n  ```\nsysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory\nsysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory\n```\n\n  > 报错解决:\n\n  ```\n# 执行以下命令\n1 modprobe br_netfilter\n2 ls /proc/sys/net/bridge\n3 sysctl -p /etc/sysctl.d/k8s.conf\n```\n\n- 1.6 设置k8s源\n```\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\nyum clean all\nyum makecache -y\n```\n\n  ```\n[] 中括号中的是repository id，唯一，用来标识不同仓库\nname 仓库名称，自定义\nbaseurl 仓库地址\nenable 是否启用该仓库，默认为1表示启用\ngpgcheck 是否验证从该仓库获得程序包的合法性，1为验证\nrepo_gpgcheck 是否验证元数据的合法性 元数据就是程序包列表，1为验证\ngpgkey=URL 数字签名的公钥文件所在位置，如果gpgcheck值为1，此处就需要指定gpgkey文件的位置，如果gpgcheck值为0就不需要此项了\n```\n\n- 1.7 免密登录配置\n\n  略\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 二、 docker版本安装\n\n- 2.1 配置源\n```\nyum install -y yum-utils device-mapper-persistent-data lvm2 bash-completion\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\nyum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y\n\n# 高版本降级\nyum downgrade --setopt=obsoletes=0 -y docker-ce-18.09.9 docker-ce-cli-18.09.9\n```\n\n- 2.2 配置阿里云镜像加速器\n> 登陆地址为：https://cr.console.aliyun.com ,未注册的可以先注册阿里云账户\n\n  ```\nmkdir -p /etc/docker\ntee /etc/docker/daemon.json <<-'EOF'\n{\n  \"registry-mirrors\": [\"https://0aqwccdy.mirror.aliyuncs.com\"]\n}\nEOF\n  ```\n\n- 2.3 启动docker\n```\nsystemctl restart docker\nsystemctl enable docker\n```\n\n- 2.4 修改Cgroup Driver\n> 修改daemon.json，新增‘”exec-opts”: [“native.cgroupdriver=systemd”’\n```\ncat /etc/docker/daemon.json\n{\n  \"registry-mirrors\": [\"https://0aqwccdy.mirror.aliyuncs.com\"],\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\n```\n\n  > 重新加载docker\n\n  ```\nsystemctl restart docker\nsystemctl enable docker\n```\n\n  > 修改cgroupdriver是为了消除告警：\n\n  ```\n[WARNING IsDockerSystemdCheck]: detected “cgroupfs” as the Docker cgroup driver. The recommended driver is “systemd”. Please follow the guide at https://kubernetes.io/docs/setup/cri/\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 三、 keepalived安装\n\n- 3.1 安装\n```\nyum -y install keepalived\n```\n\n- 3.2 master01.k8s.io上配置\n```\ntee /etc/keepalived/keepalived.conf <<- 'EOF'\n! Configuration File for keepalived\nglobal_defs {\n   router_id master01.k8s.io\n}\n\nvrrp_script check_haproxy {\n    script \"killall -0 haproxy\"\n    interval 3\n    weight -2\n    fall 10\n    rise 2\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface enp0s3\n    virtual_router_id 51\n    priority 250\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.53.137\n    }\n    track_script {\n        check_haproxy\n    }\n}\nEOF\n```\n\n- 3.3 master02.k8s.io,master03.k8s.io上配置\n```\ntee /etc/keepalived/keepalived.conf <<- 'EOF'\n! Configuration File for keepalived\nglobal_defs {\n   router_id master02.k8s.io\n}\n\nvrrp_script check_haproxy {\n    script \"killall -0 haproxy\"\n    interval 3\n    weight -2\n    fall 10\n    rise 2\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface enp0s3\n    virtual_router_id 51\n    priority 200\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n       192.168.53.137\n    }\n    track_script {\n        check_haproxy\n    }\n}\nEOF\n\n\ntee /etc/keepalived/keepalived.conf <<- 'EOF'\n! Configuration File for keepalived\nglobal_defs {\n   router_id master03.k8s.io\n}\n\nvrrp_script check_haproxy {\n    script \"killall -0 haproxy\"\n    interval 3\n    weight -2\n    fall 10\n    rise 2\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface enp0s3\n    virtual_router_id 51\n    priority 150\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.53.137\n    }\n    track_script {\n        check_haproxy\n    }\n}\nEOF\n```\n\n- 3.4 master02.k8s.io,master03.k8s.io上启动keepalived\n```\nservice keepalived start\nsystemctl enable keepalived\n```\n\n- 3.5 测试\n```\n# 首先 ip a查看ip否则绑定成功\n\n# ping 192.168.53.137 是否正常\n\n# 在master01.k8s.io上 停止服务 service keepalived stop\n\n# 在master02.k8s.io或master03.k8s.io上查看ip a是否存在192.168.53.137, 检查ping 192.168.53.137 是否正常\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 四、 haproxy安装\n\n- 4.1 安装\n\n  ```\nyum install -y haproxy\n  ```\n\n- 4.2 配置\n  > 三台master节点的配置均相同，配置中声明了后端代理的三个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口，其他的配置不做赘述。\n  ```\ntee  /etc/haproxy/haproxy.cfg <<- 'EOF'\n#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n    # to have these messages end up in /var/log/haproxy.log you will\n    # need to:\n    # 1) configure syslog to accept network log events.  This is done\n    #    by adding the '-r' option to the SYSLOGD_OPTIONS in\n    #    /etc/sysconfig/syslog\n    # 2) configure local2 events to go to the /var/log/haproxy.log\n    #   file. A line like the following can be added to\n    #   /etc/sysconfig/syslog\n    #\n    #    local2.*                       /var/log/haproxy.log\n    #\n    log         127.0.0.1 local2\n\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n\n    # turn on stats unix socket\n    stats socket /var/lib/haproxy/stats\n#---------------------------------------------------------------------\n# common defaults that all the 'listen' and 'backend' sections will\n# use if not designated in their block\n#---------------------------------------------------------------------  \ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n#---------------------------------------------------------------------\n# kubernetes apiserver frontend which proxys to the backends\n#---------------------------------------------------------------------\nfrontend kubernetes-apiserver\n    mode                 tcp\n    bind                 *:16443\n    option               tcplog\n    default_backend      kubernetes-apiserver    \n#---------------------------------------------------------------------\n# round robin balancing between the various backends\n#---------------------------------------------------------------------\nbackend kubernetes-apiserver\n    mode        tcp\n    balance     roundrobin\n    server      master01.k8s.io   192.168.53.106:6443 check\n    server      master02.k8s.io   192.168.53.107:6443 check\n    server      master03.k8s.io   192.168.53.108:6443 check\n#---------------------------------------------------------------------\n# collection haproxy statistics message\n#---------------------------------------------------------------------\nlisten stats\n    bind                 *:1080\n    stats auth           admin:awesomePassword\n    stats refresh        5s\n    stats realm          HAProxy\\ Statistics\n    stats uri            /admin?stats\nEOF\n  ```\n\n- 4.3 启动\n\n  ```\nsystemctl enable haproxy\nsystemctl start haproxy\nsystemctl status haproxy\nnetstat -lnptu|grep haproxy\n  ```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 五、 k8s安装\n\n- 5.1 版本查看\n\n  ```\nyum list kubelet --showduplicates | sort -r\n  ```\n\n  > 本文安装的kubelet版本是1.16.4，该版本支持的docker版本为1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09。\n\n- 5.2 安装kubelet、kubeadm和kubectl\n\n  ```\nyum install -y kubelet-1.16.4 kubeadm-1.16.4 kubectl-1.16.4\n  ```\n\n  > kubelet 运行在集群所有节点上，用于启动Pod和容器等对象的工具\n  > kubeadm 用于初始化集群，启动集群的命令工具\n  > kubectl 用于和集群通信的命令行，通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件\n\n- 5.3 启动kubelet\n\n  ```\nsystemctl enable kubelet\nsystemctl start kubelet\n  ```\n\n- 5.4 kubectl命令补全\n\n  ```\n# bash\necho \"source <(kubectl completion bash)\" >> ~/.bash_profile\nsource ~/.bash_profile\n# zsh\necho \"source <(kubectl completion zsh)\" >> ~/.zshrc\nsource ~/.zshrc\n\n  ```\n\n- 5.5 下载镜像\n  > 外网的慢, 从阿里云下载后打个官方tag即可\n\n  ```\ntee /root/image.sh <<- 'EOF'\n#!/bin/bash\n#url=registry.cn-hangzhou.aliyuncs.com/loong576\nurl=registry.aliyuncs.com/google_containers\nversion=v1.16.4\nimages=(`kubeadm config images list --kubernetes-version=$version|awk -F '/' '{print $2}'`)\nfor imagename in ${images[@]} ; do\n  docker pull $url/$imagename\n  docker tag $url/$imagename k8s.gcr.io/$imagename\n  docker rmi -f $url/$imagename\ndone\nEOF\n\n# 下载\nsh  /root/image.sh\n\n# 验证\ndocker images|grep 1.16.4\nk8s.gcr.io/kube-apiserver                  v1.16.4              3722a80984a0        3 months ago        217MB\nk8s.gcr.io/kube-controller-manager         v1.16.4              fb4cca6b4e4c        3 months ago        163MB\nk8s.gcr.io/kube-proxy                      v1.16.4              091df896d78f        3 months ago        86.1MB\nk8s.gcr.io/kube-scheduler                  v1.16.4              2984964036c8        3 months ago        87.3MB\nk8s.gcr.io/metrics-server-amd64            v0.3.5               abf04c0f54ff        6 months ago        39.9MB\nk8s.gcr.io/etcd                            3.3.15-0             b2756210eeab        6 months ago        247MB\nk8s.gcr.io/coredns                         1.6.2                bf261d157914        7 months ago        44.1MB\nk8s.gcr.io/pause                           3.1                  da86e6ba6ca1        2 years ago         742kB\n  ```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 六、初始化master\n\n- 6.1 kubeadm.1.16.4.conf\n\n  > 在具有vip的master上操作，这里为master01.k8s.io\n\n  ```\ntee /data/k8s-config/kubeadm.1.16.4.conf <<- 'EOF'\napiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\nkubernetesVersion: v1.16.4\napiServer:\n  certSANs:    #填写所有kube-apiserver节点的hostname、IP、VIP\n  - master01.k8s.io\n  - master02.k8s.io\n  - master03.k8s.io\n  - master.k8s.io\n  - dk-node1\n  - 192.168.53.106\n  - 192.168.53.107\n  - 192.168.53.108\n  - 192.168.53.137\n  - 192.168.0.136\n  - 127.0.0.1\ncontrolPlaneEndpoint: \"master.k8s.io:16443\"\nnetworking:\n  podSubnet: \"10.244.0.0/16\"\nEOF\n```\n\n- 6.2 master初始化\n\n  ```\nkubeadm init --config=kubeadm.1.16.4.conf\n```\n\n  ```\nYou can now join any number of control-plane nodes by copying certificate authorities\nand service account keys on each node and then running the following as root:\n\n  kubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\\n    --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac \\\n    --control-plane\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\\n    --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac\n```\n\n- 6.3 加载环境变量\n\n  ```\necho \"export KUBECONFIG=/etc/kubernetes/admin.conf\" >> ~/.zshrc\nsource ~/.zshrc\n```\n\n  本文所有操作都在root用户下执行，若为非root用户，则执行如下操作：\n\n  ```\nmkdir -p $HOME/.kube\ncp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n- 6.4 安装flannel网络\n\n  ```\nkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml\n\npodsecuritypolicy.policy/psp.flannel.unprivileged created\nclusterrole.rbac.authorization.k8s.io/flannel created\nclusterrolebinding.rbac.authorization.k8s.io/flannel created\nserviceaccount/flannel created\nconfigmap/kube-flannel-cfg created\ndaemonset.apps/kube-flannel-ds-amd64 created\ndaemonset.apps/kube-flannel-ds-arm64 created\ndaemonset.apps/kube-flannel-ds-arm created\ndaemonset.apps/kube-flannel-ds-ppc64le created\ndaemonset.apps/kube-flannel-ds-s390x created\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 七、control plane节点加入集群\n\n- 7.1 证书分发\n\n  > 在master01.k8s.io上运行脚本cert-main-master.sh，将证书分发至master02.k8s.io\n\n  ```\ntee /root/cert-main-master.sh  <<- 'EOF'\nUSER=root # customizable\nCONTROL_PLANE_IPS=\"192.168.53.107 192.168.53.108\"\nCONTROL_PLANE_pkidir=\"/etc/kubernetes/pki\"\n\nfor host in ${CONTROL_PLANE_IPS}; do\n    ssh root@${host} \"mkdir -p ${CONTROL_PLANE_pkidir}/etcd\"\n    scp /etc/kubernetes/pki/ca.crt \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/ca.key \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/sa.key \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/sa.pub \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/front-proxy-ca.crt \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/front-proxy-ca.key \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/\n    scp /etc/kubernetes/pki/etcd/ca.crt \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/etcd/ca.crt\n    # Quote this line if you are using external etcd\n    scp /etc/kubernetes/pki/etcd/ca.key \"${USER}\"@$host:${CONTROL_PLANE_pkidir}/etcd/ca.key\ndone\nEOF\n\nsh /root/cert-main-master.sh\n```\n\n- 7.2 master02.k8s.io,master03.k8s.io加入集群\n\n  ```\n  kubeadm join master.k8s.io:16443 --token ynaob5.49rz8ofxavp6hzes \\\n    --discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac \\\n    --control-plane\n```\n\n- 6.3 master02.k8s.io,master03.k8s.io加载环境变量\n\n  ```\necho \"export KUBECONFIG=/etc/kubernetes/admin.conf\" >> ~/.zshrc\nsource ~/.zshrc\n```\n\n  本文所有操作都在root用户下执行，若为非root用户，则执行如下操作：\n\n  ```\nmkdir -p $HOME/.kube\ncp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n\n- 7.4 集群节点查看\n  ```\n\n# kubectl get nodes\nNAME              STATUS   ROLES    AGE   VERSION\nmaster01.k8s.io   Ready    master   6m    v1.16.4\nmaster02.k8s.io   Ready    master   99s   v1.16.4\nmaster03.k8s.io   Ready    master   46s   v1.16.4\n\n# kubectl get pod -n kube-system\nNAME                                      READY   STATUS    RESTARTS   AGE\ncoredns-5644d7b6d9-fz77l                  1/1     Running   0          4h\ncoredns-5644d7b6d9-qvh6b                  1/1     Running   0          4h\netcd-master01.k8s.io                      1/1     Running   1          4h15m\netcd-master02.k8s.io                      1/1     Running   0          4h12m\netcd-master03.k8s.io                      1/1     Running   0          4h11m\nkube-apiserver-master01.k8s.io            1/1     Running   1          4h15m\nkube-apiserver-master02.k8s.io            1/1     Running   0          4h12m\nkube-apiserver-master03.k8s.io            1/1     Running   0          4h10m\nkube-controller-manager-master01.k8s.io   1/1     Running   2          4h15m\nkube-controller-manager-master02.k8s.io   1/1     Running   1          4h12m\nkube-controller-manager-master03.k8s.io   1/1     Running   0          4h10m\nkube-flannel-ds-amd64-84b6w               1/1     Running   1          4h15m\nkube-flannel-ds-amd64-df99l               1/1     Running   0          4h11m\nkube-flannel-ds-amd64-jzt62               1/1     Running   1          4h12m\nkube-flannel-ds-amd64-lwd8m               1/1     Running   0          12m\nkube-proxy-fgcmg                          1/1     Running   0          4h11m\nkube-proxy-mss74                          1/1     Running   0          12m\nkube-proxy-r9rz2                          1/1     Running   1          4h16m\nkube-proxy-s47gj                          1/1     Running   0          4h12m\nkube-scheduler-master01.k8s.io            1/1     Running   2          4h15m\nkube-scheduler-master02.k8s.io            1/1     Running   1          4h12m\nkube-scheduler-master03.k8s.io            1/1     Running   0          4h10m\n\n\n# kubectl get cs\nNAME                 AGE\nscheduler            <unknown>\ncontroller-manager   <unknown>\netcd-0               <unknown>\n```\n\n  > 执行`kubectl get cs`显示`<unknown>`是一个`1.16`版本已知的`bug`，后续官方应该会解决处理，有大佬分析了源码并且提交了pr，可[点此参考](https://segmentfault.com/a/1190000020912684)\n\n\n- 7.5 测试集群\n```\n# 1 查看leader\n# kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity\n\ncontrol-plane.alpha.kubernetes.io/leader: '{\"holderIdentity\":\"master01.k8s.io_4b4f63f3-551e-4514-8aa9-a8fdbb13f1b4\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2020-03-24T02:40:32Z\",\"renewTime\":\"2020-03-24T02:45:47Z\",\"leaderTransitions\":1}'\n\n\n# 2 在master01.k8s.io 上执行 init 0 关机 模拟宕机\n\n# 3 controller-manager和scheduler也发生了迁移\n# kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity\n\ncontrol-plane.alpha.kubernetes.io/leader: '{\"holderIdentity\":\"master02.k8s.io_457a8d6d-d0e4-4a8e-afbe-0c37f0dadf8d\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2020-03-24T02:46:03Z\",\"renewTime\":\"2020-03-24T02:50:50Z\",\"leaderTransitions\":2}'\n\n# 4 集群此时还是能正常操作\n# kubectl get nodes\nNAME              STATUS     ROLES    AGE   VERSION\nmaster01.k8s.io   NotReady   master   17m   v1.16.4\nmaster02.k8s.io   Ready      master   12m   v1.16.4\nmaster03.k8s.io   Ready      master   11m   v1.16.4\n```\n\n  ![](//zhangzw001.github.io/images/42/02.png)\n\n  ![](//zhangzw001.github.io/images/42/03.png)\n\n\n- 7.6 导入集群到rancher\n```\n# 这里请自行在rancher界面生成(我这里是rancherv2.3.5)\ncurl --insecure -sfL https://rancher-dev.xxx.com/v3/import/68nzw8nlch92gshktcx2v5d8xvlvlk57nfgffz9jr7hxwfkwcbbtpz.yaml | kubectl apply -f -\n```\n\n  ![](//zhangzw001.github.io/images/42/04.png)\n\n","content":"<p>简单记录kubeadm方式安装k8s1.16.4高可用集群,haproxy通过keepalived绑定的vip来负载均衡到三台master, 其中keepalived则反之单机故障,haproxy则让三台master可以同时提供服务.</p>\n<p><img src=\"//zhangzw001.github.io/images/42/01.png\" alt></p>\n<a id=\"more\"></a>\n\n\n\n<blockquote>\n<p><a href=\"https://www.kubernetes.org.cn/6632.html\" target=\"_blank\" rel=\"noopener\">Centos7.6部署k8s v1.16.4高可用集群(主备模式)</a><br><a href=\"https://www.cnblogs.com/ssgeek/p/11942062.html\" target=\"_blank\" rel=\"noopener\">使用kubeadm搭建高可用k8s v1.16.3集群(keepalived+haproxy)</a></p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"一、-安装准备\"><a href=\"#一、-安装准备\" class=\"headerlink\" title=\"一、 安装准备\"></a>一、 安装准备</h3><ul>\n<li><p>1.1 主机名</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.106</span> <span class=\"selector-tag\">master01</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.107</span> <span class=\"selector-tag\">master02</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.108</span> <span class=\"selector-tag\">master03</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.137</span> <span class=\"selector-tag\">master</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.2 同步时间, 设置时区</p>\n<figure class=\"highlight dsconfig\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* * * * * /<span class=\"string\">usr/</span><span class=\"string\">sbin/</span><span class=\"string\">ntpdate </span><span class=\"string\">time.</span><span class=\"string\">nist.</span><span class=\"string\">gov</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">timedatectl </span><span class=\"built_in\">set-timezone</span> <span class=\"string\">Asia/</span><span class=\"string\">Shanghai</span></span><br><span class=\"line\"><span class=\"string\">或</span>者</span><br><span class=\"line\"><span class=\"string\">ln </span>-<span class=\"string\">sf </span>/<span class=\"string\">usr/</span><span class=\"string\">share/</span><span class=\"string\">zoneinfo/</span><span class=\"string\">Asia/</span><span class=\"string\">Shanghai </span>/<span class=\"string\">etc/</span><span class=\"string\">localtime</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.3 关闭SElinux</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setenforce  0</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/^SELINUX=enforcing/SELINUX=disabled/g\"</span> /etc/sysconfig/selinux</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/^SELINUX=enforcing/SELINUX=disabled/g\"</span> /etc/selinux/config</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/^SELINUX=permissive/SELINUX=disabled/g\"</span> /etc/sysconfig/selinux</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/^SELINUX=permissive/SELINUX=disabled/g\"</span> /etc/selinux/config</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.4 关闭swap(否则kubeadm init或join会报错)</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; swapoff -a &amp;&amp; sysctl -w vm.swappiness=<span class=\"number\">0</span></span><br><span class=\"line\">vm.swappiness = <span class=\"number\">0</span></span><br><span class=\"line\">或 swapoff -a</span><br><span class=\"line\"></span><br><span class=\"line\">#<span class=\"regexp\">/etc/</span>fstab也要注解掉SWAP挂载。</span><br><span class=\"line\">sed -i.$(date +%F).bak <span class=\"string\">'/swap/s/^/#/'</span> <span class=\"regexp\">/etc/</span>fstab</span><br><span class=\"line\">#sed -i <span class=\"string\">'s/.*swap.*/#&amp;/'</span> <span class=\"regexp\">/etc/</span>fstab</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.5 配置系统内核参数</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使流过网桥的流量也进入iptables/netfilter框架中，在/etc/sysctl.conf中添加以下配置</span><br><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class=\"line\">net<span class=\"selector-class\">.bridge</span><span class=\"selector-class\">.bridge-nf-call-iptables</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.bridge</span><span class=\"selector-class\">.bridge-nf-call-ip6tables</span> = <span class=\"number\">1</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sysctl -<span class=\"selector-tag\">p</span> /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果出现报错</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-<span class=\"keyword\">call</span>-iptables: <span class=\"keyword\">No</span> such <span class=\"keyword\">file</span> <span class=\"keyword\">or</span> <span class=\"keyword\">directory</span></span><br><span class=\"line\">sysctl: cannot stat /proc/<span class=\"keyword\">sys</span>/net/bridge/bridge-nf-<span class=\"keyword\">call</span>-ip6tables: <span class=\"keyword\">No</span> such <span class=\"keyword\">file</span> <span class=\"keyword\">or</span> <span class=\"keyword\">directory</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>报错解决:</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 执行以下命令</span></span><br><span class=\"line\">1 modprobe br_netfilter</span><br><span class=\"line\">2 ls /proc/sys/net/bridge</span><br><span class=\"line\">3 sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.6 设置k8s源</p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">repo_gpgcheck=1</span><br><span class=\"line\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">yum clean all</span><br><span class=\"line\">yum makecache -y</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[] 中括号中的是repository id，唯一，用来标识不同仓库</span><br><span class=\"line\">name 仓库名称，自定义</span><br><span class=\"line\">baseurl 仓库地址</span><br><span class=\"line\">enable 是否启用该仓库，默认为<span class=\"number\">1</span>表示启用</span><br><span class=\"line\">gpgcheck 是否验证从该仓库获得程序包的合法性，<span class=\"number\">1</span>为验证</span><br><span class=\"line\">repo_gpgcheck 是否验证元数据的合法性 元数据就是程序包列表，<span class=\"number\">1</span>为验证</span><br><span class=\"line\">gpgkey=URL 数字签名的公钥文件所在位置，如果gpgcheck值为<span class=\"number\">1</span>，此处就需要指定gpgkey文件的位置，如果gpgcheck值为<span class=\"number\">0</span>就不需要此项了</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.7 免密登录配置</p>\n<p>略</p>\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"二、-docker版本安装\"><a href=\"#二、-docker版本安装\" class=\"headerlink\" title=\"二、 docker版本安装\"></a>二、 docker版本安装</h3><ul>\n<li><p>2.1 配置源</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -<span class=\"keyword\">y</span> yum-utils device-mapper-persistent-data lvm2 bash-completion</span><br><span class=\"line\">yum-config-manager --<span class=\"built_in\">add</span>-repo http://mirrors.aliyun.<span class=\"keyword\">com</span>/docker-<span class=\"keyword\">ce</span>/linux/centos/docker-<span class=\"keyword\">ce</span>.repo</span><br><span class=\"line\">yum install docker-<span class=\"keyword\">ce</span>-<span class=\"number\">18.09</span>.<span class=\"number\">9</span> docker-<span class=\"keyword\">ce</span>-cli-<span class=\"number\">18.09</span>.<span class=\"number\">9</span> containerd.io -<span class=\"keyword\">y</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 高版本降级</span><br><span class=\"line\">yum downgrade --setopt=obsoletes=<span class=\"number\">0</span> -<span class=\"keyword\">y</span> docker-<span class=\"keyword\">ce</span>-<span class=\"number\">18.09</span>.<span class=\"number\">9</span> docker-<span class=\"keyword\">ce</span>-cli-<span class=\"number\">18.09</span>.<span class=\"number\">9</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.2 配置阿里云镜像加速器</p>\n<blockquote>\n<p>登陆地址为：<a href=\"https://cr.console.aliyun.com\" target=\"_blank\" rel=\"noopener\">https://cr.console.aliyun.com</a> ,未注册的可以先注册阿里云账户</p>\n</blockquote>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -<span class=\"selector-tag\">p</span> /etc/docker</span><br><span class=\"line\">tee /etc/docker/daemon<span class=\"selector-class\">.json</span> &lt;&lt;-<span class=\"string\">'EOF'</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"https://0aqwccdy.mirror.aliyuncs.com\"</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.3 启动docker</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart docker</span><br><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> docker</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.4 修改Cgroup Driver</p>\n<blockquote>\n<p>修改daemon.json，新增‘”exec-opts”: [“native.cgroupdriver=systemd”’</p>\n</blockquote>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat <span class=\"meta-keyword\">/etc/</span>docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"https://0aqwccdy.mirror.aliyuncs.com\"</span>],</span><br><span class=\"line\">  <span class=\"string\">\"exec-opts\"</span>: [<span class=\"string\">\"native.cgroupdriver=systemd\"</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>重新加载docker</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart docker</span><br><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>修改cgroupdriver是为了消除告警：</p>\n</blockquote>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">WARNING IsDockerSystemdCheck</span>]: detected “cgroupfs” <span class=\"keyword\">as</span> the Docker cgroup driver. The recommended driver <span class=\"keyword\">is</span> “systemd”. Please follow the guide at https:<span class=\"comment\">//kubernetes.io/docs/setup/cri/</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"三、-keepalived安装\"><a href=\"#三、-keepalived安装\" class=\"headerlink\" title=\"三、 keepalived安装\"></a>三、 keepalived安装</h3><ul>\n<li><p>3.1 安装</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y <span class=\"keyword\">install</span> keepalived</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.2 master01.k8s.io上配置</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /etc/keepalived/keepalived.conf &lt;&lt;- '<span class=\"literal\">EOF</span>'</span><br><span class=\"line\">! Configuration File for keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   router_id master01.k8s.io</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_haproxy &#123;</span><br><span class=\"line\">    script <span class=\"string\">\"killall -0 haproxy\"</span></span><br><span class=\"line\">    interval <span class=\"number\">3</span></span><br><span class=\"line\">    weight <span class=\"number\">-2</span></span><br><span class=\"line\">    fall <span class=\"number\">10</span></span><br><span class=\"line\">    rise <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    <span class=\"section\">state</span> MASTER</span><br><span class=\"line\">    interface enp0s3</span><br><span class=\"line\">    virtual_router_id <span class=\"number\">51</span></span><br><span class=\"line\">    priority <span class=\"number\">250</span></span><br><span class=\"line\">    advert_int <span class=\"number\">1</span></span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.53</span><span class=\"number\">.137</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_haproxy</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"literal\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.3 master02.k8s.io,master03.k8s.io上配置</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /etc/keepalived/keepalived.conf &lt;&lt;- '<span class=\"literal\">EOF</span>'</span><br><span class=\"line\">! Configuration File for keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   router_id master02.k8s.io</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_haproxy &#123;</span><br><span class=\"line\">    script <span class=\"string\">\"killall -0 haproxy\"</span></span><br><span class=\"line\">    interval <span class=\"number\">3</span></span><br><span class=\"line\">    weight <span class=\"number\">-2</span></span><br><span class=\"line\">    fall <span class=\"number\">10</span></span><br><span class=\"line\">    rise <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    <span class=\"section\">state</span> BACKUP</span><br><span class=\"line\">    interface enp0s3</span><br><span class=\"line\">    virtual_router_id <span class=\"number\">51</span></span><br><span class=\"line\">    priority <span class=\"number\">200</span></span><br><span class=\"line\">    advert_int <span class=\"number\">1</span></span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">       <span class=\"number\">192.168</span><span class=\"number\">.53</span><span class=\"number\">.137</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_haproxy</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"literal\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">tee /etc/keepalived/keepalived.conf &lt;&lt;- '<span class=\"literal\">EOF</span>'</span><br><span class=\"line\">! Configuration File for keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   router_id master03.k8s.io</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_haproxy &#123;</span><br><span class=\"line\">    script <span class=\"string\">\"killall -0 haproxy\"</span></span><br><span class=\"line\">    interval <span class=\"number\">3</span></span><br><span class=\"line\">    weight <span class=\"number\">-2</span></span><br><span class=\"line\">    fall <span class=\"number\">10</span></span><br><span class=\"line\">    rise <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    <span class=\"section\">state</span> BACKUP</span><br><span class=\"line\">    interface enp0s3</span><br><span class=\"line\">    virtual_router_id <span class=\"number\">51</span></span><br><span class=\"line\">    priority <span class=\"number\">150</span></span><br><span class=\"line\">    advert_int <span class=\"number\">1</span></span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.53</span><span class=\"number\">.137</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_haproxy</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"literal\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.4 master02.k8s.io,master03.k8s.io上启动keepalived</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service keepalived start</span><br><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> keepalived</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.5 测试</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 首先 <span class=\"selector-tag\">ip</span> <span class=\"selector-tag\">a</span>查看<span class=\"selector-tag\">ip</span>否则绑定成功</span><br><span class=\"line\"></span><br><span class=\"line\"># <span class=\"selector-tag\">ping</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.137</span> 是否正常</span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"selector-tag\">master01</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>上 停止服务 <span class=\"selector-tag\">service</span> <span class=\"selector-tag\">keepalived</span> <span class=\"selector-tag\">stop</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"selector-tag\">master02</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>或<span class=\"selector-tag\">master03</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>上查看<span class=\"selector-tag\">ip</span> <span class=\"selector-tag\">a</span>是否存在192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.137</span>, 检查<span class=\"selector-tag\">ping</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.137</span> 是否正常</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"四、-haproxy安装\"><a href=\"#四、-haproxy安装\" class=\"headerlink\" title=\"四、 haproxy安装\"></a>四、 haproxy安装</h3><ul>\n<li><p>4.1 安装</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum <span class=\"keyword\">install</span> -y haproxy</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.2 配置</p>\n<blockquote>\n<p>三台master节点的配置均相同，配置中声明了后端代理的三个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口，其他的配置不做赘述。</p>\n</blockquote>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee  /etc/haproxy/haproxy.cfg &lt;&lt;- <span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Global settings</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\">global</span><br><span class=\"line\">    <span class=\"comment\"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class=\"line\">    <span class=\"comment\"># need to:</span></span><br><span class=\"line\">    <span class=\"comment\"># 1) configure syslog to accept network log events.  This is done</span></span><br><span class=\"line\">    <span class=\"comment\">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class=\"line\">    <span class=\"comment\">#    /etc/sysconfig/syslog</span></span><br><span class=\"line\">    <span class=\"comment\"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class=\"line\">    <span class=\"comment\">#   file. A line like the following can be added to</span></span><br><span class=\"line\">    <span class=\"comment\">#   /etc/sysconfig/syslog</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\">#    local2.*                       /var/log/haproxy.log</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    log         <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span> local2</span><br><span class=\"line\"></span><br><span class=\"line\">    chroot      /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">haproxy</span></span></span><br><span class=\"line\">    pidfile     /var/run/haproxy.pid</span><br><span class=\"line\">    maxconn     <span class=\"number\">4000</span></span><br><span class=\"line\">    user        haproxy</span><br><span class=\"line\">    group       haproxy</span><br><span class=\"line\">    daemon</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># turn on stats unix socket</span></span><br><span class=\"line\">    stats socket /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">haproxy</span>/<span class=\"title\">stats</span></span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># common defaults that all the 'listen' and 'backend' sections will</span></span><br><span class=\"line\"><span class=\"comment\"># use if not designated in their block</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------  </span></span><br><span class=\"line\">defaults</span><br><span class=\"line\">    mode                    http</span><br><span class=\"line\">    log                     global</span><br><span class=\"line\">    option                  httplog</span><br><span class=\"line\">    option                  dontlognull</span><br><span class=\"line\">    option http-server-close</span><br><span class=\"line\">    option forwardfor       except <span class=\"number\">127.0</span>.<span class=\"number\">0.0</span>/<span class=\"number\">8</span></span><br><span class=\"line\">    option                  redispatch</span><br><span class=\"line\">    retries                 <span class=\"number\">3</span></span><br><span class=\"line\">    timeout http-request    <span class=\"number\">10</span>s</span><br><span class=\"line\">    timeout queue           <span class=\"number\">1</span>m</span><br><span class=\"line\">    timeout connect         <span class=\"number\">10</span>s</span><br><span class=\"line\">    timeout client          <span class=\"number\">1</span>m</span><br><span class=\"line\">    timeout server          <span class=\"number\">1</span>m</span><br><span class=\"line\">    timeout http-keep-alive <span class=\"number\">10</span>s</span><br><span class=\"line\">    timeout check           <span class=\"number\">10</span>s</span><br><span class=\"line\">    maxconn                 <span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># kubernetes apiserver frontend which proxys to the backends</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\">frontend kubernetes-apiserver</span><br><span class=\"line\">    mode                 tcp</span><br><span class=\"line\">    bind                 *:<span class=\"number\">16443</span></span><br><span class=\"line\">    option               tcplog</span><br><span class=\"line\">    default_backend      kubernetes-apiserver    </span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># round robin balancing between the various backends</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\">backend kubernetes-apiserver</span><br><span class=\"line\">    mode        tcp</span><br><span class=\"line\">    balance     roundrobin</span><br><span class=\"line\">    server      master01.k8s.io   <span class=\"number\">192.168</span>.<span class=\"number\">53.106</span>:<span class=\"number\">6443</span> check</span><br><span class=\"line\">    server      master02.k8s.io   <span class=\"number\">192.168</span>.<span class=\"number\">53.107</span>:<span class=\"number\">6443</span> check</span><br><span class=\"line\">    server      master03.k8s.io   <span class=\"number\">192.168</span>.<span class=\"number\">53.108</span>:<span class=\"number\">6443</span> check</span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># collection haproxy statistics message</span></span><br><span class=\"line\"><span class=\"comment\">#---------------------------------------------------------------------</span></span><br><span class=\"line\">listen stats</span><br><span class=\"line\">    bind                 *:<span class=\"number\">1080</span></span><br><span class=\"line\">    stats auth           <span class=\"symbol\">admin:</span>awesomePassword</span><br><span class=\"line\">    stats refresh        <span class=\"number\">5</span>s</span><br><span class=\"line\">    stats realm          HAProxy\\ Statistics</span><br><span class=\"line\">    stats uri            /admin?stats</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.3 启动</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> haproxy</span><br><span class=\"line\">systemctl start haproxy</span><br><span class=\"line\">systemctl status haproxy</span><br><span class=\"line\">netstat -lnptu|grep haproxy</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"五、-k8s安装\"><a href=\"#五、-k8s安装\" class=\"headerlink\" title=\"五、 k8s安装\"></a>五、 k8s安装</h3><ul>\n<li><p>5.1 版本查看</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum <span class=\"keyword\">list</span> kubelet --showduplicates | <span class=\"keyword\">sort</span> -<span class=\"built_in\">r</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>本文安装的kubelet版本是1.16.4，该版本支持的docker版本为1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09。</p>\n</blockquote>\n</li>\n<li><p>5.2 安装kubelet、kubeadm和kubectl</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">yum</span> <span class=\"selector-tag\">install</span> <span class=\"selector-tag\">-y</span> <span class=\"selector-tag\">kubelet-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.4</span> <span class=\"selector-tag\">kubeadm-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.4</span> <span class=\"selector-tag\">kubectl-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.4</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>kubelet 运行在集群所有节点上，用于启动Pod和容器等对象的工具<br>kubeadm 用于初始化集群，启动集群的命令工具<br>kubectl 用于和集群通信的命令行，通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</p>\n</blockquote>\n</li>\n<li><p>5.3 启动kubelet</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> kubelet</span><br><span class=\"line\">systemctl start kubelet</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.4 kubectl命令补全</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bash</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"source &lt;(kubectl completion bash)\"</span> &gt;&gt; ~<span class=\"string\">/.bash_profile</span></span><br><span class=\"line\">source ~<span class=\"string\">/.bash_profile</span></span><br><span class=\"line\"><span class=\"comment\"># zsh</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"source &lt;(kubectl completion zsh)\"</span> &gt;&gt; ~<span class=\"string\">/.zshrc</span></span><br><span class=\"line\">source ~<span class=\"string\">/.zshrc</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.5 下载镜像</p>\n<blockquote>\n<p>外网的慢, 从阿里云下载后打个官方tag即可</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /root/image.sh &lt;&lt;- '<span class=\"literal\">EOF</span>'</span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#url=registry.cn-hangzhou.aliyuncs.com/loong576</span><br><span class=\"line\">url=registry.aliyuncs.com/google_containers</span><br><span class=\"line\">version=v1<span class=\"number\">.16</span><span class=\"number\">.4</span></span><br><span class=\"line\">images=(`kubeadm config images <span class=\"type\">list</span> --kubernetes-version=$version|awk -F '/' '&#123;print $<span class=\"number\">2</span>&#125;'`)</span><br><span class=\"line\">for imagename in $&#123;images[@]&#125; ; do</span><br><span class=\"line\">  docker pull $url/$imagename</span><br><span class=\"line\">  docker tag $url/$imagename k8s.gcr.io/$imagename</span><br><span class=\"line\">  docker rmi -f $url/$imagename</span><br><span class=\"line\">done</span><br><span class=\"line\"><span class=\"literal\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 下载</span><br><span class=\"line\">sh  /root/image.sh</span><br><span class=\"line\"></span><br><span class=\"line\"># 验证</span><br><span class=\"line\">docker images|grep <span class=\"number\">1.16</span><span class=\"number\">.4</span></span><br><span class=\"line\">k8s.gcr.io/kube-apiserver                  v1<span class=\"number\">.16</span><span class=\"number\">.4</span>              <span class=\"number\">3722</span>a80984a0        <span class=\"number\">3</span> months ago        <span class=\"number\">217</span>MB</span><br><span class=\"line\">k8s.gcr.io/kube-controller-manager         v1<span class=\"number\">.16</span><span class=\"number\">.4</span>              fb4cca6b4e4c        <span class=\"number\">3</span> months ago        <span class=\"number\">163</span>MB</span><br><span class=\"line\">k8s.gcr.io/kube-proxy                      v1<span class=\"number\">.16</span><span class=\"number\">.4</span>              <span class=\"number\">091</span>df896d78f        <span class=\"number\">3</span> months ago        <span class=\"number\">86.1</span>MB</span><br><span class=\"line\">k8s.gcr.io/kube-scheduler                  v1<span class=\"number\">.16</span><span class=\"number\">.4</span>              <span class=\"number\">2984964036</span>c8        <span class=\"number\">3</span> months ago        <span class=\"number\">87.3</span>MB</span><br><span class=\"line\">k8s.gcr.io/metrics-server-amd64            v0<span class=\"number\">.3</span><span class=\"number\">.5</span>               abf04c0f54ff        <span class=\"number\">6</span> months ago        <span class=\"number\">39.9</span>MB</span><br><span class=\"line\">k8s.gcr.io/etcd                            <span class=\"number\">3.3</span><span class=\"number\">.15</span><span class=\"number\">-0</span>             b2756210eeab        <span class=\"number\">6</span> months ago        <span class=\"number\">247</span>MB</span><br><span class=\"line\">k8s.gcr.io/coredns                         <span class=\"number\">1.6</span><span class=\"number\">.2</span>                bf261d157914        <span class=\"number\">7</span> months ago        <span class=\"number\">44.1</span>MB</span><br><span class=\"line\">k8s.gcr.io/pause                           <span class=\"number\">3.1</span>                  da86e6ba6ca1        <span class=\"number\">2</span> years ago         <span class=\"number\">742</span>kB</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"六、初始化master\"><a href=\"#六、初始化master\" class=\"headerlink\" title=\"六、初始化master\"></a>六、初始化master</h3><ul>\n<li><p>6.1 kubeadm.1.16.4.conf</p>\n<blockquote>\n<p>在具有vip的master上操作，这里为master01.k8s.io</p>\n</blockquote>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /data/k8s-config/kubeadm.<span class=\"number\">1.16</span>.<span class=\"number\">4</span><span class=\"selector-class\">.conf</span> &lt;&lt;- <span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: kubeadm<span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>/v1beta2</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: v1.<span class=\"number\">16.4</span></span><br><span class=\"line\">apiServer:</span><br><span class=\"line\">  certSANs:    #填写所有kube-apiserver节点的hostname、IP、VIP</span><br><span class=\"line\">  - master01<span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">  - master02<span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">  - master03<span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">  - master<span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span></span><br><span class=\"line\">  - dk-node1</span><br><span class=\"line\">  - <span class=\"number\">192.168</span>.<span class=\"number\">53.106</span></span><br><span class=\"line\">  - <span class=\"number\">192.168</span>.<span class=\"number\">53.107</span></span><br><span class=\"line\">  - <span class=\"number\">192.168</span>.<span class=\"number\">53.108</span></span><br><span class=\"line\">  - <span class=\"number\">192.168</span>.<span class=\"number\">53.137</span></span><br><span class=\"line\">  - <span class=\"number\">192.168</span>.<span class=\"number\">0.136</span></span><br><span class=\"line\">  - <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\">controlPlaneEndpoint: <span class=\"string\">\"master.k8s.io:16443\"</span></span><br><span class=\"line\">networking:</span><br><span class=\"line\">  podSubnet: <span class=\"string\">\"10.244.0.0/16\"</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>6.2 master初始化</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init --config=kubeadm<span class=\"number\">.1</span><span class=\"number\">.16</span><span class=\"number\">.4</span>.conf</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">You can now join any <span class=\"built_in\">number</span> <span class=\"keyword\">of</span> control-plane nodes <span class=\"keyword\">by</span> copying certificate authorities</span><br><span class=\"line\"><span class=\"keyword\">and</span> service account keys <span class=\"keyword\">on</span> each node <span class=\"keyword\">and</span> <span class=\"keyword\">then</span> <span class=\"built_in\">running</span> <span class=\"keyword\">the</span> following <span class=\"keyword\">as</span> root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm join master.k8s.io:<span class=\"number\">16443</span> <span class=\"comment\">--token ynaob5.49rz8ofxavp6hzes \\</span></span><br><span class=\"line\">    <span class=\"comment\">--discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac \\</span></span><br><span class=\"line\">    <span class=\"comment\">--control-plane</span></span><br><span class=\"line\"></span><br><span class=\"line\">Then you can join any <span class=\"built_in\">number</span> <span class=\"keyword\">of</span> worker nodes <span class=\"keyword\">by</span> <span class=\"built_in\">running</span> <span class=\"keyword\">the</span> following <span class=\"keyword\">on</span> each <span class=\"keyword\">as</span> root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm join master.k8s.io:<span class=\"number\">16443</span> <span class=\"comment\">--token ynaob5.49rz8ofxavp6hzes \\</span></span><br><span class=\"line\">    <span class=\"comment\">--discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>6.3 加载环境变量</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"export KUBECONFIG=/etc/kubernetes/admin.conf\"</span> &gt;&gt; ~<span class=\"string\">/.zshrc</span></span><br><span class=\"line\">source ~<span class=\"string\">/.zshrc</span></span><br></pre></td></tr></table></figure>\n\n<p>本文所有操作都在root用户下执行，若为非root用户，则执行如下操作：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>6.4 安装flannel网络</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:<span class=\"comment\">//raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">podsecuritypolicy.policy/psp<span class=\"selector-class\">.flannel</span><span class=\"selector-class\">.unprivileged</span> created</span><br><span class=\"line\">clusterrole<span class=\"selector-class\">.rbac</span><span class=\"selector-class\">.authorization</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>/flannel created</span><br><span class=\"line\">clusterrolebinding<span class=\"selector-class\">.rbac</span><span class=\"selector-class\">.authorization</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span>/flannel created</span><br><span class=\"line\">serviceaccount/flannel created</span><br><span class=\"line\">configmap/kube-flannel-cfg created</span><br><span class=\"line\">daemonset.apps/kube-flannel-ds-amd64 created</span><br><span class=\"line\">daemonset.apps/kube-flannel-ds-arm64 created</span><br><span class=\"line\">daemonset.apps/kube-flannel-ds-arm created</span><br><span class=\"line\">daemonset.apps/kube-flannel-ds-ppc64le created</span><br><span class=\"line\">daemonset.apps/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"七、control-plane节点加入集群\"><a href=\"#七、control-plane节点加入集群\" class=\"headerlink\" title=\"七、control plane节点加入集群\"></a>七、control plane节点加入集群</h3><ul>\n<li><p>7.1 证书分发</p>\n<blockquote>\n<p>在master01.k8s.io上运行脚本cert-main-master.sh，将证书分发至master02.k8s.io</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /root/cert-main-master.sh  &lt;&lt;- <span class=\"string\">'EOF'</span></span><br><span class=\"line\">USER=root <span class=\"comment\"># customizable</span></span><br><span class=\"line\">CONTROL_PLANE_IPS=<span class=\"string\">\"192.168.53.107 192.168.53.108\"</span></span><br><span class=\"line\">CONTROL_PLANE_pkidir=<span class=\"string\">\"/etc/kubernetes/pki\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> <span class=\"variable\">$&#123;CONTROL_PLANE_IPS&#125;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    ssh root@<span class=\"variable\">$&#123;host&#125;</span> <span class=\"string\">\"mkdir -p <span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/etcd\"</span></span><br><span class=\"line\">    scp /etc/kubernetes/pki/ca.crt <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/ca.key <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/sa.key <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/sa.pub <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/front-proxy-ca.crt <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/front-proxy-ca.key <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/</span><br><span class=\"line\">    scp /etc/kubernetes/pki/etcd/ca.crt <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/etcd/ca.crt</span><br><span class=\"line\">    <span class=\"comment\"># Quote this line if you are using external etcd</span></span><br><span class=\"line\">    scp /etc/kubernetes/pki/etcd/ca.key <span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:<span class=\"variable\">$&#123;CONTROL_PLANE_pkidir&#125;</span>/etcd/ca.key</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sh /root/cert-main-master.sh</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>7.2 master02.k8s.io,master03.k8s.io加入集群</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubeadm</span> <span class=\"selector-tag\">join</span> <span class=\"selector-tag\">master</span><span class=\"selector-class\">.k8s</span><span class=\"selector-class\">.io</span><span class=\"selector-pseudo\">:16443</span> <span class=\"selector-tag\">--token</span> <span class=\"selector-tag\">ynaob5</span><span class=\"selector-class\">.49rz8ofxavp6hzes</span> \\</span><br><span class=\"line\">  <span class=\"selector-tag\">--discovery-token-ca-cert-hash</span> <span class=\"selector-tag\">sha256</span><span class=\"selector-pseudo\">:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac</span> \\</span><br><span class=\"line\">  <span class=\"selector-tag\">--control-plane</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>6.3 master02.k8s.io,master03.k8s.io加载环境变量</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"export KUBECONFIG=/etc/kubernetes/admin.conf\"</span> &gt;&gt; ~<span class=\"string\">/.zshrc</span></span><br><span class=\"line\">source ~<span class=\"string\">/.zshrc</span></span><br></pre></td></tr></table></figure>\n\n<p>本文所有操作都在root用户下执行，若为非root用户，则执行如下操作：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>7.4 集群节点查看</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># kubectl get nodes</span><br><span class=\"line\">NAME              STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">master01.k8s.io   Ready    master   <span class=\"number\">6</span>m    v1<span class=\"number\">.16</span><span class=\"number\">.4</span></span><br><span class=\"line\">master02.k8s.io   Ready    master   <span class=\"number\">99</span>s   v1<span class=\"number\">.16</span><span class=\"number\">.4</span></span><br><span class=\"line\">master03.k8s.io   Ready    master   <span class=\"number\">46</span>s   v1<span class=\"number\">.16</span><span class=\"number\">.4</span></span><br><span class=\"line\"></span><br><span class=\"line\"># kubectl get pod -n kube-system</span><br><span class=\"line\">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">coredns<span class=\"number\">-5644</span>d7b6d9-fz77l                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h</span><br><span class=\"line\">coredns<span class=\"number\">-5644</span>d7b6d9-qvh6b                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h</span><br><span class=\"line\">etcd-master01.k8s.io                      <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h15m</span><br><span class=\"line\">etcd-master02.k8s.io                      <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">etcd-master03.k8s.io                      <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h11m</span><br><span class=\"line\">kube-apiserver-master01.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h15m</span><br><span class=\"line\">kube-apiserver-master02.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">kube-apiserver-master03.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h10m</span><br><span class=\"line\">kube-controller-manager-master01.k8s.io   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span>          <span class=\"number\">4</span>h15m</span><br><span class=\"line\">kube-controller-manager-master02.k8s.io   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">kube-controller-manager-master03.k8s.io   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h10m</span><br><span class=\"line\">kube-flannel-ds-amd64<span class=\"number\">-84</span>b6w               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h15m</span><br><span class=\"line\">kube-flannel-ds-amd64-df99l               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h11m</span><br><span class=\"line\">kube-flannel-ds-amd64-jzt62               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">kube-flannel-ds-amd64-lwd8m               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">12</span>m</span><br><span class=\"line\">kube-proxy-fgcmg                          <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h11m</span><br><span class=\"line\">kube-proxy-mss74                          <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">12</span>m</span><br><span class=\"line\">kube-proxy-r9rz2                          <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h16m</span><br><span class=\"line\">kube-proxy-s47gj                          <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">kube-scheduler-master01.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span>          <span class=\"number\">4</span>h15m</span><br><span class=\"line\">kube-scheduler-master02.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span>          <span class=\"number\">4</span>h12m</span><br><span class=\"line\">kube-scheduler-master03.k8s.io            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          <span class=\"number\">4</span>h10m</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># kubectl get cs</span><br><span class=\"line\">NAME                 AGE</span><br><span class=\"line\">scheduler            &lt;unknown&gt;</span><br><span class=\"line\">controller-manager   &lt;unknown&gt;</span><br><span class=\"line\">etcd<span class=\"number\">-0</span>               &lt;unknown&gt;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>执行<code>kubectl get cs</code>显示<code>&lt;unknown&gt;</code>是一个<code>1.16</code>版本已知的<code>bug</code>，后续官方应该会解决处理，有大佬分析了源码并且提交了pr，可<a href=\"https://segmentfault.com/a/1190000020912684\" target=\"_blank\" rel=\"noopener\">点此参考</a></p>\n</blockquote>\n</li>\n</ul>\n<ul>\n<li><p>7.5 测试集群</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1 查看leader</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity</span></span><br><span class=\"line\"></span><br><span class=\"line\">control-plane.alpha.kubernetes.io/leader: '&#123;<span class=\"string\">\"holderIdentity\"</span>:<span class=\"string\">\"master01.k8s.io_4b4f63f3-551e-4514-8aa9-a8fdbb13f1b4\"</span>,<span class=\"string\">\"leaseDurationSeconds\"</span>:<span class=\"number\">15</span>,<span class=\"string\">\"acquireTime\"</span>:<span class=\"string\">\"2020-03-24T02:40:32Z\"</span>,<span class=\"string\">\"renewTime\"</span>:<span class=\"string\">\"2020-03-24T02:45:47Z\"</span>,<span class=\"string\">\"leaderTransitions\"</span>:<span class=\"number\">1</span>&#125;'</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2 在master01.k8s.io 上执行 init 0 关机 模拟宕机</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3 controller-manager和scheduler也发生了迁移</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity</span></span><br><span class=\"line\"></span><br><span class=\"line\">control-plane.alpha.kubernetes.io/leader: '&#123;<span class=\"string\">\"holderIdentity\"</span>:<span class=\"string\">\"master02.k8s.io_457a8d6d-d0e4-4a8e-afbe-0c37f0dadf8d\"</span>,<span class=\"string\">\"leaseDurationSeconds\"</span>:<span class=\"number\">15</span>,<span class=\"string\">\"acquireTime\"</span>:<span class=\"string\">\"2020-03-24T02:46:03Z\"</span>,<span class=\"string\">\"renewTime\"</span>:<span class=\"string\">\"2020-03-24T02:50:50Z\"</span>,<span class=\"string\">\"leaderTransitions\"</span>:<span class=\"number\">2</span>&#125;'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4 集群此时还是能正常操作</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl get nodes</span></span><br><span class=\"line\">NAME              STATUS     ROLES    AGE   <span class=\"keyword\">VERSION</span></span><br><span class=\"line\">master01.k8s.io   NotReady   <span class=\"keyword\">master</span>   <span class=\"title\">17m</span>   v1.<span class=\"number\">16.4</span></span><br><span class=\"line\">master02.k8s.io   Ready      <span class=\"keyword\">master</span>   <span class=\"title\">12m</span>   v1.<span class=\"number\">16.4</span></span><br><span class=\"line\">master03.k8s.io   Ready      <span class=\"keyword\">master</span>   <span class=\"title\">11m</span>   v1.<span class=\"number\">16.4</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"//zhangzw001.github.io/images/42/02.png\" alt></p>\n<p><img src=\"//zhangzw001.github.io/images/42/03.png\" alt></p>\n</li>\n</ul>\n<ul>\n<li><p>7.6 导入集群到rancher</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 这里请自行在rancher界面生成(我这里是rancherv2.3.5)</span></span><br><span class=\"line\">curl --insecure -sfL https:<span class=\"regexp\">//</span>rancher-dev.xxx.com<span class=\"regexp\">/v3/im</span>port<span class=\"regexp\">/68nzw8nlch92gshktcx2v5d8xvlvlk57nfgffz9jr7hxwfkwcbbtpz.yaml | kubectl apply -f -</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"//zhangzw001.github.io/images/42/04.png\" alt></p>\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/24/42-kubeadm安装高可用k8s集群/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"记一次es集群内存溢出的问题","date":"2020-03-19T02:26:49.000Z","path":"2020/03/19/41-记一次es集群内存溢出的问题/","text":"es机器报警磁盘 / 空间不足,查看是生成了 .hprof 文件, 内存溢出的典型特征 以上问题主要是两点 由于elasticsearch用户家目录是/home/elasticsearch, 所以内存溢出时 写的.hprof文件会生成到家目录, 并且大小有6G+, 这会导致/目录磁盘空间不足报警, 是否可以设置该日志目录? 或者取巧设置elasticsearch家目录到/data挂载盘上? 内存溢出的问题, 是否可以优化并解决 问题1 我这里并未找到设置.hprof文件的生成目录路径设置, 所以我就将根目录做了一个链接12345mv /home/elasticsearch /data/ln -s /data/elasticsearch /home/elasticsearch或者修改elasticsearch用户的家目录(不过需要用户没有在login中)lsof |grep elasticsearchusermod -d /data/elasticsearch elasticsearch 问题2 内存溢出的问题,我们设置 indices.fielddata.cache.size: 20% elasticsearch2.x 限制内存使用 indices.fielddata.cache.size 控制为 fielddata 分配的堆空间大小。 当你发起一个查询，分析字符串的聚合将会被加载到 fielddata，如果这些字符串之前没有被加载过。如果结果中 fielddata 大小超过了指定 大小 ，其他的值将会被回收从而获得空间。 默认情况下，设置都是 unbounded ，Elasticsearch 永远都不会从 fielddata 中回收数据。这个默认设置是刻意选择的：fielddata 不是临时缓存。它是驻留内存里的数据结构，必须可以快速执行访问，而且构建它的代价十分高昂。如果每个请求都重载数据，性能会十分糟糕。 监控fielddata 按索引使用 indices-stats API ： 1GET /_stats/fielddata?fields=* 按节点使用 nodes-stats API ： 1GET /_nodes/stats/indices/fielddata?fields=* 按索引节点： 1GET /_nodes/stats/indices/fielddata?level=indices&amp;fields=* 使用设置 ?fields=* ，可以将内存使用分配到每个字段。 断路器机敏的读者可能已经发现 fielddata 大小设置的一个问题。fielddata 大小是在数据加载 之后 检查的。 如果一个查询试图加载比可用内存更多的信息到 fielddata 中会发生什么？答案很丑陋：我们会碰到 OutOfMemoryException 。 Elasticsearch 包括一个 fielddata 断熔器 ，这个设计就是为了处理上述情况。 断熔器通过内部检查（字段的类型、基数、大小等等）来估算一个查询需要的内存。它然后检查要求加载的 fielddata 是否会导致 fielddata 的总量超过堆的配置比例。 如果估算查询的大小超出限制，就会 触发 断路器，查询会被中止并返回异常。这都发生在数据加载 之前 ，也就意味着不会引起 OutOfMemoryException 。 12345678910可用的断路器（Available Circuit Breakers）Elasticsearch 有一系列的断路器，它们都能保证内存不会超出限制：indices.breaker.fielddata.limitfielddata 断路器默认设置堆的 60% 作为 fielddata 大小的上限。indices.breaker.request.limitrequest 断路器估算需要完成其他请求部分的结构大小，例如创建一个聚合桶，默认限制是堆内存的 40%。indices.breaker.total.limittotal 揉合 request 和 fielddata 断路器保证两者组合起来不会使用超过堆内存的 70%。 断路器的限制可以在文件 config/elasticsearch.yml 中指定，可以动态更新一个正在运行的集群： 123456PUT /_cluster/settings&#123; \"persistent\" : &#123; \"indices.breaker.fielddata.limit\" : \"40%\" &#125;&#125; 最好为断路器设置一个相对保守点的值。 记住 fielddata 需要与 request 断路器共享堆内存、索引缓冲内存和过滤器缓存。Lucene 的数据被用来构造索引，以及各种其他临时的数据结构。 正因如此，它默认值非常保守，只有 60% 。过于乐观的设置可能会引起潜在的堆栈溢出（OOM）异常，这会使整个节点宕掉。 在 Fielddata的大小 中，我们提过关于给 fielddata 的大小加一个限制，从而确保旧的无用 fielddata 被回收的方法。 indices.fielddata.cache.size 和 indices.breaker.fielddata.limit 之间的关系非常重要。 如果断路器的限制低于缓存大小，没有数据会被回收。为了能正常工作，断路器的限制 必须 要比缓存大小要高。 在设置 Elasticsearch 堆大小时需要通过 $ES_HEAP_SIZE 环境变量应用两个规则：1 不要超过可用 RAM 的 50%Lucene 能很好利用文件系统的缓存，它是通过系统内核管理的。如果没有足够的文件系统缓存空间，性能会受到影响。 此外，专用于堆的内存越多意味着其他所有使用 doc values 的字段内存越少。2 不要超过 32 GB 如果堆大小小于 32 GB，JVM 可以利用指针压缩，这可以大大降低内存的使用：每个指针 4 字节而不是 8 字节。","raw":"---\ntitle: 记一次es集群内存溢出的问题\ncopyright: true\ndate: 2020-03-19 10:26:49\ntags:\n  - elasticsearch5\ncategories:\n  - [elk,elasticsearch5]\n---\nes机器报警磁盘 / 空间不足,查看是生成了 .hprof 文件, 内存溢出的典型特征\n<!--more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n以上问题主要是两点\n1. 由于elasticsearch用户家目录是/home/elasticsearch, 所以内存溢出时 写的.hprof文件会生成到家目录, 并且大小有6G+, 这会导致/目录磁盘空间不足报警, 是否可以设置该日志目录? 或者取巧设置elasticsearch家目录到/data挂载盘上?\n2. 内存溢出的问题, 是否可以优化并解决\n\n\n### 问题1 我这里并未找到设置.hprof文件的生成目录路径设置, 所以我就将根目录做了一个链接\n```\nmv /home/elasticsearch /data/\nln -s /data/elasticsearch /home/elasticsearch\n或者修改elasticsearch用户的家目录(不过需要用户没有在login中)\nlsof |grep elasticsearch\nusermod -d /data/elasticsearch elasticsearch\n```\n\n\n\n\n### 问题2 内存溢出的问题,我们设置  indices.fielddata.cache.size:  20% \n> [elasticsearch2.x 限制内存使用](https://www.elastic.co/guide/cn/elasticsearch/guide/current/_limiting_memory_usage.html#fielddata-size)\n\nindices.fielddata.cache.size 控制为 fielddata 分配的堆空间大小。 当你发起一个查询，分析字符串的聚合将会被加载到 fielddata，如果这些字符串之前没有被加载过。如果结果中 fielddata 大小超过了指定 大小 ，其他的值将会被回收从而获得空间。\n\n默认情况下，设置都是 unbounded ，Elasticsearch 永远都不会从 fielddata 中回收数据。\n这个默认设置是刻意选择的：fielddata 不是临时缓存。它是驻留内存里的数据结构，必须可以快速执行访问，而且构建它的代价十分高昂。如果每个请求都重载数据，性能会十分糟糕。\n\n\n### 监控fielddata\n\n- 按索引使用 indices-stats API ：\n```\nGET /_stats/fielddata?fields=*\n```\n- 按节点使用 nodes-stats API ：\n```\nGET /_nodes/stats/indices/fielddata?fields=*\n```\n- 按索引节点：\n```\nGET /_nodes/stats/indices/fielddata?level=indices&fields=*\n```\n\n使用设置 ?fields=* ，可以将内存使用分配到每个字段。\n\n\n### 断路器\n\n机敏的读者可能已经发现 fielddata 大小设置的一个问题。fielddata 大小是在数据加载 之后 检查的。 如果一个查询试图加载比可用内存更多的信息到 fielddata 中会发生什么？答案很丑陋：我们会碰到 OutOfMemoryException 。\n\nElasticsearch 包括一个 fielddata 断熔器 ，这个设计就是为了处理上述情况。 断熔器通过内部检查（字段的类型、基数、大小等等）来估算一个查询需要的内存。它然后检查要求加载的 fielddata 是否会导致 fielddata 的总量超过堆的配置比例。\n\n如果估算查询的大小超出限制，就会 触发 断路器，查询会被中止并返回异常。这都发生在数据加载 之前 ，也就意味着不会引起 OutOfMemoryException 。\n\n```\n可用的断路器（Available Circuit Breakers）\n\nElasticsearch 有一系列的断路器，它们都能保证内存不会超出限制：\n\nindices.breaker.fielddata.limit\nfielddata 断路器默认设置堆的 60% 作为 fielddata 大小的上限。\nindices.breaker.request.limit\nrequest 断路器估算需要完成其他请求部分的结构大小，例如创建一个聚合桶，默认限制是堆内存的 40%。\nindices.breaker.total.limit\ntotal 揉合 request 和 fielddata 断路器保证两者组合起来不会使用超过堆内存的 70%。\n```\n\n断路器的限制可以在文件 config/elasticsearch.yml 中指定，可以动态更新一个正在运行的集群：\n```\nPUT /_cluster/settings\n{\n  \"persistent\" : {\n    \"indices.breaker.fielddata.limit\" : \"40%\" \n  }\n}\n```\n\n最好为断路器设置一个相对保守点的值。 记住 fielddata 需要与 request 断路器共享堆内存、索引缓冲内存和过滤器缓存。Lucene 的数据被用来构造索引，以及各种其他临时的数据结构。 正因如此，它默认值非常保守，只有 60% 。过于乐观的设置可能会引起潜在的堆栈溢出（OOM）异常，这会使整个节点宕掉。\n\n\n> 在 Fielddata的大小 中，我们提过关于给 fielddata 的大小加一个限制，从而确保旧的无用 fielddata 被回收的方法。 indices.fielddata.cache.size 和 indices.breaker.fielddata.limit 之间的关系非常重要。 如果断路器的限制低于缓存大小，没有数据会被回收。为了能正常工作，断路器的限制 必须 要比缓存大小要高。\n\n\n\n\n\n\n### 在设置 Elasticsearch 堆大小时需要通过 $ES_HEAP_SIZE 环境变量应用两个规则：\n\n1 不要超过可用 RAM 的 50%\nLucene 能很好利用文件系统的缓存，它是通过系统内核管理的。如果没有足够的文件系统缓存空间，性能会受到影响。 此外，专用于堆的内存越多意味着其他所有使用 doc values 的字段内存越少。\n2 不要超过 32 GB\n如果堆大小小于 32 GB，JVM 可以利用指针压缩，这可以大大降低内存的使用：每个指针 4 字节而不是 8 字节。\n---\n","content":"<p>es机器报警磁盘 / 空间不足,查看是生成了 .hprof 文件, 内存溢出的典型特征</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<p>以上问题主要是两点</p>\n<ol>\n<li>由于elasticsearch用户家目录是/home/elasticsearch, 所以内存溢出时 写的.hprof文件会生成到家目录, 并且大小有6G+, 这会导致/目录磁盘空间不足报警, 是否可以设置该日志目录? 或者取巧设置elasticsearch家目录到/data挂载盘上?</li>\n<li>内存溢出的问题, 是否可以优化并解决</li>\n</ol>\n<h3 id=\"问题1-我这里并未找到设置-hprof文件的生成目录路径设置-所以我就将根目录做了一个链接\"><a href=\"#问题1-我这里并未找到设置-hprof文件的生成目录路径设置-所以我就将根目录做了一个链接\" class=\"headerlink\" title=\"问题1 我这里并未找到设置.hprof文件的生成目录路径设置, 所以我就将根目录做了一个链接\"></a>问题1 我这里并未找到设置.hprof文件的生成目录路径设置, 所以我就将根目录做了一个链接</h3><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv <span class=\"regexp\">/home/</span>elasticsearch <span class=\"regexp\">/data/</span></span><br><span class=\"line\">ln -s <span class=\"regexp\">/data/</span>elasticsearch <span class=\"regexp\">/home/</span>elasticsearch</span><br><span class=\"line\">或者修改elasticsearch用户的家目录(不过需要用户没有在login中)</span><br><span class=\"line\">lsof |<span class=\"keyword\">grep</span> elasticsearch</span><br><span class=\"line\">usermod -d <span class=\"regexp\">/data/</span>elasticsearch elasticsearch</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"问题2-内存溢出的问题-我们设置-indices-fielddata-cache-size-20\"><a href=\"#问题2-内存溢出的问题-我们设置-indices-fielddata-cache-size-20\" class=\"headerlink\" title=\"问题2 内存溢出的问题,我们设置  indices.fielddata.cache.size:  20%\"></a>问题2 内存溢出的问题,我们设置  indices.fielddata.cache.size:  20%</h3><blockquote>\n<p><a href=\"https://www.elastic.co/guide/cn/elasticsearch/guide/current/_limiting_memory_usage.html#fielddata-size\" target=\"_blank\" rel=\"noopener\">elasticsearch2.x 限制内存使用</a></p>\n</blockquote>\n<p>indices.fielddata.cache.size 控制为 fielddata 分配的堆空间大小。 当你发起一个查询，分析字符串的聚合将会被加载到 fielddata，如果这些字符串之前没有被加载过。如果结果中 fielddata 大小超过了指定 大小 ，其他的值将会被回收从而获得空间。</p>\n<p>默认情况下，设置都是 unbounded ，Elasticsearch 永远都不会从 fielddata 中回收数据。<br>这个默认设置是刻意选择的：fielddata 不是临时缓存。它是驻留内存里的数据结构，必须可以快速执行访问，而且构建它的代价十分高昂。如果每个请求都重载数据，性能会十分糟糕。</p>\n<h3 id=\"监控fielddata\"><a href=\"#监控fielddata\" class=\"headerlink\" title=\"监控fielddata\"></a>监控fielddata</h3><ul>\n<li><p>按索引使用 indices-stats API ：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">GET</span> /_stats/fielddata?<span class=\"attribute\">fields</span>=*</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>按节点使用 nodes-stats API ：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">GET</span> /_nodes/stats/indices/fielddata?<span class=\"attribute\">fields</span>=*</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>按索引节点：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">GET</span> /_nodes/stats/indices/fielddata?<span class=\"attribute\">level</span>=indices&amp;fields=*</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>使用设置 ?fields=* ，可以将内存使用分配到每个字段。</p>\n<h3 id=\"断路器\"><a href=\"#断路器\" class=\"headerlink\" title=\"断路器\"></a>断路器</h3><p>机敏的读者可能已经发现 fielddata 大小设置的一个问题。fielddata 大小是在数据加载 之后 检查的。 如果一个查询试图加载比可用内存更多的信息到 fielddata 中会发生什么？答案很丑陋：我们会碰到 OutOfMemoryException 。</p>\n<p>Elasticsearch 包括一个 fielddata 断熔器 ，这个设计就是为了处理上述情况。 断熔器通过内部检查（字段的类型、基数、大小等等）来估算一个查询需要的内存。它然后检查要求加载的 fielddata 是否会导致 fielddata 的总量超过堆的配置比例。</p>\n<p>如果估算查询的大小超出限制，就会 触发 断路器，查询会被中止并返回异常。这都发生在数据加载 之前 ，也就意味着不会引起 OutOfMemoryException 。</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可用的断路器（Available Circuit Breakers）</span><br><span class=\"line\"></span><br><span class=\"line\">Elasticsearch 有一系列的断路器，它们都能保证内存不会超出限制：</span><br><span class=\"line\"></span><br><span class=\"line\">indices<span class=\"selector-class\">.breaker</span><span class=\"selector-class\">.fielddata</span><span class=\"selector-class\">.limit</span></span><br><span class=\"line\">fielddata 断路器默认设置堆的 <span class=\"number\">60%</span> 作为 fielddata 大小的上限。</span><br><span class=\"line\">indices<span class=\"selector-class\">.breaker</span><span class=\"selector-class\">.request</span><span class=\"selector-class\">.limit</span></span><br><span class=\"line\">request 断路器估算需要完成其他请求部分的结构大小，例如创建一个聚合桶，默认限制是堆内存的 <span class=\"number\">40%</span>。</span><br><span class=\"line\">indices<span class=\"selector-class\">.breaker</span><span class=\"selector-class\">.total</span><span class=\"selector-class\">.limit</span></span><br><span class=\"line\">total 揉合 request 和 fielddata 断路器保证两者组合起来不会使用超过堆内存的 <span class=\"number\">70%</span>。</span><br></pre></td></tr></table></figure>\n\n<p>断路器的限制可以在文件 config/elasticsearch.yml 中指定，可以动态更新一个正在运行的集群：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"persistent\"</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">\"indices.breaker.fielddata.limit\"</span> : <span class=\"string\">\"40%\"</span> </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最好为断路器设置一个相对保守点的值。 记住 fielddata 需要与 request 断路器共享堆内存、索引缓冲内存和过滤器缓存。Lucene 的数据被用来构造索引，以及各种其他临时的数据结构。 正因如此，它默认值非常保守，只有 60% 。过于乐观的设置可能会引起潜在的堆栈溢出（OOM）异常，这会使整个节点宕掉。</p>\n<blockquote>\n<p>在 Fielddata的大小 中，我们提过关于给 fielddata 的大小加一个限制，从而确保旧的无用 fielddata 被回收的方法。 indices.fielddata.cache.size 和 indices.breaker.fielddata.limit 之间的关系非常重要。 如果断路器的限制低于缓存大小，没有数据会被回收。为了能正常工作，断路器的限制 必须 要比缓存大小要高。</p>\n</blockquote>\n<h3 id=\"在设置-Elasticsearch-堆大小时需要通过-ES-HEAP-SIZE-环境变量应用两个规则：\"><a href=\"#在设置-Elasticsearch-堆大小时需要通过-ES-HEAP-SIZE-环境变量应用两个规则：\" class=\"headerlink\" title=\"在设置 Elasticsearch 堆大小时需要通过 $ES_HEAP_SIZE 环境变量应用两个规则：\"></a>在设置 Elasticsearch 堆大小时需要通过 $ES_HEAP_SIZE 环境变量应用两个规则：</h3><p>1 不要超过可用 RAM 的 50%<br>Lucene 能很好利用文件系统的缓存，它是通过系统内核管理的。如果没有足够的文件系统缓存空间，性能会受到影响。 此外，专用于堆的内存越多意味着其他所有使用 doc values 的字段内存越少。<br>2 不要超过 32 GB</p>\n<h2 id=\"如果堆大小小于-32-GB，JVM-可以利用指针压缩，这可以大大降低内存的使用：每个指针-4-字节而不是-8-字节。\"><a href=\"#如果堆大小小于-32-GB，JVM-可以利用指针压缩，这可以大大降低内存的使用：每个指针-4-字节而不是-8-字节。\" class=\"headerlink\" title=\"如果堆大小小于 32 GB，JVM 可以利用指针压缩，这可以大大降低内存的使用：每个指针 4 字节而不是 8 字节。\"></a>如果堆大小小于 32 GB，JVM 可以利用指针压缩，这可以大大降低内存的使用：每个指针 4 字节而不是 8 字节。</h2>","comments":true,"permalink":"https://blog.k1s.club/2020/03/19/41-记一次es集群内存溢出的问题/","categories":[{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elasticsearch5","slug":"elk/elasticsearch5","permalink":"https://blog.k1s.club/categories/elk/elasticsearch5/"}],"tags":[{"name":"elasticsearch5","slug":"elasticsearch5","permalink":"https://blog.k1s.club/tags/elasticsearch5/"}]},{"title":"记一次跨域的nginx配置问题","date":"2020-03-18T10:26:35.000Z","path":"2020/03/18/40-记一次跨域的nginx配置问题/","text":"nginx跨域的Access-Control-Allow-Origin的配置 和多域名配置的问题 简单配置 1. nginx 配置单个域名123add_header Access-Control-Allow-Origin \"a.test.com\";add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;add_header Access-Control-Allow-Headers authorization,sign,vary-client; 2. nginx 配置所有域名1234add_header Access-Control-Allow-Origin \"*\";add_header Access-Control-Allow-Credentials true;add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;add_header Access-Control-Allow-Headers authorization,sign,vary-client; 3. nginx 配置多域名 一开始我是这样配置的: 123456789101112 ###################这里是配置多域名跨域配置set $F_Allow_Origin \"127.0.0.1\"; #如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin if ( \"$http_origin\" ~ \"[a-z]+.zhangzw.com\" ) &#123; set $F_Allow_Origin \"$http_origin\"; &#125; add_header F_Allow_Origin \"$http_origin\"; add_header Access-Control-Allow-Origin \"$http_origin\"; add_header Access-Control-Allow-Credentials true; add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE; add_header Access-Control-Allow-Headers authorization,sign,vary-client; ###################这里是配置多域名跨域配置 测试之后发现页面还是报没有Access-Control-Allow-Origin 头, 原因是我这边由b.test.com -&gt; a.test.com, F_Allow_Origin自定义头并没有向下传递. 123456789101112###################这里是配置多域名跨域配置#如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin#if ( \"$http_origin\" !~ \"[a-z]+.zhangzw.com\" ) &#123;# return 403;#&#125;add_header Bq_F_Allow_Origin \"$http_origin\";#add_header Access-Control-Allow-Origin \"$http_origin\";add_header Access-Control-Allow-Origin \"*\";add_header Access-Control-Allow-Credentials true;add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;add_header Access-Control-Allow-Headers authorization,sign,vary-client;###################这里是配置多域名跨域配置","raw":"---\ntitle: 记一次跨域的nginx配置问题\ncopyright: true\ndate: 2020-03-18 18:26:35\ntags:\n  - nginx\ncategories:\n  - [技术文档]\n  - [nginx,问题总结]\n---\nnginx跨域的Access-Control-Allow-Origin的配置 和多域名配置的问题\n<!--more-->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 简单配置 </font>\n</center>\n\n### 1. nginx 配置单个域名\n```\n        add_header Access-Control-Allow-Origin \"a.test.com\";\n        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;\n        add_header Access-Control-Allow-Headers authorization,sign,vary-client;\n```\n\n### 2. nginx 配置所有域名\n```\n        add_header Access-Control-Allow-Origin \"*\";\n        add_header Access-Control-Allow-Credentials true;\n        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;\n        add_header Access-Control-Allow-Headers authorization,sign,vary-client;\n```\n\n### 3. nginx 配置多域名\n\n> 一开始我是这样配置的:\n```\n        ###################这里是配置多域名跨域配置\n\tset $F_Allow_Origin \"127.0.0.1\";\n        #如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin\n        if ( \"$http_origin\" ~ \"[a-z]+.zhangzw.com\" ) {\n               set $F_Allow_Origin \"$http_origin\";\n        }\n        add_header F_Allow_Origin \"$http_origin\";\n        add_header Access-Control-Allow-Origin \"$http_origin\";\n        add_header Access-Control-Allow-Credentials true;\n        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;\n        add_header Access-Control-Allow-Headers authorization,sign,vary-client;\n        ###################这里是配置多域名跨域配置\n```\n\n测试之后发现页面还是报没有Access-Control-Allow-Origin 头, 原因是我这边由b.test.com -> a.test.com, F_Allow_Origin自定义头并没有向下传递.\n\n```\n        ###################这里是配置多域名跨域配置\n        #如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin\n        #if ( \"$http_origin\" !~ \"[a-z]+.zhangzw.com\" ) {\n        #       return 403;\n        #}\n        add_header Bq_F_Allow_Origin \"$http_origin\";\n        #add_header Access-Control-Allow-Origin \"$http_origin\";\n        add_header Access-Control-Allow-Origin \"*\";\n        add_header Access-Control-Allow-Credentials true;\n        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;\n        add_header Access-Control-Allow-Headers authorization,sign,vary-client;\n        ###################这里是配置多域名跨域配置\n```\n\n\n","content":"<p>nginx跨域的Access-Control-Allow-Origin的配置 和多域名配置的问题</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 简单配置 </font>\n</center>\n\n<h3 id=\"1-nginx-配置单个域名\"><a href=\"#1-nginx-配置单个域名\" class=\"headerlink\" title=\"1. nginx 配置单个域名\"></a>1. nginx 配置单个域名</h3><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-<span class=\"keyword\">Origin </span><span class=\"string\">\"a.test.com\"</span><span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE<span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-Headers authorization,sign,vary-client<span class=\"comment\">;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-nginx-配置所有域名\"><a href=\"#2-nginx-配置所有域名\" class=\"headerlink\" title=\"2. nginx 配置所有域名\"></a>2. nginx 配置所有域名</h3><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-<span class=\"keyword\">Origin </span><span class=\"string\">\"*\"</span><span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-Credentials true<span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE<span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"keyword\">add_header </span>Access-Control-Allow-Headers authorization,sign,vary-client<span class=\"comment\">;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-nginx-配置多域名\"><a href=\"#3-nginx-配置多域名\" class=\"headerlink\" title=\"3. nginx 配置多域名\"></a>3. nginx 配置多域名</h3><blockquote>\n<p>一开始我是这样配置的:</p>\n</blockquote>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ###################这里是配置多域名跨域配置</span><br><span class=\"line\">set $F_Allow_Origin <span class=\"string\">\"127.0.0.1\"</span>;</span><br><span class=\"line\">       #如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin</span><br><span class=\"line\">       <span class=\"keyword\">if</span> ( <span class=\"string\">\"$http_origin\"</span> ~ <span class=\"string\">\"[a-z]+.zhangzw.com\"</span> ) &#123;</span><br><span class=\"line\">              set $F_Allow_Origin <span class=\"string\">\"$http_origin\"</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       add_header F_Allow_Origin <span class=\"string\">\"$http_origin\"</span>;</span><br><span class=\"line\">       add_header Access-Control-Allow-Origin <span class=\"string\">\"$http_origin\"</span>;</span><br><span class=\"line\">       add_header Access-Control-Allow-Credentials true;</span><br><span class=\"line\">       add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;</span><br><span class=\"line\">       add_header Access-Control-Allow-Headers authorization,sign,vary-client;</span><br><span class=\"line\">       ###################这里是配置多域名跨域配置</span><br></pre></td></tr></table></figure>\n\n<p>测试之后发现页面还是报没有Access-Control-Allow-Origin 头, 原因是我这边由b.test.com -&gt; a.test.com, F_Allow_Origin自定义头并没有向下传递.</p>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###################这里是配置多域名跨域配置</span><br><span class=\"line\">#如果是允许的域名则设置Access-Control-Allow-Origin 为该$http_origin</span><br><span class=\"line\">#<span class=\"keyword\">if</span> ( <span class=\"string\">\"$http_origin\"</span> !~ <span class=\"string\">\"[a-z]+.zhangzw.com\"</span> ) &#123;</span><br><span class=\"line\">#       return <span class=\"number\">403</span>;</span><br><span class=\"line\">#&#125;</span><br><span class=\"line\">add_header Bq_F_Allow_Origin <span class=\"string\">\"$http_origin\"</span>;</span><br><span class=\"line\">#add_header Access-Control-Allow-Origin <span class=\"string\">\"$http_origin\"</span>;</span><br><span class=\"line\">add_header Access-Control-Allow-Origin <span class=\"string\">\"*\"</span>;</span><br><span class=\"line\">add_header Access-Control-Allow-Credentials true;</span><br><span class=\"line\">add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;</span><br><span class=\"line\">add_header Access-Control-Allow-Headers authorization,sign,vary-client;</span><br><span class=\"line\">###################这里是配置多域名跨域配置</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/18/40-记一次跨域的nginx配置问题/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/categories/nginx/"},{"name":"问题总结","slug":"nginx/问题总结","permalink":"https://blog.k1s.club/categories/nginx/问题总结/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/tags/nginx/"}]},{"title":"记一次nginx的request_time 和upstream_response_time差值很大问题","date":"2020-03-18T02:43:34.000Z","path":"2020/03/18/39-记一次nginx的request-time-和upstream-response-time差值很大问题/","text":"遇到一个接口, 经过了nginx反向代理,request_time时间是60s+, upstream_response_time 在0.5s左右 首先问题描述我们发现后端响应时间没问题, 从前端和后端的日志都发现响应状态是200, 说明请求都是正常的 那为啥会响应时间这么长呢? request_time: 指的是 (Nginx 建立连接 到 接收完数据并关闭连接)从代理nginx到后端(这里是php)建立连接到接受完数据然后关闭连接为止的时间 upstream_response_time: 指的是 (接受用户请求的第一个字节 到 发送完响应数据)从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间) 通过查看日志发现响应返回的字节量在 300k左右, 于是去看了下前端nginx的带宽, 并没有发现超过100%, 而且日志的同一时间的并不是所有请求都超过60s+ 因此看起来服务端也正常, 应该是客户端问题 通过询问开发, 发现是测试在本机疯狂的点击,导致并发高, 而测试的网络环境是限速5m, 显然客户端带宽接收数据限制导致了服务端发送延迟. 显然我们知道request_time: 指的是 从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间)","raw":"---\ntitle: 记一次nginx的request_time 和upstream_response_time差值很大问题\ncopyright: true\ndate: 2020-03-18 10:43:34\ntags:\n  - nginx\ncategories:\n  - [技术文档]\n  - [nginx,问题总结]\n---\n遇到一个接口, 经过了nginx反向代理,request_time时间是60s+, upstream_response_time 在0.5s左右\n\n<!--more-->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n首先问题描述我们发现后端响应时间没问题, 从前端和后端的日志都发现响应状态是200, 说明请求都是正常的\n\n那为啥会响应时间这么长呢?\n\n- request_time:  \t\t指的是 (Nginx 建立连接 到 接收完数据并关闭连接)\n从代理nginx到后端(这里是php)建立连接到接受完数据然后关闭连接为止的时间\n\n- upstream_response_time:\t指的是 (接受用户请求的第一个字节 到 发送完响应数据)\n从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间)\n\n通过查看日志发现响应返回的字节量在 300k左右, 于是去看了下前端nginx的带宽, 并没有发现超过100%, 而且日志的同一时间的并不是所有请求都超过60s+\n\n因此看起来服务端也正常, 应该是客户端问题\n\n通过询问开发, 发现是测试在本机疯狂的点击,导致并发高, 而测试的网络环境是限速5m, 显然客户端带宽接收数据限制导致了服务端发送延迟.\n\n显然我们知道request_time:  指的是 从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间)\n","content":"<p>遇到一个接口, 经过了nginx反向代理,request_time时间是60s+, upstream_response_time 在0.5s左右</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<p>首先问题描述我们发现后端响应时间没问题, 从前端和后端的日志都发现响应状态是200, 说明请求都是正常的</p>\n<p>那为啥会响应时间这么长呢?</p>\n<ul>\n<li><p>request_time:          指的是 (Nginx 建立连接 到 接收完数据并关闭连接)<br>从代理nginx到后端(这里是php)建立连接到接受完数据然后关闭连接为止的时间</p>\n</li>\n<li><p>upstream_response_time:    指的是 (接受用户请求的第一个字节 到 发送完响应数据)<br>从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间)</p>\n</li>\n</ul>\n<p>通过查看日志发现响应返回的字节量在 300k左右, 于是去看了下前端nginx的带宽, 并没有发现超过100%, 而且日志的同一时间的并不是所有请求都超过60s+</p>\n<p>因此看起来服务端也正常, 应该是客户端问题</p>\n<p>通过询问开发, 发现是测试在本机疯狂的点击,导致并发高, 而测试的网络环境是限速5m, 显然客户端带宽接收数据限制导致了服务端发送延迟.</p>\n<p>显然我们知道request_time:  指的是 从接受用户请求的第一个字节 到发送完响应数据的时间(包括接受请求数据时间,程序响应时间,输出响应时间)</p>\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/18/39-记一次nginx的request-time-和upstream-response-time差值很大问题/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/categories/nginx/"},{"name":"问题总结","slug":"nginx/问题总结","permalink":"https://blog.k1s.club/categories/nginx/问题总结/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/tags/nginx/"}]},{"title":"es集群节点出现overhead脱机的问题","date":"2020-03-12T07:23:35.000Z","path":"2020/03/12/38-es集群节点出现overhead脱机的问题/","text":"elasticsearch 日志提示 overhead, 导致集群出现问题 问题说明 elasticsearch 日志提示 overhead123456[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s][2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008938][256207] duration [24.8s], collections [1]/[25.5s], total [24.8s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [8.5mb]-&gt;[17.5mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;[2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008938] overhead, spent [24.8s] collecting in the last [25.5s] 查看elasticsearch 配置 heap size 是8G ES 内存使用和GC指标——默认情况下，主节点每30秒会去检查其他节点的状态，如果任何节点的垃圾回收时间超过30秒（Garbage collection duration），则会导致主节点任务该节点脱离集群。 设置过大的heap会导致GC时间过长，这些长时间的停顿（stop-the-world）会让集群错误的认为该节点已经脱离。 所以通过增加ping_timeout的时间，和增加ping_retries的次数来防止节点错误的脱离集群，可以使节点有充足的时间进行full GC。 问题解决 这里将默认的超时时间增加, 增加重试次数, 增加间隔时间1234#超时时间设为5分钟，超过6次心跳没有回应，则认为该节点脱离master，每隔60s发送一次心跳。 discovery.zen.fd.ping_timeout: 300s discovery.zen.fd.ping_retries: 6 discovery.zen.fd.ping_interval: 60s gc 垃圾回收算法 摘自原文: https://www.jianshu.com/p/1f450826f62e 标记-清除 算法(Mark Sweep)该算法很简单，使用通过可达性分析分析方法标记出垃圾，然后直接回收掉垃圾区域。它的一个显著问题是一段时间后，内存会出现大量碎片，导致虽然碎片总和很大，但无法满足一个大对象的内存申请，从而导致 OOM，而过多的内存碎片（需要类似链表的数据结构维护），也会导致标记和清除的操作成本高，效率低下，如下图所示： 复制算法(Copying)有人提出了复制算法。它将可用内存一分为二，每次只用一块，当这一块内存不够用时，便触发 GC，将当前存活对象复制(Copy)到另一块上，以此往复。这种算法高效的原因在于分配内存时只需要将指针后移，不需要维护链表等。但它最大的问题是对内存的浪费，使用率只有 50% 标记-整理算法(Mark Compact)该算法解决了第1中算法的内存碎片问题，它会在回收阶段将所有内存做整理 分代收集算法(Generation Collection)既然大部分 Java 对象是朝生夕死的，那么我们将内存按照 Java 生存时间分为 新生代(Young) 和 老年代(Old)，前者存放短命僧，后者存放长寿佛，当然长寿佛也是由短命僧升级上来的。然后针对两者可以采用不同的回收算法，比如对于新生代采用复制算法会比较高效，而对老年代可以采用标记-清除或者标记-整理算法。这种算法也是最常用的。JVM Heap 分代后的划分一般如下所示，新生代一般会分为 Eden、Survivor0、Survivor1区，便于使用复制算法。 将内存分代后的 GC 过程一般类似下图所示： 1 对象一般都是先在 Eden区创建2 当Eden区满，触发 Young GC，此时将 Eden中还存活的对象复制到 S0中，并清空 Eden区后继续为新的对象分配内存3 当Eden区再次满后，触发又一次的 Young GC，此时会将 Eden和S0中存活的对象复制到 S1中，然后清空Eden和S0后继续为新的对象分配内存4 每经过一次 Young GC，存活下来的对象都会将自己存活次数加1，当达到一定次数后，会随着一次 Young GC 晋升到 Old区5 Old区也会在合适的时机进行自己的 GC elasticsearch gc说明 Elasticsearch 默认的 GC 配置是CMS GC ，其 Young 区用 ParNew，Old 区用CMS，大家可以在 config/jvm.options中看到如下的配置： 1234## GC configuration-XX:+UseConcMarkSweepGC-XX:CMSInitiatingOccupancyFraction=75-XX:+UseCMSInitiatingOccupancyOnly 何时进行回收1231 Young 区的GC 都是在 Eden 区满时触发2 Serial Old 和 Parallel Old 在 Old 区是在 Young GC 时预测Old 区是否可以为 young 区 promote 到 old 区 的 object 分配空间，如果不可用则触发 Old GC。这个也可以理解为是 Old区满时。3 CMS GC 是在 Old 区大小超过一定比例后触发，而不是 Old 区满。这个原因在于 CMS GC 是并发的算法，也就是说在 GC 线程收集垃圾的时候，用户线程也在运行，因此需要预留一些 Heap 空间给用户线程使用，防止由于无法分配空间而导致 Full GC 发生。 gc 日志说明123[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s] 本次是old gc, 这是第3008939次GC检查, 从java启动至今这是第256208次 gc 共花18.4s, [从上次检查至今共发生一次gc][从上次检查至今已经过去18.9s],[本次gc18.4s]/[从 JVM 启动至今发生的 GC 总耗时为5.7h], [ GC 前 Heap memory 空间]-&gt;[GC 后 Heap memory 空间]/[Heap memory 总空间] {[young 区][GC 前 Memory ]-&gt;[GC后 Memory]/[young区 Memory 总大小] } {[survivor 区][GC 前 Memory ]-&gt;[GC后 Memory]/[survivor区 Memory 总大小] }{[old 区][GC 前 Memory ]-&gt;[GC后 Memory]/[old区 Memory 总大小] }","raw":"title: es集群节点出现overhead脱机的问题\ncopyright: true\ndate: 2020-03-12 15:23:35\ntags:\n  - elasticsearch5\ncategories:\n  - [elk,elasticsearch5]\n---\nelasticsearch 日志提示 overhead, 导致集群出现问题\n<!--more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5>  问题说明 </font>\n</center>\n\n### elasticsearch 日志提示 overhead\n```\n[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]->[7.3gb]/[7.9gb], all_pools {[young] [17.5mb]->[3.3mb]/[532.5mb]}{[survivor] [0b]->[0b]/[66.5mb]}{[old] [7.3gb]->[7.3gb]/[7.3gb]}\n[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s]\n\n\n[2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008938][256207] duration [24.8s], collections [1]/[25.5s], total [24.8s]/[5.7h], memory [7.3gb]->[7.3gb]/[7.9gb], all_pools {[young] [8.5mb]->[17.5mb]/[532.5mb]}{[survivor] [0b]->[0b]/[66.5mb]}{[old] [7.3gb]->[7.3gb]/[7.3gb]}\n[2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008938] overhead, spent [24.8s] collecting in the last [25.5s]\n```\n\n查看elasticsearch 配置 heap size 是8G\n\nES 内存使用和GC指标——默认情况下，主节点每30秒会去检查其他节点的状态，如果任何节点的垃圾回收时间超过30秒（Garbage collection duration），则会导致主节点任务该节点脱离集群。\n\n设置过大的heap会导致GC时间过长，这些长时间的停顿（stop-the-world）会让集群错误的认为该节点已经脱离。\n\n所以通过增加ping_timeout的时间，和增加ping_retries的次数来防止节点错误的脱离集群，可以使节点有充足的时间进行full GC。\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5>  问题解决 </font>\n</center>\n\n### 这里将默认的超时时间增加, 增加重试次数, 增加间隔时间\n\n```\n#超时时间设为5分钟，超过6次心跳没有回应，则认为该节点脱离master，每隔60s发送一次心跳。\n discovery.zen.fd.ping_timeout: 300s\n discovery.zen.fd.ping_retries: 6\n discovery.zen.fd.ping_interval: 60s\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5>  gc 垃圾回收算法 </font>\n</center>\n\n> 摘自原文: [https://www.jianshu.com/p/1f450826f62e](https://www.jianshu.com/p/1f450826f62e)\n\n\n### 标记-清除 算法(Mark Sweep)\n该算法很简单，使用通过可达性分析分析方法标记出垃圾，然后直接回收掉垃圾区域。它的一个显著问题是一段时间后，内存会出现大量碎片，导致虽然碎片总和很大，但无法满足一个大对象的内存申请，从而导致 OOM，而过多的内存碎片（需要类似链表的数据结构维护），也会导致标记和清除的操作成本高，效率低下，如下图所示：\n\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc1.jpg\">\n</center>\n\n\n### 复制算法(Copying)\n有人提出了复制算法。它将可用内存一分为二，每次只用一块，当这一块内存不够用时，便触发 GC，将当前存活对象复制(Copy)到另一块上，以此往复。这种算法高效的原因在于分配内存时只需要将指针后移，不需要维护链表等。但它最大的问题是对内存的浪费，使用率只有 50%\n\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc2.jpg\">\n</center>\n\n\n### 标记-整理算法(Mark Compact)\n\n该算法解决了第1中算法的内存碎片问题，它会在回收阶段将所有内存做整理\n\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc3.jpg\">\n</center>\n\n### 分代收集算法(Generation Collection)\n\n既然大部分 Java 对象是朝生夕死的，那么我们将内存按照 Java 生存时间分为 新生代(Young) 和 老年代(Old)，前者存放短命僧，后者存放长寿佛，当然长寿佛也是由短命僧升级上来的。然后针对两者可以采用不同的回收算法，比如对于新生代采用复制算法会比较高效，而对老年代可以采用标记-清除或者标记-整理算法。这种算法也是最常用的。JVM Heap 分代后的划分一般如下所示，新生代一般会分为 Eden、Survivor0、Survivor1区，便于使用复制算法。\n\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc4.jpg\">\n</center>\n\n将内存分代后的 GC 过程一般类似下图所示：\n\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc5.jpg\">\n</center>\n\n1 对象一般都是先在 Eden区创建\n2 当Eden区满，触发 Young GC，此时将 Eden中还存活的对象复制到 S0中，并清空 Eden区后继续为新的对象分配内存\n3 当Eden区再次满后，触发又一次的 Young GC，此时会将 Eden和S0中存活的对象复制到 S1中，然后清空Eden和S0后继续为新的对象分配内存\n4 每经过一次 Young GC，存活下来的对象都会将自己存活次数加1，当达到一定次数后，会随着一次 Young GC 晋升到 Old区\n5 Old区也会在合适的时机进行自己的 GC\n\n\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5>  elasticsearch gc说明 </font>\n</center>\n\nElasticsearch 默认的 GC 配置是CMS GC ，其 Young 区用 ParNew，Old 区用CMS，大家可以在 config/jvm.options中看到如下的配置：\n\n```\n## GC configuration\n-XX:+UseConcMarkSweepGC\n-XX:CMSInitiatingOccupancyFraction=75\n-XX:+UseCMSInitiatingOccupancyOnly\n```\n\n### 何时进行回收\n```\n1 Young 区的GC 都是在 Eden 区满时触发\n2 Serial Old 和 Parallel Old 在 Old 区是在 Young GC 时预测Old 区是否可以为 young 区 promote 到 old 区 的 object 分配空间，如果不可用则触发 Old GC。这个也可以理解为是 Old区满时。\n3 CMS GC 是在 Old 区大小超过一定比例后触发，而不是 Old 区满。这个原因在于 CMS GC 是并发的算法，也就是说在 GC 线程收集垃圾的时候，用户线程也在运行，因此需要预留一些 Heap 空间给用户线程使用，防止由于无法分配空间而导致 Full GC 发生。\n```\n\n### gc 日志说明\n```\n[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]->[7.3gb]/[7.9gb], all_pools {[young] [17.5mb]->[3.3mb]/[532.5mb]}{[survivor] [0b]->[0b]/[66.5mb]}{[old] [7.3gb]->[7.3gb]/[7.3gb]}\n\n[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s]\n```\n\n本次是old gc, 这是第3008939次GC检查, 从java启动至今这是第256208次 gc 共花18.4s, [从上次检查至今共发生一次gc][从上次检查至今已经过去18.9s],[本次gc18.4s]/[从 JVM 启动至今发生的 GC 总耗时为5.7h],  [ GC 前 Heap memory 空间]->[GC 后 Heap memory 空间]/[Heap memory 总空间]\n\n{[young 区][GC 前 Memory ]->[GC后 Memory]/[young区 Memory 总大小] } {[survivor 区][GC 前 Memory ]->[GC后 Memory]/[survivor区 Memory 总大小] }{[old 区][GC 前 Memory ]->[GC后 Memory]/[old区 Memory 总大小] }\n","content":"<p>elasticsearch 日志提示 overhead, 导致集群出现问题</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\">  问题说明 </font>\n</center>\n\n<h3 id=\"elasticsearch-日志提示-overhead\"><a href=\"#elasticsearch-日志提示-overhead\" class=\"headerlink\" title=\"elasticsearch 日志提示 overhead\"></a>elasticsearch 日志提示 overhead</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">2020-03-12T14:38:03,565</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">old</span>][<span class=\"string\">3008939</span>][<span class=\"symbol\">256208</span>] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;</span><br><span class=\"line\">[<span class=\"string\">2020-03-12T14:38:03,593</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">3008939</span>] overhead, spent [18.4s] collecting in the last [18.9s]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">2020-03-12T14:37:44,632</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">old</span>][<span class=\"string\">3008938</span>][<span class=\"symbol\">256207</span>] duration [24.8s], collections [1]/[25.5s], total [24.8s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [8.5mb]-&gt;[17.5mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;</span><br><span class=\"line\">[<span class=\"string\">2020-03-12T14:37:44,632</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">3008938</span>] overhead, spent [24.8s] collecting in the last [25.5s]</span><br></pre></td></tr></table></figure>\n\n<p>查看elasticsearch 配置 heap size 是8G</p>\n<p>ES 内存使用和GC指标——默认情况下，主节点每30秒会去检查其他节点的状态，如果任何节点的垃圾回收时间超过30秒（Garbage collection duration），则会导致主节点任务该节点脱离集群。</p>\n<p>设置过大的heap会导致GC时间过长，这些长时间的停顿（stop-the-world）会让集群错误的认为该节点已经脱离。</p>\n<p>所以通过增加ping_timeout的时间，和增加ping_retries的次数来防止节点错误的脱离集群，可以使节点有充足的时间进行full GC。</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\">  问题解决 </font>\n</center>\n\n<h3 id=\"这里将默认的超时时间增加-增加重试次数-增加间隔时间\"><a href=\"#这里将默认的超时时间增加-增加重试次数-增加间隔时间\" class=\"headerlink\" title=\"这里将默认的超时时间增加, 增加重试次数, 增加间隔时间\"></a>这里将默认的超时时间增加, 增加重试次数, 增加间隔时间</h3><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#超时时间设为<span class=\"number\">5</span>分钟，超过<span class=\"number\">6</span>次心跳没有回应，则认为该节点脱离master，每隔<span class=\"number\">60s</span>发送一次心跳。</span><br><span class=\"line\"> discovery<span class=\"selector-class\">.zen</span><span class=\"selector-class\">.fd</span><span class=\"selector-class\">.ping_timeout</span>: <span class=\"number\">300s</span></span><br><span class=\"line\"> discovery<span class=\"selector-class\">.zen</span><span class=\"selector-class\">.fd</span><span class=\"selector-class\">.ping_retries</span>: <span class=\"number\">6</span></span><br><span class=\"line\"> discovery<span class=\"selector-class\">.zen</span><span class=\"selector-class\">.fd</span><span class=\"selector-class\">.ping_interval</span>: <span class=\"number\">60s</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\">  gc 垃圾回收算法 </font>\n</center>\n\n<blockquote>\n<p>摘自原文: <a href=\"https://www.jianshu.com/p/1f450826f62e\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/1f450826f62e</a></p>\n</blockquote>\n<h3 id=\"标记-清除-算法-Mark-Sweep\"><a href=\"#标记-清除-算法-Mark-Sweep\" class=\"headerlink\" title=\"标记-清除 算法(Mark Sweep)\"></a>标记-清除 算法(Mark Sweep)</h3><p>该算法很简单，使用通过可达性分析分析方法标记出垃圾，然后直接回收掉垃圾区域。它的一个显著问题是一段时间后，内存会出现大量碎片，导致虽然碎片总和很大，但无法满足一个大对象的内存申请，从而导致 OOM，而过多的内存碎片（需要类似链表的数据结构维护），也会导致标记和清除的操作成本高，效率低下，如下图所示：</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc1.jpg\">\n</center>\n\n\n<h3 id=\"复制算法-Copying\"><a href=\"#复制算法-Copying\" class=\"headerlink\" title=\"复制算法(Copying)\"></a>复制算法(Copying)</h3><p>有人提出了复制算法。它将可用内存一分为二，每次只用一块，当这一块内存不够用时，便触发 GC，将当前存活对象复制(Copy)到另一块上，以此往复。这种算法高效的原因在于分配内存时只需要将指针后移，不需要维护链表等。但它最大的问题是对内存的浪费，使用率只有 50%</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc2.jpg\">\n</center>\n\n\n<h3 id=\"标记-整理算法-Mark-Compact\"><a href=\"#标记-整理算法-Mark-Compact\" class=\"headerlink\" title=\"标记-整理算法(Mark Compact)\"></a>标记-整理算法(Mark Compact)</h3><p>该算法解决了第1中算法的内存碎片问题，它会在回收阶段将所有内存做整理</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc3.jpg\">\n</center>\n\n<h3 id=\"分代收集算法-Generation-Collection\"><a href=\"#分代收集算法-Generation-Collection\" class=\"headerlink\" title=\"分代收集算法(Generation Collection)\"></a>分代收集算法(Generation Collection)</h3><p>既然大部分 Java 对象是朝生夕死的，那么我们将内存按照 Java 生存时间分为 新生代(Young) 和 老年代(Old)，前者存放短命僧，后者存放长寿佛，当然长寿佛也是由短命僧升级上来的。然后针对两者可以采用不同的回收算法，比如对于新生代采用复制算法会比较高效，而对老年代可以采用标记-清除或者标记-整理算法。这种算法也是最常用的。JVM Heap 分代后的划分一般如下所示，新生代一般会分为 Eden、Survivor0、Survivor1区，便于使用复制算法。</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc4.jpg\">\n</center>\n\n<p>将内存分代后的 GC 过程一般类似下图所示：</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/38/gc5.jpg\">\n</center>\n\n<p>1 对象一般都是先在 Eden区创建<br>2 当Eden区满，触发 Young GC，此时将 Eden中还存活的对象复制到 S0中，并清空 Eden区后继续为新的对象分配内存<br>3 当Eden区再次满后，触发又一次的 Young GC，此时会将 Eden和S0中存活的对象复制到 S1中，然后清空Eden和S0后继续为新的对象分配内存<br>4 每经过一次 Young GC，存活下来的对象都会将自己存活次数加1，当达到一定次数后，会随着一次 Young GC 晋升到 Old区<br>5 Old区也会在合适的时机进行自己的 GC</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\">  elasticsearch gc说明 </font>\n</center>\n\n<p>Elasticsearch 默认的 GC 配置是CMS GC ，其 Young 区用 ParNew，Old 区用CMS，大家可以在 config/jvm.options中看到如下的配置：</p>\n<figure class=\"highlight ldif\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## GC configuration</span></span><br><span class=\"line\"><span class=\"literal\">-XX:+UseConcMarkSweepGC</span></span><br><span class=\"line\"><span class=\"literal\">-XX:CMSInitiatingOccupancyFraction=75</span></span><br><span class=\"line\"><span class=\"literal\">-XX:+UseCMSInitiatingOccupancyOnly</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"何时进行回收\"><a href=\"#何时进行回收\" class=\"headerlink\" title=\"何时进行回收\"></a>何时进行回收</h3><figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>Young 区的GC 都是在 Eden 区满时触发</span><br><span class=\"line\"><span class=\"symbol\">2 </span>Serial Old 和 Parallel Old 在 Old 区是在 Young GC 时预测Old 区是否可以为 young 区 promote 到 old 区 的 object 分配空间，如果不可用则触发 Old GC。这个也可以理解为是 Old区满时。</span><br><span class=\"line\"><span class=\"symbol\">3 </span>CMS GC 是在 Old 区大小超过一定比例后触发，而不是 Old 区满。这个原因在于 CMS GC 是并发的算法，也就是说在 GC 线程收集垃圾的时候，用户线程也在运行，因此需要预留一些 Heap 空间给用户线程使用，防止由于无法分配空间而导致 Full GC 发生。</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"gc-日志说明\"><a href=\"#gc-日志说明\" class=\"headerlink\" title=\"gc 日志说明\"></a>gc 日志说明</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">2020-03-12T14:38:03,565</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">old</span>][<span class=\"string\">3008939</span>][<span class=\"symbol\">256208</span>] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools &#123;[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]&#125;&#123;[survivor] [0b]-&gt;[0b]/[66.5mb]&#125;&#123;[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">2020-03-12T14:38:03,593</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">es7-u</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">3008939</span>] overhead, spent [18.4s] collecting in the last [18.9s]</span><br></pre></td></tr></table></figure>\n\n<p>本次是old gc, 这是第3008939次GC检查, 从java启动至今这是第256208次 gc 共花18.4s, [从上次检查至今共发生一次gc][从上次检查至今已经过去18.9s],[本次gc18.4s]/[从 JVM 启动至今发生的 GC 总耗时为5.7h],  [ GC 前 Heap memory 空间]-&gt;[GC 后 Heap memory 空间]/[Heap memory 总空间]</p>\n<p>{[young 区][GC 前 Memory ]-&gt;[GC后 Memory]/[young区 Memory 总大小] } {[survivor 区][GC 前 Memory ]-&gt;[GC后 Memory]/[survivor区 Memory 总大小] }{[old 区][GC 前 Memory ]-&gt;[GC后 Memory]/[old区 Memory 总大小] }</p>\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/12/38-es集群节点出现overhead脱机的问题/","categories":[{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elasticsearch5","slug":"elk/elasticsearch5","permalink":"https://blog.k1s.club/categories/elk/elasticsearch5/"}],"tags":[{"name":"elasticsearch5","slug":"elasticsearch5","permalink":"https://blog.k1s.club/tags/elasticsearch5/"}]},{"title":"mac一些常用命令","date":"2020-03-10T09:39:36.000Z","path":"2020/03/10/37-mac一些常用命令/","text":"记录一些常用的mac工具和方法 1. Item2 1.1 同时按住 option(alt) 键，可以以列选中，类似于 sublime3中 按住 alt的列选中 。Command + option(alt) 1.2 剪贴板历史记录Command + Shift + h 1.3 将文本内容复制到剪切板pbcopy &lt; a.txt 2. 其他 1.4 前进的快捷键12341. sublime3command + shift + z (比后退 command + z 多一个shift)或者command + y","raw":"---\ntitle: mac一些常用命令\ncopyright: true\ndate: 2020-03-10 17:39:36\ntags:\n  - mac\ncategories:\n  - [技术文档]\n  - [mac]\n  - [item2]\n---\n记录一些常用的mac工具和方法\n<!-- more-->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 1. Item2 </font>\n</center>\n\n- 1.1 同时按住 option(alt) 键，可以以列选中，类似于 sublime3中 按住 alt的列选中 。\n`Command + option(alt) `\n\n- 1.2 剪贴板历史记录\n`Command + Shift + h`\n\n- 1.3 将文本内容复制到剪切板\n`pbcopy < a.txt`\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 2. 其他 </font>\n</center>\n\n- 1.4 前进的快捷键\n```\n1. sublime3\ncommand + shift + z   (比后退 command + z 多一个shift)\n或者\ncommand + y\n```\n","content":"<p>记录一些常用的mac工具和方法</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 1. Item2 </font>\n</center>\n\n<ul>\n<li><p>1.1 同时按住 option(alt) 键，可以以列选中，类似于 sublime3中 按住 alt的列选中 。<br><code>Command + option(alt)</code></p>\n</li>\n<li><p>1.2 剪贴板历史记录<br><code>Command + Shift + h</code></p>\n</li>\n<li><p>1.3 将文本内容复制到剪切板<br><code>pbcopy &lt; a.txt</code></p>\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 2. 其他 </font>\n</center>\n\n<ul>\n<li>1.4 前进的快捷键<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. sublime3</span><br><span class=\"line\"><span class=\"built_in\">command</span> + <span class=\"built_in\">shift</span> + z   (比后退 <span class=\"built_in\">command</span> + z 多一个<span class=\"built_in\">shift</span>)</span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"built_in\">command</span> + y</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2020/03/10/37-mac一些常用命令/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"mac","slug":"mac","permalink":"https://blog.k1s.club/categories/mac/"},{"name":"item2","slug":"item2","permalink":"https://blog.k1s.club/categories/item2/"}],"tags":[{"name":"mac","slug":"mac","permalink":"https://blog.k1s.club/tags/mac/"}]},{"title":"centos单网卡配置多ip的几种方法","date":"2020-02-27T03:48:51.000Z","path":"2020/02/27/36-centos单网卡配置多ip的几种方法/","text":"centos单网卡配置多ip的几种方法 方法一 新建IP别名 临时设置, 不需要重启 12ifconfig enp0s3:1 192.168.53.109/24ifconfig enp0s3:1 down 配置文件设置, 需要重启 12345678910#cat ifcfg-enp0s3:1DEVICE=enp0s3IPADDR=192.168.53.109NETMASK=255.255.255.0# 重启网络service network restart# 查看(ifconfig 也可以查看)ip a 或ifconfig 方法二 临时设置, 不需要重启1ip addr add 192.168.53.110/24 dev enp0s3 label enp0s3:2 方法三 临时设置, 不需要重启1ifconfig enp0s3:3 192.168.53.111 netmask 255.255.255.0 方法四 同一个配置文件设置, 需要重启。IP地址没有别名不好进行管理。1234567891011121314#cat ifcfg-enp0s3DEVICE=enp0s3IPADDR=192.168.53.106IPADDR1=192.168.53.112IPADDR2=192.168.53.113PREFIX=24PREFIX1=24PREFIX2=24# 重启网络service network restart# 查看(ifconfig 不可以查看)ip a 注:这里奇怪的是, 实际配置中,出现个别ip使用方法二,三时仅部分内网可以联通,例如10.10.76.1 通过方法二配置, 从10.10.76.2上可以ping通, 但是从10.10.53.1上无法ping通(10.10.53.1和10.10.76.2是可以ping通)但是通过方法四配置就正常… 目前没有找到原因… 或与公司路由器有关","raw":"---\ntitle: centos单网卡配置多ip的几种方法\ncopyright: true\ndate: 2020-02-27 11:48:51\ntags:\n  - linux\n  - ip\ncategories:\n  - [技术文档]\n  - [linux]\n  - [网卡]\n---\ncentos单网卡配置多ip的几种方法\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### 方法一 新建IP别名\n> 临时设置, 不需要重启\n```\nifconfig enp0s3:1 192.168.53.109/24\nifconfig enp0s3:1 down\n```\n\n> 配置文件设置, 需要重启\n```\n#cat ifcfg-enp0s3:1\nDEVICE=enp0s3\nIPADDR=192.168.53.109\nNETMASK=255.255.255.0\n\n# 重启网络\nservice network restart\n\n# 查看(ifconfig 也可以查看)\nip a 或ifconfig\n```\n\n\n### 方法二  临时设置, 不需要重启\n```\nip addr add 192.168.53.110/24 dev enp0s3 label enp0s3:2\n```\n\n### 方法三  临时设置, 不需要重启\n\n```\nifconfig enp0s3:3 192.168.53.111 netmask 255.255.255.0\n```\n\n### 方法四 同一个配置文件设置, 需要重启。IP地址没有别名不好进行管理。\n```\n#cat ifcfg-enp0s3\nDEVICE=enp0s3\nIPADDR=192.168.53.106\nIPADDR1=192.168.53.112\nIPADDR2=192.168.53.113\nPREFIX=24\nPREFIX1=24\nPREFIX2=24\n\n# 重启网络\nservice network restart\n\n# 查看(ifconfig 不可以查看)\nip a \n```\n\n> 注:\n这里奇怪的是, 实际配置中,出现个别ip使用方法二,三时仅部分内网可以联通,例如\n10.10.76.1 通过方法二配置, 从10.10.76.2上可以ping通, 但是从10.10.53.1上无法ping通(10.10.53.1和10.10.76.2是可以ping通)\n但是通过方法四配置就正常... 目前没有找到原因... 或与公司路由器有关\n","content":"<p>centos单网卡配置多ip的几种方法</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"方法一-新建IP别名\"><a href=\"#方法一-新建IP别名\" class=\"headerlink\" title=\"方法一 新建IP别名\"></a>方法一 新建IP别名</h3><blockquote>\n<p>临时设置, 不需要重启</p>\n</blockquote>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ifconfig enp0s3:<span class=\"number\">1</span> <span class=\"number\">192.168</span><span class=\"meta\">.53</span><span class=\"meta\">.109</span>/<span class=\"number\">24</span></span><br><span class=\"line\">ifconfig enp0s3:<span class=\"number\">1</span> <span class=\"meta\">down</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>配置文件设置, 需要重启</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cat ifcfg-enp0s3:1</span></span><br><span class=\"line\"><span class=\"attribute\">DEVICE</span>=enp0s3</span><br><span class=\"line\"><span class=\"attribute\">IPADDR</span>=192.168.53.109</span><br><span class=\"line\"><span class=\"attribute\">NETMASK</span>=255.255.255.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启网络</span></span><br><span class=\"line\">service<span class=\"built_in\"> network </span>restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看(ifconfig 也可以查看)</span></span><br><span class=\"line\">ip a 或ifconfig</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法二-临时设置-不需要重启\"><a href=\"#方法二-临时设置-不需要重启\" class=\"headerlink\" title=\"方法二  临时设置, 不需要重启\"></a>方法二  临时设置, 不需要重启</h3><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">ip</span> addr <span class=\"keyword\">add</span> <span class=\"number\">192.168</span><span class=\"meta\">.53</span><span class=\"meta\">.110</span>/<span class=\"number\">24</span> dev enp0s3 label enp0s3:<span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法三-临时设置-不需要重启\"><a href=\"#方法三-临时设置-不需要重启\" class=\"headerlink\" title=\"方法三  临时设置, 不需要重启\"></a>方法三  临时设置, 不需要重启</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">ifconfig</span> <span class=\"selector-tag\">enp0s3</span><span class=\"selector-pseudo\">:3</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.111</span> <span class=\"selector-tag\">netmask</span> 255<span class=\"selector-class\">.255</span><span class=\"selector-class\">.255</span><span class=\"selector-class\">.0</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法四-同一个配置文件设置-需要重启。IP地址没有别名不好进行管理。\"><a href=\"#方法四-同一个配置文件设置-需要重启。IP地址没有别名不好进行管理。\" class=\"headerlink\" title=\"方法四 同一个配置文件设置, 需要重启。IP地址没有别名不好进行管理。\"></a>方法四 同一个配置文件设置, 需要重启。IP地址没有别名不好进行管理。</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cat ifcfg-enp0s3</span></span><br><span class=\"line\"><span class=\"attribute\">DEVICE</span>=enp0s3</span><br><span class=\"line\"><span class=\"attribute\">IPADDR</span>=192.168.53.106</span><br><span class=\"line\"><span class=\"attribute\">IPADDR1</span>=192.168.53.112</span><br><span class=\"line\"><span class=\"attribute\">IPADDR2</span>=192.168.53.113</span><br><span class=\"line\"><span class=\"attribute\">PREFIX</span>=24</span><br><span class=\"line\"><span class=\"attribute\">PREFIX1</span>=24</span><br><span class=\"line\"><span class=\"attribute\">PREFIX2</span>=24</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启网络</span></span><br><span class=\"line\">service<span class=\"built_in\"> network </span>restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看(ifconfig 不可以查看)</span></span><br><span class=\"line\">ip a</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注:<br>这里奇怪的是, 实际配置中,出现个别ip使用方法二,三时仅部分内网可以联通,例如<br>10.10.76.1 通过方法二配置, 从10.10.76.2上可以ping通, 但是从10.10.53.1上无法ping通(10.10.53.1和10.10.76.2是可以ping通)<br>但是通过方法四配置就正常… 目前没有找到原因… 或与公司路由器有关</p>\n</blockquote>\n","comments":true,"permalink":"https://blog.k1s.club/2020/02/27/36-centos单网卡配置多ip的几种方法/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"网卡","slug":"网卡","permalink":"https://blog.k1s.club/categories/网卡/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/tags/linux/"},{"name":"ip","slug":"ip","permalink":"https://blog.k1s.club/tags/ip/"}]},{"title":"raid1盘数据迁移","date":"2020-02-27T01:54:38.000Z","path":"2020/02/27/35-raid1盘数据迁移/","text":"dell PowerEdge 1950 服务器两块盘做raid1的linux操作系统, 开机后无限重启的一次数据迁移 考虑到raid1数据是互为备份,直接取一块盘应该能够拿到所有数据 首先对dell PowerEdge 1950 服务器 开机, 在提示ctrl +c的页面上进入sas页面, 进入选中磁盘后回车, 然后选择 SAS Topology页面, 可以看到是两块盘做的raid1 raid1 信息确认完毕 关闭1950服务器, 取下其中一块盘, 这里看到硬盘是sata盘 考虑到该盘不确定是否支持热插拔, 这里是将sata盘放入usb盘接到某台Linux服务器, 然后挂载, 挂载注意fdisk -l 看下具体分区, 我这里是/dev/sdb3 mount /data /dev/sdb3 进入/data, 就会看到raid1硬盘中保留的所有数据","raw":"---\ntitle: raid1盘数据迁移\ncopyright: true\ndate: 2020-02-27 09:54:38\ntags:\n  - raid\ncategories:\n  - [技术文档]\n  - [raid]\n---\n\ndell PowerEdge 1950 服务器两块盘做raid1的linux操作系统, 开机后无限重启的一次数据迁移\n\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n> 考虑到raid1数据是互为备份,直接取一块盘应该能够拿到所有数据\n\n\n1. 首先对dell PowerEdge 1950 服务器 开机, 在提示ctrl +c的页面上进入sas页面, 进入选中磁盘后回车, 然后选择 SAS Topology页面, 可以看到是两块盘做的raid1\n\n>  raid1 信息确认完毕\n\n\n2. 关闭1950服务器, 取下其中一块盘,  这里看到硬盘是sata盘\n\n3. 考虑到该盘不确定是否支持热插拔, 这里是将sata盘放入usb盘接到某台Linux服务器, 然后挂载, 挂载注意fdisk -l 看下具体分区, 我这里是/dev/sdb3\n\n    mount /data /dev/sdb3\n\n4. 进入/data, 就会看到raid1硬盘中保留的所有数据\n\n","content":"<p>dell PowerEdge 1950 服务器两块盘做raid1的linux操作系统, 开机后无限重启的一次数据迁移</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<blockquote>\n<p>考虑到raid1数据是互为备份,直接取一块盘应该能够拿到所有数据</p>\n</blockquote>\n<ol>\n<li>首先对dell PowerEdge 1950 服务器 开机, 在提示ctrl +c的页面上进入sas页面, 进入选中磁盘后回车, 然后选择 SAS Topology页面, 可以看到是两块盘做的raid1</li>\n</ol>\n<blockquote>\n<p> raid1 信息确认完毕</p>\n</blockquote>\n<ol start=\"2\">\n<li><p>关闭1950服务器, 取下其中一块盘,  这里看到硬盘是sata盘</p>\n</li>\n<li><p>考虑到该盘不确定是否支持热插拔, 这里是将sata盘放入usb盘接到某台Linux服务器, 然后挂载, 挂载注意fdisk -l 看下具体分区, 我这里是/dev/sdb3</p>\n<p> mount /data /dev/sdb3</p>\n</li>\n<li><p>进入/data, 就会看到raid1硬盘中保留的所有数据</p>\n</li>\n</ol>\n","comments":true,"permalink":"https://blog.k1s.club/2020/02/27/35-raid1盘数据迁移/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"raid","slug":"raid","permalink":"https://blog.k1s.club/categories/raid/"}],"tags":[{"name":"raid","slug":"raid","permalink":"https://blog.k1s.club/tags/raid/"}]},{"title":"k8s一些命令总结","date":"2019-12-05T01:25:59.000Z","path":"2019/12/05/34-k8s一些命令总结/","text":"记录一些kubectl命令 kubectl命令表 常用命令1234567891011121314# 让内网可以访问 k8s proxy(k8smaster是:192.168.1.111kubectl proxy --address='192.168.1.111' -p 10000 --accept-hosts='^172.*$'# 查看api类型kubectl api-versions # 让master也运行pod（默认master不运行pod,单机会用到）kubectl taint nodes --all node-role.kubernetes.io/master-# patch补丁, 强制更新kubectl patch -f deployment.yaml -p \"&#123;\\\"spec\\\":&#123;\\\"template\\\":&#123;\\\"metadata\\\":&#123;\\\"annotations\\\":&#123;\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"&#125;&#125;&#125;&#125;&#125;\"# 端口转发kubectl -n default port-forward service/prometheus-server 30080:80 scale 使用123# 通过将rc的副本数重新设置为0后，再将副本数设置为2，达到重启nginx的效果。kubectl scale deployment bq-front1 --replicas=0 -n webkubectl scale deployment bq-front1 --replicas=2 -n web metrics 相关123456789# 查看node 资源kubectl top nodes# 查看pods 资源kubectl top pods -n php-dev# 获取metrics接口所有数据kubectl get --raw /metrics# patch强制更新(慎用)kubectl patch -f deployment.yaml -p \"&#123;\\\"spec\\\":&#123;\\\"template\\\":&#123;\\\"metadata\\\":&#123;\\\"annotations\\\":&#123;\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"&#125;&#125;&#125;&#125;&#125;\" 根据版本缩放123456789101112#查看Deployment的变更信息（以下信息得以保存，是创建时候加的“--record”这个选项起的作用）：kubectl rollout history deployment/bq-nginx-php7 -n webkubectl rollout undo deployment/bq-nginx-php7 # 回退到上一版本kubectl rollout undo deployment/bq-nginx-php7 --to-revision=2 # 回退到指定版本kubectl describe deployments/bq-nginx-php7 -n web #查询详细信息，获取升级进度kubectl rollout pause deployment/bq-nginx-php7 -n web #暂停升级kubectl rollout resume deployment/bq-nginx-php7 -n web #继续升级kubectl rollout undo deployment/bq-nginx-php7 -n web #升级回滚kubectl scale deployment bq-nginx-php7 --replicas 2 -n web #弹性伸缩Pod数量kubectl get ns --show-labels # 查看标签,除了ns, 也可以是node,pod等","raw":"---\ntitle: k8s一些命令总结\ncopyright: true\ndate: 2019-12-05 09:25:59\ntags:\n  - k8s\n  - kubectl\ncategories:\n  - [k8s,kubectl]\n---\n\n记录一些kubectl命令\n<!-- more -->\n\n[kubectl命令表](http://docs.kubernetes.org.cn/683.html)\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 常用命令\n```\n# 让内网可以访问 k8s proxy(k8smaster是:192.168.1.111\nkubectl proxy --address='192.168.1.111' -p 10000 --accept-hosts='^172.*$'\n\n# 查看api类型\nkubectl api-versions \n\n# 让master也运行pod（默认master不运行pod,单机会用到）\nkubectl taint nodes --all node-role.kubernetes.io/master-\n\n# patch补丁, 强制更新\nkubectl patch -f deployment.yaml -p \"{\\\"spec\\\":{\\\"template\\\":{\\\"metadata\\\":{\\\"annotations\\\":{\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"}}}}}\"\n\n# 端口转发\nkubectl -n default port-forward service/prometheus-server 30080:80\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### scale 使用\n```\n# 通过将rc的副本数重新设置为0后，再将副本数设置为2，达到重启nginx的效果。\nkubectl scale deployment bq-front1 --replicas=0 -n web\nkubectl scale deployment bq-front1 --replicas=2 -n web\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### metrics 相关\n```\n# 查看node 资源\nkubectl top nodes\n# 查看pods 资源\nkubectl top pods -n php-dev\n# 获取metrics接口所有数据\nkubectl get --raw /metrics\n\n# patch强制更新(慎用)\nkubectl patch -f deployment.yaml -p \"{\\\"spec\\\":{\\\"template\\\":{\\\"metadata\\\":{\\\"annotations\\\":{\\\"ci-last-updated\\\":\\\"$(date +'%s')\\\"}}}}}\"\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 根据版本缩放\n```\n#查看Deployment的变更信息（以下信息得以保存，是创建时候加的“--record”这个选项起的作用）：\nkubectl rollout history deployment/bq-nginx-php7 -n web\nkubectl rollout undo deployment/bq-nginx-php7        # 回退到上一版本\nkubectl rollout undo deployment/bq-nginx-php7 --to-revision=2  # 回退到指定版本\n\nkubectl describe deployments/bq-nginx-php7 -n web       #查询详细信息，获取升级进度\nkubectl rollout pause deployment/bq-nginx-php7  -n web  #暂停升级\nkubectl rollout resume deployment/bq-nginx-php7  -n web #继续升级\nkubectl rollout undo deployment/bq-nginx-php7  -n web   #升级回滚\nkubectl scale deployment bq-nginx-php7 --replicas 2  -n web   #弹性伸缩Pod数量\n\nkubectl get ns --show-labels  # 查看标签,除了ns, 也可以是node,pod等\n```\n","content":"<p>记录一些kubectl命令</p>\n<a id=\"more\"></a>\n\n<p><a href=\"http://docs.kubernetes.org.cn/683.html\" target=\"_blank\" rel=\"noopener\">kubectl命令表</a></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"常用命令\"><a href=\"#常用命令\" class=\"headerlink\" title=\"常用命令\"></a>常用命令</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 让内网可以访问 k8s proxy(k8smaster是:192.168.1.111</span></span><br><span class=\"line\">kubectl<span class=\"built_in\"> proxy </span><span class=\"attribute\">--address</span>=<span class=\"string\">'192.168.1.111'</span> -p 10000 <span class=\"attribute\">--accept-hosts</span>=<span class=\"string\">'^172.*$'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看api类型</span></span><br><span class=\"line\">kubectl api-versions </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 让master也运行pod（默认master不运行pod,单机会用到）</span></span><br><span class=\"line\">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># patch补丁, 强制更新</span></span><br><span class=\"line\">kubectl patch -f deployment.yaml -p <span class=\"string\">\"&#123;\\\"spec\\\":&#123;\\\"template\\\":&#123;\\\"metadata\\\":&#123;\\\"annotations\\\":&#123;\\\"ci-last-updated\\\":\\\"<span class=\"variable\">$(date +'%s')</span>\\\"&#125;&#125;&#125;&#125;&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 端口转发</span></span><br><span class=\"line\">kubectl -n<span class=\"built_in\"> default </span>port-forward service/prometheus-server 30080:80</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"scale-使用\"><a href=\"#scale-使用\" class=\"headerlink\" title=\"scale 使用\"></a>scale 使用</h3><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过将rc的副本数重新设置为0后，再将副本数设置为2，达到重启nginx的效果。</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">scale </span>deployment <span class=\"keyword\">bq-front1 </span>--replicas=<span class=\"number\">0</span> -n web</span><br><span class=\"line\">kubectl <span class=\"keyword\">scale </span>deployment <span class=\"keyword\">bq-front1 </span>--replicas=<span class=\"number\">2</span> -n web</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"metrics-相关\"><a href=\"#metrics-相关\" class=\"headerlink\" title=\"metrics 相关\"></a>metrics 相关</h3><figure class=\"highlight nsis\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看node 资源</span></span><br><span class=\"line\">kubectl <span class=\"literal\">top</span> nodes</span><br><span class=\"line\"><span class=\"comment\"># 查看pods 资源</span></span><br><span class=\"line\">kubectl <span class=\"literal\">top</span> pods -n php-dev</span><br><span class=\"line\"><span class=\"comment\"># 获取metrics接口所有数据</span></span><br><span class=\"line\">kubectl get --raw /metrics</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># patch强制更新(慎用)</span></span><br><span class=\"line\">kubectl patch -f deployment.yaml -p <span class=\"string\">\"&#123;\\\"</span>spec\\<span class=\"string\">\":&#123;\\\"</span>template\\<span class=\"string\">\":&#123;\\\"</span>metadata\\<span class=\"string\">\":&#123;\\\"</span>annotations\\<span class=\"string\">\":&#123;\\\"</span>ci-last-updated\\<span class=\"string\">\":\\\"</span>$(date +<span class=\"string\">'%s'</span>)\\<span class=\"string\">\"&#125;&#125;&#125;&#125;&#125;\"</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"根据版本缩放\"><a href=\"#根据版本缩放\" class=\"headerlink\" title=\"根据版本缩放\"></a>根据版本缩放</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看Deployment的变更信息（以下信息得以保存，是创建时候加的“--record”这个选项起的作用）：</span></span><br><span class=\"line\">kubectl rollout <span class=\"keyword\">history</span> deployment/bq-nginx-php7 -n web</span><br><span class=\"line\">kubectl rollout undo deployment/bq-nginx-php7        <span class=\"comment\"># 回退到上一版本</span></span><br><span class=\"line\">kubectl rollout undo deployment/bq-nginx-php7 <span class=\"params\">--to-revision=2</span>  <span class=\"comment\"># 回退到指定版本</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl describe deployments/bq-nginx-php7 -n web       <span class=\"comment\">#查询详细信息，获取升级进度</span></span><br><span class=\"line\">kubectl rollout pause deployment/bq-nginx-php7  -n web  <span class=\"comment\">#暂停升级</span></span><br><span class=\"line\">kubectl rollout resume deployment/bq-nginx-php7  -n web <span class=\"comment\">#继续升级</span></span><br><span class=\"line\">kubectl rollout undo deployment/bq-nginx-php7  -n web   <span class=\"comment\">#升级回滚</span></span><br><span class=\"line\">kubectl scale deployment bq-nginx-php7 <span class=\"params\">--replicas</span> 2  -n web   <span class=\"comment\">#弹性伸缩Pod数量</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get ns <span class=\"params\">--show-labels</span>  <span class=\"comment\"># 查看标签,除了ns, 也可以是node,pod等</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/12/05/34-k8s一些命令总结/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"kubectl","slug":"k8s/kubectl","permalink":"https://blog.k1s.club/categories/k8s/kubectl/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"kubectl","slug":"kubectl","permalink":"https://blog.k1s.club/tags/kubectl/"}]},{"title":"k3s安装配置","date":"2019-12-03T08:06:28.000Z","path":"2019/12/03/29-k3s安装配置/","text":"体验轻量级k8s集群,适用于低配个人开发测试使用 k3s, 5 less than k8s 详情参考官方: k3s github地址 准备 1 selinux 关闭 123456getenforce# 本次关闭setenforce 0# 重启后关闭sed -i '/SELINUX=enforcing/s/enforcing/disabled/' /etc/sysconfig/selinux 2 关闭swap(可选) 1234# 本次关闭swapoff on# 重启后关闭sed -i '/swap/s@^/@#/@' /etc/fstab 3 关闭firewalld(必须) 12systemctl stop firewalld.servicesystemctl disable firewalld.service 4 在内核3.10,4.16,5.2,5.3 都正常运行 Step 1: 安装K3S集群1234567891011121314151617181920212223# 下载k3s 二进制文件打开各版本点击详情可以查询k3s版本对应的k8s版本(https://github.com/rancher/k3s/releases)wget https://github.com/rancher/k3s/releases/download/v1.0.0/k3sk3s v1.0.0 -&gt; k8s1.16.3# https://github.com/rancher/k3s/tagsk3s v0.9.0 -&gt; k8s1.15.4k3s v0.10.0 -&gt; k8s1.16.2我这里下载最新的k3s v1.0.0, 但是由于metrics-server好像对k8s1.16.3最新有点问题, 还是先等待metrics-server更新把测试了k3s v0.10.0 测试了下, 但遗憾的是默认好像没有安装metrics-server...mv k3s /usr/local/bin/k3schmod +x /usr/local/bin/k3s#k3s --versionk3s version v1.0.0 (18bd921c)# 下载pause镜像(这里举1,其他国内地址参考官方)docker pull registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1docker tag registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 k8s.gcr.io/pause:3.1# 验证一下docker images | grep \"k8s.gcr.io/pause\" Step 2: 安装k3s server12345678910111213141516# centos官方安装curl -sfL https://get.k3s.io | sh -# 至此server已经安装完了,但由于k8s默认是用Containerd, 并非docker, 所以需要手工修改配置(当然如果你熟悉ctr 操作Containerd也没问题)# 修改ExecStart内容# 1: --docker 表示k3s server使用docker引擎# 2: --no-deploy traefik 表示不安装traefikvim /etc/systemd/system/multi-user.target.wants/k3s.serviceExecStart=/usr/local/bin/k3s server --docker --no-deploy traefik# 启动服务systemctl daemon-reloadservice k3s restart# 验证k3s kubectl get node 想去掉k3s命令? kubectl命令管理k3s 1234567# 简单做一个aliasalias kubectl='k3s kubectl'# 或者rm -rf ~/.kubemkdir -p ~/.kubecp /etc/rancher/k3s/k3s.yaml ~/.kube/config Step 3: 客户端安装参考官方文档 安装和配置选项 1234# 同样下载二进制包wget https://github.com/rancher/k3s/releases/download/v1.0.0/k3smv k3s /usr/local/bin/k3schmod +x /usr/local/bin/k3s 加入到server有两种 手动加入 (其实上面我们已经拉取了image, 并且tag成官方地址了,所以这里也可以不用指定) 12nohup k3s agent --docker --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 --server https://k3s-server:6443 --token $&#123;NODE_TOKEN&#125; &amp;nohup k3s agent --docker --server https://k3s-server:6443 --token $&#123;NODE_TOKEN&#125; &amp; 脚本加入 12345curl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=$&#123;NODE_TOKEN&#125; INSTALL_K3S_EXEC=\"agent --docker --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1\" sh -s -curl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=$&#123;NODE_TOKEN&#125; INSTALL_K3S_EXEC=\"agent --docker\" sh -s -# ps aux|grep k3s/usr/local/bin/k3s agent --docker --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 当然如下差别不大, 都是会启动一个k3s的进程 rancher import1curl --insecure -sfL https://rancher-dev.xxx.com/v3/import/x8jc277zmjkxjgcmc9f67pzn9f7ffsjpszlv9dxc79vhmndqcms4nr.yaml | k3s kubectl apply -f - 卸载1sh /usr/local/bin/k3s-uninstall.sh","raw":"---\ntitle: k3s安装配置\ncopyright: true\ndate: 2019-12-03 16:06:28\ntags:\n  - k3s\ncategories:\n  - [技术文档]\n  - [k3s]\n---\n体验轻量级k8s集群,适用于低配个人开发测试使用\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k3s, 5 less than k8s </font>\n</center>\n\n详情参考官方: [k3s github地址](https://github.com/rancher/k3s)\n\n\n### 准备\n- 1 selinux 关闭\n\n```\ngetenforce\n# 本次关闭\nsetenforce 0\n\n# 重启后关闭\nsed -i '/SELINUX=enforcing/s/enforcing/disabled/' /etc/sysconfig/selinux\n```\n\n- 2 关闭swap(可选)\n\n```\n# 本次关闭\nswapoff on\n# 重启后关闭\nsed -i '/swap/s@^/@#/@' /etc/fstab\n```\n\n- 3 关闭firewalld(必须)\n```\nsystemctl stop firewalld.service\nsystemctl disable firewalld.service\n```\n\n- 4 在内核3.10,4.16,5.2,5.3 都正常运行\n\n\n### Step 1: 安装K3S集群\n```\n# 下载k3s 二进制文件打开各版本点击详情可以查询k3s版本对应的k8s版本(https://github.com/rancher/k3s/releases)\nwget https://github.com/rancher/k3s/releases/download/v1.0.0/k3s\nk3s v1.0.0 -> k8s1.16.3\n\n# https://github.com/rancher/k3s/tags\nk3s v0.9.0 -> k8s1.15.4\nk3s v0.10.0 -> k8s1.16.2\n\n我这里下载最新的k3s v1.0.0, 但是由于metrics-server好像对k8s1.16.3最新有点问题, 还是先等待metrics-server更新把\n测试了k3s v0.10.0 测试了下, 但遗憾的是默认好像没有安装metrics-server...\n\nmv k3s /usr/local/bin/k3s\nchmod +x /usr/local/bin/k3s\n\n#k3s --version\nk3s version v1.0.0 (18bd921c)\n\n# 下载pause镜像(这里举1,其他国内地址参考官方)\ndocker pull registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1\ndocker tag registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 k8s.gcr.io/pause:3.1\n\n# 验证一下\ndocker images | grep \"k8s.gcr.io/pause\"\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### Step 2: 安装k3s server\n```\n# centos官方安装\ncurl -sfL https://get.k3s.io | sh -\n\n# 至此server已经安装完了,但由于k8s默认是用Containerd, 并非docker, 所以需要手工修改配置(当然如果你熟悉ctr 操作Containerd也没问题)\n# 修改ExecStart内容\n# 1: --docker 表示k3s server使用docker引擎\n# 2: --no-deploy traefik 表示不安装traefik\nvim /etc/systemd/system/multi-user.target.wants/k3s.service\nExecStart=/usr/local/bin/k3s server --docker --no-deploy traefik\n\n# 启动服务\nsystemctl daemon-reload\nservice k3s restart\n\n# 验证\nk3s kubectl get node\n```\n\n> 想去掉k3s命令? kubectl命令管理k3s\n```\n# 简单做一个alias\nalias kubectl='k3s kubectl'\n\n# 或者\nrm -rf ~/.kube\nmkdir -p ~/.kube\ncp /etc/rancher/k3s/k3s.yaml ~/.kube/config\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### Step 3: 客户端安装\n\n参考官方文档 [安装和配置选项](https://rancher.com/docs/k3s/latest/en/installation/install-options/)\n\n```\n# 同样下载二进制包\nwget https://github.com/rancher/k3s/releases/download/v1.0.0/k3s\nmv k3s /usr/local/bin/k3s\nchmod +x /usr/local/bin/k3s\n```\n\n### 加入到server有两种\n- 手动加入 (其实上面我们已经拉取了image, 并且tag成官方地址了,所以这里也可以不用指定)\n```\nnohup k3s agent --docker   --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 --server https://k3s-server:6443 --token ${NODE_TOKEN} &\nnohup k3s agent --docker --server https://k3s-server:6443 --token ${NODE_TOKEN} &\n```\n\n- 脚本加入\n```\ncurl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=${NODE_TOKEN} INSTALL_K3S_EXEC=\"agent --docker  --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1\" sh -s -\ncurl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=${NODE_TOKEN} INSTALL_K3S_EXEC=\"agent --docker\" sh -s -\n\n# ps aux|grep k3s\n/usr/local/bin/k3s agent --docker --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1\n```\n\n> 当然如下差别不大, 都是会启动一个k3s的进程\n\n\n\n###  rancher import\n```\ncurl --insecure -sfL https://rancher-dev.xxx.com/v3/import/x8jc277zmjkxjgcmc9f67pzn9f7ffsjpszlv9dxc79vhmndqcms4nr.yaml | k3s kubectl apply -f -\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 卸载\n```\nsh /usr/local/bin/k3s-uninstall.sh\n```\n","content":"<p>体验轻量级k8s集群,适用于低配个人开发测试使用</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k3s, 5 less than k8s </font>\n</center>\n\n<p>详情参考官方: <a href=\"https://github.com/rancher/k3s\" target=\"_blank\" rel=\"noopener\">k3s github地址</a></p>\n<h3 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h3><ul>\n<li>1 selinux 关闭</li>\n</ul>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">getenforce</span><br><span class=\"line\"><span class=\"meta\"># 本次关闭</span></span><br><span class=\"line\">setenforce <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 重启后关闭</span></span><br><span class=\"line\">sed -i <span class=\"string\">'/SELINUX=enforcing/s/enforcing/disabled/'</span> /etc/sysconfig/selinux</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>2 关闭swap(可选)</li>\n</ul>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 本次关闭</span></span><br><span class=\"line\">swapoff <span class=\"keyword\">on</span></span><br><span class=\"line\"><span class=\"comment\"># 重启后关闭</span></span><br><span class=\"line\">sed -i '/swap/s@^/@<span class=\"comment\">#/@' /etc/fstab</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>3 关闭firewalld(必须)</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">stop</span> <span class=\"selector-tag\">firewalld</span><span class=\"selector-class\">.service</span></span><br><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">disable</span> <span class=\"selector-tag\">firewalld</span><span class=\"selector-class\">.service</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4 在内核3.10,4.16,5.2,5.3 都正常运行</p>\n</li>\n</ul>\n<h3 id=\"Step-1-安装K3S集群\"><a href=\"#Step-1-安装K3S集群\" class=\"headerlink\" title=\"Step 1: 安装K3S集群\"></a>Step 1: 安装K3S集群</h3><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 下载k3s 二进制文件打开各版本点击详情可以查询k3s版本对应的k8s版本(https://github.com/rancher/k3s/releases)</span><br><span class=\"line\">wget https://github.com/rancher/k3s/releases/download/v1<span class=\"meta\">.0</span><span class=\"meta\">.0</span>/k3s</span><br><span class=\"line\">k3s v1<span class=\"meta\">.0</span><span class=\"meta\">.0</span> -&gt; k8s1<span class=\"meta\">.16</span><span class=\"meta\">.3</span></span><br><span class=\"line\"></span><br><span class=\"line\"># https://github.com/rancher/k3s/tags</span><br><span class=\"line\">k3s v0<span class=\"meta\">.9</span><span class=\"meta\">.0</span> -&gt; k8s1<span class=\"meta\">.15</span><span class=\"meta\">.4</span></span><br><span class=\"line\">k3s v0<span class=\"meta\">.10</span><span class=\"meta\">.0</span> -&gt; k8s1<span class=\"meta\">.16</span><span class=\"meta\">.2</span></span><br><span class=\"line\"></span><br><span class=\"line\">我这里下载最新的k3s v1<span class=\"meta\">.0</span><span class=\"meta\">.0</span>, 但是由于metrics-server好像对k8s1<span class=\"meta\">.16</span><span class=\"meta\">.3</span>最新有点问题, 还是先等待metrics-server更新把</span><br><span class=\"line\">测试了k3s v0<span class=\"meta\">.10</span><span class=\"meta\">.0</span> 测试了下, 但遗憾的是默认好像没有安装metrics-server...</span><br><span class=\"line\"></span><br><span class=\"line\">mv k3s /usr/local/bin/k3s</span><br><span class=\"line\">chmod +x /usr/local/bin/k3s</span><br><span class=\"line\"></span><br><span class=\"line\">#k3s --version</span><br><span class=\"line\">k3s version v1<span class=\"meta\">.0</span><span class=\"meta\">.0</span> (18bd921c)</span><br><span class=\"line\"></span><br><span class=\"line\"># 下载<span class=\"keyword\">pause</span>镜像(这里举<span class=\"number\">1</span>,其他国内地址参考官方)</span><br><span class=\"line\">docker pull registry.cn-beijing.aliyuncs.com/ilemonrain/<span class=\"keyword\">pause</span>-amd64:<span class=\"number\">3.1</span></span><br><span class=\"line\">docker tag registry.cn-beijing.aliyuncs.com/ilemonrain/<span class=\"keyword\">pause</span>-amd64:<span class=\"number\">3.1</span> k8s.gcr.io/<span class=\"keyword\">pause</span>:<span class=\"number\">3.1</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 验证一下</span><br><span class=\"line\">docker images | grep <span class=\"string\">\"k8s.gcr.io/pause\"</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"Step-2-安装k3s-server\"><a href=\"#Step-2-安装k3s-server\" class=\"headerlink\" title=\"Step 2: 安装k3s server\"></a>Step 2: 安装k3s server</h3><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># centos官方安装</span></span><br><span class=\"line\">curl -sfL https:<span class=\"comment\">//get.k3s.io | sh -</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 至此server已经安装完了,但由于k8s默认是用Containerd, 并非docker, 所以需要手工修改配置(当然如果你熟悉ctr 操作Containerd也没问题)</span></span><br><span class=\"line\"><span class=\"meta\"># 修改ExecStart内容</span></span><br><span class=\"line\"><span class=\"meta\"># 1: --docker 表示k3s server使用docker引擎</span></span><br><span class=\"line\"><span class=\"meta\"># 2: --no-deploy traefik 表示不安装traefik</span></span><br><span class=\"line\">vim /etc/systemd/system/multi-user.target.wants/k3s.service</span><br><span class=\"line\">ExecStart=/usr/local/bin/k3s server --docker --no-deploy traefik</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 启动服务</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">service k3s restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 验证</span></span><br><span class=\"line\">k3s kubectl <span class=\"keyword\">get</span> node</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>想去掉k3s命令? kubectl命令管理k3s</p>\n</blockquote>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 简单做一个alias</span></span><br><span class=\"line\"><span class=\"keyword\">alias</span> kubectl='k3s kubectl'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">rm -rf ~<span class=\"string\">/.kube</span></span><br><span class=\"line\">mkdir -p ~<span class=\"string\">/.kube</span></span><br><span class=\"line\">cp <span class=\"string\">/etc/rancher/k3s/k3s.yaml</span> ~<span class=\"string\">/.kube/config</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"Step-3-客户端安装\"><a href=\"#Step-3-客户端安装\" class=\"headerlink\" title=\"Step 3: 客户端安装\"></a>Step 3: 客户端安装</h3><p>参考官方文档 <a href=\"https://rancher.com/docs/k3s/latest/en/installation/install-options/\" target=\"_blank\" rel=\"noopener\">安装和配置选项</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 同样下载二进制包</span></span><br><span class=\"line\">wget https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/rancher/</span>k3s<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v1.0.0/</span>k3s</span><br><span class=\"line\">mv k3s <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/bin/</span>k3s</span><br><span class=\"line\">chmod +x <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/bin/</span>k3s</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"加入到server有两种\"><a href=\"#加入到server有两种\" class=\"headerlink\" title=\"加入到server有两种\"></a>加入到server有两种</h3><ul>\n<li><p>手动加入 (其实上面我们已经拉取了image, 并且tag成官方地址了,所以这里也可以不用指定)</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nohup k3s agent <span class=\"params\">--docker</span>   <span class=\"params\">--pause-image</span> registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64<span class=\"function\">:3.1</span> <span class=\"params\">--server</span> https:<span class=\"string\">//k3s-server</span><span class=\"function\">:6443</span> <span class=\"params\">--token</span> $&#123;NODE_TOKEN&#125; &amp;</span><br><span class=\"line\">nohup k3s agent <span class=\"params\">--docker</span> <span class=\"params\">--server</span> https:<span class=\"string\">//k3s-server</span><span class=\"function\">:6443</span> <span class=\"params\">--token</span> $&#123;NODE_TOKEN&#125; &amp;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>脚本加入</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sfL http<span class=\"variable\">s:</span>//<span class=\"built_in\">get</span>.k3s.io | K3S_URL=http<span class=\"variable\">s:</span>//k3s-server:<span class=\"number\">6443</span> K3S_TOKEN=$&#123;NODE_TOKEN&#125; INSTALL_K3S_EXEC=<span class=\"string\">\"agent --docker  --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1\"</span> <span class=\"keyword\">sh</span> -s -</span><br><span class=\"line\">curl -sfL http<span class=\"variable\">s:</span>//<span class=\"built_in\">get</span>.k3s.io | K3S_URL=http<span class=\"variable\">s:</span>//k3s-server:<span class=\"number\">6443</span> K3S_TOKEN=$&#123;NODE_TOKEN&#125; INSTALL_K3S_EXEC=<span class=\"string\">\"agent --docker\"</span> <span class=\"keyword\">sh</span> -s -</span><br><span class=\"line\"></span><br><span class=\"line\"># <span class=\"keyword\">ps</span> aux|<span class=\"keyword\">grep</span> k3s</span><br><span class=\"line\">/usr/local/bin/k3s agent --docker --pause-image registry.<span class=\"keyword\">cn</span>-beijing.aliyuncs.<span class=\"keyword\">com</span>/ilemonrain/pause-amd64:<span class=\"number\">3.1</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<blockquote>\n<p>当然如下差别不大, 都是会启动一个k3s的进程</p>\n</blockquote>\n<h3 id=\"rancher-import\"><a href=\"#rancher-import\" class=\"headerlink\" title=\"rancher import\"></a>rancher import</h3><figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">curl</span> --insecure -sfL https://rancher-dev.xxx.com/<span class=\"built_in\">v3</span>/<span class=\"meta\">import</span>/x8jc277zmjkxjgcmc9f67pzn9f7ffsjpszlv9dxc79vhmndqcms4nr.yaml <span class=\"title\">| k3s kubectl apply -f -</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h3><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">sh</span> /usr/<span class=\"keyword\">local</span>/bin/k3s-uninstall.<span class=\"keyword\">sh</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/12/03/29-k3s安装配置/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/categories/k3s/"}],"tags":[{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/tags/k3s/"}]},{"title":"k3s1.16部署nginx+php5.2.17","date":"2019-12-03T03:46:42.000Z","path":"2019/12/03/33-k3s1.16部署nginx+php5.2.17/","text":"老项目是用php5.2.17的,自己编译打包镜像简单部署 开始部署 准备dockerfile Dockerfile 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798FROM centos:6.9MAINTAINER zhangzw zhangzw@zhangzw.comENV PHP_DIR /usr/local/phpENV WORK_DIR_tar /usr/loca/src/ENV PHP_VERSION 5.2.17ENV PHP_EXT_CURL curl-7.20.0# php 及扩展 包,包括以下内容# php-5.2.17-patch-fpm.tar.gz curl-7.20.0.tar.gz freetype-2.4.0.tar.gz ImageMagick-6.9.0-4.tar.gz imagick-3.0.1.tgz zendopcache-7.0.5.tgz phpredis-2.2.2.zip # php-fpm.conf php.ini copy tar $&#123;WORK_DIR_tar&#125;run yum install -y wget \\ &amp;&amp; wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo \\ &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6 \\ &amp;&amp; yum install -y epel-release \\ &amp;&amp; yum install -y freetype freetype-devel gcc make cmake ncurses-devel gcc-c++ autoconf automake zlib-devel dos2unix nc lrzsz openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel libpng-devel bzip2-devel libjpeg libjpeg-turbo-devel libmcrypt-devel mhash-devel mysql-devel libtool-ltdl libtool-ltdl-devel git bzip2-devel git supervisor autoconf automake xz unzip \\ &amp;&amp; yum clean all &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; ls *gz|xargs -i tar -xf &#123;&#125; \\ &amp;&amp; cd $&#123;PHP_EXT_CURL&#125; \\ &amp;&amp; ./configure --prefix=/usr/local/curl \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; cd php-$&#123;PHP_VERSION&#125; \\ &amp;&amp; ln -s /usr/lib64/libpng.so /usr/lib/ \\ &amp;&amp; ln -s /usr/lib64/libjpeg.so /usr/lib/ \\ &amp;&amp; ln -s /usr/lib64/mysql/libmysqlclient.so.16.0.0 /usr/lib/libmysqlclient.so \\ &amp;&amp; ./configure \\ --prefix=$&#123;PHP_DIR&#125; \\ --with-config-file-path=$&#123;PHP_DIR&#125;/etc \\ --with-mysql \\ --with-mysqli \\ --with-openssl \\ --enable-fastcgi \\ --enable-fpm \\ --enable-mbstring \\ --enable-bcmath \\ --with-freetype-dir \\ --with-jpeg-dir \\ --with-png-dir \\ --with-zlib-dir \\ --with-libxml-dir=/usr \\ --enable-xml \\ --with-mhash \\ --with-mcrypt \\ --enable-pcntl \\ --enable-sockets \\ --with-bz2 \\ --with-curl=/usr/local/curl \\ --with-curlwrappers \\ --enable-mbregex \\ --with-gd \\ --enable-gd-native-ttf \\ --enable-zip \\ --enable-soap \\ --with-iconv \\ --enable-pdo \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; cd ImageMagick-6.9.0-4 \\ &amp;&amp; ./configure --prefix=/usr/local/imagemagick \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; cd imagick-3.0.1 \\ &amp;&amp; ln -s /usr/local/imagemagick/include/ImageMagick-6 /usr/local/imagemagick/include/ImageMagick \\ &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize \\ &amp;&amp; ./configure --with-php-config=$&#123;PHP_DIR&#125;/bin/php-config --with-imagick=/usr/local/imagemagick \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; unzip phpredis-2.2.2.zip \\ &amp;&amp; cd phpredis-2.2.2 \\ &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize \\ &amp;&amp; ./configure --with-php-config=$&#123;PHP_DIR&#125;/bin/php-config \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; cd zendopcache-7.0.5 \\ &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize \\ &amp;&amp; ./configure --with-php-config=$&#123;PHP_DIR&#125;/bin/php-config \\ &amp;&amp; make \\ &amp;&amp; make install \\ &amp;&amp; groupadd -r www \\ &amp;&amp; useradd -M -s /sbin/nologin -r -g www www \\ &amp;&amp; cd $&#123;WORK_DIR_tar&#125; \\ &amp;&amp; \\cp -r $&#123;WORK_DIR_tar&#125;/php-fpm.conf $&#123;PHP_DIR&#125;/etc/ \\ &amp;&amp; \\cp -r $&#123;WORK_DIR_tar&#125;/php.ini $&#123;PHP_DIR&#125;/etc/ \\ &amp;&amp; rm -rf $&#123;WORK_DIR_tar&#125;copy supervisord-fpm.conf /etc/supervisord.confcopy start.sh /root/start.shENTRYPOINT [\"/bin/sh\", \"/root/start.sh\"] build 打包 123# 配置自己的私有仓库地址docker build -t xxx.com/centos-php:5.2.17 .docker push xxx.com/centos-php:5.2.17 可参考k3s安装教程: k3s安装配置 官方教程 在k3s中启动(这里本地挂载方式,单节点) nginx.conf 部分配置 1234567891011121314151617181920212223server &#123; listen 80 default_server; server_name _; access_log /webwww/nginx_logs/test_access.log main; error_log /webwww/nginx_logs/test_error.log debug; root /webwww/test; location = /50x.html &#123; root html; &#125; location / &#123; index index.php index.html index.htm; &#125; location ~ \\.php$ &#123; fastcgi_pass php-fpm-dev:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param HTTP_HOST $server_name; include fastcgi_params; &#125;&#125; nginx部署 nginx/php-nginx-dev.yml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758---apiVersion: apps/v1kind: Deploymentmetadata: name: php-nginx-dev namespace: php-devspec: replicas: 1 selector: matchLabels: app: php-nginx-dev template: metadata: labels: app: php-nginx-dev spec: containers: - name: php-nginx-dev image: hub.zhangzw.com/bq/nginx:1.15.12 ports: - containerPort: 80 name: nginx-80 protocol: TCP resources: requests: cpu: \"10m\" limits: cpu: \"500m\" volumeMounts: - name: nginx-www-dev mountPath: /webwww - name: nginx-cfg-dev mountPath: \"/etc/nginx/nginx.conf\" volumes: - name: nginx-www-dev hostPath: path: /data/k8s-container/php-5.2.17/webwww-data - name: nginx-cfg-dev hostPath: path: /data/k8s-container/php-5.2.17/nginx/nginx.conf---kind: ServiceapiVersion: v1metadata: labels: app: php-nginx-dev name: php-nginx-dev-service namespace: php-devspec: type: NodePort ports: - name: nginx-80 port: 80 targetPort: 80 nodePort: 32001 protocol: TCP selector: app: php-nginx-dev fpm 部署配置 php-fpm/php-fpm-dev.yml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061---apiVersion: apps/v1kind: Deploymentmetadata: name: php-fpm-dev namespace: php-devspec: replicas: 1 selector: matchLabels: app: php-fpm-dev template: metadata: labels: app: php-fpm-dev spec: containers: - name: php-fpm-dev image: hub.zhangzw.com/bq/centos-php:5.2.17 ports: - containerPort: 9000 name: fpm-9000 protocol: TCP resources: requests: cpu: \"50m\" limits: cpu: \"1500m\" volumeMounts: - name: nginx-www-dev mountPath: /webwww - name: php-cfg-dev mountPath: \"/usr/local/php/etc/php.ini\" - name: fpm-cfg-dev mountPath: \"/usr/local/php/etc/php-fpm.conf\" volumes: - name: nginx-www-dev hostPath: path: /data/k8s-container/php-5.2.17/webwww-data - name: php-cfg-dev hostPath: path: /data/k8s-container/php-5.2.17/php-fpm/php.ini - name: fpm-cfg-dev hostPath: path: /data/k8s-container/php-5.2.17/php-fpm/php-fpm.conf---apiVersion: v1kind: Servicemetadata: name: php-fpm-dev namespace: php-devspec: clusterIP: None selector: app: php-fpm-dev ports: - name: fpm-9000 port: 9000--- 部署命令123# 先启动fpm,否则nginx会报错找不到 php-fpm-devkubectl apply -f php-fpm/php-fpm-dev.ymlkubectl apply -f nginx/php-nginx-dev.yml","raw":"---\ntitle: k3s1.16部署nginx+php5.2.17\ncopyright: true\ndate: 2019-12-03 11:46:42 \ntags:\n  - k8s\n  - k3s\n  - nginx\n  - php5\ncategories:\n  - [技术文档]\n  - [k3s,lnmp]\n---\n\n老项目是用php5.2.17的,自己编译打包镜像简单部署\n<!--more-->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 开始部署 </font>\n</center>\n\n\n### 准备dockerfile\n\n\n- Dockerfile\n```\nFROM centos:6.9\nMAINTAINER zhangzw zhangzw@zhangzw.com\n\nENV PHP_DIR /usr/local/php\nENV WORK_DIR_tar /usr/loca/src/\nENV PHP_VERSION 5.2.17\nENV PHP_EXT_CURL curl-7.20.0\n# php 及扩展 包,包括以下内容\n# php-5.2.17-patch-fpm.tar.gz curl-7.20.0.tar.gz  freetype-2.4.0.tar.gz  ImageMagick-6.9.0-4.tar.gz  imagick-3.0.1.tgz zendopcache-7.0.5.tgz  phpredis-2.2.2.zip                 \n# php-fpm.conf php.ini              \ncopy tar ${WORK_DIR_tar}\n\n\nrun yum install -y wget \\\n && wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo \\\n && rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6 \\\n && yum install -y epel-release \\\n && yum install -y freetype freetype-devel gcc make cmake ncurses-devel gcc-c++ autoconf automake zlib-devel dos2unix nc lrzsz openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel libpng-devel bzip2-devel libjpeg libjpeg-turbo-devel libmcrypt-devel mhash-devel mysql-devel libtool-ltdl libtool-ltdl-devel git bzip2-devel git supervisor autoconf automake xz unzip \\\n    && yum clean all\n    && cd ${WORK_DIR_tar} \\\n        && ls *gz|xargs -i tar -xf {} \\\n && cd ${PHP_EXT_CURL} \\\n                && ./configure --prefix=/usr/local/curl \\\n                && make \\\n                && make install \\\n    && cd ${WORK_DIR_tar} \\\n && cd php-${PHP_VERSION} \\\n && ln -s /usr/lib64/libpng.so /usr/lib/ \\\n && ln -s /usr/lib64/libjpeg.so /usr/lib/ \\\n && ln -s /usr/lib64/mysql/libmysqlclient.so.16.0.0 /usr/lib/libmysqlclient.so \\\n        && ./configure \\\n            --prefix=${PHP_DIR} \\\n            --with-config-file-path=${PHP_DIR}/etc \\\n            --with-mysql \\\n            --with-mysqli \\\n            --with-openssl \\\n            --enable-fastcgi \\\n            --enable-fpm \\\n            --enable-mbstring \\\n            --enable-bcmath \\\n            --with-freetype-dir \\\n            --with-jpeg-dir \\\n            --with-png-dir \\\n            --with-zlib-dir \\\n            --with-libxml-dir=/usr \\\n            --enable-xml \\\n            --with-mhash \\\n            --with-mcrypt \\\n            --enable-pcntl \\\n            --enable-sockets \\\n            --with-bz2 \\\n            --with-curl=/usr/local/curl \\\n            --with-curlwrappers \\\n            --enable-mbregex \\\n            --with-gd \\\n            --enable-gd-native-ttf \\\n            --enable-zip \\\n            --enable-soap \\\n            --with-iconv \\\n            --enable-pdo \\\n && make \\\n && make install \\\n    && cd ${WORK_DIR_tar} \\\n        && cd ImageMagick-6.9.0-4 \\\n                && ./configure --prefix=/usr/local/imagemagick \\\n                && make \\\n                && make install \\\n        && cd ${WORK_DIR_tar} \\\n        && cd imagick-3.0.1 \\\n                && ln -s /usr/local/imagemagick/include/ImageMagick-6 /usr/local/imagemagick/include/ImageMagick \\\n                && ${PHP_DIR}/bin/phpize \\\n                && ./configure --with-php-config=${PHP_DIR}/bin/php-config --with-imagick=/usr/local/imagemagick \\\n                && make \\\n                && make install \\\n    && cd ${WORK_DIR_tar} \\\n        && unzip phpredis-2.2.2.zip \\\n        && cd phpredis-2.2.2 \\\n                && ${PHP_DIR}/bin/phpize \\\n                && ./configure --with-php-config=${PHP_DIR}/bin/php-config \\\n                && make \\\n                && make install \\\n    && cd ${WORK_DIR_tar} \\\n        && cd zendopcache-7.0.5 \\\n                && ${PHP_DIR}/bin/phpize \\\n                && ./configure --with-php-config=${PHP_DIR}/bin/php-config \\\n                && make \\\n                && make install \\\n    && groupadd -r www \\\n    && useradd -M -s /sbin/nologin -r -g www www \\\n    && cd ${WORK_DIR_tar} \\\n   && \\cp -r ${WORK_DIR_tar}/php-fpm.conf ${PHP_DIR}/etc/ \\\n   && \\cp -r ${WORK_DIR_tar}/php.ini ${PHP_DIR}/etc/ \\\n   && rm -rf ${WORK_DIR_tar}\n\ncopy supervisord-fpm.conf /etc/supervisord.conf\ncopy start.sh /root/start.sh\n\nENTRYPOINT [\"/bin/sh\", \"/root/start.sh\"]\n\n```\n\n- build 打包\n```\n# 配置自己的私有仓库地址\ndocker build -t xxx.com/centos-php:5.2.17  .\ndocker push xxx.com/centos-php:5.2.17\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n可参考k3s安装教程:\n- [k3s安装配置](https://zhangzw001.github.io/2019/12/03/29-k3s安装配置/)\n- [官方教程](https://github.com/rancher/k3s)\n\n\n### 在k3s中启动(这里本地挂载方式,单节点)\n\n- nginx.conf 部分配置\n```\nserver {\n        listen 80 default_server;\n        server_name  _;\n        access_log  /webwww/nginx_logs/test_access.log  main;\n        error_log /webwww/nginx_logs/test_error.log debug;\n        root   /webwww/test;\n\n        location = /50x.html {\n            root   html;\n        }\n\n        location / {\n            index index.php  index.html index.htm;\n        }\n\n        location ~ \\.php$ {\n            fastcgi_pass   php-fpm-dev:9000;\n            fastcgi_index  index.php;\n            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            fastcgi_param  HTTP_HOST          $server_name;\n            include        fastcgi_params;\n        }\n}\n```\n\n\n- nginx部署 nginx/php-nginx-dev.yml\n```\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-nginx-dev\n  namespace: php-dev\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-nginx-dev\n  template:\n    metadata:\n      labels:\n        app: php-nginx-dev\n    spec:\n      containers:\n      - name: php-nginx-dev\n        image: hub.zhangzw.com/bq/nginx:1.15.12\n        ports:\n        - containerPort: 80\n          name: nginx-80\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"10m\"\n          limits:\n            cpu: \"500m\"\n        volumeMounts:\n        - name: nginx-www-dev\n          mountPath: /webwww\n        - name: nginx-cfg-dev\n          mountPath: \"/etc/nginx/nginx.conf\"\n      volumes:\n        - name: nginx-www-dev\n          hostPath:\n            path: /data/k8s-container/php-5.2.17/webwww-data\n        - name: nginx-cfg-dev\n          hostPath:\n            path: /data/k8s-container/php-5.2.17/nginx/nginx.conf\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   app: php-nginx-dev\n name: php-nginx-dev-service\n namespace: php-dev\nspec:\n type: NodePort\n ports:\n   - name: nginx-80\n     port: 80\n     targetPort: 80\n     nodePort: 32001\n     protocol: TCP\n selector:\n   app: php-nginx-dev\n```\n\n\n\n- fpm 部署配置 php-fpm/php-fpm-dev.yml\n\n```\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-fpm-dev\n  namespace: php-dev\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-fpm-dev\n  template:\n    metadata:\n      labels:\n        app: php-fpm-dev\n    spec:\n      containers:\n      - name: php-fpm-dev\n        image: hub.zhangzw.com/bq/centos-php:5.2.17\n        ports:\n        - containerPort: 9000\n          name: fpm-9000\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"1500m\"\n        volumeMounts:\n        - name: nginx-www-dev\n          mountPath: /webwww\n        - name: php-cfg-dev\n          mountPath: \"/usr/local/php/etc/php.ini\"\n        - name: fpm-cfg-dev\n          mountPath: \"/usr/local/php/etc/php-fpm.conf\"\n      volumes:\n        - name: nginx-www-dev\n          hostPath:\n            path: /data/k8s-container/php-5.2.17/webwww-data\n        - name: php-cfg-dev\n          hostPath:\n            path: /data/k8s-container/php-5.2.17/php-fpm/php.ini\n        - name: fpm-cfg-dev\n          hostPath:\n            path: /data/k8s-container/php-5.2.17/php-fpm/php-fpm.conf\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: php-fpm-dev\n  namespace: php-dev\nspec:\n  clusterIP: None\n  selector:\n    app: php-fpm-dev\n  ports:\n   - name: fpm-9000\n     port: 9000\n\n---\n```\n\n- 部署命令\n```\n# 先启动fpm,否则nginx会报错找不到 php-fpm-dev\nkubectl apply -f php-fpm/php-fpm-dev.yml\nkubectl apply -f nginx/php-nginx-dev.yml\n```\n","content":"<p>老项目是用php5.2.17的,自己编译打包镜像简单部署</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 开始部署 </font>\n</center>\n\n\n<h3 id=\"准备dockerfile\"><a href=\"#准备dockerfile\" class=\"headerlink\" title=\"准备dockerfile\"></a>准备dockerfile</h3><ul>\n<li><p>Dockerfile</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:<span class=\"number\">6.9</span></span><br><span class=\"line\">MAINTAINER zhangzw zhangzw@zhangzw.com</span><br><span class=\"line\"></span><br><span class=\"line\">ENV PHP_DIR /usr/local/php</span><br><span class=\"line\">ENV WORK_DIR_tar <span class=\"regexp\">/usr/loca/src/</span></span><br><span class=\"line\">ENV PHP_VERSION <span class=\"number\">5.2</span>.<span class=\"number\">17</span></span><br><span class=\"line\">ENV PHP_EXT_CURL curl-<span class=\"number\">7.20</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\"># php 及扩展 包,包括以下内容</span></span><br><span class=\"line\"><span class=\"comment\"># php-5.2.17-patch-fpm.tar.gz curl-7.20.0.tar.gz  freetype-2.4.0.tar.gz  ImageMagick-6.9.0-4.tar.gz  imagick-3.0.1.tgz zendopcache-7.0.5.tgz  phpredis-2.2.2.zip                 </span></span><br><span class=\"line\"><span class=\"comment\"># php-fpm.conf php.ini              </span></span><br><span class=\"line\">copy tar $&#123;WORK_DIR_tar&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">run yum install -y wget <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; wget -O <span class=\"regexp\">/etc/yum.repos.d/CentOS-Base.repo http:/</span>/mirrors.aliyun.com/repo/Centos-<span class=\"number\">6.repo</span> <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; rpm --<span class=\"keyword\">import</span> /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-<span class=\"number\">6</span> <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; yum install -y epel-release <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; yum install -y freetype freetype-devel gcc make cmake ncurses-devel gcc-c++ autoconf automake zlib-devel dos2unix nc lrzsz openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel libpng-devel bzip2-devel libjpeg libjpeg-turbo-devel libmcrypt-devel mhash-devel mysql-devel libtool-ltdl libtool-ltdl-devel git bzip2-devel git supervisor autoconf automake xz unzip <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; yum clean all</span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; ls *gz|xargs -i tar -xf &#123;&#125; <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; cd $&#123;PHP_EXT_CURL&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ./configure --prefix=/usr/local/curl <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; cd php-$&#123;PHP_VERSION&#125; <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; ln -s <span class=\"regexp\">/usr/lib64/libpng.so /usr/lib/</span> <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; ln -s <span class=\"regexp\">/usr/lib64/libjpeg.so /usr/lib/</span> <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; ln -s /usr/lib64/mysql/libmysqlclient.so.<span class=\"number\">16.0</span>.<span class=\"number\">0</span> /usr/lib/libmysqlclient.so <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; ./configure <span class=\"string\">\\</span></span><br><span class=\"line\">            --prefix=$&#123;PHP_DIR&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-config-file-path=$&#123;PHP_DIR&#125;/etc <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-mysql <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-mysqli <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-openssl <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-fastcgi <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-fpm <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-mbstring <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-bcmath <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-freetype-dir <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-jpeg-dir <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-png-dir <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-zlib-dir <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-libxml-dir=/usr <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-xml <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-mhash <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-mcrypt <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-pcntl <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-sockets <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-bz2 <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-curl=/usr/local/curl <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-curlwrappers <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-mbregex <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-gd <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-gd-<span class=\"keyword\">native</span>-ttf <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-zip <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-soap <span class=\"string\">\\</span></span><br><span class=\"line\">            --<span class=\"keyword\">with</span>-iconv <span class=\"string\">\\</span></span><br><span class=\"line\">            --enable-pdo <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\"> &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; cd ImageMagick-<span class=\"number\">6.9</span>.<span class=\"number\">0</span>-<span class=\"number\">4</span> <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ./configure --prefix=/usr/local/imagemagick <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; cd imagick-<span class=\"number\">3.0</span>.<span class=\"number\">1</span> <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ln -s /usr/local/imagemagick/include/ImageMagick-<span class=\"number\">6</span> /usr/local/imagemagick/include/ImageMagick <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ./configure --<span class=\"keyword\">with</span>-php-config=$&#123;PHP_DIR&#125;/bin/php-config --<span class=\"keyword\">with</span>-imagick=/usr/local/imagemagick <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; unzip phpredis-<span class=\"number\">2.2</span>.<span class=\"number\">2.zip</span> <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; cd phpredis-<span class=\"number\">2.2</span>.<span class=\"number\">2</span> <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ./configure --<span class=\"keyword\">with</span>-php-config=$&#123;PHP_DIR&#125;/bin/php-config <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">        &amp;&amp; cd zendopcache-<span class=\"number\">7.0</span>.<span class=\"number\">5</span> <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; $&#123;PHP_DIR&#125;/bin/phpize <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; ./configure --<span class=\"keyword\">with</span>-php-config=$&#123;PHP_DIR&#125;/bin/php-config <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make <span class=\"string\">\\</span></span><br><span class=\"line\">                &amp;&amp; make install <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; groupadd -r www <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; useradd -M -s /sbin/nologin -r -g www www <span class=\"string\">\\</span></span><br><span class=\"line\">    &amp;&amp; cd $&#123;WORK_DIR_tar&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">   &amp;&amp; <span class=\"string\">\\cp</span> -r $&#123;WORK_DIR_tar&#125;<span class=\"regexp\">/php-fpm.conf $&#123;PHP_DIR&#125;/etc/</span> <span class=\"string\">\\</span></span><br><span class=\"line\">   &amp;&amp; <span class=\"string\">\\cp</span> -r $&#123;WORK_DIR_tar&#125;<span class=\"regexp\">/php.ini $&#123;PHP_DIR&#125;/etc/</span> <span class=\"string\">\\</span></span><br><span class=\"line\">   &amp;&amp; rm -rf $&#123;WORK_DIR_tar&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">copy supervisord-fpm.conf /etc/supervisord.conf</span><br><span class=\"line\">copy start.sh /root/start.sh</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT [<span class=\"string\">\"/bin/sh\"</span>, <span class=\"string\">\"/root/start.sh\"</span>]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>build 打包</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 配置自己的私有仓库地址</span><br><span class=\"line\">docker build -t xxx.com/centos-php:<span class=\"number\">5.2</span><span class=\"meta\">.17</span>  .</span><br><span class=\"line\">docker <span class=\"keyword\">push</span> xxx.com/centos-php:<span class=\"number\">5.2</span><span class=\"meta\">.17</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<p>可参考k3s安装教程:</p>\n<ul>\n<li><a href=\"https://zhangzw001.github.io/2019/12/03/29-k3s安装配置/\">k3s安装配置</a></li>\n<li><a href=\"https://github.com/rancher/k3s\" target=\"_blank\" rel=\"noopener\">官方教程</a></li>\n</ul>\n<h3 id=\"在k3s中启动-这里本地挂载方式-单节点\"><a href=\"#在k3s中启动-这里本地挂载方式-单节点\" class=\"headerlink\" title=\"在k3s中启动(这里本地挂载方式,单节点)\"></a>在k3s中启动(这里本地挂载方式,单节点)</h3><ul>\n<li><p>nginx.conf 部分配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">80</span> default_server;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  _;</span><br><span class=\"line\">        <span class=\"attribute\">access_log</span>  /webwww/nginx_logs/test_access.log  main;</span><br><span class=\"line\">        <span class=\"attribute\">error_log</span> /webwww/nginx_logs/test_error.log <span class=\"literal\">debug</span>;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>   /webwww/test;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">location</span> = /50x.html &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">            <span class=\"attribute\">index</span> index.php  index.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">            <span class=\"attribute\">fastcgi_pass</span>   php-fpm-dev:<span class=\"number\">9000</span>;</span><br><span class=\"line\">            <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">            <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">            <span class=\"attribute\">fastcgi_param</span>  HTTP_HOST          <span class=\"variable\">$server_name</span>;</span><br><span class=\"line\">            <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>nginx部署 nginx/php-nginx-dev.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">php-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.zhangzw.com/bq/nginx:1.15.12</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">nginx-80</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"10m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/etc/nginx/nginx.conf\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-5.2.17/webwww-data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-5.2.17/nginx/nginx.conf</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">php-nginx-dev</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">php-nginx-dev-service</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">nginx-80</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">32001</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">php-nginx-dev</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>fpm 部署配置 php-fpm/php-fpm-dev.yml</p>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.zhangzw.com/bq/centos-php:5.2.17</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">fpm-9000</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"1500m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/webwww</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/php/etc/php.ini\"</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/php/etc/php-fpm.conf\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-www-dev</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-5.2.17/webwww-data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">php-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-5.2.17/php-fpm/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">fpm-cfg-dev</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-5.2.17/php-fpm/php-fpm.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">php-dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-fpm-dev</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">fpm-9000</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>部署命令<figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 先启动fpm,否则nginx会报错找不到 php-fpm-<span class=\"built_in\">dev</span></span><br><span class=\"line\">kubectl apply -f php-fpm/php-fpm-<span class=\"built_in\">dev</span>.yml</span><br><span class=\"line\">kubectl apply -f nginx/php-nginx-<span class=\"built_in\">dev</span>.yml</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/12/03/33-k3s1.16部署nginx+php5.2.17/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/categories/k3s/"},{"name":"lnmp","slug":"k3s/lnmp","permalink":"https://blog.k1s.club/categories/k3s/lnmp/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/tags/nginx/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/tags/k3s/"},{"name":"php5","slug":"php5","permalink":"https://blog.k1s.club/tags/php5/"}]},{"title":"php错误502问题总结","date":"2019-12-02T09:45:01.000Z","path":"2019/12/02/32-php错误502问题总结/","text":"近期一次 502报错, 但是没有达到timeout的值,特此记录 查看error.log 内容: recv() failed (104: Connection reset by peer) while reading response header from upstream12345678910一般来说502 主要是fpm超时进程中止了 或者就是 内存不足导致 fpm中止这里查看了fpm配置 request_terminate_timeout值, 发现并不是该原因通过 top 查看了fpm内存, 其中单个内存已经达到了700M这里fpm配置的pm 是static, 由于该服务并发不是很高, 可以适当减少max_children的值, 或者采用dynamic 动态方式这里设置的max_requests = 5500, 可以考虑减小该值 问题解决1231 这里对fpm reload 即可2 改动dynamic 方式3 合理配置max_requests","raw":"---\ntitle: php错误502问题总结\ncopyright: true\ndate: 2019-12-02 17:45:01\ntags:\n  - php\ncategories:\n  - [技术文档]\n  - [php,问题总结]\n---\n\n近期一次 502报错, 但是没有达到timeout的值,特此记录\n<!--more-->\n\n\n\n### 查看error.log 内容: recv() failed (104: Connection reset by peer) while reading response header from upstream\n```\n一般来说502 主要是fpm超时进程中止了 或者就是 内存不足导致 fpm中止\n\n\n这里查看了fpm配置 request_terminate_timeout值, 发现并不是该原因\n\n通过 top 查看了fpm内存, 其中单个内存已经达到了700M\n\n这里fpm配置的pm 是static, 由于该服务并发不是很高, 可以适当减少max_children的值, 或者采用dynamic 动态方式\n\n这里设置的max_requests = 5500,  可以考虑减小该值\n```\n\n### 问题解决\n```\n1 这里对fpm reload 即可\n2 改动dynamic 方式\n3 合理配置max_requests\n```\n\n","content":"<p>近期一次 502报错, 但是没有达到timeout的值,特此记录</p>\n<a id=\"more\"></a>\n\n\n\n<h3 id=\"查看error-log-内容-recv-failed-104-Connection-reset-by-peer-while-reading-response-header-from-upstream\"><a href=\"#查看error-log-内容-recv-failed-104-Connection-reset-by-peer-while-reading-response-header-from-upstream\" class=\"headerlink\" title=\"查看error.log 内容: recv() failed (104: Connection reset by peer) while reading response header from upstream\"></a>查看error.log 内容: recv() failed (104: Connection reset by peer) while reading response header from upstream</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一般来说<span class=\"number\">502</span> 主要是fpm超时进程中止了 或者就是 内存不足导致 fpm中止</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">这里查看了fpm配置 request_terminate_timeout值, 发现并不是该原因</span><br><span class=\"line\"></span><br><span class=\"line\">通过 top 查看了fpm内存, 其中单个内存已经达到了<span class=\"number\">700</span>M</span><br><span class=\"line\"></span><br><span class=\"line\">这里fpm配置的pm 是static, 由于该服务并发不是很高, 可以适当减少max_children的值, 或者采用dynamic 动态方式</span><br><span class=\"line\"></span><br><span class=\"line\">这里设置的max_requests = <span class=\"number\">5500</span>,  可以考虑减小该值</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"问题解决\"><a href=\"#问题解决\" class=\"headerlink\" title=\"问题解决\"></a>问题解决</h3><figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>这里对fpm reload 即可</span><br><span class=\"line\"><span class=\"symbol\">2 </span>改动dynamic 方式</span><br><span class=\"line\"><span class=\"symbol\">3 </span>合理配置max_requests</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/12/02/32-php错误502问题总结/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"php","slug":"php","permalink":"https://blog.k1s.club/categories/php/"},{"name":"问题总结","slug":"php/问题总结","permalink":"https://blog.k1s.club/categories/php/问题总结/"}],"tags":[{"name":"php","slug":"php","permalink":"https://blog.k1s.club/tags/php/"}]},{"title":"systemd一些命令","date":"2019-11-26T02:34:10.000Z","path":"2019/11/26/31-systemd一些命令/","text":"记录一些需要systemd命令 systemd命令 查看服务启动配置: systemctl cat k3s 查看开机启动的服务列表：systemctl list-unit-files|grep enabled 查看启动失败的服务列表：systemctl --failed 重启服务：systemctl restart firewalld.service 显示状态：systemctl status firewalld.service 开机启用服务：systemctl enable firewalld.service 开机禁用服务：systemctl disable firewalld.service 查看开机启动：systemctl is-enabled firewalld.service","raw":"---\ntitle: systemd一些命令\ncopyright: true\ndate: 2019-11-26 10:34:10\ntags:\n  - systemd\ncategories:\n  - [linux,systemd]\n\n---\n\n记录一些需要systemd命令\n<!--more-->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### systemd命令\n- 查看服务启动配置: `systemctl cat k3s`\n- 查看开机启动的服务列表：`systemctl list-unit-files|grep enabled`\n- 查看启动失败的服务列表：`systemctl --failed`\n\n- 重启服务：`systemctl restart firewalld.service`\n- 显示状态：`systemctl status firewalld.service`\n- 开机启用服务：`systemctl enable firewalld.service`\n- 开机禁用服务：`systemctl disable firewalld.service`\n- 查看开机启动：`systemctl is-enabled firewalld.service`\n\n\n","content":"<p>记录一些需要systemd命令</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"systemd命令\"><a href=\"#systemd命令\" class=\"headerlink\" title=\"systemd命令\"></a>systemd命令</h3><ul>\n<li><p>查看服务启动配置: <code>systemctl cat k3s</code></p>\n</li>\n<li><p>查看开机启动的服务列表：<code>systemctl list-unit-files|grep enabled</code></p>\n</li>\n<li><p>查看启动失败的服务列表：<code>systemctl --failed</code></p>\n</li>\n<li><p>重启服务：<code>systemctl restart firewalld.service</code></p>\n</li>\n<li><p>显示状态：<code>systemctl status firewalld.service</code></p>\n</li>\n<li><p>开机启用服务：<code>systemctl enable firewalld.service</code></p>\n</li>\n<li><p>开机禁用服务：<code>systemctl disable firewalld.service</code></p>\n</li>\n<li><p>查看开机启动：<code>systemctl is-enabled firewalld.service</code></p>\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/26/31-systemd一些命令/","categories":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"systemd","slug":"linux/systemd","permalink":"https://blog.k1s.club/categories/linux/systemd/"}],"tags":[{"name":"systemd","slug":"systemd","permalink":"https://blog.k1s.club/tags/systemd/"}]},{"title":"29-k3s集群部署项目报挂载nfs错误","date":"2019-11-25T09:37:23.000Z","path":"2019/11/25/29-k3s集群部署项目报挂载nfs错误/","text":"","raw":"---\ntitle: 29-k3s集群部署项目报挂载nfs错误\ncopyright: true\ndate: 2019-11-25 17:37:23\ntags:\n---\n","content":"","comments":true,"permalink":"https://blog.k1s.club/2019/11/25/29-k3s集群部署项目报挂载nfs错误/","categories":[],"tags":[]},{"title":"k3s集群部署项目报挂载nfs错误","date":"2019-11-25T09:37:23.000Z","path":"2019/11/25/30-k3s集群部署项目报挂载nfs错误/","text":"体验轻量级k8s集群遇到一些nfs问题 部署服务器查看describe信息如下:1234567Mounting command: systemd-runMounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605 --scope -- mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605Output: Running scope as unit run-14829.scope.mount: 文件系统类型错误、选项错误、192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 上有坏超级块、 缺少代码页或助手程序，或其他错误 (对某些文件系统(如 nfs、cifs) 您可能需要 一款 /sbin/mount.&lt;类型&gt; 助手程序) 分析 猜测1 可能是nfs的系统格式和集群node节点文件格式不同 1234# 查看发现nfs是ext4, 然后集群中其他的磁盘都是xfsdf -T|egrep -v \"contai|var|overl\"所以新挂了块磁盘,格式化为xfs然后再次实验,发现错误同样... 猜测2 可能是客户端无法识别nfs格式 12345678910111213# 做个测试mkdir /tmp/abcmount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /tmp/abc# 果然报错mount: wrong fs type, bad option, bad superblock on 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins, missing codepage or helper program, or other error (for several filesystems (e.g. nfs, cifs) you might need a /sbin/mount.&lt;type&gt; helper program) In some cases useful info is found in syslog - try dmesg | tail or so. 所以安装了nfs即可 1yum install nfs","raw":"---\ntitle: k3s集群部署项目报挂载nfs错误\ncopyright: true\ndate: 2019-11-25 17:37:23\ntags:\n  - k3s\ncategories:\n  - [技术文档]\n  - [k3s]\n  - [nfs]\n---\n体验轻量级k8s集群遇到一些nfs问题\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n\n### 部署服务器查看describe信息如下:\n\n```\nMounting command: systemd-run\nMounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605 --scope -- mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605\nOutput: Running scope as unit run-14829.scope.\nmount: 文件系统类型错误、选项错误、192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 上有坏超级块、\n       缺少代码页或助手程序，或其他错误\n       (对某些文件系统(如 nfs、cifs) 您可能需要\n       一款 /sbin/mount.<类型> 助手程序)\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 分析\n- 猜测1 可能是nfs的系统格式和集群node节点文件格式不同\n```\n# 查看发现nfs是ext4, 然后集群中其他的磁盘都是xfs\ndf -T|egrep -v \"contai|var|overl\"\n\n所以新挂了块磁盘,格式化为xfs然后再次实验,发现错误同样...\n```\n\n- 猜测2 可能是客户端无法识别nfs格式\n```\n# 做个测试\nmkdir /tmp/abc\nmount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /tmp/abc\n\n\n# 果然报错\nmount: wrong fs type, bad option, bad superblock on 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins,\n       missing codepage or helper program, or other error\n       (for several filesystems (e.g. nfs, cifs) you might\n       need a /sbin/mount.<type> helper program)\n\n       In some cases useful info is found in syslog - try\n       dmesg | tail or so.\n```\n\n所以安装了nfs即可\n```\nyum install nfs\n```\n\n","content":"<p>体验轻量级k8s集群遇到一些nfs问题</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n\n<h3 id=\"部署服务器查看describe信息如下\"><a href=\"#部署服务器查看describe信息如下\" class=\"headerlink\" title=\"部署服务器查看describe信息如下:\"></a>部署服务器查看describe信息如下:</h3><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Mounting command: systemd-run</span><br><span class=\"line\">Mounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/369daaef<span class=\"string\">-1</span>e90<span class=\"string\">-446</span>b<span class=\"string\">-92</span>ce<span class=\"string\">-3</span>d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606<span class=\"string\">-5796</span><span class=\"string\">-4</span>c48<span class=\"string\">-8928</span><span class=\"string\">-7822</span>f3fa0605 --scope -- mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520<span class=\"string\">-2</span>-dev-nfs-es520<span class=\"string\">-2</span>-dev<span class=\"string\">-1</span>-pvc-f462c606<span class=\"string\">-5796</span><span class=\"string\">-4</span>c48<span class=\"string\">-8928</span><span class=\"string\">-7822</span>f3fa0605 /var/lib/kubelet/pods/369daaef<span class=\"string\">-1</span>e90<span class=\"string\">-446</span>b<span class=\"string\">-92</span>ce<span class=\"string\">-3</span>d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606<span class=\"string\">-5796</span><span class=\"string\">-4</span>c48<span class=\"string\">-8928</span><span class=\"string\">-7822</span>f3fa0605</span><br><span class=\"line\">Output: Running scope as unit run<span class=\"string\">-14829</span>.scope.</span><br><span class=\"line\">mount: 文件系统类型错误、选项错误、192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520<span class=\"string\">-2</span>-dev-nfs-es520<span class=\"string\">-2</span>-dev<span class=\"string\">-1</span>-pvc-f462c606<span class=\"string\">-5796</span><span class=\"string\">-4</span>c48<span class=\"string\">-8928</span><span class=\"string\">-7822</span>f3fa0605 上有坏超级块、</span><br><span class=\"line\">       缺少代码页或助手程序，或其他错误</span><br><span class=\"line\">       (对某些文件系统(如 nfs、cifs) 您可能需要</span><br><span class=\"line\">       一款 /sbin/mount.&lt;类型&gt; 助手程序)</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h3><ul>\n<li><p>猜测1 可能是nfs的系统格式和集群node节点文件格式不同</p>\n<figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看发现nfs是ext4, 然后集群中其他的磁盘都是xfs</span></span><br><span class=\"line\">df -T|<span class=\"string\">egrep -v \"contai</span>|<span class=\"string\">var</span>|<span class=\"string\">overl\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">所以新挂了块磁盘,格式化为xfs然后再次实验,发现错误同样...</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>猜测2 可能是客户端无法识别nfs格式</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 做个测试</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /tmp/<span class=\"keyword\">abc</span></span><br><span class=\"line\">mount -t nfs <span class=\"number\">192.168</span>.<span class=\"keyword\">x</span>.<span class=\"keyword\">x</span>:/data-nfs/nfs/k3s/ns-elastic5-es520-<span class=\"number\">2</span>-dev-nfs-es520-<span class=\"number\">2</span>-dev-<span class=\"number\">1</span>-pvc-f462c606-<span class=\"number\">5796</span>-<span class=\"number\">4</span>c48-<span class=\"number\">8928</span>-<span class=\"number\">7822</span>f3fa0605 /tmp/<span class=\"keyword\">abc</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 果然报错</span><br><span class=\"line\">moun<span class=\"variable\">t:</span> wrong fs <span class=\"built_in\">type</span>, <span class=\"keyword\">bad</span> option, <span class=\"keyword\">bad</span> superblock <span class=\"keyword\">on</span> <span class=\"number\">192.168</span>.<span class=\"keyword\">x</span>.<span class=\"keyword\">x</span>:/data-nfs/nfs/k3s/ns-elastic5-es520-<span class=\"number\">2</span>-dev-nfs-plugins,</span><br><span class=\"line\">       missing codepage <span class=\"built_in\">or</span> helper program, <span class=\"built_in\">or</span> other error</span><br><span class=\"line\">       (<span class=\"keyword\">for</span> several filesystems (<span class=\"keyword\">e</span>.g. nfs, cifs) you might</span><br><span class=\"line\">       need <span class=\"keyword\">a</span> /sbin/mount.<span class=\"symbol\">&lt;type&gt;</span> helper program)</span><br><span class=\"line\"></span><br><span class=\"line\">       In some cases useful info <span class=\"keyword\">is</span> found in syslog - <span class=\"keyword\">try</span></span><br><span class=\"line\">       dmesg | tail <span class=\"built_in\">or</span> <span class=\"keyword\">so</span>.</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>所以安装了nfs即可</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum <span class=\"keyword\">install</span> nfs</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/25/30-k3s集群部署项目报挂载nfs错误/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/categories/k3s/"},{"name":"nfs","slug":"nfs","permalink":"https://blog.k1s.club/categories/nfs/"}],"tags":[{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/tags/k3s/"}]},{"title":"k8s1.16使用旧yml部署配置问题","date":"2019-11-25T07:41:48.000Z","path":"2019/11/25/28-k8s1-16使用旧yml部署配置问题/","text":"使用k8s 1.16遇到的问题 1 appversion的改变12no matches for kind \"StatefulSet\" in version \"apps/v1beta1\"no matches for kind \"Deployment\" in version \"extensions/v1beta1\" 1234567891011121314# Deployment(extensions/v1beta1 舍弃)apiVersion: extensions/v1beta1 -&gt; apiVersion: apps/v1# StatefulSetapiVersion: apps/v1beta1 -&gt; apiVersion: apps/v1# 然后根据提示在spec 下添加selector.matchLabelsspec: replicas: 3 selector: matchLabels: app: test1可以通过kubectl convert 更新yaml文件 完整示例: 123456789101112131415161718192021222324252627&gt; nginx1.yml &lt;&lt;- EOF apiVersion: apps/v1kind: Deploymentmetadata: name: nginx1spec: replicas: 1 selector: matchLabels: app: nginx1 template: metadata: labels: app: nginx1 spec: containers: - image: nginx name: nginx1 imagePullPolicy: Always resources: requests: cpu: \"10m\" memory: \"10Mi\" limits: cpu: \"100m\" memory: \"50Mi\"EOF","raw":"---\ntitle: k8s1.16使用旧yml部署配置问题\ncopyright: true\ndate: 2019-11-25 15:41:48\ntags:\n  - k8s\ncategories:\n  - [技术文档]\n  - [k8s,问题总结]\n---\n使用k8s 1.16遇到的问题\n<!--more-->\n\n\n### 1 appversion的改变\n```\nno matches for kind \"StatefulSet\" in version \"apps/v1beta1\"\nno matches for kind \"Deployment\" in version \"extensions/v1beta1\"\n```\n\n```\n# Deployment(extensions/v1beta1 舍弃)\napiVersion: extensions/v1beta1 -> apiVersion: apps/v1\n# StatefulSet\napiVersion: apps/v1beta1       -> apiVersion: apps/v1\n\n\n# 然后根据提示在spec 下添加selector.matchLabels\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: test1\n\n可以通过kubectl convert 更新yaml文件\n```\n\n- 完整示例:\n\n```\n> nginx1.yml <<- EOF  \napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx1\n  template:\n    metadata:\n      labels:\n        app: nginx1\n    spec:\n      containers:\n      - image: nginx\n        name: nginx1\n        imagePullPolicy: Always\n        resources:\n          requests:\n            cpu: \"10m\"\n            memory: \"10Mi\"\n          limits:\n            cpu: \"100m\"\n            memory: \"50Mi\"\nEOF\n\n```\n","content":"<p>使用k8s 1.16遇到的问题</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"1-appversion的改变\"><a href=\"#1-appversion的改变\" class=\"headerlink\" title=\"1 appversion的改变\"></a>1 appversion的改变</h3><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">no</span> matches <span class=\"keyword\">for</span> kind <span class=\"string\">\"StatefulSet\"</span> <span class=\"keyword\">in</span> <span class=\"keyword\">version</span> <span class=\"string\">\"apps/v1beta1\"</span></span><br><span class=\"line\"><span class=\"keyword\">no</span> matches <span class=\"keyword\">for</span> kind <span class=\"string\">\"Deployment\"</span> <span class=\"keyword\">in</span> <span class=\"keyword\">version</span> <span class=\"string\">\"extensions/v1beta1\"</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Deployment(extensions/v1beta1 舍弃)</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span> <span class=\"bullet\">-&gt;</span> <span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"comment\"># StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span>       <span class=\"bullet\">-&gt;</span> <span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 然后根据提示在spec 下添加selector.matchLabels</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">test1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">可以通过kubectl</span> <span class=\"string\">convert</span> <span class=\"string\">更新yaml文件</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>完整示例:</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&gt; nginx1.yml &lt;&lt;- EOF  </span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">nginx1</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx1</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">nginx1</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"10m\"</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"string\">\"10Mi\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"100m\"</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"string\">\"50Mi\"</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/25/28-k8s1-16使用旧yml部署配置问题/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"问题总结","slug":"k8s/问题总结","permalink":"https://blog.k1s.club/categories/k8s/问题总结/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"k8s一条命令部署es5.2.0集群","date":"2019-11-21T10:13:35.000Z","path":"2019/11/21/27-k8s一条命令部署es5-2-0集群/","text":"由于老项目是基于es5.2.0, 所以准备在k8s基于nfs存储搭建一套,下面简单介绍 准备好环境和官方镜像12341 镜像: elasticsearch:5.2.02 k8s环境: k8s.1.103 存储: nfs storageclass 存储4 插件: ik分词压缩包(这里ik分词直接使用旧的es配置, 也可以自行下) 开始部署 部署命令1kubectl apply -f k8s-StatefulSet-es520-nfs.yml 配置文件 k8s-StatefulSet-es520-nfs.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149apiVersion: apps/v1beta1kind: StatefulSetmetadata: name: es520-2-dev namespace: ns-elastic5spec: serviceName: \"es520-2-dev\" replicas: 2 volumeClaimTemplates: - metadata: name: es520-2-dev-nfs annotations: volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称 spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 2Gi template: metadata: labels: app: es520-2-dev spec: containers: - name: es520-2-dev image: elasticsearch:5.2.0 ports: - containerPort: 9200 name: es520-2-9200 protocol: TCP - containerPort: 9300 name: es520-2-9300 protocol: TCP resources: requests: cpu: \"50m\" limits: cpu: \"500m\" volumeMounts: - name: es520-2-dev-nfs mountPath: /usr/share/elasticsearch/data/ - name: es520-2-dev-cfg mountPath: /usr/share/elasticsearch/config/elasticsearch.yml subPath: elasticsearch.yml - name: es520-2-dev-jvm mountPath: /usr/share/elasticsearch/config/jvm.options subPath: jvm.options - name: es520-2-dev-plu mountPath: /usr/share/elasticsearch/plugins volumes: - name: es520-2-dev-cfg configMap: name: es520-2-dev-cfg items: - key: elasticsearch.yml path: elasticsearch.yml - name: es520-2-dev-jvm configMap: name: es520-2-dev-jvm items: - key: jvm.options path: jvm.options - name: es520-2-dev-plu nfs: server: 192.168.53.106 path: /data/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins---kind: ServiceapiVersion: v1metadata: labels: app: es520-2-dev name: es520-2-dev namespace: ns-elastic5spec: type: NodePort ports: - name: es520-2-9200 port: 9200 targetPort: 9200 nodePort: 31201 protocol: TCP - name: es520-2-9300 port: 9300 targetPort: 9300 nodePort: 31301 protocol: TCP selector: app: es520-2-dev---apiVersion: v1kind: Servicemetadata: name: es520-2-dev-hlspec: clusterIP: None selector: app: es520-2-dev ports: - name: es520-2-9200 port: 9200 - name: es520-2-9300 port: 9300---apiVersion: v1kind: ConfigMapmetadata: name: es520-2-dev-cfg namespace: ns-elastic5data: elasticsearch.yml: | cluster.name: k8s-test-nfs network.host: 0.0.0.0 bootstrap.system_call_filter: false discovery.zen.ping.unicast.hosts: [\"es520-2-dev-0.es520-2-dev:9300\",\"es520-2-dev-1.es520-2-dev:9300\",\"es520-2-dev-2.es520-2-dev:9300\"] http.cors.enabled: true http.cors.allow-origin: \"*\" thread_pool.bulk.queue_size: 3000---apiVersion: v1kind: ConfigMapmetadata: name: es520-2-dev-jvm namespace: ns-elastic5data: jvm.options: | -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError 效果图 rancher 上效果 elasticsearch-head 上效果图","raw":"---\ntitle: k8s一条命令部署es5.2.0集群\ncopyright: true\ndate: 2019-11-21 18:13:35\ntags:\n  - k8s\n  - elk\n  - elk5\n  - elasticsearch5\ncategories:\n  - [技术文档]\n  - [k8s,elk5]\n  - [elk,elasticsearch5]\n---\n\n由于老项目是基于es5.2.0, 所以准备在k8s基于nfs存储搭建一套,下面简单介绍\n<!--more-->\n\n\n### 准备好环境和官方镜像\n```\n1 镜像: elasticsearch:5.2.0\n2 k8s环境: k8s.1.10\n3 存储: nfs storageclass 存储\n4 插件: ik分词压缩包(这里ik分词直接使用旧的es配置, 也可以自行下)\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 开始部署 </font>\n</center>\n\n### 部署命令\n```\nkubectl apply -f k8s-StatefulSet-es520-nfs.yml\n```\n\n### 配置文件 k8s-StatefulSet-es520-nfs.yml\n```\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  name: es520-2-dev\n  namespace: ns-elastic5\nspec:\n  serviceName: \"es520-2-dev\"\n  replicas: 2\n  volumeClaimTemplates:\n  - metadata:\n      name: es520-2-dev-nfs\n      annotations:\n        volume.beta.kubernetes.io/storage-class: \"nfs-retain\" # 这里配置 上面创建的 storageclass 的名称\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 2Gi\n  template:\n    metadata:\n      labels:\n        app: es520-2-dev\n    spec:\n      containers:\n      - name: es520-2-dev\n        image: elasticsearch:5.2.0\n        ports:\n        - containerPort: 9200\n          name: es520-2-9200\n          protocol: TCP\n        - containerPort: 9300\n          name: es520-2-9300\n          protocol: TCP\n        resources:\n          requests:\n            cpu: \"50m\"\n          limits:\n            cpu: \"500m\"\n        volumeMounts:\n        - name: es520-2-dev-nfs\n          mountPath: /usr/share/elasticsearch/data/\n        - name: es520-2-dev-cfg\n          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n          subPath: elasticsearch.yml\n        - name: es520-2-dev-jvm\n          mountPath: /usr/share/elasticsearch/config/jvm.options\n          subPath: jvm.options\n        - name: es520-2-dev-plu\n          mountPath: /usr/share/elasticsearch/plugins\n      volumes:\n      - name: es520-2-dev-cfg\n        configMap:\n          name: es520-2-dev-cfg\n          items:\n          - key: elasticsearch.yml\n            path: elasticsearch.yml\n      - name: es520-2-dev-jvm\n        configMap:\n          name: es520-2-dev-jvm\n          items:\n          - key: jvm.options\n            path: jvm.options\n      - name: es520-2-dev-plu\n        nfs:\n            server: 192.168.53.106\n            path: /data/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   app: es520-2-dev\n name: es520-2-dev\n namespace: ns-elastic5\nspec:\n type: NodePort\n ports:\n   - name: es520-2-9200\n     port: 9200\n     targetPort: 9200\n     nodePort: 31201\n     protocol: TCP\n   - name: es520-2-9300\n     port: 9300\n     targetPort: 9300\n     nodePort: 31301\n     protocol: TCP\n selector:\n   app: es520-2-dev\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: es520-2-dev-hl\nspec:\n  clusterIP: None\n  selector:\n    app: es520-2-dev\n  ports:\n   - name: es520-2-9200\n     port: 9200\n   - name: es520-2-9300\n     port: 9300\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: es520-2-dev-cfg\n  namespace: ns-elastic5\ndata:\n  elasticsearch.yml: |\n\n   cluster.name: k8s-test-nfs\n   network.host: 0.0.0.0\n   bootstrap.system_call_filter: false\n   discovery.zen.ping.unicast.hosts: [\"es520-2-dev-0.es520-2-dev:9300\",\"es520-2-dev-1.es520-2-dev:9300\",\"es520-2-dev-2.es520-2-dev:9300\"]\n   http.cors.enabled: true\n   http.cors.allow-origin: \"*\"\n   thread_pool.bulk.queue_size: 3000\n\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: es520-2-dev-jvm\n  namespace: ns-elastic5\ndata:\n  jvm.options: |\n   -Xms512m\n   -Xmx512m\n   -XX:+UseConcMarkSweepGC\n   -XX:CMSInitiatingOccupancyFraction=75\n   -XX:+UseCMSInitiatingOccupancyOnly\n   -XX:+DisableExplicitGC\n   -XX:+AlwaysPreTouch\n   -server\n   -Xss1m\n   -Djava.awt.headless=true\n   -Dfile.encoding=UTF-8\n   -Djna.nosys=true\n   -Djdk.io.permissionsUseCanonicalPath=true\n   -Dio.netty.noUnsafe=true\n   -Dio.netty.noKeySetOptimization=true\n   -Dio.netty.recycler.maxCapacityPerThread=0\n   -Dlog4j.shutdownHookEnabled=false\n   -Dlog4j2.disable.jmx=true\n   -Dlog4j.skipJansi=true\n   -XX:+HeapDumpOnOutOfMemoryError\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 效果图 </font>\n</center>\n\n\n### rancher 上效果\n<img src=\"//zhangzw001.github.io/images/27/img1.png\">\n\n\n### elasticsearch-head 上效果图\n<img src=\"//zhangzw001.github.io/images/27/img2.jpg\">\n\n","content":"<p>由于老项目是基于es5.2.0, 所以准备在k8s基于nfs存储搭建一套,下面简单介绍</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"准备好环境和官方镜像\"><a href=\"#准备好环境和官方镜像\" class=\"headerlink\" title=\"准备好环境和官方镜像\"></a>准备好环境和官方镜像</h3><figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>镜像: elasticsearch:<span class=\"number\">5.2.0</span></span><br><span class=\"line\"><span class=\"symbol\">2 </span>k8s环境: k8s.<span class=\"number\">1.10</span></span><br><span class=\"line\"><span class=\"symbol\">3 </span>存储: nfs storageclass 存储</span><br><span class=\"line\"><span class=\"symbol\">4 </span>插件: ik分词压缩包(这里ik分词直接使用旧的es配置, 也可以自行下)</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 开始部署 </font>\n</center>\n\n<h3 id=\"部署命令\"><a href=\"#部署命令\" class=\"headerlink\" title=\"部署命令\"></a>部署命令</h3><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f k8s-StatefulSet-es520-nfs.yml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置文件-k8s-StatefulSet-es520-nfs-yml\"><a href=\"#配置文件-k8s-StatefulSet-es520-nfs-yml\" class=\"headerlink\" title=\"配置文件 k8s-StatefulSet-es520-nfs.yml\"></a>配置文件 k8s-StatefulSet-es520-nfs.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic5</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"es520-2-dev\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">es520-2-dev-nfs</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span></span><br><span class=\"line\">        <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs-retain\"</span> <span class=\"comment\"># 这里配置 上面创建的 storageclass 的名称</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">2</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">elasticsearch:5.2.0</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">es520-2-9200</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">es520-2-9300</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"500m\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">es520-2-dev-nfs</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data/</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">es520-2-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">es520-2-dev-jvm</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/jvm.options</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">jvm.options</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">es520-2-dev-plu</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/plugins</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">es520-2-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">es520-2-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          items:</span></span><br><span class=\"line\"><span class=\"attr\">          - key:</span> <span class=\"string\">elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">es520-2-dev-jvm</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">es520-2-dev-jvm</span></span><br><span class=\"line\"><span class=\"attr\">          items:</span></span><br><span class=\"line\"><span class=\"attr\">          - key:</span> <span class=\"string\">jvm.options</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">jvm.options</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">es520-2-dev-plu</span></span><br><span class=\"line\"><span class=\"attr\">        nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"number\">192.168</span><span class=\"number\">.53</span><span class=\"number\">.106</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic5</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">es520-2-9200</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">31201</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">es520-2-9300</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">31301</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">es520-2-dev-hl</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">es520-2-dev</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">es520-2-9200</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">es520-2-9300</span></span><br><span class=\"line\"><span class=\"attr\">     port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">es520-2-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic5</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">elasticsearch.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   cluster.name: k8s-test-nfs</span></span><br><span class=\"line\"><span class=\"string\">   network.host: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">   bootstrap.system_call_filter: false</span></span><br><span class=\"line\"><span class=\"string\">   discovery.zen.ping.unicast.hosts: [\"es520-2-dev-0.es520-2-dev:9300\",\"es520-2-dev-1.es520-2-dev:9300\",\"es520-2-dev-2.es520-2-dev:9300\"]</span></span><br><span class=\"line\"><span class=\"string\">   http.cors.enabled: true</span></span><br><span class=\"line\"><span class=\"string\">   http.cors.allow-origin: \"*\"</span></span><br><span class=\"line\"><span class=\"string\">   thread_pool.bulk.queue_size: 3000</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">es520-2-dev-jvm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic5</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">jvm.options:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">   -Xms512m</span></span><br><span class=\"line\"><span class=\"string\">   -Xmx512m</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">   -XX:</span><span class=\"string\">+UseConcMarkSweepGC</span></span><br><span class=\"line\"><span class=\"attr\">   -XX:</span><span class=\"string\">CMSInitiatingOccupancyFraction=75</span></span><br><span class=\"line\"><span class=\"attr\">   -XX:</span><span class=\"string\">+UseCMSInitiatingOccupancyOnly</span></span><br><span class=\"line\"><span class=\"attr\">   -XX:</span><span class=\"string\">+DisableExplicitGC</span></span><br><span class=\"line\"><span class=\"attr\">   -XX:</span><span class=\"string\">+AlwaysPreTouch</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Xss1m</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Djava.awt.headless=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dfile.encoding=UTF-8</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Djna.nosys=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Djdk.io.permissionsUseCanonicalPath=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dio.netty.noUnsafe=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dio.netty.noKeySetOptimization=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dio.netty.recycler.maxCapacityPerThread=0</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dlog4j.shutdownHookEnabled=false</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dlog4j2.disable.jmx=true</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span><span class=\"string\">Dlog4j.skipJansi=true</span></span><br><span class=\"line\"><span class=\"attr\">   -XX:</span><span class=\"string\">+HeapDumpOnOutOfMemoryError</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 效果图 </font>\n</center>\n\n\n<h3 id=\"rancher-上效果\"><a href=\"#rancher-上效果\" class=\"headerlink\" title=\"rancher 上效果\"></a>rancher 上效果</h3><img src=\"//zhangzw001.github.io/images/27/img1.png\">\n\n\n<h3 id=\"elasticsearch-head-上效果图\"><a href=\"#elasticsearch-head-上效果图\" class=\"headerlink\" title=\"elasticsearch-head 上效果图\"></a>elasticsearch-head 上效果图</h3><img src=\"//zhangzw001.github.io/images/27/img2.jpg\">\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/21/27-k8s一条命令部署es5-2-0集群/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elasticsearch5","slug":"elk/elasticsearch5","permalink":"https://blog.k1s.club/categories/elk/elasticsearch5/"},{"name":"elk5","slug":"k8s/elk5","permalink":"https://blog.k1s.club/categories/k8s/elk5/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"elasticsearch5","slug":"elasticsearch5","permalink":"https://blog.k1s.club/tags/elasticsearch5/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/tags/elk/"},{"name":"elk5","slug":"elk5","permalink":"https://blog.k1s.club/tags/elk5/"}]},{"title":"logstash配置","date":"2019-11-08T09:28:26.000Z","path":"2019/11/08/26-logstash配置/","text":"记录一些logstash的配置问题 想要排除某些信息官方文档 12345678if \"_grokparsefailure\" not in [tags] &#123; if [sqlDuring] &lt; 5 &#123; drop &#123;&#125; &#125;&#125;else &#123; drop &#123;&#125;&#125; 请务必注意 如果failure 可能会导致找不到 sqlDuring变量 而报错 1[2019-12-05T17:53:03,017][FATAL][logstash.runner ] An unexpected error occurred! &#123;:error=&gt;#&lt;NoMethodError: undefined method `&lt;' for nil:NilClass&gt;, :backtrace=&gt;[\"(eval):139:in `initialize'\", \"org/jruby/RubyArray.java:1613:in `each'\", \"(eval):137:in `initialize'\", \"org/jruby/RubyProc.java:281:in `call'\", \"(eval):96:in `filter_func'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:260:in `filter_batch'\", \"org/jruby/RubyProc.java:281:in `call'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:186:in `each'\", \"org/jruby/RubyHash.java:1342:in `each'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:185:in `each'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:258:in `filter_batch'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:246:in `worker_loop'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:225:in `start_workers'\"]&#125;","raw":"---\ntitle: logstash配置\ncopyright: true\ndate: 2019-11-08 17:28:26\ntags:\n  - logstash\ncategories:\n  - [elk,logstash]\n\n---\n记录一些logstash的配置问题\n<!-- more -->\n\n\n### 想要排除某些信息\n[官方文档](https://www.elastic.co/guide/en/logstash/5.4/event-dependent-configuration.html#conditionals)\n\n\n```\nif \"_grokparsefailure\" not in [tags] {\n        if [sqlDuring] < 5 {\n                 drop {}\n         }\n}\nelse {\n        drop {}\n}\n```\n\n> 请务必注意 如果failure 可能会导致找不到 sqlDuring变量 而报错\n\n```\n[2019-12-05T17:53:03,017][FATAL][logstash.runner          ] An unexpected error occurred! {:error=>#<NoMethodError: undefined method `<' for nil:NilClass>, :backtrace=>[\"(eval):139:in `initialize'\", \"org/jruby/RubyArray.java:1613:in `each'\", \"(eval):137:in `initialize'\", \"org/jruby/RubyProc.java:281:in `call'\", \"(eval):96:in `filter_func'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:260:in `filter_batch'\", \"org/jruby/RubyProc.java:281:in `call'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:186:in `each'\", \"org/jruby/RubyHash.java:1342:in `each'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:185:in `each'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:258:in `filter_batch'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:246:in `worker_loop'\", \"/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:225:in `start_workers'\"]}\n```\n","content":"<p>记录一些logstash的配置问题</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"想要排除某些信息\"><a href=\"#想要排除某些信息\" class=\"headerlink\" title=\"想要排除某些信息\"></a>想要排除某些信息</h3><p><a href=\"https://www.elastic.co/guide/en/logstash/5.4/event-dependent-configuration.html#conditionals\" target=\"_blank\" rel=\"noopener\">官方文档</a></p>\n<figure class=\"highlight sqf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">\"_grokparsefailure\"</span> <span class=\"built_in\">not</span> <span class=\"built_in\">in</span> [tags] &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> [sqlDuring] &lt; <span class=\"number\">5</span> &#123;</span><br><span class=\"line\">                 <span class=\"built_in\">drop</span> &#123;&#125;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">drop</span> &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请务必注意 如果failure 可能会导致找不到 sqlDuring变量 而报错</p>\n</blockquote>\n<figure class=\"highlight sml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"number\">2019</span>-<span class=\"number\">12</span>-<span class=\"number\">05</span>T17:<span class=\"number\">53</span>:<span class=\"number\">03</span>,<span class=\"number\">017</span>][<span class=\"type\">FATAL</span>][logstash.runner          ] <span class=\"type\">An</span> unexpected error occurred! &#123;:error=&gt;#&lt;<span class=\"type\">NoMethodError</span>: undefined method `&lt;<span class=\"string\">' for nil:NilClass&gt;, :backtrace=&gt;[\"(eval):139:in `initialize'</span><span class=\"string\">\", \"</span>org/jruby/<span class=\"type\">RubyArray</span>.java:<span class=\"number\">1613</span>:<span class=\"keyword\">in</span> `each'<span class=\"string\">\", \"</span>(eval):<span class=\"number\">137</span>:<span class=\"keyword\">in</span> `initialize'<span class=\"string\">\", \"</span>org/jruby/<span class=\"type\">RubyProc</span>.java:<span class=\"number\">281</span>:<span class=\"keyword\">in</span> `call'<span class=\"string\">\", \"</span>(eval):<span class=\"number\">96</span>:<span class=\"keyword\">in</span> `filter_func'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/pipeline.rb:<span class=\"number\">260</span>:<span class=\"keyword\">in</span> `filter_batch'<span class=\"string\">\", \"</span>org/jruby/<span class=\"type\">RubyProc</span>.java:<span class=\"number\">281</span>:<span class=\"keyword\">in</span> `call'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:<span class=\"number\">186</span>:<span class=\"keyword\">in</span> `each'<span class=\"string\">\", \"</span>org/jruby/<span class=\"type\">RubyHash</span>.java:<span class=\"number\">1342</span>:<span class=\"keyword\">in</span> `each'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:<span class=\"number\">185</span>:<span class=\"keyword\">in</span> `each'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/pipeline.rb:<span class=\"number\">258</span>:<span class=\"keyword\">in</span> `filter_batch'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/pipeline.rb:<span class=\"number\">246</span>:<span class=\"keyword\">in</span> `worker_loop'<span class=\"string\">\", \"</span>/usr/<span class=\"keyword\">local</span>/logstash-<span class=\"number\">5.0</span>.<span class=\"number\">2</span>/logstash-core/lib/logstash/pipeline.rb:<span class=\"number\">225</span>:<span class=\"keyword\">in</span> `start_workers'<span class=\"string\">\"]&#125;</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/08/26-logstash配置/","categories":[{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"logstash","slug":"elk/logstash","permalink":"https://blog.k1s.club/categories/elk/logstash/"}],"tags":[{"name":"logstash","slug":"logstash","permalink":"https://blog.k1s.club/tags/logstash/"}]},{"title":"Linux一些脚本汇总","date":"2019-11-01T09:50:26.000Z","path":"2019/11/01/25-linux一些脚本汇总/","text":"记录一些shell脚本 1 清理es几天前的索引脚本2 从mysql导出表到clickhouse脚本 ###命令汇总 生成字符串1tr -dc A-Za-z0-9_@$\\%\\^\\/\\+ &lt; /dev/urandom|head -c 16|xargs grep需要转义的字符123grep '\"第一个转义\\$第二个转义\\[&#123;' a.txt或者直接使用-Fgrep -F '\"$[&#123;' a.txt shell参数12345678while [ -n \"$1\" ]do case \"$1\" in -a) a=$2;shift 2;; -s) s=$2;shift 2;; *) ;; casedone #%处理变量12345tmpDir=/dir1/dir2/dir3/my.file.txt$&#123;tmpDir#*/&#125; -&gt; dir1/dir2/dir3/my.file.txt (左)删除从左往右第一个 /以及左边的所有内容$&#123;tmpDir##*/&#125; -&gt; my.file.txt (左)删除从左往右最后一个/以及左边的所有内容$&#123;tmpDir%/*&#125; -&gt; /dir1/dir2/dir3/ (右)删除从右往左第一个 /以及右边的所有内容$&#123;tmpDir%%/*&#125; -&gt; 空 (右)删除从右往左最后一个/以及右边的所有内容","raw":"---\ntitle: Linux一些脚本汇总\ncopyright: true\ndate: 2019-11-01 17:50:26\ntags:\n  - shell\ncategories:\n  - [linux,shell]\n---\n记录一些shell脚本\n<!-- more -->\n\n1 [清理es几天前的索引脚本](//zhangzw001.github.io/sh/clean_es_data.sh.sh)\n2 [从mysql导出表到clickhouse脚本](//zhangzw001.github.io/sh/clickhouse_from_mysql.sh)\n\n\n---\n###命令汇总\n####  生成字符串\n```\ntr -dc A-Za-z0-9_@$\\%\\^\\/\\+ < /dev/urandom|head -c 16|xargs\n\n```\n\n#### grep需要转义的字符\n```\ngrep '\"第一个转义\\$第二个转义\\[{'  a.txt\n或者直接使用-F\ngrep -F '\"$[{' a.txt\n```\n\n#### shell参数\n```\nwhile [ -n \"$1\" ]\ndo\n case \"$1\" in \n  -a) a=$2;shift 2;;\n  -s) s=$2;shift 2;;\n  *) ;;\n case\ndone\n```\n\n### #%处理变量\n```\ntmpDir=/dir1/dir2/dir3/my.file.txt\n${tmpDir#*/}\t-> dir1/dir2/dir3/my.file.txt\t(左)删除从左往右第一个  /以及左边的所有内容\n${tmpDir##*/}\t-> my.file.txt\t\t\t(左)删除从左往右最后一个/以及左边的所有内容\n${tmpDir%/*}\t-> /dir1/dir2/dir3/\t\t(右)删除从右往左第一个  /以及右边的所有内容\n${tmpDir%%/*}\t-> 空\t\t\t\t(右)删除从右往左最后一个/以及右边的所有内容\n```\n","content":"<p>记录一些shell脚本</p>\n<a id=\"more\"></a>\n\n<p>1 <a href=\"//zhangzw001.github.io/sh/clean_es_data.sh.sh\">清理es几天前的索引脚本</a><br>2 <a href=\"//zhangzw001.github.io/sh/clickhouse_from_mysql.sh\">从mysql导出表到clickhouse脚本</a></p>\n<hr>\n<p>###命令汇总</p>\n<h4 id=\"生成字符串\"><a href=\"#生成字符串\" class=\"headerlink\" title=\"生成字符串\"></a>生成字符串</h4><figure class=\"highlight taggerscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tr -dc A-Za-z0-9_@$<span class=\"symbol\">\\%</span><span class=\"symbol\">\\^</span><span class=\"symbol\">\\/</span><span class=\"symbol\">\\+</span> &lt; /dev/urandom|head -c 16|xargs</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"grep需要转义的字符\"><a href=\"#grep需要转义的字符\" class=\"headerlink\" title=\"grep需要转义的字符\"></a>grep需要转义的字符</h4><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep <span class=\"string\">'\"第一个转义\\$第二个转义\\[&#123;'</span>  <span class=\"selector-tag\">a</span>.txt</span><br><span class=\"line\">或者直接使用-F</span><br><span class=\"line\">grep -F <span class=\"string\">'\"$[&#123;'</span> <span class=\"selector-tag\">a</span>.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"shell参数\"><a href=\"#shell参数\" class=\"headerlink\" title=\"shell参数\"></a>shell参数</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> [ -n <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> ]</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\"> <span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> <span class=\"keyword\">in</span> </span><br><span class=\"line\">  -a) a=<span class=\"variable\">$2</span>;<span class=\"built_in\">shift</span> 2;;</span><br><span class=\"line\">  -s) s=<span class=\"variable\">$2</span>;<span class=\"built_in\">shift</span> 2;;</span><br><span class=\"line\">  *) ;;</span><br><span class=\"line\"> <span class=\"keyword\">case</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"处理变量\"><a href=\"#处理变量\" class=\"headerlink\" title=\"#%处理变量\"></a>#%处理变量</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tmpDir=<span class=\"regexp\">/dir1/dir</span>2/dir3/my.file.txt</span><br><span class=\"line\"><span class=\"variable\">$&#123;</span>tmpDir<span class=\"comment\">#*/&#125;\t-&gt; dir1/dir2/dir3/my.file.txt\t(左)删除从左往右第一个  /以及左边的所有内容</span></span><br><span class=\"line\"><span class=\"variable\">$&#123;</span>tmpDir<span class=\"comment\">##*/&#125;\t-&gt; my.file.txt\t\t\t(左)删除从左往右最后一个/以及左边的所有内容</span></span><br><span class=\"line\"><span class=\"variable\">$&#123;</span>tmpDir%<span class=\"regexp\">/*&#125;\t-&gt; /dir</span>1/dir2/dir3/\t\t(右)删除从右往左第一个  /以及右边的所有内容</span><br><span class=\"line\"><span class=\"variable\">$&#123;</span>tmpDir%%<span class=\"regexp\">/*&#125;\t-&gt; 空\t\t\t\t(右)删除从右往左最后一个/</span>以及右边的所有内容</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/11/01/25-linux一些脚本汇总/","categories":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"shell","slug":"linux/shell","permalink":"https://blog.k1s.club/categories/linux/shell/"}],"tags":[{"name":"shell","slug":"shell","permalink":"https://blog.k1s.club/tags/shell/"}]},{"title":"filebeat7收集mysql慢日志到es","date":"2019-10-30T08:56:37.000Z","path":"2019/10/30/24-filebeat7收集mysql慢日志到es/","text":"慢日志提供给开发查看, 采用elk统一提供,这里采用k8s环境搭建 原文: ELK收集mysql_slow.log其他: filebeat （7.1.0）docker容器 slowlog内容分析 5.5 版本慢查询日志 12345# Time: 191030 17:03:13# User@Host: myuser[myuser] @ [10.10.0.1]# Query_time: 3.329673 Lock_time: 0.000107 Rows_sent: 0 Rows_examined: 3971182SET timestamp=1572426193;select * from a where name = 1 limit 1; 5.6 版本慢查询日志 123456# Time: 191030 17:03:13# User@Host: myuser[myuser] @ [10.10.0.1] Id: 1111# Query_time: 3.329673 Lock_time: 0.000107 Rows_sent: 0 Rows_examined: 3971182use db_name;SET timestamp=1572426193;select * from a where name = 1 limit 1; 5.7 版本慢查询日志 12345# Time: 2019-10-06T13:25:38.703546+08:00# User@Host: myuser[myuser] @ [10.10.0.1] Id: 1111# Query_time: 3.329673 Lock_time: 0.000107 Rows_sent: 0 Rows_examined: 3971182SET timestamp=1572426193;select * from a where name = 1 limit 1; 除以上格式以外,还需要注意慢查询代码块,可能并不是每次都有 # Time 一条完整的日志：最终将以# User@Host: 开始的行，和以SQL语句结尾的行合并为一条完整的慢日志语句 开始部署filebeat7 准备镜像1docker pull store/elastic/filebeat:7.2.0 filebeat配置文件1234567891011121314151617181920filebeat.inputs:- type: log enabled: true paths: - /opt/slow.log exclude_lines: ['^\\# Time'] multiline.pattern: '^\\# Time|^\\# User' multiline.negate: true multiline.match: after tail_files: trueoutput.elasticsearch: enabled: true hosts: [\"10.0.0.100:9200\"] protocol: \"http\" indices: - index: \"es-index-name\" k8s部署文件12345678910111213141516171819202122232425262728293031323334k8s-filebeat-7.2.0.ymlkind: DeploymentapiVersion: apps/v1beta2metadata: labels: elastic-app: filebeat name: filebeat namespace: ns-elastic7spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: elastic-app: filebeat template: metadata: labels: elastic-app: filebeat spec: containers: - name: filebeat image: store/elastic/filebeat:7.2.0 volumeMounts: - name: filebeat-config mountPath: /usr/share/filebeat/filebeat.yml - name: mysql-dev-252 mountPath: /opt/php-mysql-dev-0-slow.log volumes: - name: filebeat-config hostPath: path: /data/k8s-container/elk-7.2.0/filebeat-7.2.0/filebeat.yml - name: mysql-dev-252 hostPath: path: /data/k8s-container/mysql5.5/slow.log logstash分析mysql日志 省略input的kafka 和ouput的es 12345678910111213141516if [type] == \"showlog1\" or [type] == \"showlog2\" &#123; json &#123; source =&gt; \"message\" &#125; mutate &#123; gsub =&gt; [ \"message\", \"\\n\", \"\" ] &#125; grok &#123; match =&gt; [\"message\",\"(?m)^# User@Host: %&#123;USER:user&#125;\\[[^\\]]+\\] @ \\[%&#123;IP:clientip&#125;\\] Id: %&#123;NUMBER:Id:int&#125;# Query_time: %&#123;NUMBER:query_time:float&#125;\\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;(?&lt;dbnameall&gt;.*)SET\\s+timestamp=%&#123;NUMBER:timestamp_mysql:int&#125;;(?&lt;query&gt;.*)\"] &#125; date &#123; match =&gt; [\"timestamp_mysql\", \"UNIX\"] target =&gt; \"@timestamp\" &#125;&#125;","raw":"---\ntitle: filebeat7收集mysql慢日志到es\ncopyright: true\ndate: 2019-10-30 16:56:37\ntags:\n  - filebeat7\n  - elk7\n  - elk\n  - k8s\ncategories:\n  - [elk7,filebeat7]\n  - [k8s,elk7]\n---\n慢日志提供给开发查看, 采用elk统一提供,这里采用k8s环境搭建\n<!--more-->\n\n\n原文: [ELK收集mysql_slow.log](https://www.cnblogs.com/smail-bao/p/9528072.html)\n其他: [filebeat （7.1.0）docker容器](https://blog.csdn.net/u012491646/article/details/90750571)\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### slowlog内容分析\n\n- 5.5 版本慢查询日志\n```\n# Time: 191030 17:03:13\n# User@Host: myuser[myuser] @  [10.10.0.1]\n# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182\nSET timestamp=1572426193;\nselect * from a where name = 1 limit 1;\n```\n\n- 5.6 版本慢查询日志\n```\n# Time: 191030 17:03:13\n# User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111\n# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182\nuse db_name;\nSET timestamp=1572426193;\nselect * from a where name = 1 limit 1;\n```\n\n- 5.7 版本慢查询日志\n```\n# Time: 2019-10-06T13:25:38.703546+08:00\n# User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111\n# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182\nSET timestamp=1572426193;\nselect * from a where name = 1 limit 1;\n```\n\n\n- 除以上格式以外,还需要注意慢查询代码块,可能并不是每次都有 # Time\n\n\n> 一条完整的日志：最终将以# User@Host: 开始的行，和以SQL语句结尾的行合并为一条完整的慢日志语句\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 开始部署filebeat7 </font>\n</center>\n\n### 准备镜像\n```\ndocker pull store/elastic/filebeat:7.2.0\n```\n\n### filebeat配置文件\n```\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /opt/slow.log\n\n  exclude_lines: ['^\\# Time']\n\n  multiline.pattern: '^\\# Time|^\\# User'\n  multiline.negate: true\n  multiline.match: after\n\n  tail_files: true\n\noutput.elasticsearch:\n  enabled: true\n  hosts: [\"10.0.0.100:9200\"]\n  protocol: \"http\"\n  indices:\n    - index: \"es-index-name\"\n```\n\n### k8s部署文件\n```\nk8s-filebeat-7.2.0.yml\nkind: Deployment\napiVersion: apps/v1beta2\nmetadata:\n  labels:\n    elastic-app: filebeat\n  name: filebeat\n  namespace: ns-elastic7\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      elastic-app: filebeat\n  template:\n    metadata:\n      labels:\n        elastic-app: filebeat\n    spec:\n      containers:\n        - name: filebeat\n          image: store/elastic/filebeat:7.2.0\n          volumeMounts:\n            - name: filebeat-config\n              mountPath: /usr/share/filebeat/filebeat.yml\n            - name: mysql-dev-252\n              mountPath: /opt/php-mysql-dev-0-slow.log\n      volumes:\n        - name: filebeat-config\n          hostPath:\n            path: /data/k8s-container/elk-7.2.0/filebeat-7.2.0/filebeat.yml\n        - name: mysql-dev-252\n          hostPath:\n            path: /data/k8s-container/mysql5.5/slow.log\n```\n\n### logstash分析mysql日志\n> 省略input的kafka 和ouput的es\n\n```\n    if [type] == \"showlog1\" or [type] == \"showlog2\" {\n        json {\n                source => \"message\"\n        }\n\n        mutate {\n                gsub => [ \"message\", \"\\n\", \"\" ]\n        }\n        grok {\n                match => [\"message\",\"(?m)^# User@Host: %{USER:user}\\[[^\\]]+\\] @  \\[%{IP:clientip}\\]  Id: %{NUMBER:Id:int}# Query_time: %{NUMBER:query_time:float}\\s+Lock_time: %{NUMBER:lock_time:float}\\s+Rows_sent: %{NUMBER:rows_sent:int}\\s+Rows_examined: %{NUMBER:rows_examined:int}(?<dbnameall>.*)SET\\s+timestamp=%{NUMBER:timestamp_mysql:int};(?<query>.*)\"]\n        }\n        date {\n                match => [\"timestamp_mysql\", \"UNIX\"]\n                target => \"@timestamp\"\n        }\n    }\n```\n","content":"<p>慢日志提供给开发查看, 采用elk统一提供,这里采用k8s环境搭建</p>\n<a id=\"more\"></a>\n\n\n<p>原文: <a href=\"https://www.cnblogs.com/smail-bao/p/9528072.html\" target=\"_blank\" rel=\"noopener\">ELK收集mysql_slow.log</a><br>其他: <a href=\"https://blog.csdn.net/u012491646/article/details/90750571\" target=\"_blank\" rel=\"noopener\">filebeat （7.1.0）docker容器</a></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"slowlog内容分析\"><a href=\"#slowlog内容分析\" class=\"headerlink\" title=\"slowlog内容分析\"></a>slowlog内容分析</h3><ul>\n<li><p>5.5 版本慢查询日志</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Time: 191030 17:03:13</span></span><br><span class=\"line\"><span class=\"comment\"># User@Host: myuser[myuser] @  [10.10.0.1]</span></span><br><span class=\"line\"><span class=\"comment\"># Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182</span></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"built_in\">timestamp</span>=<span class=\"number\">1572426193</span>;</span><br><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> a <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> = <span class=\"number\">1</span> <span class=\"keyword\">limit</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.6 版本慢查询日志</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Time: 191030 17:03:13</span></span><br><span class=\"line\"><span class=\"comment\"># User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111</span></span><br><span class=\"line\"><span class=\"comment\"># Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182</span></span><br><span class=\"line\"><span class=\"keyword\">use</span> db_name;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"built_in\">timestamp</span>=<span class=\"number\">1572426193</span>;</span><br><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> a <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> = <span class=\"number\">1</span> <span class=\"keyword\">limit</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.7 版本慢查询日志</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Time: 2019-10-06T13:25:38.703546+08:00</span></span><br><span class=\"line\"><span class=\"comment\"># User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111</span></span><br><span class=\"line\"><span class=\"comment\"># Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182</span></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"built_in\">timestamp</span>=<span class=\"number\">1572426193</span>;</span><br><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> a <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> = <span class=\"number\">1</span> <span class=\"keyword\">limit</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>除以上格式以外,还需要注意慢查询代码块,可能并不是每次都有 # Time</p>\n</li>\n</ul>\n<blockquote>\n<p>一条完整的日志：最终将以# User@Host: 开始的行，和以SQL语句结尾的行合并为一条完整的慢日志语句</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 开始部署filebeat7 </font>\n</center>\n\n<h3 id=\"准备镜像\"><a href=\"#准备镜像\" class=\"headerlink\" title=\"准备镜像\"></a>准备镜像</h3><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull store<span class=\"regexp\">/elastic/</span><span class=\"string\">filebeat:</span><span class=\"number\">7.2</span><span class=\"number\">.0</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"filebeat配置文件\"><a href=\"#filebeat配置文件\" class=\"headerlink\" title=\"filebeat配置文件\"></a>filebeat配置文件</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filebeat.<span class=\"built_in\">input</span><span class=\"variable\">s:</span></span><br><span class=\"line\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span></span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  path<span class=\"variable\">s:</span></span><br><span class=\"line\">    - /<span class=\"keyword\">opt</span>/slow.<span class=\"built_in\">log</span></span><br><span class=\"line\"></span><br><span class=\"line\">  exclude_line<span class=\"variable\">s:</span> [<span class=\"string\">'^\\# Time'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  multiline.pattern: <span class=\"string\">'^\\# Time|^\\# User'</span></span><br><span class=\"line\">  multiline.negate: true</span><br><span class=\"line\">  multiline.<span class=\"keyword\">match</span>: after</span><br><span class=\"line\"></span><br><span class=\"line\">  tail_file<span class=\"variable\">s:</span> true</span><br><span class=\"line\"></span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  host<span class=\"variable\">s:</span> [<span class=\"string\">\"10.0.0.100:9200\"</span>]</span><br><span class=\"line\">  protoco<span class=\"variable\">l:</span> <span class=\"string\">\"http\"</span></span><br><span class=\"line\">  indice<span class=\"variable\">s:</span></span><br><span class=\"line\">    - <span class=\"built_in\">index</span>: <span class=\"string\">\"es-index-name\"</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"k8s部署文件\"><a href=\"#k8s部署文件\" class=\"headerlink\" title=\"k8s部署文件\"></a>k8s部署文件</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">k8s-filebeat-7.2.0.yml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta2</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">filebeat</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">filebeat</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      elastic-app:</span> <span class=\"string\">filebeat</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        elastic-app:</span> <span class=\"string\">filebeat</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">filebeat</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">store/elastic/filebeat:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">filebeat-config</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/usr/share/filebeat/filebeat.yml</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">mysql-dev-252</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/opt/php-mysql-dev-0-slow.log</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">filebeat-config</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/elk-7.2.0/filebeat-7.2.0/filebeat.yml</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">mysql-dev-252</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/mysql5.5/slow.log</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"logstash分析mysql日志\"><a href=\"#logstash分析mysql日志\" class=\"headerlink\" title=\"logstash分析mysql日志\"></a>logstash分析mysql日志</h3><blockquote>\n<p>省略input的kafka 和ouput的es</p>\n</blockquote>\n<figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [type] == <span class=\"string\">\"showlog1\"</span> or [type] == <span class=\"string\">\"showlog2\"</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">json</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">source</span> =&gt; <span class=\"string\">\"message\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">mutate</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">gsub</span> =&gt; [ <span class=\"string\">\"message\"</span>, <span class=\"string\">\"\\n\"</span>, <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">grok</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">match</span> =&gt; [<span class=\"string\">\"message\"</span>,<span class=\"string\">\"(?m)^# User@Host: %&#123;USER:user&#125;\\[[^\\]]+\\] @  \\[%&#123;IP:clientip&#125;\\]  Id: %&#123;NUMBER:Id:int&#125;# Query_time: %&#123;NUMBER:query_time:float&#125;\\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;(?&lt;dbnameall&gt;.*)SET\\s+timestamp=%&#123;NUMBER:timestamp_mysql:int&#125;;(?&lt;query&gt;.*)\"</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">date</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">match</span> =&gt; [<span class=\"string\">\"timestamp_mysql\"</span>, <span class=\"string\">\"UNIX\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">target</span> =&gt; <span class=\"string\">\"@timestamp\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/30/24-filebeat7收集mysql慢日志到es/","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/categories/elk7/"},{"name":"filebeat7","slug":"elk7/filebeat7","permalink":"https://blog.k1s.club/categories/elk7/filebeat7/"},{"name":"elk7","slug":"k8s/elk7","permalink":"https://blog.k1s.club/categories/k8s/elk7/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"filebeat7","slug":"filebeat7","permalink":"https://blog.k1s.club/tags/filebeat7/"},{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/tags/elk7/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/tags/elk/"}]},{"title":"mysql5.5主与mysql5.7从部署配置","date":"2019-10-29T06:56:55.000Z","path":"2019/10/29/23-mysql5-5主与mysql5-7从部署配置/","text":"由于需要将旧版mysql5.5的数据同步到新mysql5.7, 并且会对部分表分库 参考教程: mysql从5.5直接升级到5.7 mysql5.5升级到mysql5.7 采用mysql5.5数据目录升级为mysql5.712345678910111 从mysql5.5的从库 copy /data数据2 修改新的mysql5.7配置文件 my.cnf，添加datadir，指向5.5数据目录3 新安装数据库执行(本次不需要执行) /usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/disk/u014 启动mysql5 此时数据目录还是5.5的，需要执行mysql_upgrade进行升级，在执行表修复前，需要确认一个参数innodb_file_per_table，mysql官网对该参数的解释如下 该参数在5.5版本默认为OFF，所有表和索引都导入一个共享文件中，名为ibdata1,但在5.6.7及以后版本，改参数被默认设置为ON，即每张表都有对应的表和索引存储文件，每个schema下，每个frm文件都有对应的ibd文件。 在执行mysql_upgrade时，会修复系统表，并且如果该参数在5.5和5.7版本均使用默认值，则会将之前共享表和索引的存储方式改为每张表单独存储表和索引的形式，故会出现拷贝复制的操作，如果数据量比较大，则用时就会很长， 使用nnodb_file_per_table=1，及表和索引单独存储的优缺点，可查看mysql官网介绍。6 使用mysql_upgrade检测并修复表 /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock 以上已经完成对mysql5.5数据升级 在mysql5.7运行的功能 配置mysql5.5主与mysql5.7从 将msyql5.7作为mysql5.5的从库123456# 从库执行, POS位置以 show master status\\G 查询为准stop slave;SET GLOBAL read_only=0;reset slave all;CHANGE MASTER TO MASTER_HOST='db_master.prod.zhangzw.com',MASTER_PORT=3306,MASTER_USER='xxx',MASTER_PASSWORD='xxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=107;start slave; 在主库测试创建表, 查看是否会同步到mysql5.7从库1234567create table tutorials_tbl( tutorial_id INT NOT NULL AUTO_INCREMENT, tutorial_title VARCHAR(100) NOT NULL, tutorial_author VARCHAR(40) NOT NULL, submission_date DATE, PRIMARY KEY ( tutorial_id )); 修改mysql5.7库名 修改库名 没问题之后,我们需要将mysql5.7的mydatabase库改成mydatabasenew库名, 断开mysql5.5 和mysql5.7主从同步(最好设置mysql5.5只读,防止数据差异), 在mysql5.7上执行改库名, 以下有触发器的表会修改失败 测试执行时间在15s左右 123456789101112#!/bin/bash# 假设将sakila数据库名改为new_sakila# MyISAM直接更改数据库目录下的文件即可new_database=mydatabasenewold_database=mydatabasemysql -S /disk/u01/mysql.sock -e 'create database if not exists $&#123;new_database&#125;'list_table=$(mysql -S /disk/u01/mysql.sock -Nse \"select table_name from information_schema.TABLES where TABLE_SCHEMA='$&#123;old_database&#125;'\")for table in $list_tabledo mysql -S /disk/u01/mysql.sock -e \"rename table $&#123;old_database&#125;.$table to $&#123;new_database&#125;.$table\"done 此时在配置新的mysql5.7的主从机器 一些配置问题 GTID_MODE 配置不统一1234567891011The replication receiver thread cannot start because the master has GTID_MODE = OFF and this server has GTID_MODE = ON.# 永久修改gtid_mode = off# 一次性关闭步骤：stop slave;SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';SET GLOBAL GTID_MODE = 'OFF';start slave; mysql5.7 sql_mode1sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' 注意一台机器多个mysql启动脚本修改问题123#以下两处修改 /etc/init.d/mysqld57 parse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=\"$mysqld_pid_file_path\" $other_args &gt;/dev/null &amp; 一些info信息 /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock 的部分记录1234567891011121314151617181920212223242526272829303132# /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sockChecking if update is needed.Checking server version.Running queries to upgrade MySQL server.mysql_upgrade: (non fatal) [WARNING] 1642: Pre-4.1 password hash found. It is deprecated and will be removed in a future release. Please upgrade it to a new format.Checking system database.mysql.columns_priv OKmysql.db OKmysql.engine_cost OKmysql.event OKmysql.func OKmysql.general_log OKmysql.gtid_executed OKmysql.help_category OKmysql.help_keyword OKmysql.help_relation OKmysql.help_topic OKmysql.host OKmysql.innodb_index_stats OKmysql.innodb_table_stats OKmysql.ndb_binlog_index OKmysql.plugin OKmysql.proc OKmysql.procs_priv OKmysql.proxies_priv OKmysql.server_cost OKmysql.servers OKmysql.slave_master_info OKmysql.slave_relay_log_info OKmysql.slave_worker_info OKmysql.slow_log OK... 附录 my57.cnf123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183[client]port = 3308socket = /disk/u01/mysql.sock[mysql]prompt=\"\\u@m1_618_u [\\d]&gt; \"no-auto-rehash[mysqld]sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'replicate-wild-do-table=mydatabase.%binlog-ignore-db=information_schemabinlog-ignore-db=mysqlbinlog-ignore-db=performance_schemabinlog-ignore-db=testbinlog-do-db=mydatabaseuser = mysqlport = 3308basedir = /usr/local/mysql57datadir = /disk/u01socket = /disk/u01/mysql.sockpid-file = /disk/u01/dbm1_u.pidtmpdir = /disk/u02server-id = 123character-set-server = utf8skip_name_resolve = 1innodb_file_per_table = 1explicit_defaults_for_timestamp = 0read_only = 1# buffer&amp;cachetable_open_cache = 100table_definition_cache = 400table_open_cache_instances = 64sort_buffer_size = 4Mjoin_buffer_size = 4Mread_buffer_size = 8Mread_rnd_buffer_size = 4M# thread&amp;connectionthread_stack = 256Kthread_cache_size = 768back_log = 1024max_connections = 3000max_connect_errors = 1000000# temptabletmp_table_size = 32Mmax_heap_table_size = 32M# networkmax_allowed_packet = 32M#lock_wait_timeout = 3600#interactive_timeout = 600#wait_timeout = 600# query cachequery_cache_size = 0query_cache_type = 0# 设置errorlog、slowlog和generallog的时区，默认UTClog_timestamps = SYSTEM# error-loglog_error = /disk/u02/mysqld.log# slow-logslow_query_log = 1slow_query_log_file = /disk/u02/slow.loglong_query_time = 0.1log_queries_not_using_indexes =1log_throttle_queries_not_using_indexes = 60min_examined_row_limit = 100log_slow_admin_statements = 1log_slow_slave_statements = 1# general log#general-log = 1general_log_file=/disk/u02/query.log# binlogbinlog_format = rowbinlog_checksum = 1log-bin = /disk/u02/m1-binlog-bin-index = /disk/u02/m1-bin.indexsync_binlog = 0binlog_cache_size = 4Mmax_binlog_cache_size = 1Gmax_binlog_size = 512Mexpire_logs_days = 15# GTIDgtid_mode = offenforce_gtid_consistency = 1log_slave_updates# Replicationmaster_info_repository = TABLErelay_log_info_repository = TABLEslave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'relay_log_recovery = 1relay_log_purge = 1relay-log=/disk/u02/m1-relay-binrelay-log-index=/disk/u02/m1-relay-bin.index# innodb-buffer&amp;cacheinnodb_buffer_pool_size = 1Ginnodb_buffer_pool_instances = 4#innodb_additional_mem_pool_size = 16Minnodb_max_dirty_pages_pct = 50# innodb loginnodb_data_file_path = ibdata1:256M:autoextendinnodb_log_file_size = 256Minnodb_log_files_in_group = 2innodb_flush_log_at_trx_commit = 2innodb_log_buffer_size = 32M#innodb_max_undo_log_size = 4G#innodb_undo_directory = undologinnodb_undo_tablespaces = 0# innodb-ioinnodb_flush_method = O_DIRECTinnodb_io_capacity = 600innodb_io_capacity_max = 2000innodb_flush_sync = 0innodb_flush_neighbors = 0#innodb_lru_scan_depth = 4000innodb_write_io_threads = 8innodb_read_io_threads = 8innodb_purge_threads = 4innodb_page_cleaners = 4# transaction,lock#innodb_sync_spin_loops = 100#innodb_spin_wait_delay = 30innodb_lock_wait_timeout = 10innodb_print_all_deadlocks = 1innodb_rollback_on_timeout = 1innodb_open_files = 65535innodb_online_alter_log_max_size = 1G# innodb statusinnodb_status_file = 1# 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快innodb_status_output = 0innodb_status_output_locks = 0#performance_schemaperformance_schema = 1performance_schema_instrument = '%=on'#innodb monitorinnodb_monitor_enable=\"module_innodb\"innodb_monitor_enable=\"module_server\"innodb_monitor_enable=\"module_dml\"innodb_monitor_enable=\"module_ddl\"innodb_monitor_enable=\"module_trx\"innodb_monitor_enable=\"module_os\"innodb_monitor_enable=\"module_purge\"innodb_monitor_enable=\"module_log\"innodb_monitor_enable=\"module_lock\"innodb_monitor_enable=\"module_buffer\"innodb_monitor_enable=\"module_index\"innodb_monitor_enable=\"module_ibuf_system\"innodb_monitor_enable=\"module_buffer_page\"innodb_monitor_enable=\"module_adaptive_hash\"# MyISAMkey_buffer_size = 1024Mbulk_insert_buffer_size = 64Mmyisam_sort_buffer_size = 128Mmyisam_repair_threads = 1[mysqldump]quickmax_allowed_packet = 32M","raw":"---\ntitle: mysql5.5主与mysql5.7从部署配置\ncopyright: true\ndate: 2019-10-29 14:56:55\ntags:\n  - mysql\n  - mysql5.7\ncategories:\n  - [技术文档]\n  - [mysql,主从]\n---\n由于需要将旧版mysql5.5的数据同步到新mysql5.7, 并且会对部分表分库\n<!-- more -->\n\n\n\n参考教程: [mysql从5.5直接升级到5.7](https://www.cnblogs.com/qq931399960/p/10243758.html)\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> mysql5.5升级到mysql5.7 </font>\n</center>\n\n\n### 采用mysql5.5数据目录升级为mysql5.7\n```\n1 从mysql5.5的从库 copy /data数据\n2 修改新的mysql5.7配置文件 my.cnf，添加datadir，指向5.5数据目录\n3 新安装数据库执行(本次不需要执行)\n  /usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/disk/u01\n4 启动mysql\n5 此时数据目录还是5.5的，需要执行mysql_upgrade进行升级，在执行表修复前，需要确认一个参数innodb_file_per_table，mysql官网对该参数的解释如下\n 该参数在5.5版本默认为OFF，所有表和索引都导入一个共享文件中，名为ibdata1,但在5.6.7及以后版本，改参数被默认设置为ON，即每张表都有对应的表和索引存储文件，每个schema下，每个frm文件都有对应的ibd文件。\n 在执行mysql_upgrade时，会修复系统表，并且如果该参数在5.5和5.7版本均使用默认值，则会将之前共享表和索引的存储方式改为每张表单独存储表和索引的形式，故会出现拷贝复制的操作，如果数据量比较大，则用时就会很长，\n 使用nnodb_file_per_table=1，及表和索引单独存储的优缺点，可查看mysql官网介绍。\n6 使用mysql_upgrade检测并修复表\n /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock\n```\n\n> 以上已经完成对mysql5.5数据升级 在mysql5.7运行的功能\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 配置mysql5.5主与mysql5.7从 </font>\n</center>\n\n\n### 将msyql5.7作为mysql5.5的从库\n```\n # 从库执行, POS位置以 show master status\\G 查询为准\n stop slave;\n SET GLOBAL read_only=0;\n reset slave all;\n CHANGE MASTER TO MASTER_HOST='db_master.prod.zhangzw.com',MASTER_PORT=3306,MASTER_USER='xxx',MASTER_PASSWORD='xxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=107;\n start slave;\n```\n\n### 在主库测试创建表, 查看是否会同步到mysql5.7从库\n```\ncreate table tutorials_tbl(\n   tutorial_id INT NOT NULL AUTO_INCREMENT,\n   tutorial_title VARCHAR(100) NOT NULL,\n   tutorial_author VARCHAR(40) NOT NULL,\n   submission_date DATE,\n   PRIMARY KEY ( tutorial_id )\n);\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 修改mysql5.7库名 </font>\n</center>\n\n### 修改库名\n\n> 没问题之后,我们需要将mysql5.7的mydatabase库改成mydatabasenew库名, 断开mysql5.5 和mysql5.7主从同步(最好设置mysql5.5只读,防止数据差异), 在mysql5.7上执行改库名, 以下有触发器的表会修改失败\n\n> 测试执行时间在15s左右\n\n```\n#!/bin/bash\n# 假设将sakila数据库名改为new_sakila\n# MyISAM直接更改数据库目录下的文件即可\nnew_database=mydatabasenew\nold_database=mydatabase\n\nmysql -S /disk/u01/mysql.sock -e 'create database if not exists ${new_database}'\nlist_table=$(mysql -S /disk/u01/mysql.sock -Nse  \"select table_name from information_schema.TABLES where TABLE_SCHEMA='${old_database}'\")\nfor table in $list_table\ndo\n    mysql -S /disk/u01/mysql.sock -e \"rename table ${old_database}.$table to ${new_database}.$table\"\ndone\n```\n\n\n### 此时在配置新的mysql5.7的主从机器\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 一些配置问题 </font>\n</center>\n\n\n\n\n---\n\n### GTID_MODE 配置不统一\n\n```\nThe replication receiver thread cannot start because the master has GTID_MODE = OFF and this server has GTID_MODE = ON.\n\n# 永久修改\ngtid_mode = off\n\n# 一次性关闭步骤：\nstop slave;\nSET GLOBAL GTID_MODE = 'ON_PERMISSIVE';\nSET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';\nSET GLOBAL GTID_MODE = 'OFF';\nstart slave;\n```\n\n### mysql5.7 sql_mode\n```\nsql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\n\n```\n\n---\n\n### 注意一台机器多个mysql启动脚本修改问题\n```\n#以下两处修改 /etc/init.d/mysqld57 \nparse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`\n$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=\"$mysqld_pid_file_path\" $other_args >/dev/null &\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 一些info信息 </font>\n</center>\n\n### /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock 的部分记录\n\n```\n# /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock\nChecking if update is needed.\nChecking server version.\nRunning queries to upgrade MySQL server.\nmysql_upgrade: (non fatal) [WARNING] 1642: Pre-4.1 password hash found. It is deprecated and will be removed in a future release. Please upgrade it to a new format.\nChecking system database.\nmysql.columns_priv                                 OK\nmysql.db                                           OK\nmysql.engine_cost                                  OK\nmysql.event                                        OK\nmysql.func                                         OK\nmysql.general_log                                  OK\nmysql.gtid_executed                                OK\nmysql.help_category                                OK\nmysql.help_keyword                                 OK\nmysql.help_relation                                OK\nmysql.help_topic                                   OK\nmysql.host                                         OK\nmysql.innodb_index_stats                           OK\nmysql.innodb_table_stats                           OK\nmysql.ndb_binlog_index                             OK\nmysql.plugin                                       OK\nmysql.proc                                         OK\nmysql.procs_priv                                   OK\nmysql.proxies_priv                                 OK\nmysql.server_cost                                  OK\nmysql.servers                                      OK\nmysql.slave_master_info                            OK\nmysql.slave_relay_log_info                         OK\nmysql.slave_worker_info                            OK\nmysql.slow_log                                     OK\n...\n\n```\n\n### 附录 my57.cnf\n```\n[client]\nport = 3308\nsocket = /disk/u01/mysql.sock\n\n[mysql]\nprompt=\"\\u@m1_618_u [\\d]> \"\nno-auto-rehash\n\n[mysqld]\nsql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\nreplicate-wild-do-table=mydatabase.%\n\nbinlog-ignore-db=information_schema\nbinlog-ignore-db=mysql\nbinlog-ignore-db=performance_schema\nbinlog-ignore-db=test\n\nbinlog-do-db=mydatabase\n\nuser = mysql\nport = 3308\nbasedir = /usr/local/mysql57\ndatadir = /disk/u01\nsocket = /disk/u01/mysql.sock\npid-file = /disk/u01/dbm1_u.pid\ntmpdir = /disk/u02\nserver-id = 123\ncharacter-set-server = utf8\nskip_name_resolve = 1\ninnodb_file_per_table = 1\nexplicit_defaults_for_timestamp = 0\nread_only = 1\n\n# buffer&cache\ntable_open_cache = 100\ntable_definition_cache = 400\ntable_open_cache_instances = 64\nsort_buffer_size = 4M\njoin_buffer_size = 4M\nread_buffer_size = 8M\nread_rnd_buffer_size = 4M\n\n# thread&connection\nthread_stack = 256K\nthread_cache_size = 768\nback_log = 1024\nmax_connections = 3000\nmax_connect_errors = 1000000\n\n# temptable\ntmp_table_size = 32M\nmax_heap_table_size = 32M\n\n# network\nmax_allowed_packet = 32M\n#lock_wait_timeout = 3600\n#interactive_timeout = 600\n#wait_timeout = 600\n\n# query cache\nquery_cache_size = 0\nquery_cache_type = 0\n\n# 设置errorlog、slowlog和generallog的时区，默认UTC\nlog_timestamps = SYSTEM\n\n# error-log\nlog_error = /disk/u02/mysqld.log\n\n# slow-log\nslow_query_log = 1\nslow_query_log_file = /disk/u02/slow.log\nlong_query_time = 0.1\nlog_queries_not_using_indexes =1\nlog_throttle_queries_not_using_indexes = 60\nmin_examined_row_limit = 100\nlog_slow_admin_statements = 1\nlog_slow_slave_statements = 1\n\n# general log\n#general-log = 1\ngeneral_log_file=/disk/u02/query.log\n\n# binlog\nbinlog_format = row\nbinlog_checksum = 1\nlog-bin = /disk/u02/m1-bin\nlog-bin-index = /disk/u02/m1-bin.index\nsync_binlog = 0\nbinlog_cache_size = 4M\nmax_binlog_cache_size = 1G\nmax_binlog_size = 512M\nexpire_logs_days = 15\n\n# GTID\ngtid_mode = off\nenforce_gtid_consistency = 1\nlog_slave_updates\n\n# Replication\nmaster_info_repository = TABLE\nrelay_log_info_repository = TABLE\nslave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'\nrelay_log_recovery = 1\nrelay_log_purge = 1\nrelay-log=/disk/u02/m1-relay-bin\nrelay-log-index=/disk/u02/m1-relay-bin.index\n\n# innodb-buffer&cache\ninnodb_buffer_pool_size = 1G\ninnodb_buffer_pool_instances = 4\n#innodb_additional_mem_pool_size = 16M\ninnodb_max_dirty_pages_pct = 50\n\n# innodb log\ninnodb_data_file_path = ibdata1:256M:autoextend\ninnodb_log_file_size = 256M\ninnodb_log_files_in_group = 2\ninnodb_flush_log_at_trx_commit = 2\ninnodb_log_buffer_size = 32M\n#innodb_max_undo_log_size = 4G\n#innodb_undo_directory = undolog\ninnodb_undo_tablespaces = 0\n\n# innodb-io\ninnodb_flush_method = O_DIRECT\ninnodb_io_capacity = 600\ninnodb_io_capacity_max = 2000\ninnodb_flush_sync = 0\ninnodb_flush_neighbors = 0\n#innodb_lru_scan_depth = 4000\ninnodb_write_io_threads = 8\ninnodb_read_io_threads = 8\ninnodb_purge_threads = 4\ninnodb_page_cleaners = 4\n\n# transaction,lock\n#innodb_sync_spin_loops = 100\n#innodb_spin_wait_delay = 30\ninnodb_lock_wait_timeout = 10\ninnodb_print_all_deadlocks = 1\ninnodb_rollback_on_timeout = 1\n\ninnodb_open_files = 65535\n\ninnodb_online_alter_log_max_size = 1G\n\n# innodb status\ninnodb_status_file = 1\n# 注意: 开启 innodb_status_output & innodb_status_output_locks 后, 可能会导致log-error文件增长较快\ninnodb_status_output = 0\ninnodb_status_output_locks = 0\n\n#performance_schema\nperformance_schema = 1\nperformance_schema_instrument = '%=on'\n\n#innodb monitor\ninnodb_monitor_enable=\"module_innodb\"\ninnodb_monitor_enable=\"module_server\"\ninnodb_monitor_enable=\"module_dml\"\ninnodb_monitor_enable=\"module_ddl\"\ninnodb_monitor_enable=\"module_trx\"\ninnodb_monitor_enable=\"module_os\"\ninnodb_monitor_enable=\"module_purge\"\ninnodb_monitor_enable=\"module_log\"\ninnodb_monitor_enable=\"module_lock\"\ninnodb_monitor_enable=\"module_buffer\"\ninnodb_monitor_enable=\"module_index\"\ninnodb_monitor_enable=\"module_ibuf_system\"\ninnodb_monitor_enable=\"module_buffer_page\"\ninnodb_monitor_enable=\"module_adaptive_hash\"\n\n# MyISAM\nkey_buffer_size = 1024M\nbulk_insert_buffer_size = 64M\nmyisam_sort_buffer_size = 128M\nmyisam_repair_threads = 1\n\n\n[mysqldump]\nquick\nmax_allowed_packet = 32M\n```\n","content":"<p>由于需要将旧版mysql5.5的数据同步到新mysql5.7, 并且会对部分表分库</p>\n<a id=\"more\"></a>\n\n\n\n<p>参考教程: <a href=\"https://www.cnblogs.com/qq931399960/p/10243758.html\" target=\"_blank\" rel=\"noopener\">mysql从5.5直接升级到5.7</a></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> mysql5.5升级到mysql5.7 </font>\n</center>\n\n\n<h3 id=\"采用mysql5-5数据目录升级为mysql5-7\"><a href=\"#采用mysql5-5数据目录升级为mysql5-7\" class=\"headerlink\" title=\"采用mysql5.5数据目录升级为mysql5.7\"></a>采用mysql5.5数据目录升级为mysql5.7</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span> 从mysql5<span class=\"number\">.5</span>的从库 copy /data数据</span><br><span class=\"line\"><span class=\"number\">2</span> 修改新的mysql5<span class=\"number\">.7</span>配置文件 my.cnf，添加datadir，指向<span class=\"number\">5.5</span>数据目录</span><br><span class=\"line\"><span class=\"number\">3</span> 新安装数据库执行(本次不需要执行)</span><br><span class=\"line\">  /usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/disk/u01</span><br><span class=\"line\"><span class=\"number\">4</span> 启动mysql</span><br><span class=\"line\"><span class=\"number\">5</span> 此时数据目录还是<span class=\"number\">5.5</span>的，需要执行mysql_upgrade进行升级，在执行表修复前，需要确认一个参数innodb_file_per_table，mysql官网对该参数的解释如下</span><br><span class=\"line\"> 该参数在<span class=\"number\">5.5</span>版本默认为OFF，所有表和索引都导入一个共享文件中，名为ibdata1,但在<span class=\"number\">5.6</span><span class=\"number\">.7</span>及以后版本，改参数被默认设置为ON，即每张表都有对应的表和索引存储文件，每个schema下，每个frm文件都有对应的ibd文件。</span><br><span class=\"line\"> 在执行mysql_upgrade时，会修复系统表，并且如果该参数在<span class=\"number\">5.5</span>和<span class=\"number\">5.7</span>版本均使用默认值，则会将之前共享表和索引的存储方式改为每张表单独存储表和索引的形式，故会出现拷贝复制的操作，如果数据量比较大，则用时就会很长，</span><br><span class=\"line\"> 使用nnodb_file_per_table=<span class=\"number\">1</span>，及表和索引单独存储的优缺点，可查看mysql官网介绍。</span><br><span class=\"line\"><span class=\"number\">6</span> 使用mysql_upgrade检测并修复表</span><br><span class=\"line\"> /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上已经完成对mysql5.5数据升级 在mysql5.7运行的功能</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 配置mysql5.5主与mysql5.7从 </font>\n</center>\n\n\n<h3 id=\"将msyql5-7作为mysql5-5的从库\"><a href=\"#将msyql5-7作为mysql5-5的从库\" class=\"headerlink\" title=\"将msyql5.7作为mysql5.5的从库\"></a>将msyql5.7作为mysql5.5的从库</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 从库执行, POS位置以 show master status\\G 查询为准</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span> <span class=\"keyword\">slave</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> read_only=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">reset</span> <span class=\"keyword\">slave</span> <span class=\"keyword\">all</span>;</span><br><span class=\"line\"><span class=\"keyword\">CHANGE</span> <span class=\"keyword\">MASTER</span> <span class=\"keyword\">TO</span> MASTER_HOST=<span class=\"string\">'db_master.prod.zhangzw.com'</span>,MASTER_PORT=<span class=\"number\">3306</span>,MASTER_USER=<span class=\"string\">'xxx'</span>,MASTER_PASSWORD=<span class=\"string\">'xxx'</span>,MASTER_LOG_FILE=<span class=\"string\">'m1-master-bin.000001'</span>,MASTER_LOG_POS=<span class=\"number\">107</span>;</span><br><span class=\"line\"><span class=\"keyword\">start</span> <span class=\"keyword\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"在主库测试创建表-查看是否会同步到mysql5-7从库\"><a href=\"#在主库测试创建表-查看是否会同步到mysql5-7从库\" class=\"headerlink\" title=\"在主库测试创建表, 查看是否会同步到mysql5.7从库\"></a>在主库测试创建表, 查看是否会同步到mysql5.7从库</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> tutorials_tbl(</span><br><span class=\"line\">   tutorial_id <span class=\"built_in\">INT</span> <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span> AUTO_INCREMENT,</span><br><span class=\"line\">   tutorial_title <span class=\"built_in\">VARCHAR</span>(<span class=\"number\">100</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span>,</span><br><span class=\"line\">   tutorial_author <span class=\"built_in\">VARCHAR</span>(<span class=\"number\">40</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span>,</span><br><span class=\"line\">   submission_date <span class=\"built_in\">DATE</span>,</span><br><span class=\"line\">   PRIMARY <span class=\"keyword\">KEY</span> ( tutorial_id )</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 修改mysql5.7库名 </font>\n</center>\n\n<h3 id=\"修改库名\"><a href=\"#修改库名\" class=\"headerlink\" title=\"修改库名\"></a>修改库名</h3><blockquote>\n<p>没问题之后,我们需要将mysql5.7的mydatabase库改成mydatabasenew库名, 断开mysql5.5 和mysql5.7主从同步(最好设置mysql5.5只读,防止数据差异), 在mysql5.7上执行改库名, 以下有触发器的表会修改失败</p>\n</blockquote>\n<blockquote>\n<p>测试执行时间在15s左右</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># 假设将sakila数据库名改为new_sakila</span></span><br><span class=\"line\"><span class=\"comment\"># MyISAM直接更改数据库目录下的文件即可</span></span><br><span class=\"line\">new_database=mydatabasenew</span><br><span class=\"line\">old_database=mydatabase</span><br><span class=\"line\"></span><br><span class=\"line\">mysql -S /disk/u01/mysql.sock -e <span class=\"string\">'create database if not exists $&#123;new_database&#125;'</span></span><br><span class=\"line\">list_table=$(mysql -S /disk/u01/mysql.sock -Nse  <span class=\"string\">\"select table_name from information_schema.TABLES where TABLE_SCHEMA='<span class=\"variable\">$&#123;old_database&#125;</span>'\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> table <span class=\"keyword\">in</span> <span class=\"variable\">$list_table</span></span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">    mysql -S /disk/u01/mysql.sock -e <span class=\"string\">\"rename table <span class=\"variable\">$&#123;old_database&#125;</span>.<span class=\"variable\">$table</span> to <span class=\"variable\">$&#123;new_database&#125;</span>.<span class=\"variable\">$table</span>\"</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"此时在配置新的mysql5-7的主从机器\"><a href=\"#此时在配置新的mysql5-7的主从机器\" class=\"headerlink\" title=\"此时在配置新的mysql5.7的主从机器\"></a>此时在配置新的mysql5.7的主从机器</h3><center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 一些配置问题 </font>\n</center>\n\n\n\n\n<hr>\n<h3 id=\"GTID-MODE-配置不统一\"><a href=\"#GTID-MODE-配置不统一\" class=\"headerlink\" title=\"GTID_MODE 配置不统一\"></a>GTID_MODE 配置不统一</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The replication receiver thread cannot <span class=\"keyword\">start</span> because the <span class=\"keyword\">master</span> has GTID_MODE = <span class=\"keyword\">OFF</span> <span class=\"keyword\">and</span> this <span class=\"keyword\">server</span> has GTID_MODE = ON.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 永久修改</span></span><br><span class=\"line\">gtid_mode = <span class=\"keyword\">off</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一次性关闭步骤：</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span> <span class=\"keyword\">slave</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> GTID_MODE = <span class=\"string\">'ON_PERMISSIVE'</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> GTID_MODE = <span class=\"string\">'OFF_PERMISSIVE'</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> GTID_MODE = <span class=\"string\">'OFF'</span>;</span><br><span class=\"line\"><span class=\"keyword\">start</span> <span class=\"keyword\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"mysql5-7-sql-mode\"><a href=\"#mysql5-7-sql-mode\" class=\"headerlink\" title=\"mysql5.7 sql_mode\"></a>mysql5.7 sql_mode</h3><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">sql_mode</span>=<span class=\"string\">'ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"注意一台机器多个mysql启动脚本修改问题\"><a href=\"#注意一台机器多个mysql启动脚本修改问题\" class=\"headerlink\" title=\"注意一台机器多个mysql启动脚本修改问题\"></a>注意一台机器多个mysql启动脚本修改问题</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#以下两处修改 /etc/init.d/mysqld57 </span></span><br><span class=\"line\">parse_server_arguments `<span class=\"variable\">$print_defaults</span> -c /etc/my57.cnf mysqld<span class=\"built_in\"> server </span>mysql_server mysql.server`</span><br><span class=\"line\"><span class=\"variable\">$bindir</span>/mysqld_safe <span class=\"attribute\">--defaults-file</span>=/etc/my57.cnf <span class=\"attribute\">--pid-file</span>=<span class=\"string\">\"<span class=\"variable\">$mysqld_pid_file_path</span>\"</span> <span class=\"variable\">$other_args</span> &gt;/dev/<span class=\"literal\">null</span> &amp;</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 一些info信息 </font>\n</center>\n\n<h3 id=\"usr-local-mysql57-bin-mysql-upgrade-S-disk-u01-mysql-sock-的部分记录\"><a href=\"#usr-local-mysql57-bin-mysql-upgrade-S-disk-u01-mysql-sock-的部分记录\" class=\"headerlink\" title=\"/usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock 的部分记录\"></a>/usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock 的部分记录</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock</span></span><br><span class=\"line\">Checking <span class=\"keyword\">if</span> update is needed.</span><br><span class=\"line\">Checking<span class=\"built_in\"> server </span>version.</span><br><span class=\"line\">Running queries <span class=\"keyword\">to</span><span class=\"built_in\"> upgrade </span>MySQL server.</span><br><span class=\"line\">mysql_upgrade: (non fatal) [<span class=\"builtin-name\">WARNING</span>] 1642: Pre-4.1 password hash found. It is deprecated <span class=\"keyword\">and</span> will be removed <span class=\"keyword\">in</span> a future release. Please<span class=\"built_in\"> upgrade </span>it <span class=\"keyword\">to</span> a new format.</span><br><span class=\"line\">Checking<span class=\"built_in\"> system </span>database.</span><br><span class=\"line\">mysql.columns_priv                                 OK</span><br><span class=\"line\">mysql.db                                           OK</span><br><span class=\"line\">mysql.engine_cost                                  OK</span><br><span class=\"line\">mysql.event                                        OK</span><br><span class=\"line\">mysql.func                                         OK</span><br><span class=\"line\">mysql.general_log                                  OK</span><br><span class=\"line\">mysql.gtid_executed                                OK</span><br><span class=\"line\">mysql.help_category                                OK</span><br><span class=\"line\">mysql.help_keyword                                 OK</span><br><span class=\"line\">mysql.help_relation                                OK</span><br><span class=\"line\">mysql.help_topic                                   OK</span><br><span class=\"line\">mysql.host                                         OK</span><br><span class=\"line\">mysql.innodb_index_stats                           OK</span><br><span class=\"line\">mysql.innodb_table_stats                           OK</span><br><span class=\"line\">mysql.ndb_binlog_index                             OK</span><br><span class=\"line\">mysql.plugin                                       OK</span><br><span class=\"line\">mysql.proc                                         OK</span><br><span class=\"line\">mysql.procs_priv                                   OK</span><br><span class=\"line\">mysql.proxies_priv                                 OK</span><br><span class=\"line\">mysql.server_cost                                  OK</span><br><span class=\"line\">mysql.servers                                      OK</span><br><span class=\"line\">mysql.slave_master_info                            OK</span><br><span class=\"line\">mysql.slave_relay_log_info                         OK</span><br><span class=\"line\">mysql.slave_worker_info                            OK</span><br><span class=\"line\">mysql.slow_log                                     OK</span><br><span class=\"line\"><span class=\"built_in\">..</span>.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"附录-my57-cnf\"><a href=\"#附录-my57-cnf\" class=\"headerlink\" title=\"附录 my57.cnf\"></a>附录 my57.cnf</h3><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[client]</span><br><span class=\"line\">port = 3308</span><br><span class=\"line\">socket = /disk/u01/mysql.sock</span><br><span class=\"line\"></span><br><span class=\"line\">[mysql]</span><br><span class=\"line\">prompt=<span class=\"string\">\"\\u@m1_618_u [\\d]&gt; \"</span></span><br><span class=\"line\">no-auto-rehash</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span><br><span class=\"line\">replicate-wild-do-table=mydatabase.%</span><br><span class=\"line\"></span><br><span class=\"line\">binlog-ignore-db=information_schema</span><br><span class=\"line\">binlog-ignore-db=mysql</span><br><span class=\"line\">binlog-ignore-db=performance_schema</span><br><span class=\"line\">binlog-ignore-db=test</span><br><span class=\"line\"></span><br><span class=\"line\">binlog-do-db=mydatabase</span><br><span class=\"line\"></span><br><span class=\"line\">user = mysql</span><br><span class=\"line\">port = 3308</span><br><span class=\"line\">basedir = /usr/local/mysql57</span><br><span class=\"line\">datadir = /disk/u01</span><br><span class=\"line\">socket = /disk/u01/mysql.sock</span><br><span class=\"line\">pid-file = /disk/u01/dbm1_u.pid</span><br><span class=\"line\">tmpdir = /disk/u02</span><br><span class=\"line\">server-id = 123</span><br><span class=\"line\">character-set-server = utf8</span><br><span class=\"line\">skip_name_resolve = 1</span><br><span class=\"line\">innodb_file_per_table = 1</span><br><span class=\"line\">explicit_defaults_for_timestamp = 0</span><br><span class=\"line\">read_only = 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># buffer&amp;cache</span></span><br><span class=\"line\">table_open_cache = 100</span><br><span class=\"line\">table_definition_cache = 400</span><br><span class=\"line\">table_open_cache_instances = 64</span><br><span class=\"line\">sort_buffer_size = 4M</span><br><span class=\"line\">join_buffer_size = 4M</span><br><span class=\"line\">read_buffer_size = 8M</span><br><span class=\"line\">read_rnd_buffer_size = 4M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># thread&amp;connection</span></span><br><span class=\"line\">thread_stack = 256K</span><br><span class=\"line\">thread_cache_size = 768</span><br><span class=\"line\">back_log = 1024</span><br><span class=\"line\">max_connections = 3000</span><br><span class=\"line\">max_connect_errors = 1000000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># temptable</span></span><br><span class=\"line\">tmp_table_size = 32M</span><br><span class=\"line\">max_heap_table_size = 32M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\">max_allowed_packet = 32M</span><br><span class=\"line\"><span class=\"comment\">#lock_wait_timeout = 3600</span></span><br><span class=\"line\"><span class=\"comment\">#interactive_timeout = 600</span></span><br><span class=\"line\"><span class=\"comment\">#wait_timeout = 600</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># query cache</span></span><br><span class=\"line\">query_cache_size = 0</span><br><span class=\"line\">query_cache_type = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置errorlog、slowlog和generallog的时区，默认UTC</span></span><br><span class=\"line\">log_timestamps = SYSTEM</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># error-log</span></span><br><span class=\"line\">log_error = /disk/u02/mysqld.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># slow-log</span></span><br><span class=\"line\">slow_query_log = 1</span><br><span class=\"line\">slow_query_log_file = /disk/u02/slow.log</span><br><span class=\"line\">long_query_time = 0.1</span><br><span class=\"line\">log_queries_not_using_indexes =1</span><br><span class=\"line\">log_throttle_queries_not_using_indexes = 60</span><br><span class=\"line\">min_examined_row_limit = 100</span><br><span class=\"line\">log_slow_admin_statements = 1</span><br><span class=\"line\">log_slow_slave_statements = 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># general log</span></span><br><span class=\"line\"><span class=\"comment\">#general-log = 1</span></span><br><span class=\"line\">general_log_file=/disk/u02/query.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># binlog</span></span><br><span class=\"line\">binlog_format = row</span><br><span class=\"line\">binlog_checksum = 1</span><br><span class=\"line\">log-bin = /disk/u02/m1-bin</span><br><span class=\"line\">log-bin-index = /disk/u02/m1-bin.index</span><br><span class=\"line\">sync_binlog = 0</span><br><span class=\"line\">binlog_cache_size = 4M</span><br><span class=\"line\">max_binlog_cache_size = 1G</span><br><span class=\"line\">max_binlog_size = 512M</span><br><span class=\"line\">expire_logs_days = 15</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># GTID</span></span><br><span class=\"line\">gtid_mode = off</span><br><span class=\"line\">enforce_gtid_consistency = 1</span><br><span class=\"line\">log_slave_updates</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">master_info_repository = TABLE</span><br><span class=\"line\">relay_log_info_repository = TABLE</span><br><span class=\"line\">slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'</span><br><span class=\"line\">relay_log_recovery = 1</span><br><span class=\"line\">relay_log_purge = 1</span><br><span class=\"line\">relay-log=/disk/u02/m1-relay-bin</span><br><span class=\"line\">relay-log-index=/disk/u02/m1-relay-bin.index</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb-buffer&amp;cache</span></span><br><span class=\"line\">innodb_buffer_pool_size = 1G</span><br><span class=\"line\">innodb_buffer_pool_instances = 4</span><br><span class=\"line\"><span class=\"comment\">#innodb_additional_mem_pool_size = 16M</span></span><br><span class=\"line\">innodb_max_dirty_pages_pct = 50</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb log</span></span><br><span class=\"line\">innodb_data_file_path = ibdata1:256M:autoextend</span><br><span class=\"line\">innodb_log_file_size = 256M</span><br><span class=\"line\">innodb_log_files_in_group = 2</span><br><span class=\"line\">innodb_flush_log_at_trx_commit = 2</span><br><span class=\"line\">innodb_log_buffer_size = 32M</span><br><span class=\"line\"><span class=\"comment\">#innodb_max_undo_log_size = 4G</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_undo_directory = undolog</span></span><br><span class=\"line\">innodb_undo_tablespaces = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb-io</span></span><br><span class=\"line\">innodb_flush_method = O_DIRECT</span><br><span class=\"line\">innodb_io_capacity = 600</span><br><span class=\"line\">innodb_io_capacity_max = 2000</span><br><span class=\"line\">innodb_flush_sync = 0</span><br><span class=\"line\">innodb_flush_neighbors = 0</span><br><span class=\"line\"><span class=\"comment\">#innodb_lru_scan_depth = 4000</span></span><br><span class=\"line\">innodb_write_io_threads = 8</span><br><span class=\"line\">innodb_read_io_threads = 8</span><br><span class=\"line\">innodb_purge_threads = 4</span><br><span class=\"line\">innodb_page_cleaners = 4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transaction,lock</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_sync_spin_loops = 100</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_spin_wait_delay = 30</span></span><br><span class=\"line\">innodb_lock_wait_timeout = 10</span><br><span class=\"line\">innodb_print_all_deadlocks = 1</span><br><span class=\"line\">innodb_rollback_on_timeout = 1</span><br><span class=\"line\"></span><br><span class=\"line\">innodb_open_files = 65535</span><br><span class=\"line\"></span><br><span class=\"line\">innodb_online_alter_log_max_size = 1G</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb status</span></span><br><span class=\"line\">innodb_status_file = 1</span><br><span class=\"line\"><span class=\"comment\"># 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快</span></span><br><span class=\"line\">innodb_status_output = 0</span><br><span class=\"line\">innodb_status_output_locks = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#performance_schema</span></span><br><span class=\"line\">performance_schema = 1</span><br><span class=\"line\">performance_schema_instrument = '%=on'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#innodb monitor</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_innodb\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_server\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_dml\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_ddl\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_trx\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_os\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_purge\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_log\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_lock\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_buffer\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_index\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_ibuf_system\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_buffer_page\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_adaptive_hash\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># MyISAM</span></span><br><span class=\"line\">key_buffer_size = 1024M</span><br><span class=\"line\">bulk_insert_buffer_size = 64M</span><br><span class=\"line\">myisam_sort_buffer_size = 128M</span><br><span class=\"line\">myisam_repair_threads = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[mysqldump]</span><br><span class=\"line\">quick</span><br><span class=\"line\">max_allowed_packet = 32M</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/29/23-mysql5-5主与mysql5-7从部署配置/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"},{"name":"主从","slug":"mysql/主从","permalink":"https://blog.k1s.club/categories/mysql/主从/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"},{"name":"mysql5.7","slug":"mysql5-7","permalink":"https://blog.k1s.club/tags/mysql5-7/"}]},{"title":"es5集群磁盘扩容","date":"2019-10-28T06:59:52.000Z","path":"2019/10/28/22-es集群磁盘扩容/","text":"es集群磁盘不足,对磁盘扩容遇到一些的问题 重启集群前，先设置集群停止分片移动：12345curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;\"transient\" : &#123;\"cluster.routing.allocation.enable\" : \"none\"&#125;&#125;' 对磁盘进行扩容,每次操作一个节点123456789101112131415# 直接扩容磁盘到2T//针对ext4文件格式的操作系统（如CentOS6）：//umount /dev/vdbe2fsck -f /dev/vdbresize2fs /dev/vdbmount /dev/vdb /data# 或者新增 2T云盘/dev/vdcumount /data/mkdir /data2mount /dev/vdb /data2mkfs.ext4 /dev/vdcmount /dev/vdc /datacp -ra /data2/* /data/ 重启之后，恢复分片自动分配：12345curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;\"transient\" : &#123;\"cluster.routing.allocation.enable\" : \"all\"&#125;&#125;' 如果需要下线其中的节点, 先将分片都转义到其他节点123456# 执行以下命令会自动将10.10.0.1 节点上的分片全部迁移到其他机器, 等待迁移完成, 将改空机器下线即可curl -XPUT 127.0.0.1:9200/_cluster/settings -d '&#123;\"transient\" :&#123;\"cluster.routing.allocation.exclude._ip\" : \"10.10.0.1\"&#125;&#125;' 另外对于 path.data 配置多快盘的问题1234比如es8配置了三块盘:/disk4/data -&gt; sde, /disk5/data -&gt; sdf, disk6/data -&gt; sdg这里注意 es node的data path尽量保证盘的大小差别不要太大, sde,sdf,sdg的大小保障差不多, 否则由于es shard 均衡的时候可能会优先分配到磁盘大的目录, 可能会导致sde(假如这个磁盘最大)的IO高, 而sdf等IO低 简单的配置信息elasticsearch512345678910111213cluster.name: es-devnode.name: es1-upath.data: /data/es/datapath.logs: /data/es/logsnetwork.host: 0.0.0.0discovery.zen.ping.unicast.hosts: [\"10.10.0.1:9300\",\"10.10.0.2:9300\",\"10.10.0.3:9300\",\"10.10.0.4:9300\"]http.cors.enabled: truehttp.cors.allow-origin: \"*\"xpack.security.enabled: falsebootstrap.system_call_filter: falsethread_pool.bulk.queue_size: 3000# 防止脑裂discovery.zen.minimum_master_nodes: 2","raw":"---\ntitle: es5集群磁盘扩容\ncopyright: true\ndate: 2019-10-28 14:59:52\ntags:\n  - elasticsearch5\ncategories:\n  - [elk,elasticsearch5]\n---\n\nes集群磁盘不足,对磁盘扩容遇到一些的问题\n<!-- more -->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 重启集群前，先设置集群停止分片移动：\n```\ncurl -XPUT http://localhost:9200/_cluster/settings -d '{\n\"transient\" : {\n\"cluster.routing.allocation.enable\" : \"none\"\n}\n}'\n```\n\n### 对磁盘进行扩容,每次操作一个节点\n```\n# 直接扩容磁盘到2T\n//针对ext4文件格式的操作系统（如CentOS6）：//\numount /dev/vdb\ne2fsck -f /dev/vdb\nresize2fs /dev/vdb\nmount /dev/vdb /data\n\n\n# 或者新增 2T云盘/dev/vdc\numount /data/\nmkdir /data2\nmount /dev/vdb /data2\nmkfs.ext4 /dev/vdc\nmount /dev/vdc /data\ncp -ra /data2/* /data/\n```\n\n### 重启之后，恢复分片自动分配：\n```\ncurl -XPUT http://localhost:9200/_cluster/settings -d '{\n\"transient\" : {\n\"cluster.routing.allocation.enable\" : \"all\"\n}\n}'\n```\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 如果需要下线其中的节点, 先将分片都转义到其他节点\n```\n# 执行以下命令会自动将10.10.0.1 节点上的分片全部迁移到其他机器, 等待迁移完成, 将改空机器下线即可\ncurl -XPUT 127.0.0.1:9200/_cluster/settings -d '{\n\"transient\" :{\n\"cluster.routing.allocation.exclude._ip\" : \"10.10.0.1\"\n}\n}'\n```\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 另外对于  path.data 配置多快盘的问题\n```\n比如es8配置了三块盘:\n/disk4/data -> sde, /disk5/data -> sdf, disk6/data -> sdg\n\n这里注意 es node的data path尽量保证盘的大小差别不要太大, sde,sdf,sdg的大小保障差不多, 否则由于es shard 均衡的时候可能会优先分配到磁盘大的目录, 可能会导致sde(假如这个磁盘最大)的IO高, 而sdf等IO低\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 简单的配置信息elasticsearch5\n```\n cluster.name: es-dev\n node.name: es1-u\n path.data: /data/es/data\n path.logs: /data/es/logs\n network.host: 0.0.0.0\n discovery.zen.ping.unicast.hosts: [\"10.10.0.1:9300\",\"10.10.0.2:9300\",\"10.10.0.3:9300\",\"10.10.0.4:9300\"]\n http.cors.enabled: true\n http.cors.allow-origin: \"*\"\n xpack.security.enabled: false\n bootstrap.system_call_filter: false\n thread_pool.bulk.queue_size: 3000\n # 防止脑裂\n discovery.zen.minimum_master_nodes: 2\n```\n","content":"<p>es集群磁盘不足,对磁盘扩容遇到一些的问题</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"重启集群前，先设置集群停止分片移动：\"><a href=\"#重启集群前，先设置集群停止分片移动：\" class=\"headerlink\" title=\"重启集群前，先设置集群停止分片移动：\"></a>重启集群前，先设置集群停止分片移动：</h3><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT <span class=\"string\">http:</span><span class=\"comment\">//localhost:9200/_cluster/settings -d '&#123;</span></span><br><span class=\"line\"><span class=\"string\">\"transient\"</span> : &#123;</span><br><span class=\"line\"><span class=\"string\">\"cluster.routing.allocation.enable\"</span> : <span class=\"string\">\"none\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;<span class=\"string\">'</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"对磁盘进行扩容-每次操作一个节点\"><a href=\"#对磁盘进行扩容-每次操作一个节点\" class=\"headerlink\" title=\"对磁盘进行扩容,每次操作一个节点\"></a>对磁盘进行扩容,每次操作一个节点</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 直接扩容磁盘到2T</span></span><br><span class=\"line\"><span class=\"string\">//</span>针对ext4文件格式的操作系统（如CentOS6）：<span class=\"string\">//</span></span><br><span class=\"line\">umount <span class=\"string\">/dev/vdb</span></span><br><span class=\"line\">e2fsck -f <span class=\"string\">/dev/vdb</span></span><br><span class=\"line\">resize2fs <span class=\"string\">/dev/vdb</span></span><br><span class=\"line\">mount <span class=\"string\">/dev/vdb</span> <span class=\"string\">/data</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者新增 2T云盘/dev/vdc</span></span><br><span class=\"line\">umount <span class=\"string\">/data/</span></span><br><span class=\"line\">mkdir <span class=\"string\">/data2</span></span><br><span class=\"line\">mount <span class=\"string\">/dev/vdb</span> <span class=\"string\">/data2</span></span><br><span class=\"line\">mkfs.ext4 <span class=\"string\">/dev/vdc</span></span><br><span class=\"line\">mount <span class=\"string\">/dev/vdc</span> <span class=\"string\">/data</span></span><br><span class=\"line\">cp -ra <span class=\"string\">/data2/</span>* <span class=\"string\">/data/</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重启之后，恢复分片自动分配：\"><a href=\"#重启之后，恢复分片自动分配：\" class=\"headerlink\" title=\"重启之后，恢复分片自动分配：\"></a>重启之后，恢复分片自动分配：</h3><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT <span class=\"string\">http:</span><span class=\"comment\">//localhost:9200/_cluster/settings -d '&#123;</span></span><br><span class=\"line\"><span class=\"string\">\"transient\"</span> : &#123;</span><br><span class=\"line\"><span class=\"string\">\"cluster.routing.allocation.enable\"</span> : <span class=\"string\">\"all\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;<span class=\"string\">'</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"如果需要下线其中的节点-先将分片都转义到其他节点\"><a href=\"#如果需要下线其中的节点-先将分片都转义到其他节点\" class=\"headerlink\" title=\"如果需要下线其中的节点, 先将分片都转义到其他节点\"></a>如果需要下线其中的节点, 先将分片都转义到其他节点</h3><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 执行以下命令会自动将10.10.0.1 节点上的分片全部迁移到其他机器, 等待迁移完成, 将改空机器下线即可</span></span><br><span class=\"line\">curl -XPUT 127.0.0.1:9200/_cluster/settings -d '&#123;</span><br><span class=\"line\">\"<span class=\"attribute\">transient\"</span> :&#123;</span><br><span class=\"line\">\"cluster<span class=\"variable\">.routing</span><span class=\"variable\">.allocation</span><span class=\"variable\">.exclude</span><span class=\"variable\">._ip</span>\" : \"10.10.0.1\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;'</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"另外对于-path-data-配置多快盘的问题\"><a href=\"#另外对于-path-data-配置多快盘的问题\" class=\"headerlink\" title=\"另外对于  path.data 配置多快盘的问题\"></a>另外对于  path.data 配置多快盘的问题</h3><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">比如es8配置了三块盘:</span><br><span class=\"line\">/<span class=\"function\"><span class=\"title\">disk4</span>/<span class=\"keyword\">data</span> -&gt;</span> <span class=\"function\"><span class=\"title\">sde</span>, /disk5/<span class=\"keyword\">data</span> -&gt;</span> <span class=\"function\"><span class=\"title\">sdf</span>, disk6/<span class=\"keyword\">data</span> -&gt;</span> sdg</span><br><span class=\"line\"></span><br><span class=\"line\">这里注意 es node的<span class=\"keyword\">data</span> <span class=\"built_in\">path</span>尽量保证盘的大小差别不要太大, sde,sdf,sdg的大小保障差不多, 否则由于es shard 均衡的时候可能会优先分配到磁盘大的目录, 可能会导致sde(假如这个磁盘最大)的IO高, 而sdf等IO低</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"简单的配置信息elasticsearch5\"><a href=\"#简单的配置信息elasticsearch5\" class=\"headerlink\" title=\"简单的配置信息elasticsearch5\"></a>简单的配置信息elasticsearch5</h3><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">cluster.name:</span> es-dev</span><br><span class=\"line\"><span class=\"symbol\">node.name:</span> es1-u</span><br><span class=\"line\"><span class=\"symbol\">path.data:</span> /data/es/data</span><br><span class=\"line\"><span class=\"symbol\">path.logs:</span> /data/es/logs</span><br><span class=\"line\"><span class=\"symbol\">network.host:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.ping.unicast.hosts:</span> [<span class=\"string\">\"10.10.0.1:9300\"</span>,<span class=\"string\">\"10.10.0.2:9300\"</span>,<span class=\"string\">\"10.10.0.3:9300\"</span>,<span class=\"string\">\"10.10.0.4:9300\"</span>]</span><br><span class=\"line\"><span class=\"symbol\">http.cors.enabled:</span> true</span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"symbol\">xpack.security.enabled:</span> false</span><br><span class=\"line\"><span class=\"symbol\">bootstrap.system_call_filter:</span> false</span><br><span class=\"line\"><span class=\"symbol\">thread_pool.bulk.queue_size:</span> <span class=\"number\">3000</span></span><br><span class=\"line\"><span class=\"meta\"># 防止脑裂</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.minimum_master_nodes:</span> <span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/28/22-es集群磁盘扩容/","categories":[{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elasticsearch5","slug":"elk/elasticsearch5","permalink":"https://blog.k1s.club/categories/elk/elasticsearch5/"}],"tags":[{"name":"elasticsearch5","slug":"elasticsearch5","permalink":"https://blog.k1s.club/tags/elasticsearch5/"}]},{"title":"流量复制工具gor","date":"2019-10-28T06:04:37.000Z","path":"2019/10/28/21-流量复制工具gor/","text":"Gor 是一款go语言实现的简单的http流量复制工具，它的主要目的是使你的生产环境HTTP真实流量在测试环境和预发布环境重现 流量复制工具 下载安装github下载地址: https://github.com/buger/goreplay/releases 1234tar -xvf gor_1.0.0_x64.tar.gzmv gor /usr/bin/which gor 命令123456789101112131415161718192021222324252627282930311 保存请求到文件# 将本机所有80请求保存到gor-20171120_0.log文件(注意会生成很多文件)gor --input-raw :80 --output-file gor-%Y%m%d.log# --output-file-append 会生成gor-20171120.log文件gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append2 根据文件回放请求# 镜像qps回放gor --input-file gor-aaaa-20171120.log --output-http aaaa-dev.test.com# 两倍镜像qps回放gor --input-file \"gor-aaaa-20171120.log|200%\" --output-http aaaa-dev.test.com3 过滤url后保存请求到文件# 排除s.test.com的请求gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append --http-disallow-header \"Host: s.test.com\" --http-disallow-header \"Host: www.test.com\" --http-disallow-header \"Host: bbs.test.com\"# 只存储aaaa.test.com的请求gor --input-raw :80 --output-file gor-aaaa-%Y%m%d.log --output-file-append --http-allow-header \"Host: aaaa.test.com\"# https的不能抓包gor --input-raw :443 --output-file gor-ssl-aaaa-%Y%m%d.log --output-file-append --http-allow-header \"Host: aaaa.test.com\"4 在线镜像复制请求# 将生产aaaa.test.com的请求复制到 aaaa-dev.test.com 环境!gor --input-raw :80 --output-http \"aaaa-dev.test.com\" --http-allow-header \"Host: aaaa.test.com\" 离线文件编辑123456文件的每个请求通过 如下字符串分割!ð&lt;9f&gt;&lt;90&gt;µð&lt;9f&gt;&lt;99&gt;&lt;88&gt;ð&lt;9f&gt;&lt;99&gt;&lt;89&gt;并且第一行是 请求的唯一码? 和时间戳!1 9b366a8eab8d6cb8e557cb3bf43f69c36612cffb 1511165572419843000所以可录制比如半小时的然后窃取需要的时间段! 问题 https 不能抓包! 通过添加代理, gor抓取8000端口 1234567891011121314151617181920212223# SSL terminationserver &#123; listen 443 ssl; server_name aaaa.test.com; ssl_certificate /etc/ssl/nginx/server.crt; ssl_certificate_key /etc/ssl/nginx/server.key; location / &#123; proxy_set_header Host $host; proxy_pass http://localhost:8000; &#125;&#125;server &#123; listen 8000; server_name aaaa.test.com; location / &#123; proxy_set_header Host $host; proxy_pass http://production_shop_api_site; &#125;&#125;","raw":"---\ntitle: 流量复制工具gor\ncopyright: true\ndate: 2019-10-28 14:04:37\ntags:\n  - gor\n  - http流量复制工具\ncategories:\n  - [流量复制工具,gor]\n---\nGor 是一款go语言实现的简单的http流量复制工具，它的主要目的是使你的生产环境HTTP真实流量在测试环境和预发布环境重现\n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 流量复制工具 </font>\n</center>\n\n\n### 下载安装\ngithub下载地址: [https://github.com/buger/goreplay/releases](https://github.com/buger/goreplay/releases)\n\n```\ntar -xvf gor_1.0.0_x64.tar.gz\nmv gor /usr/bin/\n\nwhich gor\n```\n\n###  命令\n```\n1   保存请求到文件\n# 将本机所有80请求保存到gor-20171120_0.log文件(注意会生成很多文件)\ngor --input-raw :80 --output-file gor-%Y%m%d.log\n\n# --output-file-append 会生成gor-20171120.log文件\ngor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append\n\n\n2   根据文件回放请求\n# 镜像qps回放\ngor --input-file gor-aaaa-20171120.log --output-http aaaa-dev.test.com\n# 两倍镜像qps回放\ngor --input-file \"gor-aaaa-20171120.log|200%\" --output-http aaaa-dev.test.com\n\n\n3   过滤url后保存请求到文件\n# 排除s.test.com的请求\ngor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append --http-disallow-header \"Host: s.test.com\" --http-disallow-header \"Host: www.test.com\"  --http-disallow-header \"Host: bbs.test.com\"\n# 只存储aaaa.test.com的请求\ngor --input-raw :80 --output-file gor-aaaa-%Y%m%d.log --output-file-append --http-allow-header \"Host: aaaa.test.com\"\n\n# https的不能抓包\ngor --input-raw :443 --output-file gor-ssl-aaaa-%Y%m%d.log --output-file-append --http-allow-header \"Host: aaaa.test.com\"\n\n\n\n\n\n4   在线镜像复制请求\n# 将生产aaaa.test.com的请求复制到 aaaa-dev.test.com 环境!\ngor --input-raw :80 --output-http \"aaaa-dev.test.com\" --http-allow-header \"Host: aaaa.test.com\"\n```\n\n\n### 离线文件编辑\n```\n文件的每个请求通过 如下字符串分割!\nð<9f><90>µð<9f><99><88>ð<9f><99><89>\n并且第一行是 请求的唯一码? 和时间戳!\n1 9b366a8eab8d6cb8e557cb3bf43f69c36612cffb 1511165572419843000\n\n所以可录制比如半小时的然后窃取需要的时间段!\n\n```\n\n\n### 问题  https 不能抓包!\n> 通过添加代理, gor抓取8000端口\n\n```\n# SSL termination\nserver {\n  listen 443 ssl;\n  server_name aaaa.test.com;\n\n  ssl_certificate /etc/ssl/nginx/server.crt;\n  ssl_certificate_key /etc/ssl/nginx/server.key;\n\n  location / {\n    proxy_set_header Host $host;\n    proxy_pass http://localhost:8000;\n  }\n}\n\nserver {\n  listen 8000;\n  server_name aaaa.test.com;\n\n  location / {\n    proxy_set_header Host $host;\n    proxy_pass http://production_shop_api_site;\n  }\n}\n\n```\n\n","content":"<p>Gor 是一款go语言实现的简单的http流量复制工具，它的主要目的是使你的生产环境HTTP真实流量在测试环境和预发布环境重现</p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 流量复制工具 </font>\n</center>\n\n\n<h3 id=\"下载安装\"><a href=\"#下载安装\" class=\"headerlink\" title=\"下载安装\"></a>下载安装</h3><p>github下载地址: <a href=\"https://github.com/buger/goreplay/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/buger/goreplay/releases</a></p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -xvf gor_1.<span class=\"number\">0.0</span>_x64<span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">mv gor /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\">which gor</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"命令\"><a href=\"#命令\" class=\"headerlink\" title=\"命令\"></a>命令</h3><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1   保存请求到文件</span><br><span class=\"line\"># 将本机所有80请求保存到gor-20171120_0.<span class=\"keyword\">log</span>文件(注意会生成很多文件)</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :80 --output-<span class=\"keyword\">file</span> gor-%Y%<span class=\"keyword\">m</span>%<span class=\"keyword\">d</span>.<span class=\"built_in\">log</span></span><br><span class=\"line\"></span><br><span class=\"line\"># --output-<span class=\"keyword\">file</span>-<span class=\"keyword\">append</span> 会生成gor-20171120.<span class=\"keyword\">log</span>文件</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :80 --output-<span class=\"keyword\">file</span> gor-%Y%<span class=\"keyword\">m</span>%<span class=\"keyword\">d</span>.<span class=\"keyword\">log</span> --output-<span class=\"keyword\">file</span>-<span class=\"keyword\">append</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2   根据文件回放请求</span><br><span class=\"line\"># 镜像qps回放</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-<span class=\"keyword\">file</span> gor-aaaa-20171120.<span class=\"keyword\">log</span> --output-http aaaa-dev.<span class=\"keyword\">test</span>.com</span><br><span class=\"line\"># 两倍镜像qps回放</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-<span class=\"keyword\">file</span> <span class=\"string\">\"gor-aaaa-20171120.log|200%\"</span> --output-http aaaa-dev.<span class=\"keyword\">test</span>.com</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3   过滤url后保存请求到文件</span><br><span class=\"line\"># 排除s.<span class=\"keyword\">test</span>.com的请求</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :80 --output-<span class=\"keyword\">file</span> gor-%Y%<span class=\"keyword\">m</span>%<span class=\"keyword\">d</span>.<span class=\"keyword\">log</span> --output-<span class=\"keyword\">file</span>-<span class=\"keyword\">append</span> --http-disallow-header <span class=\"string\">\"Host: s.test.com\"</span> --http-disallow-header <span class=\"string\">\"Host: www.test.com\"</span>  --http-disallow-header <span class=\"string\">\"Host: bbs.test.com\"</span></span><br><span class=\"line\"># 只存储aaaa.<span class=\"keyword\">test</span>.com的请求</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :80 --output-<span class=\"keyword\">file</span> gor-aaaa-%Y%<span class=\"keyword\">m</span>%<span class=\"keyword\">d</span>.<span class=\"keyword\">log</span> --output-<span class=\"keyword\">file</span>-<span class=\"keyword\">append</span> --http-allow-header <span class=\"string\">\"Host: aaaa.test.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"># https的不能抓包</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :443 --output-<span class=\"keyword\">file</span> gor-ssl-aaaa-%Y%<span class=\"keyword\">m</span>%<span class=\"keyword\">d</span>.<span class=\"keyword\">log</span> --output-<span class=\"keyword\">file</span>-<span class=\"keyword\">append</span> --http-allow-header <span class=\"string\">\"Host: aaaa.test.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4   在线镜像复制请求</span><br><span class=\"line\"># 将生产aaaa.<span class=\"keyword\">test</span>.com的请求复制到 aaaa-dev.<span class=\"keyword\">test</span>.com 环境!</span><br><span class=\"line\">gor --<span class=\"keyword\">input</span>-raw :80 --output-http <span class=\"string\">\"aaaa-dev.test.com\"</span> --http-allow-header <span class=\"string\">\"Host: aaaa.test.com\"</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"离线文件编辑\"><a href=\"#离线文件编辑\" class=\"headerlink\" title=\"离线文件编辑\"></a>离线文件编辑</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">文件的每个请求通过 如下字符串分割!</span><br><span class=\"line\">ð&lt;<span class=\"number\">9</span>f&gt;&lt;<span class=\"number\">90</span>&gt;µð&lt;<span class=\"number\">9</span>f&gt;&lt;<span class=\"number\">99</span>&gt;&lt;<span class=\"number\">88</span>&gt;ð&lt;<span class=\"number\">9</span>f&gt;&lt;<span class=\"number\">99</span>&gt;&lt;<span class=\"number\">89</span>&gt;</span><br><span class=\"line\">并且第一行是 请求的唯一码? 和时间戳!</span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"number\">9</span>b366a8eab8d6cb8e557cb3bf43f69c36612cffb <span class=\"number\">1511165572419843000</span></span><br><span class=\"line\"></span><br><span class=\"line\">所以可录制比如半小时的然后窃取需要的时间段!</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"问题-https-不能抓包\"><a href=\"#问题-https-不能抓包\" class=\"headerlink\" title=\"问题  https 不能抓包!\"></a>问题  https 不能抓包!</h3><blockquote>\n<p>通过添加代理, gor抓取8000端口</p>\n</blockquote>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># SSL termination</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> aaaa.test.com;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span> /etc/ssl/nginx/server.crt;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span> /etc/ssl/nginx/server.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://localhost:8000;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">8000</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> aaaa.test.com;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://production_shop_api_site;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/28/21-流量复制工具gor/","categories":[{"name":"流量复制工具","slug":"流量复制工具","permalink":"https://blog.k1s.club/categories/流量复制工具/"},{"name":"gor","slug":"流量复制工具/gor","permalink":"https://blog.k1s.club/categories/流量复制工具/gor/"}],"tags":[{"name":"gor","slug":"gor","permalink":"https://blog.k1s.club/tags/gor/"},{"name":"http流量复制工具","slug":"http流量复制工具","permalink":"https://blog.k1s.club/tags/http流量复制工具/"}]},{"title":"k8s搭建mysql5.7.24主从","date":"2019-10-24T10:35:00.000Z","path":"2019/10/24/20-k8s搭建mysql5-7-24主从/","text":"k8s上简单部署mysql5.7.24主从 k8s搭建mysql5.7.24主从 参考文档利用Kubernetes搭建mysql主从复制集群官方dockerfile 从hub.docker.com拉取官方镜像1docker pull mysql:5.7.24 build镜像 主库master的Dockerfile12345from mysql:5.7.24run sed -i '/\\[mysqld\\]/a server-id=1\\nlog-bin' /etc/mysql/mysql.conf.d/mysqld.cnfCOPY docker-entrypoint.sh /usr/local/bin/ 主库的docker-entrypoint.sh 先从初始镜像取 或者从github对应版本上 123docker run -dti mysql:5.7.24 /bin/bashdocker cp 2bfa6209d120c23:/usr/local/bin/docker-entrypoint.sh . 修改docker-entrypoint.sh 12345678fi# 添加以下内容echo \"CREATE USER '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;\" | \"$&#123;mysql[@]&#125;\"echo \"GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;\" | \"$&#123;mysql[@]&#125;\"echo \"FLUSH PRIVILEGES ;\" | \"$&#123;mysql[@]&#125;\"# 添加以上内容echo ls /docker-entrypoint-initdb.d/ &gt; /dev/null build主库镜像 12docker build -t hub.zhangzw.com/bq/mysql-master:5.7.24 .docker push hub.zhangzw.com/bq/mysql-master:5.7.24 从库的docker-entrypoint.sh 同上先从初始镜像取 或者从github对应版本上 或复制上面的文件 修改docker-entrypoint.sh 12345678fi# 添加以下内容 echo \"STOP SLAVE;\" | \"$&#123;mysql[@]&#125;\" echo \"CHANGE MASTER TO master_host='$MYSQL_MASTER_SERVICE_HOST', master_user='$MYSQL_REPLICATION_USER', master_password='$MYSQL_REPLICATION_PASSWORD' ;\" | \"$&#123;mysql[@]&#125;\" echo \"START SLAVE;\" | \"$&#123;mysql[@]&#125;\" # 添加以上内容echo ls /docker-entrypoint-initdb.d/ &gt; /dev/null build从库镜像 12docker build -t hub.zhangzw.com/bq/mysql-slave:5.7.24 .docker push hub.zhangzw.com/bq/mysql-slave:5.7.24 开始部署 k8s-master-mysql_5.7.24.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869---apiVersion: apps/v1beta1kind: StatefulSetmetadata: labels: app: php-mysql-master-dev name: php-mysql-master-dev namespace: dbspec: serviceName: \"php-mysql-master-dev\" replicas: 1 selector: matchLabels: app: php-mysql-master-dev template: metadata: labels: app: php-mysql-master-dev spec: containers: - name: php-mysql-master-dev image: hub.zhangzw.com/bq/mysql-master:5.7.24 ports: - containerPort: 3306 name: db-port resources: requests: cpu: \"50m\" limits: cpu: \"1000m\" env: - name: MYSQL_ROOT_PASSWORD value: \"admin\" - name: MYSQL_REPLICATION_USER value: \"repl\" - name: MYSQL_REPLICATION_PASSWORD value: \"7a5b21ac65712bd95e39d3c1\" volumeMounts: - name: order-master-dev-data mountPath: /var/lib/mysql - name: order-master-dev-cfg mountPath: /etc/mysql volumes: - name: order-master-dev-data hostPath: path: /data/k8s-container/php-mysql-dev/master/data - name: order-master-dev-cfg hostPath: path: /data/k8s-container/php-mysql-dev/master/etc-mysql---kind: ServiceapiVersion: v1metadata: labels: app: php-mysql-master-dev name: php-mysql-master-dev-service namespace: dbspec: type: NodePort ports: - port: 3306 name: db-port targetPort: 3306 nodePort: 23306 protocol: TCP selector: app: php-mysql-master-dev k8s-slave-mysql_5.7.24.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172---apiVersion: apps/v1beta1kind: StatefulSetmetadata: labels: app: php-mysql-slave-dev name: php-mysql-slave-dev namespace: dbspec: serviceName: \"php-mysql-slave-dev\" replicas: 1 selector: matchLabels: app: php-mysql-slave-dev template: metadata: labels: app: php-mysql-slave-dev spec: containers: - name: php-mysql-slave-dev image: hub.zhangzw.com/bq/mysql-slave:5.7.24 ports: - containerPort: 3306 name: db-port resources: requests: cpu: \"50m\" limits: cpu: \"1000m\" env: - name: MYSQL_ROOT_PASSWORD value: \"admin\" - name: MYSQL_REPLICATION_USER value: \"repl\" - name: MYSQL_REPLICATION_PASSWORD value: \"7a5b21ac65712bd95e39d3c1\" - name: MYSQL_MASTER_SERVICE_HOST value: \"php-mysql-master-dev-service\" volumeMounts: - name: order-slave-dev-data mountPath: /var/lib/mysql - name: order-slave-dev-cfg mountPath: /etc/mysql volumes: - name: order-slave-dev-data hostPath: path: /data/k8s-container/php-mysql-dev/slave/data - name: order-slave-dev-cfg hostPath: path: /data/k8s-container/php-mysql-dev/slave/etc-mysql---kind: ServiceapiVersion: v1metadata: labels: app: php-mysql-slave-dev name: php-mysql-slave-dev-service namespace: dbspec: type: NodePort ports: - port: 3306 name: db-port targetPort: 3306 nodePort: 23307 protocol: TCP selector: app: php-mysql-slave-dev 问题总结 从库的replay log名字会根据docker主机名变化, 也可以写在配置文件 12# Dockerfile中可以添加run sed -i '/\\[mysqld\\]/a relay-log-index=php-mysql-shoporder-slave-dev-relay-bin.index' /etc/mysql/mysql.conf.d/mysqld.cnf 注意MYSQL_MASTER_SERVICE_HOST 变量的配置, 根据你master的service变化 其次我docker-entrypoint.sh 文件几次手动从页面复制粘贴下来的导致各种语法错误,这里建议找到对的版本从github克隆, 或者从mysql:5.7.24镜像中cp 配置etc-mysql/mysql.conf.d/mysqld.cnf 123456789[mysqld]# 从库配置read_only=1super_read_only=1character-set-server=utf8# 1 去掉STRICT_TRANS_TABLES 表NOT NULL时无法创建表# 2 修改NO_ZERO_DATE为ALLOW_INVALID_DATES 允许’0000-00-00’#sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' 配置etc-mysql/conf.d/mysql.cnf 123[mysql]no-auto-rehashdefault-character-set=utf8 附录master配置docker-entrypoint.shslave配置docker-entrypoint.sh","raw":"---\ntitle: k8s搭建mysql5.7.24主从\ncopyright: true\ndate: 2019-10-24 18:35:00\ntags:\n  - k8s\n  - mysql\ncategories:\n  - [k8s,mysql]\n  - [mysql]\n---\nk8s上简单部署mysql5.7.24主从 \n<!-- more -->\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> k8s搭建mysql5.7.24主从 </font>\n</center>\n\n\n参考文档\n[利用Kubernetes搭建mysql主从复制集群](https://www.jianshu.com/p/509b65e9a4f5)\n[官方dockerfile](https://github.com/docker-library/mysql)\n\n### 从hub.docker.com拉取官方镜像\n```\ndocker pull mysql:5.7.24\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> build镜像 </font>\n</center>\n\n### 主库master的Dockerfile\n```\nfrom mysql:5.7.24\n\nrun sed -i '/\\[mysqld\\]/a server-id=1\\nlog-bin' /etc/mysql/mysql.conf.d/mysqld.cnf\n\nCOPY docker-entrypoint.sh /usr/local/bin/\n```\n\n### 主库的docker-entrypoint.sh\n- 先从初始镜像取 或者从github对应版本上\n\n```\ndocker run -dti mysql:5.7.24 /bin/bash\n\ndocker cp 2bfa6209d120c23:/usr/local/bin/docker-entrypoint.sh .\n```\n\n- 修改docker-entrypoint.sh\n\n```\nfi\n# 添加以下内容\necho \"CREATE USER '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;\" | \"${mysql[@]}\"\necho \"GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;\" | \"${mysql[@]}\"\necho \"FLUSH PRIVILEGES ;\" | \"${mysql[@]}\"\n# 添加以上内容\necho\n  ls /docker-entrypoint-initdb.d/ > /dev/null\n```\n\n- build主库镜像\n\n```\ndocker build -t hub.zhangzw.com/bq/mysql-master:5.7.24 .\ndocker push hub.zhangzw.com/bq/mysql-master:5.7.24\n```\n\n\n### 从库的docker-entrypoint.sh\n\n- 同上先从初始镜像取 或者从github对应版本上 或复制上面的文件\n- 修改docker-entrypoint.sh\n\n```\nfi\n# 添加以下内容\n echo \"STOP SLAVE;\" | \"${mysql[@]}\"\n echo \"CHANGE MASTER TO master_host='$MYSQL_MASTER_SERVICE_HOST', master_user='$MYSQL_REPLICATION_USER', master_password='$MYSQL_REPLICATION_PASSWORD' ;\" |  \"${mysql[@]}\"\n echo \"START SLAVE;\" | \"${mysql[@]}\"\n # 添加以上内容\necho\n  ls /docker-entrypoint-initdb.d/ > /dev/null\n\n```\n\n- build从库镜像\n\n```\ndocker build -t hub.zhangzw.com/bq/mysql-slave:5.7.24 .\ndocker push hub.zhangzw.com/bq/mysql-slave:5.7.24\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 开始部署 </font>\n</center>\n\n\n- k8s-master-mysql_5.7.24.yml\n\n```\n---\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: php-mysql-master-dev\n  name: php-mysql-master-dev\n  namespace: db\nspec:\n  serviceName: \"php-mysql-master-dev\"\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-mysql-master-dev\n  template:\n    metadata:\n      labels:\n        app: php-mysql-master-dev\n    spec:\n      containers:\n       - name: php-mysql-master-dev\n         image: hub.zhangzw.com/bq/mysql-master:5.7.24\n         ports:\n         - containerPort: 3306\n           name: db-port\n         resources:\n           requests:\n             cpu: \"50m\"\n           limits:\n             cpu: \"1000m\"\n         env:\n         - name: MYSQL_ROOT_PASSWORD\n           value: \"admin\"\n         - name: MYSQL_REPLICATION_USER\n           value: \"repl\"\n         - name: MYSQL_REPLICATION_PASSWORD\n           value: \"7a5b21ac65712bd95e39d3c1\"\n         volumeMounts:\n         - name: order-master-dev-data\n           mountPath: /var/lib/mysql\n         - name: order-master-dev-cfg\n           mountPath: /etc/mysql\n      volumes:\n        - name: order-master-dev-data\n          hostPath:\n            path: /data/k8s-container/php-mysql-dev/master/data\n        - name: order-master-dev-cfg\n          hostPath:\n            path: /data/k8s-container/php-mysql-dev/master/etc-mysql\n\n---\n\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: php-mysql-master-dev\n  name: php-mysql-master-dev-service\n  namespace: db\nspec:\n  type: NodePort\n  ports:\n    - port: 3306\n      name: db-port\n      targetPort: 3306\n      nodePort: 23306\n      protocol: TCP\n  selector:\n    app: php-mysql-master-dev\n```\n\n- k8s-slave-mysql_5.7.24.yml\n\n```\n---\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: php-mysql-slave-dev\n  name: php-mysql-slave-dev\n  namespace: db\nspec:\n  serviceName: \"php-mysql-slave-dev\"\n  replicas: 1\n  selector:\n    matchLabels:\n      app: php-mysql-slave-dev\n  template:\n    metadata:\n      labels:\n        app: php-mysql-slave-dev\n    spec:\n      containers:\n       - name: php-mysql-slave-dev\n         image: hub.zhangzw.com/bq/mysql-slave:5.7.24\n         ports:\n         - containerPort: 3306\n           name: db-port\n         resources:\n           requests:\n             cpu: \"50m\"\n           limits:\n             cpu: \"1000m\"\n         env:\n         - name: MYSQL_ROOT_PASSWORD\n           value: \"admin\"\n         - name: MYSQL_REPLICATION_USER\n           value: \"repl\"\n         - name: MYSQL_REPLICATION_PASSWORD\n           value: \"7a5b21ac65712bd95e39d3c1\"\n         - name: MYSQL_MASTER_SERVICE_HOST\n           value: \"php-mysql-master-dev-service\"\n         volumeMounts:\n         - name: order-slave-dev-data\n           mountPath: /var/lib/mysql\n         - name: order-slave-dev-cfg\n           mountPath: /etc/mysql\n      volumes:\n        - name: order-slave-dev-data\n          hostPath:\n            path: /data/k8s-container/php-mysql-dev/slave/data\n        - name: order-slave-dev-cfg\n          hostPath:\n            path: /data/k8s-container/php-mysql-dev/slave/etc-mysql\n\n\n---\n\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: php-mysql-slave-dev\n  name: php-mysql-slave-dev-service\n  namespace: db\nspec:\n  type: NodePort\n  ports:\n    - port: 3306\n      name: db-port\n      targetPort: 3306\n      nodePort: 23307\n      protocol: TCP\n  selector:\n    app: php-mysql-slave-dev\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 问题总结 </font>\n</center>\n\n\n- 从库的replay log名字会根据docker主机名变化, 也可以写在配置文件\n \n```\n# Dockerfile中可以添加\nrun sed -i '/\\[mysqld\\]/a relay-log-index=php-mysql-shoporder-slave-dev-relay-bin.index' /etc/mysql/mysql.conf.d/mysqld.cnf\n```\n\n- 注意MYSQL_MASTER_SERVICE_HOST 变量的配置, 根据你master的service变化\n\n- 其次我docker-entrypoint.sh 文件几次手动从页面复制粘贴下来的导致各种语法错误,这里建议找到对的版本从github克隆, 或者从mysql:5.7.24镜像中cp\n\n- 配置etc-mysql/mysql.conf.d/mysqld.cnf\n```\n[mysqld]\n# 从库配置\nread_only=1\nsuper_read_only=1\ncharacter-set-server=utf8\n# 1 去掉STRICT_TRANS_TABLES 表NOT NULL时无法创建表\n# 2 修改NO_ZERO_DATE为ALLOW_INVALID_DATES 允许’0000-00-00’\n#sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\nsql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\n```\n\n-  配置etc-mysql/conf.d/mysql.cnf\n```\n[mysql]\nno-auto-rehash\ndefault-character-set=utf8\n```\n\n\n\n### 附录\n[master配置docker-entrypoint.sh](//zhangzw001.github.io/sh/master-docker-entrypoint.sh)\n[slave配置docker-entrypoint.sh](//zhangzw001.github.io/sh/slave-docker-entrypoint.sh)\n","content":"<p>k8s上简单部署mysql5.7.24主从 </p>\n<a id=\"more\"></a>\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> k8s搭建mysql5.7.24主从 </font>\n</center>\n\n\n<p>参考文档<br><a href=\"https://www.jianshu.com/p/509b65e9a4f5\" target=\"_blank\" rel=\"noopener\">利用Kubernetes搭建mysql主从复制集群</a><br><a href=\"https://github.com/docker-library/mysql\" target=\"_blank\" rel=\"noopener\">官方dockerfile</a></p>\n<h3 id=\"从hub-docker-com拉取官方镜像\"><a href=\"#从hub-docker-com拉取官方镜像\" class=\"headerlink\" title=\"从hub.docker.com拉取官方镜像\"></a>从hub.docker.com拉取官方镜像</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">docker</span> <span class=\"selector-tag\">pull</span> <span class=\"selector-tag\">mysql</span><span class=\"selector-pseudo\">:5.7.24</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> build镜像 </font>\n</center>\n\n<h3 id=\"主库master的Dockerfile\"><a href=\"#主库master的Dockerfile\" class=\"headerlink\" title=\"主库master的Dockerfile\"></a>主库master的Dockerfile</h3><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from mysql:<span class=\"number\">5.7</span>.<span class=\"number\">24</span></span><br><span class=\"line\"></span><br><span class=\"line\">run sed -<span class=\"selector-tag\">i</span> <span class=\"string\">'/\\[mysqld\\]/a server-id=1\\nlog-bin'</span> /etc/mysql/mysql<span class=\"selector-class\">.conf</span><span class=\"selector-class\">.d</span>/mysqld.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">COPY docker-entrypoint<span class=\"selector-class\">.sh</span> /usr/local/bin/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主库的docker-entrypoint-sh\"><a href=\"#主库的docker-entrypoint-sh\" class=\"headerlink\" title=\"主库的docker-entrypoint.sh\"></a>主库的docker-entrypoint.sh</h3><ul>\n<li>先从初始镜像取 或者从github对应版本上</li>\n</ul>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -dti <span class=\"string\">mysql:</span><span class=\"number\">5.7</span><span class=\"number\">.24</span> <span class=\"regexp\">/bin/</span>bash</span><br><span class=\"line\"></span><br><span class=\"line\">docker cp <span class=\"number\">2</span><span class=\"string\">bfa6209d120c23:</span><span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/bin/</span>docker-entrypoint.sh .</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>修改docker-entrypoint.sh</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"comment\"># 添加以下内容</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"CREATE USER '<span class=\"variable\">$MYSQL_REPLICATION_USER</span>'@'%' IDENTIFIED BY '<span class=\"variable\">$MYSQL_REPLICATION_PASSWORD</span>' ;\"</span> | <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"GRANT REPLICATION SLAVE ON *.* TO '<span class=\"variable\">$MYSQL_REPLICATION_USER</span>'@'%' IDENTIFIED BY '<span class=\"variable\">$MYSQL_REPLICATION_PASSWORD</span>' ;\"</span> | <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"FLUSH PRIVILEGES ;\"</span> | <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"comment\"># 添加以上内容</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\">  ls /docker-entrypoint-initdb.d/ &gt; /dev/null</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>build主库镜像</li>\n</ul>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t hub<span class=\"selector-class\">.zhangzw</span><span class=\"selector-class\">.com</span>/bq/mysql-master:<span class=\"number\">5.7</span>.<span class=\"number\">24</span> .</span><br><span class=\"line\">docker push hub<span class=\"selector-class\">.zhangzw</span><span class=\"selector-class\">.com</span>/bq/mysql-master:<span class=\"number\">5.7</span>.<span class=\"number\">24</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"从库的docker-entrypoint-sh\"><a href=\"#从库的docker-entrypoint-sh\" class=\"headerlink\" title=\"从库的docker-entrypoint.sh\"></a>从库的docker-entrypoint.sh</h3><ul>\n<li>同上先从初始镜像取 或者从github对应版本上 或复制上面的文件</li>\n<li>修改docker-entrypoint.sh</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"comment\"># 添加以下内容</span></span><br><span class=\"line\"> <span class=\"built_in\">echo</span> <span class=\"string\">\"STOP SLAVE;\"</span> | <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"> <span class=\"built_in\">echo</span> <span class=\"string\">\"CHANGE MASTER TO master_host='<span class=\"variable\">$MYSQL_MASTER_SERVICE_HOST</span>', master_user='<span class=\"variable\">$MYSQL_REPLICATION_USER</span>', master_password='<span class=\"variable\">$MYSQL_REPLICATION_PASSWORD</span>' ;\"</span> |  <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"> <span class=\"built_in\">echo</span> <span class=\"string\">\"START SLAVE;\"</span> | <span class=\"string\">\"<span class=\"variable\">$&#123;mysql[@]&#125;</span>\"</span></span><br><span class=\"line\"> <span class=\"comment\"># 添加以上内容</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\">  ls /docker-entrypoint-initdb.d/ &gt; /dev/null</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>build从库镜像</li>\n</ul>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t hub<span class=\"selector-class\">.zhangzw</span><span class=\"selector-class\">.com</span>/bq/mysql-slave:<span class=\"number\">5.7</span>.<span class=\"number\">24</span> .</span><br><span class=\"line\">docker push hub<span class=\"selector-class\">.zhangzw</span><span class=\"selector-class\">.com</span>/bq/mysql-slave:<span class=\"number\">5.7</span>.<span class=\"number\">24</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 开始部署 </font>\n</center>\n\n\n<ul>\n<li>k8s-master-mysql_5.7.24.yml</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"php-mysql-master-dev\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">         image:</span> <span class=\"string\">hub.zhangzw.com/bq/mysql-master:5.7.24</span></span><br><span class=\"line\"><span class=\"attr\">         ports:</span></span><br><span class=\"line\"><span class=\"attr\">         - containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">           name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">         resources:</span></span><br><span class=\"line\"><span class=\"attr\">           requests:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">           limits:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"1000m\"</span></span><br><span class=\"line\"><span class=\"attr\">         env:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"admin\"</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_REPLICATION_USER</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"repl\"</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_REPLICATION_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"7a5b21ac65712bd95e39d3c1\"</span></span><br><span class=\"line\"><span class=\"attr\">         volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">order-master-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">order-master-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/etc/mysql</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">order-master-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-mysql-dev/master/data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">order-master-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-mysql-dev/master/etc-mysql</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-master-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-mysql-master-dev-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">23306</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-master-dev</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>k8s-slave-mysql_5.7.24.yml</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"php-mysql-slave-dev\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">         image:</span> <span class=\"string\">hub.zhangzw.com/bq/mysql-slave:5.7.24</span></span><br><span class=\"line\"><span class=\"attr\">         ports:</span></span><br><span class=\"line\"><span class=\"attr\">         - containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">           name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">         resources:</span></span><br><span class=\"line\"><span class=\"attr\">           requests:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">           limits:</span></span><br><span class=\"line\"><span class=\"attr\">             cpu:</span> <span class=\"string\">\"1000m\"</span></span><br><span class=\"line\"><span class=\"attr\">         env:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"admin\"</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_REPLICATION_USER</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"repl\"</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_REPLICATION_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"7a5b21ac65712bd95e39d3c1\"</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">MYSQL_MASTER_SERVICE_HOST</span></span><br><span class=\"line\"><span class=\"attr\">           value:</span> <span class=\"string\">\"php-mysql-master-dev-service\"</span></span><br><span class=\"line\"><span class=\"attr\">         volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">order-slave-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\"><span class=\"attr\">         - name:</span> <span class=\"string\">order-slave-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">           mountPath:</span> <span class=\"string\">/etc/mysql</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">order-slave-dev-data</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-mysql-dev/slave/data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">order-slave-dev-cfg</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/php-mysql-dev/slave/etc-mysql</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">php-mysql-slave-dev-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">db-port</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">23307</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">php-mysql-slave-dev</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 问题总结 </font>\n</center>\n\n\n<ul>\n<li>从库的replay log名字会根据docker主机名变化, 也可以写在配置文件</li>\n</ul>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Dockerfile中可以添加</span></span><br><span class=\"line\">run sed -i <span class=\"string\">'/\\[mysqld\\]/a relay-log-index=php-mysql-shoporder-slave-dev-relay-bin.index'</span> <span class=\"regexp\">/etc/my</span>sql<span class=\"regexp\">/mysql.conf.d/my</span>sqld.cnf</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>注意MYSQL_MASTER_SERVICE_HOST 变量的配置, 根据你master的service变化</p>\n</li>\n<li><p>其次我docker-entrypoint.sh 文件几次手动从页面复制粘贴下来的导致各种语法错误,这里建议找到对的版本从github克隆, 或者从mysql:5.7.24镜像中cp</p>\n</li>\n<li><p>配置etc-mysql/mysql.conf.d/mysqld.cnf</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mysqld]</span></span><br><span class=\"line\"><span class=\"comment\"># 从库配置</span></span><br><span class=\"line\"><span class=\"attr\">read_only</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">super_read_only</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">character-set-server</span>=utf8</span><br><span class=\"line\"><span class=\"comment\"># 1 去掉STRICT_TRANS_TABLES 表NOT NULL时无法创建表</span></span><br><span class=\"line\"><span class=\"comment\"># 2 修改NO_ZERO_DATE为ALLOW_INVALID_DATES 允许’0000-00-00’</span></span><br><span class=\"line\"><span class=\"comment\">#sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span></span><br><span class=\"line\"><span class=\"attr\">sql_mode</span>=<span class=\"string\">'ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置etc-mysql/conf.d/mysql.cnf</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[mysql]</span><br><span class=\"line\">no-<span class=\"keyword\">auto</span>-rehash</span><br><span class=\"line\"><span class=\"keyword\">default</span>-character-<span class=\"built_in\">set</span>=utf8</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h3><p><a href=\"//zhangzw001.github.io/sh/master-docker-entrypoint.sh\">master配置docker-entrypoint.sh</a><br><a href=\"//zhangzw001.github.io/sh/slave-docker-entrypoint.sh\">slave配置docker-entrypoint.sh</a></p>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/24/20-k8s搭建mysql5-7-24主从/","categories":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"mysql","slug":"k8s/mysql","permalink":"https://blog.k1s.club/categories/k8s/mysql/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"shell中gt和>的区别","date":"2019-10-17T03:48:22.000Z","path":"2019/10/17/19-shell中gt和>的区别/","text":"shell中 gt 和 &gt; 的一些相关问题介绍和测试 以下是bash的测试, 注意如果你是zsh可能会不同喔😯 [[]] , [] 和test比较 [] 和test: 两者是一样的，在命令行里test expr和[ expr ]的效果相同。test中可用的比较运算符只有==和!=，两者都是用于字符串比较的，不可用于整数比较，整数比较只能使用-eq, -gt这种形式。通过which [ 和which test 可以看到是命令 [] 和test 例子 1234567[root@dk-centos6 ~]# a=\"abcdef\"[root@dk-centos6 ~]# test \"$a\" = \"abcdef\"[root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [ \"$a\" = \"abcdef\" ][root@dk-centos6 ~]# echo $?0 [[ ]]具体功能: [[是 bash 程序语言的关键字。并不是一个命令，[[ ]] 结构比[ ]结构更加通用。在[[和]]之间所有的字符都不会发生文件名扩展或者单词分割，但是会发生参数扩展和命令替换。 支持字符串的模式匹配（使用=~操作符时甚至支持shell的正则表达 式）,右边的字符串不加双引号的情况,可以把右边作为模式. 比如[[ hello == hell? ]]，结果为真。当然加引号就是文本字符串比较. 使用[[ … ]]条件判断结构，而不是[ … ]，能够防止脚本中的许多逻辑错误。比如，&amp;&amp;、||、&lt;和&gt; 操作符能够正常存在于[[ ]]条件判断结构中，但是如果出现在[ ]结构中的话，会报错。比如可以直接使用if [[ $a != 1 &amp;&amp; $a != 2 ]], 如果不适用双括号, 则为if [ $a -ne 1] &amp;&amp; [ $a != 2 ]或者if [ $a -ne 1 -a $a != 2 ]。 纯数字比较 &gt; 通过比较ASCII值,gt仅能比较数字123456789101112[root@dk-centos6 ~]# [ 2 \\&gt; 1 ][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [ 2 -gt 1 ][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [[ 2 &gt; 1 ]][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [[ 2 -gt 1 ]][root@dk-centos6 ~]# echo $?0 字符串比较 单括号中如果要比较符号 “&lt;” “&gt;”, 需要转义, 否则判断结果错误123456789[root@dk-centos6 ~]# [ \"b\" &gt; \"a\" ][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [ \"b\" &lt; \"a\" ][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [ \"b\" \\&lt; \"a\" ][root@dk-centos6 ~]# echo $?1 双括号不用转义 , 直接执行即可123456[root@dk-centos6 ~]# [[ \"b\" &gt; \"a\" ]][root@dk-centos6 ~]# echo $?0[root@dk-centos6 ~]# [[ \"b\" &lt; \"a\" ]][root@dk-centos6 ~]# echo $?1","raw":"---\ntitle: shell中gt和>的区别\ncopyright: true\ndate: 2019-10-17 11:48:22\ntags:\n  - linux\n  - shell\ncategories:\n  - [linux,shell]\n---\nshell中 gt 和 > 的一些相关问题介绍和测试\n<!-- more-->\n\n\n> 以下是bash的测试, 注意如果你是zsh可能会不同喔😯\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=4> [[]] , [] 和test比较 </font>\n</center>\n\n[] 和test:\t两者是一样的，在命令行里test expr和[ expr ]的效果相同。test中可用的比较运算符只有==和!=，两者都是用于字符串比较的，不可用于整数比较，整数比较只能使用-eq, -gt这种形式。\n通过which [ 和which test 可以看到是命令\n\n> [] 和test 例子\n\n```\n[root@dk-centos6 ~]# a=\"abcdef\"\n[root@dk-centos6 ~]# test \"$a\" = \"abcdef\"\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [ \"$a\" = \"abcdef\" ]\n[root@dk-centos6 ~]# echo $?\n0\n```\n\n[[ ]]具体功能:\t\n- [[是 bash 程序语言的关键字。并不是一个命令，[[ ]] 结构比[ ]结构更加通用。在[[和]]之间所有的字符都不会发生文件名扩展或者单词分割，但是会发生参数扩展和命令替换。\n\n- 支持字符串的模式匹配（使用=~操作符时甚至支持shell的正则表达 式）,右边的字符串不加双引号的情况,可以把右边作为模式. 比如[[ hello == hell? ]]，结果为真。当然加引号就是文本字符串比较.\n\n- 使用[[ ... ]]条件判断结构，而不是[ ... ]，能够防止脚本中的许多逻辑错误。比如，&&、||、<和> 操作符能够正常存在于[[ ]]条件判断结构中，但是如果出现在[ ]结构中的话，会报错。比如可以直接使用if [[ $a != 1 && $a != 2 ]], 如果不适用双括号, 则为if [ $a -ne 1] && [ $a != 2 ]或者if [ $a -ne 1 -a $a != 2 ]。\n\n\n---\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=4> 纯数字比较 </font>\n</center>\n\n### > 通过比较ASCII值,gt仅能比较数字\n\n```\n[root@dk-centos6 ~]# [ 2 \\> 1 ]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [ 2 -gt 1 ]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [[ 2 > 1 ]]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [[ 2 -gt 1 ]]\n[root@dk-centos6 ~]# echo $?\n0\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=4> 字符串比较 </font>\n</center>\n\n### 单括号中如果要比较符号 \"<\" \">\", 需要转义, 否则判断结果错误\n\n```\n[root@dk-centos6 ~]# [ \"b\" > \"a\" ]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [ \"b\" < \"a\" ]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [ \"b\" \\< \"a\" ]\n[root@dk-centos6 ~]# echo $?\n1\n```\n\n### 双括号不用转义 , 直接执行即可\n\n```\n[root@dk-centos6 ~]# [[ \"b\" > \"a\" ]]\n[root@dk-centos6 ~]# echo $?\n0\n[root@dk-centos6 ~]# [[ \"b\" < \"a\" ]]\n[root@dk-centos6 ~]# echo $?\n1\n```\n","content":"<p>shell中 gt 和 &gt; 的一些相关问题介绍和测试</p>\n<a id=\"more\"></a>\n\n\n<blockquote>\n<p>以下是bash的测试, 注意如果你是zsh可能会不同喔😯</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"4\"> [[]] , [] 和test比较 </font>\n</center>\n\n<p>[] 和test:    两者是一样的，在命令行里test expr和[ expr ]的效果相同。test中可用的比较运算符只有==和!=，两者都是用于字符串比较的，不可用于整数比较，整数比较只能使用-eq, -gt这种形式。<br>通过which [ 和which test 可以看到是命令</p>\n<blockquote>\n<p>[] 和test 例子</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># a=<span class=\"string\">\"abcdef\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># test <span class=\"string\">\"$a\"</span> = <span class=\"string\">\"abcdef\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [ <span class=\"string\">\"$a\"</span> = <span class=\"string\">\"abcdef\"</span> ]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<p>[[ ]]具体功能:    </p>\n<ul>\n<li><p>[[是 bash 程序语言的关键字。并不是一个命令，[[ ]] 结构比[ ]结构更加通用。在[[和]]之间所有的字符都不会发生文件名扩展或者单词分割，但是会发生参数扩展和命令替换。</p>\n</li>\n<li><p>支持字符串的模式匹配（使用=~操作符时甚至支持shell的正则表达 式）,右边的字符串不加双引号的情况,可以把右边作为模式. 比如[[ hello == hell? ]]，结果为真。当然加引号就是文本字符串比较.</p>\n</li>\n<li><p>使用[[ … ]]条件判断结构，而不是[ … ]，能够防止脚本中的许多逻辑错误。比如，&amp;&amp;、||、&lt;和&gt; 操作符能够正常存在于[[ ]]条件判断结构中，但是如果出现在[ ]结构中的话，会报错。比如可以直接使用if [[ $a != 1 &amp;&amp; $a != 2 ]], 如果不适用双括号, 则为if [ $a -ne 1] &amp;&amp; [ $a != 2 ]或者if [ $a -ne 1 -a $a != 2 ]。</p>\n</li>\n</ul>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"4\"> 纯数字比较 </font>\n</center>\n\n<h3 id=\"gt-通过比较ASCII值-gt仅能比较数字\"><a href=\"#gt-通过比较ASCII值-gt仅能比较数字\" class=\"headerlink\" title=\"&gt; 通过比较ASCII值,gt仅能比较数字\"></a>&gt; 通过比较ASCII值,gt仅能比较数字</h3><figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># [ 2</span> \\&gt; <span class=\"number\">1</span> ]</span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># echo $?</span></span><br><span class=\"line\"><span class=\"attr\">0</span></span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># [ 2</span> -<span class=\"keyword\">gt</span> <span class=\"number\">1</span> ]</span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># echo $?</span></span><br><span class=\"line\"><span class=\"attr\">0</span></span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># [[ 2</span> &gt; <span class=\"number\">1</span> ]]</span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># echo $?</span></span><br><span class=\"line\"><span class=\"attr\">0</span></span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># [[ 2</span> -<span class=\"keyword\">gt</span> <span class=\"number\">1</span> ]]</span><br><span class=\"line\">[root@dk-ce<span class=\"symbol\">ntos6</span> ~]<span class=\"attr\"># echo $?</span></span><br><span class=\"line\"><span class=\"attr\">0</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"4\"> 字符串比较 </font>\n</center>\n\n<h3 id=\"单括号中如果要比较符号-“-lt-”-“-gt-”-需要转义-否则判断结果错误\"><a href=\"#单括号中如果要比较符号-“-lt-”-“-gt-”-需要转义-否则判断结果错误\" class=\"headerlink\" title=\"单括号中如果要比较符号 “&lt;” “&gt;”, 需要转义, 否则判断结果错误\"></a>单括号中如果要比较符号 “&lt;” “&gt;”, 需要转义, 否则判断结果错误</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [ <span class=\"string\">\"b\"</span> &gt; <span class=\"string\">\"a\"</span> ]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [ <span class=\"string\">\"b\"</span> &lt; <span class=\"string\">\"a\"</span> ]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [ <span class=\"string\">\"b\"</span> \\&lt; <span class=\"string\">\"a\"</span> ]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"双括号不用转义-直接执行即可\"><a href=\"#双括号不用转义-直接执行即可\" class=\"headerlink\" title=\"双括号不用转义 , 直接执行即可\"></a>双括号不用转义 , 直接执行即可</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [[ <span class=\"string\">\"b\"</span> &gt; <span class=\"string\">\"a\"</span> ]]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># [[ <span class=\"string\">\"b\"</span> &lt; <span class=\"string\">\"a\"</span> ]]</span></span><br><span class=\"line\">[root<span class=\"symbol\">@dk</span>-centos6 ~]<span class=\"meta\"># echo $?</span></span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/17/19-shell中gt和>的区别/","categories":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"shell","slug":"linux/shell","permalink":"https://blog.k1s.club/categories/linux/shell/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/tags/linux/"},{"name":"shell","slug":"shell","permalink":"https://blog.k1s.club/tags/shell/"}]},{"title":"收藏链接","date":"2019-10-17T03:19:42.000Z","path":"2019/10/17/18-收藏链接/","text":"记录一些好的网址 容器 云原生图书编年史 云原生大佬博客汇总 (2000个) kubernetes 社群分享 QA 汇总 k8s CRD(CustomResourceDefinition)自定义controller sample k8s 集群部署运营实践总结 k8s 创建一个只读的用户权限 kubectl 创建 Pod 背后到底发生了什么？ 白话Kubernetes网络(推荐) Linux服务 MySQL 5.6, 5.7, 8.0版本的新特性大全 nginx+lua实现灰度发布 计算机网络 根域名的知识 常见状态码 golang go学习指南 go-mod学习 常用的工具网址 不用翻墙就能谷歌 deepl 比谷歌翻译好用的翻译 tableconvert 在线excel转markdown processon 免费在线作图 表情锅 自制表情动图 在线解析 子网掩码换算等 其他文章 Raft 为什么是更易理解的分布式一致性算法 Raft 一步步动态教你理解raft协议 Raft 更多形象化理解","raw":"---\ntitle: 收藏链接\ncopyright: true\ndate: 2019-10-17 11:19:42\ntags:\n  - 收藏\n  - 网址\ncategories:\n  - [网址,收藏]\ntop: 1\n---\n记录一些好的网址\n<!-- more -->\n   \n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 容器 </font>\n</center>\n\n- [云原生图书编年史](https://jimmysong.io/cloud-native/memo/books/)\n- [云原生大佬博客汇总](https://zhangzw001.github.io/2019/10/12/13-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/)\n- [(2000个) kubernetes 社群分享 QA 汇总](https://muzi502.github.io/archives/kubernetes-QA.html)\n- [k8s CRD(CustomResourceDefinition)自定义controller sample](https://github.com/kubernetes/sample-controller/blob/master/README.md)\n- [k8s 集群部署运营实践总结](https://jeremy-xu.oschina.io/2019/11/kubernetes%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E8%BF%90%E8%90%A5%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/)\n- [k8s 创建一个只读的用户权限](http://www.huilog.com/?p=1173)\n- [kubectl 创建 Pod 背后到底发生了什么？](https://fuckcloudnative.io/posts/what-happens-when-k8s/)\n- [白话Kubernetes网络(推荐)](https://juejin.im/entry/599d33ad6fb9a0247804d430)\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> Linux服务 </font>\n</center>\n\n- [MySQL 5.6, 5.7, 8.0版本的新特性大全](https://www.linuxidc.com/Linux/2019-09/160664.htm)\n- [nginx+lua实现灰度发布](https://i4t.com/4070.html)\n- [计算机网络](https://github.com/CavsZhouyou/Front-End-Interview-Notebook/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.md)\n- [根域名的知识](http://www.ruanyifeng.com/blog/2018/05/root-domain.html)\n- [常见状态码](https://developer.qiniu.com/fusion/kb/1425/the-http-status-code-books)\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> golang </font>\n</center>\n\n\n- [go学习指南](https://www.zhihu.com/question/30461290)\n- [go-mod学习](https://zhangguanzhang.github.io/2020/03/10/go-mod-base-use/)\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 常用的工具网址 </font>\n</center>\n\n- [不用翻墙就能谷歌](https://google.fuckcloudnative.io/)\n- [deepl 比谷歌翻译好用的翻译](https://www.deepl.com/translator)\n- [tableconvert 在线excel转markdown](https://tableconvert.com/)\n- [processon 免费在线作图](https://www.processon.com/;jsessionid=F837B3EA415204DD1285A90441329673.jvm1)\n- [表情锅 自制表情动图](https://app.xuty.tk/static/app/index.html)\n- [在线解析 子网掩码换算等](https://www.sojson.com/convert/subnetmask.html)\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 其他文章 </font>\n</center>\n\n- [Raft 为什么是更易理解的分布式一致性算法](https://www.cnblogs.com/mindwind/p/5231986.html)\n- [Raft 一步步动态教你理解raft协议](http://thesecretlivesofdata.com/raft/)\n- [Raft 更多形象化理解](https://raft.github.io/)\n","content":"<p>记录一些好的网址</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 容器 </font>\n</center>\n\n<ul>\n<li><a href=\"https://jimmysong.io/cloud-native/memo/books/\" target=\"_blank\" rel=\"noopener\">云原生图书编年史</a></li>\n<li><a href=\"https://zhangzw001.github.io/2019/10/12/13-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/\" target=\"_blank\" rel=\"noopener\">云原生大佬博客汇总</a></li>\n<li><a href=\"https://muzi502.github.io/archives/kubernetes-QA.html\" target=\"_blank\" rel=\"noopener\">(2000个) kubernetes 社群分享 QA 汇总</a></li>\n<li><a href=\"https://github.com/kubernetes/sample-controller/blob/master/README.md\" target=\"_blank\" rel=\"noopener\">k8s CRD(CustomResourceDefinition)自定义controller sample</a></li>\n<li><a href=\"https://jeremy-xu.oschina.io/2019/11/kubernetes%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E8%BF%90%E8%90%A5%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/\" target=\"_blank\" rel=\"noopener\">k8s 集群部署运营实践总结</a></li>\n<li><a href=\"http://www.huilog.com/?p=1173\" target=\"_blank\" rel=\"noopener\">k8s 创建一个只读的用户权限</a></li>\n<li><a href=\"https://fuckcloudnative.io/posts/what-happens-when-k8s/\" target=\"_blank\" rel=\"noopener\">kubectl 创建 Pod 背后到底发生了什么？</a></li>\n<li><a href=\"https://juejin.im/entry/599d33ad6fb9a0247804d430\" target=\"_blank\" rel=\"noopener\">白话Kubernetes网络(推荐)</a></li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> Linux服务 </font>\n</center>\n\n<ul>\n<li><a href=\"https://www.linuxidc.com/Linux/2019-09/160664.htm\" target=\"_blank\" rel=\"noopener\">MySQL 5.6, 5.7, 8.0版本的新特性大全</a></li>\n<li><a href=\"https://i4t.com/4070.html\" target=\"_blank\" rel=\"noopener\">nginx+lua实现灰度发布</a></li>\n<li><a href=\"https://github.com/CavsZhouyou/Front-End-Interview-Notebook/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.md\" target=\"_blank\" rel=\"noopener\">计算机网络</a></li>\n<li><a href=\"http://www.ruanyifeng.com/blog/2018/05/root-domain.html\" target=\"_blank\" rel=\"noopener\">根域名的知识</a></li>\n<li><a href=\"https://developer.qiniu.com/fusion/kb/1425/the-http-status-code-books\" target=\"_blank\" rel=\"noopener\">常见状态码</a></li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> golang </font>\n</center>\n\n\n<ul>\n<li><a href=\"https://www.zhihu.com/question/30461290\" target=\"_blank\" rel=\"noopener\">go学习指南</a></li>\n<li><a href=\"https://zhangguanzhang.github.io/2020/03/10/go-mod-base-use/\" target=\"_blank\" rel=\"noopener\">go-mod学习</a></li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 常用的工具网址 </font>\n</center>\n\n<ul>\n<li><a href=\"https://google.fuckcloudnative.io/\" target=\"_blank\" rel=\"noopener\">不用翻墙就能谷歌</a></li>\n<li><a href=\"https://www.deepl.com/translator\" target=\"_blank\" rel=\"noopener\">deepl 比谷歌翻译好用的翻译</a></li>\n<li><a href=\"https://tableconvert.com/\" target=\"_blank\" rel=\"noopener\">tableconvert 在线excel转markdown</a></li>\n<li><a href=\"https://www.processon.com/;jsessionid=F837B3EA415204DD1285A90441329673.jvm1\" target=\"_blank\" rel=\"noopener\">processon 免费在线作图</a></li>\n<li><a href=\"https://app.xuty.tk/static/app/index.html\" target=\"_blank\" rel=\"noopener\">表情锅 自制表情动图</a></li>\n<li><a href=\"https://www.sojson.com/convert/subnetmask.html\" target=\"_blank\" rel=\"noopener\">在线解析 子网掩码换算等</a></li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 其他文章 </font>\n</center>\n\n<ul>\n<li><a href=\"https://www.cnblogs.com/mindwind/p/5231986.html\" target=\"_blank\" rel=\"noopener\">Raft 为什么是更易理解的分布式一致性算法</a></li>\n<li><a href=\"http://thesecretlivesofdata.com/raft/\" target=\"_blank\" rel=\"noopener\">Raft 一步步动态教你理解raft协议</a></li>\n<li><a href=\"https://raft.github.io/\" target=\"_blank\" rel=\"noopener\">Raft 更多形象化理解</a></li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/17/18-收藏链接/","categories":[{"name":"网址","slug":"网址","permalink":"https://blog.k1s.club/categories/网址/"},{"name":"收藏","slug":"网址/收藏","permalink":"https://blog.k1s.club/categories/网址/收藏/"}],"tags":[{"name":"收藏","slug":"收藏","permalink":"https://blog.k1s.club/tags/收藏/"},{"name":"网址","slug":"网址","permalink":"https://blog.k1s.club/tags/网址/"}]},{"title":"markdown一些写法记录","date":"2019-10-16T07:56:27.000Z","path":"2019/10/16/17-markdown一些写法记录/","text":"记录一些需要注意的写法,markdown 是支持html语法的 这里想写一个居中的标题和图片1234&lt;center&gt;&lt;img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/&gt;&lt;font color=\"blue\" face=\"黑体\" size=5&gt; 这个就是效果图咯 &lt;/font&gt;&lt;/center&gt; 效果: 这个就是效果图咯 表格模板1234|标题|内容||----|----||标题1|内容1||标题2|内容2| 效果: 标题 内容 标题1 内容1 标题2 内容2","raw":"---\ntitle: markdown一些写法记录\ncopyright: true\ndate: 2019-10-16 15:56:27\ntags:\n  - markdown\ncategories:\n  - [markdown]\ntop: 20\n---\n\n记录一些需要注意的写法,markdown 是支持html语法的\n<!--more-->\n\n### 这里想写一个居中的标题和图片\n\n```\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 这个就是效果图咯 </font>\n</center>\n```\n\n> 效果:\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font color=\"blue\" face=\"黑体\" size=5> 这个就是效果图咯 </font>\n</center>\n\n\n### 表格模板\n```\n|标题|内容|\n|----|----|\n|标题1|内容1|\n|标题2|内容2|\n```\n\n> 效果:\n\n|标题|内容|\n|----|----|\n|标题1|内容1|\n|标题2|内容2|\n","content":"<p>记录一些需要注意的写法,markdown 是支持html语法的</p>\n<a id=\"more\"></a>\n\n<h3 id=\"这里想写一个居中的标题和图片\"><a href=\"#这里想写一个居中的标题和图片\" class=\"headerlink\" title=\"这里想写一个居中的标题和图片\"></a>这里想写一个居中的标题和图片</h3><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"built_in\">center</span>&gt;</span><br><span class=\"line\">&lt;img src=<span class=\"string\">\"//zhangzw001.github.io/images/dockerniu.jpeg\"</span> <span class=\"built_in\">width</span> = <span class=\"string\">\"100\"</span> <span class=\"built_in\">height</span> = <span class=\"string\">\"100\"</span> <span class=\"built_in\">style</span>=<span class=\"string\">\"border: 0\"</span>/&gt;</span><br><span class=\"line\">&lt;<span class=\"built_in\">font</span> <span class=\"built_in\">color</span>=<span class=\"string\">\"blue\"</span> face=<span class=\"string\">\"黑体\"</span> size=<span class=\"number\">5</span>&gt; 这个就是效果图咯 &lt;/<span class=\"built_in\">font</span>&gt;</span><br><span class=\"line\">&lt;/<span class=\"built_in\">center</span>&gt;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>效果:</p>\n</blockquote>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font color=\"blue\" face=\"黑体\" size=\"5\"> 这个就是效果图咯 </font>\n</center>\n\n\n<h3 id=\"表格模板\"><a href=\"#表格模板\" class=\"headerlink\" title=\"表格模板\"></a>表格模板</h3><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|<span class=\"string\">标题</span>|<span class=\"string\">内容</span>|</span><br><span class=\"line\">|<span class=\"string\">----</span>|<span class=\"string\">----</span>|</span><br><span class=\"line\">|<span class=\"string\">标题1</span>|<span class=\"string\">内容1</span>|</span><br><span class=\"line\">|<span class=\"string\">标题2</span>|<span class=\"string\">内容2</span>|</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>效果:</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>标题</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>标题1</td>\n<td>内容1</td>\n</tr>\n<tr>\n<td>标题2</td>\n<td>内容2</td>\n</tr>\n</tbody></table>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/16/17-markdown一些写法记录/","categories":[{"name":"markdown","slug":"markdown","permalink":"https://blog.k1s.club/categories/markdown/"}],"tags":[{"name":"markdown","slug":"markdown","permalink":"https://blog.k1s.club/tags/markdown/"}]},{"title":"Dockerfile介绍","date":"2019-10-16T07:33:17.000Z","path":"2019/10/16/16-dockerfile介绍/","text":"Dockerfile 本文摘录于: 如何快速将容器云镜像大小精简98%？ Dockerfile 文件有自己的书写格式和支持的命令，常用的Dockerfile 指令有： FROM 指定基镜像。 MAINTAINER 设置镜像的作者信息，如作者姓名、邮箱等。 COPY 将文件从本地复制到镜像，拷贝前需要保证本地源文件存在。 ADD 与 COPY 类似，复制文件到镜像。不同的是，如果文件是归档文件（tar, zip, tgz, xz 等），会被自动解压。 ENV 设置环境变量，格式: ENV key=value或ENV key value，运行容器后，可直接在容器中使用。 EXPOSE 暴露容器中指定的端口，只是一个声明，主要用户了解应用监听的端口。 VOLUME 挂载卷到容器，需要注意的是，保存镜像时不会保存卷中的数据。 WORKDIR 设置当前工作目录，后续各层的当前目录都被指定。 RUN 在容器中运行指定的命令。 CMD 容器启动时运行的命令。Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效。CMD 可以被 docker run 之后的参数替换。 ENTRYPOINT 设置容器启动时运行的命令。Dockerfile 中可以有多个 ENTRYPOINT 指令，但只有最后一个生效。CMD 或 docker run 之后的参数会被当做参数传递给 ENTRYPOINT，这个是与CMD的区别。 容器的原理 容器镜像中最重要的概念就是layers，即镜像层。 容器的原理 镜像层依赖于一系列的底层技术，比如文件系统(filesystems)、写时复制(copy-on-write)、联合挂载(union mounts)等技术查看Docker 官方文档https://docs.docker.com/storage/storagedriver/进行学习。 每条指令都创建一个镜像层，会增加镜像的大小 下面看个例子这里我有一个1.2M的镜像 12docker images|grep busyboxbusybox latest 19485c79a9bb 5 weeks ago 1.22MB 我们基于busybox写一个Dockerfile来build 1234567#cat Dockerfilefrom busybox:latestrun mkdir /tmp/dir \\ &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10run rm -f /tmp/dir/file1 执行build 1234567891011121314151617docker build -t busybox-test .Sending build context to Docker daemon 2.048kBStep 1/3 : from busybox:latest ---&gt; 19485c79a9bbStep 2/3 : run mkdir /tmp/dir &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10 ---&gt; Running in 0426f92c77ed10+0 records in10+0 records out10485760 bytes (10.0MB) copied, 0.003785 seconds, 2.6GB/sRemoving intermediate container 0426f92c77ed ---&gt; 5ec75db090c9Step 3/3 : run rm -f /tmp/dir/file1 ---&gt; Running in 540e7d0a5aeaRemoving intermediate container 540e7d0a5aea ---&gt; 00041489cc0eSuccessfully built 00041489cc0eSuccessfully tagged busybox-test:latest 查看image大小 123docker images|grep busyboxbusybox-test latest 00041489cc0e 10 minutes ago 11.7MBbusybox latest 19485c79a9bb 5 weeks ago 1.22MB ??? 我不是rm删除了创建的/tmp/dir/file1 文件吗? 难道它还在? 来,我们测试一下 12# 查看目录下是否有文件docker run -ti busybox-test ls /tmp/dir 结果显然是空… 喔,,, 因为”在Dockerfile中，每条指令都会创建一个镜像层，继而会增加镜像整体的大小”, 在看我们写的Dockerfile,我们第一个run 执行的时候, 这里假装叫 (run1层), 我们生成了file1文件当执行第二个run的时候, 我们处在了 (run2层), (run1层)已经是父层,是个只读层了,只有当前层可写, 虽然我们在 (run2层)删除了这个文件,但删除的仅仅是份拷贝而已, 这就是写时复制. 所以以上的优化应该是: 写成一条run 123456789#cat Dockerfilefrom busybox:latestrun mkdir /tmp/dir \\ &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10 \\ &amp;&amp; rm -f /tmp/dir/file1# builddocker build -t busybox-test2 . 结果显然 1234docker images|grep busyboxbusybox-test2 latest faf8b7d4f140 3 seconds ago 1.22MBbusybox-test latest 00041489cc0e 10 minutes ago 11.7MBbusybox latest 19485c79a9bb 5 weeks ago 1.22MB 虽然说这里的测试没有干任何事情, 但我们在写Dockerfile的时候需要注意, 两个run之间是两个不同的 可写层! 简单总结精简镜像大小的方法: 121 使用更小的基础镜像,注意一些很小的镜像可能缺少很多依赖库,例如查看redis依赖库 ldd /usr/bin/redis-cli2 合并Dockerfilec指令精简(可以的话写成一条run) 一些小的镜像 1 scratch: 一个空的镜像, 无法pull -.-!!! , 写在Dockerfile是可以的 2 alpine: 5M的linux镜像,有包管理工具apk 123FROM scratchADD alpine-minirootfs-3.10.2-x86_64.tar.gz /CMD [\"/bin/sh\"] 3 busybox: 1M多的镜像,称为嵌入式linux的瑞士军刀, Linux和unix一些常用的命令 注意事项 镜像构建的顺序会影响缓存的有效性,经常修改的内容应该放到最后 尽可能的写到同一个RUN,删除不必要的例外 –no-install-recommends, 并且记得删除包管理缓存 rm -rf /var/lib/apt/lists/* 多阶段构建的使用12345678910from maven:3.6-jdk-8-alpine as mavencacheworkdir /optcopy pom.xml .run mvn -e -B xx:xxcopy src ./srcrun mvn -e -B xxfrom openjdk:8-jdk-alpinecopy --from-mavencache /opt/target/xxx.jar /cmd [\"java\", \"-jar\", \"/xxx.jar\"]","raw":"---\ntitle: Dockerfile介绍\ncopyright: true\ndate: 2019-10-16 15:33:17\ntags:\n  - docker\ncategories:\n  - [docker,Dockerfile]\n---\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=5> Dockerfile </font>\n</center>\n\n<!-- more -->\n\n本文摘录于: [如何快速将容器云镜像大小精简98%？](https://mp.weixin.qq.com/s/LOXNMYtZbnYeDR2lBI56fw)\n\n\n### Dockerfile 文件有自己的书写格式和支持的命令，常用的Dockerfile 指令有：\n\n- FROM  指定基镜像。\n- MAINTAINER  设置镜像的作者信息，如作者姓名、邮箱等。\n- COPY  将文件从本地复制到镜像，拷贝前需要保证本地源文件存在。\n- ADD  与 COPY 类似，复制文件到镜像。不同的是，如果文件是归档文件（tar, zip, tgz, xz 等），会被自动解压。\n- ENV  设置环境变量，格式: ENV key=value或ENV key value，运行容器后，可直接在容器中使用。\n- EXPOSE  暴露容器中指定的端口，只是一个声明，主要用户了解应用监听的端口。\n- VOLUME  挂载卷到容器，需要注意的是，保存镜像时不会保存卷中的数据。\n- WORKDIR  设置当前工作目录，后续各层的当前目录都被指定。\n- RUN  在容器中运行指定的命令。\n- CMD  容器启动时运行的命令。Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效。CMD 可以被 docker run 之后的参数替换。\n- ENTRYPOINT  设置容器启动时运行的命令。Dockerfile 中可以有多个 ENTRYPOINT 指令，但只有最后一个生效。CMD 或 docker run 之后的参数会被当做参数传递给 ENTRYPOINT，这个是与CMD的区别。\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=5> 容器的原理 </font>\n</center>\n\n\n容器镜像中最重要的概念就是layers，即镜像层。\n\n> 容器的原理\n\n![容器的原理](/images/16/容器的原理-1.png)\n\n镜像层依赖于一系列的底层技术，比如文件系统(filesystems)、写时复制(copy-on-write)、联合挂载(union mounts)等技术\n查看Docker 官方文档[https://docs.docker.com/storage/storagedriver/](https://docs.docker.com/storage/storagedriver/)进行学习。\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font  face=\"黑体\" size=5> 每条指令都创建一个镜像层，会增加镜像的大小 </font>\n</center>\n\n### 下面看个例子\n\n这里我有一个1.2M的镜像\n```\ndocker images|grep busybox\nbusybox                 latest              19485c79a9bb        5 weeks ago         1.22MB\n```\n\n我们基于busybox写一个Dockerfile来build\n```\n#cat Dockerfile\nfrom busybox:latest\n\nrun mkdir /tmp/dir \\\n    && dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10\n\nrun rm -f /tmp/dir/file1\n\n```\n\n执行build\n```\ndocker build -t busybox-test .\nSending build context to Docker daemon  2.048kB\nStep 1/3 : from busybox:latest\n ---> 19485c79a9bb\nStep 2/3 : run mkdir /tmp/dir     && dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10\n ---> Running in 0426f92c77ed\n10+0 records in\n10+0 records out\n10485760 bytes (10.0MB) copied, 0.003785 seconds, 2.6GB/s\nRemoving intermediate container 0426f92c77ed\n ---> 5ec75db090c9\nStep 3/3 : run rm -f /tmp/dir/file1\n ---> Running in 540e7d0a5aea\nRemoving intermediate container 540e7d0a5aea\n ---> 00041489cc0e\nSuccessfully built 00041489cc0e\nSuccessfully tagged busybox-test:latest\n```\n\n查看image大小\n```\ndocker images|grep busybox\nbusybox-test            latest              00041489cc0e        10 minutes ago      11.7MB\nbusybox                 latest              19485c79a9bb        5 weeks ago         1.22MB\n```\n\n??? 我不是rm删除了创建的/tmp/dir/file1 文件吗? 难道它还在? 来,我们测试一下\n```\n# 查看目录下是否有文件\ndocker run -ti busybox-test ls /tmp/dir\n```\n\n结果显然是空...\n\n喔,,, 因为\"在Dockerfile中，每条指令都会创建一个镜像层，继而会增加镜像整体的大小\", 在看我们写的Dockerfile,\n我们第一个run 执行的时候, 这里假装叫 (run1层), 我们生成了file1文件\n当执行第二个run的时候, 我们处在了 (run2层), (run1层)已经是父层,是个只读层了,只有当前层可写, 虽然我们在 (run2层)删除了这个文件,但删除的仅仅是份拷贝而已, 这就是写时复制.\n\n所以以上的优化应该是: 写成一条run\n```\n#cat Dockerfile\nfrom busybox:latest\n\nrun mkdir /tmp/dir \\\n    && dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10 \\\n    && rm -f /tmp/dir/file1\n\n# build\ndocker build -t busybox-test2 .\n```\n\n结果显然\n```\ndocker images|grep busybox\nbusybox-test2           latest              faf8b7d4f140        3 seconds ago       1.22MB\nbusybox-test            latest              00041489cc0e        10 minutes ago      11.7MB\nbusybox                 latest              19485c79a9bb        5 weeks ago         1.22MB\n```\n\n虽然说这里的测试没有干任何事情, 但我们在写Dockerfile的时候需要注意, 两个run之间是两个不同的 可写层!\n\n简单总结精简镜像大小的方法:\n```\n1 使用更小的基础镜像,注意一些很小的镜像可能缺少很多依赖库,例如查看redis依赖库 ldd /usr/bin/redis-cli\n2 合并Dockerfilec指令精简(可以的话写成一条run)\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font face=\"黑体\" size=5> 一些小的镜像 </font>\n</center>\n\n- 1 scratch: 一个空的镜像, 无法pull -.-!!! , 写在Dockerfile是可以的\n\n- 2 alpine: 5M的linux镜像,有包管理工具apk\n```\nFROM scratch\nADD alpine-minirootfs-3.10.2-x86_64.tar.gz /\nCMD [\"/bin/sh\"]\n```\n\n- 3 busybox: 1M多的镜像,称为嵌入式linux的瑞士军刀, Linux和unix一些常用的命令\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n<font face=\"黑体\" size=5> 注意事项 </font>\n</center>\n\n1. 镜像构建的顺序会影响缓存的有效性,经常修改的内容应该放到最后\n2. 尽可能的写到同一个RUN,删除不必要的例外 --no-install-recommends, 并且记得删除包管理缓存 rm -rf /var/lib/apt/lists/*\n3. 多阶段构建的使用\n```\nfrom maven:3.6-jdk-8-alpine as mavencache\nworkdir /opt\ncopy pom.xml .\nrun mvn -e -B xx:xx\ncopy src ./src\nrun mvn -e -B xx\n\nfrom openjdk:8-jdk-alpine\ncopy --from-mavencache /opt/target/xxx.jar /\ncmd [\"java\", \"-jar\", \"/xxx.jar\"]\n```\n","content":"<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"5\"> Dockerfile </font>\n</center>\n\n<a id=\"more\"></a>\n\n<p>本文摘录于: <a href=\"https://mp.weixin.qq.com/s/LOXNMYtZbnYeDR2lBI56fw\" target=\"_blank\" rel=\"noopener\">如何快速将容器云镜像大小精简98%？</a></p>\n<h3 id=\"Dockerfile-文件有自己的书写格式和支持的命令，常用的Dockerfile-指令有：\"><a href=\"#Dockerfile-文件有自己的书写格式和支持的命令，常用的Dockerfile-指令有：\" class=\"headerlink\" title=\"Dockerfile 文件有自己的书写格式和支持的命令，常用的Dockerfile 指令有：\"></a>Dockerfile 文件有自己的书写格式和支持的命令，常用的Dockerfile 指令有：</h3><ul>\n<li>FROM  指定基镜像。</li>\n<li>MAINTAINER  设置镜像的作者信息，如作者姓名、邮箱等。</li>\n<li>COPY  将文件从本地复制到镜像，拷贝前需要保证本地源文件存在。</li>\n<li>ADD  与 COPY 类似，复制文件到镜像。不同的是，如果文件是归档文件（tar, zip, tgz, xz 等），会被自动解压。</li>\n<li>ENV  设置环境变量，格式: ENV key=value或ENV key value，运行容器后，可直接在容器中使用。</li>\n<li>EXPOSE  暴露容器中指定的端口，只是一个声明，主要用户了解应用监听的端口。</li>\n<li>VOLUME  挂载卷到容器，需要注意的是，保存镜像时不会保存卷中的数据。</li>\n<li>WORKDIR  设置当前工作目录，后续各层的当前目录都被指定。</li>\n<li>RUN  在容器中运行指定的命令。</li>\n<li>CMD  容器启动时运行的命令。Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效。CMD 可以被 docker run 之后的参数替换。</li>\n<li>ENTRYPOINT  设置容器启动时运行的命令。Dockerfile 中可以有多个 ENTRYPOINT 指令，但只有最后一个生效。CMD 或 docker run 之后的参数会被当做参数传递给 ENTRYPOINT，这个是与CMD的区别。</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"5\"> 容器的原理 </font>\n</center>\n\n\n<p>容器镜像中最重要的概念就是layers，即镜像层。</p>\n<blockquote>\n<p>容器的原理</p>\n</blockquote>\n<p><img src=\"/images/16/%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8E%9F%E7%90%86-1.png\" alt=\"容器的原理\"></p>\n<p>镜像层依赖于一系列的底层技术，比如文件系统(filesystems)、写时复制(copy-on-write)、联合挂载(union mounts)等技术<br>查看Docker 官方文档<a href=\"https://docs.docker.com/storage/storagedriver/\" target=\"_blank\" rel=\"noopener\">https://docs.docker.com/storage/storagedriver/</a>进行学习。</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"5\"> 每条指令都创建一个镜像层，会增加镜像的大小 </font>\n</center>\n\n<h3 id=\"下面看个例子\"><a href=\"#下面看个例子\" class=\"headerlink\" title=\"下面看个例子\"></a>下面看个例子</h3><p>这里我有一个1.2M的镜像</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker images|grep busybox</span><br><span class=\"line\">busybox                 latest              <span class=\"number\">19485</span>c79a9bb        <span class=\"number\">5</span> weeks ago         <span class=\"number\">1.22</span>MB</span><br></pre></td></tr></table></figure>\n\n<p>我们基于busybox写一个Dockerfile来build</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cat Dockerfile</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> busybox:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"builtin-name\">run</span> mkdir /tmp/dir \\</span><br><span class=\"line\">    &amp;&amp; dd <span class=\"attribute\">if</span>=/dev/zero <span class=\"attribute\">of</span>=/tmp/dir/file1 <span class=\"attribute\">bs</span>=1M <span class=\"attribute\">count</span>=10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"builtin-name\">run</span> rm -f /tmp/dir/file1</span><br></pre></td></tr></table></figure>\n\n<p>执行build</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t busybox-test .</span><br><span class=\"line\">Sending build context <span class=\"keyword\">to</span> Docker daemon  2.048kB</span><br><span class=\"line\"><span class=\"keyword\">Step</span> 1/3 : <span class=\"keyword\">from</span> busybox:latest</span><br><span class=\"line\"> ---&gt; 19485c79a9bb</span><br><span class=\"line\"><span class=\"keyword\">Step</span> 2/3 : <span class=\"builtin-name\">run</span> mkdir /tmp/dir     &amp;&amp; dd <span class=\"attribute\">if</span>=/dev/zero <span class=\"attribute\">of</span>=/tmp/dir/file1 <span class=\"attribute\">bs</span>=1M <span class=\"attribute\">count</span>=10</span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> 0426f92c77ed</span><br><span class=\"line\">10+0 records <span class=\"keyword\">in</span></span><br><span class=\"line\">10+0 records out</span><br><span class=\"line\">10485760 bytes (10.0MB) copied, 0.003785 seconds, 2.6GB/s</span><br><span class=\"line\">Removing intermediate container 0426f92c77ed</span><br><span class=\"line\"> ---&gt; 5ec75db090c9</span><br><span class=\"line\"><span class=\"keyword\">Step</span> 3/3 : <span class=\"builtin-name\">run</span> rm -f /tmp/dir/file1</span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> 540e7d0a5aea</span><br><span class=\"line\">Removing intermediate container 540e7d0a5aea</span><br><span class=\"line\"> ---&gt; 00041489cc0e</span><br><span class=\"line\">Successfully built 00041489cc0e</span><br><span class=\"line\">Successfully tagged busybox-test:latest</span><br></pre></td></tr></table></figure>\n\n<p>查看image大小</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker images|grep busybox</span><br><span class=\"line\">busybox-test            latest              <span class=\"number\">00041489</span>cc0e        <span class=\"number\">10</span> minutes ago      <span class=\"number\">11.7</span>MB</span><br><span class=\"line\">busybox                 latest              <span class=\"number\">19485</span>c79a9bb        <span class=\"number\">5</span> weeks ago         <span class=\"number\">1.22</span>MB</span><br></pre></td></tr></table></figure>\n\n<p>??? 我不是rm删除了创建的/tmp/dir/file1 文件吗? 难道它还在? 来,我们测试一下</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看目录下是否有文件</span><br><span class=\"line\">docker <span class=\"keyword\">run</span> -ti busybox-<span class=\"keyword\">test</span> <span class=\"keyword\">ls</span> /tmp/<span class=\"keyword\">dir</span></span><br></pre></td></tr></table></figure>\n\n<p>结果显然是空…</p>\n<p>喔,,, 因为”在Dockerfile中，每条指令都会创建一个镜像层，继而会增加镜像整体的大小”, 在看我们写的Dockerfile,<br>我们第一个run 执行的时候, 这里假装叫 (run1层), 我们生成了file1文件<br>当执行第二个run的时候, 我们处在了 (run2层), (run1层)已经是父层,是个只读层了,只有当前层可写, 虽然我们在 (run2层)删除了这个文件,但删除的仅仅是份拷贝而已, 这就是写时复制.</p>\n<p>所以以上的优化应该是: 写成一条run</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cat Dockerfile</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> busybox:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"builtin-name\">run</span> mkdir /tmp/dir \\</span><br><span class=\"line\">    &amp;&amp; dd <span class=\"attribute\">if</span>=/dev/zero <span class=\"attribute\">of</span>=/tmp/dir/file1 <span class=\"attribute\">bs</span>=1M <span class=\"attribute\">count</span>=10 \\</span><br><span class=\"line\">    &amp;&amp; rm -f /tmp/dir/file1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># build</span></span><br><span class=\"line\">docker build -t busybox-test2 .</span><br></pre></td></tr></table></figure>\n\n<p>结果显然</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker images|grep busybox</span><br><span class=\"line\">busybox-test2           latest              faf8b7d4f140        <span class=\"number\">3</span> seconds ago       <span class=\"number\">1.22</span>MB</span><br><span class=\"line\">busybox-test            latest              <span class=\"number\">00041489</span>cc0e        <span class=\"number\">10</span> minutes ago      <span class=\"number\">11.7</span>MB</span><br><span class=\"line\">busybox                 latest              <span class=\"number\">19485</span>c79a9bb        <span class=\"number\">5</span> weeks ago         <span class=\"number\">1.22</span>MB</span><br></pre></td></tr></table></figure>\n\n<p>虽然说这里的测试没有干任何事情, 但我们在写Dockerfile的时候需要注意, 两个run之间是两个不同的 可写层!</p>\n<p>简单总结精简镜像大小的方法:</p>\n<figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>使用更小的基础镜像,注意一些很小的镜像可能缺少很多依赖库,例如查看redis依赖库 ldd /<span class=\"keyword\">usr</span>/bin/redis-cli</span><br><span class=\"line\"><span class=\"symbol\">2 </span>合并Dockerfilec指令精简(可以的话写成一条<span class=\"keyword\">run</span>)</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"5\"> 一些小的镜像 </font>\n</center>\n\n<ul>\n<li><p>1 scratch: 一个空的镜像, 无法pull -.-!!! , 写在Dockerfile是可以的</p>\n</li>\n<li><p>2 alpine: 5M的linux镜像,有包管理工具apk</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> scratch</span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> alpine-minirootfs-3.10.2-x86_64.tar.gz /</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"/bin/sh\"</span>]</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3 busybox: 1M多的镜像,称为嵌入式linux的瑞士军刀, Linux和unix一些常用的命令</p>\n</li>\n</ul>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n<font face=\"黑体\" size=\"5\"> 注意事项 </font>\n</center>\n\n<ol>\n<li>镜像构建的顺序会影响缓存的有效性,经常修改的内容应该放到最后</li>\n<li>尽可能的写到同一个RUN,删除不必要的例外 –no-install-recommends, 并且记得删除包管理缓存 rm -rf /var/lib/apt/lists/*</li>\n<li>多阶段构建的使用<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> maven:<span class=\"number\">3.6</span>-jdk-<span class=\"number\">8</span>-alpine as mavencache</span><br><span class=\"line\"><span class=\"keyword\">workdir</span><span class=\"bash\"> /opt</span></span><br><span class=\"line\"><span class=\"keyword\">copy</span><span class=\"bash\"> pom.xml .</span></span><br><span class=\"line\"><span class=\"keyword\">run</span><span class=\"bash\"> mvn -e -B xx:xx</span></span><br><span class=\"line\"><span class=\"keyword\">copy</span><span class=\"bash\"> src ./src</span></span><br><span class=\"line\"><span class=\"keyword\">run</span><span class=\"bash\"> mvn -e -B xx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> openjdk:<span class=\"number\">8</span>-jdk-alpine</span><br><span class=\"line\"><span class=\"keyword\">copy</span><span class=\"bash\"> --from-mavencache /opt/target/xxx.jar /</span></span><br><span class=\"line\"><span class=\"keyword\">cmd</span><span class=\"bash\"> [<span class=\"string\">\"java\"</span>, <span class=\"string\">\"-jar\"</span>, <span class=\"string\">\"/xxx.jar\"</span>]</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/16/16-dockerfile介绍/","categories":[{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/categories/docker/"},{"name":"Dockerfile","slug":"docker/Dockerfile","permalink":"https://blog.k1s.club/categories/docker/Dockerfile/"}],"tags":[{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/tags/docker/"}]},{"title":"docker简介和使用","date":"2019-10-16T07:31:08.000Z","path":"2019/10/16/15-docker简介和使用/","text":"简单介绍docker dockerk8s支持的docker 版本查看这里我们使用年份命名版本的docker-ce，假设我们要安装v1.16.3的k8s，我们去 https://github.com/kubernetes/kubernetes 里进对应版本的CHANGELOG-1.16.md里搜The list of validated docker versions remain查找支持的docker版本，docker版本不一定得在支持列表里，实际上19.03也能使用，这里我们使用docker官方的安装脚本安装docker(该脚本支持centos和ubuntu) 12export VERSION=19.03curl -fsSL \"https://get.docker.com/\" | bash -s -- --mirror Aliyun","raw":"---\ntitle: docker简介和使用\ncopyright: true\ndate: 2019-10-16 15:31:08\ntags:\n  - docker\ncategories:\n  - [docker]\n\n---\n\n简单介绍docker \n\n<!-- more -->\n\n### docker\n\n### k8s支持的docker 版本查看\n\n这里我们使用年份命名版本的docker-ce，假设我们要安装v1.16.3的k8s，我们去 [https://github.com/kubernetes/kubernetes](https://github.com/kubernetes/kubernetes) 里进对应版本的`CHANGELOG-1.16.md`里搜`The list of validated docker versions remain`查找支持的docker版本，docker版本不一定得在支持列表里，实际上19.03也能使用，这里我们使用docker官方的安装脚本安装docker(该脚本支持centos和ubuntu)\n```\nexport VERSION=19.03\ncurl -fsSL \"https://get.docker.com/\" | bash -s -- --mirror Aliyun\n\n```\n","content":"<p>简单介绍docker </p>\n<a id=\"more\"></a>\n\n<h3 id=\"docker\"><a href=\"#docker\" class=\"headerlink\" title=\"docker\"></a>docker</h3><h3 id=\"k8s支持的docker-版本查看\"><a href=\"#k8s支持的docker-版本查看\" class=\"headerlink\" title=\"k8s支持的docker 版本查看\"></a>k8s支持的docker 版本查看</h3><p>这里我们使用年份命名版本的docker-ce，假设我们要安装v1.16.3的k8s，我们去 <a href=\"https://github.com/kubernetes/kubernetes\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/kubernetes</a> 里进对应版本的<code>CHANGELOG-1.16.md</code>里搜<code>The list of validated docker versions remain</code>查找支持的docker版本，docker版本不一定得在支持列表里，实际上19.03也能使用，这里我们使用docker官方的安装脚本安装docker(该脚本支持centos和ubuntu)</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">export</span> <span class=\"attribute\">VERSION</span>=19.03</span><br><span class=\"line\">curl -fsSL <span class=\"string\">\"https://get.docker.com/\"</span> | bash -s -- --mirror Aliyun</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/16/15-docker简介和使用/","categories":[{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/categories/docker/"}],"tags":[{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/tags/docker/"}]},{"title":"mysql5.5目录copy方式迁移","date":"2019-10-15T02:44:27.000Z","path":"2019/10/15/14-mysql目录copy方式迁移/","text":"从现有的一台 从库 全copy data目录到2台新机器上, 再配置mysql主从 目录copy方式迁移 注意 不要删除ibdata1,会导致innodb表不存在 可以不删除ib_logfile0,ib_logfile1, 但my.cnf配置大小一致 区别目录权限为mysql,tmp目录存在 请自行安装好mysql5.5 1234567891 首先停止mysql/etc/init.d/mysqld stop2 同步数据目录到新机器/data/u013 确认新机器上mysql版本并配置/etc/my.cof4 完整迁移时不需要删除内容(innodb_log_file_size = 256M 配置要一致)5 启动mysql 配置主从 1 首先 目录copy方式 同步某个从库到2台新机器并启动完成, 此时两个mysql都开启了slave 2 暂停同步，并设置读写； 123456stop slave;# 该执行仅主库上执行(配置可写)SET GLOBAL read_only=0;reset slave all;-- RESET SLAVE ALL是清除从库的同步复制信息、包括连接信息和二进制文件名、位置-- 从库上执行这个命令后，使用show slave status将不会有输出。 3 2台新的mysql中修改从库slave配置, 连接到新的主库地址(我这里通过域名解析) 12CHANGE MASTER TO MASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88; 4 由于本机需要安装mysql5.5和mysql5.7所以注意一下 123456# 初始化指定配置文件/usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql57 --datadir=/data/u001# 修改/etc/init.d/mysqld57parse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=\"$mysqld_pid_file_path\" $other_args &gt;/dev/null &amp; 报错统计 ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty. 1执行reset master; The MySQL server is running with the–read-only option so it cannot execute this statement 1执行 set global read_only=0;","raw":"---\ntitle: mysql5.5目录copy方式迁移\ncopyright: true\ndate: 2019-10-15 10:44:27\ntags:\n  - mysql\ncategories:\n  - [技术文档]\n  - [mysql]\n---\n从现有的一台 从库 全copy data目录到2台新机器上, 再配置mysql主从\n<!--more-->\n\n\n### 目录copy方式迁移\n\n>  注意\n\n- 不要删除ibdata1,会导致innodb表不存在\n- 可以不删除ib_logfile0,ib_logfile1, 但my.cnf配置大小一致\n- 区别目录权限为mysql,tmp目录存在\n- 请自行安装好mysql5.5\n\n```\n1 首先停止mysql\n/etc/init.d/mysqld stop\n\n2 同步数据目录到新机器\n/data/u01\n\n3 确认新机器上mysql版本并配置/etc/my.cof\n4 完整迁移时不需要删除内容(innodb_log_file_size = 256M 配置要一致)\n5 启动mysql\n\n```\n\n### 配置主从\n- 1 首先 目录copy方式 同步某个从库到2台新机器并启动完成, 此时两个mysql都开启了slave\n\n- 2 暂停同步，并设置读写；\n\n```\nstop slave;\n# 该执行仅主库上执行(配置可写)\nSET GLOBAL read_only=0;\nreset slave all;\n-- RESET SLAVE ALL是清除从库的同步复制信息、包括连接信息和二进制文件名、位置\n-- 从库上执行这个命令后，使用show slave status将不会有输出。\n```\n\n- 3 2台新的mysql中修改从库slave配置, 连接到新的主库地址(我这里通过域名解析)\n\n```\nCHANGE MASTER TO \nMASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88;\n```\n\n\n- 4 由于本机需要安装mysql5.5和mysql5.7所以注意一下\n\n```\n# 初始化指定配置文件\n/usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql57 --datadir=/data/u001\n\n# 修改/etc/init.d/mysqld57\nparse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`\n$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=\"$mysqld_pid_file_path\" $other_args >/dev/null &\n```\n\n### 报错统计\n- ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.\n\n```\n执行reset master; \n```\n\n- The MySQL server is running with the--read-only option so it cannot execute this statement\n\n```\n执行 set global read_only=0;\n```\n\n\n","content":"<p>从现有的一台 从库 全copy data目录到2台新机器上, 再配置mysql主从</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"目录copy方式迁移\"><a href=\"#目录copy方式迁移\" class=\"headerlink\" title=\"目录copy方式迁移\"></a>目录copy方式迁移</h3><blockquote>\n<p> 注意</p>\n</blockquote>\n<ul>\n<li>不要删除ibdata1,会导致innodb表不存在</li>\n<li>可以不删除ib_logfile0,ib_logfile1, 但my.cnf配置大小一致</li>\n<li>区别目录权限为mysql,tmp目录存在</li>\n<li>请自行安装好mysql5.5</li>\n</ul>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span> 首先停止mysql</span><br><span class=\"line\">/etc/init.d/mysqld stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span> 同步数据目录到新机器</span><br><span class=\"line\">/data/u01</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span> 确认新机器上mysql版本并配置/etc/my.cof</span><br><span class=\"line\"><span class=\"number\">4</span> 完整迁移时不需要删除内容(innodb_log_file_size = <span class=\"number\">256</span>M 配置要一致)</span><br><span class=\"line\"><span class=\"number\">5</span> 启动mysql</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置主从\"><a href=\"#配置主从\" class=\"headerlink\" title=\"配置主从\"></a>配置主从</h3><ul>\n<li><p>1 首先 目录copy方式 同步某个从库到2台新机器并启动完成, 此时两个mysql都开启了slave</p>\n</li>\n<li><p>2 暂停同步，并设置读写；</p>\n</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">stop</span> <span class=\"keyword\">slave</span>;</span><br><span class=\"line\"><span class=\"comment\"># 该执行仅主库上执行(配置可写)</span></span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> read_only=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">reset</span> <span class=\"keyword\">slave</span> <span class=\"keyword\">all</span>;</span><br><span class=\"line\"><span class=\"comment\">-- RESET SLAVE ALL是清除从库的同步复制信息、包括连接信息和二进制文件名、位置</span></span><br><span class=\"line\"><span class=\"comment\">-- 从库上执行这个命令后，使用show slave status将不会有输出。</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>3 2台新的mysql中修改从库slave配置, 连接到新的主库地址(我这里通过域名解析)</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CHANGE</span> <span class=\"keyword\">MASTER</span> <span class=\"keyword\">TO</span> </span><br><span class=\"line\">MASTER_HOST=<span class=\"string\">'a_master.b.com'</span>,MASTER_PORT=<span class=\"number\">3306</span>,MASTER_USER=<span class=\"string\">'repl_user'</span>,MASTER_PASSWORD=<span class=\"string\">'xxxx'</span>,MASTER_LOG_FILE=<span class=\"string\">'m1-master-bin.000001'</span>,MASTER_LOG_POS=<span class=\"number\">88</span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>4 由于本机需要安装mysql5.5和mysql5.7所以注意一下</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 初始化指定配置文件</span></span><br><span class=\"line\">/usr/local/mysql57/bin/mysqld <span class=\"attribute\">--defaults-file</span>=/etc/my57.cnf --initialize-insecure <span class=\"attribute\">--user</span>=mysql <span class=\"attribute\">--basedir</span>=/usr/local/mysql57 <span class=\"attribute\">--datadir</span>=/data/u001</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改/etc/init.d/mysqld57</span></span><br><span class=\"line\">parse_server_arguments `<span class=\"variable\">$print_defaults</span> -c /etc/my57.cnf mysqld<span class=\"built_in\"> server </span>mysql_server mysql.server`</span><br><span class=\"line\"><span class=\"variable\">$bindir</span>/mysqld_safe <span class=\"attribute\">--defaults-file</span>=/etc/my57.cnf <span class=\"attribute\">--pid-file</span>=<span class=\"string\">\"<span class=\"variable\">$mysqld_pid_file_path</span>\"</span> <span class=\"variable\">$other_args</span> &gt;/dev/<span class=\"literal\">null</span> &amp;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"报错统计\"><a href=\"#报错统计\" class=\"headerlink\" title=\"报错统计\"></a>报错统计</h3><ul>\n<li>ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行<span class=\"keyword\">reset</span> <span class=\"keyword\">master</span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>The MySQL server is running with the–read-only option so it cannot execute this statement</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行 <span class=\"builtin-name\">set</span> global <span class=\"attribute\">read_only</span>=0;</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/15/14-mysql目录copy方式迁移/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"}]},{"title":"云原生博客汇总","date":"2019-10-12T08:35:21.000Z","path":"2019/10/12/13-云原生博客汇总/","text":"记录一些云原生技术博客 来自ServiceMesher[8] 群KaiRen’s Blog Zlatan Eevee 国南之境 博客 | 高策 Kakashi’s Blog Alex Wu’s blog | THINK BIG, START SMALL, DELIVER VALUE TO THE BUSINESS 开元DevOps知识库 - 知识管理，时间管理，自我管理 起风了 茶歇驿站 - Gopher, OpenSource Fans, 成长之路有我相伴。 Polar Snow Documentation 云原生实验室 - 米开朗基杨的博客 Jimmy Song - 宋净超的博客|Cloud Native|云原生布道师 漠然的博客 | mritd Blog DevOps – 成长之路 birdben 浮生若梦 CNCF Cloud Native Interactive Landscape 杜屹东的博客 | 学无止境 梦旭随想 ictfox blog CloudNative 架构 我爱西红柿 Doublemine Bingo Huang Arthur Chunqi Li’s Blog Archive | Arthur Chunqi Li’s Blog IT技术工作学习折腾笔记 李佶澳的博客 墨荷琼林官网-编程日志 Archive - Nolla Tomoya’s Blog 君无止境 Jamin Zhang roc - imroc.io|roc的博客|Cloud Native|Kubernetes|Go|Golang Blog | Sysdig sleele的博客 TauCeti blog · TauCeti blog 水晶命匣 | 生命在于折腾，折腾万岁！ 苏洋博客 LinuxTOY Infvie’s Blog | 运维SRE社区博客 Solar MoeLove Hwchiu Learning Notekubernetes/SDN/DevOps 存储领域 yangguanjun","raw":"---\ntitle: 云原生博客汇总\ncopyright: true\ndate: 2019-10-12 16:35:21\ntags:\n  - 云原生\n  - cloud native\n  - 大佬博客\ncategories:\n  - [技术文档]\n  - [网址,大佬博客]\n---\n\n记录一些云原生技术博客\n<!--more-->\n\n### 来自ServiceMesher[8] 群\n\n[KaiRen's Blog](https://k2r2bai.com/)\n\n[Zlatan Eevee](https://ieevee.com/)\n\n[国南之境](https://hansedong.github.io/)\n\n[博客 | 高策](http://gaocegege.com/Blog/)\n\n[Kakashi's Blog](https://kkc.github.io/)\n\n[Alex Wu's blog | THINK BIG, START SMALL, DELIVER VALUE TO THE BUSINESS](https://blog.yaodataking.com/)\n\n[开元DevOps知识库 - 知识管理，时间管理，自我管理](https://nicksors.cc/)\n\n[起风了](https://xuchao918.github.io/)\n\n[茶歇驿站 \\- Gopher, OpenSource Fans, 成长之路有我相伴。](https://maiyang.me/)\n\n[Polar Snow Documentation](https://docs.lvrui.io/)\n\n[云原生实验室 \\- 米开朗基杨的博客](https://www.yangcs.net/)\n\n[Jimmy Song - 宋净超的博客|Cloud Native|云原生布道师](https://jimmysong.io/)\n\n[漠然的博客 | mritd Blog](https://mritd.me/)\n\n[DevOps – 成长之路](http://www.rhca.me/)\n\n[birdben](https://birdben.github.io/)\n\n[浮生若梦](https://fs.tn/)\n\n[CNCF Cloud Native Interactive Landscape](https://landscape.cncf.io/)\n\n[杜屹东的博客 | 学无止境](https://www.duyidong.com/)\n\n[梦旭随想](https://blog.ihypo.net/index.html)\n\n[ictfox blog](http://www.yangguanjun.com/)\n\n[CloudNative 架构](http://team.jiunile.com/)\n\n[我爱西红柿](https://www.bladewan.com/)\n\n[Doublemine](https://notes.doublemine.me/)\n\n[Bingo Huang](https://bingohuang.com/)\n\n[Arthur Chunqi Li's Blog](http://chunqi.li/)\n\n[Archive | Arthur Chunqi Li's Blog](http://chunqi.li/archives/)\n\n[IT技术工作学习折腾笔记 李佶澳的博客](https://www.lijiaocn.com/)\n\n[墨荷琼林官网-编程日志](http://moheqionglin.com/site/blogs/1/list.html)\n\n[Archive - Nolla](https://cmgs.me/archive)\n\n[Tomoya's Blog](https://tomoyadeng.github.io/blog/)\n\n[君无止境](https://youendless.com/)\n\n[Jamin Zhang](https://jaminzhang.github.io/)\n\n[roc - imroc.io|roc的博客|Cloud Native|Kubernetes|Go|Golang](https://imroc.io/)\n\n[Blog | Sysdig](https://sysdig.com/blog/)\n\n[sleele的博客](https://sleele.com/)\n\n[TauCeti blog · TauCeti blog](https://www.tauceti.blog/)\n\n[水晶命匣 | 生命在于折腾，折腾万岁！](http://ghoulich.xninja.org/)\n\n[苏洋博客](https://soulteary.com/)\n\n[LinuxTOY](https://linuxtoy.org/)\n\n[Infvie's Blog | 运维SRE社区博客](https://www.infvie.com/)\n\n[Solar](https://zhangchenchen.github.io/)\n\n[MoeLove](https://moelove.info/)\n\n[Hwchiu Learning Notekubernetes/SDN/DevOps](https://www.hwchiu.com/)\n\n[存储领域 yangguanjun](http://www.yangguanjun.com)\n","content":"<p>记录一些云原生技术博客</p>\n<a id=\"more\"></a>\n\n<h3 id=\"来自ServiceMesher-8-群\"><a href=\"#来自ServiceMesher-8-群\" class=\"headerlink\" title=\"来自ServiceMesher[8] 群\"></a>来自ServiceMesher[8] 群</h3><p><a href=\"https://k2r2bai.com/\" target=\"_blank\" rel=\"noopener\">KaiRen’s Blog</a></p>\n<p><a href=\"https://ieevee.com/\" target=\"_blank\" rel=\"noopener\">Zlatan Eevee</a></p>\n<p><a href=\"https://hansedong.github.io/\" target=\"_blank\" rel=\"noopener\">国南之境</a></p>\n<p><a href=\"http://gaocegege.com/Blog/\" target=\"_blank\" rel=\"noopener\">博客 | 高策</a></p>\n<p><a href=\"https://kkc.github.io/\" target=\"_blank\" rel=\"noopener\">Kakashi’s Blog</a></p>\n<p><a href=\"https://blog.yaodataking.com/\" target=\"_blank\" rel=\"noopener\">Alex Wu’s blog | THINK BIG, START SMALL, DELIVER VALUE TO THE BUSINESS</a></p>\n<p><a href=\"https://nicksors.cc/\" target=\"_blank\" rel=\"noopener\">开元DevOps知识库 - 知识管理，时间管理，自我管理</a></p>\n<p><a href=\"https://xuchao918.github.io/\" target=\"_blank\" rel=\"noopener\">起风了</a></p>\n<p><a href=\"https://maiyang.me/\" target=\"_blank\" rel=\"noopener\">茶歇驿站 - Gopher, OpenSource Fans, 成长之路有我相伴。</a></p>\n<p><a href=\"https://docs.lvrui.io/\" target=\"_blank\" rel=\"noopener\">Polar Snow Documentation</a></p>\n<p><a href=\"https://www.yangcs.net/\" target=\"_blank\" rel=\"noopener\">云原生实验室 - 米开朗基杨的博客</a></p>\n<p><a href=\"https://jimmysong.io/\" target=\"_blank\" rel=\"noopener\">Jimmy Song - 宋净超的博客|Cloud Native|云原生布道师</a></p>\n<p><a href=\"https://mritd.me/\" target=\"_blank\" rel=\"noopener\">漠然的博客 | mritd Blog</a></p>\n<p><a href=\"http://www.rhca.me/\" target=\"_blank\" rel=\"noopener\">DevOps – 成长之路</a></p>\n<p><a href=\"https://birdben.github.io/\" target=\"_blank\" rel=\"noopener\">birdben</a></p>\n<p><a href=\"https://fs.tn/\" target=\"_blank\" rel=\"noopener\">浮生若梦</a></p>\n<p><a href=\"https://landscape.cncf.io/\" target=\"_blank\" rel=\"noopener\">CNCF Cloud Native Interactive Landscape</a></p>\n<p><a href=\"https://www.duyidong.com/\" target=\"_blank\" rel=\"noopener\">杜屹东的博客 | 学无止境</a></p>\n<p><a href=\"https://blog.ihypo.net/index.html\" target=\"_blank\" rel=\"noopener\">梦旭随想</a></p>\n<p><a href=\"http://www.yangguanjun.com/\" target=\"_blank\" rel=\"noopener\">ictfox blog</a></p>\n<p><a href=\"http://team.jiunile.com/\" target=\"_blank\" rel=\"noopener\">CloudNative 架构</a></p>\n<p><a href=\"https://www.bladewan.com/\" target=\"_blank\" rel=\"noopener\">我爱西红柿</a></p>\n<p><a href=\"https://notes.doublemine.me/\" target=\"_blank\" rel=\"noopener\">Doublemine</a></p>\n<p><a href=\"https://bingohuang.com/\" target=\"_blank\" rel=\"noopener\">Bingo Huang</a></p>\n<p><a href=\"http://chunqi.li/\" target=\"_blank\" rel=\"noopener\">Arthur Chunqi Li’s Blog</a></p>\n<p><a href=\"http://chunqi.li/archives/\" target=\"_blank\" rel=\"noopener\">Archive | Arthur Chunqi Li’s Blog</a></p>\n<p><a href=\"https://www.lijiaocn.com/\" target=\"_blank\" rel=\"noopener\">IT技术工作学习折腾笔记 李佶澳的博客</a></p>\n<p><a href=\"http://moheqionglin.com/site/blogs/1/list.html\" target=\"_blank\" rel=\"noopener\">墨荷琼林官网-编程日志</a></p>\n<p><a href=\"https://cmgs.me/archive\" target=\"_blank\" rel=\"noopener\">Archive - Nolla</a></p>\n<p><a href=\"https://tomoyadeng.github.io/blog/\" target=\"_blank\" rel=\"noopener\">Tomoya’s Blog</a></p>\n<p><a href=\"https://youendless.com/\" target=\"_blank\" rel=\"noopener\">君无止境</a></p>\n<p><a href=\"https://jaminzhang.github.io/\" target=\"_blank\" rel=\"noopener\">Jamin Zhang</a></p>\n<p><a href=\"https://imroc.io/\" target=\"_blank\" rel=\"noopener\">roc - imroc.io|roc的博客|Cloud Native|Kubernetes|Go|Golang</a></p>\n<p><a href=\"https://sysdig.com/blog/\" target=\"_blank\" rel=\"noopener\">Blog | Sysdig</a></p>\n<p><a href=\"https://sleele.com/\" target=\"_blank\" rel=\"noopener\">sleele的博客</a></p>\n<p><a href=\"https://www.tauceti.blog/\" target=\"_blank\" rel=\"noopener\">TauCeti blog · TauCeti blog</a></p>\n<p><a href=\"http://ghoulich.xninja.org/\" target=\"_blank\" rel=\"noopener\">水晶命匣 | 生命在于折腾，折腾万岁！</a></p>\n<p><a href=\"https://soulteary.com/\" target=\"_blank\" rel=\"noopener\">苏洋博客</a></p>\n<p><a href=\"https://linuxtoy.org/\" target=\"_blank\" rel=\"noopener\">LinuxTOY</a></p>\n<p><a href=\"https://www.infvie.com/\" target=\"_blank\" rel=\"noopener\">Infvie’s Blog | 运维SRE社区博客</a></p>\n<p><a href=\"https://zhangchenchen.github.io/\" target=\"_blank\" rel=\"noopener\">Solar</a></p>\n<p><a href=\"https://moelove.info/\" target=\"_blank\" rel=\"noopener\">MoeLove</a></p>\n<p><a href=\"https://www.hwchiu.com/\" target=\"_blank\" rel=\"noopener\">Hwchiu Learning Notekubernetes/SDN/DevOps</a></p>\n<p><a href=\"http://www.yangguanjun.com\" target=\"_blank\" rel=\"noopener\">存储领域 yangguanjun</a></p>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/12/13-云原生博客汇总/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"网址","slug":"网址","permalink":"https://blog.k1s.club/categories/网址/"},{"name":"大佬博客","slug":"网址/大佬博客","permalink":"https://blog.k1s.club/categories/网址/大佬博客/"}],"tags":[{"name":"云原生","slug":"云原生","permalink":"https://blog.k1s.club/tags/云原生/"},{"name":"cloud native","slug":"cloud-native","permalink":"https://blog.k1s.club/tags/cloud-native/"},{"name":"大佬博客","slug":"大佬博客","permalink":"https://blog.k1s.club/tags/大佬博客/"}]},{"title":"awk简单记录","date":"2019-10-11T07:23:48.000Z","path":"2019/10/11/12-awk简单记录/","text":"记录一些简单使用 实例1: 计算nginx日志中某个接口的次数和平均响应时间例如我的a.txt nginx日志格式如下12a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] \"GET /v1/actionname?xxxx HTTP/1.1\" 200 386 \"-\" \"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\" \"-\" \"0.023\"a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] \"GET /v1/actionname2?xxxx HTTP/1.1\" 200 386 \"-\" \"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\" \"-\" \"0.016\" 这里我只想取出接口名: /v1/actionname 和 0.023 响应时间 首先我取出这两列1234567cat a.txt|awk -F '\"' '&#123;print $(NF-1),$2&#125;'|awk -F '?' '&#123;print $1&#125;'|awk '&#123;print $1\" \"$3&#125;' &gt; b.txtcat b.txt0.023 /v1/actionname0.016 /v1/actionname2... 命令详解12345678&gt; 第一步 响应时间求和&#123;s[$2]+=$1&#125;: 每遇到一个$2,比如遇到/v1/actionname,记录一个数组s[/v1/actionname] = 所有$1的值的总和&gt; 第二步 算接口的次数&#123;m[$2]++&#125;: 每遇到一个$2,比如遇到/v1/actionname,记录一个数组m[/v1/actionname] = 所有$1的个数&gt; 第三步 取平均值# 这里输出csv文件cat b.txt|awk '&#123;m[$2]++&#125; &#123;s[$2]+=$1&#125; ; END &#123;for(i in m) &#123;print s[i]/m[i] \",\" m[i] \",\" i&#125;&#125;'|awk -F \",\" '$2 &gt; 20'|sort -k2nr &gt; test.csv 例如计算总响应时间,总数,平均值12345678# 这里$17 是接口名 : /v4.5/?xxx , $4 是响应时间 # 每遇到一个$17, 就把$4响应时间累加存到 s中, s可能是 s[\"/v4.5/?xxx\"]=4.75, s[\"/v3.8/?xxx\"]=1.469# 同理m一样, m[\"/v4.5/?xxx\"]=313, m[\"/v3.8/?xxx\"]=64tail -1000 openapi.access.log |awk '&#123;s[$17]+=$4&#125; &#123;m[$17]++&#125; END &#123;for(i in s) &#123;print m[i],\"\\t\",s[i],\"\\t\",s[i]/m[i],\"\\t\",i&#125; &#125;'|sort -k1nr|head -10313 4.75 0.0151757 /v4.5/?xxx64 1.469 0.0229531 /v3.8/?xxx","raw":"---\ntitle: awk简单记录\ncopyright: true\ndate: 2019-10-11 15:23:48\ntags:\n  - linux\n  - awk \ncategories:\n  - [linux,awk]\n---\n\n记录一些简单使用\n<!-- more -->\n\n\n### 实例1: 计算nginx日志中某个接口的次数和平均响应时间\n#### 例如我的a.txt nginx日志格式如下\n\n```\na.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] \"GET /v1/actionname?xxxx HTTP/1.1\" 200 386 \"-\" \"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\" \"-\" \"0.023\"\na.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] \"GET /v1/actionname2?xxxx HTTP/1.1\" 200 386 \"-\" \"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\" \"-\" \"0.016\"\n```\n\n> 这里我只想取出接口名: /v1/actionname 和 0.023 响应时间\n\n#### 首先我取出这两列\n```\ncat a.txt|awk -F '\"' '{print $(NF-1),$2}'|awk -F '?' '{print $1}'|awk '{print $1\" \"$3}' > b.txt\n\n\ncat b.txt\n0.023 /v1/actionname\n0.016 /v1/actionname2\n...\n```\n\n\n#### 命令详解\n```\n> 第一步 响应时间求和\n{s[$2]+=$1}: 每遇到一个$2,比如遇到/v1/actionname,记录一个数组s[/v1/actionname] = 所有$1的值的总和\n> 第二步 算接口的次数\n{m[$2]++}:  每遇到一个$2,比如遇到/v1/actionname,记录一个数组m[/v1/actionname] = 所有$1的个数\n> 第三步 取平均值\n\n# 这里输出csv文件\ncat b.txt|awk '{m[$2]++} {s[$2]+=$1} ; END {for(i in m) {print s[i]/m[i] \",\" m[i] \",\" i}}'|awk -F \",\" '$2 > 20'|sort -k2nr > test.csv\n```\n\n#### 例如计算总响应时间,总数,平均值\n```\n# 这里$17 是接口名 : /v4.5/?xxx , $4 是响应时间 \n# 每遇到一个$17, 就把$4响应时间累加存到 s中,  s可能是 s[\"/v4.5/?xxx\"]=4.75, s[\"/v3.8/?xxx\"]=1.469\n# 同理m一样,  m[\"/v4.5/?xxx\"]=313, m[\"/v3.8/?xxx\"]=64\n\ntail -1000 openapi.access.log |awk '{s[$17]+=$4} {m[$17]++} END {for(i in s) {print m[i],\"\\t\",s[i],\"\\t\",s[i]/m[i],\"\\t\",i} }'|sort -k1nr|head -10\n\n313   4.75   0.0151757   /v4.5/?xxx\n64   1.469   0.0229531   /v3.8/?xxx\n```\n\n","content":"<p>记录一些简单使用</p>\n<a id=\"more\"></a>\n\n\n<h3 id=\"实例1-计算nginx日志中某个接口的次数和平均响应时间\"><a href=\"#实例1-计算nginx日志中某个接口的次数和平均响应时间\" class=\"headerlink\" title=\"实例1: 计算nginx日志中某个接口的次数和平均响应时间\"></a>实例1: 计算nginx日志中某个接口的次数和平均响应时间</h3><h4 id=\"例如我的a-txt-nginx日志格式如下\"><a href=\"#例如我的a-txt-nginx日志格式如下\" class=\"headerlink\" title=\"例如我的a.txt nginx日志格式如下\"></a>例如我的a.txt nginx日志格式如下</h4><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a.b.com <span class=\"number\">1.1.1.1</span> <span class=\"string\">[08/Sep/2019:23:57:01 +0800]</span> <span class=\"string\">\"<span class=\"keyword\">GET</span> /v1/actionname?xxxx HTTP/1.1\"</span> <span class=\"number\">200</span> <span class=\"number\">386</span> <span class=\"string\">\"-\"</span> <span class=\"string\">\"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\"</span> <span class=\"string\">\"-\"</span> <span class=\"string\">\"0.023\"</span></span><br><span class=\"line\">a.b.com <span class=\"number\">1.1.1.1</span> <span class=\"string\">[08/Sep/2019:23:57:01 +0800]</span> <span class=\"string\">\"<span class=\"keyword\">GET</span> /v1/actionname2?xxxx HTTP/1.1\"</span> <span class=\"number\">200</span> <span class=\"number\">386</span> <span class=\"string\">\"-\"</span> <span class=\"string\">\"Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36\"</span> <span class=\"string\">\"-\"</span> <span class=\"string\">\"0.016\"</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里我只想取出接口名: /v1/actionname 和 0.023 响应时间</p>\n</blockquote>\n<h4 id=\"首先我取出这两列\"><a href=\"#首先我取出这两列\" class=\"headerlink\" title=\"首先我取出这两列\"></a>首先我取出这两列</h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">cat</span> a.txt|awk -F <span class=\"string\">'\"'</span> <span class=\"string\">'&#123;print $(NF-1),<span class=\"variable\">$2</span>&#125;'</span>|awk -F <span class=\"string\">'?'</span> <span class=\"string\">'&#123;print <span class=\"variable\">$1</span>&#125;'</span>|awk <span class=\"string\">'&#123;print <span class=\"variable\">$1</span>\" \"<span class=\"variable\">$3</span>&#125;'</span> &gt; b.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cat b.txt</span><br><span class=\"line\"><span class=\"number\">0</span>.<span class=\"number\">023</span> /v1/actionname</span><br><span class=\"line\"><span class=\"number\">0</span>.<span class=\"number\">016</span> /v1/actionname2</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"命令详解\"><a href=\"#命令详解\" class=\"headerlink\" title=\"命令详解\"></a>命令详解</h4><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 第一步 响应时间求和</span><br><span class=\"line\">&#123;s[<span class=\"variable\">$2</span>]+=<span class=\"variable\">$1&#125;</span>: 每遇到一个<span class=\"variable\">$2</span>,比如遇到/v1/actionname,记录一个数组s[/v1/actionname] = 所有<span class=\"variable\">$1</span>的值的总和</span><br><span class=\"line\">&gt; 第二步 算接口的次数</span><br><span class=\"line\">&#123;<span class=\"keyword\">m</span>[<span class=\"variable\">$2</span>]++&#125;:  每遇到一个<span class=\"variable\">$2</span>,比如遇到/v1/actionname,记录一个数组<span class=\"keyword\">m</span>[/v1/actionname] = 所有<span class=\"variable\">$1</span>的个数</span><br><span class=\"line\">&gt; 第三步 取平均值</span><br><span class=\"line\"></span><br><span class=\"line\"># 这里输出csv文件</span><br><span class=\"line\"><span class=\"keyword\">cat</span> b.txt|awk '&#123;<span class=\"keyword\">m</span>[<span class=\"variable\">$2</span>]++&#125; &#123;s[<span class=\"variable\">$2</span>]+=<span class=\"variable\">$1&#125;</span> ; END &#123;<span class=\"keyword\">for</span>(i <span class=\"keyword\">in</span> <span class=\"keyword\">m</span>) &#123;<span class=\"keyword\">print</span> s[i]/<span class=\"keyword\">m</span>[i] <span class=\"string\">\",\"</span> <span class=\"keyword\">m</span>[i] <span class=\"string\">\",\"</span> i&#125;&#125;'|awk -F <span class=\"string\">\",\"</span> '<span class=\"variable\">$2</span> &gt; 20'|<span class=\"keyword\">sort</span> -k2nr &gt; <span class=\"keyword\">test</span>.csv</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"例如计算总响应时间-总数-平均值\"><a href=\"#例如计算总响应时间-总数-平均值\" class=\"headerlink\" title=\"例如计算总响应时间,总数,平均值\"></a>例如计算总响应时间,总数,平均值</h4><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 这里<span class=\"variable\">$17</span> 是接口名 : /v4.5/?xxx , <span class=\"variable\">$4</span> 是响应时间 </span><br><span class=\"line\"># 每遇到一个<span class=\"variable\">$17</span>, 就把<span class=\"variable\">$4</span>响应时间累加存到 s中,  s可能是 s[<span class=\"string\">\"/v4.5/?xxx\"</span>]=4.75, s[<span class=\"string\">\"/v3.8/?xxx\"</span>]=1.469</span><br><span class=\"line\"># 同理<span class=\"keyword\">m</span>一样,  <span class=\"keyword\">m</span>[<span class=\"string\">\"/v4.5/?xxx\"</span>]=313, <span class=\"keyword\">m</span>[<span class=\"string\">\"/v3.8/?xxx\"</span>]=64</span><br><span class=\"line\"></span><br><span class=\"line\">tail -1000 openapi.access.<span class=\"keyword\">log</span> |awk '&#123;s[<span class=\"variable\">$17</span>]+=<span class=\"variable\">$4&#125;</span> &#123;<span class=\"keyword\">m</span>[<span class=\"variable\">$17</span>]++&#125; END &#123;<span class=\"keyword\">for</span>(i <span class=\"keyword\">in</span> s) &#123;<span class=\"keyword\">print</span> <span class=\"keyword\">m</span>[i],<span class=\"string\">\"\\t\"</span>,s[i],<span class=\"string\">\"\\t\"</span>,s[i]/<span class=\"keyword\">m</span>[i],<span class=\"string\">\"\\t\"</span>,i&#125; &#125;'|<span class=\"keyword\">sort</span> -k1nr|head -10</span><br><span class=\"line\"></span><br><span class=\"line\">313   4.75   0.0151757   /v4.5/?xxx</span><br><span class=\"line\">64   1.469   0.0229531   /v3.8/?xxx</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/11/12-awk简单记录/","categories":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"awk","slug":"linux/awk","permalink":"https://blog.k1s.club/categories/linux/awk/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/tags/linux/"},{"name":"awk","slug":"awk","permalink":"https://blog.k1s.club/tags/awk/"}]},{"title":"mysql简单记录","date":"2019-10-10T02:40:20.000Z","path":"2019/10/10/11-mysql简单记录/","text":"简单记录一些mysql知识点 SQL 语句主要可以划分为以下 3 个类别123DDL（Data Definition Languages）语句：数据定义语言，这些语句定义了不同的数据段、数据库、表、列、索引等数据库对象的定义。常用的语句关键字主要包括 create、drop、alter等。DML（Data Manipulation Language）语句：数据操纵语句，用于添加、删除、更新和查询数据库记录，并检查数据完整性，常用的语句关键字主要包括 insert、delete、udpate 和select 等。(增添改查）DCL（Data Control Language）语句：数据控制语句，用于控制不同数据段直接的许可和访问级别的语句。这些语句定义了数据库、表、字段、用户的访问权限和安全级别。主要的语句关键字包括 grant、revoke 等。 清空表123456789删除表信息的方式有两种 :truncate table table_name;delete * from table_name;注 : truncate操作中的table可以省略，delete操作中的*可以省略truncate、delete 清空表数据的区别 :1&gt; truncate 是整体删除 (速度较快)，delete是逐条删除 (速度较慢)2&gt; truncate 不写服务器 log，delete 写服务器 log，也就是 truncate 效率比 delete高的原因3&gt; truncate 不激活trigger (触发器)，但是会重置Identity (标识列、自增字段)，相当于自增列会被置为初始值，又重新从1开始记录，而不是接着原来的 ID数。而 delete 删除以后，identity 依旧是接着被删除的最近的那一条记录ID加1后进行记录。如果只需删除表中的部分记录，只能使用 DELETE语句配合 where条件 备份12345# 全量锁表备份(不可写)mysqldump --lock-all-tables --all-databases &gt; ALLDB.sql# 仅导出所有表的结构mysqldump --opt -d 数据库名 -u root -p &gt; xxx.sql slave 中修改master_host12345678910# 查看 master.info中信息# 查看 show slave status\\G 中 Master_Host# 修改的步骤需要先停止slave1 stop slave ;2 change master to master_host='xxx.xxx.xxx'; 首次配置主库: CHANGE MASTER TO MASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88;3 start slave ; mysql问题: navicat连接数据库很慢123456报错: 2013-Lost connection to MYSQL server at 'reading for initial communication packet'说明: 只有windows 的navicat会出现上面报错, windows上通过mysql命令连接时 也很慢#添加如下内容:[mysqld]skip-name-resolve mysql问题: mysql5.7 错误总结-ERROR 1067 (42000): Invalid default value for TIMESTAMP123456show variables like 'sql_mode';+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+| Variable_name | Value |+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+| sql_mode | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+ 这是因为sql_mode中的NO_ZEROR_DATE导制的，在strict mode中不允许’0000-00-00’作为合法日期 将上面的NO_ZERO_DATE改为下面的 ALLOW_INVALID_DATES 12set sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';set session sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'; 上面的设置是临时设置，在重新登陆后，该设置又恢复为NO_ZERO_DATE mysql5.5主+mysql5.7从 问题123ERROR 1794 (HY000): Slave is not configured or failed to initialize properly. You must at least set --server-id to enable either a master or a slave. Additional error messages can be found in the MySQL error log.server_uuid是5.6的gtid特性引入的一个配置，把mysql5.7的 rpl_slave.cc文件中get_master_uuid函数换成5.6对应的函数就可以了。 mysql一些info信息统计123456789101112131415161718#tbl_size.sqluse information_schema;SELECT TABLE_NAME, ENGINE, ROUND((DATA_LENGTH/1024/1024),2) as DataM , ROUND((INDEX_LENGTH/1024/1024),2) as IndexM, ROUND(((DATA_LENGTH+INDEX_LENGTH)/1024/1024),2) as AllM, TABLE_ROWS, TABLE_COMMENTFROM TABLESWHERE TABLE_SCHEMA = 'hzkj_zh'ORDER BY AllM DESC;# 生成excel表格mysql test &lt;tbl_size.sql &gt;tbl_info_20191028.txt 跳过主从同步错误1234stop slave;SET GLOBAL sql_slave_skip_counter =1;start slave;show slave status\\G; mysql information_schema.TABLES表中的table_rows 字段值与’count(*)’ 值不同 查看information_schema 123456789101112131415use information_schema;SELECT TABLE_NAME, TABLE_ROWSFROM TABLESWHERE TABLE_SCHEMA = 'zz' and TABLE_NAME = 'zzz';+---------------------+------------+| TABLE_NAME | TABLE_ROWS |+---------------------+------------+| zzz | 42411396 |+---------------------+------------+ 但是会发现和 1\" select count(*) from 某张表; \" 执行得到的值是不相同的！那是因为： 1: 默认情况下 mysql 对表进行增删操作时，是不会自动更新 information_schema 库中 tables 表的 table_rows 字段的，在网上搜索一下发现说：只有10%的行数发生变化才会自动收集（没有亲自验证过！）； 2: 执行 Analyze table tableName; 会统计所有表数据（在生产环境中不建议使用，因为会锁表！）；原文链接：mysql information_schema.TABLES表中的table_rows 字段值与count值不同","raw":"---\ntitle: mysql简单记录\ncopyright: true\ndate: 2019-10-10 10:40:20\ntags:\n  - mysql\ncategories:\n  - [技术文档]\n  - [mysql]\n---\n简单记录一些mysql知识点\n<!-- more -->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### SQL 语句主要可以划分为以下 3 个类别\n\n```\nDDL（Data Definition Languages）语句：数据定义语言，这些语句定义了不同的数据段、数据库、表、列、索引等数据库对象的定义。常用的语句关键字主要包括 create、drop、alter等。\nDML（Data Manipulation Language）语句：数据操纵语句，用于添加、删除、更新和查询数据库记录，并检查数据完整性，常用的语句关键字主要包括 insert、delete、udpate 和select 等。(增添改查）\nDCL（Data Control Language）语句：数据控制语句，用于控制不同数据段直接的许可和访问级别的语句。这些语句定义了数据库、表、字段、用户的访问权限和安全级别。主要的语句关键字包括 grant、revoke 等。\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 清空表\n```\n删除表信息的方式有两种 :\ntruncate table table_name;\ndelete * from table_name;\n注 : truncate操作中的table可以省略，delete操作中的*可以省略\n\ntruncate、delete 清空表数据的区别 :\n1> truncate 是整体删除 (速度较快)，delete是逐条删除 (速度较慢)\n2> truncate 不写服务器 log，delete 写服务器 log，也就是 truncate 效率比 delete高的原因\n3> truncate 不激活trigger (触发器)，但是会重置Identity (标识列、自增字段)，相当于自增列会被置为初始值，又重新从1开始记录，而不是接着原来的 ID数。而 delete 删除以后，identity 依旧是接着被删除的最近的那一条记录ID加1后进行记录。如果只需删除表中的部分记录，只能使用 DELETE语句配合 where条件\n\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 备份\n```\n# 全量锁表备份(不可写)\nmysqldump --lock-all-tables --all-databases > ALLDB.sql\n\n# 仅导出所有表的结构\nmysqldump --opt -d 数据库名 -u root -p > xxx.sql\n\n\n```\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### slave 中修改master_host\n```\n# 查看 master.info中信息\n\n# 查看 show slave status\\G 中 Master_Host\n\n# 修改的步骤需要先停止slave\n1 stop slave ;\n2 change master to master_host='xxx.xxx.xxx';\n  首次配置主库:\n  CHANGE MASTER TO MASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88;\n3 start slave ;\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### mysql问题: navicat连接数据库很慢\n```\n报错: 2013-Lost connection to MYSQL server at 'reading for initial communication packet'\n说明: 只有windows 的navicat会出现上面报错, windows上通过mysql命令连接时 也很慢\n\n#添加如下内容:\n[mysqld]\nskip-name-resolve\n```\n\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### mysql问题: mysql5.7 错误总结-ERROR 1067 (42000): Invalid default value for TIMESTAMP\n```\nshow variables like 'sql_mode';\n+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n| Variable_name | Value                                                                                                                                     |\n+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n| sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |\n+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+\n```\n这是因为sql_mode中的NO_ZEROR_DATE导制的，在strict mode中不允许'0000-00-00'作为合法日期\n\n将上面的NO_ZERO_DATE改为下面的 ALLOW_INVALID_DATES\n```\nset sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';\nset session  sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';\n\n```\n上面的设置是临时设置，在重新登陆后，该设置又恢复为NO_ZERO_DATE\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### mysql5.5主+mysql5.7从 问题\n```\nERROR 1794 (HY000): Slave is not configured or failed to initialize properly. You must at least set --server-id to enable either a master or a slave. Additional error messages can be found in the MySQL error log.\nserver_uuid是5.6的gtid特性引入的一个配置，\n把mysql5.7的 rpl_slave.cc文件中get_master_uuid函数换成5.6对应的函数就可以了。\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### mysql一些info信息统计\n```\n#tbl_size.sql\nuse information_schema;\nSELECT\n    TABLE_NAME,\n ENGINE,\n    ROUND((DATA_LENGTH/1024/1024),2) as DataM ,\n    ROUND((INDEX_LENGTH/1024/1024),2) as IndexM,\n    ROUND(((DATA_LENGTH+INDEX_LENGTH)/1024/1024),2) as AllM,\n    TABLE_ROWS,\n TABLE_COMMENT\nFROM\n    TABLES\nWHERE\n    TABLE_SCHEMA = 'hzkj_zh'\nORDER BY AllM DESC;\n\n# 生成excel表格\nmysql test <tbl_size.sql >tbl_info_20191028.txt\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 跳过主从同步错误\n```\nstop slave;\nSET GLOBAL sql_slave_skip_counter =1;\nstart slave;\nshow slave status\\G; \n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### mysql information_schema.TABLES表中的table_rows 字段值与'count(*)' 值不同\n\n> 查看information_schema\n```\nuse information_schema;\nSELECT\n    TABLE_NAME,\n    TABLE_ROWS\nFROM\n    TABLES\nWHERE\n    TABLE_SCHEMA = 'zz' and TABLE_NAME = 'zzz';\n\n\n+---------------------+------------+\n| TABLE_NAME          | TABLE_ROWS |\n+---------------------+------------+\n|      zzz            |   42411396 |\n+---------------------+------------+\n```\n\n但是会发现和\n```\n\" select count(*) from 某张表; \"\n```\n\n执行得到的值是不相同的！那是因为：\n\n- 1: 默认情况下 mysql 对表进行增删操作时，是不会自动更新 information_schema 库中 tables 表的 table_rows 字段的，在网上搜索一下发现说：只有10%的行数发生变化才会自动收集（没有亲自验证过！）；\n- 2: 执行 Analyze table tableName; 会统计所有表数据（在生产环境中不建议使用，因为会锁表！）；\n原文链接：[mysql information_schema.TABLES表中的table_rows 字段值与count值不同](https://blog.csdn.net/David_jiahuan/article/details/98478740)\n","content":"<p>简单记录一些mysql知识点</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"SQL-语句主要可以划分为以下-3-个类别\"><a href=\"#SQL-语句主要可以划分为以下-3-个类别\" class=\"headerlink\" title=\"SQL 语句主要可以划分为以下 3 个类别\"></a>SQL 语句主要可以划分为以下 3 个类别</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DDL（Data Definition Languages）语句：数据定义语言，这些语句定义了不同的数据段、数据库、表、列、索引等数据库对象的定义。常用的语句关键字主要包括 <span class=\"keyword\">create</span>、<span class=\"keyword\">drop</span>、<span class=\"keyword\">alter</span>等。</span><br><span class=\"line\">DML（<span class=\"keyword\">Data</span> Manipulation <span class=\"keyword\">Language</span>）语句：数据操纵语句，用于添加、删除、更新和查询数据库记录，并检查数据完整性，常用的语句关键字主要包括 <span class=\"keyword\">insert</span>、<span class=\"keyword\">delete</span>、udpate 和<span class=\"keyword\">select</span> 等。(增添改查）</span><br><span class=\"line\">DCL（<span class=\"keyword\">Data</span> Control <span class=\"keyword\">Language</span>）语句：数据控制语句，用于控制不同数据段直接的许可和访问级别的语句。这些语句定义了数据库、表、字段、用户的访问权限和安全级别。主要的语句关键字包括 <span class=\"keyword\">grant</span>、<span class=\"keyword\">revoke</span> 等。</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"清空表\"><a href=\"#清空表\" class=\"headerlink\" title=\"清空表\"></a>清空表</h3><figure class=\"highlight erlang-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">删除表信息的方式有两种 :</span><br><span class=\"line\">truncate table table_name;</span><br><span class=\"line\">delete * from table_name;</span><br><span class=\"line\">注 : truncate操作中的table可以省略，delete操作中的*可以省略</span><br><span class=\"line\"></span><br><span class=\"line\">truncate、delete 清空表数据的区别 :</span><br><span class=\"line\"><span class=\"meta\">1&gt; </span>truncate 是整体删除 (速度较快)，delete是逐条删除 (速度较慢)</span><br><span class=\"line\"><span class=\"meta\">2&gt; </span>truncate 不写服务器 log，delete 写服务器 log，也就是 truncate 效率比 delete高的原因</span><br><span class=\"line\"><span class=\"meta\">3&gt; </span>truncate 不激活trigger (触发器)，但是会重置Identity (标识列、自增字段)，相当于自增列会被置为初始值，又重新从<span class=\"number\">1</span>开始记录，而不是接着原来的 ID数。而 delete 删除以后，identity 依旧是接着被删除的最近的那一条记录ID加<span class=\"number\">1</span>后进行记录。如果只需删除表中的部分记录，只能使用 DELETE语句配合 where条件</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"备份\"><a href=\"#备份\" class=\"headerlink\" title=\"备份\"></a>备份</h3><figure class=\"highlight dsconfig\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 全量锁表备份(不可写)</span></span><br><span class=\"line\"><span class=\"string\">mysqldump </span><span class=\"built_in\">--lock-all-tables</span> <span class=\"built_in\">--all-databases</span> &gt; <span class=\"string\">ALLDB.</span><span class=\"string\">sql</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#</span> 仅导出所有表的结构</span><br><span class=\"line\"><span class=\"string\">mysqldump </span><span class=\"built_in\">--opt</span> -d 数据库名 -u <span class=\"string\">root </span>-p &gt; <span class=\"string\">xxx.</span><span class=\"string\">sql</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"slave-中修改master-host\"><a href=\"#slave-中修改master-host\" class=\"headerlink\" title=\"slave 中修改master_host\"></a>slave 中修改master_host</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 master.info中信息</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 show slave status\\G 中 Master_Host</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改的步骤需要先停止slave</span></span><br><span class=\"line\">1 <span class=\"keyword\">stop</span> <span class=\"keyword\">slave</span> ;</span><br><span class=\"line\">2 <span class=\"keyword\">change</span> <span class=\"keyword\">master</span> <span class=\"keyword\">to</span> master_host=<span class=\"string\">'xxx.xxx.xxx'</span>;</span><br><span class=\"line\">  首次配置主库:</span><br><span class=\"line\">  <span class=\"keyword\">CHANGE</span> <span class=\"keyword\">MASTER</span> <span class=\"keyword\">TO</span> MASTER_HOST=<span class=\"string\">'a_master.b.com'</span>,MASTER_PORT=<span class=\"number\">3306</span>,MASTER_USER=<span class=\"string\">'repl_user'</span>,MASTER_PASSWORD=<span class=\"string\">'xxxx'</span>,MASTER_LOG_FILE=<span class=\"string\">'m1-master-bin.000001'</span>,MASTER_LOG_POS=<span class=\"number\">88</span>;</span><br><span class=\"line\">3 <span class=\"keyword\">start</span> <span class=\"keyword\">slave</span> ;</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"mysql问题-navicat连接数据库很慢\"><a href=\"#mysql问题-navicat连接数据库很慢\" class=\"headerlink\" title=\"mysql问题: navicat连接数据库很慢\"></a>mysql问题: navicat连接数据库很慢</h3><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">报错: <span class=\"number\">2013</span>-Lost connection <span class=\"keyword\">to</span> MYSQL server <span class=\"keyword\">at</span> 'reading <span class=\"keyword\">for</span> initial communication packet'</span><br><span class=\"line\">说明: 只有windows 的navicat会出现上面报错, windows上通过mysql命令连接时 也很慢</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加如下内容:</span></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">skip-<span class=\"built_in\">name</span>-resolve</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"mysql问题-mysql5-7-错误总结-ERROR-1067-42000-Invalid-default-value-for-TIMESTAMP\"><a href=\"#mysql问题-mysql5-7-错误总结-ERROR-1067-42000-Invalid-default-value-for-TIMESTAMP\" class=\"headerlink\" title=\"mysql问题: mysql5.7 错误总结-ERROR 1067 (42000): Invalid default value for TIMESTAMP\"></a>mysql问题: mysql5.7 错误总结-ERROR 1067 (42000): Invalid default value for TIMESTAMP</h3><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show variables like <span class=\"emphasis\">'sql_mode'</span>;</span><br><span class=\"line\"><span class=\"code\">+---------------+</span>-------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">| Variable<span class=\"emphasis\">_name | Value                                                                                                                                     |</span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class=\"line\"><span class=\"emphasis\">| sql_</span>mode      | ONLY<span class=\"emphasis\">_FULL_</span>GROUP<span class=\"emphasis\">_BY,STRICT_</span>TRANS<span class=\"emphasis\">_TABLES,NO_</span>ZERO<span class=\"emphasis\">_IN_</span>DATE,NO<span class=\"emphasis\">_ZERO_</span>DATE,ERROR<span class=\"emphasis\">_FOR_</span>DIVISION<span class=\"emphasis\">_BY_</span>ZERO,NO<span class=\"emphasis\">_AUTO_</span>CREATE<span class=\"emphasis\">_USER,NO_</span>ENGINE<span class=\"emphasis\">_SUBSTITUTION |</span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>\n\n<p>这是因为sql_mode中的NO_ZEROR_DATE导制的，在strict mode中不允许’0000-00-00’作为合法日期</p>\n<p>将上面的NO_ZERO_DATE改为下面的 ALLOW_INVALID_DATES</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">sql_mode</span>=<span class=\"string\">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span>;</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> session  <span class=\"attribute\">sql_mode</span>=<span class=\"string\">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span>;</span><br></pre></td></tr></table></figure>\n\n<p>上面的设置是临时设置，在重新登陆后，该设置又恢复为NO_ZERO_DATE</p>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"mysql5-5主-mysql5-7从-问题\"><a href=\"#mysql5-5主-mysql5-7从-问题\" class=\"headerlink\" title=\"mysql5.5主+mysql5.7从 问题\"></a>mysql5.5主+mysql5.7从 问题</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">ERROR</span> 1794 (HY000): Slave is <span class=\"keyword\">not</span> configured <span class=\"keyword\">or</span> failed <span class=\"keyword\">to</span> initialize properly. You must at least <span class=\"builtin-name\">set</span> --server-id <span class=\"keyword\">to</span> <span class=\"builtin-name\">enable</span> either a master <span class=\"keyword\">or</span> a slave. Additional <span class=\"builtin-name\">error</span> messages can be found <span class=\"keyword\">in</span> the MySQL <span class=\"builtin-name\">error</span> log.</span><br><span class=\"line\">server_uuid是5.6的gtid特性引入的一个配置，</span><br><span class=\"line\">把mysql5.7的 rpl_slave.cc文件中get_master_uuid函数换成5.6对应的函数就可以了。</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"mysql一些info信息统计\"><a href=\"#mysql一些info信息统计\" class=\"headerlink\" title=\"mysql一些info信息统计\"></a>mysql一些info信息统计</h3><figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#tbl_size.sql</span><br><span class=\"line\">use information_schema;</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span></span><br><span class=\"line\">    TABLE_NAME,</span><br><span class=\"line\"> ENGINE,</span><br><span class=\"line\">    <span class=\"built_in\">ROUND</span>((DATA_LENGTH/<span class=\"number\">1024</span>/<span class=\"number\">1024</span>),<span class=\"number\">2</span>) <span class=\"keyword\">as</span> DataM ,</span><br><span class=\"line\">    <span class=\"built_in\">ROUND</span>((INDEX_LENGTH/<span class=\"number\">1024</span>/<span class=\"number\">1024</span>),<span class=\"number\">2</span>) <span class=\"keyword\">as</span> IndexM,</span><br><span class=\"line\">    <span class=\"built_in\">ROUND</span>(((DATA_LENGTH+INDEX_LENGTH)/<span class=\"number\">1024</span>/<span class=\"number\">1024</span>),<span class=\"number\">2</span>) <span class=\"keyword\">as</span> AllM,</span><br><span class=\"line\">    TABLE_ROWS,</span><br><span class=\"line\"> TABLE_COMMENT</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">    TABLES</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span></span><br><span class=\"line\">    TABLE_SCHEMA = <span class=\"string\">'hzkj_zh'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> AllM <span class=\"keyword\">DESC</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"># 生成excel表格</span><br><span class=\"line\">mysql test &lt;tbl_size.sql &gt;tbl_info_20191028.txt</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"跳过主从同步错误\"><a href=\"#跳过主从同步错误\" class=\"headerlink\" title=\"跳过主从同步错误\"></a>跳过主从同步错误</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">stop</span> <span class=\"keyword\">slave</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> sql_slave_skip_counter =<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">start</span> <span class=\"keyword\">slave</span>;</span><br><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">slave</span> <span class=\"keyword\">status</span>\\G;</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"mysql-information-schema-TABLES表中的table-rows-字段值与’count-’-值不同\"><a href=\"#mysql-information-schema-TABLES表中的table-rows-字段值与’count-’-值不同\" class=\"headerlink\" title=\"mysql information_schema.TABLES表中的table_rows 字段值与’count(*)’ 值不同\"></a>mysql information_schema.TABLES表中的table_rows 字段值与’count(*)’ 值不同</h3><blockquote>\n<p>查看information_schema</p>\n</blockquote>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use information<span class=\"emphasis\">_schema;</span></span><br><span class=\"line\"><span class=\"emphasis\">SELECT</span></span><br><span class=\"line\"><span class=\"emphasis\">    TABLE_</span>NAME,</span><br><span class=\"line\"><span class=\"code\">    TABLE_ROWS</span></span><br><span class=\"line\">FROM</span><br><span class=\"line\"><span class=\"code\">    TABLES</span></span><br><span class=\"line\">WHERE</span><br><span class=\"line\"><span class=\"code\">    TABLE_SCHEMA = 'zz' and TABLE_NAME = 'zzz';</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>------------+</span><br><span class=\"line\">| TABLE<span class=\"emphasis\">_NAME          | TABLE_</span>ROWS |</span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>------------+</span><br><span class=\"line\">|      zzz            |   42411396 |</span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>------------+</span><br></pre></td></tr></table></figure>\n\n<p>但是会发现和</p>\n<figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\" <span class=\"keyword\">select</span> <span class=\"built_in\">count</span>(*) <span class=\"keyword\">from</span> 某张表; \"</span><br></pre></td></tr></table></figure>\n\n<p>执行得到的值是不相同的！那是因为：</p>\n<ul>\n<li>1: 默认情况下 mysql 对表进行增删操作时，是不会自动更新 information_schema 库中 tables 表的 table_rows 字段的，在网上搜索一下发现说：只有10%的行数发生变化才会自动收集（没有亲自验证过！）；</li>\n<li>2: 执行 Analyze table tableName; 会统计所有表数据（在生产环境中不建议使用，因为会锁表！）；<br>原文链接：<a href=\"https://blog.csdn.net/David_jiahuan/article/details/98478740\" target=\"_blank\" rel=\"noopener\">mysql information_schema.TABLES表中的table_rows 字段值与count值不同</a></li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/10/10/11-mysql简单记录/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"}]},{"title":"centos6安装nginx1.16+php7.2","date":"2019-09-27T06:39:07.000Z","path":"2019/09/27/10-centos6安装nginx1-16-php7-2/","text":"记录简单的安装nginx和php的配置,仅供参考 先准备环境123456789# 更新源mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bakcurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repoyum clean allyum makecacheyum install -y epel-release# 安装一些依赖包yum -y install gcc make cmake ncurses-devel libxml2-devel libtool-ltdl-devel gcc-c++ autoconf automake bison zlib-devel openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel autoconf automake libtool-ltdl libtool-ltdl-devel libjpeg libjpeg-turbo-devel libmcrypt-devel libpng-devel centos6编译安装nginx123456789101112131415#首先官网下载1.16cd /usr/local/src/wget http://nginx.org/download/nginx-1.16.0.tar.gztar -xvf nginx-1.16.0.tar.gz# 编译简单的模块./configure --prefix=/usr/local/nginx/ --with-http_ssl_module --with-http_stub_status_module --with-http_stub_status_modulemake -j4make install# 通过启动脚本启动chmod +x /etc/init.d/nginxservice nginx start# 开机启动chkconfig nginx on nginx 启动脚本 /etc/init.d/nginx12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576#!/bin/bash# nginx Startup script for the Nginx HTTP Server# it is v.0.0.2 version.# chkconfig: - 85 15# description: Nginx is a high-performance web and proxy server.# It has a lot of features, but it's not for everyone.# processname: nginx# pidfile: /var/run/nginx.pid# config: /usr/local/nginx/conf/nginx.confnginx=/usr/local/nginx/sbin/nginxnginx_config=/usr/local/nginx/conf/nginx.confnginx_pid=/var/run/nginx.pidRETVAL=0prog=\"nginx\"# Source function library.. /etc/rc.d/init.d/functions# Source networking configuration.. /etc/sysconfig/network# Check that networking is up.[ $&#123;NETWORKING&#125; = \"no\" ] &amp;&amp; exit 0[ -x $nginx ] || exit 0# Start nginx daemons functions.start() &#123;if [ -e $nginx_pid ];then echo \"nginx already running....\" exit 1fi echo -n $\"Starting $prog: \" daemon $nginx -c $&#123;nginx_config&#125; RETVAL=$? echo [ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/nginx return $RETVAL&#125;# Stop nginx daemons functions.stop() &#123; echo -n $\"Stopping $prog: \" killproc $nginx RETVAL=$? echo [ $RETVAL = 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx /usr/local//nginx/logs/nginx.pid&#125;reload() &#123; echo -n $\"Reloading $prog: \" #kill -HUP `cat $&#123;nginx_pid&#125;` killproc $nginx -HUP RETVAL=$? echo&#125;# See how we were called.case \"$1\" instart) start ;;stop) stop ;;reload) reload ;;restart) stop start ;;status) status $prog RETVAL=$? ;;*) echo $\"Usage: $prog &#123;start|stop|restart|reload|status|help&#125;\" exit 1esacexit $RETVAL nginx.conf简单配置12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697user nobody nobody;worker_processes auto;worker_rlimit_nofile 102400;pid /var/run/nginx.pid;events &#123; use epoll; worker_connections 102400;&#125;http &#123; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; ###定义一个log_format log_format main '[ $host $request_time $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] \"$request\" ' '$body_bytes_sent \"$http_referer\" \"$http_user_agent\" \"$http_x_forwarded_for \" \"$bytes_sent\" \" $request_body\"' ; ###日志目录配置 #日志全部写入/nginx_logs/access.log 文件中。关闭最后两个server_name的日志 access_log /data/nginx_logs/access.log server_name_main; error_log /data/nginx_logs/error.log notice; ###杂项配置 charset utf-8; #server name的hash表， server_names_hash_bucket_size 128; #请求头如果过小，那么会引起400错误。一般如果cookie过大，会引起问题。getconf PAGESIZE系统分页 client_header_buffer_size 8k; client_body_buffer_size 512k; large_client_header_buffers 16 16k; client_max_body_size 30m; sendfile on; tcp_nopush on; keepalive_timeout 60; tcp_nodelay on; #fastcgi通用配置 fastcgi_connect_timeout 600; fastcgi_send_timeout 600; fastcgi_read_timeout 600; fastcgi_buffer_size 128k; fastcgi_buffers 8 256k; fastcgi_busy_buffers_size 256k; fastcgi_temp_file_write_size 256k; ###代理有关的配置 proxy_connect_timeout 600; proxy_read_timeout 600; proxy_send_timeout 600; proxy_buffer_size 512k; proxy_buffers 6 512k; proxy_busy_buffers_size 512k; proxy_temp_file_write_size 512k; #或许在于测试,代理服务器不主动关闭客户端，防止499错误 proxy_ignore_client_abort on; ###gzip配置 gzip on; gzip_min_length 1k; gzip_buffers 4 16k; gzip_http_version 1.0; gzip_comp_level 2; gzip_types text/plain application/x-javascript text/css application/xml; gzip_vary on; include /usr/local/nginx/conf/mime.types; default_type application/octet-stream; # 隐藏nginx版本信息 server_tokens off; server &#123; listen 80 default_server; server_name _; #server_name localhost; index index.html index.htm; root html; deny all; location / &#123; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125;&#125; centos6编译安装php712345678910111213141516# 首先安装freetype2.4tar -xvf freetype-2.4.0.tar.gzcd freetype-2.4.0./configure --prefix=/usr/local/freetypemake -j4 &amp;&amp; make install# 编译php7(不需要的可以去掉)tar -xvf php-7.2.2.tar.gzcd php-7.2.2./configure --prefix=/usr/local/php --with-libxml-dir=/usr/ --with-pdo-mysql=mysqlnd --with-zlib --with-libxml-dir --with-openssl --enable-mysqlnd --enable-mbstring --with-config-file-path=/usr/local/php/etc/ --with-config-file-scan-dir=/usr/local/php/etc/conf.d --enable-fpm --with-freetype-dir=/usr/local/freetype --with-jpeg-dir --with-png-dir --with-gd --enable-gd-native-ttf --enable-pdo --enable-mbstring --enable-bcmathmake -j 4 &amp;&amp; make install# 安装composercurl -sS https://getcomposer.org/installer | php &amp;&amp; mv composer.phar /usr/bin/composer 配置1234567891011# php.ini配置(具体配置内容自行修改)cp php.ini-production /usr/local/php7/etc/php.inicp /usr/local/php7/etc/php-fpm.conf.default /usr/local/php7/etc/php-fpm.confcp /usr/local/php7/etc/php-fpm.d/www.conf.default /usr/local/php7/etc/php-fpm.d/www.conf# 启动脚本cp ./sapi/fpm/init.d.php-fpm /etc/init.d/php-fpmchmod +x /etc/init.d/php-fpm# 创建linkln -s /usr/local/php7 /usr/local/php 启动php-fpm12service php-fpm startchkconfig php-fpm on","raw":"---\ntitle: centos6安装nginx1.16+php7.2\ncopyright: true\ndate: 2019-09-27 14:39:07\ntags:\n  - nginx\n  - php7\ncategories:\n  - [技术文档]\n  - [nginx]\n---\n\n记录简单的安装nginx和php的配置,仅供参考\n\n<!-- more -->\n\n### 先准备环境\n```\n# 更新源\nmv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo\nyum clean all\nyum makecache\nyum install -y epel-release\n\n# 安装一些依赖包\nyum -y install gcc make cmake ncurses-devel libxml2-devel libtool-ltdl-devel gcc-c++ autoconf automake bison  zlib-devel openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel autoconf automake  libtool-ltdl libtool-ltdl-devel libjpeg  libjpeg-turbo-devel libmcrypt-devel libpng-devel\n\n```\n\n\n### centos6编译安装nginx\n```\n#首先官网下载1.16\ncd /usr/local/src/\nwget http://nginx.org/download/nginx-1.16.0.tar.gz\ntar -xvf nginx-1.16.0.tar.gz\n\n# 编译简单的模块\n./configure --prefix=/usr/local/nginx/  --with-http_ssl_module --with-http_stub_status_module  --with-http_stub_status_module\nmake -j4\nmake install\n\n# 通过启动脚本启动\nchmod +x /etc/init.d/nginx\nservice nginx start\n# 开机启动\nchkconfig nginx on\n```\n\n### nginx 启动脚本 /etc/init.d/nginx\n```\n#!/bin/bash\n# nginx Startup script for the Nginx HTTP Server\n# it is v.0.0.2 version.\n# chkconfig: - 85 15\n# description: Nginx is a high-performance web and proxy server.\n#              It has a lot of features, but it's not for everyone.\n# processname: nginx\n# pidfile: /var/run/nginx.pid\n# config: /usr/local/nginx/conf/nginx.conf\n\nnginx=/usr/local/nginx/sbin/nginx\nnginx_config=/usr/local/nginx/conf/nginx.conf\nnginx_pid=/var/run/nginx.pid\n\nRETVAL=0\nprog=\"nginx\"\n# Source function library.\n.  /etc/rc.d/init.d/functions\n# Source networking configuration.\n.  /etc/sysconfig/network\n# Check that networking is up.\n[ ${NETWORKING} = \"no\" ] && exit 0\n[ -x $nginx ] || exit 0\n# Start nginx daemons functions.\nstart() {\nif [ -e $nginx_pid ];then\n   echo \"nginx already running....\"\n   exit 1\nfi\n   echo -n $\"Starting $prog: \"\n   daemon $nginx -c ${nginx_config}\n   RETVAL=$?\n   echo\n   [ $RETVAL = 0 ] && touch /var/lock/subsys/nginx\n   return $RETVAL\n}\n# Stop nginx daemons functions.\nstop() {\n        echo -n $\"Stopping $prog: \"\n        killproc $nginx\n        RETVAL=$?\n        echo\n        [ $RETVAL = 0 ] && rm -f /var/lock/subsys/nginx /usr/local//nginx/logs/nginx.pid\n}\n\nreload() {\n    echo -n $\"Reloading $prog: \"\n    #kill -HUP `cat ${nginx_pid}`\n    killproc $nginx -HUP\n    RETVAL=$?\n    echo\n}\n# See how we were called.\ncase \"$1\" in\nstart)\n        start\n        ;;\nstop)\n        stop\n        ;;\nreload)\n        reload\n        ;;\nrestart)\n        stop\n        start\n        ;;\nstatus)\n        status $prog\n        RETVAL=$?\n        ;;\n*)\n        echo $\"Usage: $prog {start|stop|restart|reload|status|help}\"\n        exit 1\nesac\nexit $RETVAL\n```\n\n### nginx.conf简单配置\n```\nuser  nobody nobody;\nworker_processes  auto;\n\nworker_rlimit_nofile 102400;\npid        /var/run/nginx.pid;\n\nevents {\n    use epoll;\n    worker_connections 102400;\n}\n\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                 '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    ###定义一个log_format\n    log_format  main '[ $host $request_time  $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] \"$request\" '  '$body_bytes_sent \"$http_referer\" \"$http_user_agent\" \"$http_x_forwarded_for \" \"$bytes_sent\" \" $request_body\"' ;\n\n\n    ###日志目录配置\n    #日志全部写入/nginx_logs/access.log 文件中。关闭最后两个server_name的日志\n    access_log  /data/nginx_logs/access.log  server_name_main;\n    error_log /data/nginx_logs/error.log notice;\n\n    ###杂项配置\n    charset utf-8;\n    #server name的hash表，\n    server_names_hash_bucket_size 128;\n    #请求头如果过小，那么会引起400错误。一般如果cookie过大，会引起问题。getconf PAGESIZE系统分页\n    client_header_buffer_size 8k;\n    client_body_buffer_size  512k;\n    large_client_header_buffers 16 16k;\n    client_max_body_size 30m;\n    sendfile on;\n    tcp_nopush     on;\n    keepalive_timeout 60;\n    tcp_nodelay on;\n\n    #fastcgi通用配置\n    fastcgi_connect_timeout 600;\n    fastcgi_send_timeout 600;\n    fastcgi_read_timeout 600;\n    fastcgi_buffer_size 128k;\n    fastcgi_buffers 8 256k;\n    fastcgi_busy_buffers_size 256k;\n    fastcgi_temp_file_write_size 256k;\n\n    ###代理有关的配置\n    proxy_connect_timeout    600;\n    proxy_read_timeout       600;\n    proxy_send_timeout       600;\n    proxy_buffer_size        512k;\n    proxy_buffers            6 512k;\n    proxy_busy_buffers_size 512k;\n    proxy_temp_file_write_size 512k;\n\n    #或许在于测试,代理服务器不主动关闭客户端，防止499错误\n    proxy_ignore_client_abort on;\n\n\n    ###gzip配置\n    gzip on;\n    gzip_min_length  1k;\n    gzip_buffers     4 16k;\n    gzip_http_version 1.0;\n    gzip_comp_level 2;\n    gzip_types       text/plain application/x-javascript text/css application/xml;\n    gzip_vary on;\n\n\n    include             /usr/local/nginx/conf/mime.types;\n    default_type        application/octet-stream;\n\n    # 隐藏nginx版本信息\n    server_tokens off;\n\n    server {\n        listen       80 default_server;\n        server_name  _;\n        #server_name  localhost;\n        index  index.html index.htm;\n        root   html;\n        deny all;\n\n        location / {\n        }\n\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n\n\n}\n```\n\n### centos6编译安装php7\n```\n# 首先安装freetype2.4\ntar -xvf freetype-2.4.0.tar.gz\ncd freetype-2.4.0\n./configure --prefix=/usr/local/freetype\nmake -j4 && make install\n\n\n# 编译php7(不需要的可以去掉)\ntar -xvf php-7.2.2.tar.gz\ncd php-7.2.2\n./configure    --prefix=/usr/local/php   --with-libxml-dir=/usr/   --with-pdo-mysql=mysqlnd   --with-zlib   --with-libxml-dir   --with-openssl   --enable-mysqlnd   --enable-mbstring   --with-config-file-path=/usr/local/php/etc/   --with-config-file-scan-dir=/usr/local/php/etc/conf.d   --enable-fpm --with-freetype-dir=/usr/local/freetype  --with-jpeg-dir --with-png-dir --with-gd --enable-gd-native-ttf --enable-pdo --enable-mbstring --enable-bcmath\n\nmake -j 4 && make install\n\n# 安装composer\ncurl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/bin/composer\n```\n\n### 配置\n```\n# php.ini配置(具体配置内容自行修改)\ncp php.ini-production /usr/local/php7/etc/php.ini\ncp /usr/local/php7/etc/php-fpm.conf.default /usr/local/php7/etc/php-fpm.conf\ncp /usr/local/php7/etc/php-fpm.d/www.conf.default /usr/local/php7/etc/php-fpm.d/www.conf\n\n# 启动脚本\ncp ./sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm\nchmod +x /etc/init.d/php-fpm\n\n# 创建link\nln -s /usr/local/php7 /usr/local/php\n```\n\n### 启动php-fpm\n```\nservice php-fpm start\nchkconfig php-fpm on\n```\n","content":"<p>记录简单的安装nginx和php的配置,仅供参考</p>\n<a id=\"more\"></a>\n\n<h3 id=\"先准备环境\"><a href=\"#先准备环境\" class=\"headerlink\" title=\"先准备环境\"></a>先准备环境</h3><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 更新源</span></span><br><span class=\"line\">mv <span class=\"meta-keyword\">/etc/</span>yum.repos.d/CentOS-Base.repo <span class=\"meta-keyword\">/etc/</span>yum.repos.d/CentOS-Base.repo.bak</span><br><span class=\"line\">curl -o <span class=\"meta-keyword\">/etc/</span>yum.repos.d/CentOS-Base.repo http:<span class=\"comment\">//mirrors.aliyun.com/repo/Centos-6.repo</span></span><br><span class=\"line\">yum clean all</span><br><span class=\"line\">yum makecache</span><br><span class=\"line\">yum install -y epel-release</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装一些依赖包</span></span><br><span class=\"line\">yum -y install gcc make cmake ncurses-devel libxml2-devel libtool-ltdl-devel gcc-c++ autoconf automake bison  zlib-devel openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel autoconf automake  libtool-ltdl libtool-ltdl-devel libjpeg  libjpeg-turbo-devel libmcrypt-devel libpng-devel</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"centos6编译安装nginx\"><a href=\"#centos6编译安装nginx\" class=\"headerlink\" title=\"centos6编译安装nginx\"></a>centos6编译安装nginx</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#首先官网下载1.16</span></span><br><span class=\"line\"><span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span></span><br><span class=\"line\">wget http:<span class=\"string\">//nginx.org/download/nginx-1.16.0.tar.gz</span></span><br><span class=\"line\">tar -xvf nginx-1.16.0.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译简单的模块</span></span><br><span class=\"line\"><span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/nginx/</span>  <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-http_stub_status_module</span>  <span class=\"params\">--with-http_stub_status_module</span></span><br><span class=\"line\">make -j4</span><br><span class=\"line\">make install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过启动脚本启动</span></span><br><span class=\"line\">chmod +x <span class=\"string\">/etc/init.d/nginx</span></span><br><span class=\"line\">service nginx start</span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">chkconfig nginx on</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"nginx-启动脚本-etc-init-d-nginx\"><a href=\"#nginx-启动脚本-etc-init-d-nginx\" class=\"headerlink\" title=\"nginx 启动脚本 /etc/init.d/nginx\"></a>nginx 启动脚本 /etc/init.d/nginx</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># nginx Startup script for the Nginx HTTP Server</span></span><br><span class=\"line\"><span class=\"comment\"># it is v.0.0.2 version.</span></span><br><span class=\"line\"><span class=\"comment\"># chkconfig: - 85 15</span></span><br><span class=\"line\"><span class=\"comment\"># description: Nginx is a high-performance web and proxy server.</span></span><br><span class=\"line\"><span class=\"comment\">#              It has a lot of features, but it's not for everyone.</span></span><br><span class=\"line\"><span class=\"comment\"># processname: nginx</span></span><br><span class=\"line\"><span class=\"comment\"># pidfile: /var/run/nginx.pid</span></span><br><span class=\"line\"><span class=\"comment\"># config: /usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\">nginx=/usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx</span><br><span class=\"line\">nginx_config=/usr/<span class=\"built_in\">local</span>/nginx/conf/nginx.conf</span><br><span class=\"line\">nginx_pid=/var/run/nginx.pid</span><br><span class=\"line\"></span><br><span class=\"line\">RETVAL=0</span><br><span class=\"line\">prog=<span class=\"string\">\"nginx\"</span></span><br><span class=\"line\"><span class=\"comment\"># Source function library.</span></span><br><span class=\"line\">.  /etc/rc.d/init.d/<span class=\"built_in\">functions</span></span><br><span class=\"line\"><span class=\"comment\"># Source networking configuration.</span></span><br><span class=\"line\">.  /etc/sysconfig/network</span><br><span class=\"line\"><span class=\"comment\"># Check that networking is up.</span></span><br><span class=\"line\">[ <span class=\"variable\">$&#123;NETWORKING&#125;</span> = <span class=\"string\">\"no\"</span> ] &amp;&amp; <span class=\"built_in\">exit</span> 0</span><br><span class=\"line\">[ -x <span class=\"variable\">$nginx</span> ] || <span class=\"built_in\">exit</span> 0</span><br><span class=\"line\"><span class=\"comment\"># Start nginx daemons functions.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">start</span></span>() &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -e <span class=\"variable\">$nginx_pid</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">   <span class=\"built_in\">echo</span> <span class=\"string\">\"nginx already running....\"</span></span><br><span class=\"line\">   <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">   <span class=\"built_in\">echo</span> -n $<span class=\"string\">\"Starting <span class=\"variable\">$prog</span>: \"</span></span><br><span class=\"line\">   daemon <span class=\"variable\">$nginx</span> -c <span class=\"variable\">$&#123;nginx_config&#125;</span></span><br><span class=\"line\">   RETVAL=$?</span><br><span class=\"line\">   <span class=\"built_in\">echo</span></span><br><span class=\"line\">   [ <span class=\"variable\">$RETVAL</span> = 0 ] &amp;&amp; touch /var/lock/subsys/nginx</span><br><span class=\"line\">   <span class=\"built_in\">return</span> <span class=\"variable\">$RETVAL</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># Stop nginx daemons functions.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">stop</span></span>() &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> -n $<span class=\"string\">\"Stopping <span class=\"variable\">$prog</span>: \"</span></span><br><span class=\"line\">        killproc <span class=\"variable\">$nginx</span></span><br><span class=\"line\">        RETVAL=$?</span><br><span class=\"line\">        <span class=\"built_in\">echo</span></span><br><span class=\"line\">        [ <span class=\"variable\">$RETVAL</span> = 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx /usr/<span class=\"built_in\">local</span>//nginx/logs/nginx.pid</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">reload</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -n $<span class=\"string\">\"Reloading <span class=\"variable\">$prog</span>: \"</span></span><br><span class=\"line\">    <span class=\"comment\">#kill -HUP `cat $&#123;nginx_pid&#125;`</span></span><br><span class=\"line\">    killproc <span class=\"variable\">$nginx</span> -HUP</span><br><span class=\"line\">    RETVAL=$?</span><br><span class=\"line\">    <span class=\"built_in\">echo</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># See how we were called.</span></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">start)</span><br><span class=\"line\">        start</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">stop)</span><br><span class=\"line\">        stop</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">reload)</span><br><span class=\"line\">        reload</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">restart)</span><br><span class=\"line\">        stop</span><br><span class=\"line\">        start</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">status)</span><br><span class=\"line\">        status <span class=\"variable\">$prog</span></span><br><span class=\"line\">        RETVAL=$?</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">*)</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> $<span class=\"string\">\"Usage: <span class=\"variable\">$prog</span> &#123;start|stop|restart|reload|status|help&#125;\"</span></span><br><span class=\"line\">        <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span> <span class=\"variable\">$RETVAL</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"nginx-conf简单配置\"><a href=\"#nginx-conf简单配置\" class=\"headerlink\" title=\"nginx.conf简单配置\"></a>nginx.conf简单配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">user</span>  nobody nobody;</span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span>  auto;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">worker_rlimit_nofile</span> <span class=\"number\">102400</span>;</span><br><span class=\"line\"><span class=\"attribute\">pid</span>        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">use</span> <span class=\"literal\">epoll</span>;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span> <span class=\"number\">102400</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">log_format</span>  main  <span class=\"string\">'<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span></span><br><span class=\"line\">                  <span class=\"string\">'<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                 <span class=\"string\">'\"<span class=\"variable\">$http_user_agent</span>\" \"<span class=\"variable\">$http_x_forwarded_for</span>\"'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">###定义一个log_format</span></span><br><span class=\"line\">    <span class=\"attribute\">log_format</span>  main <span class=\"string\">'[ <span class=\"variable\">$host</span> <span class=\"variable\">$request_time</span>  <span class=\"variable\">$upstream_addr</span> <span class=\"variable\">$upstream_response_time</span> ] '</span> <span class=\"string\">'<span class=\"variable\">$status</span> '</span> <span class=\"string\">'<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span>  <span class=\"string\">'<span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" \"<span class=\"variable\">$http_user_agent</span>\" \"<span class=\"variable\">$http_x_forwarded_for</span> \" \"<span class=\"variable\">$bytes_sent</span>\" \" <span class=\"variable\">$request_body</span>\"'</span> ;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">###日志目录配置</span></span><br><span class=\"line\">    <span class=\"comment\">#日志全部写入/nginx_logs/access.log 文件中。关闭最后两个server_name的日志</span></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span>  /data/nginx_logs/access.log  server_name_main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /data/nginx_logs/error.log <span class=\"literal\">notice</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">###杂项配置</span></span><br><span class=\"line\">    <span class=\"attribute\">charset</span> utf-<span class=\"number\">8</span>;</span><br><span class=\"line\">    <span class=\"comment\">#server name的hash表，</span></span><br><span class=\"line\">    <span class=\"attribute\">server_names_hash_bucket_size</span> <span class=\"number\">128</span>;</span><br><span class=\"line\">    <span class=\"comment\">#请求头如果过小，那么会引起400错误。一般如果cookie过大，会引起问题。getconf PAGESIZE系统分页</span></span><br><span class=\"line\">    <span class=\"attribute\">client_header_buffer_size</span> <span class=\"number\">8k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">client_body_buffer_size</span>  <span class=\"number\">512k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">large_client_header_buffers</span> <span class=\"number\">16</span> <span class=\"number\">16k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">client_max_body_size</span> <span class=\"number\">30m</span>;</span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">tcp_nopush</span>     <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span> <span class=\"number\">60</span>;</span><br><span class=\"line\">    <span class=\"attribute\">tcp_nodelay</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#fastcgi通用配置</span></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_connect_timeout</span> <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_send_timeout</span> <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_read_timeout</span> <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_buffer_size</span> <span class=\"number\">128k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_buffers</span> <span class=\"number\">8</span> <span class=\"number\">256k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_busy_buffers_size</span> <span class=\"number\">256k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_temp_file_write_size</span> <span class=\"number\">256k</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">###代理有关的配置</span></span><br><span class=\"line\">    <span class=\"attribute\">proxy_connect_timeout</span>    <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_read_timeout</span>       <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_send_timeout</span>       <span class=\"number\">600</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_buffer_size</span>        <span class=\"number\">512k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_buffers</span>            <span class=\"number\">6</span> <span class=\"number\">512k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_busy_buffers_size</span> <span class=\"number\">512k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_temp_file_write_size</span> <span class=\"number\">512k</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#或许在于测试,代理服务器不主动关闭客户端，防止499错误</span></span><br><span class=\"line\">    <span class=\"attribute\">proxy_ignore_client_abort</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">###gzip配置</span></span><br><span class=\"line\">    <span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_min_length</span>  <span class=\"number\">1k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_buffers</span>     <span class=\"number\">4</span> <span class=\"number\">16k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_comp_level</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_types</span>       text/plain application/x-javascript text/css application/xml;</span><br><span class=\"line\">    <span class=\"attribute\">gzip_vary</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span>             /usr/local/nginx/conf/mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>        application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 隐藏nginx版本信息</span></span><br><span class=\"line\">    <span class=\"attribute\">server_tokens</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span>       <span class=\"number\">80</span> default_server;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  _;</span><br><span class=\"line\">        <span class=\"comment\">#server_name  localhost;</span></span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">        <span class=\"attribute\">location</span> = /50x.html &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"centos6编译安装php7\"><a href=\"#centos6编译安装php7\" class=\"headerlink\" title=\"centos6编译安装php7\"></a>centos6编译安装php7</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 首先安装freetype2.4</span></span><br><span class=\"line\">tar -xvf freetype-2.4.0.tar.gz</span><br><span class=\"line\"><span class=\"keyword\">cd</span> freetype-2.4.0</span><br><span class=\"line\"><span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/freetype</span></span><br><span class=\"line\">make -j4 &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译php7(不需要的可以去掉)</span></span><br><span class=\"line\">tar -xvf php-7.2.2.tar.gz</span><br><span class=\"line\"><span class=\"keyword\">cd</span> php-7.2.2</span><br><span class=\"line\"><span class=\"string\">./configure</span>    <span class=\"params\">--prefix=/usr/local/php</span>   <span class=\"params\">--with-libxml-dir=/usr/</span>   <span class=\"params\">--with-pdo-mysql=mysqlnd</span>   <span class=\"params\">--with-zlib</span>   <span class=\"params\">--with-libxml-dir</span>   <span class=\"params\">--with-openssl</span>   <span class=\"params\">--enable-mysqlnd</span>   <span class=\"params\">--enable-mbstring</span>   <span class=\"params\">--with-config-file-path=/usr/local/php/etc/</span>   <span class=\"params\">--with-config-file-scan-dir=/usr/local/php/etc/conf</span>.d   <span class=\"params\">--enable-fpm</span> <span class=\"params\">--with-freetype-dir=/usr/local/freetype</span>  <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--enable-gd-native-ttf</span> <span class=\"params\">--enable-pdo</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-bcmath</span></span><br><span class=\"line\"></span><br><span class=\"line\">make -j 4 &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装composer</span></span><br><span class=\"line\">curl -sS https:<span class=\"string\">//getcomposer.org/installer</span> | php &amp;&amp; mv composer.phar <span class=\"string\">/usr/bin/composer</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># php.ini配置(具体配置内容自行修改)</span></span><br><span class=\"line\">cp php.ini-production <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/php7/</span>etc/php.ini</span><br><span class=\"line\">cp <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/php7/</span>etc/php-fpm.conf.default <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/php7/</span>etc/php-fpm.conf</span><br><span class=\"line\">cp <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/php7/</span>etc/php-fpm.d/www.conf.default <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/php7/</span>etc/php-fpm.d/www.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 启动脚本</span></span><br><span class=\"line\">cp .<span class=\"meta-keyword\">/sapi/</span>fpm/init.d.php-fpm <span class=\"meta-keyword\">/etc/</span>init.d/php-fpm</span><br><span class=\"line\">chmod +x <span class=\"meta-keyword\">/etc/</span>init.d/php-fpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 创建link</span></span><br><span class=\"line\">ln -s <span class=\"meta-keyword\">/usr/</span>local/php7 <span class=\"meta-keyword\">/usr/</span>local/php</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动php-fpm\"><a href=\"#启动php-fpm\" class=\"headerlink\" title=\"启动php-fpm\"></a>启动php-fpm</h3><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service php-fpm <span class=\"built_in\">start</span></span><br><span class=\"line\">chkconfig php-fpm <span class=\"keyword\">on</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/27/10-centos6安装nginx1-16-php7-2/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/categories/nginx/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/tags/nginx/"},{"name":"php7","slug":"php7","permalink":"https://blog.k1s.club/tags/php7/"}]},{"title":"linux遇到一些问题统计","date":"2019-09-26T09:33:38.000Z","path":"2019/09/26/9-linux遇到一些问题统计总结/","text":"记录一些Linux,nginx或其他服务一些问题 Linux问题: 2020-09-02 一次dnsmasq迁移问题 网卡配置如下 123456789101112DEVICE=em1HWADDR=xTYPE=EthernetUUID=xONBOOT=yesNM_CONTROLLED=yesBOOTPROTO=staticIPADDR0=172.16.76.100PREFIX0=24GATEWAY=172.16.76.1DNS1=172.16.76.100DNS2=172.16.76.101 这里有个大问题, 由于本身就是dns服务器, 但配置的DNS1居然是本机, 这导致service network restart 的时候会去修改 /etc/resolv.conf 的配置为 DNS1 和DNS2的ip, 此时dns服务器将无法解析外网域名 因此正确的配置是 123DNS1=119.29.29.29DNS2=223.5.5.5DNS3=114.114.114.114 Linux问题: 升级内核123456789101112131415rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.orgrpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm# 查看可升级的内核yum --disablerepo=\"*\" --enablerepo=\"elrepo-kernel\" list availableyum --enablerepo=elrepo-kernel install kernel-ml# 查看已经安装的内核cat /boot/grub2/grub.cfg |grep menuentry# 设置5.3的为默认grub2-set-default 'CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)'# grub2-editenv listsaved_entry=CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core) linux问题: tcpdump抓包tcp第三次握手ack为1 执行命令监听: tcpdump -n port 80 (想要详细信息加 -vv) 客户端 telnet x.x.x.x 80 日志如下: 123456tcpdump -n port 80tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes11:16:40.689157 IP 192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [SEW], seq 1306124348, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458678777 ecr 0,sackOK,eol], length 011:16:40.689724 IP 192.168.53.106.http &gt; 192.168.54.141.53444: Flags [S.E], seq 1553518959, ack 1306124349, win 64308, options [mss 1410,sackOK,TS val 4208119240 ecr 458678777,nop,wscale 7], length 011:16:40.690320 IP 192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [.], ack 1, win 4106, options [nop,nop,TS val 458678778 ecr 4208119240], length 0 这里第一和第二次握手都没有问题, 第三次 ack 1, 并非是seq+1 这里提一下ACK, ACK 是确认值, ack 是确认编号, 第一次握手ACK=0,在第二次握手开始ACK=1, 而ack是=seq+1(收到的随机数+1) 那么这里ack 1 是啥呢? … 应该就是默认tcpdump 显示成相对值了, 通过-S 参数会显示绝对值 执行命令监听: tcpdump -S -n port 80 12345tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes11:16:54.806628 IP 192.168.54.141.53516 &gt; 192.168.53.106.http: Flags [S], seq 316359286, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458692791 ecr 0,sackOK,eol], length 011:16:54.806861 IP 192.168.53.106.http &gt; 192.168.54.141.53516: Flags [S.], seq 1113466641, ack 316359287, win 64308, options [mss 1410,sackOK,TS val 4208133357 ecr 458692791,nop,wscale 7], length 011:16:54.807576 IP 192.168.54.141.53516 &gt; 192.168.53.106.http: Flags [.], ack 1113466642, win 4106, options [nop,nop,TS val 458692792 ecr 4208133357], length 0 三次握手图 四次挥手图 linux问题: 禁ping12345678# 一次性修改echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all# 开机自动修改echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all# 永久禁用,加入到/etc/sysctl.confnet.ipv4.icmp_echo_ignore_all=1 linux问题: 文件锁问题1234567问题描述: php slowlog 出现session_start() 慢问题原因: 我们这边有A 和B 两个二级域名,A 会请求 B, 并且由于测试环境在同一台服务器,公用一个php,所以在发生调用的时候同时写了session,而php的sessions配置是默认的file方式, 这就造成了锁的问题问题解决: 1. 修改代码部分2. php的session配置改成redis session.save_handler = redis session.save_path = \"tcp://x.x.x.x:xxxx\" linux问题: 内存释放问题123456问题描述: 开发这边写了个统计脚本, 占用49G内存, 从日志发现脚本已经全部执行完成, 但是php脚本依然存在问题原因: 通过 strace -p pid 观察进程, 发现是持续性的做内存释放操作 munmap(0x7f6db77ad000, 266240) = 0持续执行munmap函数是因为一直在释放内存(毕竟49G), 结果 =0 说明内存释放执行函数是返回正常了问题解决: 1. 修改代码降低内存2. 等待一段时间内存会释放完成(测试80分钟释放完毕) nginx if 条件 &amp;&amp; 的实现 1 允许所有人访问 a.php|b.php|c.php|d.php|e.php 2 仅允许127.0.0.1|172.16.0.2 ip可以访问 aa.php|bb.php 123456789101112131415161718set $flag \"allow\";# 以下php 所有人可以访问if ( $fastcgi_script_name ~ (a.php|b.php|c.php|d.php|e.php) ) &#123; set $flag \"allow_php_ip\";&#125;# 以下php 仅固定ip可以访问if ($fastcgi_script_name ~ (aa.php|bb.php)) &#123; set $flag \"$&#123;flag&#125;_php\";&#125;if ( $proxy_add_x_forwarded_for ~ (127.0.0.1|172.16.0.2)) &#123; set $flag \"$&#123;flag&#125;_ip\";&#125;# 写包含是 $flag 可能为 \"allow_php_ip_ip\" (在允许的ip服务器(127.0.0.1)上访问 /a.php)if ( $flag !~ \"allow_php_ip\" ) &#123; return 403;&#125; nginx问题: 静态文件分离对于一般的nginx+php的方式, 我们php采用nobody用户,而代码/lumen采用web-www用户, 这样的好处是页面访问到/lumen时是nobody用户, 是无法修改代码的 可能我们需求是上用户upload图片等, 这时候就可能被传上某个a.php, 这就有可能被代码注入(一般来说图片是放cdn,配置单独域名回源的,这里是直接存在项目目录) 所以为了防止代码注入,我们需要限制upload目录的访问权限 1234# nginx配置如下 location ~ /images/.*\\.(gif|jpg|jpeg|png)$ &#123; root /lumen/storage/uploads/; &#125; 这样我们图片传到 /lumen/storage/uploads/images/ 目录, 访问是 www.xxx.com/images/x.png 来访问 且不允许其他类型文件访问. nginx问题: root 和alias在配置文件映射的时候，如果使用了正则表达式，那么可能会出现无法访问文件，nginx可能会将所有的文件都映射成为文件夹，导致文件映射失败的情况出现； root的例子 1234location /a/ &#123; root /lumen/public;&#125;这里实际访问的路径: www.xxx.com/a/ -&gt; /lumen/public/a/ alias的例子 12345# 注意这里目录最后加上/location /a/ &#123; alias /lumen/public/;&#125;这里实际访问的路径: www.xxx.com/a/ -&gt; /lumen/public/ nginx问题: 隐藏版本信息123Syntax: server_tokens on | off | build | string;Default: server_tokens on;Context: http, server, location nginx问题: 日志出现encode内容如何查看12# python2 执行decode&gt;&gt;&gt; print \"\\x22content\\x22\\x0D\\x0A\\x0D\\x0A\\xE8\\x8A\\x8A\\xE8\\x8A\\x8A\\xE8\\xBF\\x98\\xE6\\x80\\x95\\xE5\\xA6\\x9E\\xE5\\xA6\\x9E\\xE4\\xB8\\x8D\\xE8\\x80\\x81\\xE5\\xAE\\x9E\\xEF\\xBC\\x8C\\xE7\\x89\\xB9\\xE5\\x9C\\xB0\\xE8\\xBF\\x87\\xE6\\x9D\\xA5\\xE8\\xA7\\x86\\xE5\\xAF\\x9F\\xE4\\xB8\\x80\\xE4\\xB8\\x8B\\x0D\\x0A\".decode('utf-8') nginx问题: default配置未设置nginx 未设置default时, 如果直接访问服务器外网ip, 会去请求到第一个匹配的server段, 有可能会请求到后端的服务器的内容, 这很有可能暴露我们不想暴露的服务一般来说开头添加如下配置 123456 server &#123; listen 80 default_server; listen [::]:80 default_server; server_name _; deny all;&#125; nginx 配置已经配置域名方式访问, 如果访问ip会返回403, 正常来说返回403已经不会对服务器造成压力了 可是万万没想到虽然返回了403, 但是也有700字节大小, 大量请求对小带宽来说还是有压力的 123456789101112# server &#123; listen 80 default_server; listen [::]:80 default_server; server_name _; return 499; &#125;#其他location,if配置,if ($host != a.example.com) &#123; return 499;&#125; nginx1.11以前trace_id 生成问题 如果是前端(upstream) 123456789101112131415161718log_format server_name_main '\"$request_trace_id\" [ $host $request_time ] ' '[ $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] \"$request\" ' '$body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\" \"$bytes_sent\"' '&#123;$request_body&#125;' ;...server &#123; set $request_trace_id $pid$connection$bytes_sent$msec; if ( $http_x_request_id != \"\" )&#123; set $request_trace_id $http_x_request_id; &#125; add_header Bq_F_Traceid $request_trace_id; # 一定要写到location中, 因为proxy_pass location / &#123; proxy_pass http://xxxx; proxy_set_header X-Request-Id $request_trace_id; &#125;&#125; 如果是后端节点 12345678910111213141516171819# 一定要写到server段, 否则后端可能报404错误server &#123; listen 80; server_name openapi-community-alpha.zhangzw.com ; set $request_trace_id trace-id-$pid-$connection-$bytes_sent-$msec; # 如果请求头中已有该参数,则获取即可;如果没有,则使用$request_id进行填充 set $temp_request_id $http_x_request_id; if ($temp_request_id = \"\") &#123; set $temp_request_id $request_trace_id; &#125; # 屏蔽掉原来的请求头参数 # proxy_set_header x_request_id \"\"; proxy_set_header X-Request-Id \"\"; # 设置向后转发的请求头参数 proxy_set_header X-Request-Id $temp_request_id; location / &#123; try_files $uri $uri/ /index.php?$query_string; &#125;&#125; 修改swap123456789dd if=/dev/zero of=/data/swapfilenew bs=4096 count=4096000swapoff -a /sbin/mkswap /data/swapfilenew/sbin/swapon /data/swapfilenewvim /etc/fstab/data/swapfilenew none swap defaults 0 0","raw":"---\ntitle: linux遇到一些问题统计\ncopyright: true\ndate: 2019-09-26 17:33:38\ntags:\n  - linux\ncategories:\n  - [技术文档]\n  - [linux,问题总结]\ntop: 20\n---\n记录一些Linux,nginx或其他服务一些问题\n\n<!-- more -->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### Linux问题: 2020-09-02 一次dnsmasq迁移问题\n\n> 网卡配置如下\n```\nDEVICE=em1\nHWADDR=x\nTYPE=Ethernet\nUUID=x\nONBOOT=yes\nNM_CONTROLLED=yes\nBOOTPROTO=static\nIPADDR0=172.16.76.100\nPREFIX0=24\nGATEWAY=172.16.76.1\nDNS1=172.16.76.100\nDNS2=172.16.76.101\n```\n> 这里有个大问题, 由于本身就是dns服务器, 但配置的DNS1居然是本机, 这导致service network restart 的时候会去修改 /etc/resolv.conf 的配置为 DNS1 和DNS2的ip, 此时dns服务器将无法解析外网域名\n\n> 因此正确的配置是\n\n```\nDNS1=119.29.29.29\nDNS2=223.5.5.5\nDNS3=114.114.114.114\n```\n\n\n### Linux问题: 升级内核\n\n```\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm\n\n# 查看可升级的内核\nyum --disablerepo=\"*\" --enablerepo=\"elrepo-kernel\" list available\nyum --enablerepo=elrepo-kernel install kernel-ml\n\n# 查看已经安装的内核\ncat /boot/grub2/grub.cfg |grep menuentry\n\n# 设置5.3的为默认\ngrub2-set-default 'CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)'\n\n# grub2-editenv list\nsaved_entry=CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)\n```\n\n### linux问题: tcpdump抓包tcp第三次握手ack为1\n- 执行命令监听: tcpdump -n port 80 (想要详细信息加 -vv)\n\n> 客户端 telnet x.x.x.x 80\n\n日志如下:\n\n```\ntcpdump  -n port 80\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes\n11:16:40.689157 IP 192.168.54.141.53444 > 192.168.53.106.http: Flags [SEW], seq 1306124348, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458678777 ecr 0,sackOK,eol], length 0\n11:16:40.689724 IP 192.168.53.106.http > 192.168.54.141.53444: Flags [S.E], seq 1553518959, ack 1306124349, win 64308, options [mss 1410,sackOK,TS val 4208119240 ecr 458678777,nop,wscale 7], length 0\n11:16:40.690320 IP 192.168.54.141.53444 > 192.168.53.106.http: Flags [.], ack 1, win 4106, options [nop,nop,TS val 458678778 ecr 4208119240], length 0\n```\n这里第一和第二次握手都没有问题, 第三次 ack 1, 并非是seq+1\n\n这里提一下ACK, ACK 是确认值, ack 是确认编号, 第一次握手ACK=0,在第二次握手开始ACK=1, 而ack是=seq+1(收到的随机数+1)\n\n那么这里ack 1 是啥呢?  ... 应该就是默认tcpdump 显示成相对值了, 通过-S 参数会显示绝对值\n\n- 执行命令监听: tcpdump -S  -n port 80\n\n```\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes\n11:16:54.806628 IP 192.168.54.141.53516 > 192.168.53.106.http: Flags [S], seq 316359286, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458692791 ecr 0,sackOK,eol], length 0\n11:16:54.806861 IP 192.168.53.106.http > 192.168.54.141.53516: Flags [S.], seq 1113466641, ack 316359287, win 64308, options [mss 1410,sackOK,TS val 4208133357 ecr 458692791,nop,wscale 7], length 0\n11:16:54.807576 IP 192.168.54.141.53516 > 192.168.53.106.http: Flags [.], ack 1113466642, win 4106, options [nop,nop,TS val 458692792 ecr 4208133357], length 0\n```\n\n三次握手图\n![三次握手图](/images/tcp三次握手图.png)\n\n四次挥手图\n![四次挥手图](/images/tcp四次挥手图.png)\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### linux问题: 禁ping\n\n```\n# 一次性修改\necho 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all\n\n# 开机自动修改\necho 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all\n\n# 永久禁用,加入到/etc/sysctl.conf\nnet.ipv4.icmp_echo_ignore_all=1\n```\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### linux问题: 文件锁问题\n\n```\n问题描述: php slowlog 出现session_start() 慢\n问题原因: 我们这边有A 和B 两个二级域名,A 会请求 B, 并且由于测试环境在同一台服务器,公用一个php,所以在发生调用的时候同时写了session,而php的sessions配置是默认的file方式, 这就造成了锁的问题\n问题解决: \n1. 修改代码部分\n2. php的session配置改成redis\n    session.save_handler = redis\n    session.save_path = \"tcp://x.x.x.x:xxxx\"\n```\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### linux问题: 内存释放问题\n\n```\n问题描述: 开发这边写了个统计脚本, 占用49G内存, 从日志发现脚本已经全部执行完成, 但是php脚本依然存在\n问题原因: 通过 strace -p pid 观察进程, 发现是持续性的做内存释放操作 munmap(0x7f6db77ad000, 266240)          = 0\n持续执行munmap函数是因为一直在释放内存(毕竟49G), 结果 =0 说明内存释放执行函数是返回正常了\n问题解决: \n1. 修改代码降低内存\n2. 等待一段时间内存会释放完成(测试80分钟释放完毕)\n```\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### nginx if 条件 && 的实现\n\n- 1 允许所有人访问 a.php|b.php|c.php|d.php|e.php \n- 2 仅允许127.0.0.1|172.16.0.2 ip可以访问 aa.php|bb.php \n\n```\nset $flag \"allow\";\n# 以下php 所有人可以访问\nif ( $fastcgi_script_name ~ (a.php|b.php|c.php|d.php|e.php) ) {\n        set $flag \"allow_php_ip\";\n}\n\n# 以下php 仅固定ip可以访问\nif ($fastcgi_script_name ~ (aa.php|bb.php)) {\n        set $flag \"${flag}_php\";\n}\n\nif ( $proxy_add_x_forwarded_for ~ (127.0.0.1|172.16.0.2)) {\n        set $flag \"${flag}_ip\";\n}\n# 写包含是 $flag 可能为 \"allow_php_ip_ip\" (在允许的ip服务器(127.0.0.1)上访问 /a.php)\nif ( $flag !~ \"allow_php_ip\" ) {\n        return 403;\n}\n```\n\n### nginx问题: 静态文件分离\n\n对于一般的nginx+php的方式, 我们php采用nobody用户,而代码/lumen采用web-www用户, 这样的好处是页面访问到/lumen时是nobody用户, 是无法修改代码的\n\n可能我们需求是上用户upload图片等, 这时候就可能被传上某个a.php, 这就有可能被代码注入(一般来说图片是放cdn,配置单独域名回源的,这里是直接存在项目目录)\n\n所以为了防止代码注入,我们需要限制upload目录的访问权限\n\n```\n# nginx配置如下\n        location ~ /images/.*\\.(gif|jpg|jpeg|png)$ {\n            root /lumen/storage/uploads/;\n        }\n\n```\n\n这样我们图片传到 /lumen/storage/uploads/images/ 目录, 访问是 www.xxx.com/images/x.png 来访问 且不允许其他类型文件访问.\n\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### nginx问题: root 和alias\n在配置文件映射的时候，如果使用了正则表达式，那么可能会出现无法访问文件，nginx可能会将所有的\n文件都映射成为文件夹，导致文件映射失败的情况出现；\n\n- root的例子\n\n```\nlocation /a/ {\n\troot /lumen/public;\n}\n这里实际访问的路径: www.xxx.com/a/ -> /lumen/public/a/\n```\n\n- alias的例子\n\n```\n# 注意这里目录最后加上/\nlocation /a/ {\n        alias /lumen/public/;\n}\n这里实际访问的路径: www.xxx.com/a/ -> /lumen/public/\n```\n\n\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### nginx问题: 隐藏版本信息\n\n```\nSyntax:  server_tokens on | off | build | string;\nDefault:  server_tokens on;\nContext:  http, server, location\n```\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### nginx问题: 日志出现encode内容如何查看\n\n```\n# python2 执行decode\n>>> print \"\\x22content\\x22\\x0D\\x0A\\x0D\\x0A\\xE8\\x8A\\x8A\\xE8\\x8A\\x8A\\xE8\\xBF\\x98\\xE6\\x80\\x95\\xE5\\xA6\\x9E\\xE5\\xA6\\x9E\\xE4\\xB8\\x8D\\xE8\\x80\\x81\\xE5\\xAE\\x9E\\xEF\\xBC\\x8C\\xE7\\x89\\xB9\\xE5\\x9C\\xB0\\xE8\\xBF\\x87\\xE6\\x9D\\xA5\\xE8\\xA7\\x86\\xE5\\xAF\\x9F\\xE4\\xB8\\x80\\xE4\\xB8\\x8B\\x0D\\x0A\".decode('utf-8')\n```\n\n---\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### nginx问题: default配置未设置\nnginx 未设置default时, 如果直接访问服务器外网ip, 会去请求到第一个匹配的server段, 有可能会请求到后端的服务器的内容, 这很有可能暴露我们不想暴露的服务\n一般来说开头添加如下配置\n\n```\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        deny all;\n\t}\n```\n\nnginx 配置已经配置域名方式访问, 如果访问ip会返回403, 正常来说返回403已经不会对服务器造成压力了\n\n> 可是万万没想到虽然返回了403, 但是也有700字节大小, 大量请求对小带宽来说还是有压力的\n\n```\n# \nserver {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        return 499;\n   }\n\n#其他location,if配置,\nif ($host != a.example.com) {\n    return 499;\n}\n\n```\n\n\n\n---\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n\n### nginx1.11以前trace_id 生成问题\n- 如果是前端(upstream)\n\n```\nlog_format  server_name_main '\"$request_trace_id\" [ $host $request_time ] ' '[ $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] \"$request\" '  '$body_bytes_sent \"$http_referer\" '\n                     '\"$http_user_agent\" \"$http_x_forwarded_for\" \"$bytes_sent\"'    '{$request_body}' ;\n...\n\nserver {\n        set $request_trace_id $pid$connection$bytes_sent$msec;\n            if ( $http_x_request_id != \"\" ){\n                        set $request_trace_id $http_x_request_id;\n                }\n        add_header  Bq_F_Traceid $request_trace_id;\n\t# 一定要写到location中, 因为proxy_pass\n\tlocation / {\n\n\t\tproxy_pass http://xxxx;\n                proxy_set_header  X-Request-Id        $request_trace_id;\n\n\t}\n}\n```\n\n- 如果是后端节点\n\n```\n# 一定要写到server段, 否则后端可能报404错误\nserver {\n\tlisten 80;\n    \tserver_name  openapi-community-alpha.zhangzw.com ;\n        set $request_trace_id trace-id-$pid-$connection-$bytes_sent-$msec;\n                # 如果请求头中已有该参数,则获取即可;如果没有,则使用$request_id进行填充\n                set $temp_request_id $http_x_request_id;\n                if ($temp_request_id = \"\") {\n                    set $temp_request_id $request_trace_id;\n                }\n                # 屏蔽掉原来的请求头参数\n                # proxy_set_header  x_request_id        \"\";\n                proxy_set_header  X-Request-Id \"\";\n                # 设置向后转发的请求头参数\n                proxy_set_header  X-Request-Id        $temp_request_id;\n\tlocation / {\n\t\ttry_files $uri $uri/ /index.php?$query_string;\n\t}\n}\n```\n\n\n### 修改swap\n\n```\ndd if=/dev/zero of=/data/swapfilenew bs=4096 count=4096000\n\nswapoff -a \n\n/sbin/mkswap  /data/swapfilenew\n/sbin/swapon  /data/swapfilenew\n\nvim /etc/fstab\n/data/swapfilenew none swap defaults 0 0\n```\n","content":"<p>记录一些Linux,nginx或其他服务一些问题</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"Linux问题-2020-09-02-一次dnsmasq迁移问题\"><a href=\"#Linux问题-2020-09-02-一次dnsmasq迁移问题\" class=\"headerlink\" title=\"Linux问题: 2020-09-02 一次dnsmasq迁移问题\"></a>Linux问题: 2020-09-02 一次dnsmasq迁移问题</h3><blockquote>\n<p>网卡配置如下</p>\n</blockquote>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">DEVICE</span>=em1</span><br><span class=\"line\"><span class=\"attr\">HWADDR</span>=x</span><br><span class=\"line\"><span class=\"attr\">TYPE</span>=Ethernet</span><br><span class=\"line\"><span class=\"attr\">UUID</span>=x</span><br><span class=\"line\"><span class=\"attr\">ONBOOT</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"><span class=\"attr\">NM_CONTROLLED</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"><span class=\"attr\">BOOTPROTO</span>=static</span><br><span class=\"line\"><span class=\"attr\">IPADDR0</span>=<span class=\"number\">172.16</span>.<span class=\"number\">76.100</span></span><br><span class=\"line\"><span class=\"attr\">PREFIX0</span>=<span class=\"number\">24</span></span><br><span class=\"line\"><span class=\"attr\">GATEWAY</span>=<span class=\"number\">172.16</span>.<span class=\"number\">76.1</span></span><br><span class=\"line\"><span class=\"attr\">DNS1</span>=<span class=\"number\">172.16</span>.<span class=\"number\">76.100</span></span><br><span class=\"line\"><span class=\"attr\">DNS2</span>=<span class=\"number\">172.16</span>.<span class=\"number\">76.101</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里有个大问题, 由于本身就是dns服务器, 但配置的DNS1居然是本机, 这导致service network restart 的时候会去修改 /etc/resolv.conf 的配置为 DNS1 和DNS2的ip, 此时dns服务器将无法解析外网域名</p>\n</blockquote>\n<blockquote>\n<p>因此正确的配置是</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DNS1=<span class=\"number\">119.29</span><span class=\"number\">.29</span><span class=\"number\">.29</span></span><br><span class=\"line\">DNS2=<span class=\"number\">223.5</span><span class=\"number\">.5</span><span class=\"number\">.5</span></span><br><span class=\"line\">DNS3=<span class=\"number\">114.114</span><span class=\"number\">.114</span><span class=\"number\">.114</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Linux问题-升级内核\"><a href=\"#Linux问题-升级内核\" class=\"headerlink\" title=\"Linux问题: 升级内核\"></a>Linux问题: 升级内核</h3><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm --import https:<span class=\"comment\">//www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class=\"line\">rpm -Uvh http:<span class=\"comment\">//www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看可升级的内核</span></span><br><span class=\"line\">yum --disablerepo=<span class=\"string\">\"*\"</span> --enablerepo=<span class=\"string\">\"elrepo-kernel\"</span> list available</span><br><span class=\"line\">yum --enablerepo=elrepo-kernel install kernel-ml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看已经安装的内核</span></span><br><span class=\"line\">cat /boot/grub2/grub.cfg |grep menuentry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 设置5.3的为默认</span></span><br><span class=\"line\">grub2-<span class=\"keyword\">set</span>-<span class=\"keyword\">default</span> <span class=\"string\">'CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># grub2-editenv list</span></span><br><span class=\"line\">saved_entry=CentOS Linux (<span class=\"number\">5.3</span><span class=\"number\">.13</span><span class=\"number\">-1.</span>el7.elrepo.x86_64) <span class=\"number\">7</span> (Core)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"linux问题-tcpdump抓包tcp第三次握手ack为1\"><a href=\"#linux问题-tcpdump抓包tcp第三次握手ack为1\" class=\"headerlink\" title=\"linux问题: tcpdump抓包tcp第三次握手ack为1\"></a>linux问题: tcpdump抓包tcp第三次握手ack为1</h3><ul>\n<li>执行命令监听: tcpdump -n port 80 (想要详细信息加 -vv)</li>\n</ul>\n<blockquote>\n<p>客户端 telnet x.x.x.x 80</p>\n</blockquote>\n<p>日志如下:</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcpdump  -n<span class=\"built_in\"> port </span>80</span><br><span class=\"line\">tcpdump: verbose output suppressed, use -v <span class=\"keyword\">or</span> -vv <span class=\"keyword\">for</span> full protocol decode</span><br><span class=\"line\">listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class=\"line\">11:16:40.689157<span class=\"built_in\"> IP </span>192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [SEW], seq 1306124348, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458678777 ecr 0,sackOK,eol], length 0</span><br><span class=\"line\">11:16:40.689724<span class=\"built_in\"> IP </span>192.168.53.106.http &gt; 192.168.54.141.53444: Flags [S.E], seq 1553518959, ack 1306124349, win 64308, options [mss 1410,sackOK,TS val 4208119240 ecr 458678777,nop,wscale 7], length 0</span><br><span class=\"line\">11:16:40.690320<span class=\"built_in\"> IP </span>192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [.], ack 1, win 4106, options [nop,nop,TS val 458678778 ecr 4208119240], length 0</span><br></pre></td></tr></table></figure>\n\n<p>这里第一和第二次握手都没有问题, 第三次 ack 1, 并非是seq+1</p>\n<p>这里提一下ACK, ACK 是确认值, ack 是确认编号, 第一次握手ACK=0,在第二次握手开始ACK=1, 而ack是=seq+1(收到的随机数+1)</p>\n<p>那么这里ack 1 是啥呢?  … 应该就是默认tcpdump 显示成相对值了, 通过-S 参数会显示绝对值</p>\n<ul>\n<li>执行命令监听: tcpdump -S  -n port 80</li>\n</ul>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">tcpdump</span>: <span class=\"selector-tag\">verbose</span> <span class=\"selector-tag\">output</span> <span class=\"selector-tag\">suppressed</span>, <span class=\"selector-tag\">use</span> <span class=\"selector-tag\">-v</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">-vv</span> <span class=\"selector-tag\">for</span> <span class=\"selector-tag\">full</span> <span class=\"selector-tag\">protocol</span> <span class=\"selector-tag\">decode</span></span><br><span class=\"line\"><span class=\"selector-tag\">listening</span> <span class=\"selector-tag\">on</span> <span class=\"selector-tag\">enp0s3</span>, <span class=\"selector-tag\">link-type</span> <span class=\"selector-tag\">EN10MB</span> (<span class=\"selector-tag\">Ethernet</span>), <span class=\"selector-tag\">capture</span> <span class=\"selector-tag\">size</span> 262144 <span class=\"selector-tag\">bytes</span></span><br><span class=\"line\">11<span class=\"selector-pseudo\">:16</span><span class=\"selector-pseudo\">:54.806628</span> <span class=\"selector-tag\">IP</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.54</span><span class=\"selector-class\">.141</span><span class=\"selector-class\">.53516</span> &gt; 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.106</span><span class=\"selector-class\">.http</span>: <span class=\"selector-tag\">Flags</span> <span class=\"selector-attr\">[S]</span>, <span class=\"selector-tag\">seq</span> 316359286, <span class=\"selector-tag\">win</span> 65535, <span class=\"selector-tag\">options</span> <span class=\"selector-attr\">[mss 1460,nop,wscale 5,nop,nop,TS val 458692791 ecr 0,sackOK,eol]</span>, <span class=\"selector-tag\">length</span> 0</span><br><span class=\"line\">11<span class=\"selector-pseudo\">:16</span><span class=\"selector-pseudo\">:54.806861</span> <span class=\"selector-tag\">IP</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.106</span><span class=\"selector-class\">.http</span> &gt; 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.54</span><span class=\"selector-class\">.141</span><span class=\"selector-class\">.53516</span>: <span class=\"selector-tag\">Flags</span> <span class=\"selector-attr\">[S.]</span>, <span class=\"selector-tag\">seq</span> 1113466641, <span class=\"selector-tag\">ack</span> 316359287, <span class=\"selector-tag\">win</span> 64308, <span class=\"selector-tag\">options</span> <span class=\"selector-attr\">[mss 1410,sackOK,TS val 4208133357 ecr 458692791,nop,wscale 7]</span>, <span class=\"selector-tag\">length</span> 0</span><br><span class=\"line\">11<span class=\"selector-pseudo\">:16</span><span class=\"selector-pseudo\">:54.807576</span> <span class=\"selector-tag\">IP</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.54</span><span class=\"selector-class\">.141</span><span class=\"selector-class\">.53516</span> &gt; 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.53</span><span class=\"selector-class\">.106</span><span class=\"selector-class\">.http</span>: <span class=\"selector-tag\">Flags</span> <span class=\"selector-attr\">[.]</span>, <span class=\"selector-tag\">ack</span> 1113466642, <span class=\"selector-tag\">win</span> 4106, <span class=\"selector-tag\">options</span> <span class=\"selector-attr\">[nop,nop,TS val 458692792 ecr 4208133357]</span>, <span class=\"selector-tag\">length</span> 0</span><br></pre></td></tr></table></figure>\n\n<p>三次握手图<br><img src=\"/images/tcp%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%BE.png\" alt=\"三次握手图\"></p>\n<p>四次挥手图<br><img src=\"/images/tcp%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E5%9B%BE.png\" alt=\"四次挥手图\"></p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"linux问题-禁ping\"><a href=\"#linux问题-禁ping\" class=\"headerlink\" title=\"linux问题: 禁ping\"></a>linux问题: 禁ping</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一次性修改</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> 1 &gt; <span class=\"string\">/proc/sys/net/ipv4/icmp_echo_ignore_all</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机自动修改</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> 1 &gt; <span class=\"string\">/proc/sys/net/ipv4/icmp_echo_ignore_all</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 永久禁用,加入到/etc/sysctl.conf</span></span><br><span class=\"line\">net.ipv4.icmp_<span class=\"keyword\">echo</span>_ignore_all=1</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"linux问题-文件锁问题\"><a href=\"#linux问题-文件锁问题\" class=\"headerlink\" title=\"linux问题: 文件锁问题\"></a>linux问题: 文件锁问题</h3><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">问题描述: php slowlog 出现session_start() 慢</span><br><span class=\"line\">问题原因: 我们这边有A 和B 两个二级域名,A 会请求 B, 并且由于测试环境在同一台服务器,公用一个php,所以在发生调用的时候同时写了session,而php的sessions配置是默认的file方式, 这就造成了锁的问题</span><br><span class=\"line\">问题解决: </span><br><span class=\"line\"><span class=\"number\">1</span>. 修改代码部分</span><br><span class=\"line\"><span class=\"number\">2</span>. php的session配置改成redis</span><br><span class=\"line\">    session<span class=\"selector-class\">.save_handler</span> = redis</span><br><span class=\"line\">    session<span class=\"selector-class\">.save_path</span> = <span class=\"string\">\"tcp://x.x.x.x:xxxx\"</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"linux问题-内存释放问题\"><a href=\"#linux问题-内存释放问题\" class=\"headerlink\" title=\"linux问题: 内存释放问题\"></a>linux问题: 内存释放问题</h3><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">问题描述: 开发这边写了个统计脚本, 占用49G内存, 从日志发现脚本已经全部执行完成, 但是php脚本依然存在</span></span><br><span class=\"line\"><span class=\"section\">问题原因: 通过 strace -p pid 观察进程, 发现是持续性的做内存释放操作 munmap(0x7f6db77ad000, 266240)          = 0</span></span><br><span class=\"line\">持续执行munmap函数是因为一直在释放内存(毕竟49G), 结果 =0 说明内存释放执行函数是返回正常了</span><br><span class=\"line\"><span class=\"section\">问题解决: </span></span><br><span class=\"line\">1. 修改代码降低内存</span><br><span class=\"line\">2. 等待一段时间内存会释放完成(测试80分钟释放完毕)</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"nginx-if-条件-amp-amp-的实现\"><a href=\"#nginx-if-条件-amp-amp-的实现\" class=\"headerlink\" title=\"nginx if 条件 &amp;&amp; 的实现\"></a>nginx if 条件 &amp;&amp; 的实现</h3><ul>\n<li>1 允许所有人访问 a.php|b.php|c.php|d.php|e.php </li>\n<li>2 仅允许127.0.0.1|172.16.0.2 ip可以访问 aa.php|bb.php </li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"allow\"</span>;</span><br><span class=\"line\"><span class=\"comment\"># 以下php 所有人可以访问</span></span><br><span class=\"line\"><span class=\"attribute\">if</span> ( <span class=\"variable\">$fastcgi_script_name</span> <span class=\"regexp\">~ (a.php|b.php|c.php|d.php|e.php)</span> ) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"allow_php_ip\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下php 仅固定ip可以访问</span></span><br><span class=\"line\"><span class=\"attribute\">if</span> (<span class=\"variable\">$fastcgi_script_name</span> <span class=\"regexp\">~ (aa.php|bb.php))</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"<span class=\"variable\">$&#123;flag&#125;</span>_php\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">if</span> ( <span class=\"variable\">$proxy_add_x_forwarded_for</span> <span class=\"regexp\">~ (127.0.0.1|172.16.0.2))</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"<span class=\"variable\">$&#123;flag&#125;</span>_ip\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 写包含是 $flag 可能为 \"allow_php_ip_ip\" (在允许的ip服务器(127.0.0.1)上访问 /a.php)</span></span><br><span class=\"line\"><span class=\"attribute\">if</span> ( <span class=\"variable\">$flag</span> !<span class=\"regexp\">~ \"allow_php_ip\"</span> ) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">403</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"nginx问题-静态文件分离\"><a href=\"#nginx问题-静态文件分离\" class=\"headerlink\" title=\"nginx问题: 静态文件分离\"></a>nginx问题: 静态文件分离</h3><p>对于一般的nginx+php的方式, 我们php采用nobody用户,而代码/lumen采用web-www用户, 这样的好处是页面访问到/lumen时是nobody用户, 是无法修改代码的</p>\n<p>可能我们需求是上用户upload图片等, 这时候就可能被传上某个a.php, 这就有可能被代码注入(一般来说图片是放cdn,配置单独域名回源的,这里是直接存在项目目录)</p>\n<p>所以为了防止代码注入,我们需要限制upload目录的访问权限</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nginx配置如下</span></span><br><span class=\"line\">        location ~ <span class=\"regexp\">/images/</span>.*\\.(gif|jpg|jpeg|png)$ &#123;</span><br><span class=\"line\">            root <span class=\"regexp\">/lumen/</span>storage<span class=\"regexp\">/uploads/</span>;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样我们图片传到 /lumen/storage/uploads/images/ 目录, 访问是 <a href=\"http://www.xxx.com/images/x.png\" target=\"_blank\" rel=\"noopener\">www.xxx.com/images/x.png</a> 来访问 且不允许其他类型文件访问.</p>\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"nginx问题-root-和alias\"><a href=\"#nginx问题-root-和alias\" class=\"headerlink\" title=\"nginx问题: root 和alias\"></a>nginx问题: root 和alias</h3><p>在配置文件映射的时候，如果使用了正则表达式，那么可能会出现无法访问文件，nginx可能会将所有的<br>文件都映射成为文件夹，导致文件映射失败的情况出现；</p>\n<ul>\n<li>root的例子</li>\n</ul>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location <span class=\"regexp\">/a/</span> &#123;</span><br><span class=\"line\">\troot <span class=\"regexp\">/lumen/</span><span class=\"keyword\">public</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">这里实际访问的路径: www.xxx.com<span class=\"regexp\">/a/</span> -&gt; <span class=\"regexp\">/lumen/</span><span class=\"keyword\">public</span><span class=\"regexp\">/a/</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>alias的例子</li>\n</ul>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意这里目录最后加上/</span></span><br><span class=\"line\">location <span class=\"regexp\">/a/</span> &#123;</span><br><span class=\"line\">        alias <span class=\"regexp\">/lumen/public/</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">这里实际访问的路径: www.xxx.com<span class=\"regexp\">/a/</span><span class=\"function\"> -&gt;</span> <span class=\"regexp\">/lumen/public/</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"nginx问题-隐藏版本信息\"><a href=\"#nginx问题-隐藏版本信息\" class=\"headerlink\" title=\"nginx问题: 隐藏版本信息\"></a>nginx问题: 隐藏版本信息</h3><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Syntax:  server_tokens <span class=\"keyword\">on</span> | off | build | <span class=\"built_in\">string</span>;</span><br><span class=\"line\">Default:  server_tokens <span class=\"keyword\">on</span>;</span><br><span class=\"line\">Context:  http, server, location</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"nginx问题-日志出现encode内容如何查看\"><a href=\"#nginx问题-日志出现encode内容如何查看\" class=\"headerlink\" title=\"nginx问题: 日志出现encode内容如何查看\"></a>nginx问题: 日志出现encode内容如何查看</h3><figure class=\"highlight taggerscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># python2 执行decode</span><br><span class=\"line\">&gt;&gt;&gt; print \"<span class=\"symbol\">\\x</span>22content<span class=\"symbol\">\\x</span>22<span class=\"symbol\">\\x</span>0D<span class=\"symbol\">\\x</span>0A<span class=\"symbol\">\\x</span>0D<span class=\"symbol\">\\x</span>0A<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>8A<span class=\"symbol\">\\x</span>8A<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>8A<span class=\"symbol\">\\x</span>8A<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>BF<span class=\"symbol\">\\x</span>98<span class=\"symbol\">\\x</span>E6<span class=\"symbol\">\\x</span>80<span class=\"symbol\">\\x</span>95<span class=\"symbol\">\\x</span>E5<span class=\"symbol\">\\x</span>A6<span class=\"symbol\">\\x</span>9E<span class=\"symbol\">\\x</span>E5<span class=\"symbol\">\\x</span>A6<span class=\"symbol\">\\x</span>9E<span class=\"symbol\">\\x</span>E4<span class=\"symbol\">\\x</span>B8<span class=\"symbol\">\\x</span>8D<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>80<span class=\"symbol\">\\x</span>81<span class=\"symbol\">\\x</span>E5<span class=\"symbol\">\\x</span>AE<span class=\"symbol\">\\x</span>9E<span class=\"symbol\">\\x</span>EF<span class=\"symbol\">\\x</span>BC<span class=\"symbol\">\\x</span>8C<span class=\"symbol\">\\x</span>E7<span class=\"symbol\">\\x</span>89<span class=\"symbol\">\\x</span>B9<span class=\"symbol\">\\x</span>E5<span class=\"symbol\">\\x</span>9C<span class=\"symbol\">\\x</span>B0<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>BF<span class=\"symbol\">\\x</span>87<span class=\"symbol\">\\x</span>E6<span class=\"symbol\">\\x</span>9D<span class=\"symbol\">\\x</span>A5<span class=\"symbol\">\\x</span>E8<span class=\"symbol\">\\x</span>A7<span class=\"symbol\">\\x</span>86<span class=\"symbol\">\\x</span>E5<span class=\"symbol\">\\x</span>AF<span class=\"symbol\">\\x</span>9F<span class=\"symbol\">\\x</span>E4<span class=\"symbol\">\\x</span>B8<span class=\"symbol\">\\x</span>80<span class=\"symbol\">\\x</span>E4<span class=\"symbol\">\\x</span>B8<span class=\"symbol\">\\x</span>8B<span class=\"symbol\">\\x</span>0D<span class=\"symbol\">\\x</span>0A\".decode('utf-8')</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"nginx问题-default配置未设置\"><a href=\"#nginx问题-default配置未设置\" class=\"headerlink\" title=\"nginx问题: default配置未设置\"></a>nginx问题: default配置未设置</h3><p>nginx 未设置default时, 如果直接访问服务器外网ip, 会去请求到第一个匹配的server段, 有可能会请求到后端的服务器的内容, 这很有可能暴露我们不想暴露的服务<br>一般来说开头添加如下配置</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"built_in\"> server </span>&#123;</span><br><span class=\"line\">       listen       80 default_server;</span><br><span class=\"line\">       listen       [::]:80 default_server;</span><br><span class=\"line\">       server_name  _;</span><br><span class=\"line\">       deny all;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>nginx 配置已经配置域名方式访问, 如果访问ip会返回403, 正常来说返回403已经不会对服务器造成压力了</p>\n<blockquote>\n<p>可是万万没想到虽然返回了403, 但是也有700字节大小, 大量请求对小带宽来说还是有压力的</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># </span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80 default_server;</span><br><span class=\"line\">        listen       [::]:80 default_server;</span><br><span class=\"line\">        server_name  _;</span><br><span class=\"line\">        return 499;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#其他location,if配置,</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$host</span> != a.example.com) &#123;</span><br><span class=\"line\">    return 499;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n\n<h3 id=\"nginx1-11以前trace-id-生成问题\"><a href=\"#nginx1-11以前trace-id-生成问题\" class=\"headerlink\" title=\"nginx1.11以前trace_id 生成问题\"></a>nginx1.11以前trace_id 生成问题</h3><ul>\n<li>如果是前端(upstream)</li>\n</ul>\n<figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">log_format  server_name_main <span class=\"string\">'\"<span class=\"variable\">$request_trace_id</span>\" [ <span class=\"variable\">$host</span> <span class=\"variable\">$request_time</span> ] '</span> <span class=\"string\">'[ <span class=\"variable\">$upstream_addr</span> <span class=\"variable\">$upstream_response_time</span> ] '</span> <span class=\"string\">'<span class=\"variable\">$status</span> '</span> <span class=\"string\">'<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span>  <span class=\"string\">'<span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                     <span class=\"string\">'\"<span class=\"variable\">$http_user_agent</span>\" \"<span class=\"variable\">$http_x_forwarded_for</span>\" \"<span class=\"variable\">$bytes_sent</span>\"'</span>    <span class=\"string\">'&#123;<span class=\"variable\">$request_body</span>&#125;'</span> ;</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">server</span> &#123;</span><br><span class=\"line\">        set <span class=\"variable\">$request_trace_id</span> <span class=\"variable\">$pid</span><span class=\"variable\">$connection</span><span class=\"variable\">$bytes_sent</span><span class=\"variable\">$msec</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( <span class=\"variable\">$http_x_request_id</span> != <span class=\"string\">\"\"</span> )&#123;</span><br><span class=\"line\">                        set <span class=\"variable\">$request_trace_id</span> <span class=\"variable\">$http_x_request_id</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        <span class=\"keyword\">add_header</span>  <span class=\"keyword\">Bq_F_Traceid</span> $request_trace_id;</span><br><span class=\"line\">\t<span class=\"comment\"># 一定要写到location中, 因为proxy_pass</span></span><br><span class=\"line\">\tlocation / &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tproxy_pass http://xxxx;</span><br><span class=\"line\">                proxy_set_header  X-Request-Id        <span class=\"variable\">$request_trace_id</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>如果是后端节点</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一定要写到server段, 否则后端可能报404错误</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">\tlisten 80;</span><br><span class=\"line\">    \tserver_name  openapi-community-alpha.zhangzw.com ;</span><br><span class=\"line\">        <span class=\"builtin-name\">set</span> <span class=\"variable\">$request_trace_id</span> trace-id-<span class=\"variable\">$pid</span>-<span class=\"variable\">$connection</span>-<span class=\"variable\">$bytes_sent</span>-<span class=\"variable\">$msec</span>;</span><br><span class=\"line\">                # 如果请求头中已有该参数,则获取即可;如果没有,则使用<span class=\"variable\">$request_id</span>进行填充</span><br><span class=\"line\">                <span class=\"builtin-name\">set</span> <span class=\"variable\">$temp_request_id</span> <span class=\"variable\">$http_x_request_id</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"variable\">$temp_request_id</span> = <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">                    <span class=\"builtin-name\">set</span> <span class=\"variable\">$temp_request_id</span> <span class=\"variable\">$request_trace_id</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                # 屏蔽掉原来的请求头参数</span><br><span class=\"line\">                # proxy_set_header  x_request_id        <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">                proxy_set_header  X-Request-Id <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">                # 设置向后转发的请求头参数</span><br><span class=\"line\">                proxy_set_header  X-Request-Id        <span class=\"variable\">$temp_request_id</span>;</span><br><span class=\"line\">\tlocation / &#123;</span><br><span class=\"line\">\t\ttry_files <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.php?<span class=\"variable\">$query_string</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改swap\"><a href=\"#修改swap\" class=\"headerlink\" title=\"修改swap\"></a>修改swap</h3><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dd <span class=\"keyword\">if</span>=<span class=\"regexp\">/dev/</span>zero of=<span class=\"regexp\">/data/</span>swapfilenew bs=<span class=\"number\">4096</span> <span class=\"keyword\">count</span>=<span class=\"number\">4096000</span></span><br><span class=\"line\"></span><br><span class=\"line\">swapoff -a </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"regexp\">/sbin/m</span>kswap  <span class=\"regexp\">/data/</span>swapfilenew</span><br><span class=\"line\"><span class=\"regexp\">/sbin/</span>swapon  <span class=\"regexp\">/data/</span>swapfilenew</span><br><span class=\"line\"></span><br><span class=\"line\">vim <span class=\"regexp\">/etc/</span>fstab</span><br><span class=\"line\"><span class=\"regexp\">/data/</span>swapfilenew none swap defaults <span class=\"number\">0</span> <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/26/9-linux遇到一些问题统计总结/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"问题总结","slug":"linux/问题总结","permalink":"https://blog.k1s.club/categories/linux/问题总结/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/tags/linux/"}]},{"title":"mysql5.7二进制部署","date":"2019-09-26T07:11:05.000Z","path":"2019/09/26/8-mysql5-7二进制部署/","text":"二进制方式部署mysql5.7 下载glibc二进制包12345#打开下载页面, 可能会有小版本更新(注意：选择操作系统时选Linux-Generic）https://dev.mysql.com/downloads/mysql/5.7.html#downloads# 最新的可能有小版本变化wget https://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 安装配置1234567891011121314151617181920212223242526272829303132333435363738394041tar -xvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gzmv mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/cd /usr/local/# 我的镜像是安装过5.5mysql, 所以需要mv一下mv mysql mysql-5.5.37# 由于以前安装过php指定了该mysq目录, 这可能导致以前安装的php缺少libmysqlclient.so.18ln -s /usr/local/mysql-5.5.37/lib/libmysqlclient.so.18 /usr/local/mysql-5.7.24-linux-glibc2.12-x86_64/lib/libmysqlclient.so.18ln -s mysql-5.7.24-linux-glibc2.12-x86_64 mysql# 添加启动文件\\cp mysql/support-files/mysql.server /etc/init.d/mysqldecho \"PATH=$PATH:/usr/local/mysql/bin/\" &gt;&gt;~/.bashrc# 可选wget http://centos.mirrors.ucloud.cn/centos/6/os/x86_64/Packages/numactl-2.0.9-2.el6.x86_64.rpmyum localinstall numactl-2.0.9-2.el6.x86_64.rpm\\rm numactl-2.0.9-2.el6.x86_64.rpmuseradd mysql# 配置下mysql的数据目录cd /data/mkdir u01mkdir u02chown -R mysql.mysql u01chown -R mysql.mysql u02chmod 750 u01chmod 750 u02cd /data/u01/# 初始化/usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/u01cat auto.cnf# 启动服务 (在这之前准备好 /etc/my.cnf)/etc/init.d/mysqld start# 记录下variablesmysql -e \"show global variables\" &gt;mysql_option_default.log my.cnf123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172[client]port = 3306socket = /data/u01/mysql.sock[mysql]prompt=\"\\u@m1-u [\\d]&gt; \"no-auto-rehash[mysqld]user = mysqlport = 3306basedir = /usr/local/mysqldatadir = /data/u01socket = /data/u01/mysql.sockpid-file = /data/u01/m1-u.pidtmpdir = /data/u02server-id = 1001character-set-server = utf8skip_name_resolve = 1innodb_file_per_table = 1explicit_defaults_for_timestamp = 0# buffer&amp;cachetable_open_cache = 100table_definition_cache = 400table_open_cache_instances = 64sort_buffer_size = 4Mjoin_buffer_size = 4Mread_buffer_size = 8Mread_rnd_buffer_size = 4M# thread&amp;connectionthread_stack = 256Kthread_cache_size = 768back_log = 1024max_connections = 3000max_connect_errors = 1000000# temptabletmp_table_size = 32Mmax_heap_table_size = 32M# networkmax_allowed_packet = 32M#lock_wait_timeout = 3600#interactive_timeout = 600#wait_timeout = 600# query cachequery_cache_size = 0query_cache_type = 0# 设置errorlog、slowlog和generallog的时区，默认UTClog_timestamps = SYSTEM# error-loglog_error = /data/u02/mysqld.log# slow-logslow_query_log = 1slow_query_log_file = /data/u02/slow.loglong_query_time = 0.1log_queries_not_using_indexes =1log_throttle_queries_not_using_indexes = 60min_examined_row_limit = 100log_slow_admin_statements = 1log_slow_slave_statements = 1# general log#general-log = 1general_log_file=/data/u02/query.log# binlogbinlog_format = rowbinlog_checksum = 1log-bin = /data/u02/bdm1-binlog-bin-index = /data/u02/bdm1-bin.indexsync_binlog = 0binlog_cache_size = 4Mmax_binlog_cache_size = 2Gmax_binlog_size = 512Mexpire_logs_days = 15# GTIDgtid_mode = onenforce_gtid_consistency = 1log_slave_updates# Replicationmaster_info_repository = TABLErelay_log_info_repository = TABLEslave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'relay_log_recovery = 1relay_log_purge = 1relay-log=/data/u02/bdm1-relay-binrelay-log-index=/data/u02/bdm1-relay-bin.index# innodb-buffer&amp;cacheinnodb_buffer_pool_size = 2Ginnodb_buffer_pool_instances = 4#innodb_additional_mem_pool_size = 16Minnodb_max_dirty_pages_pct = 50# innodb loginnodb_data_file_path = ibdata1:1G:autoextendinnodb_log_file_size = 1Ginnodb_log_files_in_group = 2innodb_flush_log_at_trx_commit = 2innodb_log_buffer_size = 32M#innodb_max_undo_log_size = 4G#innodb_undo_directory = undologinnodb_undo_tablespaces = 4# innodb-ioinnodb_flush_method = O_DIRECTinnodb_io_capacity = 600innodb_io_capacity_max = 2000innodb_flush_sync = 0innodb_flush_neighbors = 0#innodb_lru_scan_depth = 4000innodb_write_io_threads = 8innodb_read_io_threads = 8innodb_purge_threads = 4innodb_page_cleaners = 4# transaction,lock#innodb_sync_spin_loops = 100#innodb_spin_wait_delay = 30innodb_lock_wait_timeout = 10innodb_print_all_deadlocks = 1innodb_rollback_on_timeout = 1innodb_open_files = 65535innodb_online_alter_log_max_size = 2G# innodb statusinnodb_status_file = 1# 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快innodb_status_output = 0innodb_status_output_locks = 0#performance_schemaperformance_schema = 1performance_schema_instrument = '%=on'#innodb monitorinnodb_monitor_enable=\"module_innodb\"innodb_monitor_enable=\"module_server\"innodb_monitor_enable=\"module_dml\"innodb_monitor_enable=\"module_ddl\"innodb_monitor_enable=\"module_trx\"innodb_monitor_enable=\"module_os\"innodb_monitor_enable=\"module_purge\"innodb_monitor_enable=\"module_log\"innodb_monitor_enable=\"module_lock\"innodb_monitor_enable=\"module_buffer\"innodb_monitor_enable=\"module_index\"innodb_monitor_enable=\"module_ibuf_system\"innodb_monitor_enable=\"module_buffer_page\"innodb_monitor_enable=\"module_adaptive_hash\"# MyISAMkey_buffer_size = 1024Mbulk_insert_buffer_size = 64Mmyisam_sort_buffer_size = 128Mmyisam_repair_threads = 1[mysqldump]quickmax_allowed_packet = 32M","raw":"---\ntitle: mysql5.7二进制部署\ncopyright: true\ndate: 2019-09-26 15:11:05\ntags:\n  - mysql\n  - mysql5.7\ncategories:\n  - [技术文档]\n  - [mysql]\n---\n\n> 二进制方式部署mysql5.7\n\n<!-- more -->\n\n### 下载glibc二进制包\n```\n#打开下载页面, 可能会有小版本更新(注意：选择操作系统时选Linux-Generic）\nhttps://dev.mysql.com/downloads/mysql/5.7.html#downloads\n\n# 最新的可能有小版本变化\nwget https://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz\n```\n\n### 安装配置 \n```\ntar -xvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz\nmv mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/\ncd /usr/local/\n\n# 我的镜像是安装过5.5mysql, 所以需要mv一下\nmv mysql mysql-5.5.37\n\n# 由于以前安装过php指定了该mysq目录, 这可能导致以前安装的php缺少libmysqlclient.so.18\nln -s /usr/local/mysql-5.5.37/lib/libmysqlclient.so.18 /usr/local/mysql-5.7.24-linux-glibc2.12-x86_64/lib/libmysqlclient.so.18\nln -s mysql-5.7.24-linux-glibc2.12-x86_64 mysql\n\n# 添加启动文件\n\\cp mysql/support-files/mysql.server /etc/init.d/mysqld\necho \"PATH=$PATH:/usr/local/mysql/bin/\" >>~/.bashrc\n\n# 可选\nwget http://centos.mirrors.ucloud.cn/centos/6/os/x86_64/Packages/numactl-2.0.9-2.el6.x86_64.rpm\nyum localinstall numactl-2.0.9-2.el6.x86_64.rpm\n\\rm numactl-2.0.9-2.el6.x86_64.rpm\n\nuseradd mysql\n\n# 配置下mysql的数据目录\ncd /data/\nmkdir u01\nmkdir u02\nchown -R mysql.mysql u01\nchown -R mysql.mysql u02\nchmod 750 u01\nchmod 750 u02\ncd /data/u01/\n\n# 初始化\n/usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/u01\ncat auto.cnf\n\n# 启动服务 (在这之前准备好 /etc/my.cnf)\n/etc/init.d/mysqld start\n\n# 记录下variables\nmysql -e \"show global variables\" >mysql_option_default.log\n```\n\n\n### my.cnf\n```\n[client]\nport = 3306\nsocket = /data/u01/mysql.sock\n\n[mysql]\nprompt=\"\\u@m1-u [\\d]> \"\nno-auto-rehash\n\n[mysqld]\nuser = mysql\nport = 3306\nbasedir = /usr/local/mysql\ndatadir = /data/u01\nsocket = /data/u01/mysql.sock\npid-file = /data/u01/m1-u.pid\ntmpdir = /data/u02\nserver-id = 1001\ncharacter-set-server = utf8\nskip_name_resolve = 1\ninnodb_file_per_table = 1\nexplicit_defaults_for_timestamp = 0\n\n# buffer&cache\ntable_open_cache = 100\ntable_definition_cache = 400\ntable_open_cache_instances = 64\nsort_buffer_size = 4M\njoin_buffer_size = 4M\nread_buffer_size = 8M\nread_rnd_buffer_size = 4M\n\n# thread&connection\nthread_stack = 256K\nthread_cache_size = 768\nback_log = 1024\nmax_connections = 3000\nmax_connect_errors = 1000000\n\n# temptable\ntmp_table_size = 32M\nmax_heap_table_size = 32M\n\n# network\nmax_allowed_packet = 32M\n#lock_wait_timeout = 3600\n#interactive_timeout = 600\n#wait_timeout = 600\n\n# query cache\nquery_cache_size = 0\nquery_cache_type = 0\n\n# 设置errorlog、slowlog和generallog的时区，默认UTC\nlog_timestamps = SYSTEM\n\n# error-log\nlog_error = /data/u02/mysqld.log\n\n# slow-log\nslow_query_log = 1\nslow_query_log_file = /data/u02/slow.log\nlong_query_time = 0.1\nlog_queries_not_using_indexes =1\nlog_throttle_queries_not_using_indexes = 60\nmin_examined_row_limit = 100\nlog_slow_admin_statements = 1\nlog_slow_slave_statements = 1\n\n# general log\n#general-log = 1\ngeneral_log_file=/data/u02/query.log\n\n# binlog\nbinlog_format = row\nbinlog_checksum = 1\nlog-bin = /data/u02/bdm1-bin\nlog-bin-index = /data/u02/bdm1-bin.index\nsync_binlog = 0\nbinlog_cache_size = 4M\nmax_binlog_cache_size = 2G\nmax_binlog_size = 512M\nexpire_logs_days = 15\n\n# GTID\ngtid_mode = on\nenforce_gtid_consistency = 1\nlog_slave_updates\n\n# Replication\nmaster_info_repository = TABLE\nrelay_log_info_repository = TABLE\nslave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'\nrelay_log_recovery = 1\nrelay_log_purge = 1\nrelay-log=/data/u02/bdm1-relay-bin\nrelay-log-index=/data/u02/bdm1-relay-bin.index\n\n# innodb-buffer&cache\ninnodb_buffer_pool_size = 2G\ninnodb_buffer_pool_instances = 4\n#innodb_additional_mem_pool_size = 16M\ninnodb_max_dirty_pages_pct = 50\n\n# innodb log\ninnodb_data_file_path = ibdata1:1G:autoextend\ninnodb_log_file_size = 1G\ninnodb_log_files_in_group = 2\ninnodb_flush_log_at_trx_commit = 2\ninnodb_log_buffer_size = 32M\n#innodb_max_undo_log_size = 4G\n#innodb_undo_directory = undolog\ninnodb_undo_tablespaces = 4\n\n# innodb-io\ninnodb_flush_method = O_DIRECT\ninnodb_io_capacity = 600\ninnodb_io_capacity_max = 2000\ninnodb_flush_sync = 0\ninnodb_flush_neighbors = 0\n#innodb_lru_scan_depth = 4000\ninnodb_write_io_threads = 8\ninnodb_read_io_threads = 8\ninnodb_purge_threads = 4\ninnodb_page_cleaners = 4\n\n# transaction,lock\n#innodb_sync_spin_loops = 100\n#innodb_spin_wait_delay = 30\ninnodb_lock_wait_timeout = 10\ninnodb_print_all_deadlocks = 1\ninnodb_rollback_on_timeout = 1\n\ninnodb_open_files = 65535\n\ninnodb_online_alter_log_max_size = 2G\n\n# innodb status\ninnodb_status_file = 1\n# 注意: 开启 innodb_status_output & innodb_status_output_locks 后, 可能会导致log-error文件增长较快\ninnodb_status_output = 0\ninnodb_status_output_locks = 0\n\n#performance_schema\nperformance_schema = 1\nperformance_schema_instrument = '%=on'\n\n#innodb monitor\ninnodb_monitor_enable=\"module_innodb\"\ninnodb_monitor_enable=\"module_server\"\ninnodb_monitor_enable=\"module_dml\"\ninnodb_monitor_enable=\"module_ddl\"\ninnodb_monitor_enable=\"module_trx\"\ninnodb_monitor_enable=\"module_os\"\ninnodb_monitor_enable=\"module_purge\"\ninnodb_monitor_enable=\"module_log\"\ninnodb_monitor_enable=\"module_lock\"\ninnodb_monitor_enable=\"module_buffer\"\ninnodb_monitor_enable=\"module_index\"\ninnodb_monitor_enable=\"module_ibuf_system\"\ninnodb_monitor_enable=\"module_buffer_page\"\ninnodb_monitor_enable=\"module_adaptive_hash\"\n\n# MyISAM\nkey_buffer_size = 1024M\nbulk_insert_buffer_size = 64M\nmyisam_sort_buffer_size = 128M\nmyisam_repair_threads = 1\n\n\n[mysqldump]\nquick\nmax_allowed_packet = 32M\n```\n","content":"<blockquote>\n<p>二进制方式部署mysql5.7</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<h3 id=\"下载glibc二进制包\"><a href=\"#下载glibc二进制包\" class=\"headerlink\" title=\"下载glibc二进制包\"></a>下载glibc二进制包</h3><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#打开下载页面, 可能会有小版本更新(注意：选择操作系统时选Linux-Generic）</span></span><br><span class=\"line\"><span class=\"symbol\">https:</span>/<span class=\"regexp\">/dev.mysql.com/downloads</span><span class=\"regexp\">/mysql/</span><span class=\"number\">5.7</span>.html<span class=\"comment\">#downloads</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最新的可能有小版本变化</span></span><br><span class=\"line\">wget <span class=\"symbol\">https:</span>/<span class=\"regexp\">/cdn.mysql.com/</span>Downloads/MySQL-<span class=\"number\">5.7</span>/mysql-<span class=\"number\">5.7</span>.<span class=\"number\">24</span>-linux-glibc2.<span class=\"number\">12</span>-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -xvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br><span class=\"line\">mv mysql-5.7.24-linux-glibc2.12-x86_64 <span class=\"string\">/usr/local/</span></span><br><span class=\"line\"><span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 我的镜像是安装过5.5mysql, 所以需要mv一下</span></span><br><span class=\"line\">mv mysql mysql-5.5.37</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 由于以前安装过php指定了该mysq目录, 这可能导致以前安装的php缺少libmysqlclient.so.18</span></span><br><span class=\"line\">ln -s <span class=\"string\">/usr/local/mysql-5.5.37/lib/libmysqlclient.so.18</span> <span class=\"string\">/usr/local/mysql-5.7.24-linux-glibc2.12-x86_64/lib/libmysqlclient.so.18</span></span><br><span class=\"line\">ln -s mysql-5.7.24-linux-glibc2.12-x86_64 mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加启动文件</span></span><br><span class=\"line\">\\cp mysql/support-files/mysql.server <span class=\"string\">/etc/init.d/mysqld</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"PATH=$PATH:/usr/local/mysql/bin/\"</span> &gt;&gt;~<span class=\"string\">/.bashrc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可选</span></span><br><span class=\"line\">wget http:<span class=\"string\">//centos.mirrors.ucloud.cn/centos/6/os/x86_64/Packages/numactl-2.0.9-2.el6.x86_64.rpm</span></span><br><span class=\"line\">yum localinstall numactl-2.0.9-2.el6.x86_64.rpm</span><br><span class=\"line\">\\rm numactl-2.0.9-2.el6.x86_64.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">useradd mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置下mysql的数据目录</span></span><br><span class=\"line\"><span class=\"keyword\">cd</span> <span class=\"string\">/data/</span></span><br><span class=\"line\">mkdir u01</span><br><span class=\"line\">mkdir u02</span><br><span class=\"line\">chown -R mysql.mysql u01</span><br><span class=\"line\">chown -R mysql.mysql u02</span><br><span class=\"line\">chmod 750 u01</span><br><span class=\"line\">chmod 750 u02</span><br><span class=\"line\"><span class=\"keyword\">cd</span> <span class=\"string\">/data/u01/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 初始化</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/mysql/bin/mysqld</span> <span class=\"params\">--initialize-insecure</span> <span class=\"params\">--user=mysql</span> <span class=\"params\">--basedir=/usr/local/mysql</span> <span class=\"params\">--datadir=/data/u01</span></span><br><span class=\"line\">cat auto.cnf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务 (在这之前准备好 /etc/my.cnf)</span></span><br><span class=\"line\"><span class=\"string\">/etc/init.d/mysqld</span> start</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 记录下variables</span></span><br><span class=\"line\">mysql -e <span class=\"string\">\"show global variables\"</span> &gt;mysql_option_default.log</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"my-cnf\"><a href=\"#my-cnf\" class=\"headerlink\" title=\"my.cnf\"></a>my.cnf</h3><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[client]</span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">socket = /data/u01/mysql.sock</span><br><span class=\"line\"></span><br><span class=\"line\">[mysql]</span><br><span class=\"line\">prompt=<span class=\"string\">\"\\u@m1-u [\\d]&gt; \"</span></span><br><span class=\"line\">no-auto-rehash</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">user = mysql</span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">basedir = /usr/local/mysql</span><br><span class=\"line\">datadir = /data/u01</span><br><span class=\"line\">socket = /data/u01/mysql.sock</span><br><span class=\"line\">pid-file = /data/u01/m1-u.pid</span><br><span class=\"line\">tmpdir = /data/u02</span><br><span class=\"line\">server-id = 1001</span><br><span class=\"line\">character-set-server = utf8</span><br><span class=\"line\">skip_name_resolve = 1</span><br><span class=\"line\">innodb_file_per_table = 1</span><br><span class=\"line\">explicit_defaults_for_timestamp = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># buffer&amp;cache</span></span><br><span class=\"line\">table_open_cache = 100</span><br><span class=\"line\">table_definition_cache = 400</span><br><span class=\"line\">table_open_cache_instances = 64</span><br><span class=\"line\">sort_buffer_size = 4M</span><br><span class=\"line\">join_buffer_size = 4M</span><br><span class=\"line\">read_buffer_size = 8M</span><br><span class=\"line\">read_rnd_buffer_size = 4M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># thread&amp;connection</span></span><br><span class=\"line\">thread_stack = 256K</span><br><span class=\"line\">thread_cache_size = 768</span><br><span class=\"line\">back_log = 1024</span><br><span class=\"line\">max_connections = 3000</span><br><span class=\"line\">max_connect_errors = 1000000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># temptable</span></span><br><span class=\"line\">tmp_table_size = 32M</span><br><span class=\"line\">max_heap_table_size = 32M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\">max_allowed_packet = 32M</span><br><span class=\"line\"><span class=\"comment\">#lock_wait_timeout = 3600</span></span><br><span class=\"line\"><span class=\"comment\">#interactive_timeout = 600</span></span><br><span class=\"line\"><span class=\"comment\">#wait_timeout = 600</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># query cache</span></span><br><span class=\"line\">query_cache_size = 0</span><br><span class=\"line\">query_cache_type = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置errorlog、slowlog和generallog的时区，默认UTC</span></span><br><span class=\"line\">log_timestamps = SYSTEM</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># error-log</span></span><br><span class=\"line\">log_error = /data/u02/mysqld.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># slow-log</span></span><br><span class=\"line\">slow_query_log = 1</span><br><span class=\"line\">slow_query_log_file = /data/u02/slow.log</span><br><span class=\"line\">long_query_time = 0.1</span><br><span class=\"line\">log_queries_not_using_indexes =1</span><br><span class=\"line\">log_throttle_queries_not_using_indexes = 60</span><br><span class=\"line\">min_examined_row_limit = 100</span><br><span class=\"line\">log_slow_admin_statements = 1</span><br><span class=\"line\">log_slow_slave_statements = 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># general log</span></span><br><span class=\"line\"><span class=\"comment\">#general-log = 1</span></span><br><span class=\"line\">general_log_file=/data/u02/query.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># binlog</span></span><br><span class=\"line\">binlog_format = row</span><br><span class=\"line\">binlog_checksum = 1</span><br><span class=\"line\">log-bin = /data/u02/bdm1-bin</span><br><span class=\"line\">log-bin-index = /data/u02/bdm1-bin.index</span><br><span class=\"line\">sync_binlog = 0</span><br><span class=\"line\">binlog_cache_size = 4M</span><br><span class=\"line\">max_binlog_cache_size = 2G</span><br><span class=\"line\">max_binlog_size = 512M</span><br><span class=\"line\">expire_logs_days = 15</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># GTID</span></span><br><span class=\"line\">gtid_mode = on</span><br><span class=\"line\">enforce_gtid_consistency = 1</span><br><span class=\"line\">log_slave_updates</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">master_info_repository = TABLE</span><br><span class=\"line\">relay_log_info_repository = TABLE</span><br><span class=\"line\">slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'</span><br><span class=\"line\">relay_log_recovery = 1</span><br><span class=\"line\">relay_log_purge = 1</span><br><span class=\"line\">relay-log=/data/u02/bdm1-relay-bin</span><br><span class=\"line\">relay-log-index=/data/u02/bdm1-relay-bin.index</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb-buffer&amp;cache</span></span><br><span class=\"line\">innodb_buffer_pool_size = 2G</span><br><span class=\"line\">innodb_buffer_pool_instances = 4</span><br><span class=\"line\"><span class=\"comment\">#innodb_additional_mem_pool_size = 16M</span></span><br><span class=\"line\">innodb_max_dirty_pages_pct = 50</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb log</span></span><br><span class=\"line\">innodb_data_file_path = ibdata1:1G:autoextend</span><br><span class=\"line\">innodb_log_file_size = 1G</span><br><span class=\"line\">innodb_log_files_in_group = 2</span><br><span class=\"line\">innodb_flush_log_at_trx_commit = 2</span><br><span class=\"line\">innodb_log_buffer_size = 32M</span><br><span class=\"line\"><span class=\"comment\">#innodb_max_undo_log_size = 4G</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_undo_directory = undolog</span></span><br><span class=\"line\">innodb_undo_tablespaces = 4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb-io</span></span><br><span class=\"line\">innodb_flush_method = O_DIRECT</span><br><span class=\"line\">innodb_io_capacity = 600</span><br><span class=\"line\">innodb_io_capacity_max = 2000</span><br><span class=\"line\">innodb_flush_sync = 0</span><br><span class=\"line\">innodb_flush_neighbors = 0</span><br><span class=\"line\"><span class=\"comment\">#innodb_lru_scan_depth = 4000</span></span><br><span class=\"line\">innodb_write_io_threads = 8</span><br><span class=\"line\">innodb_read_io_threads = 8</span><br><span class=\"line\">innodb_purge_threads = 4</span><br><span class=\"line\">innodb_page_cleaners = 4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transaction,lock</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_sync_spin_loops = 100</span></span><br><span class=\"line\"><span class=\"comment\">#innodb_spin_wait_delay = 30</span></span><br><span class=\"line\">innodb_lock_wait_timeout = 10</span><br><span class=\"line\">innodb_print_all_deadlocks = 1</span><br><span class=\"line\">innodb_rollback_on_timeout = 1</span><br><span class=\"line\"></span><br><span class=\"line\">innodb_open_files = 65535</span><br><span class=\"line\"></span><br><span class=\"line\">innodb_online_alter_log_max_size = 2G</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># innodb status</span></span><br><span class=\"line\">innodb_status_file = 1</span><br><span class=\"line\"><span class=\"comment\"># 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快</span></span><br><span class=\"line\">innodb_status_output = 0</span><br><span class=\"line\">innodb_status_output_locks = 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#performance_schema</span></span><br><span class=\"line\">performance_schema = 1</span><br><span class=\"line\">performance_schema_instrument = '%=on'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#innodb monitor</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_innodb\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_server\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_dml\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_ddl\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_trx\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_os\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_purge\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_log\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_lock\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_buffer\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_index\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_ibuf_system\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_buffer_page\"</span></span><br><span class=\"line\">innodb_monitor_enable=<span class=\"string\">\"module_adaptive_hash\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># MyISAM</span></span><br><span class=\"line\">key_buffer_size = 1024M</span><br><span class=\"line\">bulk_insert_buffer_size = 64M</span><br><span class=\"line\">myisam_sort_buffer_size = 128M</span><br><span class=\"line\">myisam_repair_threads = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[mysqldump]</span><br><span class=\"line\">quick</span><br><span class=\"line\">max_allowed_packet = 32M</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/26/8-mysql5-7二进制部署/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"},{"name":"mysql5.7","slug":"mysql5-7","permalink":"https://blog.k1s.club/tags/mysql5-7/"}]},{"title":"k8s部署storageclass动态创建pv(nfs&rbd)","date":"2019-09-26T06:12:49.000Z","path":"2019/09/26/7-k8s部署storageclass动态创建pv-nfs-rbd/","text":"考虑到k8s存储的问题, 本机目录挂载存在太大局限性, 多node多pod的服务存储急迫需要共享存储, 这里简单应用k8s storageclass nfs和rbd存储 第一部分 nfs这里单节点简单配置nfs(高并发可采用nfs+rsync+inotify或Sersync) 高并发参考 NFS高可用(NFS+keepalive+Sersync)inotify+rsync实时备份总结 12345678910#安装nfsyum install -y nfs-utils rpcbind# 创建目录mkdir /data/nfsecho \"/data/nfs 192.168.0.0/24(rw,sync,no_root_squash) \" &gt;&gt;/etc/exports# 启动服务systemctl start rpcbindsystemctl start nfs k8s部署storageclass环境-nfs导入外部配置12345git clone https://github.com/kubernetes-incubator/external-storage.gitcd external-storage/nfs-client/deploy#注意1 node节点需要安装nfs-utils(centos7),nfs-common(ubuntu) 修改deployment.yaml12345678910111213141516171819202122232425262728293031323334353637apiVersion: v1kind: ServiceAccountmetadata: name: nfs-client-provisioner---kind: DeploymentapiVersion: extensions/v1beta1metadata: name: nfs-client-provisionerspec: replicas: 1 strategy: type: Recreate template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: nfs.com/nfs - name: NFS_SERVER value: 192.168.0.134 - name: NFS_PATH value: /data/nfs volumes: - name: nfs-client-root nfs: server: 192.168.0.134 path: /data/nfs 修改class.yaml1234567apiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: nfsprovisioner: nfs.com/nfsparameters: archiveOnDelete: \"false\" rbac.yaml不用修改1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859rbac.yamlkind: ServiceAccountapiVersion: v1metadata: name: nfs-client-provisioner---kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: nfs-client-provisioner-runnerrules: - apiGroups: [\"\"] resources: [\"persistentvolumes\"] verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"] - apiGroups: [\"\"] resources: [\"persistentvolumeclaims\"] verbs: [\"get\", \"list\", \"watch\", \"update\"] - apiGroups: [\"storage.k8s.io\"] resources: [\"storageclasses\"] verbs: [\"get\", \"list\", \"watch\"] - apiGroups: [\"\"] resources: [\"events\"] verbs: [\"create\", \"update\", \"patch\"]---kind: ClusterRoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: run-nfs-client-provisionersubjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: defaultroleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io---kind: RoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: leader-locking-nfs-client-provisionerrules: - apiGroups: [\"\"] resources: [\"endpoints\"] verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]---kind: RoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: leader-locking-nfs-client-provisionersubjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: defaultroleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.io 部署nfs环境(创建nfs存储类)1kubectl apply -f rbac.yaml -f class.yaml -f deployment.yaml k8s中部署nginx项目采用nfs存储部署nginx-deployment-nfs.yaml(测试nfs) 这种方式会创建一个pvc 挂载到多个pod中,这种方式适合nginx-html挂载 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465---kind: PersistentVolumeClaimapiVersion: v1metadata: name: html0-deploy-nfs annotations: volume.beta.kubernetes.io/storage-class: 'nfs'spec: accessModes: - ReadWriteMany resources: requests: storage: 1Gi---apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: nginx0-deployspec: replicas: 2 template: metadata: labels: app: nginx0-deploy spec: containers: - name: nginx0-deploy image: hub.zhangzw.com/bq/nginx:1.15.12 ports: - containerPort: 80 volumeMounts: - name: html0-deploy-nfs mountPath: /usr/share/nginx/html - name: nginx-config mountPath: \"/etc/nginx/conf.d\" volumes: - name: nginx-config configMap: name: nginx-config - name: html0-deploy-nfs persistentVolumeClaim: claimName: html0-deploy-nfs---apiVersion: v1kind: ConfigMapmetadata: name: nginx-configdata: default.conf: | server &#123; listen 80; server_name localhost; root /usr/share/nginx/html/; access_log /var/log/nginx/host_access.log; error_log /var/log/nginx/host_error.log debug; location / &#123; root /usr/share/nginx/html/; index index.html index.htm index.php; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root /usr/share/nginx/html; &#125; &#125; 部署nginx-statefulset-nfs.yaml(测试nfs) 这里statefulset 方式会创建多个pvc, 每个pod的html就可以都不一样! 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758---apiVersion: apps/v1beta1kind: StatefulSetmetadata: name: nginx3spec: serviceName: \"nginx\" replicas: 2 volumeClaimTemplates: - metadata: name: html annotations: volume.beta.kubernetes.io/storage-class: \"nfs\" # 这里配置 上面创建的 storageclass 的名称 spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 2Gi template: metadata: labels: app: nginx spec: containers: - name: nginx image: hub.zhangzw.com/bq/nginx:1.15.12 volumeMounts: - mountPath: \"/usr/share/nginx/html/\" name: html - mountPath: \"/etc/nginx/conf.d\" name: nginx-config volumes: - name: nginx-config configMap: name: nginx-config---apiVersion: v1kind: ConfigMapmetadata: name: nginx-configdata: default.conf: | server &#123; listen 80; server_name localhost; root /usr/share/nginx/html/; access_log /var/log/nginx/host_access.log; error_log /var/log/nginx/host_error.log debug; location / &#123; root /usr/share/nginx/html/; index index.html index.htm index.php; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root /usr/share/nginx/html; &#125; &#125; 另外说明一下将nfs作为文件存储类似mount方式,这种方式不适用于多容器自动化部署 ,显然这种并不适合ceph rbd存储, cephfs是可以的首先需要在nfs目录创建需要挂载的目录12#例如mkdir -p /data/nfs/k8s-db-t/mysql-data-dev 在部署的yml中直接mount nfs的目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: mysql-server namespace: devopsspec: replicas: 1 template: metadata: labels: app: mysql-server spec: containers: - image: mysql:5.7.16 imagePullPolicy: Always name: mysql-server ports: - containerPort: 3306 protocol: TCP volumeMounts: - name: mysql-data mountPath: /var/lib/mysql resources: requests: cpu: 40m memory: 32Mi limits: cpu: \"300m\" memory: 256Mi env: - name: MYSQL_ROOT_PASSWORD value: \"admin\" - name: MYSQL_DATABASE value: \"gogs\" - name: MYSQL_USER value: \"gogs\" - name: MYSQL_PASSWORD value: \"gogspass\" - name: TZ value: \"Asia/Shanghai\" volumes: - name: mysql-data nfs: server: 192.168.0.134 path: /data/nfs/k8s-db-t/mysql-data-dev---apiVersion: v1kind: Servicemetadata: name: mysql-service namespace: devopsspec: clusterIP: None selector: app: mysql-server ports: - name: http port: 3306 第二部分 cephk8s部署storageclass环境-ceph如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置12git clone https://github.com/kubernetes-incubator/external-storage.gitcd external-storage/ceph/rbd/deploy 以下整合在一个文件, 两个版本,默认 和retain storageclass-cepm.com-rbd.yaml123456789101112131415161718192021222324252627282930313233343536---apiVersion: v1data: key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==kind: Secretmetadata: name: ceph-secret-admintype: kubernetes.io/rbd---apiVersion: v1data: key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==kind: Secretmetadata: name: ceph-secret-admin namespace: ns-elastictype: kubernetes.io/rbd---apiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: rbd annotations: storageclass.kubernetes.io/is-default-class: \"true\"provisioner: ceph.com/rbdparameters: monitors: 192.168.0.134:6789 adminId: admin adminSecretName: ceph-secret-admin adminSecretNamespace: default pool: storageclass-rbd userId: admin userSecretName: ceph-secret-admin fsType: ext4 imageFormat: \"2\" imageFeatures: \"layering\" storageclass-cepm.com-rbd-retain.yaml12345678910111213141516171819202122232425262728293031323334353637---apiVersion: v1data: key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==kind: Secretmetadata: name: ceph-secret-admintype: kubernetes.io/rbd---apiVersion: v1data: key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==kind: Secretmetadata: name: ceph-secret-admin namespace: ns-elastictype: kubernetes.io/rbd---apiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: rbd-retain annotations: storageclass.kubernetes.io/is-default-class: \"false\"provisioner: ceph.com/rbdreclaimPolicy: Retainparameters: monitors: 192.168.0.134:6789 adminId: admin adminSecretName: ceph-secret-admin adminSecretNamespace: default pool: storageclass-rbd-retain userId: admin userSecretName: ceph-secret-admin fsType: ext4 imageFormat: \"2\" imageFeatures: \"layering\" k8s中部署nginx项目采用 ceph.com/rbd 和nfs类似, 这里省略 以上采用的是persistentVolumeClaim 方式动态分配全部内容","raw":"---\ntitle: k8s部署storageclass动态创建pv(nfs&rbd)\ncopyright: true\ndate: 2019-09-26 14:12:49\ntags:\n  - ceph\n  - nfs\n  - k8s\n  - k8s存储\n  - storageclass\ncategories:\n  - [k8s,storageclass]\n  - [存储,nfs]\n  - [存储,ceph]\n  - [技术文档]\n---\n\n考虑到k8s存储的问题, 本机目录挂载存在太大局限性, 多node多pod的服务存储急迫需要共享存储, 这里简单应用k8s storageclass nfs和rbd存储\n<!-- more -->\n\n# 第一部分 nfs\n\n### 这里单节点简单配置nfs(高并发可采用nfs+rsync+inotify或Sersync)\n\n> 高并发参考\n\n[NFS高可用(NFS+keepalive+Sersync)](https://cloud.tencent.com/developer/article/1445884)\n[inotify+rsync实时备份总结](https://blog.51cto.com/lzhnb/2088224)\n\n\n```\n#安装nfs\nyum install -y nfs-utils rpcbind\n\n# 创建目录\nmkdir /data/nfs\necho \"/data/nfs 192.168.0.0/24(rw,sync,no_root_squash) \" >>/etc/exports\n\n# 启动服务\nsystemctl start rpcbind\nsystemctl start nfs\n```\n\n### k8s部署storageclass环境-nfs\n#### 导入外部配置\n```\ngit clone https://github.com/kubernetes-incubator/external-storage.git\ncd external-storage/nfs-client/deploy\n\n#注意\n1  node节点需要安装nfs-utils(centos7),nfs-common(ubuntu)\n```\n\n\n#### 修改deployment.yaml\n```\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: nfs-client-provisioner\n---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: nfs-client-provisioner\nspec:\n  replicas: 1\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: nfs-client-provisioner\n    spec:\n      serviceAccountName: nfs-client-provisioner\n      containers:\n        - name: nfs-client-provisioner\n          image: quay.io/external_storage/nfs-client-provisioner:latest\n          volumeMounts:\n            - name: nfs-client-root\n              mountPath: /persistentvolumes\n          env:\n            - name: PROVISIONER_NAME\n              value: nfs.com/nfs\n            - name: NFS_SERVER\n              value: 192.168.0.134\n            - name: NFS_PATH\n              value: /data/nfs\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            server: 192.168.0.134\n            path: /data/nfs\n```\n\n#### 修改class.yaml\n```\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: nfs\nprovisioner: nfs.com/nfs\nparameters:\n  archiveOnDelete: \"false\"\n```\n\n#### rbac.yaml不用修改\n```\nrbac.yaml\nkind: ServiceAccount\napiVersion: v1\nmetadata:\n  name: nfs-client-provisioner\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: nfs-client-provisioner-runner\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumes\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"]\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumeclaims\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\"]\n  - apiGroups: [\"storage.k8s.io\"]\n    resources: [\"storageclasses\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"events\"]\n    verbs: [\"create\", \"update\", \"patch\"]\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: run-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner\n    namespace: default\nroleRef:\n  kind: ClusterRole\n  name: nfs-client-provisioner-runner\n  apiGroup: rbac.authorization.k8s.io\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-nfs-client-provisioner\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner\n    # replace with namespace where provisioner is deployed\n    namespace: default\nroleRef:\n  kind: Role\n  name: leader-locking-nfs-client-provisioner\n  apiGroup: rbac.authorization.k8s.io\n```\n\n#### 部署nfs环境(创建nfs存储类)\n```\nkubectl apply -f rbac.yaml -f class.yaml -f deployment.yaml\n```\n\n\n---\n\n### k8s中部署nginx项目采用nfs存储\n#### 部署nginx-deployment-nfs.yaml(测试nfs)\n> 这种方式会创建一个pvc 挂载到多个pod中,这种方式适合nginx-html挂载\n\n```\n---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: html0-deploy-nfs\n  annotations:\n    volume.beta.kubernetes.io/storage-class: 'nfs'\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: nginx0-deploy\nspec:\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: nginx0-deploy\n    spec:\n      containers:\n      - name: nginx0-deploy\n        image: hub.zhangzw.com/bq/nginx:1.15.12\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: html0-deploy-nfs\n          mountPath: /usr/share/nginx/html\n        - name: nginx-config\n          mountPath: \"/etc/nginx/conf.d\"\n      volumes:\n      - name: nginx-config\n        configMap:\n            name: nginx-config\n      - name: html0-deploy-nfs\n        persistentVolumeClaim:\n          claimName: html0-deploy-nfs\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: nginx-config\ndata:\n  default.conf: |\n            server {\n              listen       80;\n              server_name  localhost;\n              root   /usr/share/nginx/html/;\n              access_log  /var/log/nginx/host_access.log;\n              error_log  /var/log/nginx/host_error.log debug;\n              location / {\n                  root   /usr/share/nginx/html/;\n                  index  index.html index.htm index.php;\n              }\n              error_page   500 502 503 504  /50x.html;\n\n              location = /50x.html {\n                  root   /usr/share/nginx/html;\n              }\n              }\n```\n\n\n#### 部署nginx-statefulset-nfs.yaml(测试nfs)\n> 这里statefulset 方式会创建多个pvc, 每个pod的html就可以都不一样!\n\n```\n---\napiVersion: apps/v1beta1\nkind: StatefulSet\nmetadata:\n  name: nginx3\nspec:\n  serviceName: \"nginx\"\n  replicas: 2\n  volumeClaimTemplates:\n  - metadata:\n      name: html\n      annotations:\n        volume.beta.kubernetes.io/storage-class: \"nfs\" # 这里配置 上面创建的 storageclass 的名称\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 2Gi\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: hub.zhangzw.com/bq/nginx:1.15.12\n        volumeMounts:\n        - mountPath: \"/usr/share/nginx/html/\"\n          name: html\n        - mountPath: \"/etc/nginx/conf.d\"\n          name: nginx-config\n      volumes:\n      - name: nginx-config\n        configMap:\n            name: nginx-config\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: nginx-config\ndata:\n  default.conf: |\n            server {\n              listen       80;\n              server_name  localhost;\n              root   /usr/share/nginx/html/;\n              access_log  /var/log/nginx/host_access.log;\n              error_log  /var/log/nginx/host_error.log debug;\n              location / {\n                  root   /usr/share/nginx/html/;\n                  index  index.html index.htm index.php;\n              }\n              error_page   500 502 503 504  /50x.html;\n\n              location = /50x.html {\n                  root   /usr/share/nginx/html;\n              }\n              }\n```\n\n---\n### 另外说明一下将nfs作为文件存储类似mount方式,这种方式不适用于多容器自动化部署 ,显然这种并不适合ceph rbd存储, cephfs是可以的\n\n#### 首先需要在nfs目录创建需要挂载的目录\n```\n#例如\nmkdir -p /data/nfs/k8s-db-t/mysql-data-dev\n```\n\n#### 在部署的yml中直接mount nfs的目录\n```\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: mysql-server\n  namespace: devops\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: mysql-server\n    spec:\n      containers:\n      - image: mysql:5.7.16\n        imagePullPolicy: Always\n        name: mysql-server\n        ports:\n        - containerPort: 3306\n          protocol: TCP\n        volumeMounts:\n          - name: mysql-data\n            mountPath: /var/lib/mysql\n        resources:\n          requests:\n            cpu: 40m\n            memory: 32Mi\n          limits:\n            cpu: \"300m\"\n            memory: 256Mi\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          value: \"admin\"\n        - name: MYSQL_DATABASE\n          value: \"gogs\"\n        - name: MYSQL_USER\n          value: \"gogs\"\n        - name: MYSQL_PASSWORD\n          value: \"gogspass\"\n        - name: TZ\n          value: \"Asia/Shanghai\"\n      volumes:\n        - name: mysql-data\n          nfs:\n            server: 192.168.0.134\n            path: /data/nfs/k8s-db-t/mysql-data-dev\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-service\n  namespace: devops\nspec:\n  clusterIP: None\n  selector:\n    app: mysql-server\n  ports:\n  - name: http\n    port: 3306\n```\n\n---\n# 第二部分 ceph\n### k8s部署storageclass环境-ceph\n\n#### 如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置\n```\ngit clone https://github.com/kubernetes-incubator/external-storage.git\ncd external-storage/ceph/rbd/deploy\n```\n\n> 以下整合在一个文件, 两个版本,默认 和retain\n \n#### storageclass-cepm.com-rbd.yaml\n```\n---\napiVersion: v1\ndata:\n  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==\nkind: Secret\nmetadata:\n  name: ceph-secret-admin\ntype: kubernetes.io/rbd\n---\napiVersion: v1\ndata:\n  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==\nkind: Secret\nmetadata:\n  name: ceph-secret-admin\n  namespace: ns-elastic\ntype: kubernetes.io/rbd\n---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: rbd\n  annotations:\n    storageclass.kubernetes.io/is-default-class: \"true\"\nprovisioner: ceph.com/rbd\nparameters:\n  monitors: 192.168.0.134:6789\n  adminId: admin\n  adminSecretName: ceph-secret-admin\n  adminSecretNamespace: default\n  pool: storageclass-rbd\n  userId: admin\n  userSecretName: ceph-secret-admin\n  fsType: ext4\n  imageFormat: \"2\"\n  imageFeatures: \"layering\"\n```\n\n#### storageclass-cepm.com-rbd-retain.yaml\n```\n---\napiVersion: v1\ndata:\n  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==\nkind: Secret\nmetadata:\n  name: ceph-secret-admin\ntype: kubernetes.io/rbd\n---\napiVersion: v1\ndata:\n  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==\nkind: Secret\nmetadata:\n  name: ceph-secret-admin\n  namespace: ns-elastic\ntype: kubernetes.io/rbd\n---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: rbd-retain\n  annotations:\n    storageclass.kubernetes.io/is-default-class: \"false\"\nprovisioner: ceph.com/rbd\nreclaimPolicy: Retain\nparameters:\n  monitors: 192.168.0.134:6789\n  adminId: admin\n  adminSecretName: ceph-secret-admin\n  adminSecretNamespace: default\n  pool: storageclass-rbd-retain\n  userId: admin\n  userSecretName: ceph-secret-admin\n  fsType: ext4\n  imageFormat: \"2\"\n  imageFeatures: \"layering\"\n```\n\n#### k8s中部署nginx项目采用 ceph.com/rbd 和nfs类似, 这里省略 \n\n> 以上采用的是persistentVolumeClaim 方式动态分配全部内容\n","content":"<p>考虑到k8s存储的问题, 本机目录挂载存在太大局限性, 多node多pod的服务存储急迫需要共享存储, 这里简单应用k8s storageclass nfs和rbd存储</p>\n<a id=\"more\"></a>\n\n<h1 id=\"第一部分-nfs\"><a href=\"#第一部分-nfs\" class=\"headerlink\" title=\"第一部分 nfs\"></a>第一部分 nfs</h1><h3 id=\"这里单节点简单配置nfs-高并发可采用nfs-rsync-inotify或Sersync\"><a href=\"#这里单节点简单配置nfs-高并发可采用nfs-rsync-inotify或Sersync\" class=\"headerlink\" title=\"这里单节点简单配置nfs(高并发可采用nfs+rsync+inotify或Sersync)\"></a>这里单节点简单配置nfs(高并发可采用nfs+rsync+inotify或Sersync)</h3><blockquote>\n<p>高并发参考</p>\n</blockquote>\n<p><a href=\"https://cloud.tencent.com/developer/article/1445884\" target=\"_blank\" rel=\"noopener\">NFS高可用(NFS+keepalive+Sersync)</a><br><a href=\"https://blog.51cto.com/lzhnb/2088224\" target=\"_blank\" rel=\"noopener\">inotify+rsync实时备份总结</a></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装nfs</span></span><br><span class=\"line\">yum <span class=\"keyword\">install</span> -y nfs-utils rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">mkdir /<span class=\"keyword\">data</span>/nfs</span><br><span class=\"line\">echo <span class=\"string\">\"/data/nfs 192.168.0.0/24(rw,sync,no_root_squash) \"</span> &gt;&gt;/etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">start</span> rpcbind</span><br><span class=\"line\">systemctl <span class=\"keyword\">start</span> nfs</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"k8s部署storageclass环境-nfs\"><a href=\"#k8s部署storageclass环境-nfs\" class=\"headerlink\" title=\"k8s部署storageclass环境-nfs\"></a>k8s部署storageclass环境-nfs</h3><h4 id=\"导入外部配置\"><a href=\"#导入外部配置\" class=\"headerlink\" title=\"导入外部配置\"></a>导入外部配置</h4><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"keyword\">clone</span> <span class=\"title\">https</span>://github.com/kubernetes-incubator/external-storage.git</span><br><span class=\"line\">cd external-storage/nfs-client/deploy</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注意</span></span><br><span class=\"line\"><span class=\"number\">1</span>  <span class=\"keyword\">node</span><span class=\"title\">节点需要安装nfs-utils</span>(centos7),nfs-common(ubuntu)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改deployment-yaml\"><a href=\"#修改deployment-yaml\" class=\"headerlink\" title=\"修改deployment.yaml\"></a>修改deployment.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  strategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccountName:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">nfs.com/nfs</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.134</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">NFS_PATH</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">/data/nfs</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.134</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/nfs</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改class-yaml\"><a href=\"#修改class-yaml\" class=\"headerlink\" title=\"修改class.yaml\"></a>修改class.yaml</h4><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> storage.k8s.io/v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> StorageClass</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> nfs</span><br><span class=\"line\"><span class=\"symbol\">provisioner:</span> nfs.com/nfs</span><br><span class=\"line\"><span class=\"symbol\">parameters:</span></span><br><span class=\"line\"><span class=\"symbol\">  archiveOnDelete:</span> <span class=\"string\">\"false\"</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"rbac-yaml不用修改\"><a href=\"#rbac-yaml不用修改\" class=\"headerlink\" title=\"rbac.yaml不用修改\"></a>rbac.yaml不用修改</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">rbac.yaml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"persistentvolumes\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"get\",</span> <span class=\"string\">\"list\"</span><span class=\"string\">,</span> <span class=\"string\">\"watch\"</span><span class=\"string\">,</span> <span class=\"string\">\"create\"</span><span class=\"string\">,</span> <span class=\"string\">\"delete\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"persistentvolumeclaims\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"get\",</span> <span class=\"string\">\"list\"</span><span class=\"string\">,</span> <span class=\"string\">\"watch\"</span><span class=\"string\">,</span> <span class=\"string\">\"update\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"storage.k8s.io\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"storageclasses\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"get\",</span> <span class=\"string\">\"list\"</span><span class=\"string\">,</span> <span class=\"string\">\"watch\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"events\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"create\",</span> <span class=\"string\">\"update\"</span><span class=\"string\">,</span> <span class=\"string\">\"patch\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">run-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - apiGroups:</span> <span class=\"string\">[\"\"]</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">[\"endpoints\"]</span></span><br><span class=\"line\"><span class=\"attr\">    verbs:</span> <span class=\"string\">[\"get\",</span> <span class=\"string\">\"list\"</span><span class=\"string\">,</span> <span class=\"string\">\"watch\"</span><span class=\"string\">,</span> <span class=\"string\">\"create\"</span><span class=\"string\">,</span> <span class=\"string\">\"update\"</span><span class=\"string\">,</span> <span class=\"string\">\"patch\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">  - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\"><span class=\"attr\">    namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"部署nfs环境-创建nfs存储类\"><a href=\"#部署nfs环境-创建nfs存储类\" class=\"headerlink\" title=\"部署nfs环境(创建nfs存储类)\"></a>部署nfs环境(创建nfs存储类)</h4><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f rbac<span class=\"selector-class\">.yaml</span> -f class<span class=\"selector-class\">.yaml</span> -f deployment.yaml</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"k8s中部署nginx项目采用nfs存储\"><a href=\"#k8s中部署nginx项目采用nfs存储\" class=\"headerlink\" title=\"k8s中部署nginx项目采用nfs存储\"></a>k8s中部署nginx项目采用nfs存储</h3><h4 id=\"部署nginx-deployment-nfs-yaml-测试nfs\"><a href=\"#部署nginx-deployment-nfs-yaml-测试nfs\" class=\"headerlink\" title=\"部署nginx-deployment-nfs.yaml(测试nfs)\"></a>部署nginx-deployment-nfs.yaml(测试nfs)</h4><blockquote>\n<p>这种方式会创建一个pvc 挂载到多个pod中,这种方式适合nginx-html挂载</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">html0-deploy-nfs</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">'nfs'</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  accessModes:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\"><span class=\"attr\">  resources:</span></span><br><span class=\"line\"><span class=\"attr\">    requests:</span></span><br><span class=\"line\"><span class=\"attr\">      storage:</span> <span class=\"number\">1</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx0-deploy</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx0-deploy</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx0-deploy</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.zhangzw.com/bq/nginx:1.15.12</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">html0-deploy-nfs</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/etc/nginx/conf.d\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">html0-deploy-nfs</span></span><br><span class=\"line\"><span class=\"attr\">        persistentVolumeClaim:</span></span><br><span class=\"line\"><span class=\"attr\">          claimName:</span> <span class=\"string\">html0-deploy-nfs</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">default.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">            server &#123;</span></span><br><span class=\"line\"><span class=\"string\">              listen       80;</span></span><br><span class=\"line\"><span class=\"string\">              server_name  localhost;</span></span><br><span class=\"line\"><span class=\"string\">              root   /usr/share/nginx/html/;</span></span><br><span class=\"line\"><span class=\"string\">              access_log  /var/log/nginx/host_access.log;</span></span><br><span class=\"line\"><span class=\"string\">              error_log  /var/log/nginx/host_error.log debug;</span></span><br><span class=\"line\"><span class=\"string\">              location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  root   /usr/share/nginx/html/;</span></span><br><span class=\"line\"><span class=\"string\">                  index  index.html index.htm index.php;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">              error_page   500 502 503 504  /50x.html;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">              location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  root   /usr/share/nginx/html;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"部署nginx-statefulset-nfs-yaml-测试nfs\"><a href=\"#部署nginx-statefulset-nfs-yaml-测试nfs\" class=\"headerlink\" title=\"部署nginx-statefulset-nfs.yaml(测试nfs)\"></a>部署nginx-statefulset-nfs.yaml(测试nfs)</h4><blockquote>\n<p>这里statefulset 方式会创建多个pvc, 每个pod的html就可以都不一样!</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx3</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"nginx\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">html</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span></span><br><span class=\"line\">        <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs\"</span> <span class=\"comment\"># 这里配置 上面创建的 storageclass 的名称</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">2</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">hub.zhangzw.com/bq/nginx:1.15.12</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - mountPath:</span> <span class=\"string\">\"/usr/share/nginx/html/\"</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">html</span></span><br><span class=\"line\"><span class=\"attr\">        - mountPath:</span> <span class=\"string\">\"/etc/nginx/conf.d\"</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">default.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">            server &#123;</span></span><br><span class=\"line\"><span class=\"string\">              listen       80;</span></span><br><span class=\"line\"><span class=\"string\">              server_name  localhost;</span></span><br><span class=\"line\"><span class=\"string\">              root   /usr/share/nginx/html/;</span></span><br><span class=\"line\"><span class=\"string\">              access_log  /var/log/nginx/host_access.log;</span></span><br><span class=\"line\"><span class=\"string\">              error_log  /var/log/nginx/host_error.log debug;</span></span><br><span class=\"line\"><span class=\"string\">              location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  root   /usr/share/nginx/html/;</span></span><br><span class=\"line\"><span class=\"string\">                  index  index.html index.htm index.php;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">              error_page   500 502 503 504  /50x.html;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">              location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  root   /usr/share/nginx/html;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"另外说明一下将nfs作为文件存储类似mount方式-这种方式不适用于多容器自动化部署-显然这种并不适合ceph-rbd存储-cephfs是可以的\"><a href=\"#另外说明一下将nfs作为文件存储类似mount方式-这种方式不适用于多容器自动化部署-显然这种并不适合ceph-rbd存储-cephfs是可以的\" class=\"headerlink\" title=\"另外说明一下将nfs作为文件存储类似mount方式,这种方式不适用于多容器自动化部署 ,显然这种并不适合ceph rbd存储, cephfs是可以的\"></a>另外说明一下将nfs作为文件存储类似mount方式,这种方式不适用于多容器自动化部署 ,显然这种并不适合ceph rbd存储, cephfs是可以的</h3><h4 id=\"首先需要在nfs目录创建需要挂载的目录\"><a href=\"#首先需要在nfs目录创建需要挂载的目录\" class=\"headerlink\" title=\"首先需要在nfs目录创建需要挂载的目录\"></a>首先需要在nfs目录创建需要挂载的目录</h4><figure class=\"highlight haskell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#例如</span></span><br><span class=\"line\"><span class=\"title\">mkdir</span> -p /<span class=\"class\"><span class=\"keyword\">data</span>/nfs/k8s-db-t/mysql-<span class=\"keyword\">data</span>-dev</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"在部署的yml中直接mount-nfs的目录\"><a href=\"#在部署的yml中直接mount-nfs的目录\" class=\"headerlink\" title=\"在部署的yml中直接mount nfs的目录\"></a>在部署的yml中直接mount nfs的目录</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">mysql-server</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devops</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">mysql-server</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - image:</span> <span class=\"attr\">mysql:5.7.16</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">mysql-server</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">mysql-data</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"number\">40</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">32</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"300m\"</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">256</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"admin\"</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MYSQL_DATABASE</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"gogs\"</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MYSQL_USER</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"gogs\"</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MYSQL_PASSWORD</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"gogspass\"</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"Asia/Shanghai\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">mysql-data</span></span><br><span class=\"line\"><span class=\"attr\">          nfs:</span></span><br><span class=\"line\"><span class=\"attr\">            server:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.134</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/nfs/k8s-db-t/mysql-data-dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">mysql-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devops</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">mysql-server</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">3306</span></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"第二部分-ceph\"><a href=\"#第二部分-ceph\" class=\"headerlink\" title=\"第二部分 ceph\"></a>第二部分 ceph</h1><h3 id=\"k8s部署storageclass环境-ceph\"><a href=\"#k8s部署storageclass环境-ceph\" class=\"headerlink\" title=\"k8s部署storageclass环境-ceph\"></a>k8s部署storageclass环境-ceph</h3><h4 id=\"如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置\"><a href=\"#如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置\" class=\"headerlink\" title=\"如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置\"></a>如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/kubernetes-incubator/</span>external-storage.git</span><br><span class=\"line\">cd external-storage<span class=\"regexp\">/ceph/</span>rbd<span class=\"regexp\">/deploy</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以下整合在一个文件, 两个版本,默认 和retain</p>\n</blockquote>\n<h4 id=\"storageclass-cepm-com-rbd-yaml\"><a href=\"#storageclass-cepm-com-rbd-yaml\" class=\"headerlink\" title=\"storageclass-cepm.com-rbd.yaml\"></a>storageclass-cepm.com-rbd.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  key:</span> <span class=\"string\">QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">kubernetes.io/rbd</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  key:</span> <span class=\"string\">QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">kubernetes.io/rbd</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">rbd</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">storageclass.kubernetes.io/is-default-class:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">ceph.com/rbd</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\"><span class=\"attr\">  monitors:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.134</span><span class=\"string\">:6789</span></span><br><span class=\"line\"><span class=\"attr\">  adminId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">  adminSecretName:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  adminSecretNamespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">  pool:</span> <span class=\"string\">storageclass-rbd</span></span><br><span class=\"line\"><span class=\"attr\">  userId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">  userSecretName:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  fsType:</span> <span class=\"string\">ext4</span></span><br><span class=\"line\"><span class=\"attr\">  imageFormat:</span> <span class=\"string\">\"2\"</span></span><br><span class=\"line\"><span class=\"attr\">  imageFeatures:</span> <span class=\"string\">\"layering\"</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"storageclass-cepm-com-rbd-retain-yaml\"><a href=\"#storageclass-cepm-com-rbd-retain-yaml\" class=\"headerlink\" title=\"storageclass-cepm.com-rbd-retain.yaml\"></a>storageclass-cepm.com-rbd-retain.yaml</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  key:</span> <span class=\"string\">QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">kubernetes.io/rbd</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  key:</span> <span class=\"string\">QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">kubernetes.io/rbd</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">rbd-retain</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">storageclass.kubernetes.io/is-default-class:</span> <span class=\"string\">\"false\"</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">ceph.com/rbd</span></span><br><span class=\"line\"><span class=\"attr\">reclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\"><span class=\"attr\">  monitors:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.134</span><span class=\"string\">:6789</span></span><br><span class=\"line\"><span class=\"attr\">  adminId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">  adminSecretName:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  adminSecretNamespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">  pool:</span> <span class=\"string\">storageclass-rbd-retain</span></span><br><span class=\"line\"><span class=\"attr\">  userId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">  userSecretName:</span> <span class=\"string\">ceph-secret-admin</span></span><br><span class=\"line\"><span class=\"attr\">  fsType:</span> <span class=\"string\">ext4</span></span><br><span class=\"line\"><span class=\"attr\">  imageFormat:</span> <span class=\"string\">\"2\"</span></span><br><span class=\"line\"><span class=\"attr\">  imageFeatures:</span> <span class=\"string\">\"layering\"</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"k8s中部署nginx项目采用-ceph-com-rbd-和nfs类似-这里省略\"><a href=\"#k8s中部署nginx项目采用-ceph-com-rbd-和nfs类似-这里省略\" class=\"headerlink\" title=\"k8s中部署nginx项目采用 ceph.com/rbd 和nfs类似, 这里省略\"></a>k8s中部署nginx项目采用 ceph.com/rbd 和nfs类似, 这里省略</h4><blockquote>\n<p>以上采用的是persistentVolumeClaim 方式动态分配全部内容</p>\n</blockquote>\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/26/7-k8s部署storageclass动态创建pv-nfs-rbd/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"存储","slug":"存储","permalink":"https://blog.k1s.club/categories/存储/"},{"name":"ceph","slug":"存储/ceph","permalink":"https://blog.k1s.club/categories/存储/ceph/"},{"name":"storageclass","slug":"k8s/storageclass","permalink":"https://blog.k1s.club/categories/k8s/storageclass/"},{"name":"nfs","slug":"存储/nfs","permalink":"https://blog.k1s.club/categories/存储/nfs/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"ceph","slug":"ceph","permalink":"https://blog.k1s.club/tags/ceph/"},{"name":"k8s存储","slug":"k8s存储","permalink":"https://blog.k1s.club/tags/k8s存储/"},{"name":"nfs","slug":"nfs","permalink":"https://blog.k1s.club/tags/nfs/"},{"name":"storageclass","slug":"storageclass","permalink":"https://blog.k1s.club/tags/storageclass/"}]},{"title":"ceph安装部署","date":"2019-09-26T03:13:40.000Z","path":"2019/09/26/6-ceph安装部署/","text":"Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。 简单了解什么是块存储/对象存储/文件系统存储？ceph 目前提供对象存储（RADOSGW）、块存储RDB以及 CephFS 文件系统这 3 种功能。对于这3种功能介绍，分别如下： 对象存储，也就是通常意义的键值存储，其接口就是简单的GET、PUT、DEL 和其他扩展，代表主要有 Swift 、S3 以及 Gluster 等； 块存储，这种接口通常以 QEMU Driver 或者 Kernel Module 的方式存在，这种接口需要实现 Linux 的 Block Device 的接口或者 QEMU 提供的 Block Driver 接口，如 Sheepdog，AWS 的 EBS，青云的云硬盘和阿里云的盘古系统，还有 Ceph 的 RBD（RBD是Ceph面向块存储的接口）。在常见的存储中 DAS、SAN 提供的也是块存储； 文件存储，通常意义是支持 POSIX 接口，它跟传统的文件系统如 Ext4 是一个类型的，但区别在于分布式存储提供了并行化的能力，如 Ceph 的 CephFS (CephFS是Ceph面向文件存储的接口)，但是有时候又会把 GlusterFS ，HDFS 这种非POSIX接口的类文件存储接口归入此类。当然 NFS、NAS也是属于文件系统存储； 参考教程Kubernetes 集成 Ceph 后端存储教程centos7安装ceph集群 准备配置源12345678910111213141516171819202122cat &gt;/etc/yum.repos.d/ceph.repo&lt;&lt;EOF[ceph]name=cephbaseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/gpgcheck=0priority=1[ceph-noarch]name=cephnoarchbaseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/gpgcheck=0priority=1[ceph-source]name=Ceph source packagesbaseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/SRPMSenabled=0gpgcheck=1type=rpm-mdgpgkey=http://mirrors.163.com/ceph/keys/release.ascpriority=1EOF 安装过卸载123ceph-deploy purge dk1-t dk2-tceph-deploy purgedata dk1-t dk2-tceph-deploy forgetkeys 在dk2-t节点创建集群 mon模块1234567891011121314151617181920212223242526272829303132333435363738394041424344454647yum install ceph-deploy -yceph-deploy --versionmkdir /data/cephcd /data/cephceph-deploy new dk2-t# 查看配置文件ls -l# 配置ceph.conf[global]...# 如果有多个网卡，应该配置如下选项，# public network是公共网络，负责集群对外提供服务的流量# cluster network是集群网络，负载集群中数据复制传输通信等# 本次实验使用同一块网卡，生境环境建议分别使用一块网卡public network = 192.168.0.0/22cluster network = 192.168.0.0/22osd pool default size = 2# 安装 ceph 包# 如果按照官方文档安装方法 会重新配置安装官方ceph源# 由于网络问题，安装可能会出错，需要多次执行# ceph-deploy install 其实只是会安装 ceph ceph-radosgw 两个包# ceph-deploy install lab1 lab2 lab3# 推荐使用阿里源安装，因为使用ceph-deploy安装会很慢# 使用如下命令手动安装包，替代官方的 ceph-deploy install 命令# 如下操作在所有node节点上执行export CEPH_DEPLOY_REPO_URL=http://mirrors.163.com/ceph/rpm-luminous/el7export CEPH_DEPLOY_GPG_URL=http://mirrors.163.com/ceph/keys/release.asc# 先执行是因为 ceph-deploy install太慢yum install -y ceph ceph-radosgwceph-deploy install dk2-t# 部署monitor和生成keysceph-deploy mon create-initialls -l *.keyring# 复制文件到node节点ceph-deploy dk1-t dk2-t# 额外mon节点，mon节点也需要高可用ceph-deploy mon add dk1-t 在dk2-t节点创建集群 mgr模块123# 部署manager （luminous+）12及以后的版本需要部署# 本次部署 jewel 版本 ，不需要执行如下命令 ceph-deploy mgr create dk2-t 在dk2-t节点创建集群 osd模块1234# 12的版本(这里挂载一个 10G的磁盘 /dev/sdb)# create 命令一次完成准备 OSD 、部署到 OSD 节点、并激活它。 create 命令是依次执行 prepare 和 activate 命令的捷径。ceph-deploy osd create --data /dev/sdb dk2-tceph-deploy osd create --data /dev/sdc dk1-t 如何卸载osd1234567891011121314# 查看ceph osd tree# 节点状态标记为outceph osd out osd.0# 从crush中移除节点ceph osd crush remove osd.0# 删除节点ceph osd rm osd.0# 删除节点认证（不删除编号会占住）ceph auth del osd.0 查看 mon 信息12345678ceph mon dumpdumped monmap epoch 1epoch 1fsid 4620d0c7-4458-4ff9-9296-d1318058bafclast_changed 2019-06-19 14:44:41.361005created 2019-06-19 14:44:41.3610050: 192.168.0.134:6789/0 mon.dk2-t 配置文件内容 /etc/ceph/ceph.conf1234567891011[global]public network = 192.168.0.0/22cluster network = 192.168.0.0/22osd pool default size = 2fsid = 4620d0c7-4458-4ff9-9296-d1318058bafcmon_initial_members = dk2-tmon_host = 192.168.0.134auth_cluster_required = cephxauth_service_required = cephxauth_client_required = cephxmon_max_pg_per_osd = 1000 ceph 一些测试命令创建 rbd pool，名字叫做 kube1ceph osd pool create kube 256 256 如何取得admin的密钥12ceph auth get client.admin 2&gt;&amp;1 |grep \"key = \" |awk '&#123;print $3&#125;'AQAn/19bbb21GBAA1kc0HRWoGjeoPTRQziA03A== 测试ceph是否正常12345678910111213rbd create kube/test --size 1024 --image-format 2rbd ls kuberbd map kube/test # 如果报错, 警用 rbd info kube/test rbd feature disable kube/test exclusive-lock object-map fast-diff deep-flattenrbd map kube/testrbd showmappedmkfs.ext4 /dev/rbd0mkdir /data/rbd0mount /dev/rbd0 /data/rbd0cd /data/rbd0 &amp;&amp; echo test &gt; test.txt 在k8s 手动创建存储类创建ceph pg123456789101112131415161718192021# Total PGs = (Total_number_of_OSD * 100) / max_replication_count# pg = 1 * 100 /2 ~ 64(取2的次方数)# 这里准备创建2个pool, 每个poolceph osd pool create rbd-k8s 16# 查看ceph osd lspools# 创建imagerbd create rbd-k8s/cephimageredis --size 500M# 查看listrbd list rbd-k8s# 处理新特性# 查看inforbd info rbd-k8s/cephimageredis# 关闭exclusive-lock object-map fast-diff deep-flatten 这些特性rbd feature disable rbd-k8s/cephimageredis exclusive-lock object-map fast-diff deep-flatten 首先创建secret12#获取keygrep key /etc/ceph/ceph.client.admin.keyring |awk '&#123;printf \"%s\", $NF&#125;'|base64 ceph-secret.yaml1234567apiVersion: v1kind: Secretmetadata: name: ceph-secrettype: \"kubernetes.io/rbd\"data: key: QVFCTFo2dGNGNXFLRnhBQXBGTXJEdm5CY2k2UGtwZmZrN0JSVEE9PQ== 其次创建pv, pv是没有namespace概念的 persistentVolumeReclaimPolicy是清理规则 (retain: 不清理, Recycle: 回收) redis-ceph-pv.yml 1234567891011121314151617181920apiVersion: v1kind: PersistentVolumemetadata: name: redis2-ceph-rbd-pvspec: capacity: storage: 100Mi accessModes: - ReadWriteOnce rbd: monitors: - '192.168.0.134:6789' pool: rbd-k8s image: cephimageredis user: admin secretRef: name: ceph-secret fsType: ext4 readOnly: false persistentVolumeReclaimPolicy: Recycle 执行部署pv1kubectl create -f redis-ceph-pv.yml 然后创建pvc redis-ceph-pvc.yml 12345678910apiVersion: v1kind: PersistentVolumeClaimmetadata: name: redis2-ceph-rbd-pvcspec: accessModes: - ReadWriteOnce resources: requests: storage: 100Mi 执行部署pvc1kubectl create -f redis-ceph-pvc.yml 最后在rancher上选择挂载rbd","raw":"---\ntitle: ceph安装部署\ncopyright: true\ndate: 2019-09-26 11:13:40\ntags:\n  - ceph\n  - cephfs\n  - k8s\n  - k8s存储\ncategories:\n  - [技术文档]\n  - [存储,ceph]\n---\n\nCeph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。\n\n<!-- more-->\n\n### 简单了解什么是块存储/对象存储/文件系统存储？\n\nceph 目前提供对象存储（RADOSGW）、块存储RDB以及 CephFS 文件系统这 3 种功能。对于这3种功能介绍，分别如下：\n\n1. 对象存储，也就是通常意义的键值存储，其接口就是简单的GET、PUT、DEL 和其他扩展，代表主要有 Swift 、S3 以及 Gluster 等；\n\n2. 块存储，这种接口通常以 QEMU Driver 或者 Kernel Module 的方式存在，这种接口需要实现 Linux 的 Block Device 的接口或者 QEMU 提供的 Block Driver 接口，如 Sheepdog，AWS 的 EBS，青云的云硬盘和阿里云的盘古系统，还有 Ceph 的 RBD（RBD是Ceph面向块存储的接口）。在常见的存储中 DAS、SAN 提供的也是块存储；\n\n3. 文件存储，通常意义是支持 POSIX 接口，它跟传统的文件系统如 Ext4 是一个类型的，但区别在于分布式存储提供了并行化的能力，如 Ceph 的 CephFS (CephFS是Ceph面向文件存储的接口)，但是有时候又会把 GlusterFS ，HDFS 这种非POSIX接口的类文件存储接口归入此类。当然 NFS、NAS也是属于文件系统存储；\n\n\n### 参考教程\n[Kubernetes 集成 Ceph 后端存储教程](https://blog.csdn.net/shida_csdn/article/details/78579043)\n[centos7安装ceph集群](https://blog.csdn.net/zcc_heu/article/details/79017624)\n\n###  准备\n#### 配置源\n```\ncat >/etc/yum.repos.d/ceph.repo<<EOF\n[ceph]\nname=ceph\nbaseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/\ngpgcheck=0\npriority=1\n\n[ceph-noarch]\nname=cephnoarch\nbaseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/\ngpgcheck=0\npriority=1\n\n[ceph-source]\nname=Ceph source packages\nbaseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/SRPMS\nenabled=0\ngpgcheck=1\ntype=rpm-md\ngpgkey=http://mirrors.163.com/ceph/keys/release.asc\npriority=1\nEOF\n\n```\n\n\n#### 安装过卸载\n```\nceph-deploy purge dk1-t dk2-t\nceph-deploy purgedata dk1-t dk2-t\nceph-deploy forgetkeys\n\n```\n\n\n### 在dk2-t节点创建集群 mon模块\n```\nyum install ceph-deploy -y\nceph-deploy --version\n\nmkdir /data/ceph\ncd /data/ceph\nceph-deploy new dk2-t\n\n# 查看配置文件\nls -l\n\n# 配置ceph.conf\n[global]\n...\n# 如果有多个网卡，应该配置如下选项，\n# public network是公共网络，负责集群对外提供服务的流量\n# cluster network是集群网络，负载集群中数据复制传输通信等\n# 本次实验使用同一块网卡，生境环境建议分别使用一块网卡\npublic network = 192.168.0.0/22\ncluster network = 192.168.0.0/22\nosd pool default size = 2\n\n\n# 安装 ceph 包\n# 如果按照官方文档安装方法 会重新配置安装官方ceph源\n# 由于网络问题，安装可能会出错，需要多次执行\n# ceph-deploy install 其实只是会安装 ceph ceph-radosgw 两个包\n# ceph-deploy install lab1 lab2 lab3\n# 推荐使用阿里源安装，因为使用ceph-deploy安装会很慢\n# 使用如下命令手动安装包，替代官方的 ceph-deploy install 命令\n# 如下操作在所有node节点上执行\nexport CEPH_DEPLOY_REPO_URL=http://mirrors.163.com/ceph/rpm-luminous/el7\nexport CEPH_DEPLOY_GPG_URL=http://mirrors.163.com/ceph/keys/release.asc\n\n# 先执行是因为 ceph-deploy install太慢\nyum install -y ceph ceph-radosgw\nceph-deploy install dk2-t\n\n\n# 部署monitor和生成keys\nceph-deploy mon create-initial\nls -l *.keyring\n\n# 复制文件到node节点\nceph-deploy dk1-t dk2-t\n\n# 额外mon节点，mon节点也需要高可用\nceph-deploy mon add dk1-t\n```\n\n\n### 在dk2-t节点创建集群 mgr模块\n```\n# 部署manager （luminous+）12及以后的版本需要部署\n# 本次部署 jewel 版本 ，不需要执行如下命令\n ceph-deploy mgr create dk2-t\n```\n\n### 在dk2-t节点创建集群 osd模块\n```\n# 12的版本(这里挂载一个 10G的磁盘 /dev/sdb)\n# create 命令一次完成准备 OSD 、部署到 OSD 节点、并激活它。 create 命令是依次执行 prepare 和 activate 命令的捷径。\nceph-deploy osd create --data /dev/sdb dk2-t\nceph-deploy osd create --data /dev/sdc dk1-t\n```\n\n\n### 如何卸载osd\n```\n# 查看\nceph osd tree\n\n# 节点状态标记为out\nceph osd out osd.0\n\n# 从crush中移除节点\nceph osd crush remove osd.0\n\n# 删除节点\nceph osd rm osd.0\n\n# 删除节点认证（不删除编号会占住）\nceph auth del osd.0\n```\n\n\n#### 查看 mon 信息\n\n```\nceph mon dump\n\ndumped monmap epoch 1\nepoch 1\nfsid 4620d0c7-4458-4ff9-9296-d1318058bafc\nlast_changed 2019-06-19 14:44:41.361005\ncreated 2019-06-19 14:44:41.361005\n0: 192.168.0.134:6789/0 mon.dk2-t\n```\n\n#### 配置文件内容 /etc/ceph/ceph.conf\n```\n[global]\npublic network = 192.168.0.0/22\ncluster network = 192.168.0.0/22\nosd pool default size = 2\nfsid = 4620d0c7-4458-4ff9-9296-d1318058bafc\nmon_initial_members = dk2-t\nmon_host = 192.168.0.134\nauth_cluster_required = cephx\nauth_service_required = cephx\nauth_client_required = cephx\nmon_max_pg_per_osd = 1000\n```\n\n\n\n### ceph 一些测试命令\n\n####  创建 rbd pool，名字叫做 kube\n```\nceph osd pool create kube 256 256\n```\n\n#### 如何取得admin的密钥\n\n```\nceph auth get client.admin 2>&1 |grep \"key = \" |awk '{print  $3}'\nAQAn/19bbb21GBAA1kc0HRWoGjeoPTRQziA03A==\n```\n\n#### 测试ceph是否正常\n\n```\nrbd create kube/test --size 1024 --image-format 2\nrbd ls kube\nrbd map kube/test\n    # 如果报错, 警用\n    rbd info kube/test\n    rbd feature disable kube/test exclusive-lock object-map fast-diff deep-flatten\n\nrbd map kube/test\nrbd showmapped\nmkfs.ext4 /dev/rbd0\nmkdir /data/rbd0\nmount /dev/rbd0 /data/rbd0\ncd /data/rbd0 && echo test > test.txt\n\n```\n\n\n---\n\n\n\n\n### 在k8s 手动创建存储类\n#### 创建ceph pg\n```\n# Total PGs = (Total_number_of_OSD * 100) / max_replication_count\n# pg = 1 * 100 /2 ~ 64(取2的次方数)\n\n# 这里准备创建2个pool, 每个pool\nceph osd pool create rbd-k8s 16\n\n# 查看\nceph osd lspools\n\n# 创建image\nrbd create rbd-k8s/cephimageredis --size 500M\n\n# 查看list\nrbd list rbd-k8s\n\n# 处理新特性\n# 查看info\nrbd info rbd-k8s/cephimageredis\n\n# 关闭exclusive-lock object-map fast-diff deep-flatten 这些特性\nrbd feature disable  rbd-k8s/cephimageredis exclusive-lock object-map fast-diff deep-flatten\n```\n\n#### 首先创建secret\n```\n#获取key\ngrep key /etc/ceph/ceph.client.admin.keyring |awk '{printf \"%s\", $NF}'|base64\n```\n\n- **ceph-secret.yaml**\n```\napiVersion: v1\nkind: Secret\nmetadata:\n  name: ceph-secret\ntype: \"kubernetes.io/rbd\"\ndata:\n  key: QVFCTFo2dGNGNXFLRnhBQXBGTXJEdm5CY2k2UGtwZmZrN0JSVEE9PQ==\n```\n\n#### 其次创建pv, pv是没有namespace概念的\n> persistentVolumeReclaimPolicy是清理规则 (retain: 不清理, Recycle: 回收)\n- **redis-ceph-pv.yml**\n```\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: redis2-ceph-rbd-pv\nspec:\n  capacity:\n    storage: 100Mi\n  accessModes:\n    - ReadWriteOnce\n  rbd:\n    monitors:\n      - '192.168.0.134:6789'\n    pool: rbd-k8s\n    image: cephimageredis\n    user: admin\n    secretRef:\n      name: ceph-secret\n    fsType: ext4\n    readOnly: false\n  persistentVolumeReclaimPolicy: Recycle\n```\n\n- **执行部署pv**\n```\nkubectl create -f redis-ceph-pv.yml\n```\n\n#### 然后创建pvc\n- **redis-ceph-pvc.yml**\n\n```\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: redis2-ceph-rbd-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 100Mi\n```\n\n- **执行部署pvc**\n```\nkubectl create -f redis-ceph-pvc.yml\n```\n\n#### 最后在rancher上选择挂载rbd\n\n![rancher-pv](https://zhangzw001.github.io/images/blog6/rancher-pv.png)\n\n\n---\n\n\n\n\n","content":"<p>Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"简单了解什么是块存储-对象存储-文件系统存储？\"><a href=\"#简单了解什么是块存储-对象存储-文件系统存储？\" class=\"headerlink\" title=\"简单了解什么是块存储/对象存储/文件系统存储？\"></a>简单了解什么是块存储/对象存储/文件系统存储？</h3><p>ceph 目前提供对象存储（RADOSGW）、块存储RDB以及 CephFS 文件系统这 3 种功能。对于这3种功能介绍，分别如下：</p>\n<ol>\n<li><p>对象存储，也就是通常意义的键值存储，其接口就是简单的GET、PUT、DEL 和其他扩展，代表主要有 Swift 、S3 以及 Gluster 等；</p>\n</li>\n<li><p>块存储，这种接口通常以 QEMU Driver 或者 Kernel Module 的方式存在，这种接口需要实现 Linux 的 Block Device 的接口或者 QEMU 提供的 Block Driver 接口，如 Sheepdog，AWS 的 EBS，青云的云硬盘和阿里云的盘古系统，还有 Ceph 的 RBD（RBD是Ceph面向块存储的接口）。在常见的存储中 DAS、SAN 提供的也是块存储；</p>\n</li>\n<li><p>文件存储，通常意义是支持 POSIX 接口，它跟传统的文件系统如 Ext4 是一个类型的，但区别在于分布式存储提供了并行化的能力，如 Ceph 的 CephFS (CephFS是Ceph面向文件存储的接口)，但是有时候又会把 GlusterFS ，HDFS 这种非POSIX接口的类文件存储接口归入此类。当然 NFS、NAS也是属于文件系统存储；</p>\n</li>\n</ol>\n<h3 id=\"参考教程\"><a href=\"#参考教程\" class=\"headerlink\" title=\"参考教程\"></a>参考教程</h3><p><a href=\"https://blog.csdn.net/shida_csdn/article/details/78579043\" target=\"_blank\" rel=\"noopener\">Kubernetes 集成 Ceph 后端存储教程</a><br><a href=\"https://blog.csdn.net/zcc_heu/article/details/79017624\" target=\"_blank\" rel=\"noopener\">centos7安装ceph集群</a></p>\n<h3 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h3><h4 id=\"配置源\"><a href=\"#配置源\" class=\"headerlink\" title=\"配置源\"></a>配置源</h4><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;/etc/yum.repos.d/ceph.repo&lt;&lt;EOF</span><br><span class=\"line\">[ceph]</span><br><span class=\"line\">name=ceph</span><br><span class=\"line\">baseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">priority=1</span><br><span class=\"line\"></span><br><span class=\"line\">[ceph-noarch]</span><br><span class=\"line\">name=cephnoarch</span><br><span class=\"line\">baseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">priority=1</span><br><span class=\"line\"></span><br><span class=\"line\">[ceph-source]</span><br><span class=\"line\">name=Ceph source packages</span><br><span class=\"line\">baseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/SRPMS</span><br><span class=\"line\">enabled=0</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">type=rpm-md</span><br><span class=\"line\">gpgkey=http://mirrors.163.com/ceph/keys/release.asc</span><br><span class=\"line\">priority=1</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装过卸载\"><a href=\"#安装过卸载\" class=\"headerlink\" title=\"安装过卸载\"></a>安装过卸载</h4><figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph-deploy purge <span class=\"symbol\">dk1</span>-<span class=\"built_in\">t</span> <span class=\"symbol\">dk2</span>-<span class=\"built_in\">t</span></span><br><span class=\"line\">ceph-deploy purgedata <span class=\"symbol\">dk1</span>-<span class=\"built_in\">t</span> <span class=\"symbol\">dk2</span>-<span class=\"built_in\">t</span></span><br><span class=\"line\">ceph-deploy forgetkeys</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"在dk2-t节点创建集群-mon模块\"><a href=\"#在dk2-t节点创建集群-mon模块\" class=\"headerlink\" title=\"在dk2-t节点创建集群 mon模块\"></a>在dk2-t节点创建集群 mon模块</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install ceph-deploy -y</span><br><span class=\"line\">ceph-deploy --version</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir /data/ceph</span><br><span class=\"line\">cd /data/ceph</span><br><span class=\"line\">ceph-deploy new dk2-t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看配置文件</span></span><br><span class=\"line\">ls -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置ceph.conf</span></span><br><span class=\"line\">[global]</span><br><span class=\"line\"><span class=\"built_in\">..</span>.</span><br><span class=\"line\"><span class=\"comment\"># 如果有多个网卡，应该配置如下选项，</span></span><br><span class=\"line\"><span class=\"comment\"># public network是公共网络，负责集群对外提供服务的流量</span></span><br><span class=\"line\"><span class=\"comment\"># cluster network是集群网络，负载集群中数据复制传输通信等</span></span><br><span class=\"line\"><span class=\"comment\"># 本次实验使用同一块网卡，生境环境建议分别使用一块网卡</span></span><br><span class=\"line\">public<span class=\"built_in\"> network </span>= 192.168.0.0/22</span><br><span class=\"line\">cluster<span class=\"built_in\"> network </span>= 192.168.0.0/22</span><br><span class=\"line\">osd<span class=\"built_in\"> pool default </span>size = 2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 ceph 包</span></span><br><span class=\"line\"><span class=\"comment\"># 如果按照官方文档安装方法 会重新配置安装官方ceph源</span></span><br><span class=\"line\"><span class=\"comment\"># 由于网络问题，安装可能会出错，需要多次执行</span></span><br><span class=\"line\"><span class=\"comment\"># ceph-deploy install 其实只是会安装 ceph ceph-radosgw 两个包</span></span><br><span class=\"line\"><span class=\"comment\"># ceph-deploy install lab1 lab2 lab3</span></span><br><span class=\"line\"><span class=\"comment\"># 推荐使用阿里源安装，因为使用ceph-deploy安装会很慢</span></span><br><span class=\"line\"><span class=\"comment\"># 使用如下命令手动安装包，替代官方的 ceph-deploy install 命令</span></span><br><span class=\"line\"><span class=\"comment\"># 如下操作在所有node节点上执行</span></span><br><span class=\"line\"><span class=\"builtin-name\">export</span> <span class=\"attribute\">CEPH_DEPLOY_REPO_URL</span>=http://mirrors.163.com/ceph/rpm-luminous/el7</span><br><span class=\"line\"><span class=\"builtin-name\">export</span> <span class=\"attribute\">CEPH_DEPLOY_GPG_URL</span>=http://mirrors.163.com/ceph/keys/release.asc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 先执行是因为 ceph-deploy install太慢</span></span><br><span class=\"line\">yum install -y ceph ceph-radosgw</span><br><span class=\"line\">ceph-deploy install dk2-t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署monitor和生成keys</span></span><br><span class=\"line\">ceph-deploy mon create-initial</span><br><span class=\"line\">ls -l *.keyring</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到node节点</span></span><br><span class=\"line\">ceph-deploy dk1-t dk2-t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 额外mon节点，mon节点也需要高可用</span></span><br><span class=\"line\">ceph-deploy mon <span class=\"builtin-name\">add</span> dk1-t</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"在dk2-t节点创建集群-mgr模块\"><a href=\"#在dk2-t节点创建集群-mgr模块\" class=\"headerlink\" title=\"在dk2-t节点创建集群 mgr模块\"></a>在dk2-t节点创建集群 mgr模块</h3><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 部署manager （luminous+）12及以后的版本需要部署</span></span><br><span class=\"line\"><span class=\"meta\"># 本次部署 jewel 版本 ，不需要执行如下命令</span></span><br><span class=\"line\"> ceph-deploy mgr create dk2-t</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"在dk2-t节点创建集群-osd模块\"><a href=\"#在dk2-t节点创建集群-osd模块\" class=\"headerlink\" title=\"在dk2-t节点创建集群 osd模块\"></a>在dk2-t节点创建集群 osd模块</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 12的版本(这里挂载一个 10G的磁盘 /dev/sdb)</span></span><br><span class=\"line\"><span class=\"comment\"># create 命令一次完成准备 OSD 、部署到 OSD 节点、并激活它。 create 命令是依次执行 prepare 和 activate 命令的捷径。</span></span><br><span class=\"line\">ceph-deploy osd create <span class=\"params\">--data</span> <span class=\"string\">/dev/sdb</span> dk2-t</span><br><span class=\"line\">ceph-deploy osd create <span class=\"params\">--data</span> <span class=\"string\">/dev/sdc</span> dk1-t</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如何卸载osd\"><a href=\"#如何卸载osd\" class=\"headerlink\" title=\"如何卸载osd\"></a>如何卸载osd</h3><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看</span></span><br><span class=\"line\">ceph osd tree</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 节点状态标记为out</span></span><br><span class=\"line\">ceph osd out osd<span class=\"number\">.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 从crush中移除节点</span></span><br><span class=\"line\">ceph osd crush remove osd<span class=\"number\">.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 删除节点</span></span><br><span class=\"line\">ceph osd rm osd<span class=\"number\">.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 删除节点认证（不删除编号会占住）</span></span><br><span class=\"line\">ceph auth del osd<span class=\"number\">.0</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看-mon-信息\"><a href=\"#查看-mon-信息\" class=\"headerlink\" title=\"查看 mon 信息\"></a>查看 mon 信息</h4><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph mon dump</span><br><span class=\"line\"></span><br><span class=\"line\">dumped monmap epoch 1</span><br><span class=\"line\">epoch 1</span><br><span class=\"line\">fsid 4620d0c7<span class=\"string\">-4458</span><span class=\"string\">-4</span>ff9<span class=\"string\">-9296</span>-d1318058bafc</span><br><span class=\"line\">last_changed 2019<span class=\"string\">-06</span><span class=\"string\">-19</span> 14:44:41.361005</span><br><span class=\"line\">created 2019<span class=\"string\">-06</span><span class=\"string\">-19</span> 14:44:41.361005</span><br><span class=\"line\">0: 192.168.0.134:6789/0 mon.dk2-t</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置文件内容-etc-ceph-ceph-conf\"><a href=\"#配置文件内容-etc-ceph-ceph-conf\" class=\"headerlink\" title=\"配置文件内容 /etc/ceph/ceph.conf\"></a>配置文件内容 /etc/ceph/ceph.conf</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[global]</span><br><span class=\"line\">public<span class=\"built_in\"> network </span>= 192.168.0.0/22</span><br><span class=\"line\">cluster<span class=\"built_in\"> network </span>= 192.168.0.0/22</span><br><span class=\"line\">osd<span class=\"built_in\"> pool default </span>size = 2</span><br><span class=\"line\">fsid = 4620d0c7-4458-4ff9-9296-d1318058bafc</span><br><span class=\"line\">mon_initial_members = dk2-t</span><br><span class=\"line\">mon_host = 192.168.0.134</span><br><span class=\"line\">auth_cluster_required = cephx</span><br><span class=\"line\">auth_service_required = cephx</span><br><span class=\"line\">auth_client_required = cephx</span><br><span class=\"line\">mon_max_pg_per_osd = 1000</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ceph-一些测试命令\"><a href=\"#ceph-一些测试命令\" class=\"headerlink\" title=\"ceph 一些测试命令\"></a>ceph 一些测试命令</h3><h4 id=\"创建-rbd-pool，名字叫做-kube\"><a href=\"#创建-rbd-pool，名字叫做-kube\" class=\"headerlink\" title=\"创建 rbd pool，名字叫做 kube\"></a>创建 rbd pool，名字叫做 kube</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph osd<span class=\"built_in\"> pool </span>create kube 256 256</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"如何取得admin的密钥\"><a href=\"#如何取得admin的密钥\" class=\"headerlink\" title=\"如何取得admin的密钥\"></a>如何取得admin的密钥</h4><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph auth get client.admin <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span> |grep <span class=\"string\">\"key = \"</span> |awk '&#123;print  $<span class=\"number\">3</span>&#125;'</span><br><span class=\"line\">AQAn/<span class=\"number\">19</span>bbb21GBAA1kc0HRWoGjeoPTRQziA03A==</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"测试ceph是否正常\"><a href=\"#测试ceph是否正常\" class=\"headerlink\" title=\"测试ceph是否正常\"></a>测试ceph是否正常</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rbd <span class=\"keyword\">create</span> kube/<span class=\"keyword\">test</span> <span class=\"comment\">--size 1024 --image-format 2</span></span><br><span class=\"line\">rbd ls kube</span><br><span class=\"line\">rbd <span class=\"keyword\">map</span> kube/<span class=\"keyword\">test</span></span><br><span class=\"line\">    <span class=\"comment\"># 如果报错, 警用</span></span><br><span class=\"line\">    rbd info kube/<span class=\"keyword\">test</span></span><br><span class=\"line\">    rbd feature <span class=\"keyword\">disable</span> kube/<span class=\"keyword\">test</span> exclusive-<span class=\"keyword\">lock</span> <span class=\"keyword\">object</span>-<span class=\"keyword\">map</span> <span class=\"keyword\">fast</span>-diff deep-flatten</span><br><span class=\"line\"></span><br><span class=\"line\">rbd <span class=\"keyword\">map</span> kube/<span class=\"keyword\">test</span></span><br><span class=\"line\">rbd showmapped</span><br><span class=\"line\">mkfs.ext4 /dev/rbd0</span><br><span class=\"line\">mkdir /<span class=\"keyword\">data</span>/rbd0</span><br><span class=\"line\"><span class=\"keyword\">mount</span> /dev/rbd0 /<span class=\"keyword\">data</span>/rbd0</span><br><span class=\"line\">cd /<span class=\"keyword\">data</span>/rbd0 &amp;&amp; echo <span class=\"keyword\">test</span> &gt; test.txt</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"在k8s-手动创建存储类\"><a href=\"#在k8s-手动创建存储类\" class=\"headerlink\" title=\"在k8s 手动创建存储类\"></a>在k8s 手动创建存储类</h3><h4 id=\"创建ceph-pg\"><a href=\"#创建ceph-pg\" class=\"headerlink\" title=\"创建ceph pg\"></a>创建ceph pg</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Total PGs = (Total_number_of_OSD * 100) / max_replication_count</span></span><br><span class=\"line\"><span class=\"comment\"># pg = 1 * 100 /2 ~ 64(取2的次方数)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这里准备创建2个pool, 每个pool</span></span><br><span class=\"line\">ceph osd<span class=\"built_in\"> pool </span>create rbd-k8s 16</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\">ceph osd lspools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建image</span></span><br><span class=\"line\">rbd create rbd-k8s/cephimageredis --size 500M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看list</span></span><br><span class=\"line\">rbd list rbd-k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 处理新特性</span></span><br><span class=\"line\"><span class=\"comment\"># 查看info</span></span><br><span class=\"line\">rbd <span class=\"builtin-name\">info</span> rbd-k8s/cephimageredis</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭exclusive-lock object-map fast-diff deep-flatten 这些特性</span></span><br><span class=\"line\">rbd feature <span class=\"builtin-name\">disable</span>  rbd-k8s/cephimageredis exclusive-lock object-map fast-diff deep-flatten</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"首先创建secret\"><a href=\"#首先创建secret\" class=\"headerlink\" title=\"首先创建secret\"></a>首先创建secret</h4><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#获取<span class=\"built_in\">key</span></span><br><span class=\"line\">grep <span class=\"built_in\">key</span> /etc/ceph/ceph.client.admin.keyring |awk '&#123;<span class=\"built_in\">printf</span> <span class=\"string\">\"%s\"</span>, $NF&#125;'|<span class=\"built_in\">base64</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ceph-secret.yaml</strong><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ceph-secret</span><br><span class=\"line\">type: <span class=\"string\">\"kubernetes.io/rbd\"</span></span><br><span class=\"line\">data:</span><br><span class=\"line\">  key: <span class=\"attribute\">QVFCTFo2dGNGNXFLRnhBQXBGTXJEdm5CY2k2UGtwZmZrN0JSVEE9PQ</span>==</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"其次创建pv-pv是没有namespace概念的\"><a href=\"#其次创建pv-pv是没有namespace概念的\" class=\"headerlink\" title=\"其次创建pv, pv是没有namespace概念的\"></a>其次创建pv, pv是没有namespace概念的</h4><blockquote>\n<p>persistentVolumeReclaimPolicy是清理规则 (retain: 不清理, Recycle: 回收)</p>\n<ul>\n<li><strong>redis-ceph-pv.yml</strong></li>\n</ul>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis2-ceph-rbd-pv</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  capacity:</span></span><br><span class=\"line\"><span class=\"attr\">    storage:</span> <span class=\"number\">100</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">  accessModes:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\"><span class=\"attr\">  rbd:</span></span><br><span class=\"line\"><span class=\"attr\">    monitors:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'192.168.0.134:6789'</span></span><br><span class=\"line\"><span class=\"attr\">    pool:</span> <span class=\"string\">rbd-k8s</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">cephimageredis</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">    secretRef:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">ceph-secret</span></span><br><span class=\"line\"><span class=\"attr\">    fsType:</span> <span class=\"string\">ext4</span></span><br><span class=\"line\"><span class=\"attr\">    readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">  persistentVolumeReclaimPolicy:</span> <span class=\"string\">Recycle</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>执行部署pv</strong><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubectl</span> <span class=\"selector-tag\">create</span> <span class=\"selector-tag\">-f</span> <span class=\"selector-tag\">redis-ceph-pv</span><span class=\"selector-class\">.yml</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"然后创建pvc\"><a href=\"#然后创建pvc\" class=\"headerlink\" title=\"然后创建pvc\"></a>然后创建pvc</h4><ul>\n<li><strong>redis-ceph-pvc.yml</strong></li>\n</ul>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> PersistentVolumeClaim</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> redis2-ceph-rbd-pvc</span><br><span class=\"line\"><span class=\"symbol\">spec:</span></span><br><span class=\"line\"><span class=\"symbol\">  accessModes:</span></span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\"><span class=\"symbol\">  resources:</span></span><br><span class=\"line\"><span class=\"symbol\">    requests:</span></span><br><span class=\"line\"><span class=\"symbol\">      storage:</span> <span class=\"number\">100</span>Mi</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>执行部署pvc</strong><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubectl</span> <span class=\"selector-tag\">create</span> <span class=\"selector-tag\">-f</span> <span class=\"selector-tag\">redis-ceph-pvc</span><span class=\"selector-class\">.yml</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"最后在rancher上选择挂载rbd\"><a href=\"#最后在rancher上选择挂载rbd\" class=\"headerlink\" title=\"最后在rancher上选择挂载rbd\"></a>最后在rancher上选择挂载rbd</h4><p><img src=\"https://zhangzw001.github.io/images/blog6/rancher-pv.png\" alt=\"rancher-pv\"></p>\n<hr>\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/26/6-ceph安装部署/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"存储","slug":"存储","permalink":"https://blog.k1s.club/categories/存储/"},{"name":"ceph","slug":"存储/ceph","permalink":"https://blog.k1s.club/categories/存储/ceph/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"ceph","slug":"ceph","permalink":"https://blog.k1s.club/tags/ceph/"},{"name":"cephfs","slug":"cephfs","permalink":"https://blog.k1s.club/tags/cephfs/"},{"name":"k8s存储","slug":"k8s存储","permalink":"https://blog.k1s.club/tags/k8s存储/"}]},{"title":"hexo添加看板娘","date":"2019-09-24T09:46:17.000Z","path":"2019/09/24/5-hexo添加看板娘/","text":"hexo6 左下角添加看板娘 github地址: 张书樵大神 下载大神项目 (会说话,换人物,小游戏等功能)12cd themes/nextv6/sourcegit clone https://github.com/stevenjoezhang/live2d-widget.git github说明比较详细, 这里简单说明 由于这里是克隆到了source目录, hexo d -g的时候会生成到public目录, 相当于站点根目录了 123456# 直接开启autoload.js注释const live2d_path = \"/live2d-widget/\";# 修改 themes/nextv6/layout/_layout.swig, 最后一行添加如下&lt;!-- 看板娘 --&gt;&lt;script src=\"/live2d-widget/autoload.js\"&gt;&lt;/script&gt; 一般小白简单教程(只有看鼠标方向功能) hexo 官方支持版 需要安装模板1npm install --save hexo-helper-live2d 修改主题配置文件各种宠物预览 12345678910111213141516171819202122232425# Live2D## https://github.com/EYHN/hexo-helper-live2dlive2d: enable: true # enable: false scriptFrom: local # 默认 pluginRootPath: live2dw/ # 插件在站点上的根目录(相对路径) pluginJsPath: lib/ # 脚本文件相对与插件根目录路径 pluginModelPath: assets/ # 模型文件相对与插件根目录路径 # scriptFrom: jsdelivr # jsdelivr CDN # scriptFrom: unpkg # unpkg CDN # scriptFrom: https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js # 你的自定义 url tagMode: false # 标签模式, 是否仅替换 live2d tag标签而非插入到所有页面中 debug: false # 调试, 是否在控制台输出日志 model: use: live2d-widget-model-haruto # npm-module package name # use: wanko # 博客根目录/live2d_models/ 下的目录名 # use: ./wives/wanko # 相对于博客根目录的路径 # use: https://cdn.jsdelivr.net/npm/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json # 你的自定义 url display: position: left width: 150 height: 300 mobile: show: true # 手机中是否展示","raw":"---\ntitle: hexo添加看板娘\ncopyright: true\ndate: 2019-09-24 17:46:17\ntags:\n  - hexo6\n  - 特效\ncategories:\n  - [有趣,二次元]\n  - [博客,美化]\n---\n\n### hexo6 左下角添加看板娘\n<!--more-->\n\ngithub地址: [张书樵大神](https://github.com/stevenjoezhang/live2d-widget)\n\n### 下载大神项目 (会说话,换人物,小游戏等功能)\n```\ncd themes/nextv6/source\ngit clone https://github.com/stevenjoezhang/live2d-widget.git\n```\n\n#### github说明比较详细, 这里简单说明\n> 由于这里是克隆到了source目录, hexo d -g的时候会生成到public目录, 相当于站点根目录了\n```\n# 直接开启autoload.js注释\nconst live2d_path = \"/live2d-widget/\";\n\n# 修改 themes/nextv6/layout/_layout.swig, 最后一行添加如下\n<!-- 看板娘 -->\n<script src=\"/live2d-widget/autoload.js\"></script>\n```\n\n\n### 一般小白简单教程(只有看鼠标方向功能)\n\n> hexo 官方支持版\n#### 需要安装模板\n```\nnpm install --save hexo-helper-live2d\n```\n\n#### 修改主题配置文件\n[各种宠物预览](https://blog.csdn.net/wang_123_zy/article/details/87181892#live2dwidgetmodelchitose_12)\n```\n# Live2D\n## https://github.com/EYHN/hexo-helper-live2d\nlive2d:\n  enable: true\n  # enable: false\n  scriptFrom: local # 默认\n  pluginRootPath: live2dw/ # 插件在站点上的根目录(相对路径)\n  pluginJsPath: lib/ # 脚本文件相对与插件根目录路径\n  pluginModelPath: assets/ # 模型文件相对与插件根目录路径\n  # scriptFrom: jsdelivr # jsdelivr CDN\n  # scriptFrom: unpkg # unpkg CDN\n  # scriptFrom: https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js # 你的自定义 url\n  tagMode: false # 标签模式, 是否仅替换 live2d tag标签而非插入到所有页面中\n  debug: false # 调试, 是否在控制台输出日志\n  model:\n    use: live2d-widget-model-haruto # npm-module package name\n    # use: wanko # 博客根目录/live2d_models/ 下的目录名\n    # use: ./wives/wanko # 相对于博客根目录的路径\n    # use: https://cdn.jsdelivr.net/npm/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json # 你的自定义 url\n  display:\n    position: left\n    width: 150\n    height: 300\n  mobile:\n    show: true # 手机中是否展示\n```\n","content":"<h3 id=\"hexo6-左下角添加看板娘\"><a href=\"#hexo6-左下角添加看板娘\" class=\"headerlink\" title=\"hexo6 左下角添加看板娘\"></a>hexo6 左下角添加看板娘</h3><a id=\"more\"></a>\n\n<p>github地址: <a href=\"https://github.com/stevenjoezhang/live2d-widget\" target=\"_blank\" rel=\"noopener\">张书樵大神</a></p>\n<h3 id=\"下载大神项目-会说话-换人物-小游戏等功能\"><a href=\"#下载大神项目-会说话-换人物-小游戏等功能\" class=\"headerlink\" title=\"下载大神项目 (会说话,换人物,小游戏等功能)\"></a>下载大神项目 (会说话,换人物,小游戏等功能)</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">cd</span> themes/nextv6/<span class=\"keyword\">source</span></span><br><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/stevenjoezhang/live2d-widget.git</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"github说明比较详细-这里简单说明\"><a href=\"#github说明比较详细-这里简单说明\" class=\"headerlink\" title=\"github说明比较详细, 这里简单说明\"></a>github说明比较详细, 这里简单说明</h4><blockquote>\n<p>由于这里是克隆到了source目录, hexo d -g的时候会生成到public目录, 相当于站点根目录了</p>\n</blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 直接开启autoload.js注释</span><br><span class=\"line\">const live2d_path = \"/live2d-widget/\";</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改 themes/nextv6/layout/_layout.swig, 最后一行添加如下</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 看板娘 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/live2d-widget/autoload.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"一般小白简单教程-只有看鼠标方向功能\"><a href=\"#一般小白简单教程-只有看鼠标方向功能\" class=\"headerlink\" title=\"一般小白简单教程(只有看鼠标方向功能)\"></a>一般小白简单教程(只有看鼠标方向功能)</h3><blockquote>\n<p>hexo 官方支持版</p>\n</blockquote>\n<h4 id=\"需要安装模板\"><a href=\"#需要安装模板\" class=\"headerlink\" title=\"需要安装模板\"></a>需要安装模板</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm <span class=\"keyword\">install</span> <span class=\"comment\">--save hexo-helper-live2d</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改主题配置文件\"><a href=\"#修改主题配置文件\" class=\"headerlink\" title=\"修改主题配置文件\"></a>修改主题配置文件</h4><p><a href=\"https://blog.csdn.net/wang_123_zy/article/details/87181892#live2dwidgetmodelchitose_12\" target=\"_blank\" rel=\"noopener\">各种宠物预览</a></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Live2D</span></span><br><span class=\"line\"><span class=\"comment\">## https://github.com/EYHN/hexo-helper-live2d</span></span><br><span class=\"line\"><span class=\"attr\">live2d:</span></span><br><span class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># enable: false</span></span><br><span class=\"line\"><span class=\"attr\">  scriptFrom:</span> <span class=\"string\">local</span> <span class=\"comment\"># 默认</span></span><br><span class=\"line\"><span class=\"attr\">  pluginRootPath:</span> <span class=\"string\">live2dw/</span> <span class=\"comment\"># 插件在站点上的根目录(相对路径)</span></span><br><span class=\"line\"><span class=\"attr\">  pluginJsPath:</span> <span class=\"string\">lib/</span> <span class=\"comment\"># 脚本文件相对与插件根目录路径</span></span><br><span class=\"line\"><span class=\"attr\">  pluginModelPath:</span> <span class=\"string\">assets/</span> <span class=\"comment\"># 模型文件相对与插件根目录路径</span></span><br><span class=\"line\">  <span class=\"comment\"># scriptFrom: jsdelivr # jsdelivr CDN</span></span><br><span class=\"line\">  <span class=\"comment\"># scriptFrom: unpkg # unpkg CDN</span></span><br><span class=\"line\">  <span class=\"comment\"># scriptFrom: https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js # 你的自定义 url</span></span><br><span class=\"line\"><span class=\"attr\">  tagMode:</span> <span class=\"literal\">false</span> <span class=\"comment\"># 标签模式, 是否仅替换 live2d tag标签而非插入到所有页面中</span></span><br><span class=\"line\"><span class=\"attr\">  debug:</span> <span class=\"literal\">false</span> <span class=\"comment\"># 调试, 是否在控制台输出日志</span></span><br><span class=\"line\"><span class=\"attr\">  model:</span></span><br><span class=\"line\"><span class=\"attr\">    use:</span> <span class=\"string\">live2d-widget-model-haruto</span> <span class=\"comment\"># npm-module package name</span></span><br><span class=\"line\">    <span class=\"comment\"># use: wanko # 博客根目录/live2d_models/ 下的目录名</span></span><br><span class=\"line\">    <span class=\"comment\"># use: ./wives/wanko # 相对于博客根目录的路径</span></span><br><span class=\"line\">    <span class=\"comment\"># use: https://cdn.jsdelivr.net/npm/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json # 你的自定义 url</span></span><br><span class=\"line\"><span class=\"attr\">  display:</span></span><br><span class=\"line\"><span class=\"attr\">    position:</span> <span class=\"string\">left</span></span><br><span class=\"line\"><span class=\"attr\">    width:</span> <span class=\"number\">150</span></span><br><span class=\"line\"><span class=\"attr\">    height:</span> <span class=\"number\">300</span></span><br><span class=\"line\"><span class=\"attr\">  mobile:</span></span><br><span class=\"line\"><span class=\"attr\">    show:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 手机中是否展示</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/24/5-hexo添加看板娘/","categories":[{"name":"有趣","slug":"有趣","permalink":"https://blog.k1s.club/categories/有趣/"},{"name":"博客","slug":"博客","permalink":"https://blog.k1s.club/categories/博客/"},{"name":"二次元","slug":"有趣/二次元","permalink":"https://blog.k1s.club/categories/有趣/二次元/"},{"name":"美化","slug":"博客/美化","permalink":"https://blog.k1s.club/categories/博客/美化/"}],"tags":[{"name":"hexo6","slug":"hexo6","permalink":"https://blog.k1s.club/tags/hexo6/"},{"name":"特效","slug":"特效","permalink":"https://blog.k1s.club/tags/特效/"}]},{"title":"hexo鼠标移动和鼠标点击特效","date":"2019-09-24T08:34:36.000Z","path":"2019/09/24/4-hexo鼠标移动和鼠标点击特效/","text":"hexo6 鼠标添加点击出现桃心的特效 来自: Next主题个性化 所需要的js文件 未压缩 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051! function(e, t, a) &#123; function n() &#123; c( \".heart&#123;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);&#125;.heart:after,.heart:before&#123;content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;&#125;.heart:after&#123;top: -5px;&#125;.heart:before&#123;left: -5px;&#125;\"), o(), r() &#125; function r() &#123; for (var e = 0; e &lt; d.length; e++) d[e].alpha &lt;= 0 ? (t.body.removeChild(d[e].el), d.splice(e, 1)) : (d[e].y--, d[e].scale += .004, d[e].alpha -= .013, d[e].el.style.cssText = \"left:\" + d[e].x + \"px;top:\" + d[e].y + \"px;opacity:\" + d[e].alpha + \";transform:scale(\" + d[e].scale + \",\" + d[e].scale + \") rotate(45deg);background:\" + d[e].color + \";z-index:99999\"); requestAnimationFrame(r) &#125; function o() &#123; var t = \"function\" == typeof e.onclick &amp;&amp; e.onclick; e.onclick = function(e) &#123; t &amp;&amp; t(), i(e) &#125; &#125; function i(e) &#123; var a = t.createElement(\"div\"); a.className = \"heart\", d.push(&#123; el: a, x: e.clientX - 5, y: e.clientY - 5, scale: 1, alpha: 1, color: s() &#125;), t.body.appendChild(a) &#125; function c(e) &#123; var a = t.createElement(\"style\"); a.type = \"text/css\"; try &#123; a.appendChild(t.createTextNode(e)) &#125; catch (t) &#123; a.styleSheet.cssText = e &#125; t.getElementsByTagName(\"head\")[0].appendChild(a) &#125; function s() &#123; return \"rgb(\" + ~~(255 * Math.random()) + \",\" + ~~(255 * Math.random()) + \",\" + ~~(255 * Math.random()) + \")\" &#125; var d = []; e.requestAnimationFrame = function() &#123; return e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function(e) &#123; setTimeout(e, 1e3 / 60) &#125; &#125;(), n()&#125;(window, document); 压缩后 1!function(e,t,a)&#123;function n()&#123;c(\".heart&#123;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);&#125;.heart:after,.heart:before&#123;content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;&#125;.heart:after&#123;top: -5px;&#125;.heart:before&#123;left: -5px;&#125;\"),o(),r()&#125;function r()&#123;for(var e=0;e&lt;d.length;e++)d[e].alpha&lt;=0?(t.body.removeChild(d[e].el),d.splice(e,1)):(d[e].y--,d[e].scale+=.004,d[e].alpha-=.013,d[e].el.style.cssText=\"left:\"+d[e].x+\"px;top:\"+d[e].y+\"px;opacity:\"+d[e].alpha+\";transform:scale(\"+d[e].scale+\",\"+d[e].scale+\") rotate(45deg);background:\"+d[e].color+\";z-index:99999\");requestAnimationFrame(r)&#125;function o()&#123;var t=\"function\"==typeof e.onclick&amp;&amp;e.onclick;e.onclick=function(e)&#123;t&amp;&amp;t(),i(e)&#125;&#125;function i(e)&#123;var a=t.createElement(\"div\");a.className=\"heart\",d.push(&#123;el:a,x:e.clientX-5,y:e.clientY-5,scale:1,alpha:1,color:s()&#125;),t.body.appendChild(a)&#125;function c(e)&#123;var a=t.createElement(\"style\");a.type=\"text/css\";try&#123;a.appendChild(t.createTextNode(e))&#125;catch(t)&#123;a.styleSheet.cssText=e&#125;t.getElementsByTagName(\"head\")[0].appendChild(a)&#125;function s()&#123;return\"rgb(\"+~~(255*Math.random())+\",\"+~~(255*Math.random())+\",\"+~~(255*Math.random())+\")\"&#125;var d=[];e.requestAnimationFrame=function()&#123;return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e)&#123;setTimeout(e,1e3/60)&#125;&#125;(),n()&#125;(window,document); 将上面的内容贴到新增的themes/nextv6/source/js/src/love.js 文件中修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容12&lt;!-- 鼠标桃心动画 --&gt;&lt;script type=\"text/javascript\" src=\"/js/src/love.js\"&gt;&lt;/script&gt; hexo6 鼠标移动添加星星特效来自: 愚人节鼠标跟随特效 新增js文件 themes/nextv6/source/js/src/love2.js123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143/*! * Fairy Dust Cursor.js * - 90's cursors collection * -- https://github.com/tholman/90s-cursor-effects * -- http://codepen.io/tholman/full/jWmZxZ/ */(function fairyDustCursor() &#123; var possibleColors = [\"#D61C59\", \"#E7D84B\", \"#1B8798\"] var width = window.innerWidth; var height = window.innerHeight; var cursor = &#123;x: width/2, y: width/2&#125;; var particles = []; function init() &#123; bindEvents(); loop(); &#125; // Bind events that are needed function bindEvents() &#123; document.addEventListener('mousemove', onMouseMove); document.addEventListener('touchmove', onTouchMove); document.addEventListener('touchstart', onTouchMove); window.addEventListener('resize', onWindowResize); &#125; function onWindowResize(e) &#123; width = window.innerWidth; height = window.innerHeight; &#125; function onTouchMove(e) &#123; if( e.touches.length &gt; 0 ) &#123; for( var i = 0; i &lt; e.touches.length; i++ ) &#123; addParticle( e.touches[i].clientX, e.touches[i].clientY, possibleColors[Math.floor(Math.random()*possibleColors.length)]); &#125; &#125; &#125; function onMouseMove(e) &#123; cursor.x = e.clientX; cursor.y = e.clientY; addParticle( cursor.x, cursor.y, possibleColors[Math.floor(Math.random()*possibleColors.length)]); &#125; function addParticle(x, y, color) &#123; var particle = new Particle(); particle.init(x, y, color); particles.push(particle); &#125; function updateParticles() &#123; // Updated for( var i = 0; i &lt; particles.length; i++ ) &#123; particles[i].update(); &#125; // Remove dead particles for( var i = particles.length -1; i &gt;= 0; i-- ) &#123; if( particles[i].lifeSpan &lt; 0 ) &#123; particles[i].die(); particles.splice(i, 1); &#125; &#125; &#125; function loop() &#123; requestAnimationFrame(loop); updateParticles(); &#125; /** * Particles */ function Particle() &#123; this.character = \"*\"; this.lifeSpan = 120; //ms this.initialStyles =&#123; \"position\": \"fixed\", \"top\": \"0\", //必须加 \"display\": \"block\", \"pointerEvents\": \"none\", \"z-index\": \"10000000\", \"fontSize\": \"20px\", \"will-change\": \"transform\" &#125;; // Init, and set properties this.init = function(x, y, color) &#123; this.velocity = &#123; x: (Math.random() &lt; 0.5 ? -1 : 1) * (Math.random() / 2), y: 1 &#125;; this.position = &#123;x: x - 10, y: y - 20&#125;; this.initialStyles.color = color; console.log(color); this.element = document.createElement('span'); this.element.innerHTML = this.character; applyProperties(this.element, this.initialStyles); this.update(); document.body.appendChild(this.element); &#125;; this.update = function() &#123; this.position.x += this.velocity.x; this.position.y += this.velocity.y; this.lifeSpan--; this.element.style.transform = \"translate3d(\" + this.position.x + \"px,\" + this.position.y + \"px,0) scale(\" + (this.lifeSpan / 120) + \")\"; &#125; this.die = function() &#123; this.element.parentNode.removeChild(this.element); &#125; &#125; /** * Utils */ // Applies css `properties` to an element. function applyProperties( target, properties ) &#123; for( var key in properties ) &#123; target.style[ key ] = properties[ key ]; &#125; &#125; init();&#125;)(); 修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容12&lt;!-- 鼠标移动星星特效 --&gt;&lt;script type=\"text/javascript\" src=\"/js/src/love2.js\"&gt;&lt;/script&gt;","raw":"---\ntitle: hexo鼠标移动和鼠标点击特效\ncopyright: true\ndate: 2019-09-24 16:34:36\ntags:\n  - hexo6\n  - 特效\ncategories:\n  - [有趣]\n  - [博客,美化]\n---\n\n### hexo6 鼠标添加点击出现桃心的特效\n <!-- more -->\n\n来自: [Next主题个性化](https://www.writebug.site/2019/01/02/Next%E4%B8%BB%E9%A2%98%E4%B8%AA%E6%80%A7%E5%8C%96/)\n\n#### 所需要的js文件\n- 未压缩\n```\n! function(e, t, a) {\n    function n() {\n        c(\n            \".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}\"), o(), r()\n    }\n    \n    function r() {\n        for (var e = 0; e < d.length; e++) d[e].alpha <= 0 ? (t.body.removeChild(d[e].el), d.splice(e, 1)) : (d[e].y--, d[e].scale += .004, d[e].alpha -= .013, d[e].el.style.cssText = \"left:\" + d[e].x + \"px;top:\" + d[e].y + \"px;opacity:\" + d[e].alpha + \";transform:scale(\" + d[e].scale + \",\" + d[e].scale + \") rotate(45deg);background:\" + d[e].color + \";z-index:99999\");\n        requestAnimationFrame(r)\n    }\n    \n    function o() {\n        var t = \"function\" == typeof e.onclick && e.onclick;\n        e.onclick = function(e) {\n            t && t(), i(e)\n        }\n    }\n    \n    function i(e) {\n        var a = t.createElement(\"div\");\n        a.className = \"heart\", d.push({\n            el: a,\n            x: e.clientX - 5,\n            y: e.clientY - 5,\n            scale: 1,\n            alpha: 1,\n            color: s()\n        }), t.body.appendChild(a)\n    }\n\n    function c(e) {\n        var a = t.createElement(\"style\");\n        a.type = \"text/css\";\n        try {\n            a.appendChild(t.createTextNode(e))\n        } catch (t) {\n            a.styleSheet.cssText = e\n        }\n        t.getElementsByTagName(\"head\")[0].appendChild(a)\n    }\n\n    function s() {\n        return \"rgb(\" + ~~(255 * Math.random()) + \",\" + ~~(255 * Math.random()) + \",\" + ~~(255 * Math.random()) + \")\"\n    }\n    var d = [];\n    e.requestAnimationFrame = function() {\n        return e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function(e) {\n            setTimeout(e, 1e3 / 60)\n        }\n    }(), n()\n}(window, document);\n```\n\n- 压缩后\n```\n!function(e,t,a){function n(){c(\".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}\"),o(),r()}function r(){for(var e=0;e<d.length;e++)d[e].alpha<=0?(t.body.removeChild(d[e].el),d.splice(e,1)):(d[e].y--,d[e].scale+=.004,d[e].alpha-=.013,d[e].el.style.cssText=\"left:\"+d[e].x+\"px;top:\"+d[e].y+\"px;opacity:\"+d[e].alpha+\";transform:scale(\"+d[e].scale+\",\"+d[e].scale+\") rotate(45deg);background:\"+d[e].color+\";z-index:99999\");requestAnimationFrame(r)}function o(){var t=\"function\"==typeof e.onclick&&e.onclick;e.onclick=function(e){t&&t(),i(e)}}function i(e){var a=t.createElement(\"div\");a.className=\"heart\",d.push({el:a,x:e.clientX-5,y:e.clientY-5,scale:1,alpha:1,color:s()}),t.body.appendChild(a)}function c(e){var a=t.createElement(\"style\");a.type=\"text/css\";try{a.appendChild(t.createTextNode(e))}catch(t){a.styleSheet.cssText=e}t.getElementsByTagName(\"head\")[0].appendChild(a)}function s(){return\"rgb(\"+~~(255*Math.random())+\",\"+~~(255*Math.random())+\",\"+~~(255*Math.random())+\")\"}var d=[];e.requestAnimationFrame=function(){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)}}(),n()}(window,document);\n```\n\n#### 将上面的内容贴到新增的themes/nextv6/source/js/src/love.js 文件中\n\n#### 修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容\n```\n<!-- 鼠标桃心动画 -->\n<script type=\"text/javascript\" src=\"/js/src/love.js\"></script>\n```\n\n\n### hexo6 鼠标移动添加星星特效\n来自: [愚人节鼠标跟随特效](https://blog.csdn.net/a201577F0546/article/details/89060017)\n\n#### 新增js文件 themes/nextv6/source/js/src/love2.js\n```\n\n/*!\n * Fairy Dust Cursor.js\n * - 90's cursors collection\n * -- https://github.com/tholman/90s-cursor-effects\n * -- http://codepen.io/tholman/full/jWmZxZ/\n */\n\n(function fairyDustCursor() {\n  \n  var possibleColors = [\"#D61C59\", \"#E7D84B\", \"#1B8798\"]\n  var width = window.innerWidth;\n  var height = window.innerHeight;\n  var cursor = {x: width/2, y: width/2};\n  var particles = [];\n  \n  function init() {\n    bindEvents();\n    loop();\n  }\n  \n  // Bind events that are needed\n  function bindEvents() {\n    document.addEventListener('mousemove', onMouseMove);\n    document.addEventListener('touchmove', onTouchMove);\n    document.addEventListener('touchstart', onTouchMove);\n    \n    window.addEventListener('resize', onWindowResize);\n  }\n  \n  function onWindowResize(e) {\n    width = window.innerWidth;\n    height = window.innerHeight;\n  }\n  \n  function onTouchMove(e) {\n    if( e.touches.length > 0 ) {\n      for( var i = 0; i < e.touches.length; i++ ) {\n        addParticle( e.touches[i].clientX, e.touches[i].clientY, possibleColors[Math.floor(Math.random()*possibleColors.length)]);\n      }\n    }\n  }\n  \n  function onMouseMove(e) {    \n    cursor.x = e.clientX;\n    cursor.y = e.clientY;\n    \n    addParticle( cursor.x, cursor.y, possibleColors[Math.floor(Math.random()*possibleColors.length)]);\n  }\n  \n  function addParticle(x, y, color) {\n    var particle = new Particle();\n    particle.init(x, y, color);\n    particles.push(particle);\n  }\n  \n  function updateParticles() {\n    \n    // Updated\n    for( var i = 0; i < particles.length; i++ ) {\n      particles[i].update();\n    }\n    \n    // Remove dead particles\n    for( var i = particles.length -1; i >= 0; i-- ) {\n      if( particles[i].lifeSpan < 0 ) {\n        particles[i].die();\n        particles.splice(i, 1);\n      }\n    }\n    \n  }\n  \n  function loop() {\n    requestAnimationFrame(loop);\n    updateParticles();\n  }\n  \n  /**\n   * Particles\n   */\n  \n  function Particle() {\n\n    this.character = \"*\";\n    this.lifeSpan = 120; //ms\n    this.initialStyles ={\n      \"position\": \"fixed\",\n      \"top\": \"0\", //必须加\n      \"display\": \"block\",\n      \"pointerEvents\": \"none\",\n      \"z-index\": \"10000000\",\n      \"fontSize\": \"20px\",\n      \"will-change\": \"transform\"\n    };\n\n    // Init, and set properties\n    this.init = function(x, y, color) {\n\n      this.velocity = {\n        x:  (Math.random() < 0.5 ? -1 : 1) * (Math.random() / 2),\n        y: 1\n      };\n      \n      this.position = {x: x - 10, y: y - 20};\n      this.initialStyles.color = color;\n      console.log(color);\n\n      this.element = document.createElement('span');\n      this.element.innerHTML = this.character;\n      applyProperties(this.element, this.initialStyles);\n      this.update();\n      \n      document.body.appendChild(this.element);\n    };\n    \n    this.update = function() {\n      this.position.x += this.velocity.x;\n      this.position.y += this.velocity.y;\n      this.lifeSpan--;\n      \n      this.element.style.transform = \"translate3d(\" + this.position.x + \"px,\" + this.position.y + \"px,0) scale(\" + (this.lifeSpan / 120) + \")\";\n    }\n    \n    this.die = function() {\n      this.element.parentNode.removeChild(this.element);\n    }\n    \n  }\n  \n  /**\n   * Utils\n   */\n  \n  // Applies css `properties` to an element.\n  function applyProperties( target, properties ) {\n    for( var key in properties ) {\n      target.style[ key ] = properties[ key ];\n    }\n  }\n  \n  init();\n})();\n```\n\n#### 修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容\n```\n<!-- 鼠标移动星星特效 -->\n<script type=\"text/javascript\" src=\"/js/src/love2.js\"></script>\n```\n","content":"<h3 id=\"hexo6-鼠标添加点击出现桃心的特效\"><a href=\"#hexo6-鼠标添加点击出现桃心的特效\" class=\"headerlink\" title=\"hexo6 鼠标添加点击出现桃心的特效\"></a>hexo6 鼠标添加点击出现桃心的特效</h3> <a id=\"more\"></a>\n\n<p>来自: <a href=\"https://www.writebug.site/2019/01/02/Next%E4%B8%BB%E9%A2%98%E4%B8%AA%E6%80%A7%E5%8C%96/\" target=\"_blank\" rel=\"noopener\">Next主题个性化</a></p>\n<h4 id=\"所需要的js文件\"><a href=\"#所需要的js文件\" class=\"headerlink\" title=\"所需要的js文件\"></a>所需要的js文件</h4><ul>\n<li><p>未压缩</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e, t, a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">n</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        c(</span><br><span class=\"line\">            <span class=\"string\">\".heart&#123;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);&#125;.heart:after,.heart:before&#123;content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;&#125;.heart:after&#123;top: -5px;&#125;.heart:before&#123;left: -5px;&#125;\"</span>), o(), r()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">r</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> e = <span class=\"number\">0</span>; e &lt; d.length; e++) d[e].alpha &lt;= <span class=\"number\">0</span> ? (t.body.removeChild(d[e].el), d.splice(e, <span class=\"number\">1</span>)) : (d[e].y--, d[e].scale += <span class=\"number\">.004</span>, d[e].alpha -= <span class=\"number\">.013</span>, d[e].el.style.cssText = <span class=\"string\">\"left:\"</span> + d[e].x + <span class=\"string\">\"px;top:\"</span> + d[e].y + <span class=\"string\">\"px;opacity:\"</span> + d[e].alpha + <span class=\"string\">\";transform:scale(\"</span> + d[e].scale + <span class=\"string\">\",\"</span> + d[e].scale + <span class=\"string\">\") rotate(45deg);background:\"</span> + d[e].color + <span class=\"string\">\";z-index:99999\"</span>);</span><br><span class=\"line\">        requestAnimationFrame(r)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">o</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> t = <span class=\"string\">\"function\"</span> == <span class=\"keyword\">typeof</span> e.onclick &amp;&amp; e.onclick;</span><br><span class=\"line\">        e.onclick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">            t &amp;&amp; t(), i(e)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">i</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> a = t.createElement(<span class=\"string\">\"div\"</span>);</span><br><span class=\"line\">        a.className = <span class=\"string\">\"heart\"</span>, d.push(&#123;</span><br><span class=\"line\">            el: a,</span><br><span class=\"line\">            x: e.clientX - <span class=\"number\">5</span>,</span><br><span class=\"line\">            y: e.clientY - <span class=\"number\">5</span>,</span><br><span class=\"line\">            scale: <span class=\"number\">1</span>,</span><br><span class=\"line\">            alpha: <span class=\"number\">1</span>,</span><br><span class=\"line\">            color: s()</span><br><span class=\"line\">        &#125;), t.body.appendChild(a)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">c</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> a = t.createElement(<span class=\"string\">\"style\"</span>);</span><br><span class=\"line\">        a.type = <span class=\"string\">\"text/css\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            a.appendChild(t.createTextNode(e))</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (t) &#123;</span><br><span class=\"line\">            a.styleSheet.cssText = e</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        t.getElementsByTagName(<span class=\"string\">\"head\"</span>)[<span class=\"number\">0</span>].appendChild(a)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">s</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"rgb(\"</span> + ~~(<span class=\"number\">255</span> * <span class=\"built_in\">Math</span>.random()) + <span class=\"string\">\",\"</span> + ~~(<span class=\"number\">255</span> * <span class=\"built_in\">Math</span>.random()) + <span class=\"string\">\",\"</span> + ~~(<span class=\"number\">255</span> * <span class=\"built_in\">Math</span>.random()) + <span class=\"string\">\")\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> d = [];</span><br><span class=\"line\">    e.requestAnimationFrame = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">            setTimeout(e, <span class=\"number\">1e3</span> / <span class=\"number\">60</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;(), n()</span><br><span class=\"line\">&#125;(<span class=\"built_in\">window</span>, <span class=\"built_in\">document</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>压缩后</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e,t,a</span>)</span>&#123;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">n</span>(<span class=\"params\"></span>)</span>&#123;c(<span class=\"string\">\".heart&#123;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);&#125;.heart:after,.heart:before&#123;content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;&#125;.heart:after&#123;top: -5px;&#125;.heart:before&#123;left: -5px;&#125;\"</span>),o(),r()&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">r</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> e=<span class=\"number\">0</span>;e&lt;d.length;e++)d[e].alpha&lt;=<span class=\"number\">0</span>?(t.body.removeChild(d[e].el),d.splice(e,<span class=\"number\">1</span>)):(d[e].y--,d[e].scale+=<span class=\"number\">.004</span>,d[e].alpha-=<span class=\"number\">.013</span>,d[e].el.style.cssText=<span class=\"string\">\"left:\"</span>+d[e].x+<span class=\"string\">\"px;top:\"</span>+d[e].y+<span class=\"string\">\"px;opacity:\"</span>+d[e].alpha+<span class=\"string\">\";transform:scale(\"</span>+d[e].scale+<span class=\"string\">\",\"</span>+d[e].scale+<span class=\"string\">\") rotate(45deg);background:\"</span>+d[e].color+<span class=\"string\">\";z-index:99999\"</span>);requestAnimationFrame(r)&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">o</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">var</span> t=<span class=\"string\">\"function\"</span>==<span class=\"keyword\">typeof</span> e.onclick&amp;&amp;e.onclick;e.onclick=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;t&amp;&amp;t(),i(e)&#125;&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">i</span>(<span class=\"params\">e</span>)</span>&#123;<span class=\"keyword\">var</span> a=t.createElement(<span class=\"string\">\"div\"</span>);a.className=<span class=\"string\">\"heart\"</span>,d.push(&#123;<span class=\"attr\">el</span>:a,<span class=\"attr\">x</span>:e.clientX<span class=\"number\">-5</span>,<span class=\"attr\">y</span>:e.clientY<span class=\"number\">-5</span>,<span class=\"attr\">scale</span>:<span class=\"number\">1</span>,<span class=\"attr\">alpha</span>:<span class=\"number\">1</span>,<span class=\"attr\">color</span>:s()&#125;),t.body.appendChild(a)&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">c</span>(<span class=\"params\">e</span>)</span>&#123;<span class=\"keyword\">var</span> a=t.createElement(<span class=\"string\">\"style\"</span>);a.type=<span class=\"string\">\"text/css\"</span>;<span class=\"keyword\">try</span>&#123;a.appendChild(t.createTextNode(e))&#125;<span class=\"keyword\">catch</span>(t)&#123;a.styleSheet.cssText=e&#125;t.getElementsByTagName(<span class=\"string\">\"head\"</span>)[<span class=\"number\">0</span>].appendChild(a)&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">s</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">return</span><span class=\"string\">\"rgb(\"</span>+~~(<span class=\"number\">255</span>*<span class=\"built_in\">Math</span>.random())+<span class=\"string\">\",\"</span>+~~(<span class=\"number\">255</span>*<span class=\"built_in\">Math</span>.random())+<span class=\"string\">\",\"</span>+~~(<span class=\"number\">255</span>*<span class=\"built_in\">Math</span>.random())+<span class=\"string\">\")\"</span>&#125;<span class=\"keyword\">var</span> d=[];e.requestAnimationFrame=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">return</span> e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;setTimeout(e,<span class=\"number\">1e3</span>/<span class=\"number\">60</span>)&#125;&#125;(),n()&#125;(<span class=\"built_in\">window</span>,<span class=\"built_in\">document</span>);</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"将上面的内容贴到新增的themes-nextv6-source-js-src-love-js-文件中\"><a href=\"#将上面的内容贴到新增的themes-nextv6-source-js-src-love-js-文件中\" class=\"headerlink\" title=\"将上面的内容贴到新增的themes/nextv6/source/js/src/love.js 文件中\"></a>将上面的内容贴到新增的themes/nextv6/source/js/src/love.js 文件中</h4><h4 id=\"修改themes-nextv6-layout-layout-swig文件-末尾添加如下内容\"><a href=\"#修改themes-nextv6-layout-layout-swig文件-末尾添加如下内容\" class=\"headerlink\" title=\"修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容\"></a>修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 鼠标桃心动画 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js/src/love.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hexo6-鼠标移动添加星星特效\"><a href=\"#hexo6-鼠标移动添加星星特效\" class=\"headerlink\" title=\"hexo6 鼠标移动添加星星特效\"></a>hexo6 鼠标移动添加星星特效</h3><p>来自: <a href=\"https://blog.csdn.net/a201577F0546/article/details/89060017\" target=\"_blank\" rel=\"noopener\">愚人节鼠标跟随特效</a></p>\n<h4 id=\"新增js文件-themes-nextv6-source-js-src-love2-js\"><a href=\"#新增js文件-themes-nextv6-source-js-src-love2-js\" class=\"headerlink\" title=\"新增js文件 themes/nextv6/source/js/src/love2.js\"></a>新增js文件 themes/nextv6/source/js/src/love2.js</h4><figure class=\"highlight qml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*!</span></span><br><span class=\"line\"><span class=\"comment\"> * Fairy Dust Cursor.js</span></span><br><span class=\"line\"><span class=\"comment\"> * - 90's cursors collection</span></span><br><span class=\"line\"><span class=\"comment\"> * -- https://github.com/tholman/90s-cursor-effects</span></span><br><span class=\"line\"><span class=\"comment\"> * -- http://codepen.io/tholman/full/jWmZxZ/</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fairyDustCursor</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> possibleColors = [<span class=\"string\">\"#D61C59\"</span>, <span class=\"string\">\"#E7D84B\"</span>, <span class=\"string\">\"#1B8798\"</span>]</span><br><span class=\"line\">  <span class=\"keyword\">var</span> width = <span class=\"built_in\">window</span>.innerWidth;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> height = <span class=\"built_in\">window</span>.innerHeight;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> cursor = &#123;<span class=\"attribute\">x</span>: width/<span class=\"number\">2</span>, <span class=\"attribute\">y</span>: width/<span class=\"number\">2</span>&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> particles = [];</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">init</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    bindEvents();</span><br><span class=\"line\">    loop();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// Bind events that are needed</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">bindEvents</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'mousemove'</span>, onMouseMove);</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'touchmove'</span>, onTouchMove);</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'touchstart'</span>, onTouchMove);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'resize'</span>, onWindowResize);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onWindowResize</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">    width = <span class=\"built_in\">window</span>.innerWidth;</span><br><span class=\"line\">    height = <span class=\"built_in\">window</span>.innerHeight;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onTouchMove</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( e.touches.length &gt; <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>( <span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; e.touches.length; i++ ) &#123;</span><br><span class=\"line\">        addParticle( e.touches[i].clientX, e.touches[i].clientY, possibleColors[<span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random()*possibleColors.length)]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onMouseMove</span>(<span class=\"params\">e</span>) </span>&#123;    </span><br><span class=\"line\">    cursor.x = e.clientX;</span><br><span class=\"line\">    cursor.y = e.clientY;</span><br><span class=\"line\">    </span><br><span class=\"line\">    addParticle( cursor.x, cursor.y, possibleColors[<span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random()*possibleColors.length)]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addParticle</span>(<span class=\"params\">x, y, color</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> particle = <span class=\"keyword\">new</span> Particle();</span><br><span class=\"line\">    particle.init(x, y, <span class=\"built_in\">color</span>);</span><br><span class=\"line\">    particles.push(particle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">updateParticles</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Updated</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>( <span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; particles.length; i++ ) &#123;</span><br><span class=\"line\">      particles[i].update();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Remove dead particles</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>( <span class=\"keyword\">var</span> i = particles.length <span class=\"number\">-1</span>; i &gt;= <span class=\"number\">0</span>; i-- ) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( particles[i].lifeSpan &lt; <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">        particles[i].die();</span><br><span class=\"line\">        particles.splice(i, <span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">loop</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    requestAnimationFrame(loop);</span><br><span class=\"line\">    updateParticles();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Particles</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Particle</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.character = <span class=\"string\">\"*\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifeSpan = <span class=\"number\">120</span>; <span class=\"comment\">//ms</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.initialStyles =&#123;</span><br><span class=\"line\">      <span class=\"string\">\"position\"</span>: <span class=\"string\">\"fixed\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"top\"</span>: <span class=\"string\">\"0\"</span>, <span class=\"comment\">//必须加</span></span><br><span class=\"line\">      <span class=\"string\">\"display\"</span>: <span class=\"string\">\"block\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"pointerEvents\"</span>: <span class=\"string\">\"none\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"z-index\"</span>: <span class=\"string\">\"10000000\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"fontSize\"</span>: <span class=\"string\">\"20px\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"will-change\"</span>: <span class=\"string\">\"transform\"</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Init, and set properties</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.init = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">x, y, color</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.velocity = &#123;</span><br><span class=\"line\">        <span class=\"attribute\">x</span>:  (<span class=\"built_in\">Math</span>.random() &lt; <span class=\"number\">0.5</span> ? <span class=\"number\">-1</span> : <span class=\"number\">1</span>) * (<span class=\"built_in\">Math</span>.random() / <span class=\"number\">2</span>),</span><br><span class=\"line\">        <span class=\"attribute\">y</span>: <span class=\"number\">1</span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"keyword\">this</span>.position = &#123;<span class=\"attribute\">x</span>: x - <span class=\"number\">10</span>, <span class=\"attribute\">y</span>: y - <span class=\"number\">20</span>&#125;;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.initialStyles.color = <span class=\"built_in\">color</span>;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"built_in\">color</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.element = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'span'</span>);</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.element.innerHTML = <span class=\"keyword\">this</span>.character;</span><br><span class=\"line\">      applyProperties(<span class=\"keyword\">this</span>.element, <span class=\"keyword\">this</span>.initialStyles);</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.update();</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"built_in\">document</span>.body.appendChild(<span class=\"keyword\">this</span>.element);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.update = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.position.x += <span class=\"keyword\">this</span>.velocity.x;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.position.y += <span class=\"keyword\">this</span>.velocity.y;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.lifeSpan--;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"keyword\">this</span>.element.style.transform = <span class=\"string\">\"translate3d(\"</span> + <span class=\"keyword\">this</span>.position.x + <span class=\"string\">\"px,\"</span> + <span class=\"keyword\">this</span>.position.y + <span class=\"string\">\"px,0) scale(\"</span> + (<span class=\"keyword\">this</span>.lifeSpan / <span class=\"number\">120</span>) + <span class=\"string\">\")\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.die = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.element.parentNode.removeChild(<span class=\"keyword\">this</span>.element);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Utils</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// Applies css `properties` to an element.</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">applyProperties</span>(<span class=\"params\"> target, properties </span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>( <span class=\"keyword\">var</span> key <span class=\"keyword\">in</span> properties ) &#123;</span><br><span class=\"line\">      target.style[ key ] = properties[ key ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  init();</span><br><span class=\"line\">&#125;)();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改themes-nextv6-layout-layout-swig文件-末尾添加如下内容-1\"><a href=\"#修改themes-nextv6-layout-layout-swig文件-末尾添加如下内容-1\" class=\"headerlink\" title=\"修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容\"></a>修改themes/nextv6/layout/_layout.swig文件, 末尾添加如下内容</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 鼠标移动星星特效 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js/src/love2.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/24/4-hexo鼠标移动和鼠标点击特效/","categories":[{"name":"有趣","slug":"有趣","permalink":"https://blog.k1s.club/categories/有趣/"},{"name":"博客","slug":"博客","permalink":"https://blog.k1s.club/categories/博客/"},{"name":"美化","slug":"博客/美化","permalink":"https://blog.k1s.club/categories/博客/美化/"}],"tags":[{"name":"hexo6","slug":"hexo6","permalink":"https://blog.k1s.club/tags/hexo6/"},{"name":"特效","slug":"特效","permalink":"https://blog.k1s.club/tags/特效/"}]},{"title":"k8s遇到的一些问题统计总结","date":"2019-09-20T01:20:39.000Z","path":"2019/09/20/3-k8s遇到的一些问题统计总结/","text":"不定时更新,文章可能比较散乱,&gt;_&lt; 1. 单机版k8s pod一直是pending的问题 describe一下pod会发现错误: 1 node(s) had taints that the pod didnt tolerate.这是因为master上存在污点,pod不会再改节点上创建两种办法: deploy 的时候加上 容忍该污点 直接取消master上的污点 12345# 取消master上污点 kubectl taint nodes --all node-role.kubernetes.io/master-# 查看taintkubectl describe node node1 2. 修改service-node-port-range 由于traefik部署需要对外开放80端口, 但默认仅允许30000以上端口 123456789# kubeadm 1.14 配置apiServer: extraArgs: authorization-mode: Node,RBAC service-node-port-range: 79-33000# kubeadm 1.10配置apiServerExtraArgs: service-node-port-range: 79-33000 3. traefik断电后重新启动报错 command traefik error: field not found, node: redirect12345看到这个错误猜测可能是用的latest镜像问题, 从hub.docker.com 查看更新了v2.0+的版本将traefik的deployment配置中 image改成 traefik:1.7重新部署后 问题解 4. 查看当前集群的(CustomResourceDefinition)12345678# 查看k8s有哪些apikubectl api-versions# 查看当前crdkubectl get crd# 其次查看该api是什么版本kubectl describe crd destinationrules.networking.istio.io 5. 启用自动轮换kubelet 证书(证书未过期)参考: Kubeadm证书过期时间调整 kubelet证书分为server和client两种， k8s 1.9默认启用了client证书的自动轮换，但server证书自动轮换需要用户开启 增加 kubelet 参数 123# 在/etc/systemd/system/kubelet.service.d/10-kubeadm.conf 增加如下参数Environment=\"KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true\" 增加 controller-manager 参数 123456# 在/etc/kubernetes/manifests/kube-controller-manager.yaml 添加如下参数 - command: - kube-controller-manager - --experimental-cluster-signing-duration=87600h0m0s - --feature-gates=RotateKubeletServerCertificate=true - .... 创建 rbac 对象创建 rbac对象，允许节点轮换kubelet server证书： 1234567891011121314151617181920212223242526272829303132cat &gt; ca-update.yaml &lt;&lt; EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserverrules:- apiGroups: - certificates.k8s.io resources: - certificatesigningrequests/selfnodeserver verbs: - create---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: kubeadm:node-autoapprove-certificate-serverroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserversubjects:- apiGroup: rbac.authorization.k8s.io kind: Group name: system:nodesEOFkubectl create –f ca-update.yaml 重新启动kubelet 123systemctl daemon-reloadsystemctl enable kubeletsystemctl restart kubelet 6. hpa的一个cpu-percent百分比问题1kubectl autoscale deployment php-admintest-nginx-dev --cpu-percent=80 --min=1 --max=2 -n php-dev 例如以上,我希望在平均cpu超过80%时,pod能自动调整为2个 em…这没啥问题 但我做简单ab压测发现, 我把cpu压到了100000% … 我的deployment 配置中是这样限制cpu的 12345resources: requests: cpu: \"1m\" limits: cpu: \"1000m\" 显然我的pod可以使用1个核cpu, 那这个平均cpu是等于啥呢? cpu-percent = 1000m/resources.request.cpu =&gt; 1000m/1m =100000% -_-!!! 稍微解释下,为啥我要设置request.cpu=1m:比如单机4核k8s,我启动了1个pod,limit是4cpu,那么我request.cpu其实默认也是1, 所以集群就已经预留了4cpu, 此时如果在启动pod, 在配置limit的时候就无法成功启动pod,因为核心不够了,都给那什么玩意了…(当然这样改动也的确会出现过度分配) 因此建议 修改requests.cpu=500m, –cpu-percent可设范围: 0200% ,或者低一些 250m -&gt; 0400% 总结:request.cpu 必须设置, 这个是对比的对象 另外:对于扩容而言，这个时间段为3分钟，缩容为5分钟(可以通过 –horizontal-pod-autoscaler-downscale-delay ， –horizontal-pod-autoscaler-upscale-delay 进行调整)。 7 k8s1.16.2+metrics v0.3.5 deployment重启之后hpa就失效,无法获取到数据1The HPA was unable to compute the replica count: unable to get metrics for resource cpu: no metrics returned from resource metrics API 8 k8s机器进程数达到500多的时候, ssh连接到服务报错 shell request failed on channel 0123456789原因：目标主机的系统进程数太小，导致不能连接解决：需要修改/etc/security/limits.d/20-nproc.conf文件中的值，把4096改大一点，如 65535#cat /etc/security/limits.d/20-nproc.conf* soft nproc 4096root soft nproc unlimited重新ssh，即可。","raw":"---\ntitle: k8s遇到的一些问题统计总结\ndate: 2019-09-20 09:20:39\ncopyright: true\ntags:\n  - k8s\ncategories:\n  - [技术文档]\n  - [k8s,问题总结]\ntop: 10\n---\n\n 不定时更新,文章可能比较散乱,>_<\n\n<!-- more -->\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 1. 单机版k8s pod一直是pending的问题\n> describe一下pod会发现错误: 1 node(s) had taints that the pod didnt tolerate.\n> 这是因为master上存在污点,pod不会再改节点上创建\n> 两种办法:\n\n\n- deploy 的时候加上 容忍该污点\n- 直接取消master上的污点 \n\n```\n# 取消master上污点\n  kubectl taint nodes --all node-role.kubernetes.io/master-\n\n# 查看taint\nkubectl describe node node1\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 2. 修改service-node-port-range\n\n> 由于traefik部署需要对外开放80端口, 但默认仅允许30000以上端口\n\n```\n# kubeadm 1.14 配置\napiServer:\n  extraArgs:\n    authorization-mode: Node,RBAC\n    service-node-port-range: 79-33000\n\n# kubeadm 1.10配置\napiServerExtraArgs:\n  service-node-port-range: 79-33000\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 3. traefik断电后重新启动报错 command traefik error: field not found, node: redirect\n\n```\n看到这个错误猜测可能是用的latest镜像问题, 从hub.docker.com 查看更新了v2.0+的版本\n\n将traefik的deployment配置中 image改成 traefik:1.7\n\n重新部署后 问题解\n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 4. 查看当前集群的(CustomResourceDefinition)\n```\n# 查看k8s有哪些api\nkubectl api-versions\n\n# 查看当前crd\nkubectl get crd\n\n# 其次查看该api是什么版本\nkubectl describe crd destinationrules.networking.istio.io\n\n```\n\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 5. 启用自动轮换kubelet 证书(证书未过期)\n\n参考: [Kubeadm证书过期时间调整](https://www.cnblogs.com/skymyyang/p/11093686.html)\n\nkubelet证书分为server和client两种， k8s 1.9默认启用了client证书的自动轮换，但server证书自动轮换需要用户开启\n\n增加 kubelet 参数\n```\n# 在/etc/systemd/system/kubelet.service.d/10-kubeadm.conf 增加如下参数\n\nEnvironment=\"KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true\"\n```\n\n增加 controller-manager 参数\n```\n# 在/etc/kubernetes/manifests/kube-controller-manager.yaml 添加如下参数\n  - command:\n    - kube-controller-manager\n    - --experimental-cluster-signing-duration=87600h0m0s\n    - --feature-gates=RotateKubeletServerCertificate=true\n    - ....\n```\n\n创建 rbac 对象\n创建 rbac对象，允许节点轮换kubelet server证书：\n```\ncat > ca-update.yaml << EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver\nrules:\n- apiGroups:\n  - certificates.k8s.io\n  resources:\n  - certificatesigningrequests/selfnodeserver\n  verbs:\n  - create\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kubeadm:node-autoapprove-certificate-server\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\n  kind: Group\n  name: system:nodes\nEOF\n\nkubectl create –f ca-update.yaml\n```\n\n重新启动kubelet\n```\nsystemctl daemon-reload\nsystemctl enable kubelet\nsystemctl restart kubelet\n```\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 6. hpa的一个cpu-percent百分比问题\n```\nkubectl autoscale deployment php-admintest-nginx-dev --cpu-percent=80 --min=1 --max=2 -n php-dev\n```\n例如以上,我希望在平均cpu超过80%时,pod能自动调整为2个\n\nem...这没啥问题\n\n但我做简单ab压测发现, 我把cpu压到了100000% ...\n\n我的deployment 配置中是这样限制cpu的\n```\n        resources:\n          requests:\n            cpu: \"1m\"\n          limits:\n            cpu: \"1000m\"\n```\n\n显然我的pod可以使用1个核cpu, 那这个平均cpu是等于啥呢?\n\ncpu-percent = 1000m/resources.request.cpu => 1000m/1m =100000%\n\n-_-!!!\n\n稍微解释下,为啥我要设置request.cpu=1m:\n比如单机4核k8s,我启动了1个pod,limit是4cpu,那么我request.cpu其实默认也是1, 所以集群就已经预留了4cpu, 此时如果在启动pod, 在配置limit的时候就无法成功启动pod,因为核心不够了,都给那什么玩意了...(当然这样改动也的确会出现过度分配)\n\n> 因此建议 修改requests.cpu=500m,  --cpu-percent可设范围: 0~200% ,或者低一些 250m -> 0~400%\n\n总结:\nrequest.cpu 必须设置, 这个是对比的对象\n\n另外:\n对于扩容而言，这个时间段为3分钟，缩容为5分钟(可以通过 --horizontal-pod-autoscaler-downscale-delay ， --horizontal-pod-autoscaler-upscale-delay 进行调整)。\n\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 7 k8s1.16.2+metrics v0.3.5 deployment重启之后hpa就失效,无法获取到数据\n\n```\nThe HPA was unable to compute the replica count: unable to get metrics for resource cpu: no metrics returned from resource metrics API \n```\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width = \"100\" height = \"100\" style=\"border: 0\"/>\n</center>\n\n### 8 k8s机器进程数达到500多的时候, ssh连接到服务报错 shell request failed on channel 0\n```\n原因：目标主机的系统进程数太小，导致不能连接\n\n解决：需要修改/etc/security/limits.d/20-nproc.conf文件中的值，把4096改大一点，如 65535\n\n#cat /etc/security/limits.d/20-nproc.conf\n*          soft    nproc     4096\nroot       soft    nproc     unlimited\n\n重新ssh，即可。\n\n```\n","content":"<p> 不定时更新,文章可能比较散乱,&gt;_&lt;</p>\n<a id=\"more\"></a>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"1-单机版k8s-pod一直是pending的问题\"><a href=\"#1-单机版k8s-pod一直是pending的问题\" class=\"headerlink\" title=\"1. 单机版k8s pod一直是pending的问题\"></a>1. 单机版k8s pod一直是pending的问题</h3><blockquote>\n<p>describe一下pod会发现错误: 1 node(s) had taints that the pod didnt tolerate.<br>这是因为master上存在污点,pod不会再改节点上创建<br>两种办法:</p>\n</blockquote>\n<ul>\n<li>deploy 的时候加上 容忍该污点</li>\n<li>直接取消master上的污点 </li>\n</ul>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 取消master上污点</span></span><br><span class=\"line\">  kubectl taint nodes --all <span class=\"keyword\">node</span><span class=\"title\">-role</span>.kubernetes.io/<span class=\"literal\">master</span>-</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看taint</span></span><br><span class=\"line\">kubectl describe <span class=\"keyword\">node</span> <span class=\"title\">node1</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"2-修改service-node-port-range\"><a href=\"#2-修改service-node-port-range\" class=\"headerlink\" title=\"2. 修改service-node-port-range\"></a>2. 修改service-node-port-range</h3><blockquote>\n<p>由于traefik部署需要对外开放80端口, 但默认仅允许30000以上端口</p>\n</blockquote>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubeadm 1.14 配置</span></span><br><span class=\"line\">apiServer:</span><br><span class=\"line\">  extraArgs:</span><br><span class=\"line\">    authorization-mode: <span class=\"keyword\">Node</span><span class=\"title\">,RBAC</span></span><br><span class=\"line\">    service-<span class=\"keyword\">node</span>-port-range:<span class=\"title\"> 79-33000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubeadm 1.10配置</span></span><br><span class=\"line\">apiServerExtraArgs:</span><br><span class=\"line\">  service-<span class=\"keyword\">node</span>-port-range:<span class=\"title\"> 79-33000</span></span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"3-traefik断电后重新启动报错-command-traefik-error-field-not-found-node-redirect\"><a href=\"#3-traefik断电后重新启动报错-command-traefik-error-field-not-found-node-redirect\" class=\"headerlink\" title=\"3. traefik断电后重新启动报错 command traefik error: field not found, node: redirect\"></a>3. traefik断电后重新启动报错 command traefik error: field not found, node: redirect</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">看到这个错误猜测可能是用的<span class=\"selector-tag\">latest</span>镜像问题, 从<span class=\"selector-tag\">hub</span><span class=\"selector-class\">.docker</span><span class=\"selector-class\">.com</span> 查看更新了<span class=\"selector-tag\">v2</span><span class=\"selector-class\">.0</span>+的版本</span><br><span class=\"line\"></span><br><span class=\"line\">将<span class=\"selector-tag\">traefik</span>的<span class=\"selector-tag\">deployment</span>配置中 <span class=\"selector-tag\">image</span>改成 <span class=\"selector-tag\">traefik</span><span class=\"selector-pseudo\">:1.7</span></span><br><span class=\"line\"></span><br><span class=\"line\">重新部署后 问题解</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"4-查看当前集群的-CustomResourceDefinition\"><a href=\"#4-查看当前集群的-CustomResourceDefinition\" class=\"headerlink\" title=\"4. 查看当前集群的(CustomResourceDefinition)\"></a>4. 查看当前集群的(CustomResourceDefinition)</h3><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看k8s有哪些api</span></span><br><span class=\"line\">kubectl api-versions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看当前crd</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">get</span> crd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 其次查看该api是什么版本</span></span><br><span class=\"line\">kubectl describe crd destinationrules.networking.istio.io</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"5-启用自动轮换kubelet-证书-证书未过期\"><a href=\"#5-启用自动轮换kubelet-证书-证书未过期\" class=\"headerlink\" title=\"5. 启用自动轮换kubelet 证书(证书未过期)\"></a>5. 启用自动轮换kubelet 证书(证书未过期)</h3><p>参考: <a href=\"https://www.cnblogs.com/skymyyang/p/11093686.html\" target=\"_blank\" rel=\"noopener\">Kubeadm证书过期时间调整</a></p>\n<p>kubelet证书分为server和client两种， k8s 1.9默认启用了client证书的自动轮换，但server证书自动轮换需要用户开启</p>\n<p>增加 kubelet 参数</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在/etc/systemd/system/kubelet.service.d/10-kubeadm.conf 增加如下参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">\"KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true\"</span></span><br></pre></td></tr></table></figure>\n\n<p>增加 controller-manager 参数</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在/etc/kubernetes/manifests/kube-controller-manager.yaml 添加如下参数</span></span><br><span class=\"line\">  - command:</span><br><span class=\"line\">    - kube-controller-manager</span><br><span class=\"line\">    - <span class=\"attribute\">--experimental-cluster-signing-duration</span>=87600h0m0s</span><br><span class=\"line\">    - <span class=\"attribute\">--feature-gates</span>=RotateKubeletServerCertificate=true</span><br><span class=\"line\">    - <span class=\"built_in\">..</span><span class=\"built_in\">..</span></span><br></pre></td></tr></table></figure>\n\n<p>创建 rbac 对象<br>创建 rbac对象，允许节点轮换kubelet server证书：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ca-update.yaml &lt;&lt; EOF</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">rbac.authorization.kubernetes.io/autoupdate:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\">    <span class=\"string\">kubernetes.io/bootstrapping:</span> <span class=\"string\">rbac-defaults</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"attr\">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"attr\">- apiGroups:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">certificates.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  resources:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">certificatesigningrequests/selfnodeserver</span></span><br><span class=\"line\"><span class=\"attr\">  verbs:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">create</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"attr\">kubeadm:node-autoapprove-certificate-server</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\">  apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"attr\">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\">- apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">  kind:</span> <span class=\"string\">Group</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"attr\">system:nodes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">–f</span> <span class=\"string\">ca-update.yaml</span></span><br></pre></td></tr></table></figure>\n\n<p>重新启动kubelet</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"builtin-name\">enable</span> kubelet</span><br><span class=\"line\">systemctl restart kubelet</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"6-hpa的一个cpu-percent百分比问题\"><a href=\"#6-hpa的一个cpu-percent百分比问题\" class=\"headerlink\" title=\"6. hpa的一个cpu-percent百分比问题\"></a>6. hpa的一个cpu-percent百分比问题</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl autoscale deployment php-admintest-nginx-dev <span class=\"attribute\">--cpu-percent</span>=80 <span class=\"attribute\">--min</span>=1 <span class=\"attribute\">--max</span>=2 -n php-dev</span><br></pre></td></tr></table></figure>\n\n<p>例如以上,我希望在平均cpu超过80%时,pod能自动调整为2个</p>\n<p>em…这没啥问题</p>\n<p>但我做简单ab压测发现, 我把cpu压到了100000% …</p>\n<p>我的deployment 配置中是这样限制cpu的</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">resources:</span></span><br><span class=\"line\"><span class=\"symbol\">  requests:</span></span><br><span class=\"line\"><span class=\"symbol\">    cpu:</span> <span class=\"string\">\"1m\"</span></span><br><span class=\"line\"><span class=\"symbol\">  limits:</span></span><br><span class=\"line\"><span class=\"symbol\">    cpu:</span> <span class=\"string\">\"1000m\"</span></span><br></pre></td></tr></table></figure>\n\n<p>显然我的pod可以使用1个核cpu, 那这个平均cpu是等于啥呢?</p>\n<p>cpu-percent = 1000m/resources.request.cpu =&gt; 1000m/1m =100000%</p>\n<p>-_-!!!</p>\n<p>稍微解释下,为啥我要设置request.cpu=1m:<br>比如单机4核k8s,我启动了1个pod,limit是4cpu,那么我request.cpu其实默认也是1, 所以集群就已经预留了4cpu, 此时如果在启动pod, 在配置limit的时候就无法成功启动pod,因为核心不够了,都给那什么玩意了…(当然这样改动也的确会出现过度分配)</p>\n<blockquote>\n<p>因此建议 修改requests.cpu=500m,  –cpu-percent可设范围: 0<del>200% ,或者低一些 250m -&gt; 0</del>400%</p>\n</blockquote>\n<p>总结:<br>request.cpu 必须设置, 这个是对比的对象</p>\n<p>另外:<br>对于扩容而言，这个时间段为3分钟，缩容为5分钟(可以通过 –horizontal-pod-autoscaler-downscale-delay ， –horizontal-pod-autoscaler-upscale-delay 进行调整)。</p>\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"7-k8s1-16-2-metrics-v0-3-5-deployment重启之后hpa就失效-无法获取到数据\"><a href=\"#7-k8s1-16-2-metrics-v0-3-5-deployment重启之后hpa就失效-无法获取到数据\" class=\"headerlink\" title=\"7 k8s1.16.2+metrics v0.3.5 deployment重启之后hpa就失效,无法获取到数据\"></a>7 k8s1.16.2+metrics v0.3.5 deployment重启之后hpa就失效,无法获取到数据</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The HPA was unable <span class=\"keyword\">to</span> compute the replica count: unable <span class=\"keyword\">to</span> <span class=\"builtin-name\">get</span> metrics <span class=\"keyword\">for</span><span class=\"built_in\"> resource </span>cpu: <span class=\"literal\">no</span> metrics returned <span class=\"keyword\">from</span><span class=\"built_in\"> resource </span>metrics API</span><br></pre></td></tr></table></figure>\n\n<center>\n<img src=\"//zhangzw001.github.io/images/dockerniu.jpeg\" width=\"100\" height=\"100\" style=\"border: 0\">\n</center>\n\n<h3 id=\"8-k8s机器进程数达到500多的时候-ssh连接到服务报错-shell-request-failed-on-channel-0\"><a href=\"#8-k8s机器进程数达到500多的时候-ssh连接到服务报错-shell-request-failed-on-channel-0\" class=\"headerlink\" title=\"8 k8s机器进程数达到500多的时候, ssh连接到服务报错 shell request failed on channel 0\"></a>8 k8s机器进程数达到500多的时候, ssh连接到服务报错 shell request failed on channel 0</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">原因：目标主机的系统进程数太小，导致不能连接</span><br><span class=\"line\"></span><br><span class=\"line\">解决：需要修改/etc/security/limits.d/<span class=\"number\">20</span>-nproc.conf文件中的值，把<span class=\"number\">4096</span>改大一点，如 <span class=\"number\">65535</span></span><br><span class=\"line\"></span><br><span class=\"line\">#cat /etc/security/limits.d/<span class=\"number\">20</span>-nproc.conf</span><br><span class=\"line\">*          soft    nproc     <span class=\"number\">4096</span></span><br><span class=\"line\">root       soft    nproc     unlimited</span><br><span class=\"line\"></span><br><span class=\"line\">重新ssh，即可。</span><br></pre></td></tr></table></figure>\n\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/20/3-k8s遇到的一些问题统计总结/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"问题总结","slug":"k8s/问题总结","permalink":"https://blog.k1s.club/categories/k8s/问题总结/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"}]},{"title":"部署elk7.2.0","date":"2019-09-19T09:59:53.000Z","path":"2019/09/19/2-部署elk7-2-0/","text":"说明: 121 单台k8s,本机目录挂载(未配置cephfs)2 如果replicas大于1, 就会出现多个es挂载同一个目录,会出现报错(uuid block) 1. es配置本地挂载 k8s-es-7.2.0.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128---apiVersion: v1kind: ServiceAccountmetadata: labels: app: elasticsearch name: elasticsearch7-admin namespace: ns-elastic7---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: elasticsearch7-admin labels: app: elasticsearchroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects: - kind: ServiceAccount name: elasticsearch7-admin namespace: ns-elastic7---apiVersion: apps/v1kind: StatefulSetmetadata: labels: app: elasticsearch role: master name: elasticsearch-master namespace: ns-elastic7spec: replicas: 1 serviceName: elasticsearch-master selector: matchLabels: app: elasticsearch role: master template: metadata: labels: app: elasticsearch role: master spec: serviceAccountName: elasticsearch7-admin restartPolicy: Always securityContext: fsGroup: 1000 containers: - name: elasticsearch-master image: hub.zhangzw.com/bq/elasticsearch:7.2.0 command: [\"bash\", \"-c\", \"ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh\"] imagePullPolicy: IfNotPresent securityContext: privileged: true ports: - containerPort: 9200 protocol: TCP - containerPort: 9300 protocol: TCP resources: requests: cpu: \"50m\" limits: cpu: \"800m\" env: - name: cluster.name value: \"es_cluster\" - name: node.master value: \"true\" - name: node.data value: \"true\" - name: cluster.initial_master_nodes value: \"elasticsearch-master-0\" # 根据副本数和name配置 - name: discovery.zen.ping_timeout value: \"5s\" - name: node.ingest value: \"false\" - name: ES_JAVA_OPTS value: \"-Xms1g -Xmx1g\" - name: \"discovery.zen.ping.unicast.hosts\" value: \"elasticsearch-discovery\" # Disvocery Service - name: \"http.cors.enabled\" value: \"true\" - name: \"http.cors.allow-origin\" value: \"*\" volumeMounts: - name: elasticsearch-data-volume mountPath: /usr/share/elasticsearch/data volumes: - name: elasticsearch-data-volume hostPath: path: /data/k8s-container/elk-7.2.0/es-7.2.0/data---apiVersion: v1kind: Servicemetadata: labels: app: elasticsearch name: elasticsearch-discovery namespace: ns-elastic7spec: publishNotReadyAddresses: true ports: - name: transport port: 9300 targetPort: 9300 selector: app: elasticsearch role: master---kind: ServiceapiVersion: v1metadata: labels: app: elasticsearch name: elasticsearch-service namespace: ns-elastic7spec: type: NodePort ports: - port: 9200 targetPort: 9200 nodePort: 19230 protocol: TCP selector: app: elasticsearch 2. es配置nfs动态挂载 k8s-es-7.2.0-nfs.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129---apiVersion: v1kind: ServiceAccountmetadata: labels: app: elasticsearch name: elasticsearch-admin namespace: ns-elastic---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: elasticsearch-admin labels: app: elasticsearchroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-adminsubjects: - kind: ServiceAccount name: elasticsearch-admin namespace: ns-elastic---apiVersion: apps/v1kind: StatefulSetmetadata: labels: app: elasticsearch role: master name: elasticsearch-master namespace: ns-elasticspec: replicas: 2 volumeClaimTemplates: - metadata: name: elasticsearch-data-nfs annotations: volume.beta.kubernetes.io/storage-class: \"nfs\" spec: accessModes: [ \"ReadWriteOnce\" ] resources: requests: storage: 2Gi serviceName: elasticsearch-master selector: matchLabels: app: elasticsearch role: master template: metadata: labels: app: elasticsearch role: master spec: serviceAccountName: elasticsearch-admin restartPolicy: Always securityContext: fsGroup: 1000 containers: - name: elasticsearch-master image: elasticsearch:7.2.0 command: [\"bash\", \"-c\", \"ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh\"] imagePullPolicy: IfNotPresent volumeMounts: - name: elasticsearch-data-nfs mountPath: /usr/share/elasticsearch/data securityContext: privileged: true ports: - containerPort: 9200 protocol: TCP - containerPort: 9300 protocol: TCP env: - name: cluster.name value: \"es_cluster\" - name: node.master value: \"true\" - name: node.data value: \"true\" - name: cluster.initial_master_nodes value: \"elasticsearch-master-0,elasticsearch-master-1\" # 根据副本数和name配置 - name: discovery.zen.ping_timeout value: \"5s\" - name: node.ingest value: \"false\" - name: ES_JAVA_OPTS value: \"-Xms1g -Xmx1g\" - name: \"discovery.zen.ping.unicast.hosts\" value: \"elasticsearch-discovery\" # Disvocery Service - name: \"http.cors.enabled\" value: \"true\" - name: \"http.cors.allow-origin\" value: \"*\"---apiVersion: v1kind: Servicemetadata: labels: app: elasticsearch name: elasticsearch-discovery namespace: ns-elasticspec: publishNotReadyAddresses: true ports: - name: transport port: 9300 targetPort: 9300 selector: app: elasticsearch role: master---kind: ServiceapiVersion: v1metadata: labels: app: elasticsearch name: elasticsearch-service namespace: ns-elasticspec: type: NodePort ports: - port: 9200 targetPort: 9200 nodePort: 19220 protocol: TCP selector: app: elasticsearch 3. kibana配置k8s-kibana-7.2.0.yml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485apiVersion: v1kind: ConfigMapmetadata: name: kibana-config namespace: ns-elastic7 labels: elastic-app: kibanadata: kibana.yml: | server.name: kibana server.host: \"0\" elasticsearch.hosts: [ \"http://elasticsearch-service:9200\" ] xpack.monitoring.ui.container.elasticsearch.enabled: true---kind: DeploymentapiVersion: apps/v1beta2metadata: labels: elastic-app: kibana name: kibana namespace: ns-elastic7spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: elastic-app: kibana template: metadata: labels: elastic-app: kibana spec: containers: - name: kibana image: hub.zhangzw.com/bq/kibana:7.2.0 ports: - containerPort: 5601 protocol: TCP resources: requests: cpu: \"50m\" limits: cpu: \"800m\" volumeMounts: - name: kibana-config mountPath: /usr/share/kibana/config volumes: - name: kibana-config configMap: name: kibana-config tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule---kind: ServiceapiVersion: v1metadata: labels: elastic-app: kibana name: kibana-service namespace: ns-elastic7spec: ports: - port: 5601 targetPort: 5601 selector: elastic-app: kibana type: NodePort---apiVersion: extensions/v1beta1kind: Ingressmetadata: labels: elastic-app: kibana name: kibana-ingress namespace: ns-elastic7spec: rules: - host: elk-kibana-dev.zhangzw.com http: paths: - backend: serviceName: kibana-service servicePort: 5601 4. logstash配置 本地挂载 k8s-logstash-7.2.0.yml 4.1 config/pipelines.yml 12- pipeline.id: main path.config: \"/usr/share/logstash/config/pipeline/*.conf\" 4.2 首先配置grok规则 config/pipeline/logstash.conf 12345678910111213141516171819202122input &#123; udp &#123; port =&gt; \"10000\" &#125; &#125; filter &#123; grok &#123; match =&gt; &#123; \"message\" =&gt; \"\\&#123;\\\"id\\\":\\\"(?&lt;id&gt;(.)*)\\\",\\\"tag\\\":\\\"(?&lt;tag&gt;(.)*)\\\",\\\"title\\\":\\\"%&#123;GREEDYDATA:title&#125;(?&lt;title&gt;(.|\\r|\\n)*)\\\",\\\"value\\\":\\\"%&#123;GREEDYDATA:value&#125;(?&lt;value&gt;(.|\\r|\\n)*)\\\",\\\"createdAt\\\":\\\"(?&lt;createdAt&gt;\\S+ \\S+)\\\",\\\"Telephone\\\":\\\"(?&lt;Telephone&gt;(.)*)\\\",\\\"uid\\\":\\\"(?&lt;uid&gt;(.)*)\\\",\\\"updateTime\\\":\\\"(?&lt;updateTime&gt;(.)*)\\\",\\\"appVersion\\\":\\\"(?&lt;appVersion&gt;(.)*)\\\",\\\"mobileModel\\\":\\\"(?&lt;mobileModel&gt;(.)*)\\\",\\\"osVersion\\\":\\\"(?&lt;osVersion&gt;(.)*)\\\",\\\"channel\\\":\\\"(?&lt;channel&gt;(.)*)\\\",\\\"UDID\\\":\\\"(?&lt;UDID&gt;(.)*)\\\"\\&#125;\" &#125; &#125; &#125;output &#123; elasticsearch &#123; hosts =&gt; [ \"http://elasticsearch-service:9200\" ] index =&gt; \"k8s2-dev-%&#123;+YYYY.MM.dd&#125;\" &#125; &#125; 4.3 配置文件 k8s-logstash-7.2.0.yml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455---kind: DeploymentapiVersion: apps/v1beta2metadata: labels: elastic-app: logstash name: logstash namespace: ns-elasticspec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: elastic-app: logstash template: metadata: labels: elastic-app: logstash spec: containers: - name: logstash image: hub.zhangzw.com/bq/logstash:7.2.0 ports: - containerPort: 10000 protocol: UDP volumeMounts: - name: logstash-config mountPath: /usr/share/logstash/config volumes: - name: logstash-config hostPath: path: /data/k8s-pod/elk-7.2.0/logstash-7.2.0/config tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule---kind: ServiceapiVersion: v1metadata: labels: elastic-app: logstash name: logstash-service namespace: ns-elasticspec: type: NodePort ports: - port: 10000 targetPort: 10000 nodePort: 10000 protocol: UDP selector: elastic-app: logstash type: NodePort---","raw":"---\ntitle: 部署elk7.2.0\ndate: 2019-09-19 17:59:53\ncopyright: true\ntags:\n  - k8s\n  - elk\n  - elk7\n  - elasticsearch7\ncategories:\n  - [技术文档]\n  - [k8s,elk7]\n  - [elk,elasticsearch7]\ndescription: \"本文主要是单机版部署elk7, 非高可用部署. 部分安装步骤省略. 主要是记录yml配置文件, 仅供参考. <br>详细内容请点击下方阅读全文, 非常感谢!\"\n---\n\n\n> 说明:\n```\n1 单台k8s,本机目录挂载(未配置cephfs)\n2 如果replicas大于1, 就会出现多个es挂载同一个目录,会出现报错(uuid block)\n```\n\n### 1. es配置本地挂载 k8s-es-7.2.0.yml\n```\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n labels:\n   app: elasticsearch\n name: elasticsearch7-admin\n namespace: ns-elastic7\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n name: elasticsearch7-admin\n labels:\n   app: elasticsearch\nroleRef:\n apiGroup: rbac.authorization.k8s.io\n kind: ClusterRole\n name: cluster-admin\nsubjects:\n - kind: ServiceAccount\n   name: elasticsearch7-admin\n   namespace: ns-elastic7\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: elasticsearch\n    role: master\n  name: elasticsearch-master\n  namespace: ns-elastic7\nspec:\n  replicas: 1\n  serviceName: elasticsearch-master\n  selector:\n    matchLabels:\n      app: elasticsearch\n      role: master\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n        role: master\n    spec:\n      serviceAccountName: elasticsearch7-admin\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n      containers:\n        - name: elasticsearch-master\n          image: hub.zhangzw.com/bq/elasticsearch:7.2.0\n          command: [\"bash\", \"-c\", \"ulimit -l unlimited && sysctl -w vm.max_map_count=262144 && chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data && exec su elasticsearch docker-entrypoint.sh\"]\n          imagePullPolicy: IfNotPresent\n          securityContext:\n            privileged: true\n          ports:\n            - containerPort: 9200\n              protocol: TCP\n            - containerPort: 9300\n              protocol: TCP\n          resources:\n            requests:\n              cpu: \"50m\"\n            limits:\n              cpu: \"800m\"\n          env:\n            - name: cluster.name\n              value: \"es_cluster\"\n            - name: node.master\n              value: \"true\"\n            - name: node.data\n              value: \"true\"\n            - name: cluster.initial_master_nodes\n              value: \"elasticsearch-master-0\" # 根据副本数和name配置\n            - name: discovery.zen.ping_timeout\n              value: \"5s\"\n            - name: node.ingest\n              value: \"false\"\n            - name: ES_JAVA_OPTS\n              value: \"-Xms1g -Xmx1g\"\n            - name: \"discovery.zen.ping.unicast.hosts\"\n              value: \"elasticsearch-discovery\" # Disvocery Service\n            - name: \"http.cors.enabled\"\n              value: \"true\"\n            - name: \"http.cors.allow-origin\"\n              value: \"*\"\n          volumeMounts:\n            - name: elasticsearch-data-volume\n              mountPath: /usr/share/elasticsearch/data\n      volumes:\n        - name: elasticsearch-data-volume\n          hostPath:\n            path: /data/k8s-container/elk-7.2.0/es-7.2.0/data\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: elasticsearch\n  name: elasticsearch-discovery\n  namespace: ns-elastic7\nspec:\n  publishNotReadyAddresses: true\n  ports:\n  - name: transport\n    port: 9300\n    targetPort: 9300\n  selector:\n    app: elasticsearch\n    role: master\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   app: elasticsearch\n name: elasticsearch-service\n namespace: ns-elastic7\nspec:\n type: NodePort\n ports:\n   - port: 9200\n     targetPort: 9200\n     nodePort: 19230\n     protocol: TCP\n selector:\n   app: elasticsearch\n```\n\n### 2. es配置nfs动态挂载 k8s-es-7.2.0-nfs.yml\n```\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n labels:\n   app: elasticsearch\n name: elasticsearch-admin\n namespace: ns-elastic\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n name: elasticsearch-admin\n labels:\n   app: elasticsearch\nroleRef:\n apiGroup: rbac.authorization.k8s.io\n kind: ClusterRole\n name: cluster-admin\nsubjects:\n - kind: ServiceAccount\n   name: elasticsearch-admin\n   namespace: ns-elastic\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: elasticsearch\n    role: master\n  name: elasticsearch-master\n  namespace: ns-elastic\nspec:\n  replicas: 2\n  volumeClaimTemplates:\n  - metadata:\n      name: elasticsearch-data-nfs\n      annotations:\n        volume.beta.kubernetes.io/storage-class: \"nfs\"\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 2Gi\n  serviceName: elasticsearch-master\n  selector:\n    matchLabels:\n      app: elasticsearch\n      role: master\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n        role: master\n    spec:\n      serviceAccountName: elasticsearch-admin\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n      containers:\n        - name: elasticsearch-master\n          image: elasticsearch:7.2.0\n          command: [\"bash\", \"-c\", \"ulimit -l unlimited && sysctl -w vm.max_map_count=262144 && chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data && exec su elasticsearch docker-entrypoint.sh\"]\n          imagePullPolicy: IfNotPresent\n          volumeMounts:\n          - name: elasticsearch-data-nfs\n            mountPath: /usr/share/elasticsearch/data\n          securityContext:\n            privileged: true\n          ports:\n            - containerPort: 9200\n              protocol: TCP\n            - containerPort: 9300\n              protocol: TCP\n          env:\n            - name: cluster.name\n              value: \"es_cluster\"\n            - name: node.master\n              value: \"true\"\n            - name: node.data\n              value: \"true\"\n            - name: cluster.initial_master_nodes\n              value: \"elasticsearch-master-0,elasticsearch-master-1\" # 根据副本数和name配置\n            - name: discovery.zen.ping_timeout\n              value: \"5s\"\n            - name: node.ingest\n              value: \"false\"\n            - name: ES_JAVA_OPTS\n              value: \"-Xms1g -Xmx1g\"\n            - name: \"discovery.zen.ping.unicast.hosts\"\n              value: \"elasticsearch-discovery\" # Disvocery Service\n            - name: \"http.cors.enabled\"\n              value: \"true\"\n            - name: \"http.cors.allow-origin\"\n              value: \"*\"\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: elasticsearch\n  name: elasticsearch-discovery\n  namespace: ns-elastic\nspec:\n  publishNotReadyAddresses: true\n  ports:\n  - name: transport\n    port: 9300\n    targetPort: 9300\n  selector:\n    app: elasticsearch\n    role: master\n---\nkind: Service\napiVersion: v1\nmetadata:\n labels:\n   app: elasticsearch\n name: elasticsearch-service\n namespace: ns-elastic\nspec:\n type: NodePort\n ports:\n   - port: 9200\n     targetPort: 9200\n     nodePort: 19220\n     protocol: TCP\n selector:\n   app: elasticsearch\n```\n\n\n### 3. kibana配置k8s-kibana-7.2.0.yml\n```\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: kibana-config\n  namespace: ns-elastic7\n  labels:\n    elastic-app: kibana\ndata:\n  kibana.yml: |\n    server.name: kibana\n    server.host: \"0\"\n    elasticsearch.hosts: [ \"http://elasticsearch-service:9200\" ]\n    xpack.monitoring.ui.container.elasticsearch.enabled: true\n---\nkind: Deployment\napiVersion: apps/v1beta2\nmetadata:\n  labels:\n    elastic-app: kibana\n  name: kibana\n  namespace: ns-elastic7\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      elastic-app: kibana\n  template:\n    metadata:\n      labels:\n        elastic-app: kibana\n    spec:\n      containers:\n        - name: kibana\n          image: hub.zhangzw.com/bq/kibana:7.2.0\n          ports:\n            - containerPort: 5601\n              protocol: TCP\n          resources:\n            requests:\n              cpu: \"50m\"\n            limits:\n              cpu: \"800m\"\n          volumeMounts:\n            - name: kibana-config\n              mountPath: /usr/share/kibana/config\n      volumes:\n        - name: kibana-config\n          configMap:\n            name: kibana-config\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    elastic-app: kibana\n  name: kibana-service\n  namespace: ns-elastic7\nspec:\n  ports:\n    - port: 5601\n      targetPort: 5601\n  selector:\n    elastic-app: kibana\n  type: NodePort\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n labels:\n   elastic-app: kibana\n name: kibana-ingress\n namespace: ns-elastic7\nspec:\n rules:\n   - host: elk-kibana-dev.zhangzw.com\n     http:\n       paths:\n         - backend:\n             serviceName: kibana-service\n             servicePort: 5601\n```\n\n### 4. logstash配置 本地挂载 k8s-logstash-7.2.0.yml\n- 4.1 config/pipelines.yml\n```\n- pipeline.id: main\n  path.config: \"/usr/share/logstash/config/pipeline/*.conf\"\n```\n\n- 4.2 首先配置grok规则 config/pipeline/logstash.conf\n```\ninput {\n    udp {\n        port => \"10000\"\n        }\n    }\n\n filter {\n      grok {\n          match => {\n            \"message\" => \"\\{\\\"id\\\":\\\"(?<id>(.)*)\\\",\\\"tag\\\":\\\"(?<tag>(.)*)\\\",\\\"title\\\":\\\"%{GREEDYDATA:title}(?<title>(.|\\r|\\n)*)\\\",\\\"value\\\":\\\"%{GREEDYDATA:value}(?<value>(.|\\r|\\n)*)\\\",\\\"createdAt\\\":\\\"(?<createdAt>\\S+ \\S+)\\\",\\\"Telephone\\\":\\\"(?<Telephone>(.)*)\\\",\\\"uid\\\":\\\"(?<uid>(.)*)\\\",\\\"updateTime\\\":\\\"(?<updateTime>(.)*)\\\",\\\"appVersion\\\":\\\"(?<appVersion>(.)*)\\\",\\\"mobileModel\\\":\\\"(?<mobileModel>(.)*)\\\",\\\"osVersion\\\":\\\"(?<osVersion>(.)*)\\\",\\\"channel\\\":\\\"(?<channel>(.)*)\\\",\\\"UDID\\\":\\\"(?<UDID>(.)*)\\\"\\}\"\n              }\n            }\n }\n\noutput {\n    elasticsearch {\n        hosts =>  [ \"http://elasticsearch-service:9200\" ]\n        index => \"k8s2-dev-%{+YYYY.MM.dd}\"\n\n        }\n\n    }\n```\n\n- 4.3 配置文件 k8s-logstash-7.2.0.yml\n```\n---\nkind: Deployment\napiVersion: apps/v1beta2\nmetadata:\n  labels:\n    elastic-app: logstash\n  name: logstash\n  namespace: ns-elastic\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      elastic-app: logstash\n  template:\n    metadata:\n      labels:\n        elastic-app: logstash\n    spec:\n      containers:\n        - name: logstash\n          image: hub.zhangzw.com/bq/logstash:7.2.0\n          ports:\n            - containerPort: 10000\n              protocol: UDP\n          volumeMounts:\n            - name: logstash-config\n              mountPath: /usr/share/logstash/config\n      volumes:\n        - name: logstash-config\n          hostPath:\n            path: /data/k8s-pod/elk-7.2.0/logstash-7.2.0/config\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    elastic-app: logstash\n  name: logstash-service\n  namespace: ns-elastic\nspec:\n  type: NodePort\n  ports:\n    - port: 10000\n      targetPort: 10000\n      nodePort: 10000\n      protocol: UDP\n  selector:\n    elastic-app: logstash\n  type: NodePort\n---\n```\n","content":"<blockquote>\n<p>说明:</p>\n</blockquote>\n<figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">1 </span>单台k8s,本机目录挂载(未配置cephfs)</span><br><span class=\"line\"><span class=\"symbol\">2 </span>如果replicas大于<span class=\"number\">1</span>, 就会出现多个es挂载同一个目录,会出现报错(uuid block)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"1-es配置本地挂载-k8s-es-7-2-0-yml\"><a href=\"#1-es配置本地挂载-k8s-es-7-2-0-yml\" class=\"headerlink\" title=\"1. es配置本地挂载 k8s-es-7.2.0.yml\"></a>1. es配置本地挂载 k8s-es-7.2.0.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch7-admin</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch7-admin</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\"> apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\"> kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">cluster-admin</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\"> - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">   name:</span> <span class=\"string\">elasticsearch7-admin</span></span><br><span class=\"line\"><span class=\"attr\">   namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">    role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">      role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">        role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccountName:</span> <span class=\"string\">elasticsearch7-admin</span></span><br><span class=\"line\"><span class=\"attr\">      restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">      securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">        fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">hub.zhangzw.com/bq/elasticsearch:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          command:</span> <span class=\"string\">[\"bash\",</span> <span class=\"string\">\"-c\"</span><span class=\"string\">,</span> <span class=\"string\">\"ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">          securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">            privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"800m\"</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">cluster.name</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"es_cluster\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.master</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.data</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">cluster.initial_master_nodes</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"elasticsearch-master-0\"</span> <span class=\"comment\"># 根据副本数和name配置</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">discovery.zen.ping_timeout</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"5s\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.ingest</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"false\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">ES_JAVA_OPTS</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"-Xms1g -Xmx1g\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"discovery.zen.ping.unicast.hosts\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"elasticsearch-discovery\"</span> <span class=\"comment\"># Disvocery Service</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"http.cors.enabled\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"http.cors.allow-origin\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">elasticsearch-data-volume</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">elasticsearch-data-volume</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-container/elk-7.2.0/es-7.2.0/data</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">elasticsearch-discovery</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  publishNotReadyAddresses:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">transport</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">    role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch-service</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">19230</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-es配置nfs动态挂载-k8s-es-7-2-0-nfs-yml\"><a href=\"#2-es配置nfs动态挂载-k8s-es-7-2-0-nfs-yml\" class=\"headerlink\" title=\"2. es配置nfs动态挂载 k8s-es-7.2.0-nfs.yml\"></a>2. es配置nfs动态挂载 k8s-es-7.2.0-nfs.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch-admin</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch-admin</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"attr\"> apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\"> kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">cluster-admin</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"attr\"> - kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">   name:</span> <span class=\"string\">elasticsearch-admin</span></span><br><span class=\"line\"><span class=\"attr\">   namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">    role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">elasticsearch-data-nfs</span></span><br><span class=\"line\"><span class=\"attr\">      annotations:</span></span><br><span class=\"line\">        <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"nfs\"</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">2</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">      role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">        role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      serviceAccountName:</span> <span class=\"string\">elasticsearch-admin</span></span><br><span class=\"line\"><span class=\"attr\">      restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">      securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">        fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">elasticsearch-master</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"attr\">elasticsearch:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          command:</span> <span class=\"string\">[\"bash\",</span> <span class=\"string\">\"-c\"</span><span class=\"string\">,</span> <span class=\"string\">\"ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">elasticsearch-data-nfs</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\"><span class=\"attr\">          securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">            privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">cluster.name</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"es_cluster\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.master</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.data</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">cluster.initial_master_nodes</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"elasticsearch-master-0,elasticsearch-master-1\"</span> <span class=\"comment\"># 根据副本数和name配置</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">discovery.zen.ping_timeout</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"5s\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">node.ingest</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"false\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">ES_JAVA_OPTS</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"-Xms1g -Xmx1g\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"discovery.zen.ping.unicast.hosts\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"elasticsearch-discovery\"</span> <span class=\"comment\"># Disvocery Service</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"http.cors.enabled\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">\"http.cors.allow-origin\"</span></span><br><span class=\"line\"><span class=\"attr\">              value:</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">elasticsearch-discovery</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  publishNotReadyAddresses:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">transport</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">    role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">elasticsearch-service</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\"> ports:</span></span><br><span class=\"line\"><span class=\"attr\">   - port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     targetPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"attr\">     nodePort:</span> <span class=\"number\">19220</span></span><br><span class=\"line\"><span class=\"attr\">     protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\"> selector:</span></span><br><span class=\"line\"><span class=\"attr\">   app:</span> <span class=\"string\">elasticsearch</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-kibana配置k8s-kibana-7-2-0-yml\"><a href=\"#3-kibana配置k8s-kibana-7-2-0-yml\" class=\"headerlink\" title=\"3. kibana配置k8s-kibana-7.2.0.yml\"></a>3. kibana配置k8s-kibana-7.2.0.yml</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">kibana.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    server.name: kibana</span></span><br><span class=\"line\"><span class=\"string\">    server.host: \"0\"</span></span><br><span class=\"line\"><span class=\"string\">    elasticsearch.hosts: [ \"http://elasticsearch-service:9200\" ]</span></span><br><span class=\"line\"><span class=\"string\">    xpack.monitoring.ui.container.elasticsearch.enabled: true</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta2</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">hub.zhangzw.com/bq/kibana:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            requests:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"50m\"</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span></span><br><span class=\"line\"><span class=\"attr\">              cpu:</span> <span class=\"string\">\"800m\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/usr/share/kibana/config</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\"><span class=\"attr\">          configMap:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\"><span class=\"attr\">      tolerations:</span></span><br><span class=\"line\"><span class=\"attr\">        - key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\"><span class=\"attr\">          effect:</span> <span class=\"string\">NoSchedule</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">kibana-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> labels:</span></span><br><span class=\"line\"><span class=\"attr\">   elastic-app:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">kibana-ingress</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">ns-elastic7</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> rules:</span></span><br><span class=\"line\"><span class=\"attr\">   - host:</span> <span class=\"string\">elk-kibana-dev.zhangzw.com</span></span><br><span class=\"line\"><span class=\"attr\">     http:</span></span><br><span class=\"line\"><span class=\"attr\">       paths:</span></span><br><span class=\"line\"><span class=\"attr\">         - backend:</span></span><br><span class=\"line\"><span class=\"attr\">             serviceName:</span> <span class=\"string\">kibana-service</span></span><br><span class=\"line\"><span class=\"attr\">             servicePort:</span> <span class=\"number\">5601</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-logstash配置-本地挂载-k8s-logstash-7-2-0-yml\"><a href=\"#4-logstash配置-本地挂载-k8s-logstash-7-2-0-yml\" class=\"headerlink\" title=\"4. logstash配置 本地挂载 k8s-logstash-7.2.0.yml\"></a>4. logstash配置 本地挂载 k8s-logstash-7.2.0.yml</h3><ul>\n<li><p>4.1 config/pipelines.yml</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- pipeline<span class=\"selector-class\">.id</span>: main</span><br><span class=\"line\">  path<span class=\"selector-class\">.config</span>: <span class=\"string\">\"/usr/share/logstash/config/pipeline/*.conf\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.2 首先配置grok规则 config/pipeline/logstash.conf</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">    udp &#123;</span><br><span class=\"line\">        port =&gt; <span class=\"string\">\"10000\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> filter &#123;</span><br><span class=\"line\">      grok &#123;</span><br><span class=\"line\">          match =&gt; &#123;</span><br><span class=\"line\">            <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"\\&#123;<span class=\"subst\">\\\"</span>id<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;id&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>tag<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;tag&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>title<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>%&#123;GREEDYDATA:title&#125;(?&lt;title&gt;(.|\\r|<span class=\"subst\">\\n</span>)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>value<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>%&#123;GREEDYDATA:value&#125;(?&lt;value&gt;(.|\\r|<span class=\"subst\">\\n</span>)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>createdAt<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;createdAt&gt;\\S+ \\S+)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>Telephone<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;Telephone&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>uid<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;uid&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>updateTime<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;updateTime&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>appVersion<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;appVersion&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>mobileModel<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;mobileModel&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>osVersion<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;osVersion&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>channel<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;channel&gt;(.)*)<span class=\"subst\">\\\"</span>,<span class=\"subst\">\\\"</span>UDID<span class=\"subst\">\\\"</span>:<span class=\"subst\">\\\"</span>(?&lt;UDID&gt;(.)*)<span class=\"subst\">\\\"</span>\\&#125;\"</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        hosts =&gt;  [ <span class=\"string\">\"http://elasticsearch-service:9200\"</span> ]</span><br><span class=\"line\">        index =&gt; <span class=\"string\">\"k8s2-dev-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.3 配置文件 k8s-logstash-7.2.0.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1beta2</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      elastic-app:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        elastic-app:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">hub.zhangzw.com/bq/logstash:7.2.0</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/usr/share/logstash/config</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\"><span class=\"attr\">          hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/data/k8s-pod/elk-7.2.0/logstash-7.2.0/config</span></span><br><span class=\"line\"><span class=\"attr\">      tolerations:</span></span><br><span class=\"line\"><span class=\"attr\">        - key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\"><span class=\"attr\">          effect:</span> <span class=\"string\">NoSchedule</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">logstash-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ns-elastic</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">UDP</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    elastic-app:</span> <span class=\"string\">logstash</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/19/2-部署elk7-2-0/","categories":[{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elk7","slug":"k8s/elk7","permalink":"https://blog.k1s.club/categories/k8s/elk7/"},{"name":"elasticsearch7","slug":"elk/elasticsearch7","permalink":"https://blog.k1s.club/categories/elk/elasticsearch7/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/tags/elk7/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/tags/elk/"},{"name":"elasticsearch7","slug":"elasticsearch7","permalink":"https://blog.k1s.club/tags/elasticsearch7/"}]},{"title":"首次搭建hexo博客系统","date":"2019-09-19T09:24:53.000Z","path":"2019/09/19/首次搭建hexo博客系统/","text":"首次搭建hexo博客系统, 简单记录一下一些用法和注意事项 1 安装hexo 1.1 在mac上安装 12# 安装nodebrew install node npm 1.2 在linux安装 123# 安装node10curl -sL https://rpm.nodesource.com/setup_10.x | bash -yum install -y nodejs 1.3 安装hexo 12# 安装hexonpm install -g hexo 2 初始化123456789101112cd /data/github/# 初始化hexo init blog# 框架安装npm install#安装 Hexo 关于启动服务器的插件npm install hexo-server --save# 启动服务器, 本地查看效果, 如果不指定端口，默认为4000hexo server 3 主题和配置 下载主题：https://github.com/theme-next/hexo-theme-next 12unzip hexo-theme-next-master.zipmv hexo-theme-next-master $blog/themes/ 修改主题配置 _config.yml 中的其他属性 12345title: Zhangzhiwei's Blog...theme: hexo-theme-next...scheme: Mist 4. 编写更新博客 创建博客 1hexo new '第一个博客' cat source/_posts/第一个博客.md 123456title: 第一个博客date: 2019-09-19 16:58:01tags: - hexocategories: - hexo学习 github 创建一个Repository仓库 1231. 仓库名字必须是 xxx.github.io2. 在settings中 勾选Template repository3. 记得添加自己的ssh github配置 12 # 安装 hexo 关于 git 的组件npm install hexo-deployer-git --save 在_config.yml 中为 git 添加配置 1234deploy: type: git repository: git@github.com:*/*.github.io.git branch: master 查看是否能提交代码github 1ssh -T -ai ~/.ssh/id_rsa git@github.com 部署 1234hexo ghexo d或者hexo d -g 5. next6让首页文字预览显示 5.1 方法一: 自动形成摘要,默认截取的长度为 150 字符 1231. 找到主题的配置文件(themes/next/_config.yml)2. 修改auto_excerpt,把enable改为对应的false改为true3. hexo d -g 5.2 方法二: 博客内容中添加 &lt; !–more–&gt; 123# 安装nodebrew install node npm &lt;!-- more --&gt; 5.3 方法三: 在文章中的front-matter中添加description，并提供文章摘录,这种方式只会在首页列表中显示文章的摘要内容，进入文章详情后不会再显示。 1234567891011title: 部署elk7.2.0date: 2019-09-19 17:59:53copyright: truetags: - k8s - elk - elk7categories: - 技术文档 - elkdescription: 本文主要是简单单机版部署elk7体验, 并非高可用集群方式部署, 部分安装步骤省略. 主要是记录yml配置文件, 仅供参考. 详细内容请点击下方阅读全文, 非常感谢! 6. next6添加搜索功能123456789101. npm install hexo-generator-searchdb --save2. 全局配置文件_config.ymlsearch: path: search.xml field: post format: html limit: 100003. 修改主题的_config.ymllocal_search: enable: true 7. next6 Mist字体的 首页文章间距和首页页宽,字体 7.1 首页文章间距 12345增加一些内容: source/css/_schemes/Mist/_posts-expanded.styl.posts-expand .post &#123; margin-top: 30px; margin-bottom: 30px;&#125; 7.2 页宽 1234source/css/_variables/base.styl$content-desktop = 900px$content-desktop-large = 1000px$content-desktop-largest = 1100px 7.3 字体大小 1234567891011themes/next/source/css/_variables/base.styl$font-size-base = 0.95em;$font-size-base = unit(hexo-config('font.global.size'), em) if hexo-config('font.global.size') is a 'unit';$font-size-smallest = .75em;$font-size-smaller = .8125em;$font-size-small = .855em;$font-size-medium = 0.95em;$font-size-large = 0.975em;$font-size-larger = 1.em;$font-size-largest = 1.125em; 8. 添加网格 8.1 自定义方式修改 1234567891011121314# 新创建自定义文件cat themes/next/source/css/_custom/custom.styl// 主页文章添加阴影效果.post &#123;margin-top: 60px;margin-bottom: 60px;padding: 25px;-webkit-box-shadow: 0 0 5px rgba(202, 203, 203, .5);-moz-box-shadow: 0 0 5px rgba(202, 203, 204, .5);&#125;# 修改config文件vim ./themes/next/_config.ymlcustom: custom 8.2 next6版本修改方式 参考: hexo6–next美化整理 修改 themes/next/layout/_layout.swig 1234&#123;% if theme.canvas_nest %&#125;&lt;script type=\"text/javascript\" src=\"//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js\"&gt;&lt;/script&gt;&#123;% endif %&#125; 将上述代码防止在&lt; /body&gt; 前就可以了(注意不要放在&lt; /head&gt;的后面)。 修改主题的_config.yml 123456canvas_nest: true//color: 线条颜色, 默认: '0,0,0'；三个数字分别为(R,G,B)//opacity: 线条透明度（0~1）, 默认: 0.5//count: 线条的总数量, 默认: 150//zIndex: 背景的z-index属性，css属性用于控制所在层的位置, 默认: -1 注意:我这里打开提示缺少 canvas-nest.min.js文件,这里是手动copy的一份写到 source/lib/canvas-nest/canvas-nest.min.js 1!function()&#123;function o(w,v,i)&#123;return w.getAttribute(v)||i&#125;function j(i)&#123;return document.getElementsByTagName(i)&#125;function l()&#123;var i=j(\"script\"),w=i.length,v=i[w-1];return&#123;l:w,z:o(v,\"zIndex\",-1),o:o(v,\"opacity\",0.5),c:o(v,\"color\",\"0,0,0\"),n:o(v,\"count\",99)&#125;&#125;function k()&#123;r=u.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,n=u.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight&#125;function b()&#123;e.clearRect(0,0,r,n);var w=[f].concat(t);var x,v,A,B,z,y;t.forEach(function(i)&#123;i.x+=i.xa,i.y+=i.ya,i.xa*=i.x&gt;r||i.x&lt;0?-1:1,i.ya*=i.y&gt;n||i.y&lt;0?-1:1,e.fillRect(i.x-0.5,i.y-0.5,1,1);for(v=0;v&lt;w.length;v++)&#123;x=w[v];if(i!==x&amp;&amp;null!==x.x&amp;&amp;null!==x.y)&#123;B=i.x-x.x,z=i.y-x.y,y=B*B+z*z;y&lt;x.max&amp;&amp;(x===f&amp;&amp;y&gt;=x.max/2&amp;&amp;(i.x-=0.03*B,i.y-=0.03*z),A=(x.max-y)/x.max,e.beginPath(),e.lineWidth=A/2,e.strokeStyle=\"rgba(\"+s.c+\",\"+(A+0.2)+\")\",e.moveTo(i.x,i.y),e.lineTo(x.x,x.y),e.stroke())&#125;&#125;w.splice(w.indexOf(i),1)&#125;),m(b)&#125;var u=document.createElement(\"canvas\"),s=l(),c=\"c_n\"+s.l,e=u.getContext(\"2d\"),r,n,m=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i)&#123;window.setTimeout(i,1000/45)&#125;,a=Math.random,f=&#123;x:null,y:null,max:20000&#125;;u.id=c;u.style.cssText=\"position:fixed;top:0;left:0;z-index:\"+s.z+\";opacity:\"+s.o;j(\"body\")[0].appendChild(u);k(),window.onresize=k;window.onmousemove=function(i)&#123;i=i||window.event,f.x=i.clientX,f.y=i.clientY&#125;,window.onmouseout=function()&#123;f.x=null,f.y=null&#125;;for(var t=[],p=0;s.n&gt;p;p++)&#123;var h=a()*r,g=a()*n,q=2*a()-1,d=2*a()-1;t.push(&#123;x:h,y:g,xa:q,ya:d,max:6000&#125;)&#125;setTimeout(function()&#123;b()&#125;,100)&#125;();% 9. 添加评论功能 9.1 注册leancloud 1注册-&gt; 验证邮箱-&gt; 实名认证 -&gt; 设置获取appid和appkey 9.2 修改配置文件 123456valine: enable: true appid: 'appid' appkey: 'appkey' placeholder: \"ヾﾉ≧∀≦)o 来呀！快活呀！~啦啦啦~ 啦啦啦啦~\" visitor: true //这个打开页会统计文章阅读数 10. next6添加字数统计 和阅读时长 hexo-symbols-count-time 10.1 安装node扩展 1npm install hexo-symbols-count-time --save 10.2 修改全局配置 _config.yml 123456symbols_count_time: symbols: true time: true total_symbols: true total_time: true exclude_codeblock: false 10.3 修改主题配置 _config.yml 1234567symbols_count_time: separated_meta: true item_text_post: true item_text_total: false awl: 4 wpm: 275 suffix: mins. 11. next6 文章置顶功能 11.1 安装node扩展 12npm uninstall hexo-generator-index --savenpm install hexo-generator-index-pin-top --save 11.2 在文章开头添加置顶标识 1top: 10 11.3 首页添加明显置顶标识 123456themes/next/layout/_macro/post.swig 在&lt;div class=\"post-meta\"&gt; 下添加如下代码&#123;% if post.top %&#125; &lt;i class=\"fa fa-thumb-tack\"&gt;&lt;/i&gt; &lt;font color=green&gt;置顶&lt;/font&gt; &lt;span class=\"post-meta-divider\"&gt;|&lt;/span&gt;&#123;% endif %&#125; 12. next6 开启标签和分类 12.1 创建tags相关目录 12hexo new page tagshexo new page categories 12.2 开启tags标签和分类 123vim themes/next/_config.ymltags: /tags/ || tagscategories: /categories/ || th 12.3 修改tags站点文件 12345678cat source/tags/index.md---title: tagsdate: 2019-09-24 10:08:59type: \"tags\"layout: \"tags\"comments: false--- 12.4 修改categories站点文件 12345678cat source/categories/index.md---title: categoriesdate: 2019-09-24 10:09:55type: \"categories\"layout: \"categories\"comments: false--- 12.5 去掉xxx.github.io/tags/ 页面的post-title(因为我的这个css左对齐了,默认是居中,所以很丑) 123# 注释下面这段代码vim themes/nextv/layout/page.swig &lt;!-- &#123;% include '_partials/page/page-header.swig' %&#125; --&gt; 12.6 文章中多个tag和categories 123456tags: - k8s - k8s安装categories: - [k8s,安装] - [技术文档]","raw":"---\ntitle: 首次搭建hexo博客系统\ndate: 2019-09-19 17:24:53\ncopyright: true\ntags:\n  - hexo6\n  - hexo美化\ncategories: \n  - [有趣]\n  - [博客,美化]\ndescription: \"介绍一些hexo常用的配置和优化\"\n---\n首次搭建hexo博客系统, 简单记录一下一些用法和注意事项\n<!--more-->\n### 1 安装hexo\n- 1.1 在mac上安装\n```\n# 安装node\nbrew install node npm\n```\n\n- 1.2 在linux安装\n```\n# 安装node10\ncurl -sL https://rpm.nodesource.com/setup_10.x | bash -\nyum install -y nodejs\n```\n\n- 1.3 安装hexo\n```\n# 安装hexo\nnpm install -g hexo\n```\n\n\n### 2 初始化\n```\ncd /data/github/\n# 初始化\n\nhexo init blog\n# 框架安装\nnpm install\n\n#安装 Hexo 关于启动服务器的插件\nnpm install hexo-server --save\n\n# 启动服务器, 本地查看效果, 如果不指定端口，默认为4000\nhexo server\n\n```\n\n### 3 主题和配置\n- 下载主题：[https://github.com/theme-next/hexo-theme-next](https://github.com/theme-next/hexo-theme-next)\n```\nunzip hexo-theme-next-master.zip\nmv hexo-theme-next-master $blog/themes/\n```\n\n- 修改主题配置 _config.yml 中的其他属性\n```\ntitle: Zhangzhiwei's Blog\n...\ntheme: hexo-theme-next\n...\nscheme: Mist\n```\n\n### 4. 编写更新博客\n\n- 创建博客\n```\nhexo new '第一个博客'\n```\n\n- cat source/_posts/第一个博客.md\n```\ntitle: 第一个博客\ndate: 2019-09-19 16:58:01\ntags:\n  - hexo\ncategories:\n  - hexo学习\n```\n\n- github 创建一个Repository仓库\n```\n1. 仓库名字必须是 xxx.github.io\n2. 在settings中 勾选Template repository\n3. 记得添加自己的ssh\n```\n\n\n\n- github配置\n```\n # 安装 hexo 关于 git 的组件\nnpm install hexo-deployer-git --save\n```\n\n- 在_config.yml 中为 git 添加配置\n```\ndeploy:\n  type: git\n  repository: git@github.com:*/*.github.io.git\n  branch: master\n```\n\n- 查看是否能提交代码github\n```\nssh -T -ai ~/.ssh/id_rsa git@github.com\n```\n\n- 部署\n```\nhexo g\nhexo d\n或者\nhexo d -g\n```\n\n### 5. next6让首页文字预览显示\n- 5.1 方法一: 自动形成摘要,默认截取的长度为 150 字符\n```\n1. 找到主题的配置文件(themes/next/_config.yml)\n2. 修改auto_excerpt,把enable改为对应的false改为true\n3. hexo d -g\n```\n\n- 5.2 方法二: 博客内容中添加 < !--more-->\n```\n# 安装node\nbrew install node npm\n <!-- more -->\n```\n\n- 5.3 方法三: 在文章中的front-matter中添加description，并提供文章摘录,这种方式只会在首页列表中显示文章的摘要内容，进入文章详情后不会再显示。\n```\ntitle: 部署elk7.2.0\ndate: 2019-09-19 17:59:53\ncopyright: true\ntags:\n  - k8s\n  - elk\n  - elk7\ncategories:\n  - 技术文档\n  - elk\ndescription: 本文主要是简单单机版部署elk7体验,  并非高可用集群方式部署, 部分安装步骤省略. 主要是记录yml配置文件, 仅供参考. 详细内容请点击下方阅读全文, 非常感谢!\n```\n\n\n### 6. next6添加搜索功能\n```\n1. npm install hexo-generator-searchdb --save\n2. 全局配置文件_config.yml\nsearch:\n  path: search.xml\n  field: post\n  format: html\n  limit: 10000\n3. 修改主题的_config.yml\nlocal_search:\n  enable: true\n```\n\n### 7. next6 Mist字体的 首页文章间距和首页页宽,字体\n- 7.1 首页文章间距\n\n\t```\n\t增加一些内容: source/css/_schemes/Mist/_posts-expanded.styl\n\t.posts-expand .post {\n\t  margin-top: 30px;\n\t  margin-bottom: 30px;\n\t}\n\t\n\t```\n\n- 7.2 页宽\n\n\t```\n\tsource/css/_variables/base.styl\n\t$content-desktop                = 900px\n\t$content-desktop-large          = 1000px\n\t$content-desktop-largest        = 1100px\n\t```\n\n- 7.3 字体大小\n\n\t```\n\tthemes/next/source/css/_variables/base.styl\n\t\n\t$font-size-base           = 0.95em;\n\t$font-size-base           = unit(hexo-config('font.global.size'), em) if hexo-config('font.global.size') is a 'unit';\n\t$font-size-smallest       = .75em;\n\t$font-size-smaller        = .8125em;\n\t$font-size-small          = .855em;\n\t$font-size-medium         = 0.95em;\n\t$font-size-large          = 0.975em;\n\t$font-size-larger         = 1.em;\n\t$font-size-largest        = 1.125em;\n\t```\n\n### 8. 添加网格\n-  8.1 自定义方式修改\n\n\t```\n\t# 新创建自定义文件\n\tcat themes/next/source/css/_custom/custom.styl\n\t// 主页文章添加阴影效果\n\t.post {\n\tmargin-top: 60px;\n\tmargin-bottom: 60px;\n\tpadding: 25px;\n\t-webkit-box-shadow: 0 0 5px rgba(202, 203, 203, .5);\n\t-moz-box-shadow: 0 0 5px rgba(202, 203, 204, .5);\n\t}\n\n\t# 修改config文件\n\tvim ./themes/next/_config.yml\n\tcustom: custom\n\t```\n\n- 8.2 next6版本修改方式\n\t> 参考: [hexo6--next美化整理](https://www.jianshu.com/p/ec2e6c8a1d89)\n\n\t1. 修改 themes/next/layout/_layout.swig\n\t```\n\t{% if theme.canvas_nest %}\n\t<script type=\"text/javascript\" src=\"//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js\">\n\t</script>\n\t{% endif %}\n\t```\n\n\t> 将上述代码防止在< /body> 前就可以了(注意不要放在< /head>的后面)。\n\n\t2. 修改主题的_config.yml\n\n\t```\n\tcanvas_nest: true\n\n\t//color: 线条颜色, 默认: '0,0,0'；三个数字分别为(R,G,B)\n\t//opacity: 线条透明度（0~1）, 默认: 0.5\n\t//count: 线条的总数量, 默认: 150\n\t//zIndex: 背景的z-index属性，css属性用于控制所在层的位置, 默认: -1\n\t```\n> 注意:\n我这里打开提示缺少 canvas-nest.min.js文件,这里是手动copy的一份写到 source/lib/canvas-nest/canvas-nest.min.js\n\n```\n!function(){function o(w,v,i){return w.getAttribute(v)||i}function j(i){return document.getElementsByTagName(i)}function l(){var i=j(\"script\"),w=i.length,v=i[w-1];return{l:w,z:o(v,\"zIndex\",-1),o:o(v,\"opacity\",0.5),c:o(v,\"color\",\"0,0,0\"),n:o(v,\"count\",99)}}function k(){r=u.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,n=u.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function b(){e.clearRect(0,0,r,n);var w=[f].concat(t);var x,v,A,B,z,y;t.forEach(function(i){i.x+=i.xa,i.y+=i.ya,i.xa*=i.x>r||i.x<0?-1:1,i.ya*=i.y>n||i.y<0?-1:1,e.fillRect(i.x-0.5,i.y-0.5,1,1);for(v=0;v<w.length;v++){x=w[v];if(i!==x&&null!==x.x&&null!==x.y){B=i.x-x.x,z=i.y-x.y,y=B*B+z*z;y<x.max&&(x===f&&y>=x.max/2&&(i.x-=0.03*B,i.y-=0.03*z),A=(x.max-y)/x.max,e.beginPath(),e.lineWidth=A/2,e.strokeStyle=\"rgba(\"+s.c+\",\"+(A+0.2)+\")\",e.moveTo(i.x,i.y),e.lineTo(x.x,x.y),e.stroke())}}w.splice(w.indexOf(i),1)}),m(b)}var u=document.createElement(\"canvas\"),s=l(),c=\"c_n\"+s.l,e=u.getContext(\"2d\"),r,n,m=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i){window.setTimeout(i,1000/45)},a=Math.random,f={x:null,y:null,max:20000};u.id=c;u.style.cssText=\"position:fixed;top:0;left:0;z-index:\"+s.z+\";opacity:\"+s.o;j(\"body\")[0].appendChild(u);k(),window.onresize=k;window.onmousemove=function(i){i=i||window.event,f.x=i.clientX,f.y=i.clientY},window.onmouseout=function(){f.x=null,f.y=null};for(var t=[],p=0;s.n>p;p++){var h=a()*r,g=a()*n,q=2*a()-1,d=2*a()-1;t.push({x:h,y:g,xa:q,ya:d,max:6000})}setTimeout(function(){b()},100)}();%\n\n```\n\n### 9. 添加评论功能\n\n- 9.1 注册leancloud\n ```\n 注册-> 验证邮箱-> 实名认证 -> 设置获取appid和appkey\n ```\n\n- 9.2 修改配置文件\n ```\n valine:\n   enable: true \n   appid: 'appid' \n   appkey: 'appkey' \n   placeholder: \"ヾﾉ≧∀≦)o 来呀！快活呀！~啦啦啦~ 啦啦啦啦~\" \n   visitor: true //这个打开页会统计文章阅读数\n ```\n\n\n\n\n### 10. next6添加字数统计 和阅读时长\n\n> [hexo-symbols-count-time](https://github.com/theme-next/hexo-symbols-count-time)\n\n- 10.1 安装node扩展\n ```\n npm install hexo-symbols-count-time --save\n ```\n\n- 10.2 修改全局配置 _config.yml\n ```\n symbols_count_time:\n   symbols: true\n   time: true\n   total_symbols: true\n   total_time: true\n   exclude_codeblock: false\n ```\n\n- 10.3 修改主题配置 _config.yml\n ```\n symbols_count_time:\n   separated_meta: true\n   item_text_post: true\n   item_text_total: false\n   awl: 4\n   wpm: 275\n   suffix: mins.\n ```\n\n\n\n### 11. next6 文章置顶功能\n\n- 11.1 安装node扩展 \n ```\n npm uninstall hexo-generator-index --save\n npm install hexo-generator-index-pin-top --save\n ```\n\n- 11.2 在文章开头添加置顶标识\n ```\n top: 10\n ```\n\n- 11.3 首页添加明显置顶标识\n ```\n themes/next/layout/_macro/post.swig 在<div class=\"post-meta\"> 下添加如下代码\n {% if post.top %}\n     <i class=\"fa fa-thumb-tack\"></i>\n     <font color=green>置顶</font>\n     <span class=\"post-meta-divider\">|</span>\n {% endif %}\n ```\n\n### 12. next6 开启标签和分类\n\n- 12.1 创建tags相关目录\n```\nhexo new page tags\nhexo new page categories\n```\n\n- 12.2 开启tags标签和分类\n```\nvim themes/next/_config.yml\ntags: /tags/ || tags\ncategories: /categories/ || th\n```\n\n- 12.3 修改tags站点文件\n```\ncat source/tags/index.md\n---\ntitle: tags\ndate: 2019-09-24 10:08:59\ntype: \"tags\"\nlayout: \"tags\"\ncomments: false\n---\n```\n\n- 12.4 修改categories站点文件\n```\ncat source/categories/index.md\n---\ntitle: categories\ndate: 2019-09-24 10:09:55\ntype: \"categories\"\nlayout: \"categories\"\ncomments: false\n---\n```\n\n- 12.5 去掉xxx.github.io/tags/ 页面的post-title(因为我的这个css左对齐了,默认是居中,所以很丑)\n```\n# 注释下面这段代码\nvim themes/nextv/layout/page.swig \n<!-- {% include '_partials/page/page-header.swig' %} -->\n```\n\n- 12.6 文章中多个tag和categories\n```\ntags:\n  - k8s\n  - k8s安装\ncategories:\n  - [k8s,安装]\n  - [技术文档]\n```\n","content":"<p>首次搭建hexo博客系统, 简单记录一下一些用法和注意事项</p>\n<a id=\"more\"></a>\n<h3 id=\"1-安装hexo\"><a href=\"#1-安装hexo\" class=\"headerlink\" title=\"1 安装hexo\"></a>1 安装hexo</h3><ul>\n<li><p>1.1 在mac上安装</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装node</span></span><br><span class=\"line\">brew install <span class=\"keyword\">node</span> <span class=\"title\">npm</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.2 在linux安装</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装node10</span></span><br><span class=\"line\"><span class=\"attribute\">curl</span> -sL https://rpm.nodesource.com/setup_10.x | bash -</span><br><span class=\"line\">yum install -y nodejs</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>1.3 安装hexo</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装hexo</span></span><br><span class=\"line\">npm <span class=\"keyword\">install</span> -g hexo</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"2-初始化\"><a href=\"#2-初始化\" class=\"headerlink\" title=\"2 初始化\"></a>2 初始化</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /data/github/</span><br><span class=\"line\"><span class=\"comment\"># 初始化</span></span><br><span class=\"line\"></span><br><span class=\"line\">hexo init blog</span><br><span class=\"line\"><span class=\"comment\"># 框架安装</span></span><br><span class=\"line\">npm <span class=\"keyword\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装 Hexo 关于启动服务器的插件</span></span><br><span class=\"line\">npm <span class=\"keyword\">install</span> hexo-<span class=\"keyword\">server</span> <span class=\"comment\">--save</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务器, 本地查看效果, 如果不指定端口，默认为4000</span></span><br><span class=\"line\">hexo <span class=\"keyword\">server</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-主题和配置\"><a href=\"#3-主题和配置\" class=\"headerlink\" title=\"3 主题和配置\"></a>3 主题和配置</h3><ul>\n<li><p>下载主题：<a href=\"https://github.com/theme-next/hexo-theme-next\" target=\"_blank\" rel=\"noopener\">https://github.com/theme-next/hexo-theme-next</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip hexo-theme-<span class=\"keyword\">next</span>-master.zip</span><br><span class=\"line\">mv hexo-theme-<span class=\"keyword\">next</span>-master <span class=\"variable\">$blog</span><span class=\"regexp\">/themes/</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改主题配置 _config.yml 中的其他属性</p>\n<figure class=\"highlight ldif\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">title</span>: Zhangzhiwei's Blog</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"attribute\">theme</span>: hexo-theme-next</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"attribute\">scheme</span>: Mist</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"4-编写更新博客\"><a href=\"#4-编写更新博客\" class=\"headerlink\" title=\"4. 编写更新博客\"></a>4. 编写更新博客</h3><ul>\n<li><p>创建博客</p>\n<figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo <span class=\"keyword\">new</span> <span class=\"string\">'第一个博客'</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>cat source/_posts/第一个博客.md</p>\n<figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">title: 第一个博客</span><br><span class=\"line\">date: 2019<span class=\"string\">-09</span><span class=\"string\">-19</span> 16:58:01</span><br><span class=\"line\"><span class=\"keyword\">tags:</span></span><br><span class=\"line\">  - hexo</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - hexo学习</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>github 创建一个Repository仓库</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">1. </span>仓库名字必须是 xxx.github.io</span><br><span class=\"line\"><span class=\"bullet\">2. </span>在settings中 勾选Template repository</span><br><span class=\"line\"><span class=\"bullet\">3. </span>记得添加自己的ssh</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>github配置</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\"># 安装 hexo 关于 git 的组件</span></span><br><span class=\"line\">npm <span class=\"keyword\">install</span> hexo-deployer-git <span class=\"comment\">--save</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在_config.yml 中为 git 添加配置</p>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">deploy</span>:</span><br><span class=\"line\">  <span class=\"attribute\">type</span>: git</span><br><span class=\"line\">  <span class=\"attribute\">repository</span>: git<span class=\"variable\">@github</span>.<span class=\"attribute\">com</span>:*<span class=\"comment\">/*.github.io.git</span></span><br><span class=\"line\"><span class=\"comment\">  branch: master</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看是否能提交代码github</p>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -T -ai ~<span class=\"regexp\">/.ssh/id</span>_rsa git<span class=\"variable\">@github</span>.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>部署</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">hexo</span> g</span><br><span class=\"line\">hexo d</span><br><span class=\"line\">或者</span><br><span class=\"line\">hexo d -g</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"5-next6让首页文字预览显示\"><a href=\"#5-next6让首页文字预览显示\" class=\"headerlink\" title=\"5. next6让首页文字预览显示\"></a>5. next6让首页文字预览显示</h3><ul>\n<li><p>5.1 方法一: 自动形成摘要,默认截取的长度为 150 字符</p>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span> 找到主题的配置文件(themes/<span class=\"keyword\">next</span>/_config.yml)</span><br><span class=\"line\"><span class=\"number\">2.</span> 修改auto_excerpt,把enable改为对应的<span class=\"literal\">false</span>改为<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"number\">3.</span> hexo d -g</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.2 方法二: 博客内容中添加 &lt; !–more–&gt;</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 安装node</span><br><span class=\"line\">brew install node npm</span><br><span class=\"line\"> <span class=\"comment\">&lt;!-- more --&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.3 方法三: 在文章中的front-matter中添加description，并提供文章摘录,这种方式只会在首页列表中显示文章的摘要内容，进入文章详情后不会再显示。</p>\n<figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">title: 部署elk7.2.0</span><br><span class=\"line\">date: 2019<span class=\"string\">-09</span><span class=\"string\">-19</span> 17:59:53</span><br><span class=\"line\">copyright: true</span><br><span class=\"line\"><span class=\"keyword\">tags:</span></span><br><span class=\"line\">  - k8s</span><br><span class=\"line\">  - elk</span><br><span class=\"line\">  - elk7</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - 技术文档</span><br><span class=\"line\">  - elk</span><br><span class=\"line\">description: 本文主要是简单单机版部署elk7体验,  并非高可用集群方式部署, 部分安装步骤省略. 主要是记录yml配置文件, 仅供参考. 详细内容请点击下方阅读全文, 非常感谢!</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"6-next6添加搜索功能\"><a href=\"#6-next6添加搜索功能\" class=\"headerlink\" title=\"6. next6添加搜索功能\"></a>6. next6添加搜索功能</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. npm <span class=\"keyword\">install</span> hexo-generator-searchdb <span class=\"comment\">--save</span></span><br><span class=\"line\"><span class=\"number\">2.</span> 全局配置文件_config.yml</span><br><span class=\"line\"><span class=\"keyword\">search</span>:</span><br><span class=\"line\">  <span class=\"keyword\">path</span>: search.xml</span><br><span class=\"line\">  <span class=\"keyword\">field</span>: post</span><br><span class=\"line\">  <span class=\"keyword\">format</span>: html</span><br><span class=\"line\">  <span class=\"keyword\">limit</span>: <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"number\">3.</span> 修改主题的_config.yml</span><br><span class=\"line\">local_search:</span><br><span class=\"line\">  <span class=\"keyword\">enable</span>: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-next6-Mist字体的-首页文章间距和首页页宽-字体\"><a href=\"#7-next6-Mist字体的-首页文章间距和首页页宽-字体\" class=\"headerlink\" title=\"7. next6 Mist字体的 首页文章间距和首页页宽,字体\"></a>7. next6 Mist字体的 首页文章间距和首页页宽,字体</h3><ul>\n<li><p>7.1 首页文章间距</p>\n  <figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">增加一些内容: source/css/_schemes/Mist/_posts-expanded.styl</span><br><span class=\"line\"><span class=\"selector-class\">.posts-expand</span> <span class=\"selector-class\">.post</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">margin-top</span>: <span class=\"number\">30px</span>;</span><br><span class=\"line\">  <span class=\"attribute\">margin-bottom</span>: <span class=\"number\">30px</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>7.2 页宽</p>\n  <figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source/css/_variables/base.styl</span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>-desktop                = 900px</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>-desktop-large          = 1000px</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>-desktop-largest        = 1100px</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>7.3 字体大小</p>\n  <figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">themes/next/<span class=\"keyword\">source</span>/css/_variables/base.styl</span><br><span class=\"line\"></span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-base           = <span class=\"number\">0.95</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-base           = <span class=\"keyword\">unit</span>(hexo-config(<span class=\"string\">'font.global.size'</span>), em) <span class=\"keyword\">if</span> hexo-config(<span class=\"string\">'font.global.size'</span>) is a <span class=\"string\">'unit'</span>;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-smallest       = <span class=\"number\">.75</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-smaller        = <span class=\"number\">.8125</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-small          = <span class=\"number\">.855</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-medium         = <span class=\"number\">0.95</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-large          = <span class=\"number\">0.975</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-larger         = <span class=\"number\">1.</span>em;</span><br><span class=\"line\">$font-<span class=\"keyword\">size</span>-largest        = <span class=\"number\">1.125</span>em;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"8-添加网格\"><a href=\"#8-添加网格\" class=\"headerlink\" title=\"8. 添加网格\"></a>8. 添加网格</h3><ul>\n<li><p>8.1 自定义方式修改</p>\n <figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 新创建自定义文件</span></span><br><span class=\"line\">cat themes<span class=\"meta-keyword\">/next/</span>source<span class=\"meta-keyword\">/css/</span>_custom/custom.styl</span><br><span class=\"line\"><span class=\"comment\">// 主页文章添加阴影效果</span></span><br><span class=\"line\">.<span class=\"class\">post </span>&#123;</span><br><span class=\"line\">margin-top: <span class=\"number\">60</span>px;</span><br><span class=\"line\">margin-bottom: <span class=\"number\">60</span>px;</span><br><span class=\"line\"><span class=\"symbol\">padding:</span> <span class=\"number\">25</span>px;</span><br><span class=\"line\">-webkit-box-shadow: <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">5</span>px rgba(<span class=\"number\">202</span>, <span class=\"number\">203</span>, <span class=\"number\">203</span>, <span class=\"number\">.5</span>);</span><br><span class=\"line\">-moz-box-shadow: <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">5</span>px rgba(<span class=\"number\">202</span>, <span class=\"number\">203</span>, <span class=\"number\">204</span>, <span class=\"number\">.5</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 修改config文件</span></span><br><span class=\"line\">vim .<span class=\"meta-keyword\">/themes/</span>next/_config.yml</span><br><span class=\"line\"><span class=\"symbol\">custom:</span> custom</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>8.2 next6版本修改方式</p>\n<blockquote>\n<p>参考: <a href=\"https://www.jianshu.com/p/ec2e6c8a1d89\" target=\"_blank\" rel=\"noopener\">hexo6–next美化整理</a></p>\n</blockquote>\n<ol>\n<li><p>修改 themes/next/layout/_layout.swig</p>\n<figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> theme.canvas_nest %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js\"</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>将上述代码防止在&lt; /body&gt; 前就可以了(注意不要放在&lt; /head&gt;的后面)。</p>\n</blockquote>\n</li>\n<li><p>修改主题的_config.yml</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">canvas_nest</span>: true</span><br><span class=\"line\"></span><br><span class=\"line\">//color: 线条颜色, 默认: '0,0,0'；三个数字分别为(R,G,B)</span><br><span class=\"line\">//opacity: 线条透明度（0~1）, 默认: 0.5</span><br><span class=\"line\">//count: 线条的总数量, 默认: 150</span><br><span class=\"line\">//zIndex: 背景的z-index属性，css属性用于控制所在层的位置, 默认: -1</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n</li>\n</ul>\n<blockquote>\n<p>注意:<br>我这里打开提示缺少 canvas-nest.min.js文件,这里是手动copy的一份写到 source/lib/canvas-nest/canvas-nest.min.js</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">o</span>(<span class=\"params\">w,v,i</span>)</span>&#123;<span class=\"keyword\">return</span> w.getAttribute(v)||i&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">j</span>(<span class=\"params\">i</span>)</span>&#123;<span class=\"keyword\">return</span> <span class=\"built_in\">document</span>.getElementsByTagName(i)&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">l</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">var</span> i=j(<span class=\"string\">\"script\"</span>),w=i.length,v=i[w<span class=\"number\">-1</span>];<span class=\"keyword\">return</span>&#123;<span class=\"attr\">l</span>:w,<span class=\"attr\">z</span>:o(v,<span class=\"string\">\"zIndex\"</span>,<span class=\"number\">-1</span>),<span class=\"attr\">o</span>:o(v,<span class=\"string\">\"opacity\"</span>,<span class=\"number\">0.5</span>),<span class=\"attr\">c</span>:o(v,<span class=\"string\">\"color\"</span>,<span class=\"string\">\"0,0,0\"</span>),<span class=\"attr\">n</span>:o(v,<span class=\"string\">\"count\"</span>,<span class=\"number\">99</span>)&#125;&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">k</span>(<span class=\"params\"></span>)</span>&#123;r=u.width=<span class=\"built_in\">window</span>.innerWidth||<span class=\"built_in\">document</span>.documentElement.clientWidth||<span class=\"built_in\">document</span>.body.clientWidth,n=u.height=<span class=\"built_in\">window</span>.innerHeight||<span class=\"built_in\">document</span>.documentElement.clientHeight||<span class=\"built_in\">document</span>.body.clientHeight&#125;<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">b</span>(<span class=\"params\"></span>)</span>&#123;e.clearRect(<span class=\"number\">0</span>,<span class=\"number\">0</span>,r,n);<span class=\"keyword\">var</span> w=[f].concat(t);<span class=\"keyword\">var</span> x,v,A,B,z,y;t.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">i</span>)</span>&#123;i.x+=i.xa,i.y+=i.ya,i.xa*=i.x&gt;r||i.x&lt;<span class=\"number\">0</span>?<span class=\"number\">-1</span>:<span class=\"number\">1</span>,i.ya*=i.y&gt;n||i.y&lt;<span class=\"number\">0</span>?<span class=\"number\">-1</span>:<span class=\"number\">1</span>,e.fillRect(i.x<span class=\"number\">-0.5</span>,i.y<span class=\"number\">-0.5</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>);<span class=\"keyword\">for</span>(v=<span class=\"number\">0</span>;v&lt;w.length;v++)&#123;x=w[v];<span class=\"keyword\">if</span>(i!==x&amp;&amp;<span class=\"literal\">null</span>!==x.x&amp;&amp;<span class=\"literal\">null</span>!==x.y)&#123;B=i.x-x.x,z=i.y-x.y,y=B*B+z*z;y&lt;x.max&amp;&amp;(x===f&amp;&amp;y&gt;=x.max/<span class=\"number\">2</span>&amp;&amp;(i.x-=<span class=\"number\">0.03</span>*B,i.y-=<span class=\"number\">0.03</span>*z),A=(x.max-y)/x.max,e.beginPath(),e.lineWidth=A/<span class=\"number\">2</span>,e.strokeStyle=<span class=\"string\">\"rgba(\"</span>+s.c+<span class=\"string\">\",\"</span>+(A+<span class=\"number\">0.2</span>)+<span class=\"string\">\")\"</span>,e.moveTo(i.x,i.y),e.lineTo(x.x,x.y),e.stroke())&#125;&#125;w.splice(w.indexOf(i),<span class=\"number\">1</span>)&#125;),m(b)&#125;<span class=\"keyword\">var</span> u=<span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"canvas\"</span>),s=l(),c=<span class=\"string\">\"c_n\"</span>+s.l,e=u.getContext(<span class=\"string\">\"2d\"</span>),r,n,m=<span class=\"built_in\">window</span>.requestAnimationFrame||<span class=\"built_in\">window</span>.webkitRequestAnimationFrame||<span class=\"built_in\">window</span>.mozRequestAnimationFrame||<span class=\"built_in\">window</span>.oRequestAnimationFrame||<span class=\"built_in\">window</span>.msRequestAnimationFrame||<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">i</span>)</span>&#123;<span class=\"built_in\">window</span>.setTimeout(i,<span class=\"number\">1000</span>/<span class=\"number\">45</span>)&#125;,a=<span class=\"built_in\">Math</span>.random,f=&#123;<span class=\"attr\">x</span>:<span class=\"literal\">null</span>,<span class=\"attr\">y</span>:<span class=\"literal\">null</span>,<span class=\"attr\">max</span>:<span class=\"number\">20000</span>&#125;;u.id=c;u.style.cssText=<span class=\"string\">\"position:fixed;top:0;left:0;z-index:\"</span>+s.z+<span class=\"string\">\";opacity:\"</span>+s.o;j(<span class=\"string\">\"body\"</span>)[<span class=\"number\">0</span>].appendChild(u);k(),<span class=\"built_in\">window</span>.onresize=k;<span class=\"built_in\">window</span>.onmousemove=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">i</span>)</span>&#123;i=i||<span class=\"built_in\">window</span>.event,f.x=i.clientX,f.y=i.clientY&#125;,<span class=\"built_in\">window</span>.onmouseout=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;f.x=<span class=\"literal\">null</span>,f.y=<span class=\"literal\">null</span>&#125;;<span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> t=[],p=<span class=\"number\">0</span>;s.n&gt;p;p++)&#123;<span class=\"keyword\">var</span> h=a()*r,g=a()*n,q=<span class=\"number\">2</span>*a()<span class=\"number\">-1</span>,d=<span class=\"number\">2</span>*a()<span class=\"number\">-1</span>;t.push(&#123;<span class=\"attr\">x</span>:h,<span class=\"attr\">y</span>:g,<span class=\"attr\">xa</span>:q,<span class=\"attr\">ya</span>:d,<span class=\"attr\">max</span>:<span class=\"number\">6000</span>&#125;)&#125;setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;b()&#125;,<span class=\"number\">100</span>)&#125;();%</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"9-添加评论功能\"><a href=\"#9-添加评论功能\" class=\"headerlink\" title=\"9. 添加评论功能\"></a>9. 添加评论功能</h3><ul>\n<li><p>9.1 注册leancloud</p>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">注册-&gt; 验证邮箱-&gt; 实名认证 -&gt; 设置获取appid和appkey</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>9.2 修改配置文件</p>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">valine</span>:</span><br><span class=\"line\">  <span class=\"attribute\">enable</span>: true </span><br><span class=\"line\">  <span class=\"attribute\">appid</span>: <span class=\"string\">'appid'</span> </span><br><span class=\"line\">  <span class=\"attribute\">appkey</span>: <span class=\"string\">'appkey'</span> </span><br><span class=\"line\">  <span class=\"attribute\">placeholder</span>: <span class=\"string\">\"ヾﾉ≧∀≦)o 来呀！快活呀！~啦啦啦~ 啦啦啦啦~\"</span> </span><br><span class=\"line\">  <span class=\"attribute\">visitor</span>: true <span class=\"comment\">//这个打开页会统计文章阅读数</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"10-next6添加字数统计-和阅读时长\"><a href=\"#10-next6添加字数统计-和阅读时长\" class=\"headerlink\" title=\"10. next6添加字数统计 和阅读时长\"></a>10. next6添加字数统计 和阅读时长</h3><blockquote>\n<p><a href=\"https://github.com/theme-next/hexo-symbols-count-time\" target=\"_blank\" rel=\"noopener\">hexo-symbols-count-time</a></p>\n</blockquote>\n<ul>\n<li><p>10.1 安装node扩展</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm <span class=\"keyword\">install</span> hexo-symbols-<span class=\"keyword\">count</span>-<span class=\"built_in\">time</span> <span class=\"comment\">--save</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>10.2 修改全局配置 _config.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">symbols_count_time:</span></span><br><span class=\"line\"><span class=\"attr\">  symbols:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  time:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  total_symbols:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  total_time:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_codeblock:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>10.3 修改主题配置 _config.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">symbols_count_time:</span></span><br><span class=\"line\"><span class=\"attr\">  separated_meta:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  item_text_post:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  item_text_total:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">  awl:</span> <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"attr\">  wpm:</span> <span class=\"number\">275</span></span><br><span class=\"line\"><span class=\"attr\">  suffix:</span> <span class=\"string\">mins.</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"11-next6-文章置顶功能\"><a href=\"#11-next6-文章置顶功能\" class=\"headerlink\" title=\"11. next6 文章置顶功能\"></a>11. next6 文章置顶功能</h3><ul>\n<li><p>11.1 安装node扩展 </p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm <span class=\"keyword\">uninstall</span> hexo-generator-<span class=\"keyword\">index</span> <span class=\"comment\">--save</span></span><br><span class=\"line\">npm <span class=\"keyword\">install</span> hexo-generator-<span class=\"keyword\">index</span>-pin-top <span class=\"comment\">--save</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>11.2 在文章开头添加置顶标识</p>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">top:</span> <span class=\"number\">10</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>11.3 首页添加明显置顶标识</p>\n<figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\">themes/next/layout/_macro/post.swig 在<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"post-meta\"</span>&gt;</span> 下添加如下代码</span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> post.top %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">    <span class=\"tag\">&lt;<span class=\"name\">i</span> <span class=\"attr\">class</span>=<span class=\"string\">\"fa fa-thumb-tack\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">i</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"xml\">    <span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">green</span>&gt;</span>置顶<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"xml\">    <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"post-meta-divider\"</span>&gt;</span>|<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"12-next6-开启标签和分类\"><a href=\"#12-next6-开启标签和分类\" class=\"headerlink\" title=\"12. next6 开启标签和分类\"></a>12. next6 开启标签和分类</h3><ul>\n<li><p>12.1 创建tags相关目录</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new<span class=\"built_in\"> page </span>tags</span><br><span class=\"line\">hexo new<span class=\"built_in\"> page </span>categories</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>12.2 开启tags标签和分类</p>\n<figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim themes/next/_config.yml</span><br><span class=\"line\"><span class=\"keyword\">tags:</span> /tags/ || tags</span><br><span class=\"line\">categories: /categories/ || th</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>12.3 修改tags站点文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">source/tags/index.md</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">title:</span> <span class=\"string\">tags</span></span><br><span class=\"line\"><span class=\"attr\">date:</span> <span class=\"number\">2019</span><span class=\"bullet\">-09</span><span class=\"bullet\">-24</span> <span class=\"number\">10</span><span class=\"string\">:08:59</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">\"tags\"</span></span><br><span class=\"line\"><span class=\"attr\">layout:</span> <span class=\"string\">\"tags\"</span></span><br><span class=\"line\"><span class=\"attr\">comments:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>12.4 修改categories站点文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">source/categories/index.md</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">title:</span> <span class=\"string\">categories</span></span><br><span class=\"line\"><span class=\"attr\">date:</span> <span class=\"number\">2019</span><span class=\"bullet\">-09</span><span class=\"bullet\">-24</span> <span class=\"number\">10</span><span class=\"string\">:09:55</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">\"categories\"</span></span><br><span class=\"line\"><span class=\"attr\">layout:</span> <span class=\"string\">\"categories\"</span></span><br><span class=\"line\"><span class=\"attr\">comments:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>12.5 去掉xxx.github.io/tags/ 页面的post-title(因为我的这个css左对齐了,默认是居中,所以很丑)</p>\n<figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\"># 注释下面这段代码</span></span><br><span class=\"line\"><span class=\"xml\">vim themes/nextv/layout/page.swig </span></span><br><span class=\"line\"><span class=\"xml\"><span class=\"comment\">&lt;!-- </span></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">include</span></span> '_partials/page/page-header.swig' %&#125;</span><span class=\"xml\"><span class=\"comment\"> --&gt;</span></span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>12.6 文章中多个tag和categories</p>\n<figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">tags:</span></span><br><span class=\"line\">  - k8s</span><br><span class=\"line\">  - k8s安装</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - [k8s,安装]</span><br><span class=\"line\">  - [技术文档]</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","comments":true,"permalink":"https://blog.k1s.club/2019/09/19/首次搭建hexo博客系统/","categories":[{"name":"有趣","slug":"有趣","permalink":"https://blog.k1s.club/categories/有趣/"},{"name":"博客","slug":"博客","permalink":"https://blog.k1s.club/categories/博客/"},{"name":"美化","slug":"博客/美化","permalink":"https://blog.k1s.club/categories/博客/美化/"}],"tags":[{"name":"hexo6","slug":"hexo6","permalink":"https://blog.k1s.club/tags/hexo6/"},{"name":"hexo美化","slug":"hexo美化","permalink":"https://blog.k1s.club/tags/hexo美化/"}]}],"categories":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/categories/go/"},{"name":"有趣","slug":"有趣","permalink":"https://blog.k1s.club/categories/有趣/"},{"name":"博客","slug":"博客","permalink":"https://blog.k1s.club/categories/博客/"},{"name":"美化","slug":"博客/美化","permalink":"https://blog.k1s.club/categories/博客/美化/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/categories/k8s/"},{"name":"radius","slug":"radius","permalink":"https://blog.k1s.club/categories/radius/"},{"name":"windows","slug":"windows","permalink":"https://blog.k1s.club/categories/windows/"},{"name":"prometheus","slug":"k8s/prometheus","permalink":"https://blog.k1s.club/categories/k8s/prometheus/"},{"name":"gitlab-ci","slug":"gitlab-ci","permalink":"https://blog.k1s.club/categories/gitlab-ci/"},{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/categories/elk7/"},{"name":"fluentd","slug":"fluentd","permalink":"https://blog.k1s.club/categories/fluentd/"},{"name":"技术文档","slug":"技术文档","permalink":"https://blog.k1s.club/categories/技术文档/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/categories/elk/"},{"name":"elasticsearch5","slug":"elk/elasticsearch5","permalink":"https://blog.k1s.club/categories/elk/elasticsearch5/"},{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/categories/nginx/"},{"name":"问题总结","slug":"nginx/问题总结","permalink":"https://blog.k1s.club/categories/nginx/问题总结/"},{"name":"mac","slug":"mac","permalink":"https://blog.k1s.club/categories/mac/"},{"name":"item2","slug":"item2","permalink":"https://blog.k1s.club/categories/item2/"},{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/categories/linux/"},{"name":"网卡","slug":"网卡","permalink":"https://blog.k1s.club/categories/网卡/"},{"name":"raid","slug":"raid","permalink":"https://blog.k1s.club/categories/raid/"},{"name":"kubectl","slug":"k8s/kubectl","permalink":"https://blog.k1s.club/categories/k8s/kubectl/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/categories/k3s/"},{"name":"lnmp","slug":"k3s/lnmp","permalink":"https://blog.k1s.club/categories/k3s/lnmp/"},{"name":"php","slug":"php","permalink":"https://blog.k1s.club/categories/php/"},{"name":"问题总结","slug":"php/问题总结","permalink":"https://blog.k1s.club/categories/php/问题总结/"},{"name":"systemd","slug":"linux/systemd","permalink":"https://blog.k1s.club/categories/linux/systemd/"},{"name":"nfs","slug":"nfs","permalink":"https://blog.k1s.club/categories/nfs/"},{"name":"问题总结","slug":"k8s/问题总结","permalink":"https://blog.k1s.club/categories/k8s/问题总结/"},{"name":"elk5","slug":"k8s/elk5","permalink":"https://blog.k1s.club/categories/k8s/elk5/"},{"name":"logstash","slug":"elk/logstash","permalink":"https://blog.k1s.club/categories/elk/logstash/"},{"name":"shell","slug":"linux/shell","permalink":"https://blog.k1s.club/categories/linux/shell/"},{"name":"filebeat7","slug":"elk7/filebeat7","permalink":"https://blog.k1s.club/categories/elk7/filebeat7/"},{"name":"elk7","slug":"k8s/elk7","permalink":"https://blog.k1s.club/categories/k8s/elk7/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/categories/mysql/"},{"name":"主从","slug":"mysql/主从","permalink":"https://blog.k1s.club/categories/mysql/主从/"},{"name":"流量复制工具","slug":"流量复制工具","permalink":"https://blog.k1s.club/categories/流量复制工具/"},{"name":"gor","slug":"流量复制工具/gor","permalink":"https://blog.k1s.club/categories/流量复制工具/gor/"},{"name":"mysql","slug":"k8s/mysql","permalink":"https://blog.k1s.club/categories/k8s/mysql/"},{"name":"网址","slug":"网址","permalink":"https://blog.k1s.club/categories/网址/"},{"name":"收藏","slug":"网址/收藏","permalink":"https://blog.k1s.club/categories/网址/收藏/"},{"name":"markdown","slug":"markdown","permalink":"https://blog.k1s.club/categories/markdown/"},{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/categories/docker/"},{"name":"Dockerfile","slug":"docker/Dockerfile","permalink":"https://blog.k1s.club/categories/docker/Dockerfile/"},{"name":"大佬博客","slug":"网址/大佬博客","permalink":"https://blog.k1s.club/categories/网址/大佬博客/"},{"name":"awk","slug":"linux/awk","permalink":"https://blog.k1s.club/categories/linux/awk/"},{"name":"问题总结","slug":"linux/问题总结","permalink":"https://blog.k1s.club/categories/linux/问题总结/"},{"name":"存储","slug":"存储","permalink":"https://blog.k1s.club/categories/存储/"},{"name":"ceph","slug":"存储/ceph","permalink":"https://blog.k1s.club/categories/存储/ceph/"},{"name":"storageclass","slug":"k8s/storageclass","permalink":"https://blog.k1s.club/categories/k8s/storageclass/"},{"name":"nfs","slug":"存储/nfs","permalink":"https://blog.k1s.club/categories/存储/nfs/"},{"name":"二次元","slug":"有趣/二次元","permalink":"https://blog.k1s.club/categories/有趣/二次元/"},{"name":"elasticsearch7","slug":"elk/elasticsearch7","permalink":"https://blog.k1s.club/categories/elk/elasticsearch7/"}],"tags":[{"name":"go","slug":"go","permalink":"https://blog.k1s.club/tags/go/"},{"name":"hexo6","slug":"hexo6","permalink":"https://blog.k1s.club/tags/hexo6/"},{"name":"特效","slug":"特效","permalink":"https://blog.k1s.club/tags/特效/"},{"name":"k8s","slug":"k8s","permalink":"https://blog.k1s.club/tags/k8s/"},{"name":"istio","slug":"istio","permalink":"https://blog.k1s.club/tags/istio/"},{"name":"freeradius","slug":"freeradius","permalink":"https://blog.k1s.club/tags/freeradius/"},{"name":"daloradius","slug":"daloradius","permalink":"https://blog.k1s.club/tags/daloradius/"},{"name":"windows","slug":"windows","permalink":"https://blog.k1s.club/tags/windows/"},{"name":"ssh","slug":"ssh","permalink":"https://blog.k1s.club/tags/ssh/"},{"name":"promethues","slug":"promethues","permalink":"https://blog.k1s.club/tags/promethues/"},{"name":"docker","slug":"docker","permalink":"https://blog.k1s.club/tags/docker/"},{"name":"gitlab-runner","slug":"gitlab-runner","permalink":"https://blog.k1s.club/tags/gitlab-runner/"},{"name":"fluentd","slug":"fluentd","permalink":"https://blog.k1s.club/tags/fluentd/"},{"name":"elasticsearch5","slug":"elasticsearch5","permalink":"https://blog.k1s.club/tags/elasticsearch5/"},{"name":"nginx","slug":"nginx","permalink":"https://blog.k1s.club/tags/nginx/"},{"name":"mac","slug":"mac","permalink":"https://blog.k1s.club/tags/mac/"},{"name":"linux","slug":"linux","permalink":"https://blog.k1s.club/tags/linux/"},{"name":"ip","slug":"ip","permalink":"https://blog.k1s.club/tags/ip/"},{"name":"raid","slug":"raid","permalink":"https://blog.k1s.club/tags/raid/"},{"name":"kubectl","slug":"kubectl","permalink":"https://blog.k1s.club/tags/kubectl/"},{"name":"k3s","slug":"k3s","permalink":"https://blog.k1s.club/tags/k3s/"},{"name":"php5","slug":"php5","permalink":"https://blog.k1s.club/tags/php5/"},{"name":"php","slug":"php","permalink":"https://blog.k1s.club/tags/php/"},{"name":"systemd","slug":"systemd","permalink":"https://blog.k1s.club/tags/systemd/"},{"name":"elk","slug":"elk","permalink":"https://blog.k1s.club/tags/elk/"},{"name":"elk5","slug":"elk5","permalink":"https://blog.k1s.club/tags/elk5/"},{"name":"logstash","slug":"logstash","permalink":"https://blog.k1s.club/tags/logstash/"},{"name":"shell","slug":"shell","permalink":"https://blog.k1s.club/tags/shell/"},{"name":"filebeat7","slug":"filebeat7","permalink":"https://blog.k1s.club/tags/filebeat7/"},{"name":"elk7","slug":"elk7","permalink":"https://blog.k1s.club/tags/elk7/"},{"name":"mysql","slug":"mysql","permalink":"https://blog.k1s.club/tags/mysql/"},{"name":"mysql5.7","slug":"mysql5-7","permalink":"https://blog.k1s.club/tags/mysql5-7/"},{"name":"gor","slug":"gor","permalink":"https://blog.k1s.club/tags/gor/"},{"name":"http流量复制工具","slug":"http流量复制工具","permalink":"https://blog.k1s.club/tags/http流量复制工具/"},{"name":"收藏","slug":"收藏","permalink":"https://blog.k1s.club/tags/收藏/"},{"name":"网址","slug":"网址","permalink":"https://blog.k1s.club/tags/网址/"},{"name":"markdown","slug":"markdown","permalink":"https://blog.k1s.club/tags/markdown/"},{"name":"云原生","slug":"云原生","permalink":"https://blog.k1s.club/tags/云原生/"},{"name":"cloud native","slug":"cloud-native","permalink":"https://blog.k1s.club/tags/cloud-native/"},{"name":"大佬博客","slug":"大佬博客","permalink":"https://blog.k1s.club/tags/大佬博客/"},{"name":"awk","slug":"awk","permalink":"https://blog.k1s.club/tags/awk/"},{"name":"php7","slug":"php7","permalink":"https://blog.k1s.club/tags/php7/"},{"name":"ceph","slug":"ceph","permalink":"https://blog.k1s.club/tags/ceph/"},{"name":"k8s存储","slug":"k8s存储","permalink":"https://blog.k1s.club/tags/k8s存储/"},{"name":"nfs","slug":"nfs","permalink":"https://blog.k1s.club/tags/nfs/"},{"name":"storageclass","slug":"storageclass","permalink":"https://blog.k1s.club/tags/storageclass/"},{"name":"cephfs","slug":"cephfs","permalink":"https://blog.k1s.club/tags/cephfs/"},{"name":"elasticsearch7","slug":"elasticsearch7","permalink":"https://blog.k1s.club/tags/elasticsearch7/"},{"name":"hexo美化","slug":"hexo美化","permalink":"https://blog.k1s.club/tags/hexo美化/"}]}