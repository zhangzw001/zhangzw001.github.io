<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on zhangzw</title>
		<link>https://www.ngirl.xyz/posts/</link>
		<description>Recent content in Posts on zhangzw</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh-hans</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Sat, 31 Jul 2021 10:55:50 +0800</lastBuildDate>
		<atom:link href="https://www.ngirl.xyz/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>ç½‘ç»œåŸºç¡€</title>
			<link>https://www.ngirl.xyz/posts/67-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/</link>
			<pubDate>Sat, 31 Jul 2021 10:55:50 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/67-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/</guid>
			<description>unix å†å² gnu linux åˆ†æ”¯  https://futurist.se/gldt/ https://futurist.se/gldt/2012/02/20/gnulinux-distribution-timeline-12-2/  ç½‘æ¡¥(2å±‚äº¤æ¢æœº) &amp;gt; å·¥ä½œåœ¨2å±‚, ä½¿ç”¨macåœ°å€ ç½‘æ¡¥: æ¡¥æ¥ä¸¤ä¸ªç½‘ç»œ(å…¶å®å°±æ˜¯ä¸¤ä¸ªå£çš„äº¤æ¢æœº) äº¤æ¢æœº: æ¡¥æ¥å¤šä¸ªç½‘ç»œ ç½‘æ¡¥éš”ç¦»å†²çª,å‡å°‘å†²çªåŸŸ, ä½†æ˜¯ä¸èƒ½å‡å°‘å¹¿æ’­ é‚£ä¹ˆæ€ä¹ˆè§£å†³å¹¿æ’­é—®é¢˜å‘¢? -&amp;gt; é€»è¾‘åœ°å€:ipåŒ… + è·¯ç”±å™¨ åŒä¸€ç½‘ç»œå†…éƒ¨çš„é€šä¿¡ ä¼šå…ˆé€šè¿‡arpå¹¿æ’­, æ‰¾åˆ°é€šä¿¡çš„ipçš„macåœ°å€ é‚£ä¹ˆæ€ä¹ˆçŸ¥é“ipæ˜¯æœ¬åœ°ç½‘ç»œ, è¿˜æ˜¯å…¶ä»–ç½‘ç»œ: ç½‘ç»œåœ°å€ å’Œæœ¬æœºåœ°å€ é‚£æ€ä¹ˆçŸ¥é“é‚£éƒ¨åˆ†æ˜¯ç½‘ç»œåœ°å€, è¿˜æ˜¯æœ¬æœºåœ°å€å‘¢? - å­ç½‘æ©ç  å­ç½‘æ©ç å¯ä»¥é€šè¿‡ipåœ°å€ å–åˆ° ç½‘ç»œåœ°å€ socket ip:port =&amp;gt; å¥—æ¥å­— å¥—æ¥å­—å°±æ˜¯tcp/ipåè®®ä¸­ç”¨äºé€šä¿¡çš„ä¸¤ä¸ªç«¯ç‚¹, æœ‰server socket, client socket TCP : Transmission Control Protocol UDP : User Datagram Protocol  identification(fragment id) : å¦‚æœæŠ¥æ–‡è¿‡å¤§(1500byte), æœåŠ¡ç«¯åªèƒ½æ¥å—500(éœ€è¦åˆ‡ç‰‡å‘é€), identification å°±ç”¨æ¥æ ‡è®°æ˜¯åŒä¸€ä¸ªæŠ¥æ–‡
fragment offset : å°±æ˜¯ä¸‰ä¸ªåˆ‡ç‰‡çš„åç§»é‡, ä¿è¯åˆ‡ç‰‡çš„é¡ºåº</description>
			<content type="html"><![CDATA[<h3 id="unix-å†å²">unix å†å²</h3>
<p><img src="/images/67/markdown-img-paste-20210621114801593.png" alt=""></p>
<h3 id="gnu-linux-åˆ†æ”¯">gnu linux åˆ†æ”¯</h3>
<ul>
<li><a href="https://futurist.se/gldt/">https://futurist.se/gldt/</a></li>
<li><a href="https://futurist.se/gldt/2012/02/20/gnulinux-distribution-timeline-12-2/">https://futurist.se/gldt/2012/02/20/gnulinux-distribution-timeline-12-2/</a></li>
</ul>
<p><img src="/images/67/markdown-img-paste-2021062114112618.png" alt=""></p>
<h3 id="ç½‘æ¡¥2å±‚äº¤æ¢æœº">ç½‘æ¡¥(2å±‚äº¤æ¢æœº)</h3>
<pre><code>&gt; å·¥ä½œåœ¨2å±‚, ä½¿ç”¨macåœ°å€

ç½‘æ¡¥: æ¡¥æ¥ä¸¤ä¸ªç½‘ç»œ(å…¶å®å°±æ˜¯ä¸¤ä¸ªå£çš„äº¤æ¢æœº)
äº¤æ¢æœº: æ¡¥æ¥å¤šä¸ªç½‘ç»œ

ç½‘æ¡¥éš”ç¦»å†²çª,å‡å°‘å†²çªåŸŸ, ä½†æ˜¯ä¸èƒ½å‡å°‘å¹¿æ’­
é‚£ä¹ˆæ€ä¹ˆè§£å†³å¹¿æ’­é—®é¢˜å‘¢?

-&gt; é€»è¾‘åœ°å€:ipåŒ… + è·¯ç”±å™¨

åŒä¸€ç½‘ç»œå†…éƒ¨çš„é€šä¿¡ ä¼šå…ˆé€šè¿‡arpå¹¿æ’­, æ‰¾åˆ°é€šä¿¡çš„ipçš„macåœ°å€

é‚£ä¹ˆæ€ä¹ˆçŸ¥é“ipæ˜¯æœ¬åœ°ç½‘ç»œ, è¿˜æ˜¯å…¶ä»–ç½‘ç»œ:
ç½‘ç»œåœ°å€ å’Œæœ¬æœºåœ°å€
é‚£æ€ä¹ˆçŸ¥é“é‚£éƒ¨åˆ†æ˜¯ç½‘ç»œåœ°å€, è¿˜æ˜¯æœ¬æœºåœ°å€å‘¢?  - å­ç½‘æ©ç 
å­ç½‘æ©ç å¯ä»¥é€šè¿‡ipåœ°å€ å–åˆ° ç½‘ç»œåœ°å€

</code></pre><h3 id="socket">socket</h3>
<pre><code>ip:port =&gt; å¥—æ¥å­—
å¥—æ¥å­—å°±æ˜¯tcp/ipåè®®ä¸­ç”¨äºé€šä¿¡çš„ä¸¤ä¸ªç«¯ç‚¹, æœ‰server socket, client socket

TCP : Transmission Control Protocol
UDP : User Datagram Protocol
</code></pre><p><img src="/images/67/markdown-img-paste-20210621164945488.png" alt=""></p>
<blockquote>
<p>identification(fragment id) : å¦‚æœæŠ¥æ–‡è¿‡å¤§(1500byte), æœåŠ¡ç«¯åªèƒ½æ¥å—500(éœ€è¦åˆ‡ç‰‡å‘é€), identification å°±ç”¨æ¥æ ‡è®°æ˜¯åŒä¸€ä¸ªæŠ¥æ–‡</p>
<p>fragment offset : å°±æ˜¯ä¸‰ä¸ªåˆ‡ç‰‡çš„åç§»é‡, ä¿è¯åˆ‡ç‰‡çš„é¡ºåº</p>
<p>Protocol : ä¸Šå±‚çš„åè®®(tcp,udp,icmp?)</p>
<p>Data : åº”ç”¨å±‚header+ä¼ è¾“å±‚header+data</p>
</blockquote>
<p><img src="/images/67/markdown-img-paste-20210621174204921.png" alt=""></p>
<blockquote>
<p>Sequence Number : åºåˆ—å·</p>
<p>Acknowledgement Number : ç¡®è®¤å·</p>
<p>URG ç´§æ€¥ä½
ACK ç¡®è®¤ä½
PSH æ¨é€ä½(ä¸èƒ½æ”¾åˆ°ç¼“å­˜,ç«‹å³å‘é€,ä¼˜å…ˆä¼ è¾“)
RST é‡ç½®ä½(è¿æ¥é‡ç½®, ä¸éœ€è¦å®Œå…¨ä¸‰æ¬¡æ¡æ‰‹)
SYN
FIN</p>
<p>Window Size : åå®šæ¥æ”¶æ–¹çš„ç¼“å†²ä¸­èƒ½å®¹é‡çš„æŠ¥æ–‡çš„ä¸ªæ•°</p>
</blockquote>
<blockquote>
<p>tcpçš„æœ‰é™çŠ¶æ€æœº</p>
</blockquote>
<h3 id="tcp">tcp</h3>
<h4 id="tcp-ä¸‰æ¬¡æ¡æ‰‹">tcp ä¸‰æ¬¡æ¡æ‰‹</h4>
<pre><code>1. client -&gt; SYN=1,seq num=x                    -&gt; server
2. client &lt;- SYN=1,ACK=1,ack num=x+1, seq num=y &lt;- server
3. client -&gt; ACK=1,ack num=y+1                  &lt;- server
</code></pre><h4 id="tcp-å››æ¬¡æŒ¥æ‰‹">tcp å››æ¬¡æŒ¥æ‰‹</h4>
<p><img src="/images/67/markdown-img-paste-20210629100443918.png" alt=""></p>
<h4 id="çŠ¶æ€">çŠ¶æ€</h4>
<pre><code>client:
    -&gt;  closed -&gt; syn_send -&gt; established
        â†‘                            â†“
        time_wait &lt;- fin_wait2 &lt;- fin_wait1
server:
    -&gt; listen -&gt; syn_recv -&gt; established
        â†‘                           â†“
      closed &lt;-   last_ack   &lt;-  close_wait      

</code></pre><h3 id="a-b-c-ç±»">A B C ç±»</h3>
<pre><code>A : 0xxxxxxx.X.X.X
B : 10xxxxxx.X.X.X
C : 110xxxxx.X.X.X

ç§æœ‰A : 10.X.X.X  10.0.0.0/8
ç§æœ‰B : 172.0001xxxx.X.X      172.16.0.0/12
ç§æœ‰C : 192.168.X.X   192.168.0.0/24
</code></pre><h3 id="ç½‘ç»œåˆ’åˆ†">ç½‘ç»œåˆ’åˆ†</h3>
<ul>
<li>åˆ’åˆ†å­ç½‘</li>
<li>åˆå¹¶è¶…ç½‘</li>
</ul>
<pre><code>éœ€è¦ä¸¤ä¸ªç½‘æ®µæœ‰å…±åŒçš„ç½‘ç»œid(æ¯”å¦‚10.0.0.0/8 å’Œ172.20.0.0/16 æ— æ³•åˆå¹¶)
</code></pre><h3 id="lo-å›ç¯ç½‘å¡">lo å›ç¯ç½‘å¡</h3>
<pre><code>æ°¸è¿œä¸ä¼šè·‘åˆ°åˆ«çš„æœºå™¨ 127.0.0.1/8  çš„æ‰€æœ‰ç½‘æ®µip ,pingéƒ½æ˜¯æœ¬æœº
ping 127.0.0.1
ping 127.1.2.3

å½“ç„¶æˆ‘ä»¬å¯ä»¥è‡ªå·±ç»™loç»‘å®šä¸€ä¸ªipç½‘æ®µ
ip addr add 1.0.0.1/8
æ­¤æ—¶æˆ‘ä»¬ping 1.0.0.1 æˆ– ping 1.1.0.1 éƒ½å°†æ˜¯pingæœ¬æœº
</code></pre><h3 id="è·¨ç½‘ç»œé€šä¿¡">è·¨ç½‘ç»œé€šä¿¡</h3>
<pre><code>1 ä¸»æœºè·¯ç”±: åˆ°è¾¾ä¸»æœºipçš„è·¯ç”±
2 ç½‘ç»œè·¯ç”±: åˆ°è¾¾ç½‘æ®µçš„è·¯ç”±
3 é»˜è®¤è·¯ç”±: æ‰¾ä¸åˆ°çš„è·¯ç”±èµ°é»˜è®¤è·¯ç”±, ipv4é…ç½®gatewayå…¶å®å°±æ˜¯æ·»åŠ ä¸€å¤©é»˜è®¤è·¯ç”±
&gt; ä¼˜å…ˆçº§: 1 &gt; 2 &gt; 3
</code></pre><blockquote>
<p>å¦‚ä¸‹ä¾‹å­:</p>
</blockquote>
<pre><code>$ route -n
Kernel IP routing table
Destination     Gateway          Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.20.100.1     0.0.0.0         UG    100    0        0 em1             //é»˜è®¤è·¯ç”±
172.20.100.0     0.0.0.0         255.255.252.0   U     100    0        0 em1             //ç½‘ç»œè·¯ç”±
172.17.0.0      0.0.0.0          255.255.0.0     U     0      0        0 docker0
192.168.0.0     0.0.0.0          255.255.255.0   U     0      0        0 *
192.168.0.95    0.0.0.0          255.255.255.255 UH    0      0        0 cali40c9bc493ea //ä¸»æœºè·¯ç”±
192.168.1.0     172.20.100.221   255.255.255.0   UG    0      0        0 tunl0           //éç›´è¿ç½‘ç»œè·¯ç”±
</code></pre><h3 id="è·¯ç”±è¡¨çš„æ„æˆ">è·¯ç”±è¡¨çš„æ„æˆ</h3>
<pre><code>1. Destination(ç›®æ ‡): æ•°æ®åŒ…çš„ç›®æ ‡è·¯å¾„
2. NetMask(å­ç½‘æ©ç ):  åˆ’åˆ†ç½‘ç»œçš„å­ç½‘æ©ç 
3. Interface(æ¥å£):   æœ¬è·¯ç”±å™¨çš„å‡ºå£(è°å‘é€æ•°æ®åŒ…)
4. Gateway(ç½‘å…³):
    1) ç›´è¿:  ç½‘å…³ä¸ç”¨é…ç½®(é€šå¸¸æ˜¯0.0.0.0),å¹¶ä¸”è·¯ç”±ä¼šè‡ªåŠ¨æ·»åŠ 
    2) éç›´è¿: ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ é‚»è¿‘æœ¬è·¯ç”±å™¨çš„ç½‘ç»œåœ°å€
</code></pre><p><img src="/images/67/markdown-img-paste-20210618152726982.png" alt=""></p>
<pre><code># A--- 1 R1 2 --- 3 R2 4 --- 5 R3 6 --- B

0. A æµè§ˆå™¨æ‰“å¼€ http://B
1. A åˆ¤æ–­B å’ŒA æ˜¯å¦åœ¨åŒä¸€ä¸ªç½‘æ®µ
2. A (å­˜åœ¨è·¯ç”± 0.0.0.0 gateway:R1 IP1 interfaceA),
    A é€šè¿‡arpåè®®å¹¿æ’­æ‰¾åˆ° IP1çš„MAC1åœ°å€, ç„¶åå­˜å…¥åˆ°arp cacheä¸­: IP1 -&gt; MAC1
    æ­¤æ—¶å°±å¯ä»¥ä¼ è¾“æŠ¥æ–‡ç»™R1:
    frame:  dest mac: MAC1 ,    src mac: MACA
    ip:     dest ip : IPB,      src ip : IPA
    tcp:    dest port:80,       src post:xxxxx , SYN
3. R1 æŸ¥è·¯ç”±è¡¨(æ”¶åˆ°æ•°æ®)
    ç½‘ç»œè·¯ç”±: 0.0.0.0 gateway:R2 IP3 interfaceR1(2)

    R1 é€šè¿‡arpåè®®å¹¿æ’­æ‰¾åˆ° R2çš„MAC3åœ°å€, ç„¶åå­˜å…¥åˆ°arp cacheä¸­: IP3 -&gt; MAC3
    æ­¤æ—¶å°±å¯ä»¥ä¼ è¾“æŠ¥æ–‡ç»™R2:
    frame:  dest mac: MAC3 ,    src mac: MAC2  (è¿™é‡Œåœ¨å˜, æ•°æ®é“¾è·¯å±‚æ˜¯ä¸€æ®µä¸€æ®µçš„ä¼ è¾“çš„)
    ip:     dest ip : IPB,      src ip : IPA
    tcp:    dest port:80,       src post:xxxxx , SYN
4. R2 æŸ¥è·¯ç”±è¡¨(æ”¶åˆ°æ•°æ®)
    ç½‘ç»œè·¯ç”±: 0.0.0.0 gateway:R3 IP5 interfaceR2(4)

    R2 é€šè¿‡arpåè®®å¹¿æ’­æ‰¾åˆ° R3çš„MAC5åœ°å€, ç„¶åå­˜å…¥åˆ°arp cacheä¸­: IP5 -&gt; MAC5
    æ­¤æ—¶å°±å¯ä»¥ä¼ è¾“æŠ¥æ–‡ç»™R3:
    frame:  dest mac: MAC5 ,    src mac: MAC4  (è¿™é‡Œåœ¨å˜, æ•°æ®é“¾è·¯å±‚æ˜¯ä¸€æ®µä¸€æ®µçš„ä¼ è¾“çš„)
    ip:     dest ip : IPB,      src ip : IPA
    tcp:    dest port:80,       src post:xxxxx , SYN
5. R3 æŸ¥è·¯ç”±è¡¨(æ”¶åˆ°æ•°æ®)
    ç½‘ç»œè·¯ç”±: ç›´è¿ IPB

    R3 é€šè¿‡arpåè®®å¹¿æ’­æ‰¾åˆ° Bçš„MACBåœ°å€, ç„¶åå­˜å…¥åˆ°arp cacheä¸­: IPB -&gt; MACB
    æ­¤æ—¶å°±å¯ä»¥ä¼ è¾“æŠ¥æ–‡ç»™B:
    frame:  dest mac: MACB ,    src mac: MAC6  (è¿™é‡Œåœ¨å˜, æ•°æ®é“¾è·¯å±‚æ˜¯ä¸€æ®µä¸€æ®µçš„ä¼ è¾“çš„)
    ip:     dest ip : IPB,      src ip : IPA
    tcp:    dest port:80,       src post:xxxxx , SYN

</code></pre><h3 id="dhcp">dhcp</h3>
<pre><code>1 client -&gt; å®¢æˆ·ç«¯å¹¿æ’­,å‘ç°æŠ¥æ–‡ -&gt; server
2 client &lt;- æœåŠ¡ç«¯å¹¿æ’­,æä¾›æ¶ˆæ¯ &lt;- server
3 client -&gt; å®¢æˆ·ç«¯å¯¹è¯·æ±‚æ¶ˆæ¯åšå‡ºç›¸åº”ack -&gt; server
4 client &lt;- æœåŠ¡å™¨ç¡®è®¤æ¶ˆæ¯,ç»“æŸäº¤æ¢è¿‡ç¨‹ &lt;- server

&gt; æå‰ä¸€åŠæ—¶é—´ç»­çº¦
</code></pre><h3 id="centos6ä¿®æ”¹ç½‘å¡è§„åˆ™ä¸é‡å¯æ›´æ–°æ–¹æ³•">centos6ä¿®æ”¹ç½‘å¡è§„åˆ™ä¸é‡å¯æ›´æ–°æ–¹æ³•</h3>
<pre><code># ä¿®æ”¹NAME
vim /etc/udev/rules.d/70-persistent-net.rules
# æŸ¥çœ‹ eth0çš„driver
ethtool -i eth0
# å¸è½½ driver
modprobe -r ${driverName}
# ifconfig å°±çœ‹ä¸åˆ°ç½‘å¡äº†
# é‡æ–°åŠ è½½driver
modprobe ${driverName}
</code></pre><h3 id="åŠ¨æ€è·¯ç”±">åŠ¨æ€è·¯ç”±</h3>
<pre><code>RIP: æ ¹æ®ç»è¿‡è·¯ç”±å™¨ä¸ªæ•°åˆ¤æ–­é€‰æ‹©èµ°å“ªæ¡è·¯çº¿
OSPF: æ ¹æ®ä¸åŒå› ç´ é€‰æ‹©è·¯çº¿, è€ƒè™‘è·¯ç”±å™¨ä¸ªæ•°,å¸¦å®½å¤§å°ç­‰ç­‰
BGP:

&gt; linuxå½“åšè·¯ç”±å™¨ä½¿ç”¨,é…ç½®å·¥å…·:
yum install quagga
</code></pre><h3 id="è·¯ç”±å®éªŒ">è·¯ç”±å®éªŒ</h3>
<pre><code>ping 10.0.0.100 çš„æ—¶å€™ ttl=62, ç»è¿‡äº†ä¸¤ä¸ªè·¯ç”±
traceroute 10.0.0.100 ç»è¿‡çš„
mtr 10.0.0.100
</code></pre><p><img src="/images/67/markdown-img-paste-20210618181247554.png" alt=""></p>
<h3 id="è·¯ç”±å‘½ä»¤">è·¯ç”±å‘½ä»¤</h3>
<pre><code>route add -net  192.168.10.0/24 gw 172.16.0.6
</code></pre><h3 id="dhcp-1">dhcp</h3>
<pre><code>æŠŠä¸€ä¸ªä¸»æœºæ¥å…¥tcp/ipç½‘ç»œ,è¦é…ç½®å“ªäº›å‚æ•°
    ip/NetMask
    gateway
    dns

    å‚æ•°é…ç½®æ–¹å¼
        é™æ€é…ç½®
        åŠ¨æ€åˆ†é…
            bootp : boot protocol
            dhcp : å¼•å…¥äº†&quot;ç§Ÿçº¦&quot;çš„bootp,ä¹Ÿå¯ä»¥ä¸ºç‰¹å®šä¸»æœºä¿ç•™å›ºå®šçš„åœ°å€

dhcp : åŠ¨æ€ä¸»æœºé…ç½®åè®®
    å·¥ä½œæµç¨‹(å¹¿æ’­)
        1) client: dhcp discover
        2) server: dhcp offer(ip/NetMask,gw,...)
            lease time: ç§Ÿçº¦æœŸé™
        3) client: dhcp request
        4) server: dhcp ack
    ç»­ç§Ÿ(å•æ’­)
        å‰©ä½™æ—¶é—´: 50%,75%,87.5%
        å·¥ä½œæµç¨‹
            dhcp request
            dhcp ack

            dhcp request
            dhcp nak

            dhcp discover : å¹¿æ’­

</code></pre>]]></content>
		</item>
		
		<item>
			<title>Linuxè®¡ç®—æœºåŸºç¡€</title>
			<link>https://www.ngirl.xyz/posts/66-linux%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/</link>
			<pubDate>Sat, 31 Jul 2021 10:47:24 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/66-linux%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/</guid>
			<description>è®¡ç®—æœºåŸºç¡€ è¿›ç¨‹ process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬ è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹ ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢? task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼ task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct è¿›ç¨‹åˆ›å»º init çˆ¶å­å…³ç³» è¿›ç¨‹ fork() ,clone() CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶) å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰ è¿›ç¨‹ä¼˜å…ˆçº§(priority) 0-139: 1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜) 100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜) Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§ -20,19(å¯¹åº”100-139) 2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ— è¿›ç¨‹å†…å­˜ page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨ è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´ ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame IPC : inter Process Communication åŒä¸€ä¸»æœºä¸Š: signal shm : shared memory semerphor : ä¸åŒä¸»æœºä¸Š: rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ socket : https://blog.</description>
			<content type="html"><![CDATA[<h2 id="è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€</h2>
<h3 id="è¿›ç¨‹">è¿›ç¨‹</h3>
<pre><code>process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬

è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹
ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢?

task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼
task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct
</code></pre><p><img src="/images/66/markdown-img-paste-20210624115848639.png" alt=""></p>
<pre><code>è¿›ç¨‹åˆ›å»º
    init
        çˆ¶å­å…³ç³»
        è¿›ç¨‹
            fork() ,clone()
            CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶)
        å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰
    è¿›ç¨‹ä¼˜å…ˆçº§(priority)
        0-139:
            1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜)
            100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
            Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§
                -20,19(å¯¹åº”100-139)
        2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ—

    è¿›ç¨‹å†…å­˜
        page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨
        è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´
        ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame

    IPC : inter Process Communication
        åŒä¸€ä¸»æœºä¸Š:
            signal
            shm : shared memory
            semerphor :
        ä¸åŒä¸»æœºä¸Š:
            rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨
            socket : https://blog.csdn.net/pashanhu6402/article/details/96428887
</code></pre><h4 id="ps">ps</h4>
<pre><code>pså‘½ä»¤
    /proc/ å†…æ ¸çŠ¶æ€ä¿¡æ¯
        å†…æ ¸å‚æ•°:
            å¯è®¾ç½®å™¨å€¼çš„å‚æ•°  /proc/sys/
            çŠ¶æ€å˜é‡, ä»…æŸ¥çœ‹
        å‚æ•°: æ¨¡æ‹Ÿæˆæ–‡ä»¶ç³»ç»Ÿç±»å‹
    è¿›ç¨‹:
        /proc/[0-9]+ :
            [0-9]+ : pidç›®å½•

    ä¸‰ç§é£æ ¼:
        1   UNIX options, which may be grouped and must be preceded by a dash.
        2   BSD options, which may be grouped and must not be used with a dash.
        3   GNU long options, which are preceded by two dashes.
    å¯åŠ¨è¿›ç¨‹çš„æ–¹å¼:
        1. ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­è‡ªåŠ¨å¯åŠ¨, ä¸ç»ˆç«¯æ— å…³
        2. ç»ˆç«¯å¯åŠ¨, è¿›ç¨‹ä¼šéšç»ˆç«¯é€€å‡ºè€Œé€€å‡º

    é€‰é¡¹:
        1. a : æ‰€æœ‰ä¸ç»ˆç«¯ç›¸å…³çš„è¿›ç¨‹
        2. x : æ‰€æœ‰ä¸ç»ˆç«¯æ— å…³çš„è¿›ç¨‹
            $ ps ax|head -1
            PID TTY      STAT   TIME COMMAND
            1 ?        Ss    14:26 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
            2 ?        S      0:00 [kthreadd]
                å¸¦ä¸­æ‹¬å·çš„æ˜¯å†…æ ¸çº¿ç¨‹
        3. u : ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒ  ç»„ç»‡çŠ¶æ€ä¿¡æ¯æ˜¾ç¤º
            # å¸¸ç”¨ç»„åˆ1
            $ ps aux|head -1
            USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
                1. VSZ è™šæ‹Ÿå†…å­˜é›†
                2. RSS ResIdent Size å¸¸é©»å†…å­˜;
                3. STAT
                    R : running
                    S : Interruptable sleeping
                    D : UnInterruptable sleeping
                    T : Stopped
                    Z : zomble çˆ¶è¿›ç¨‹æœªæ¸…ç†æ—¶å°±ä¼šä¸€ç›´ä¿æŒåƒµå°¸æ€
                    + : å‰å°è¿›ç¨‹
                    l : å¤šçº¿ç¨‹è¿›ç¨‹
                    N : ä½ä¼˜å…ˆçº§è¿›ç¨‹(nice)
                    &lt; : é«˜ä¼˜å…ˆçº§è¿›ç¨‹
                    s : session leader
        4. -e : æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹
        5. -f : æ˜¾ç¤ºå®Œæ•´æ ¼å¼
            # å¸¸ç”¨ç»„åˆ2
            $ ps -ef |head -1
            UID        PID  PPID  C STIME TTY          TIME CMD
        6. -F : æ˜¾ç¤ºå®Œæ•´æ ¼å¼
            #
            $ ps -eF |head -1
            UID        PID  PPID  C    SZ   RSS PSR STIME TTY          TIME CMD
            C : cpu utillization
            PSR : è¿è¡Œåœ¨å“ªä¸ªcpuä¸Š
        7 -H : ä»¥å±‚çº§ç»“æ„æ˜¾ç¤ºè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯
            # å¸¸ç”¨ç»„åˆ3
            ps -eFH
            $ å¸¸ç”¨ç»„åˆ4 -eo, axo
                o field1,field2: è‡ªå®šä¹‰è¦æ˜¾ç¤ºçš„å­—æ®µåˆ—è¡¨, é€—å·åˆ†éš”
                    å¸¸ç”¨çš„field: pid, ni,pri,psr,pcpu,stat,comm,tty,ppid,rtprio
                    pri : priority ä¼˜å…ˆçº§
                    rtprio read time priority å®æ—¶ä¼˜å…ˆçº§
                ps axo pid,command
</code></pre><h4 id="vmstat">vmstat</h4>
<pre><code>$ vmstat -w 1
procs -----------------------memory---------------------- ---swap-- -----io---- -system-- --------cpu--------
 r  b         swpd         free         buff        cache   si   so    bi    bo   in   cs  us  sy  id  wa  st
</code></pre><pre><code>memory
    swpd : äº¤æ¢å†…å­˜ä½¿ç”¨æ€»é‡
    free : ç©ºé—²
    buff : ç”¨äºbuffer
    cache : ç”¨æˆ·cache
swap
    si (swap in) : æ¢è¿›,è¿›å…¥swapçš„é€Ÿç‡(kb/s),å†…å­˜è¿›swap
    so (swap out): æ¢å‡º,ç¦»å¼€swapçš„é€Ÿç‡(kb/s),swapå›å†…å­˜
io
    bi (block in): ä»å—è®¾å¤‡è¯»å–åˆ°å†…å­˜çš„é€Ÿç‡(kb/s)
    bo (block out): ä¿å­˜æ•°æ®è‡³å—è®¾å¤‡çš„é€Ÿç‡
system
    in (interrupts) : ä¸­æ–­é€Ÿç‡
    cs (context switch) : ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿç‡
</code></pre><pre><code>-w å®½æ˜¾ç¤º
-s æ˜¾ç¤ºå†…å­˜ç»Ÿè®¡æ•°æ®

</code></pre><h4 id="pmap">pmap</h4>
<pre><code>pmap 1
    -x : æ˜¾ç¤ºè¯¦ç»†æ ¼å¼ä¿¡æ¯

å¦ä¸€ç§æŸ¥çœ‹æ–¹å¼: cat /proc/1/maps
</code></pre><h4 id="dstat-å¼ºå¤§">dstat (å¼ºå¤§ğŸ‘)</h4>
<pre><code>$ dstat
You did not select any stats, using -cdngy by default.
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw
</code></pre><h3 id="ç½‘ç»œå®¢æˆ·ç«¯">ç½‘ç»œå®¢æˆ·ç«¯</h3>
<h4 id="hping">hping</h4>
<h3 id="linuxå†…æ ¸">Linuxå†…æ ¸</h3>
<h4 id="å†…æ ¸è®¾è®¡æµæ´¾">å†…æ ¸è®¾è®¡æµæ´¾</h4>
<pre><code>å•å†…æ ¸è®¾è®¡: linux
å¾®å†…æ ¸è®¾è®¡: Winodows,Solaris
</code></pre><h4 id="linuxå†…æ ¸ç‰¹ç‚¹">Linuxå†…æ ¸ç‰¹ç‚¹</h4>
<pre><code>æ”¯æŒæ¨¡å—åŒ–:  *.ko(kernel object)
&gt; å¦å¤–ä¸€ä¸ªå¯¹è±¡: *.so(share object)

æ”¯æŒæ¨¡å—è¿è¡Œæ—¶åŠ¨æ€è£…è½½æˆ–å¸è½½
</code></pre><h4 id="ç»„æˆéƒ¨åˆ†">ç»„æˆéƒ¨åˆ†</h4>
<pre><code>æ ¸å¿ƒæ–‡ä»¶: /boot/vmlinuz-VERSION-release
ramdisk:
  - centos5: /boot/initrd-VERSION-release.Img
    - å·¥å…·è‡ªåŠ¨åˆ›å»º: mkinitrd
  - centos6,7 : /boot/Initramfs-VERSION-release.Img
    - å·¥å…·è‡ªåŠ¨åˆ›å»º: dracut,mkinitrd(åªæ˜¯ä¸ºäº†å…¼å®¹,å°è£…dracut)

æ¨¡å—æ–‡ä»¶: /lib/modules/VERSION-release
</code></pre><ul>
<li>ramdisk</li>
</ul>
<pre><code>centos5çš„ rd=ramdisk, æ˜¯æŠŠå†…å­˜å½“åšç£ç›˜ä½¿ç”¨
centos6,7çš„ramfs=ramçš„æ–‡ä»¶ç³»ç»Ÿ
ramdiskæ˜¯æŠŠå†…å­˜å½“åšç£ç›˜ä½¿ç”¨, æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ç£ç›˜ä¸€èˆ¬ä¼šå…ˆåŠ è½½åˆ°å†…å­˜(buffer/cache),ç„¶ååœ¨ä½¿ç”¨, ä¸ºäº†è¯»å–æ›´å¿«
ä½†æ˜¯ramdiskçš„æ¨¡å¼ä¸‹ç£ç›˜å°±æ˜¯å†…å­˜,è¯»å–ä¹‹å‰å†æ¬¡åŠ è½½åˆ°bufferå°±æ²¡æœ‰æ„ä¹‰äº†
å› æ­¤centos6,7 ä½¿ç”¨ramçš„æ–‡ä»¶ç³»ç»Ÿ

ramdisk å…¶å®æ˜¯ä¸€ä¸ªç®€è£…ç‰ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
</code></pre><h4 id="centosç³»ç»Ÿmbrå¯åŠ¨æµç¨‹">centosç³»ç»Ÿmbrå¯åŠ¨æµç¨‹:</h4>
<pre><code>1. POST: åŠ ç”µè‡ªæ£€; (è¿™æ˜¯ä¸€æ®µcpuåœ¨ç”Ÿäº§çš„æ—¶å€™çƒ§å†™çš„ç¨‹åº)
    - ROM: CMOS
        - BIOS: Basic Input and Output System
    - ROM+RAM: CPUå¯ä»¥è®¿é—®çš„å¯»å€ç©ºé—´
2. Boot Sequence:
    - æŒ‰æ¬¡åºæŸ¥æ‰¾å„å¼•å¯¼è®¾å¤‡, ç¬¬ä¸€ä¸ªæœ‰å¼•å¯¼ç¨‹åºçš„è®¾å¤‡å³ä¸ºæœ¬æ¬¡å¯åŠ¨è¦ç”¨åˆ°çš„è®¾å¤‡(uç›˜, ç£ç›˜)
    - bootloader: å¼•å¯¼åŠ è½½å™¨,å°±æ˜¯æˆ‘ä»¬å®‰è£…åˆ°ç£ç›˜æˆ–è€…uç›˜ä¸Šçš„ç¨‹åº
            - Windows : ntloader
            - Linux:
            - LILO : LInux LOader (ç£ç›˜å¤§äº1024æŸ±é¢æ— æ³•åŠ è½½,ç›®å‰å®‰å“æ‰‹æœº)
            - GRUB : Grand Uniform Bootloader
                - GRUB 0.X(centos[56]) -&gt; é‡å Grub legacy
                - GRUB 1.X(centos7) -&gt; å®Œå…¨é‡æ–°,é‡å Grub2
                - åŠŸèƒ½: æä¾›ä¸€ä¸ªèœå•,å…è®¸ç”¨æˆ·é€‰æ‹©è¦å¯åŠ¨çš„ç³»ç»Ÿæˆ–ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬;æŠŠå†…æ ¸è£…è½½åˆ°RAMçš„ç‰¹å®šç©ºé—´, è§£å‹,æŠŠç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™å†…æ ¸
        - MBR : Master Boot Record
            - 512bytes:
            - 446bytes : bootloader,ä»£ç é‡å°,ä¸æ”¯æŒåŠ è½½é€»è¾‘åˆ†åŒº
            - 64bytes : fat åˆ†åŒºè¡¨
            - 2bytes : 55AA=æœ‰æ•ˆ,å…¶ä»–XXXX=æ— æ•ˆ
        - GRUB : ç”±äº446byteså¤ªå°äº†, grubé‡æ–°è®¾è®¡
            - bootloader : ç¬¬1é˜¶æ®µ,ä»¥å‰çš„bootloaderç›®çš„éƒ½æ˜¯ç›´æ¥è¯»å–446bytesè£…è½½å†…æ ¸åˆ°ramç©ºé—´,ç„¶åæ§åˆ¶æƒäº¤ç»™å†…æ ¸, grubçš„bootloaderä½œä¸ºç¬¬ä¸€æ­¥,ä¸»è¦å°±æ˜¯ä¸ºäº†ç¬¬äºŒéƒ¨,åŠ è½½/boot/grub,è¿™æ®µç¨‹åºå°±å¯ä»¥ä¸å—MBR446bytesé™åˆ¶,å¯ä»¥æ“ä½œæ€§å¼º, ç”šè‡³å¯ä»¥æä¾›å¯äº¤äº’çš„uiç•Œé¢
            - Partition filesystem driver: 1.5 é˜¶æ®µ ? ä¸ºä»€ä¹ˆéœ€è¦?
            - partition : /boot/grub , ç¬¬2é˜¶æ®µ,æ­¤æ—¶è¯¥æ­¥éª¤çš„uiç•Œé¢é€‰æ‹©å®Œå†…æ ¸ä¹‹å,è§£å‹,æŠŠç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™å†…æ ¸
        - äº†è§£ EFI(UEFI) GPT :
3. åŠ è½½Kernel: å†…æ ¸è·å¾—æ§åˆ¶æƒå
        - è‡ªèº«åˆå§‹åŒ–
            - æ¢æµ‹å¯è¯†åˆ«åˆ°çš„æ‰€æœ‰ç¡¬ä»¶è®¾å¤‡
            - åŠ è½½ç¡¬ä»¶é©±åŠ¨ç¨‹åº(æœ‰å¯èƒ½å€ŸåŠ©äºramdisk)
            - ä»¥åªè¯»æ–¹å¼æŒ‚è½½è·Ÿæ–‡ä»¶ç³»ç»Ÿ(rootfs)
            - è¿è¡Œç”¨æˆ·æ§ä»¶çš„ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº: /sbin/init
                - initç¨‹åºçš„ç±»å‹
                - centos5 : SysV init
                    - é…ç½®æ–‡ä»¶ : /etc/inittab
                - centos6 : Upstart
                    - é…ç½®æ–‡ä»¶ :
                        - /etc/inittab å®é™…ä¸ç”¨,å…¼å®¹5
                        - /etc/init/*.conf
                - centos7 : Systemd
                    - é…ç½®æ–‡ä»¶: /usr/lib/systemd/system, /etc/systemd/system


    ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ç®€å•æ€»ç»“(å†…æ ¸) : åŠ ç”µè‡ªæ£€POST -&gt; BootSequence(BIOS) -&gt; å¼•å¯¼ç¨‹åºBootloader(MBR) -&gt; åŠ è½½Kernel(ramdisk) -&gt; æŒ‚è½½rootfs(readonly) -&gt; åˆå§‹åŒ–/sbin/init


4. åˆå§‹åŒ– /sbin/init
    - centos5 : sysV init
        - è¿è¡Œçº§åˆ«: ä¸ºäº†ç³»ç»Ÿçš„è¿è¡Œæˆ–ç»´æŠ¤ç­‰ç›®çš„è€Œè®¾è®¡çš„æœºåˆ¶;
            - 0-6:
                - 0 : å…³æœº, shutdown
                - 1 : å•ç”¨æˆ·æ¨¡å¼(single user): rootç”¨æˆ·, æ— éœ€è®¤è¯, ç»´æŠ¤æ¨¡å¼
                - 2 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : ä¼šå¯åŠ¨ç½‘ç»œåŠŸèƒ½, ä½†ä¸ä¼šå¯åŠ¨NFS, é¡»è®¤è¯,ç»´æŠ¤æ¨¡å¼
                - 3 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : å®Œå…¨åŠŸèƒ½æ¨¡å¼, æ— æ¡Œé¢
                - 4 : é¢„ç•™æ¨¡å¼ : æ— ç‰¹åˆ«ä½¿ç”¨ç›®çš„, ä¹ æƒ¯åŒ3ç•Œåˆ«åŠŸèƒ½
                - 5 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : å®Œå…¨åŠŸèƒ½æ¨¡å¼, æœ‰æ¡Œé¢
                - 6 : é‡å¯æ¨¡å¼
            - é»˜è®¤çº§åˆ«: 3,5
            - çº§åˆ«åˆ‡æ¢: init [0-6]
            - çº§åˆ«æŸ¥çœ‹: who -r  æˆ– runlevel
        - é…ç½®æ–‡ä»¶: /etc/inittab
            - æ¯ä¸€è¡Œå®šä¹‰ä¸€ç§actionä»¥åŠé˜ˆå€¼å¯¹åº”çš„process
                - id:runlevels:action:process
                    - id: ä¸€ä¸ªä»»åŠ¡çš„æ ‡è¯†ç¬¦
                    - runlevels: åœ¨å“ªäº›çº§åˆ«å¯åŠ¨æ­¤ä»»åŠ¡
                    - action : åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹å¯åŠ¨æ­¤ä»»åŠ¡
                    - process : ç¨‹åº
                - actions:
                    - wait : ç­‰å¾…åˆ‡æ¢è‡³æ­¤ä»»åŠ¡æ‰€åœ¨çš„çº§åˆ«æ—¶æ‰§è¡Œä¸€æ¬¡ (l0:0:wait:/etc/rc.d/rc 0)
                    - respawn : ä¸€æ—¦æ­¤ä»»åŠ¡ç»ˆæ­¢æ—¶,å°±è‡ªåŠ¨é‡æ–°å¯åŠ¨ (1:2345:respawn:/sbin/mingetty tty1)
                    - initdefault : è®¾å®šé»˜è®¤è¿è¡Œçº§åˆ« (id:3:initdefault:)
                    - sysinit : è®¾å®šåˆå§‹åŒ–æ–¹å¼ (si::sysinit:/etc/rc.d/rc.sysinit)
                - /etc/rc.d/rc
                    - è¯¥è„šæœ¬ä¼šåœæ­¢æ‰€æœ‰/etc/rc.d/rc$runlevel.d/K##*è„šæœ¬,
                    - å¯åŠ¨æ‰€æœ‰/etc/rc.d/rc$runlevel.d/S##*è„šæœ¬
                    - K,S åé¢çš„æ•°å­—è¡¨ç¤ºå¯åŠ¨å’Œå…³é—­çš„é¡ºåº
                - chkconfig : ç®¡æ§/etc/init.dæ¯ä¸ªæœåŠ¡è„šæœ¬åœ¨å„ä¸ªçº§åˆ«ä¸‹çš„å¯åŠ¨æˆ–å…³é—­çŠ¶æ€
                    - chkconfig --add nginxd : æ·»åŠ åˆ°chkconfigç®¡ç†, å³ä¾¿è„šæœ¬å†™æˆ2345, ä¹Ÿä¼šåˆ›å»º0-6çº§åˆ«æ‰€æœ‰éƒ½æ˜¯Kxxnginxd
                        - è„šæœ¬æ ¼å¼:
                          - æ–¹æ³•1: é™„å½•1
                          - æ–¹æ³•2: é™„å½•2
                    - chkconfig nginxd on : æ­¤æ—¶ 2345 çº§åˆ«ä¼šåˆ›å»ºSxxnginxd
                    - chkconfig --level 35 nginxd : ä¿®æ”¹35
                    - chkconfig nginxd off: æ­¤æ—¶ 2345 çº§åˆ«ä¼šåˆ›å»ºKxxnginxd
                    - chkconfig --del nginxd
                - ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ : /etc/rc.d/rc.sysinit
                    - 1. è®¾ç½®ä¸»æœºå
                    - 2. è®¾ç½®æ¬¢è¿ä¿¡æ¯
                    - 3. æŒ‚è½½udevå’Œselinux
                    - 4. æŒ‚è½½/etc/fstabæ–‡ä»¶ä¸­å®šä¹‰çš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿ
                    - 5. æ£€æµ‹æ ¹æ–‡ä»¶ç³»ç»Ÿ, å¹¶ä»¥è¯»å†™æ–¹å¼é‡æ–°æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
                    - 6 è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ
                    - 7 æ ¹æ®/etc/sysctl.confè®¾å®šå†…æ ¸å‚æ•°
                    - 8 æ¿€æ´»lvm è½¯raidè®¾å¤‡
                    - 9 æ¿€æ´»swapè®¾å¤‡(/etc/fstab)
                    - 10 åŠ è½½é¢å¤–è®¾å¤‡çš„é©±åŠ¨ç¨‹åº
                    - 11 æ¸…ç†æ“ä½œ

        ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ç®€å•æ€»ç»“(ç”¨æˆ·ç©ºé—´): /sbin/init(/etc/inittab)
            è®¾ç½®é»˜è®¤è¿è¡Œçº§åˆ« -&gt; è¿è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬, å®Œæˆåˆå§‹åŒ– -&gt; å…³é—­å¯¹åº”çº§åˆ«ä¸‹è¦åœæ­¢çš„æœåŠ¡, å¯åŠ¨æœåŠ¡ -&gt; è®¾ç½®ç™»å½•ç»ˆç«¯

    - centos6
        - initç¨‹åº: upstart, ä½†ä¾ç„¶å‘½åä¸º/sbin/init
        - é…ç½®æ–‡ä»¶: /etc/init/*.conf, /etc/inittab(ä¹Ÿä¼šè¯»å–, ä½†ä»…å…è®¸é…ç½®å…è®¸çº§åˆ«)

    - centos7
        - initç¨‹åº: systemd
        - é…ç½®æ–‡ä»¶: /usr/lib/systemd/system/*, /etc/systemd/system/*
        - å®Œå…¨å…¼å®¹sysVè„šæœ¬æœºåˆ¶

</code></pre><blockquote>
<p>é™„å½•1</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span> <span class="c1">#filename: nginxd</span>
 <span class="c1"># nginx - this script starts and stops the nginx daemon</span>
 <span class="c1">#</span>
 <span class="c1"># chkconfig:   - 85 15</span>
 <span class="c1"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span>
 <span class="c1">#               proxy and IMAP/POP3 proxy server</span>
 <span class="c1"># processname: nginx</span>
 <span class="c1"># config:      /etc/nginx/nginx.conf</span>
 <span class="c1"># config:      /etc/sysconfig/nginx</span>
 <span class="c1"># pidfile:     /var/run/nginx.pid</span>

 <span class="c1"># Source function library.</span>
 . /etc/rc.d/init.d/functions

 <span class="c1"># Source networking configuration.</span>
 . /etc/sysconfig/network

</code></pre></div><blockquote>
<p>é™„å½•2</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#! /bin/sh
</span><span class="cp"></span>
<span class="c1">### BEGIN INIT INFO</span>
<span class="c1"># Provides:          php-fpm</span>
<span class="c1"># Required-Start:    $remote_fs $network</span>
<span class="c1"># Required-Stop:     $remote_fs $network</span>
<span class="c1"># Default-Start:     2 3 4 5</span>
<span class="c1"># Default-Stop:      0 1 6</span>
<span class="c1"># Short-Description: starts php-fpm</span>
<span class="c1"># Description:       starts the PHP FastCGI Process Manager daemon</span>
<span class="c1">### END INIT INFO</span>
</code></pre></div><h4 id="grub">grub</h4>
<pre><code>grub : grand unified bootloader
    - grub 0.x : grub legacy
    - grub 1.x : grub2

grub legacy:
    stage1 : MBR
    stage1_5 : mbrä¹‹åçš„æ‰‡åŒº,è®©stage1ä¸­çš„bootloèƒ½è¯†åˆ«stage2æ‰€åœ¨çš„åˆ†åŒºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ
    stage2 : ç£ç›˜åˆ†åŒº(/boot/grub)

    é…ç½®æ–‡ä»¶ : /boot/grub/grub.conf &lt;- /etc/grub.conf

    stage2åŠå†…æ ¸ç­‰é€šå¸¸æ”¾ç½®äºä¸€ä¸ªåŸºæœ¬ç£ç›˜åˆ†åŒº:
        (1) æä¾›èœå•,å¹¶æä¾›äº¤äº’å¼æ¥å£
            e: ç¼–è¾‘æ¨¡å¼,ç”¨æˆ·ç¼–è¾‘èœå•
            c: å‘½ä»¤æ¨¡å¼,å‘½ä»¤æ¥å£
        (2) åŠ è½½ç”¨æˆ·æ‰€é€‰æ‹©çš„å†…æ ¸
            å…è®¸ä¼ å‚ç»™å†…æ ¸
            å¯éšè—æ­¤èœå•
        (3) ä¸ºèœå•æä¾›ä¿æŠ¤æœºåˆ¶
            ä¸ºç¼–è¾‘èœå•è¿›è¡Œè®¤è¯
            ä¸ºå¯ç”¨å†…æ ¸æˆ–æ“ä½œç³»ç»Ÿè¿›è¡Œè®¤è¯
    grubçš„å‘½ä»¤æ¥å£:
        help: å¸®åŠ©åˆ—è¡¨
        find (hd0,0)/vmlinux-ä¸¤æ¬¡tab
        root (hd0,0) è®¾ç½® (hd0,0) ä¸ºæ ¹
        kernel /vmlinuz-VERSION-release ro root=/dev/vg0/root, zè¡¨ç¤ºå‹ç¼©æ ¼å¼, æœ¬æ¬¡å¯åŠ¨æ—¶ç”¨åˆ°çš„å†…æ ¸æ–‡ä»¶
        initrd /initrd-VERSION-release.img æˆ– /initramfs-VERSION-release.img
        boot å¼•å¯¼å¯åŠ¨é€‰å®šçš„å†…æ ¸
</code></pre><h4 id="æ¨¡å—module">æ¨¡å—module</h4>
<pre><code>å†…æ ¸æ¨¡å—ç®¡ç† :
    lsmod: æ˜¾ç¤ºå†…æ ¸å·²è£…è½½æ¨¡å—

    åŠ¨æ€è£…å¸è½½æ¨¡å— :
        å¸è½½ : modprobe -r MOD_NAME
        è£…è½½ : modprobe MOD_NAME

        è£…è½½ : insmod /path/to/module_file
        å¸è½½ : rmmod MOD_NAME

    æŸ¥çœ‹æŸæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯ :
        modinfo MOD_NAME

    æ£€æŸ¥å¹¶ç”Ÿæˆæ¨¡å—é—´ä¾èµ–å…³ç³»çš„å‘½ä»¤ :
        depmod
</code></pre><h4 id="sysctl">sysctl</h4>
<ul>
<li>/proc</li>
</ul>
<pre><code># è·¯ç”±è½¬å‘åŠŸèƒ½
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
# æ¸…ç†cache
echo 1 &gt; /proc/sys/vm/drop_caches
# å½“å‰ä¸»æœºå
cat /proc/sys/kernel/hostname
# ç¦ping
echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all
</code></pre><ul>
<li>/sysç›®å½•</li>
</ul>
<pre><code>sysfs : è¾“å‡ºå†…æ ¸è¯†åˆ«å‡ºçš„å„ç¡¬ä»¶è®¾å¤‡çš„ç›¸å…³å±æ€§ä¿¡æ¯
udev : é€šè¿‡è¯»å–/sysç›®å½•çš„ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯ æŒ‰éœ€ä¸ºç¡¬ä»¶è®¾å¤‡åˆ›å»ºè®¾å¤‡æ–‡ä»¶
</code></pre><h4 id="ç¼–è¯‘å†…æ ¸è¿‡ç¨‹">ç¼–è¯‘å†…æ ¸è¿‡ç¨‹</h4>
<pre><code>ä¸‹è½½åˆ°/usr/src/linux-4.19.195.tar.xz
make menuconfig  é…ç½®å†…æ ¸é€‰é¡¹
make
make modules_install å®‰è£…å†…æ ¸æ¨¡å—

screen:
    æ‰“å¼€: screen
    æ‹†é™¤: ctrl+a,d
    åˆ—è¡¨: screen -ls
    è¿æ¥è‡³: screen -r screen_id  
    é€€å‡º: exit
</code></pre><h4 id="sytemd">sytemd</h4>
<ul>
<li>systemdçš„æ–°ç‰¹æ€§</li>
</ul>
<pre><code>ç³»ç»Ÿå¼•å¯¼æ—¶å®ç°æœåŠ¡å¹¶è¡Œå¯åŠ¨
æŒ‰éœ€æ¿€æ´»è¿›ç¨‹
ç³»ç»ŸçŠ¶æ€å¿«ç…§
åŸºäºä¾èµ–å…³ç³»å®šä¹‰çš„æœåŠ¡æ§åˆ¶é€»è¾‘
</code></pre><ul>
<li>æ ¸å¿ƒæ¦‚å¿µ-unit</li>
</ul>
<pre><code>ç”±å…¶ç›¸å…³é…ç½®æ–‡ä»¶è¿›è¡Œæ ‡è¯†,è¯†åˆ«å’Œé…ç½®;æ–‡ä»¶ä¸­ä¸»è¦åŒ…å«äº†ç³»ç»ŸæœåŠ¡,ç›‘å¬çš„socket,ä¿å­˜çš„å¿«ç…§,initç›¸å…³çš„ä¿¡æ¯
    /usr/lib/systemd/system
    /etc/systemd/system
    /run/systemd/system(ä¸é‡è¦)
unitåœºå‡ç±»å‹:
    Service uint(x.service): ç”¨äºå®šä¹‰ç³»ç»ŸæœåŠ¡
    Target unit(x.target) : ç”¨äºæ¨¡æ‹Ÿå®ç°&quot;è¿è¡Œçº§åˆ«&quot;,systemdæ˜¯æ²¡æœ‰sysVçš„runlevelæ¦‚å¿µ
    Device uint(x.device) : ç”¨äºå®šä¹‰å†…æ ¸è¯†åˆ«çš„è®¾å¤‡
    Mount uint(x.mount)   : ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
    Socket uint(x.socket) : ç”¨äºè¡¨ç¤ºè¿›ç¨‹é—´é€šä¿¡ç”¨åˆ°çš„socketæ–‡ä»¶
    Snapshot unit(x.snapshot) : ç®¡ç†ç³»ç»Ÿå¿«ç…§
    Swap uint(x.swap) : ç”¨äºç®¡ç†æ ‡è¯†swapè®¾å¤‡
    AutoMount unit(x.automount): æ–‡ä»¶ç³»ç»Ÿè‡ªåŠ¨æŒ‚è½½ç‚¹è®¾å¤‡
    Path unit(.path) : ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€æ–‡ä»¶æˆ–ç›®å½•

å…³é”®ç‰¹æ€§:
    åŸºäºsocketçš„æ¿€æ´»æœºåˆ¶ : socketå’Œç¨‹åºåˆ†ç¦»
    åŸºäºbusçš„æ¿€æ´»æœºåˆ¶
    åŸºäºdeviceçš„æ¿€æ´»æœºåˆ¶
    åŸºäºpathçš„æ¿€æ´»æœºåˆ¶
    ç³»ç»Ÿå¿«ç…§: ä¿å­˜å„unitçš„å½“å‰çŠ¶æ€ä¿¡æ¯ äºåƒé…’å­˜å‚¨è®¾å¤‡ä¸­
    å‘åå…¼å®¹sysv initè„šæœ¬
        /etc/init.d/ ç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥é€šè¿‡systemctlç®¡ç†
ä¸å…¼å®¹:
    systemctlçš„å‘½ä»¤æ˜¯å›ºå®šçš„
    éç”±systemdå¯åŠ¨çš„æœåŠ¡,systemctlæ— æ³•æ§åˆ¶

</code></pre><ul>
<li>å¸¸ç”¨å‘½ä»¤</li>
</ul>
<pre><code># æŸ¥çœ‹æ˜¯å¦æ¿€æ´»
systemctl is-active nginx.service
# æŸ¥çœ‹å·²æ¿€æ´»çš„service
systemctl list-units --type service
# æŸ¥çœ‹æ‰€æœ‰çš„æœåŠ¡
systemctl list-units -t service -a

# è®¾ç½®å¼€æœºå¯åŠ¨(å®é™…å°±æ˜¯é“¾æ¥åˆ°: /etc/systemd/system/multi-user.target.wants)
systemctl enable nginx.service
# æŸ¥çœ‹æ˜¯å¦èƒ½å¼€æœºè‡ªå¯
systemctl is-enabled nginx.service
# ç¦æ­¢/å–æ¶ˆ æŸæœåŠ¡(å°±æ˜¯é“¾æ¥: /etc/systemd/system/nginx.service -&gt; /dev/null)
systemctl mask nginx.service
systemctl unmask nginx.service


</code></pre><ul>
<li>ç®¡ç†target units</li>
</ul>
<pre><code>runlevel0.target -&gt; poweroff.target
runlevel1.target -&gt; rescue.target
runlevel2.target -&gt; multi-user.target
runlevel3.target -&gt; multi-user.target
runlevel4.target -&gt; multi-user.target
runlevel5.target -&gt; graphical.target
runlevel6.target -&gt; reboot.target

åˆ‡æ¢çº§åˆ«: init N -&gt; systemctl isolate NAME.target

æŸ¥çœ‹çº§åˆ«: runlevel -&gt;  systemctl list-units -t target

è·å–é»˜è®¤è¿è¡Œçº§åˆ« : systemctl get-default
ä¿®æ”¹é»˜è®¤è¿è¡Œçº§åˆ« : systemctl set-default NAME.target

åˆ‡æ¢ç´§æ€¥æ•‘æ´æ¨¡å¼(çº§åˆ«1) : systemctl rescue
åˆ‡æ¢ç´§æ€¥emergencyæ¨¡å¼(ä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–è„šæœ¬) : systemctl emergency

å…³æœº: systemctl halt, systemctl powerof
é‡å¯: systemctl reboot
éª¨æ°”: systemctl suspend
å¿«ç…§: systemctl hybrid-sleep
å¿«ç…§å¹¶æŒ‚èµ·: systemctl hybrid-sleep
</code></pre><ul>
<li>service unit file</li>
</ul>
<pre><code>[Unit] : å®šä¹‰ä¸unitç±»å‹æ— å…³çš„é€šç”¨é€‰é¡¹, ç”¨äºæä¾›unitçš„æè¿°ä¿¡æ¯, unitçš„æ¬£æ…°åŠä¾èµ–å…³ç³»ç­‰
    Description : ä¼šæ˜¾ç¤ºåˆ°systemctl status ä¼šæ˜¾ç¤º
    After : å®šä¹‰å¯åŠ¨é¡ºåºå…³ç³»
    Wants : ä¾èµ–åˆ°çš„å…¶ä»–units(å¼±ä¾èµ–,ä¾èµ–ä¸å¯åŠ¨è‡ªå·±å¯ä»¥æ¿€æ´»)
    Requires : ä¾èµ–åˆ°çš„å…¶ä»–units(å¼ºä¾èµ–,ä¾èµ–ä¸å¯åŠ¨è‡ªå·±æ— æ³•æ¿€æ´»)
    BindsTo : ä¸Requiresç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ

[Service] : ä¸Serviceç›¸å…³çš„é€‰é¡¹
    Type : å®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚
        Type=simple : é»˜è®¤å€¼ï¼Œæ‰§è¡ŒExecStartæŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹
        Type=forking : ä»¥ fork æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º
        Type=oneshot : ä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
        Type=dbus : å½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨
        Type=notify : å½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥Systemdï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
        Type=idle : è‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ
    ExecStart : å¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤
    ExecStartPre : å¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
    ExecStartPost : å¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
    ExecReload : é‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
    ExecStop : åœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
    ExecStopPost : åœæ­¢å½“å…¶æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
    RestartSec : è‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°
    Restart : å®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬alwaysï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€on-successã€on-failureã€on-abnormalã€on-abortã€on-watchdog
    TimeoutSec : å®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°
    Environment : æŒ‡å®šç¯å¢ƒå˜é‡

[Install] : å®šä¹‰ç”±&quot;systemctl enable &quot; å’Œ&quot;disable&quot;å‘½ä»¤çš„æ—¶å€™ç”¨åˆ°
    WantedBy : å®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .wantsåç¼€æ„æˆçš„å­ç›®å½•ä¸­
    RequiredBy : å®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .requiredåç¼€æ„æˆçš„å­ç›®å½•ä¸­
    Alias : å½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å
    Also : å½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit

&gt; ä¿®æ”¹äº†unité…ç½®éœ€è¦æ‰§è¡Œ: systemctl daemon-reload
&gt; ç„¶åreloadæˆ–restart
</code></pre><h3 id="è¿ç»´å®‰å…¨">è¿ç»´å®‰å…¨</h3>
<pre><code>å®¢æˆ·ç«¯é€šè¿‡æµè§ˆå™¨è®¿é—®ç½‘é¡µæ—¶, å®¢æˆ·ç«¯ä¸éœ€è¦å‘ç»™æœåŠ¡ç«¯è¯ä¹¦, åªéœ€è¦éªŒè¯æœåŠ¡ç«¯çš„æ­£å¸¸(ä½†æ˜¯å¯¹äºç½‘é“¶æ”¯ä»˜å¯èƒ½ä¼šéœ€è¦å®‰è£…è¯ä¹¦,é“¶è¡Œè‡ªå·±çš„CA,æ¯”å¦‚uç›¾)


ssl : secure sockets layer  
    netscape 1994
    v1(æ²¡å…¬å¼€), v2(95å¹´,å¾ˆå¤šæ¼æ´), v3
tls : transport layer security
    ietf 1999
    v1.0 v1.1 v1.2 v1.3

sslä¼šè¯ä¸»è¦ä¸‰æ­¥
    1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ç´¢è¦å¹¶éªŒè¯è¯ä¹¦
    2. åŒæ–¹åå•†ç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
    3. åŒæ–¹é‡‡ç”¨&quot;ä¼šè¯å¯†é’¥&quot;è¿›è¡ŒåŠ å¯†é€šä¿¡

    ssl handshake protocol :
        ç¬¬ä¸€é˜¶æ®µ å®¢æˆ·ç«¯å‘é€client hello
             æ”¯æŒçš„åè®®ç‰ˆæœ¬, æ¯”å¦‚tls v1.2
             å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°, ç¨åç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
             æ”¯æŒçš„åŠ å¯†ç®—æ³•,æ¯”å¦‚AES(å¯¹ç§°åŠ å¯†ç®—æ³•),RSA(å…¬é’¥åŠ å¯†ç®—æ³•)
             æ”¯æŒçš„å‹ç¼©ç®—æ³•
        ç¬¬äºŒé˜¶æ®µ æœåŠ¡ç«¯å‘é€Server hello
            ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†é€šä¿¡åè®®ç‰ˆæœ¬, æ¯”å¦‚tls v1.2 ;
            æœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°, ç¨åç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
            ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†æ–¹æ³•, æ¯”å¦‚ RSA
            æœåŠ¡ç«¯å‘é€è¯ä¹¦
            [å¦‚æœéœ€è¦éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦,ä¼šç´¢è¦å®¢æˆ·ç«¯è¯ä¹¦...]
        ç¬¬ä¸‰é˜¶æ®µ:
            å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨è¯ä¹¦(å‘è¯æœºæ„,å®Œæ•´æ€§,æŒæœ‰è€…,æœ‰æ•ˆæœŸ,åŠé”€åˆ—è¡¨)
            å®¢æˆ·ç«¯å‘é€ä»¥ä¸‹ä¿¡æ¯ç»™æœåŠ¡ç«¯
                ä¸€ä¸ªéšæœºæ•°
                ç¼–ç å˜æ›´é€šçŸ¥,è¡¨ç¤ºéšåçš„ä¿¡æ¯å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹å¼å’Œå¯†é’¥å‘é€
                å®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥
        ç¬¬å››é˜¶æ®µ:
            æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ç»è¿‡pre-master-key æ··åˆå,è®¡ç®—ç”Ÿæˆæœ¬æ¬¡æ‰€å¾—åˆ°çš„çš„&quot;ä¼šè¯å¯†é’¥&quot;
            å‘å®¢æˆ·ç«¯å‘é€å¦‚ä¸‹ä¿¡æ¯
                ç¼–ç å˜æ›´é€šçŸ¥,è¡¨ç¤ºéšåçš„ä¿¡æ¯å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹å¼å’Œå¯†é’¥å‘é€
                æœåŠ¡ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥

PKI: å…¬é’¥åŸºç¡€è®¾æ–½
    ç­¾è¯æœºæ„ CA
    æ³¨å†Œæœºæ„ RA
    è¯ä¹¦åŠé”€åˆ—è¡¨ CRL
    è¯ä¹¦å­˜å–åº“

openssl
    ç»„ä»¶
        libcrypto,libssl,openssl

    openssl (å¤šå­å‘½ä»¤):
        Standard commands
        Message Digest commands (see the `dgst' command for more details)
        Cipher commands (see the `enc' command for more details)

    å¯¹ç§°åŠ å¯†
        å·¥å…·: openssl enc, gpg
        æ”¯æŒç®—æ³•: des3,aes,
        openssl enc å‘½ä»¤:
            åŠ å¯†è§£å¯†:
            # -e encode
            # -a base64 ç¼–ç 
            ~]# openssl enc -e -des3 -a  -in b  -out b.encode
            ~]# openssl enc -d -des3 -a  -in b.encode  -out b.decode
    å•å‘åŠ å¯†
        å·¥å…·: openssl dgst, md5sum,sha1sum,sha224sum...
        dgstå‘½ä»¤:
            ~]# md5sum b
                e6f443c6566d585113d137e0992d8391  b
            ~]# openssl dgst -md5 b
                MD5(b)= e6f443c6566d585113d137e0992d8391
    ç”Ÿæˆç”¨æˆ·å¯†ç :
        å·¥å…·: passwd, openssl passwd

        ~]# openssl passwd -1 -salt 123
            $1$123$ai3PKcU9Q7J3tIviFBaqN0
    éšæœºæ•°ç”Ÿæˆ
        å·¥å…· openssl rand
        ~]# openssl rand -base64 32
        ~]# openssl rand -hex 10
    å…¬é’¥åŠ å¯†:
        å·¥å…·: openssl rsautl, gpg
        åŠ å¯†è§£å¯†:
            ç®—æ³•: RSA , ELGamal
        æ•°å­—ç­¾å:
            ç®—æ³•: RSA, DSA, ELGamal
        å¯†é’¥äº¤æ¢
            ç®—æ³•: DH

        ç”Ÿæˆå¯†é’¥å¯¹:
            # æ”¾åˆ°æ‹¬å·ä»£è¡¨æ˜¯å­shellæ‰§è¡Œçš„, ä¸å½±å“å½“å‰shellçš„umask
            # umask 077 ä¼šè®©é»˜è®¤çš„644-077 =600æƒé™
            ç”Ÿæˆç§é’¥: ~]# (umask 077 ; openssl genrsa -out server.key 2048)
            æå–å…¬é’¥: ~]# openssl rsa -in server.key -pubout -out server.pub


linuxçš„éšæœºç”Ÿæˆå™¨:
    /dev/random : ä»…ä»ç†µæ± ä¸­è¿”å›éšæœºæ•°, éšæœºæ•°ç”¨å°½,(é˜»å¡)
    /dev/urandom : ä»…ä»ç†µæ± ä¸­è¿”å›éšæœºæ•°, éšæœºæ•°ç”¨å°½,ä¼šåˆ©ç”¨è½¯ä»¶ç”Ÿæˆä¼ªéšæœºæ•°,(éé˜»å¡,ä½†ä¸å®‰å…¨)
    ç†µæ±  :
        å†…æ ¸çš„ç©ºé—´
        æ¥æº:
            ç¡¬ç›˜IOä¸­æ–­æ—¶é—´é—´éš”
            é”®ç›˜IOä¸­æ–­æ—¶é—´é—´éš”

CA :
    å»ºç«‹ç§æœ‰CA:
        å·¥å…·: openssl, openca
    openssl :
        é…ç½®æ–‡ä»¶: /etc/pki/tls/openssl.cnf
        æ­¥éª¤:
            1. ç”Ÿæˆç§é’¥;
                ~]# (umask 077; openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)
            2. ç”Ÿæˆè‡ªç­¾è¯ä¹¦;
                # -new : ç”Ÿæˆæ–°è¯ä¹¦éƒ¨ç½²è¯·æ±‚
                # -x509 : ç”Ÿæˆè‡ªç­¾æ ¼å¼è¯ä¹¦,ä¸“ç”¨äºåˆ›å»ºç§æœ‰CA
                # -key : ç”Ÿæˆè¯·æ±‚ç”¨åˆ°çš„ç§æœ‰è·¯å¾„, ä¼šæå–å…¬é’¥
                # -out : ç”Ÿæˆçš„è¯·æ±‚æ–‡ä»¶è·¯å¾„, å¦‚æœæ˜¯è‡ªç­¾æ“ä½œå°†ç›´æ¥ç”Ÿæˆç­¾ç½²è¿‡çš„æ­£å¼
                ~]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650
            3. æä¾›CAæ‰€éœ€çš„ç›®å½•åŠæ–‡ä»¶:
                ~]# mkdir -p /etc/pki/CA/{certs,crl,newcerts}
                ~]# touch  /etc/pki/CA/{serial,index.txt}
                ~]# echo 01 &gt; /etc/pki/CA/serial
    è¦ç”¨åˆ°è¯ä¹¦è¿›è¡Œå®‰å…¨é€šä¿¡çš„æœåŠ¡å™¨, éœ€è¦å‘CAè¯·æ±‚ç­¾ç½²è¯ä¹¦:
        æ­¥éª¤
            1) ç”Ÿæˆç§é’¥:
                ~]# (umask 077; openssl genrsa -out /etc/nginx/ssl/server.key 2048)
            2) ç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚
                ~]# openssl req -new -key /etc/nginx/ssl/server.key -out /etc/nginx/ssl/server.csr -days 365

            3) åœ¨CAæœåŠ¡å™¨ç­¾ç½²è¯ä¹¦:
                ~]# openssl -ca in /etc/nginx/ssl/server.csr -out /etc/pki/CA/certs/server.crt -days 365

            4) æŸ¥çœ‹è¯ä¹¦çš„ä¿¡æ¯:
                ~]# openssl -x509 -in /etc/pki/CA/certs/server.crt -noout -serial -subject

</code></pre><h3 id="dns">DNS</h3>
<h4 id="è¯´æ˜">è¯´æ˜</h4>
<pre><code>DNS: Domain Name Service : åº”ç”¨å±‚åè®®
    C/S: 53/udp(è§£æ),53/tcp(åŒºåŸŸä¼ é€)
tld : TOP level domain

DNSåè§£ææ–¹å¼:
    åç§°-&gt; ip : æ­£å‘è§£æ
    ip -&gt; åç§°: åå‘è§£æ
    æ³¨æ„: äºŒè€…éåŒä¸€ç©ºé—´,éä¸ºåŒä¸€æ£µæ ‘,ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„å­˜å‚¨æ–¹å¼
DNS è§£æè¿‡ç¨‹:
    ä¾‹å¦‚: è¯·æ±‚www.baidu.com
        1. é¦–å…ˆå®¢æˆ·ç«¯ä¼šæŸ¥æ‰¾è‡ªå·±çš„hostæ–‡ä»¶,
        2. å¦‚æœhostæ²¡æœ‰, å°±è¯·æ±‚æœ¬åœ°ç¼“å­˜,
        3. å¦‚æœç¼“å­˜æ²¡æœ‰, å°±è¯·æ±‚/etc/resolv.confçš„dnsæœåŠ¡å™¨
            3.1 dnsæœåŠ¡å™¨æŸ¥æ‰¾è‡ªå·±çš„åŸŸæ˜¯å¦è´Ÿè´£,æ˜¯å¦èƒ½è§£æ
            3.2 dnsæœåŠ¡å™¨å¦‚æœä¸èƒ½è§£æ,åŒæ ·æŸ¥æ‰¾dnsæœ¬åœ°ç¼“å­˜,
            3.3 dnsæœ¬åœ°ç¼“å­˜ä¹Ÿæ‰¾ä¸åˆ°,å°±å»æ ¹åŸŸåæŸ¥æ‰¾-&gt;comæœåŠ¡å™¨-&gt;baiduæœåŠ¡å™¨-&gt;æ‰¾åˆ°www.baidu.com çš„è§£ææ¡ç›®
        4. /etc/resolv.confçš„dnsæœåŠ¡å™¨æ‹¿åˆ°è¯·æ±‚ä¹‹å,è¿”å›ç»™å®¢æˆ·ç«¯
</code></pre><blockquote>
<p>åå‘è§£ææ ‘:
<img src="/images/66/markdown-img-paste-20210628102440183.png" alt=""></p>
</blockquote>
<pre><code>~]# dig -x 114.114.114.114
114.114.114.114.in-addr.arpa. 524 IN	PTR	public1.114dns.com.
</code></pre><h4 id="åŸºç¡€">åŸºç¡€</h4>
<pre><code>åŒºåŸŸ(zone)å’ŒåŸŸ(domain)
    åŒºåŸŸæ˜¯ç‰©ç†æ¦‚å¿µ, åŸŸæ˜¯é€»è¾‘æ¦‚å¿µ
    magedu.comåŸŸ:
        æ­£å‘è§£æåŒºåŸŸ
        åå‘è§£æåŒºåŸŸ
åŒºåŸŸæ•°æ®åº“æ–‡ä»¶
    èµ„æºè®°å½•  : Resource Record
        ç±»å‹ : A, AAAA, PTR, SOA , NS, CNAME, MX
        SOA : Start Of Authority ,èµ·å§‹æˆæƒè®°å½•;ä¸€ä¸ªåŒºåŸŸè§£æåº“åªèƒ½æœ‰ä¸€ä¸ªSOAè®°å½•,å¿…é¡»åœ¨ç¬¬ä¸€æ¡ (å²›å)
        NS  : Name Service , åŸŸåæœåŠ¡è®°å½•; å¯ä»¥æœ‰å¤šä¸ª(å²›ä¸»)
        A   : Address , åœ°å€è®°å½•, FQDN-&gt;IPv4 (32ä½)
        AAAA: Address FQDN-&gt;IPv6 (128ä½)
        CNAME: Canonical Name, åˆ«å
        PTR : Pointer, IP-&gt;FQDN
        MX  : Mail Exchanger, é‚®ä»¶äº¤æ¢å™¨,å¯ä»¥å¤šä¸ª
            ä¼˜å…ˆçº§: 0-99, æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜;

    èµ„æºè®°å½•çš„å®šä¹‰æ ¼å¼:
        åŸŸå: name [TTL] IN  RR_TYPE value
        SOA :
            name: å½“å‰åŒºåŸŸçš„åå­—; &quot;magedu.com.&quot; æˆ–è€…&quot;3.2.1.in-addr.arpa.&quot; (æœ€åä¸€ä¸ªç‚¹ä¸èƒ½å°‘);
            value: å¤šéƒ¨åˆ†
                1): å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°(ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸»DNSæœåŠ¡å™¨åç§°);
                2): å½“å‰åŒºåŸŸç®¡ç†çš„é‚®ç®±åœ°å€; ä½†åœ°å€ä¸­ä¸èƒ½ä½¿ç”¨@ç¬¦å·,ä¸€èˆ¬ä½¿ç”¨ç‚¹å·æ›¿ä»£
                3): (ä¸»ä»æœåŠ¡åè°ƒå±æ€§çš„å®šä¹‰ä»¥åŠå¦å®šç­”æ¡ˆçš„TTL)
                    ä¾‹å¦‚:
                        magedu.com. 86400 IN SOA magedu.com. admin.magedu.com. (
                            2017010801; serial åºåˆ—å·
                            2H ; refresh åˆ·æ–°æ—¶é•¿
                            10M ; retry é‡è¯•æ—¶é•¿
                            1w ; expire è¿‡æœŸæ—¶é•¿
                            1D ; negative answer ttl å¦å®šç­”æ¡ˆçš„ttl

                        )
        NS :
            name: å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°
            value: å½“å‰åŒºåŸŸçš„æŸDNSæœåŠ¡å™¨çš„åå­—, ä¾‹å¦‚ns.magedu.com. ;
                æ³¨æ„: ä¸€ä¸ªåŒºåŸŸå¯ä»¥æœ‰å¤šä¸ªnsè®°å½•
            ä¾‹å¦‚:
                magedu.com. 86400 IN NS ns1.magedu.com.
                magedu.com. 86400 IN NS ns2.magedu.com.
        MX:
            name : å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°
            value : å½“å‰åŒºåŸŸæŸé‚®ä»¶äº¤æ¢å™¨çš„ä¸»æœºå;
                æ³¨æ„: MXè®°å½•å¯ä»¥æœ‰å¤šä¸ª, æ¯ä¸ªè®°å½•çš„valueä¹‹å‰åº”è¯¥æœ‰ä¸€ä¸ªæ•°å­—, è¡¨ç¤ºä¼˜å…ˆçº§;
            ä¾‹å¦‚:
                magedu.com. 86400 IN MX 10 mx1.magedu.com.
                magedu.com. 86400 IN MX 20 mx2.magedu.com.
        A :
            name: æŸFQDN
            value: ipv4åœ°å€
            ä¾‹å¦‚:
                www.magedu.com. IN A 1.1.1.1
                                IN A 1.1.1.2 (å¯ä»¥çœç•¥www.magedu.com.)
        PTR :
            name : ipåœ°å€, ipåè¿‡æ¥å†™+.in-addr.arpa.
            value : FQDN
            ä¾‹å¦‚:
                4.3.2.1.in-addr.arpa. IN PTR www.magedu.com.
        CNAME:
            name: FQDNæ ¼å¼çš„åˆ«å
            value : FQDN
            ä¾‹å¦‚:
                web.magedu.com. IN CNAME www.magedu.com.

    æ³¨æ„:
        1) TTL å¯ä»¥ä»å…¨å±€ç»§æ‰¿;
        2) @è¡¨ç¤ºå½“å‰åŒºåŸŸçš„åç§°;
        3) ç›¸é‚»çš„ä¸¤ä¸ªè®°å½•å…¶nameç›¸åŒæ—¶ ç¬¬äºŒä¸ªå¯ä»¥çœç•¥
        4) å¯¹äºæ­£å‘åŒºåŸŸæ¥è¯´, MX,NSç­‰è®°å½•çš„valueä¸ºä¸€ä¸ªFQDN,æ­¤FQDNåº”è¯¥æœ‰ä¸€ä¸ªAè®°å½•
</code></pre><h4 id="bind">bind</h4>
<pre><code>BIND: Berkeley Internet Name Domain ä¼¯å…‹åˆ©äº’è”ç½‘åç§°åŸŸ, ISCç»´æŠ¤
ç¨‹åºåŒ…:
    bind-libs: (yum info bind-libs) è¢«bindå’Œbind-utilsåŒ…ä¸­çš„ç¨‹åºå…±åŒç”¨åˆ°çš„;
    bind-utils : bind å®¢æˆ·ç«¯ç¨‹åºé›†, ä¾‹å¦‚: dig,host,nslookupç­‰;
    bind: æä¾›dns serverç¨‹åº, æµ‹è¯•ç¨‹åº;
    bind-chroot : é€‰è£…, è®©namedè¿è¡Œäºjailæ¨¡å¼ä¸‹
é…ç½®æ–‡ä»¶: rpm -lq bind|head -10
    ä¸»: /etc/named.conf
    å…¶ä»–:
        /etc/named.iscdlv.key
        /etc/named.rfc1912.zones
        /etc/named.root.key
    è§£æåº“æ–‡ä»¶:
        /var/namedç›®å½•ä¸‹:
            ä¸€èˆ¬åå­—ä¸º: ZONE_NAME.zone
        æ³¨æ„:
            1) å¯ä»¥é…ç½®å¤šä¸ªåŒºåŸŸæä¾›è§£æ
            2) æ ¹åŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.ca
            3) æ­£å‘è§£ælocalhoståŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.localhost
               åå‘è§£ælocalhoståŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.loopback
    rndc: remote name domain contoller
        127.0.0.1:953/tcp
    ä¸»é…ç½®æ–‡ä»¶æ ¼å¼:
        å…¨å±€é…ç½®æ®µ:
            options{...}
        æ—¥å¿—é…ç½®æ®µ
            logging{...}
        åŒºåŸŸé…ç½®æ®µ
            zone{...} : é‚£äº›ç”±æœ¬çº§è´Ÿè´£è§£æçš„åŒºåŸŸ, æˆ–è€…è½¬å‘çš„åŒºåŸŸ

            æ³¨æ„: æ¯ä¸ªé…ç½®è¯­å¥ å¿…é¡»åˆ†å·ç»“å°¾;

        ç¼“å­˜åç§°æœåŠ¡å™¨çš„é…ç½®:
            ç›‘å¬èƒ½ä¸å¤–éƒ¨ä¸»æœºé€šä¿¡çš„åœ°å€;
                listen-on port 53 { 172.16.76.220;127.0.0.1; };
            å­¦ä¹ æ—¶,å»ºè®®å…³é—­
                dnssec-enable no;
                dnssec-validation no;
                dnssec-lookaside no;
            å…³é—­ä»…å…è®¸æœ¬åœ°æŸ¥è¯¢:(æ³¨é‡Šä»¥ä¸‹å†…å®¹)
                allow-query     { localhost; };
        æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯:
            /usr/sbin/named-checkconf [/etc/named.conf]
        å¯åŠ¨:
            systemctl start named

        æµ‹è¯•å·¥å…·
            dig : dig [-t RR_TYPE] name [@SERVER] [query options]

                æŸ¥è¯¢é€‰é¡¹:
                    +[no]trace : è·Ÿè¸ªè§£æè¿‡ç¨‹
                    +[no]recurese : è¿›è¡Œé€’å½’è§£æ;

                    # è¿½è¸ªæŸ¥è¯¢è§£æçš„å…¨è¿‡ç¨‹
                    dig +trace -t A www.baidu.com
                æ³¨æ„: åå‘è§£ææµ‹è¯•
                    dig -x 140.205.41.17

                æ¨¡æ‹Ÿå®Œå…¨åŒºåŸŸä¼ é€:
                    dig -t axfr DOMAIN [@SERVER]
            host : host [-t RR_TYPE] name [SERVER]
            nslookup : nslookup [-options] [name] [server]
                &gt; äº¤äº’å¼
                &gt; server 114.114.114.114
                &gt; set q=A

            rndcå‘½ä»¤: named æœåŠ¡æ§åˆ¶å‘½ä»¤
                status : ç»Ÿè®¡
                flush  : æ¸…ç©ºç¼“å­˜
                reload [zone]


        é…ç½®è§£æä¸€ä¸ªæ­£å‘åŒºåŸŸ:
            1) å®šä¹‰åŒºåŸŸ:
                zone &quot;ZONE_NAME&quot; IN {
                    type {master|slave|hint|forward};    //ä¸»|ä»|è·Ÿ|è½¬å‘
                    file &quot;ZONE_NAME.zone&quot;;
                };

                ~]# tail -4 /etc/named.rfc1912.zones
                zone &quot;test.com&quot; IN {
                	type master;
                	file &quot;test.com.zone&quot;;
                };

                æ³¨æ„: åŒºåŸŸåå­—å³åŸŸå

            2) å»ºç«‹åŒºåŸŸæ•°æ®æ–‡ä»¶(/var/named, å†…å®¹ä¸»è¦æ˜¯Aè®°å½•)
                ~]# cat /var/named/test.com.zone
                $TTL 600
                $ORIGIN test.com.               //åé¢ç®€å†™çš„ç»“æœè‡ªåŠ¨è¿½åŠ è¯¥å†…å®¹
                @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                        2021062801 1H 10M 3D 1D )
                    IN NS    ns1                    // è¿™é‡Œå¯ä»¥ç®€å†™, ä¸èƒ½å¸¦.
                    IN NS    ns2.test.com.          // å¿…é¡»æœ€åä¸€ä½åŠ .
                    IN MX 10 mx1                    
                    IN MX 20 mx2.test.com.      
                ns1 IN A     172.16.76.220
                ns2 IN A     172.16.76.220
                mx1 IN A     172.16.76.220
                mx2 IN A     172.16.76.220
                www IN A     172.16.76.220
                web IN CNAME www

                ~]# chmod 640 test.com.zone
                ~]# chown :named test.com.zone
            3) æ£€æŸ¥zoneé…ç½®
                ~]# named-checkzone test.com /var/named/test.com.zone
                ~]# systemctl reload named

        é…ç½®è§£æä¸€ä¸ªåå‘åŒºåŸŸ:
            1) å®šä¹‰åŒºåŸŸ:
                zone &quot;ZONE_NAME&quot; IN {
                    type {master|slave|hint|forward};    //ä¸»|ä»|è·Ÿ|è½¬å‘
                    file &quot;ZONE_NAME.zone&quot;;
                };
                æ³¨æ„: åå‘åŸŸåçš„åå­—
                    åå†™çš„ç½‘æ®µåœ°å€: .in-addr.arpa
                    76.16.172.in-addr.arpa

            2) å»ºç«‹åŒºåŸŸæ•°æ®æ–‡ä»¶(/var/named, å†…å®¹ä¸»è¦æ˜¯Aè®°å½•)
            ~]# cat /var/named/172.16.76.zone
                $TTL 600
                $ORIGIN 76.16.172.in-addr.arpa.               //åé¢ç®€å†™çš„ç»“æœè‡ªåŠ¨è¿½åŠ è¯¥å†…å®¹
                @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                        2021062801 1H 10M 3D 1D )
                    IN NS    ns1                    // è¿™é‡Œå¯ä»¥ç®€å†™, ä¸èƒ½å¸¦.
                    IN NS    ns2.test.com.          // å¿…é¡»æœ€åä¸€ä½åŠ .
                220 IN PTR   ns1.test.com.  
                220 IN PTR   ns2.test.com.         

</code></pre><h4 id="bindä¸»ä»">bindä¸»ä»</h4>
<blockquote>
<p>ä»…ä»…æ˜¯æŸä¸ªåŒºåŸŸçº§åˆ«ä½œä¸ºä»</p>
</blockquote>
<pre><code>å¦‚ä½•é…ç½®ä»åŒºåŸŸ:
  On Slave:
    1) å®šä¹‰åŒºåŸŸ;
        zone &quot;ZONE_NAME&quot; IN {
            type slave;
            file &quot;slaves/ZONE_NAME.zone&quot;;
            master { master_ip; };
        é…ç½®è¯­æ³•æ£€æŸ¥: named-checkconf
    2) é‡è½½
        rndc reload æˆ–è€…systemctl reload named
    }
  On Master :
    1) ç¡®ä¿åŒºåŸŸæ•°æ®æ–‡ä»¶ä¸­ ä¸ºæ¯ä¸ªä»æœåŠ¡å™¨é…ç½®NSè®°å½•,å¹¶ä¸”åœ¨æ­£å‘åŒºåŸŸæ–‡ä»¶ä¸­éœ€è¦é…ç½®NSè®°å½•çš„Aè®°å½•, ä¸”Aè®°å½•åœ°å€å°±æ˜¯ä»æœåŠ¡å™¨ip
            @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                2021062802 1H 10M 3D 1D )
                IN NS    ns2
            ns2 IN A     172.16.76.221

        &gt; åºåˆ—å·+1,æ”¹å˜äº†åºåˆ—å·, ä»åº“æ‰æ›´æ–°
    2) é‡è½½

æ‰‹å·¥ä¼ é€é…ç½®:( ä»172.16.76.220ä¸ŠåŒæ­¥é…ç½® )
    ~]# dig -t axfr test.com @172.16.76.220
</code></pre><h4 id="å­åŸŸæˆæƒ">å­åŸŸæˆæƒ</h4>
<blockquote>
<p>magedu.com -&gt; ops.magedu.com</p>
</blockquote>
<pre><code>æ­£å‘è§£æåŒºåŸŸæˆæƒå­åŸŸçš„æ–¹æ³•:
    ops.magedu.com.      IN NS ns1.ops.magedu.com.
    ns1.ops.magedu.com.  IN A  IPAddress1
    ops.magedu.com.      IN NS ns2.ops.magedu.com.
    ns2.ops.magedu.com.  IN A  IPAddress2

å®šä¹‰è½¬å‘:
    æ³¨æ„: è¢«è½¬å‘çš„æœåŠ¡å™¨, å¿…é¡»å…è®¸ä¸ºå½“å‰æœåŠ¡å™¨åšé€’å½’
    1) åŒºåŸŸè½¬å‘: ä»…è½¬å‘æŸç‰¹å®šåŒºåŸŸ
        zone &quot;ZONE_NAME&quot; {
            type forward;
            forward { first|only };
            forwarders { server_ip; };
        };

        first: é¦–å…ˆè½¬å‘,æ‰¾ä¸åˆ°, å°±è‡ªå·±å»è¿­ä»£æ‰¾æ ¹
        only: åªè½¬å‘,ä¸€èˆ¬æ˜¯å†…éƒ¨ä½¿ç”¨çš„åŸŸå

    2) å…¨å±€è½¬å‘: åªè¦ä¸æ˜¯è‡ªå·±çš„éƒ½è½¬å‘
        ç¼–è¾‘named.conf-&gt;options{
            forward only;
            forwarders { server_ip; }
        }
</code></pre><h4 id="bindä¸­çš„å®‰å…¨ç›¸å…³çš„é…ç½®">bindä¸­çš„å®‰å…¨ç›¸å…³çš„é…ç½®</h4>
<pre><code>acl : è®¿é—®æ§åˆ¶åˆ—è¡¨; æŠŠä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€å½’å¹¶ä¸ºä¸€ä¸ªå‘½åçš„ç»“åˆ,éšåé€šè¿‡æ­¤åç§°å³å¯å¯¹æ­¤ç»“åˆå†…çš„æ‰€æœ‰ä¸»æœºç»Ÿä¸€è°ƒç”¨;
    é…ç½®æ–‡ä»¶: /etc/named.conf
    acl acl_name {
        ip;
        net/prelen;
    }
    ç¤ºä¾‹:
        acl mynet {
            172.16.0.0/16;
            192.168.0.1/24;
        }
bindå››ä¸ªå†…ç½®çš„acl
    none:
    any: ä»»æ„
    local: æœ¬æœº
    localnet : æœ¬æœºæ‰€åœ¨çš„ipæ‰€å±çš„ç½‘ç»œ
è®¿é—®æ§åˆ¶æŒ‡ä»¤:(options,zone)
    allow-query { mynet; }; å…è®¸æŸ¥è¯¢çš„ä¸»æœº; ç™½åå•
    allow-transfer { myslaves; }; å…è®¸å‘é‚£äº›ä¸»æœºåšåŒºåŸŸä¼ é€;é»˜è®¤æ˜¯æ‰€æœ‰; åº”è¯¥é…ç½®ä¸ºä»æœåŠ¡å™¨
    allow-recursion { mynet; }; å…è®¸å“ªäº›ä¸»æœºå‘å½“å‰dnsæœåŠ¡å™¨è¿›è¡Œé€’å½’æŸ¥è¯¢(recursion yes ä¼šä¿®æ”¹æˆå…è®¸æ‰€æœ‰)
    allow-update { none; }; DDNS,å…è®¸åŠ¨æ€æ›´æ–°åŒºåŸŸæ•°æ®åº“æ–‡ä»¶ä¸­çš„å†…å®¹;
</code></pre><h4 id="bind-view-">bind view :</h4>
<pre><code>è§†å›¾:
    view VIEW_NAME {
        zone
        zone
    }
    # æ¯”å¦‚æ ¹æ®ip(ç”µä¿¡çš„),è®¿é—®è¯¥è§†å›¾
    view internal {
        match-clients { 172.16.0.0/8; };
        zone &quot;magedu.com&quot; IN {
            type master;
            file &quot;magedu.com/internal&quot;;
        };
    };
    # è§†å›¾ä¼šæŒ‰ç…§é…ç½®é¡ºåº,æ²¡æœ‰åŒ¹é…åˆ°çš„èµ°è¯¥è§†å›¾
    view external {
        match-cients { any; };
        zone &quot;magedu.com&quot; IN {
            type master;
            file &quot;magedu.com/external&quot;;
        };
    }
</code></pre><h3 id="httpåè®®">httpåè®®</h3>
<h4 id="tcpåè®®çš„ç‰¹æ€§">TCPåè®®çš„ç‰¹æ€§</h4>
<pre><code>å»ºç«‹è¿æ¥:
å°†æ•°æ®æ‰“åŒ…æˆæ®µ: æ ¡éªŒå’Œ(CRC32)
ç¡®è®¤,é‡ä¼ å’Œè¶…æ—¶:
æ’åº: é€»è¾‘åºå·
æµé‡æ§åˆ¶: æ»‘åŠ¨çª—å£win
æ‹¥å¡æ§åˆ¶: æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…ç®—æ³•
</code></pre><h4 id="http-hyper-text-transfer-protocol-æ–‡æœ¬åè®®">http: hyper text transfer protocol ,æ–‡æœ¬åè®®</h4>
<pre><code>&gt; html: hyper text mark language è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€
&gt; css : Cascading style sheet
&gt; js : javascript, å®¢æˆ·ç«¯è„šæœ¬;

æ–‡æœ¬åè®®:  å°†å†…å®¹ç¼–ç æˆasciiä¼ è¾“, ä½†æ˜¯å¯¹äºå›¾ç‰‡ä½¿ç”¨æ–‡æœ¬åè®®ç›´æ¥ä¼ è¾“ä¼šä¹±ç 
åè®®ç‰ˆæœ¬:
    http/0.9 : åŸå‹ç‰ˆæœ¬,åŠŸèƒ½ç®€é™‹
        method : ä»…get
    http/1.0 : cache, MIME, method,
        MIME : Multipurpose Internet Mail Extesion  å¯ä»¥ä¼ è¾“éæ–‡æœ¬å†…å®¹,
        method : get, post, head, put, delete, trace , options
    http/1.1 : å¢å¼ºäº†ç¼“å­˜åŠŸèƒ½;
    SPDY     : Google
    http/2   : rfc

httpå·¥ä½œæ¨¡å¼:
    httpè¯·æ±‚æŠ¥æ–‡: request
    httpå“åº”æŠ¥æ–‡: response
        ä¸€æ¬¡httpäº‹åŠ¡: è¯·æ±‚ &lt;--&gt; å“åº”
    webèµ„æº: web resource
        é™æ€èµ„æº(æ— éœ€æœåŠ¡ç«¯åšå‡ºé¢å¤–å¤„ç†)
        åŠ¨æ€èµ„æº(æœåŠ¡ç«¯éœ€è¦é€šè¿‡æ‰§è¡Œç¨‹åºåšå‡ºå¤„ç†,è€Œåå‘é€ç»™å®¢æˆ·ç«¯çš„æ˜¯ç¨‹åºçš„è¿è¡Œç»“æœ)
    URI = URL+URN
    èµ„æºçš„æ ‡è¯†æœºåˆ¶: URL (Uniform Resource Locator)
</code></pre><h3 id="iptables-åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™">iptables: åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™</h3>
<pre><code>5ä¸ªé’©å­:
    1. prerouting : åœ¨å…¥è·¯ç”±ä¹‹å‰
    2. å…¥route(ä¸¤ç§æƒ…å†µ)
        2.1 input: è·¯ç”±åˆ°æœ¬æœºçš„è¯·æ±‚
            2.1.1 output : æœ¬æœºè¯·æ±‚è¿”å›å‡ºå»çš„
        2.2 forward: è·¯ç”±è½¬å‘åˆ°å…¶ä»–æœºå™¨çš„è¯·æ±‚
    3. å‡ºroute
    4. postrouting : å‡ºè·¯ç”±ä¹‹å

-&gt; prerouting -&gt; route -&gt; input -&gt; output -&gt;  route -&gt;  postrouting -&gt;
                    \     -&gt; forward  -&gt;     /
</code></pre><p><img src="/images/66/markdown-img-paste-20210629112733417.png" alt=""></p>
<h4 id="ç†è®ºè¯´æ˜">ç†è®ºè¯´æ˜</h4>
<pre><code>Firewall:
    ä¸»æœºé˜²ç«å¢™ï¼š
    ç½‘ç»œé˜²ç«å¢™ï¼š

    è½¯ä»¶é˜²ç«å¢™(è½¯ä»¶é€»è¾‘)
    ç¡¬ä»¶é˜²ç«å¢™(ç¡¬ä»¶å’Œè½¯ä»¶é€»è¾‘)

iptables: ç½‘ç»œå±‚é˜²ç«å¢™
	iptables/netfilter

	ipfw --&gt; ipchains --&gt; iptables
		è®©ç”¨æˆ·ç¼–å†™è§„åˆ™

	netfilter: framework
		hook function
			PREROUTINGï¼šè·¯ç”±å‰
			INPUTï¼šåˆ°è¾¾æœ¬æœºå†…éƒ¨çš„æŠ¥æ–‡å¿…ç»ä¹‹è·¯
			FORWARDï¼šç”±æœ¬æœºè½¬å‘çš„æŠ¥æ–‡å¿…ç»ä¹‹è·¯
			OUTPUTï¼šç”±æœ¬æœºå‘å‡ºçš„æŠ¥æ–‡çš„å¿…ç»ä¹‹è·¯
			POSTROUTINGï¼šè·¯ç”±å

    è§„åˆ™çš„åŠŸèƒ½ï¼š
		raw, mangle, nat, filter

		filter: è¿‡æ»¤ï¼Œå®šä¹‰æ˜¯å¦å…è®¸é€šè¿‡é˜²ç«å¢™
		nat: åœ°å€è½¬æ¢ï¼Œå¯ç”¨connection_track;(ç›®çš„æ˜¯ä¸ºäº†éšè—å†…éƒ¨ä¸»æœº)
			SNAT æºåœ°å€è½¬æ¢
			DNAT ç›®æ ‡åœ°å€
			PNAT ç›®æ ‡ç«¯å£
		mangle: æ‹†è§£æŠ¥æ–‡,ä½œå‡ºä¿®æ”¹, é‡æ–°å°è£…
		raw: å…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªåŠŸèƒ½ï¼› è¿æ¥è¿½è¸ªè¡¨,

    è¡¨å’Œé“¾çš„å¯¹åº”å…³ç³»ï¼š
        raw: PREROUTING, OUTPUT
        mangle: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING
        nat: PREROUTINGï¼ˆSNATï¼‰ï¼ŒPOSTROUTINGï¼ˆDNATï¼‰ï¼Œ[INPUTï¼Œ] OUTPUT
        filter: INPUT, FORWARD, OUTPUT

    æ•°æ®æŠ¥æ–‡æµç¨‹ï¼š
        è·Ÿæœ¬æœºå†…éƒ¨è¿›ç¨‹é€šä¿¡ï¼š
            è¿›å…¥ï¼šPREROUTING, INPUT
            å‡ºå»ï¼šOUTPUT, POSTROUTING

        ç”±æœ¬æœºè½¬å‘ï¼š
            PREROUTING, FORWARD, POSTROUTING


        æ•°æ®æŠ¥æ–‡çš„æµå‘ï¼š
            æºIPå’Œç›®æ ‡IPç”±æµå‘å†³å®šï¼›
            æµå…¥æŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šPREROUTING --&gt; INPUT
            æµå‡ºæŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šOUTPUT --&gt; POSTROUTING
            è½¬å‘æŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šPREROUTING --&gt; FORWARD --&gt; POSTROUTING

    æ€»ç»“ï¼šiptables/netfilter
        5ä¸ªé’©å­ï¼šç”Ÿæˆ5ä¸ªå†…ç½®é“¾
</code></pre><p><img src="/images/66/markdown-img-paste-20210629150606899.png" alt=""></p>
<h4 id="iptables-ä½¿ç”¨">iptables ä½¿ç”¨</h4>
<p><img src="/images/66/markdown-img-paste-2021062917492962.png" alt=""></p>
<pre><code>
iptables: ç”¨æˆ·ç©ºé—´çš„å·¥å…·ï¼Œå†™è§„åˆ™ï¼Œå¹¶è‡ªåŠ¨å‘å¾€netfilterï¼Œç«‹å³ç”Ÿæ•ˆï¼› è§„åˆ™éƒ½æ˜¯å†™åœ¨é“¾ä¸Š
netfilter: æ¥æ”¶å¹¶ç”Ÿæ•ˆè§„åˆ™ï¼›

é“¾: é“¾ä¸Šçš„è§„åˆ™æ¬¡åº, å³ä¸ºæ£€æŸ¥çš„æ¬¡åº,å› æ­¤éšå«ä¸€å®šçš„åº”ç”¨æ³•åˆ™
    1) åŒç±»è§„åˆ™(è®¿é—®åŒä¸€åº”ç”¨), åŒ¹é…èŒƒå›´å°çš„æ”¾ä¸Šé¢
    2) ä¸åŒç±»è§„åˆ™(è®¿é—®ä¸åŒåº”ç”¨),åŒ¹é…åˆ°æŠ¥æ–‡é¢‘ç‡è¾ƒå¤§çš„æ”¾ä¸Šé¢
    3) å°†é‚£äº›å¯ç”±ä¸€æ¡è§„åˆ™æè¿°çš„å¤šä¸ªè§„åˆ™åˆå¹¶
    4) è®¾ç½®é»˜è®¤ç­–ç•¥

åŸºæœ¬è¯­æ³•ï¼š
    é«˜åº¦æ¨¡å—åŒ–,ç”±è¯¸å¤šæ‰©å±•æ¨¡å—å®ç°å…¶æ£€æµ‹æ¡ä»¶æˆ–å¤„ç†åŠ¨ä½œçš„å®šä¹‰
        rpm -ql iptables :
            ipv6: /usr/lib64/xtables/libip6t
            ipv4: /usr/lib64/xtables/libipt,/usr/lib64/xtables/libxt


    iptables [-t TABLE] COMMAND CHAIN  CRETIRIA -j TARGET
    Iptables [-t table] COMMAND chain [-m matchname [per-match-options]] - targetname [per-target-options]

    -t TABLE:
        nat, mangle, raw, filter
        é»˜è®¤ä¸ºfilter

    COMMAND: ç®¡ç†å‘½ä»¤
        é“¾ï¼š
            -Nï¼šnew, è‡ªå»ºä¸€æ¡é“¾
                iptables -N in_web_rules
            -X: delete, åˆ é™¤ä¸€æ¡è‡ªå®šä¹‰çš„ç©ºé“¾
                æ³¨æ„: ä»…èƒ½åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„ å¼•ç”¨è®¡æ•°ä¸º0çš„ç©ºçš„é“¾;
                iptables -X in_web_rules
            -Pï¼špolicyï¼Œè®¾ç½®é»˜è®¤ç­–ç•¥ï¼Œå¯¹filterè¡¨æ¥è®²ï¼Œé»˜è®¤è§„åˆ™ä¸ºACCEPTæˆ–DROPï¼›
            -Eï¼šé‡å‘½åè‡ªå®šä¹‰é“¾
                iptables -E in_web_rules in_web_rules2

        é“¾ä¸­çš„è§„åˆ™ï¼š
            -A: append è¿½åŠ 
            -I: insert æ’å…¥,æŒ‡æ˜ä½ç½®,çœç•¥è¡¨ç¤ºç¬¬ä¸€æ¡
            -D: delete
                1) æŒ‡å®šè§„åˆ™åºå·
                    iptables -D FORWARD 1
                2) æŒ‡å®šè§„åˆ™æœ¬èº«
            -R: replace
            -Fï¼šflush, æ¸…ç©ºè§„åˆ™é“¾ï¼›
            -Zï¼šzeroï¼Œè®¡æ•°å™¨å½’é›¶

        æŸ¥è¯¢ï¼š
            -L
                -n: æ•°å­—æ ¼å¼æ˜¾ç¤ºä¸»æœºåœ°å€å’Œç«¯å£ï¼›
                -v: è¯¦ç»†æ ¼å¼ï¼Œ-vv, -vvv
                --line-numbers: æ˜¾ç¤ºè§„åˆ™ç¼–å·

                    pkts bytes  target     prot opt in        out         source               destination
                    åŒ…æ•° å­—èŠ‚æ•°   ç›®æ ‡       åè®®  æµå…¥çš„æ¥å£  æµå‡ºçš„æ¥å£   æºåœ°å€               ç›®æ ‡åœ°å€

                -x: exactlyï¼Œä¸è¦å¯¹è®¡æ•°å™¨çš„è®¡æ•°ç»“æœåšå•ä½æ¢ç®—ï¼Œè€Œæ˜¾ç¤ºå…¶ç²¾ç¡®å€¼

                ä¾‹å¦‚:( Læ˜¯å‘½ä»¤, å¿…é¡»æ”¾åœ¨æœ€å, å…¶ä»–çš„æ˜¯ä¿®é¥°Lçš„)
                    iptables -n nat -nvxL --line-numbers
                    iptables -nxvL INPUT --line-numbers

    iptables [-t TABLE] -A é“¾å åŒ¹é…æ¡ä»¶ -j å¤„ç†ç›®æ ‡
        åŒ¹é…æ¡ä»¶ï¼š
            é€šç”¨åŒ¹é…: æ— éœ€åŠ è½½ä»»ä½•æ¨¡å—
                [!] -s åœ°å€ï¼šæŒ‡å®šæŠ¥æ–‡æºIPåœ°å€åŒ¹é…çš„èŒƒå›´ï¼›å¯ä»¥æ˜¯IPï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œåœ°å€ï¼›å¯ä½¿ç”¨!å–åï¼›
                    --src, --source
                [!] -d åœ°å€ï¼šæŒ‡å®šæŠ¥æ–‡ç›®æ ‡IPåœ°å€åŒ¹é…çš„èŒƒå›´ï¼›
                    --dst, --destination
                [!] -p åè®®ï¼šæŒ‡å®šåŒ¹é…æŠ¥æ–‡çš„åè®®ç±»å‹ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§tcp, udpå’Œicmp;
                [!] -i INTERFACE: æ•°æ®æŠ¥æ–‡æµå…¥çš„æ¥å£ï¼›PREROUTING, INPUT, FORWARD
                [!] -o INTERFACE: æ•°æ®æŠ¥æ–‡æµå‡ºçš„æ¥å£ï¼›OUTPUT, FORWARD, POSTROUITING

                ä¾‹å¦‚:
                    # è®¾ç½®é»˜è®¤åªèƒ½è¢«172.16.0.0/16 ç½‘æ®µè®¿é—®
                    iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -j ACCEPT
                    # è®¾ç½®é»˜è®¤åªèƒ½è®¿é—®172.16.0.0/16 ç½‘æ®µ
                    iptables -t filter -A OUTPUT -s 172.16.76.220 -d 172.16.0.0/16 -p tcp -j ACCEPT
                    # è®¾ç½®é»˜è®¤å…¥å£å’Œå‡ºå£ä¸ºDROP
                    iptables -P INPUT DROP
                    iptables -P OUTPUT DROP

                    # ä»…å…è®¸172.16.76.0/24 ç½‘æ®µping
                    iptables -A INPUT ! -s 172.16.76.0/24 -d 172.16.76.220 -p icmp -j DROP

            æ‰©å±•åŒ¹é…
                éšå¼æ‰©å±•ï¼šå½“ä½¿ç”¨-p {tcp|udp|icmp}ä¸­çš„ä¸€ç§æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ä¸“ç”¨é€‰é¡¹ï¼›
                    -p tcp:
                        [!] --sport PORT[-PORT]: æŒ‡å®šæºç«¯å£,å¯ä»¥æ˜¯èŒƒå›´
                        [!] --dport PORT[-PORT]: æŒ‡å®šç›®æ ‡ç«¯å£,å¯ä»¥æ˜¯èŒƒå›´
                        [!] --tcp-flags mask comp
                            ä¾‹å¦‚:
                                # ä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ¬¡: FIN=1,ACK=0,FIN=0,RST=0
                                &quot;--tcp-flags SYN,ACK,FIN,RST FIN&quot; : è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°å››ä¸ªè¡¨ç¤ºä½æ˜¯éœ€è¦æ£€æŸ¥çš„, ç¬¬äºŒä¸ªå‚æ•°FINåˆ™å¿…é¡»æ˜¯1
                        [!] --syn : å¸¸ç”¨,ç®€å†™; ç›¸å½“äº&quot;--tcp-flags SYN,ACK,FIN,RST FIN&quot;

                    -p udp:
                        [!] --sport
                        [!] --dport
                    -p icmp
                        [!] --icmp-type 8 : ping çš„è¯·æ±‚åŒ…
                        [!] --icmp-type 0 : ping çš„è¿”å›åŒ…

                        ä¾‹å¦‚:
                            # æˆ‘ä»¬æƒ³è¦è®©å±€åŸŸç½‘å¯ä»¥pingæœ¬æœº, ä½†æ˜¯ä¸å…è®¸æœ¬æœºpingå¤–ç½‘
                            #1. é¦–å…ˆåŠ ä¸Šç¦æ­¢è§„åˆ™
                            iptables -A INPUT -d 172.16.76.220 -p icmp -j REJECT
                            iptables -A OUTPUT -s 172.16.76.220 -p icmp -j REJECT
                            #2. é¦–å…ˆå…è®¸ æ¥æ”¶ --icmp-type 8 çš„è¯·æ±‚ (æ­¤æ—¶pingæ•°æ®åªèƒ½è¿›ä¸èƒ½å‡º)
                            iptables -I INPUT 1 -s 172.16.76.0/24 -d 172.16.76.220 -p icmp --icmp-type 8 -j ACCEPT
                            #3. å†å…è®¸å‡º
                            iptables -I OUTPUT 1 -s 172.16.76.220 -d 172.16.76.0/24 -p icmp --icmp-type 0 -j ACCEPT

                æ˜¾å¼æ‰©å±•(è£…å…¥æ¨¡å—)ï¼šå¿…é¡»æ˜ç¡®è¯´æ˜ä½¿ç”¨å“ªä¸ªæ¨¡å—è¿›è¡Œæ‰©å±•ï¼Œè€Œåæ‰èƒ½ä½¿ç”¨å…¶æ‰©å±•ä¸“ç”¨é€‰é¡¹ï¼›
                    -m æ‰©å±•æ¨¡å—åç§°

                    æ¨¡å—ï¼šiptablesï¼Œnetfilterå„æ‹¥æœ‰ä¸€éƒ¨åˆ†ä»£ç 

                    1. multiport: å¤šç«¯å£åŒ¹é…
                        å¯ç”¨äºåŒ¹é…éè¿ç»­æˆ–è¿ç»­ç«¯å£ï¼›æœ€å¤šæŒ‡å®š15ä¸ªç«¯å£ï¼›

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --source-ports, --sports port[,port,port:port]
                            [!] --destination-ports, --dports
                            [!] --ports

                        ä¾‹å­ï¼š
                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp -m multiport --dports 22,80 -j ACCEPT
                            ~]# iptables -I OUTPUT -s 172.16.100.7 -p tcp -m multiport --sports 22,80 -j ACCEPT
                            ~]# iptables -I INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp -m multiport --dports 30000:31000,22,80 -j ACCEPT

                    2. iprange: åŒ¹é…æŒ‡å®šèŒƒå›´å†…çš„åœ°å€ï¼›
                        åŒ¹é…ä¸€æ®µè¿ç»­çš„åœ°å€è€Œéæ•´ä¸ªç½‘ç»œæ—¶æœ‰ç”¨ï¼›

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --src-ragne IP[-IP]
                            [!] --dst-range

                        ~]# iptables -A INPUT -d 172.16.100.7 -p tcp --dport 23 -m iprange --src-range 172.16.100.1-172.16.100.100 -j ACCEPT
                        ~]# iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 23 -m iprange --dst-range 172.16.100.1-172.16.100.100 -j ACCEPT

                    3. time: åŸºäºæ—¶é—´åšè®¿é—®æ§åˆ¶
                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --datestart YYYY[-MM][-DD[Thh[:mm[:ss]]]]
                            --datestop

                            [!] --timestart hh:mm[:ss]
                            [!] --timestop hh:mm[:ss]

                            --weekdays day[,day]
                                Mon, Tue,
                            --kerneltz : ä½¿ç”¨å†…æ ¸é…ç½®çš„æ—¶åŒºè€Œéé»˜è®¤çš„UTC ;

                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -m time --timestart 08:20 --timestop 18:40 --weekdays Mon,Tue,Thu,Fri -j REJECT
                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -m time --timestart 08:20 --timestop 18:40 --weekdays 1,2,3,4,5 --kerneltz -j REJECT

                    4. string: å­—ç¬¦ä¸²åŒ¹é…ï¼Œèƒ½å¤Ÿæ£€æµ‹æŠ¥æ–‡åº”ç”¨å±‚ä¸­çš„å­—ç¬¦ä¸²
                        æ³¨æ„: åªèƒ½æ£€æµ‹æ˜æ–‡, å¯¹äºhttps,sshåè®®çš„ç¼–ç çš„æ— æ³•è¿‡æ»¤

                        å­—ç¬¦åŒ¹é…æ£€æŸ¥é«˜æ•ˆç®—æ³•
                            kmp, bm

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --algo {kmp|bm}
                            [!] --string &quot;STRING&quot;
                            [!] --hex-string &quot;HEX_STRING&quot;: HEX_STRINGä¸ºç¼–ç æˆ16è¿›åˆ¶æ ¼å¼çš„å­—ä¸²ï¼›

                        ~]# iptables -I OUTPUT -m string --algo kmp --string &quot;sex&quot; -j DROP

                    5. connlimit: è¿æ¥æ•°é™åˆ¶ï¼Œå¯¹æ¯IPæ‰€èƒ½å¤Ÿå‘èµ·å¹¶å‘è¿æ¥æ•°åšé™åˆ¶ï¼›
                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --connlimit-above [n] å¤§äºç­‰äº æ‹’ç»
                            [!] --connlimit-upto [n]  å°äºç­‰äºå…è®¸
                            ~]# iptables -I INPUT -d 172.16.76.220 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j DROP
                            ~]# iptables -R INPUT 1 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp --dport 22 -m connlimit --connlimit-upto 2 -j ACCEPT

                    6. limit: é€Ÿç‡é™åˆ¶; é™åˆ¶çš„æ˜¯æ¯ç§’çš„æŠ¥æ–‡

                        æ³¨æ„: ä»¤ç‰Œæ¡¶çš„æ–¹å¼é™åˆ¶é€Ÿç‡, æ¯”å¦‚å‘5ä¸ªä»¤ç‰Œ, æ‹¿ä¸€ä¸ªé€šè¿‡ä¸€ä¸ª,æ²¡æœ‰ä»¤ç‰Œäº†å°±é˜»å¡

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --limit n[/second|/minute|/hour|/day]
                            --limit-burst n

                        ä¾‹å­ï¼š
                        # iptables -A INPUT -d 172.16.76.220 -p icmp --icmp-type 8 -m limit --limit 20/minute --limit-burst 5 -j ACCEPT
                        # é™åˆ¶ æœ¬æœºæŸtcpæœåŠ¡æ¥æ”¶æ–°è¯·æ±‚çš„é€Ÿç‡: ä½¿ç”¨--syn + -m limit

                    7. state: çŠ¶æ€æ£€æŸ¥,è¿æ¥è¿½è¸ª
                        &gt; å†…æ ¸å†…å­˜ç©ºé—´ä¿å­˜ å®¢æˆ·ç«¯çš„è®¿é—®è®°å½•

						ä¸“ç”¨é€‰é¡¹ï¼š
							--state

						è¿æ¥è¿½è¸ªä¸­çš„çŠ¶æ€ï¼š
							NEW: æ–°å»ºç«‹ä¸€ä¸ªä¼šè¯(è·Ÿåè®®æ— å…³, å¯ä»¥è¿½è¸ªtcp,udp,icmp )
							ESTABLISHEDï¼šå·²å»ºç«‹çš„è¿æ¥
                            UNTRACKED: æœªè¿½è¸ªçš„
							RELATED: æœ‰å…³è”å…³ç³»çš„è¿æ¥
							INVALID: æ— æ³•è¯†åˆ«çš„è¿æ¥


						è°ƒæ•´è¿æ¥è¿½è¸ªåŠŸèƒ½æ‰€èƒ½å®¹çº³çš„è¿æ¥çš„æœ€å¤§æ•°ç›®ï¼š
							/proc/sys/net/nf_conntrack_max

						å½“å‰è¿½è¸ªçš„æ‰€æœ‰è¿æ¥
							/proc/net/nf_conntrack

						ä¸åŒåè®®æˆ–è¿æ¥ç±»å‹è¿½è¸ªæ—¶çš„å±æ€§ï¼š
							/proc/sys/net/netfilterç›®å½•ï¼š

						æ”¾è¡Œè¢«åŠ¨æ¨¡å¼ä¸‹çš„FTPæœåŠ¡ï¼š
							1ã€è£…è½½æ¨¡å—/lib/modules/KERNEL_VERSION/kernel/net/netfilter/
								æ¨¡å—ï¼šnf_conntrack_ftp
                                å‘½ä»¤: modprobe nf_conntrack_ftp

							2ã€æ”¾è¡Œè¯·æ±‚æŠ¥æ–‡ï¼š
							 	1ï¼‰æ”¾è¡ŒNEWçŠ¶æ€å¯¹21ç«¯å£è¯·æ±‚çš„æŠ¥æ–‡ï¼›
							 	2) æ”¾è¡ŒESTABLISHEDä»¥åŠRELATEDçŠ¶æ€çš„æŠ¥æ–‡

							 3ã€æ—…è¡Œå“åº”æŠ¥æ–‡ï¼š
							 	(1) æ”¾è¡ŒESTABLISHEDä»¥åŠRELATEDçŠ¶æ€çš„æŠ¥æ–‡

                        ä¾‹å¦‚:
                            ~]# iptables -A INPUT -d 172.16.76.220 -p tcp -m multiport --dports 22,8011,80,3306 -m state --state NEW -j ACCEPT
                            ~]# iptables -A INPUT -d 172.16.76.220 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
                            ~]# iptables -A OUTPUT -s 172.16.76.220 -m state --state ESTABLISHED,RELATED -j ACCEPT

        å¤„ç†åŠ¨ä½œ:
            åŸºæœ¬å¤„ç†åŠ¨ä½œ: ACCEPT, DROP
            æ‰©å±•å¤„ç†åŠ¨ä½œ: REJECT, RETURN , LOG, REDIRECT ,...
                REJECT:
                    --reject-with type
                    The type  given  can  be  icmp-net-unreachable,  icmp-host-unreachable,  icmp-port-unreachable,  icmp-proto-unreachable,  icmp-net-prohibited,icmp-host-prohibited,  or  icmp-admin-prohibited  (*), which return the appropriate ICMP error message (icmp-port-unreachable is the default).

                LOG :
                    --log-level
                    --log-prefix
                    é»˜è®¤æ—¥å¿—ä¿å­˜äº/var/log/message
                    ~]# iptables -R INPUT 1 -d 172.16.76.220 -p tcp ! --dport 22 -j LOG --log-prefix &quot;mylog &quot; --log-level 2
            ç”¨æˆ·è‡ªå®šä¹‰é“¾:

                ~]# iptables -N in_ping_rules
                ~]# iptables -A in_ping_rules -s 172.16.76.0/24 -d 172.16.76.220 -p icmp --icmp-type 8 -j ACCEPT
                ~]# iptables -A in_ping_rules  -d 172.16.76.220 -p icmp  -j REJECT
                ~]# iptables -A INPUT -d 172.16.76.220 -j in_ping_rules


    centos6:
        ä¿å­˜å¯ç”¨ä¸­çš„è§„åˆ™äºè§„åˆ™æ–‡ä»¶ä¸­ï¼š
                1ã€# iptables-save &gt; /etc/sysconfig/iptables
                2ã€# service iptables save

        ç”Ÿæ•ˆè§„åˆ™æ–‡ä»¶ä¸­çš„è§„åˆ™ï¼š
                1ã€# iptables-restore &lt; /etc/sysconfig/iptables
                2ã€# service iptables restart
                    æ‰§è¡Œçš„æ“ä½œï¼šæ¸…ç©ºç°æœ‰è§„åˆ™ï¼Œè¯»å–å¹¶ç”Ÿæ•ˆè§„åˆ™æ–‡ä»¶ä¸­çš„è§„åˆ™
    centos7:
        1) è‡ªå®šä¹‰unit file, è¿›è¡Œiptables-restore
        2) firewalldæœåŠ¡
        3) è‡ªå®šä¹‰è„šæœ¬

</code></pre><h4 id="ç»ƒä¹ ">ç»ƒä¹ </h4>
<pre><code>
ç»ƒä¹ ï¼šINPUTå’ŒOUTPUTé»˜è®¤ç­–ç•¥ä¸ºDROPï¼›

	1ã€é™åˆ¶æœ¬åœ°ä¸»æœºçš„webæœåŠ¡å™¨åœ¨å‘¨ä¸€ä¸å…è®¸è®¿é—®ï¼›æ–°è¯·æ±‚çš„é€Ÿç‡ä¸èƒ½è¶…è¿‡100ä¸ªæ¯ç§’ï¼›webæœåŠ¡å™¨åŒ…å«äº†adminå­—ç¬¦ä¸²çš„é¡µé¢ä¸å…è®¸è®¿é—®ï¼›webæœåŠ¡å™¨ä»…å…è®¸å“åº”æŠ¥æ–‡ç¦»å¼€æœ¬æœºï¼›
		iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m time --weekdays 2,3,4,5,6,7 -j ACCEPT  

        iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m state --state NEW -m limit --limit 100/second -j ACCEPT

        iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m string --algo kmp --string &quot;admin&quot; -j REJECT

        iptables -I OUTPUT -s 172.16.76.220 -tcp -m multiport --dports 8011,80,443 -m state --state ESTABLISHED,RELATED -j ACCEPT

	2ã€åœ¨å·¥ä½œæ—¶é—´ï¼Œå³å‘¨ä¸€åˆ°å‘¨äº”çš„8:30-18:00ï¼Œå¼€æ”¾æœ¬æœºçš„ftpæœåŠ¡ç»™172.16.0.0ç½‘ç»œä¸­çš„ä¸»æœºè®¿é—®ï¼›æ•°æ®ä¸‹è½½è¯·æ±‚çš„æ¬¡æ•°æ¯åˆ†é’Ÿä¸å¾—è¶…è¿‡5ä¸ªï¼›
        iptables -I  INPUT 3 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -m multiport --dports 21,1024:65535 -m time --timestart 8:30 --timestop 18:00 --kerneltz -j ACCEPT  

        iptables -I INPUT 4 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -m multiport --dports 1024: -m limit --limit 5/minute -j ACCEPT

	3ã€å¼€æ”¾æœ¬æœºçš„sshæœåŠ¡ç»™172.16.x.1-172.16.x.100ä¸­çš„ä¸»æœºï¼Œxä¸ºä½ çš„åº§ä½å·ï¼Œæ–°è¯·æ±‚å»ºç«‹çš„é€Ÿç‡ä¸€åˆ†é’Ÿä¸å¾—è¶…è¿‡2ä¸ªï¼›ä»…å…è®¸å“åº”æŠ¥æ–‡é€šè¿‡å…¶æœåŠ¡ç«¯å£ç¦»å¼€æœ¬æœºï¼›

        iptables -I INPUT -p tcp -m iprange --src-range 172.16.x.1-172.16.x.100 -m state --state NEW -m limit --limit 2/minute -j ACCEPT
        iptables -I OUTPUT -p tcp --sport 22 -j ACCEPT

	4ã€æ‹’ç»TCPæ ‡å¿—ä½å…¨éƒ¨ä¸º1åŠå…¨éƒ¨ä¸º0çš„æŠ¥æ–‡è®¿é—®æœ¬æœºï¼›
        iptales -I INPUT -d 172.16.76.220 -p tcp --tcp-flags SYN,ACK,FIN,RST SYN,ACK,FIN,RST  -j REJECT
        iptales -I INPUT -d 172.16.76.220 -p tcp --tcp-flags SYN,ACK,FIN,RST   -j REJECT

        [root@centos7 ~]#iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
        [root@centos7 ~]#iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP

	5ã€å…è®¸æœ¬æœºpingåˆ«çš„ä¸»æœºï¼›ä½†ä¸å¼€æ”¾åˆ«çš„ä¸»æœºpingæœ¬æœºï¼›

        iptables -I INPUT -p icmp --icmp-type 8 -j REJECT
        iptables -I INPUT -p icmp --icmp-type 0 -j ACCEPT  
        iptables -I OUTPUT  -p icmp --icmp-type 8 -j ACCEPT





	ç»ƒä¹ ï¼šåˆ¤æ–­ä¸‹è¿°è§„åˆ™çš„æ„ä¹‰ï¼š
	# iptables -N clean_in
        åˆ›å»ºè‡ªå®šä¹‰é“¾ clean_in
	# iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP
        è‡ªå®šä¹‰é“¾clean_in æœ€åä¸€è¡Œè¿½åŠ è§„åˆ™, ç¦æ­¢ç›®æ ‡åœ°å€æ˜¯255.255.255.255çš„icmpæŠ¥æ–‡
	# iptables -A clean_in -d 172.16.255.255 -p icmp -j DROP
        ç¦æ­¢ç›®æ ‡åœ°å€æ˜¯172.16.255.255çš„icmpæŠ¥æ–‡
	# iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP
        æ‰€æœ‰æ–°å»ºè¿æ¥ ä¸æ˜¯ä¸‰æ¬¡æ¡æ‰‹ç¬¬ä¸€æ¬¡çš„ éƒ½æ‹’ç»
	# iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP
        æ‹’ç»tcpæŠ¥æ–‡æ ‡å¿—ä½æ˜¯å…¨1çš„æŠ¥æ–‡
	# iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP
        æ‹’ç»tcpæŠ¥æ–‡æ ‡å¿—ä½æ˜¯å…¨0çš„æŠ¥æ–‡
	# iptables -A clean_in -d 172.16.100.7 -j RETURN
        ç›®æ ‡åœ°å€æ˜¯172.16.100.7çš„ç›´æ¥è¿”å›
	# iptables -A INPUT -d 172.16.100.7 -j clean_in
        ç›®æ ‡åœ°å€æ˜¯172.16.100.7 çš„åŒ¹é…è‡ªå®šä¹‰é“¾clean_inä¸­çš„è§„åˆ™

	# iptables -A INPUT  -i lo -j ACCEPT
        æœ¬åœ°å›ç¯ç½‘å¡è¾“å…¥è¯·æ±‚å…¨éƒ¨é€šè¿‡
	# iptables -A OUTPUT -o lo -j ACCEPT
        æœ¬åœ°å›ç¯ç½‘å¡è¾“å‡ºè¯·æ±‚å…¨éƒ¨é€šè¿‡


	# iptables -A INPUT  -i eth0 -m multiport -p tcp --dports 53,113,135,137,139,445 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 53,113,135,137,139,445ç«¯å£çš„tcpè¯·æ±‚å…¨éƒ¨æ‹’ç»
	# iptables -A INPUT  -i eth0 -m multiport -p udp --dports 53,113,135,137,139,445 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 53,113,135,137,139,445ç«¯å£çš„udpè¯·æ±‚å…¨éƒ¨æ‹’ç»
	# iptables -A INPUT  -i eth0 -p udp --dport 1026 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 1026ç«¯å£çš„udpè¯·æ±‚æ‹’ç»
	# iptables -A INPUT  -p icmp -m limit --limit 10/second -j ACCEPT
        ä»…å…è®¸æ¯ç§’10æ¬¡çš„pingæŠ¥æ–‡
</code></pre><h4 id="å‘½ä»¤æ€»ç»“">å‘½ä»¤æ€»ç»“</h4>
<pre><code>iptables:
    [-t table ] COMMAND [chain] rule-specification
        -m matchname [per-match-options]
        -t targetname [per-target-options]
        [options]
    åŒ¹é…æ¡ä»¶ï¼š
    	åŸºæœ¬åŒ¹é…æ¡ä»¶ï¼š-sï¼Œ-dï¼Œ-pï¼Œ-m-ï¼Œ-æ‰©å±•åŒ¹é…æ¡ä»¶ï¼š
    		éšå¼æ‰©å±•ï¼š
    	 		-p tcp: --dport, --sport, -tcp-flags,--syn
    	 		-p udp:--dport,--sport
    	 		-p imcp:--icmp-type
    		æ˜¾å¼æ‰©å±•ï¼š
    	 		multiport: --sports, --dports
    	 		iprange: --src-range,-dst-range
    	 		time: -timestart, -timestop, --weekdays, -monthdays, --datestart,--datestop
    	 		string: --algo {bm kmp), --string
    	 		connlimit: --connlimit-upto, -connllimit-above
    	 		limit: --limit, --limit-burst
    	 		state: --state
    	 			NEW, ESTABLISHED, RELATED, INVALID, UNTRACKED

    Target:
    	-j:
    		ACCEPT/DROP
    		REJECT: --reject-with
    		LOG: --log-level, -log-prefix
            è‡ªå®šä¹‰é“¾
            RETURN
</code></pre><h4 id="iptables-forwardé“¾">iptables forwardé“¾</h4>
<p><img src="/images/66/markdown-img-paste-20210702134647247.png" alt=""></p>
<pre><code>iptalbes -A FORWARD -j REJECT
# å› ä¸ºforward åœ¨å…¥å’Œå‡ºéƒ½æ˜¯ç»è¿‡çš„é“¾è·¯
iptables -I FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT
iptables -I FORWARD -d 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT

#  é»˜è®¤è®¾ç½®å…è®¸å‡º
iptables -I FORWARD -m state --state ESTABLISHED -j ACCEPT
# å…è®¸ç½‘ç»œ 192.168.10.0/24 è®¿é—® (172.16.0.67) 80 ç«¯å£
iptables -I FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT
# å…è®¸ è®¿é—®192.168.10.2çš„80
iptables -I FORWARD -d 192.168.10.2 -p tcp --dprot 80 -m state --state NEW -j ACCEPT
</code></pre><h4 id="iptables-nat">iptables NAT</h4>
<pre><code>ä¸ºäº†è§£å†³å†…ç½‘ipä¸æš´éœ²ç»™å¤–ç½‘
åŒäº‹è§£å†³äº†ipv4ä¸è¶³çš„é—®é¢˜

# SNAT : å®¢æˆ·ç«¯å‡ºå»çš„æ—¶å€™, è·¯ç”±ä¿®æ”¹æºipåœ°å€(ä¿æŠ¤å®¢æˆ·ç«¯çš„æœ¬åœ°ip)
# DNAT : æœåŠ¡ç«¯è¢«è¯·æ±‚çš„æ—¶å€™, æœåŠ¡ç«¯çš„è·¯ç”±ä¿®æ”¹æŠ¥æ–‡çš„ç›®çš„ip(ä¿æŠ¤æœåŠ¡ç«¯çš„å†…ç½‘ip)
# PAT  : ç«¯å£åœ°å€è½¬æ¢(æ›´å¤šæ˜¯ä¿®æ”¹ç›®æ ‡ç«¯å£)

DNAT æ˜¯åº”è¯¥åœ¨iptablesçš„å“ªä¸ªé“¾è·¯ä¿®æ”¹å‘¢?
æ¯”å¦‚ client =&gt; server -&gt; prerouting -&gt; router -&gt; input   âŒè¿™å°±ä¼šè·¯ç”±æœ¬æœºè¯·æ±‚äº†
                                |            \_&gt; forward âŒè¿™å°±æ˜¯ç›´æ¥è·¯ç”±äº†, åªæ˜¯ä¿®æ”¹macåœ°å€
                                 \_&gt; âœ… åœ¨pretouringçš„æ—¶å€™ä¿®æ”¹å°±å¯ä»¥äº†

SNAT åº”è¯¥æ˜¯åœ¨iptables  POSTROUTINGçš„æ—¶å€™ä¿®æ”¹


    SNAT
        --to-sourece è½¬åˆ°é™æ€ip
        --random  å®ç°è´Ÿè½½å‡è¡¡
        --persistent
    MASQUERADE (SNATåŠŸèƒ½, åŠ¨æ€ipçš„åœºæ™¯)
    DNAT
        --to-destination [addr:port] è½¬åˆ°é™æ€ip
        --random  å®ç°è´Ÿè½½å‡è¡¡
        --persistent
    REDIRECT
        --to-ports port

&gt; ä½†æ˜¯ç°åœ¨æˆ‘ä»¬éƒ½ä¸ä½¿ç”¨iptablesæ¥å®ç°äº†,æœ‰ä¸“é—¨çš„lvs

&gt; æ³¨æ„: è™½ç„¶è·¯ç”±å™¨ä¸Šæ²¡æœ‰ç›‘å¬å¯¹åº”çš„ç«¯å£æ¥è½¬å‘, ä½†æ˜¯å®ƒåœ¨å†…æ ¸å·²ç»å…·æœ‰äº†è½¬å‘åŠŸèƒ½, ä¸éœ€è¦åœ¨ç”¨æˆ·æ€å‡è£…å¼€å¯äº†æŸä¸ªç«¯å£ä½œä¸ºè½¬å‘

</code></pre><p><img src="/images/66/markdown-img-paste-20210702134647247.png" alt=""></p>
<pre><code># ä¾‹å­ éšè—å†…éƒ¨ç½‘ç»œå®¢æˆ·ç«¯ip -&gt; SNAT
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.0.6
</code></pre><p><img src="/images/66/markdown-img-paste-20210702143310515.png" alt=""></p>
<pre><code># ä¾‹å­ å› æ­¤å†…éƒ¨å¾€æ¥æœåŠ¡å™¨ip -&gt; DNAT
iptables -t nat -A PREROUTING -d 172.16.0.67 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.2
# æ­¤æ—¶å¦‚æœè¦æ‹’ç», ç”±äºdnatå·²ç»ä¿®æ”¹äº†ç›®æ ‡åœ°å€,æ‰€ä»¥-d ä¸æ˜¯172, è€Œæ˜¯192
iptables -A FORWARD -s 172.16.0.200 -p tcp --dport 80 -d 192.168.10.2 -j REJECT
</code></pre><h3 id="ioæ¨¡å‹">IOæ¨¡å‹</h3>
<pre><code>I/Oæ¨¡å‹ï¼š
    æ¨¡å‹:
	   é˜»å¡å‹ã€ ä¸€èˆ¬ioé˜»å¡æ˜¯ä¸å¯ä¸­æ–­çš„çŠ¶æ€
       éé˜»å¡å‹ã€
       å¤ç”¨å‹ã€
       ä¿¡å·é©±åŠ¨å‹ã€
       å¼‚æ­¥

    ä¸€æ¬¡æ–‡ä»¶Oè¯·æ±‚ï¼Œéƒ½ä¼šç”±ä¸¤é˜¶æ®µç»„æˆï¼š
       ç¬¬ä¸€æ­¥ï¼šç­‰å¾…æ•°æ®ï¼Œå³æ•°æ®ä»ç£ç›˜åˆ°å†…æ ¸å†…å­˜(æ¶ˆè€—æ—¶é—´)
       ç¬¬äºŒæ­¥ï¼šå¤åˆ¶æ•°æ®ï¼Œå³æ•°æ®å†…æ ¸å†…å­˜åˆ°è¿›ç¨‹å†…å­˜

       æ³¨æ„:
           é˜»å¡å‹: ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ éƒ½æ˜¯é˜»å¡
           éé˜»å¡å‹: ç¬¬ä¸€æ­¥éé˜»å¡,ç¬¬äºŒæ­¥æ˜¯é˜»å¡

	åŒæ­¥/å¼‚æ­¥ï¼š
		å…³æ³¨æ¶ˆæ¯é€šçŸ¥æœºåˆ¶
		æ¶ˆæ¯é€šçŸ¥ï¼š
			åŒæ­¥ï¼šç­‰å¾…å¯¹æ–¹è¿”å›æ¶ˆæ¯
			å¼‚æ­¥ï¼šè¢«è°ƒç”¨è€…é€šè¿‡çŠ¶æ€ã€é€šçŸ¥æˆ–å›è°ƒæœºåˆ¶é€šçŸ¥è°ƒç”¨è€…è¢«è°ƒç”¨è€…çš„è¿è¡ŒçŠ¶æ€
	é˜»å¡/éé˜»å¡ï¼š
		å…³æ³¨è°ƒç”¨è€…åœ¨ç­‰å¾…ç»“æœè¿”å›ä¹‹å‰æ‰€å¤„çš„çŠ¶æ€
			é˜»å¡ï¼š blockingï¼Œè°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…è¢«æŒ‚èµ·
			éé˜»å¡ï¼š nonblockingï¼Œè°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…ä¸ä¼šè¢«æŒ‚èµ·

	å¤ç”¨å‹ioè°ƒç”¨ï¼š
        &gt; åœ¨ç‰¹æ®Šçš„ç»„ä»¶ä¸Šé˜»å¡,ioå¤ç”¨å™¨å¯ä»¥å¸®åŠ©æŸä¸ªç”¨æˆ·è¿›ç¨‹ç›‘æ§ioé˜»å¡, åªä¸è¿‡ä¸ä¼šé˜»å¡ç”¨æˆ·è¿›ç¨‹, é˜»å¡çš„ä½ç½®ä¸åŒ
 		select(): æœ€é«˜å¹¶å‘1024
 		poll():

        event-driven: (ä¿¡å·é©±åŠ¨å‹)
            epoll(linux): libevent
            kqueue(bsd)
            /dev/poll(solaris)
</code></pre><p><img src="/images/66/markdown-img-paste-2021070215362884.png" alt=""></p>
<h3 id="ç¼“å­˜">ç¼“å­˜</h3>
<pre><code>äºŒå…«æ¨¡å‹
ä½¿ç”¨çº¿ä¸Šæ•°æ®å…ˆå¯¹ç¼“å­˜è¿›è¡Œå‹æµ‹, ç­‰å¾…ç¼“å­˜æœåŠ¡å™¨warm up

ç¼“å­˜å‘½ä¸­ç‡
    é¡µé¢å‘½ä¸­ç‡
    å­—èŠ‚å‘½ä¸­ç‡
ç¼“å­˜ä¸å¦
    ç§æœ‰æ•°æ®
    å…¬å…±æ•°æ®
ç¼“å­˜æ¨¡å¼
    ä»£ç†å¼ç¼“å­˜:
        æœªå‘½ä¸­, ç¼“å­˜æœåŠ¡å™¨å»æ‰¾åç«¯RS
        http+ç¼“å­˜ (squid,varnish )
        squid å’Œvarnishçš„å…³ç³»å°±åƒ apache å’Œnginx
    æ—æŒ‚å¼ç¼“å­˜:
        æœªå‘½ä¸­, å®¢æˆ·ç«¯è‡ªå·±å»æ‰¾åç«¯RS
        ä¸“ç”¨ç¼“å­˜(memorycache,redis )


cache-response-directive =
      &quot;public&quot;                               
    | &quot;private&quot; [ &quot;=&quot; &lt;&quot;&gt; 1#field-name &lt;&quot;&gt; ]
    | &quot;no-cache&quot; [ &quot;=&quot; &lt;&quot;&gt; 1#field-name &lt;&quot;&gt; ] ,å¯ä»¥ç¼“å­˜,ä½†æ˜¯å“åº”ç»™å®¢æˆ·ç«¯ä¹‹å‰éœ€è¦è¯·æ±‚æœåŠ¡ç«¯æ¡ä»¶å¼éªŒè¯ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ,
    | &quot;no-store&quot;   , ä¸å…è®¸å­˜å‚¨å“åº”å†…å®¹äºç¼“å­˜ä¸­                         
    | &quot;no-transform&quot;                         
    | &quot;must-revalidate&quot; åŒ no-cache                     
    | &quot;proxy-revalidate&quot;                    
    | &quot;max-age&quot; &quot;=&quot; delta-seconds            
    | &quot;s-maxage&quot; &quot;=&quot; delta-seconds           
    | cache-extension            
</code></pre><p><img src="/images/66/markdown-img-paste-20210709182934970.png" alt=""></p>
<p><img src="/images/66/markdown-img-paste-20210709183834825.png" alt="">
<img src="/images/66/markdown-img-paste-20210709184000155.png" alt="">
<img src="/images/66/markdown-img-paste-20210709183933301.png" alt=""></p>
<h4 id="varnish">varnish</h4>
<pre><code>æ“ä½œç¬¦:
    ==,!=,~,&gt;,&gt;=,&lt;,&lt;=
    é€»è¾‘ &amp;&amp;,||,!
    èµ‹å€¼ =

å†…å»ºå˜é‡
    req.*   : å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚æŠ¥æ–‡
        (be)req.http.*
            req.http.User-Agent ~ &quot;chrome&quot;
            req.http.Cookie
            (be)req.http.Reffer
            (be)req.http.HEADERS
        (be)req.request : è¯·æ±‚æ–¹æ³•
        (be)req.url  è¯·æ±‚url
        (be)req.proto
        (be)req.backend
    resp.*   : varnishå‘é€ç»™client
        (be)resp.http.HEADERS
        (be)resp.status
        (be)resp.backend.name backendä¸»æœºå
        (be)resp.ttl
        (be)resp.proto
    bereq.*  : ç”±varnishå‘ç»™backendä¸»æœºçš„httpdè¯·æ±‚
    beresp.* : ç”±backendå“åº”ç»™varnishçš„æŠ¥æ–‡
    obj.*    : ä¿å­˜åœ¨ç¼“å­˜ç©ºé—´çš„ç¼“å­˜å¯¹è±¡
        ojb.hits
        obj.ttl
    server.*
        server.ip
        server.hostname
    client.*
        client.ip
å†…å»ºå‡½æ•°
    regsub(str,regex,sub)
    regsuball(str,regex,sub)
    ban(boolean expression)
    hash_data(input)
client side :
    vcl_deliver: ç›´æ¥å‘é€å®¢æˆ·ç«¯
    vcl_pipe: æ²¡æœ‰åŒ¹é…åˆ°çš„è§„åˆ™
    vcl_pass:

</code></pre><ul>
<li>
<p>å†…ç½®å˜é‡æ˜¯å¦å¯ä»¥ä¿®æ”¹
<img src="/images/66/markdown-img-paste-20210712110939380.png" alt=""></p>
</li>
<li>
<p>ç¤ºä¾‹1 obj.hits å†…å»ºå˜é‡</p>
</li>
</ul>
<pre><code>sub vcl_deliver {
    if (obj.hits &gt; 0 ) {
        set resp.http.X-cache = &quot;Hit via &quot;+server.ip;
        set resp.http.X-hit-count =  &quot;Hit &quot;+obj.hits ;
    } else {
        set resp.http.X-cache = &quot;Miss from &quot;+server.ip;
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹2 æ˜¯å¦åŒºåˆ†å¤§å°å†™</li>
</ul>
<pre><code>sub vcl_recv {
    # ç¦ç”¨curlè¯·æ±‚
    if (req.http.User-Agent ~ &quot;(?i)curl&quot;) {
		return(synth(403));
	}
    # loginæˆ–è€…adminå¼€å¤´çš„ä¸ç¼“å­˜
    if (req.url ~ &quot;(?i)^/(login|admin)&quot; ) {
    		return(pass);
    	}
}

</code></pre><ul>
<li>ç¤ºä¾‹3 ç‰¹å®šç±»å‹çš„èµ„æº,ä¾‹å¦‚å…¬å¼€çš„å›¾ç‰‡ç­‰,å–æ¶ˆå…¶ç§æœ‰æ ‡è¯†,å¹¶å¼ºè¡Œè®¾å®šå…¶å¯ä»¥ç”±varnishç¼“å­˜çš„æ—¶é•¿</li>
</ul>
<pre><code>sub vcl_backend_response {
    if (beresp.http.Cache-Control !~ &quot;(?i)s-maxage&quot;) {
        if (bereq.url ~ &quot;(?i)\.(jpg|jpeg|png|gif|css|js)&quot;) {
            unset beresp.http.Set-Cookie ;
            set beresp.ttl = 3600s;
        }
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹4 é€ä¼ çœŸå®å®¢æˆ·ç«¯ip</li>
</ul>
<pre><code>#
sub vcl_recv {
    # æ˜¯å¦æ˜¯æ–°è¿æ¥
    if (req.restarts == 0) {
        if (req.http.X-Fowarded-For) {
            set req.http.X-Forwarded-For = req.http.X-Forwarded-For + &quot;,&quot;+client.ip;
        }else {
            set req.http.X-Forwarded-For = client.ip;
        }
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹5 æ¸…ç†ç¼“å­˜,ä¿®å»ºæ–¹å¼</li>
</ul>
<blockquote>
<p><a href="https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html">https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html</a></p>
</blockquote>
<ul>
<li>purgeé…ç½®</li>
</ul>
<pre><code>#å®šä¹‰å…è®¸æ¸…ç†ç¼“å­˜çš„IP
acl purgeip {
    &quot;127.0.0.1&quot;;
    &quot;localhost&quot;;
    &quot;10.10.53.197&quot;;
}

sub vcl_recv {
     #åŒ¹é…æ¸…ç†ç¼“å­˜çš„è¯·æ±‚
     if (req.method == &quot;PURGE&quot;) {
        #å¦‚æœå‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯IP ä¸æ˜¯åœ¨acl purgeé‡Œé¢å®šä¹‰çš„ å°±æ‹’ç»
         if (client.ip ~ purgeip) {
	            return (purge);  #æ¸…é™¤ç¼“å­˜
         }
         return (synth(405, &quot;This IP is not allowed to send PURGE requests.&quot;));
     }
sub vcl_purge {
     return (synth(200, &quot;Purged&quot;));
}

# æµ‹è¯•
curl -X PURGE http://xxx
</code></pre><ul>
<li>banningé…ç½®</li>
</ul>
<pre><code>1. å‘½ä»¤è¡Œæ‰§è¡Œ(ä¸´æ—¶æ‰¹é‡æ“ä½œ)
# æ¸…ç†^/javascriptçš„ç¼“å­˜
ban req.url ~ ^/javascript
# è¯·æ±‚ .jsç»“å°¾çš„ç¼“å­˜
ban req.url ~ .js$

2. å†™å…¥åˆ°é…ç½®æ–‡ä»¶,ä½¿ç”¨ban() å‡½æ•°
sub vcl_recv {
    if (req.method == &quot;BAN&quot;) {
        ban(&quot;req.http.host == &quot; + req.http.host + &quot; &amp;&amp; req.url == &quot; + req.url);
        # Throw a synthetic page so the request won't go to the backend.
        return(synth(200, &quot;Ban added&quot;));
    }
}
# ç„¶åæ‰§è¡Œå‘½ä»¤
# æ¸…ç†http://www.ngirl.xyz/javascript çš„æ‰€æœ‰ç¼“å­˜
ban req.http.host == &quot;www.ngirl.xyz&quot; &amp;&amp; req.url == &quot;/javascript&quot;

</code></pre><ul>
<li>é…ç½®å¤šä¸ªåç«¯æœåŠ¡å™¨</li>
</ul>
<pre><code>backend imgsrv1 {
    .host = &quot;192.168.0.11&quot;;
    .port = &quot;80&quot;;
}
backend imgsrv2 {
    .host = &quot;192.168.0.12&quot;;
    .port = &quot;80&quot;;
}
backend appsrv1 {
    .host = &quot;192.168.0.111&quot;;
    .port = &quot;80&quot;;
}
backend appsrv2 {
    .host = &quot;192.168.0.112&quot;;
    .port = &quot;80&quot;;
}
sub vcl_init {
    new imgsrvs = directors.random();
    imgsrvs.add_backend(imgsrv1,10);
    imgsrvs.add_backend(imgsrv2,10);

    new appsrvs = directors.round_robin();
    imgsrvs.add_backend(appsrv1);
    imgsrvs.add_backend(appsrv2);

    ...
}

sub vcl_recv {
    if (req.url ~ &quot;(?i)\.(js|css)$&quot;) {
        set req.backend_hint = staticksrv.backend();
    }
    if (req.url ~ &quot;(?i)\.(jpg|jpeg|png|gif)&quot;) {
        set req.backend_hint = imgsrvs.backend();
    } else {
        set req.backend_hint = appsrvs.backend();
    }
}
</code></pre><ul>
<li>åŸºäºcookieçš„session sticky</li>
</ul>
<pre><code>sub vcl_init {
    new h = directors.hash();
    h.add_backend(one, 1);   // backend 'one' with weight '1'
    h.add_backend(two, 1);   // backend 'two' with weight '1'
}

sub vcl_recv {
    // pick a backend based on the cookie header of the client
    set req.backend_hint = h.backend(req.http.cookie);
}
</code></pre><ul>
<li>å®˜æ–¹ç¤ºä¾‹åœ°å€</li>
</ul>
<ul>
<li><a href="https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html">é…ç½®ç¼“å­˜ä¿®å‡</a></li>
<li><a href="https://book.varnish-software.com/4.0/chapters/Saving_a_Request.html">é…ç½®å¤šä¸ªåç«¯æœåŠ¡å™¨</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Dockeréƒ¨ç½²jira8å…¨å®¶æ¡¶ç ´è§£</title>
			<link>https://www.ngirl.xyz/posts/65-docker%E9%83%A8%E7%BD%B2jira8%E5%85%A8%E5%AE%B6%E6%A1%B6%E7%A0%B4%E8%A7%A3/</link>
			<pubDate>Wed, 27 Jan 2021 18:13:13 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/65-docker%E9%83%A8%E7%BD%B2jira8%E5%85%A8%E5%AE%B6%E6%A1%B6%E7%A0%B4%E8%A7%A3/</guid>
			<description>å‚è€ƒæ–‡æ¡£
   é€šè¿‡atlassian-agent.jarå…¨å®¶æ¡¶ç ´è§£: https://www.cnblogs.com/zhmiao/p/10620903.html
  é€šè¿‡altassian-agent.jarå…¨å®¶æ¡¶ç ´è§£æ’ä»¶(è¶…è¯¦ç»† æ¨è): https://www.dqzboy.com/atlassianå…¨å®¶æ¡¶ä»¥åŠæ’ä»¶ç ´è§£è¯¦ç»†æ•™ç¨‹
  é€šè¿‡è‡ªå·±è¦†ç›–jaråŒ…çš„æ–¹å¼: https://www.cnblogs.com/tchua/p/10862670.html
  atlassian-agent.jarå®˜æ–¹ä¸‹è½½: https://gitee.com/pengzhile/atlassian-agent/releases/v1.2.3
   è¯´æ˜ 1. atlassian-agent.jarç‰ˆæœ¬: v1.2.3 2. é€šè¿‡docker swarm éƒ¨ç½² 3. jiraç‰ˆæœ¬ä¸º: 8.1.0 4. mysqlç‰ˆæœ¬: 5.7.24  å®‰è£…mysqlæ­¥éª¤ ç¼–å†™ docker-compose.yml version:&amp;#39;3&amp;#39;services:mysql:image:xxx.com/mysql:5.7.24volumes:- /data/container/jira8-mysql/data/:/var/lib/mysql:rw- /data/container/jira8-mysql/etc-mysql:/etc/mysql:rwdeploy:replicas:1resources:limits:cpus:&amp;#39;2&amp;#39;memory:4Genvironment:MYSQL_ROOT_PASSWORD:&amp;#34;rooté»˜è®¤å¯†ç &amp;#34;ports:- &amp;#34;13336:3306&amp;#34;networks:- jira8networks:jira8:æŒ‰ç…§jiraçš„mysql5.7é…ç½®å‚æ•°è¦æ±‚é…ç½®ä»¥ä¸‹ #etc-mysql æ˜¯ä»mysql5.7å†…cpä¸‹æ¥çš„, æ–¹ä¾¿åç»­ç›´æ¥ä¿®æ”¹, æŒ‚è½½åˆ°æœ¬åœ° #/data/container/jira8-mysql/etc-mysql/conf.d/docker.cnf [mysqld] skip-host-cache skip-name-resolve character_set_server=utf8mb4 innodb_default_row_format=DYNAMIC default-storage-engine=INNODB innodb_large_prefix=ON innodb_file_format=Barracuda innodb_log_file_size=2G sql_mode = NO_AUTO_VALUE_ON_ZERO docker swarmå¯åŠ¨ mysql cd /data/container/jira8-mysql docker stack deploy -c docker-compose.</description>
			<content type="html"><![CDATA[<blockquote>
<p>å‚è€ƒæ–‡æ¡£</p>
</blockquote>
<ul>
<li>
<p>é€šè¿‡atlassian-agent.jarå…¨å®¶æ¡¶ç ´è§£: <a href="https://www.cnblogs.com/zhmiao/p/10620903.html">https://www.cnblogs.com/zhmiao/p/10620903.html</a></p>
</li>
<li>
<p>é€šè¿‡altassian-agent.jarå…¨å®¶æ¡¶ç ´è§£æ’ä»¶(è¶…è¯¦ç»† æ¨è): <a href="https://www.dqzboy.com/atlassian%e5%85%a8%e5%ae%b6%e6%a1%b6%e4%bb%a5%e5%8f%8a%e6%8f%92%e4%bb%b6%e7%a0%b4%e8%a7%a3%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b">https://www.dqzboy.com/atlassianå…¨å®¶æ¡¶ä»¥åŠæ’ä»¶ç ´è§£è¯¦ç»†æ•™ç¨‹</a></p>
</li>
<li>
<p>é€šè¿‡è‡ªå·±è¦†ç›–jaråŒ…çš„æ–¹å¼: <a href="https://www.cnblogs.com/tchua/p/10862670.html">https://www.cnblogs.com/tchua/p/10862670.html</a></p>
</li>
<li>
<p>atlassian-agent.jarå®˜æ–¹ä¸‹è½½: <a href="https://gitee.com/pengzhile/atlassian-agent/releases/v1.2.3">https://gitee.com/pengzhile/atlassian-agent/releases/v1.2.3</a></p>
</li>
</ul>
<hr>
<h3 id="è¯´æ˜">è¯´æ˜</h3>
<pre><code>1. atlassian-agent.jarç‰ˆæœ¬: v1.2.3
2. é€šè¿‡docker swarm éƒ¨ç½²
3. jiraç‰ˆæœ¬ä¸º: 8.1.0
4. mysqlç‰ˆæœ¬: 5.7.24
</code></pre><hr>
<h3 id="å®‰è£…mysqlæ­¥éª¤">å®‰è£…mysqlæ­¥éª¤</h3>
<h4 id="ç¼–å†™-docker-composeyml">ç¼–å†™ docker-compose.yml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mysql</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/mysql:5.7.24</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/jira8-mysql/data/:/var/lib/mysql:rw</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/jira8-mysql/etc-mysql:/etc/mysql:rw</span><span class="w">
</span><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cpus</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">4G</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rooté»˜è®¤å¯†ç &#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;13336:3306&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">jira8</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">jira8</span><span class="p">:</span><span class="w">
</span></code></pre></div><h4 id="æŒ‰ç…§jiraçš„mysql57é…ç½®å‚æ•°è¦æ±‚é…ç½®ä»¥ä¸‹">æŒ‰ç…§jiraçš„mysql5.7é…ç½®å‚æ•°è¦æ±‚é…ç½®ä»¥ä¸‹</h4>
<pre><code>#etc-mysql æ˜¯ä»mysql5.7å†…cpä¸‹æ¥çš„, æ–¹ä¾¿åç»­ç›´æ¥ä¿®æ”¹, æŒ‚è½½åˆ°æœ¬åœ°

#/data/container/jira8-mysql/etc-mysql/conf.d/docker.cnf
[mysqld]
skip-host-cache
skip-name-resolve
character_set_server=utf8mb4
innodb_default_row_format=DYNAMIC
default-storage-engine=INNODB
innodb_large_prefix=ON
innodb_file_format=Barracuda
innodb_log_file_size=2G
sql_mode = NO_AUTO_VALUE_ON_ZERO
</code></pre><h4 id="docker-swarmå¯åŠ¨-mysql">docker swarmå¯åŠ¨ mysql</h4>
<pre><code>cd /data/container/jira8-mysql
docker stack deploy -c docker-compose.yml jira8
</code></pre><h4 id="åˆ›å»ºæ•°æ®åº“">åˆ›å»ºæ•°æ®åº“</h4>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- è¿™é‡Œé€šè¿‡rootè´¦å·å’Œé»˜è®¤å¯†ç ç™»å½•
</span><span class="c1"></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">jiradb</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8mb4</span> <span class="k">COLLATE</span> <span class="n">utf8mb4_bin</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">on</span> <span class="n">jiradb</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">&#39;jira&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">&#39;xxxxxxxx&#39;</span><span class="p">;</span>

</code></pre></div><hr>
<h3 id="å®‰è£…jiraæ­¥éª¤">å®‰è£…jiraæ­¥éª¤</h3>
<h4 id="ä¸‹è½½atlassian-agent-v123zipå¹¶è§£å‹">ä¸‹è½½atlassian-agent-v1.2.3.zipå¹¶è§£å‹</h4>
<h4 id="æ‹‰å–é•œåƒ">æ‹‰å–é•œåƒ</h4>
<pre><code>docker pull cptactionhank/atlassian-jira-software:8.1.0
</code></pre><h4 id="ä¿®æ”¹ä¸‹dockerfile">ä¿®æ”¹ä¸‹Dockerfile</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">from cptactionhank/atlassian-jira-software:8.1.0</span><span class="w">
</span><span class="w"></span><span class="l">USER root</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">COPY &#34;atlassian-agent.jar&#34; /opt/atlassian/jira/</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">RUN echo &#39;export CATALINA_OPTS=&#34;-javaagent:/opt/atlassian/jira/atlassian-agent.jar ${CATALINA_OPTS}&#34;&#39; &gt;&gt; /opt/atlassian/jira/bin/setenv.sh</span><span class="w">
</span><span class="w">
</span></code></pre></div><h4 id="buildé•œåƒå¹¶ä¸Šä¼ åˆ°å†…ç½‘é•œåƒæœåŠ¡å™¨">buildé•œåƒå¹¶ä¸Šä¼ åˆ°å†…ç½‘é•œåƒæœåŠ¡å™¨</h4>
<pre><code>docker build -t xxx.com/atlassian-jira-software:8.1.0-free .
docker push xxx.com/atlassian-jira-software:8.1.0-free
</code></pre><h4 id="ç¼–å†™-docker-composeyml-1">ç¼–å†™ docker-compose.yml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/atlassian-jira-software:8.1.0-free</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">/etc/localtime:/etc/localtime:ro</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/jira8/data:/var/atlassian/jira:rw</span><span class="w">
</span><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cpus</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;4&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">restart_policy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">failure</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;8081:8080&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">jira8</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">jira8</span><span class="p">:</span><span class="w">
</span></code></pre></div><h4 id="å¯åŠ¨jira-serveræœåŠ¡">å¯åŠ¨jira serveræœåŠ¡</h4>
<pre><code>cd /data/container/jira8
docker stack deploy -c docker-compose.yml jira8
# è·å–id
export jiraId=$(docker ps|grep &quot;atlassian-jira-software:8.1.0-free&quot;|awk '{print $1}')
æŸ¥çœ‹æ—¥å¿—
docker logs -f ${jiraId}
</code></pre><h4 id="ç ´è§£">ç ´è§£</h4>
<blockquote>
<p>è¿™é‡Œé€šè¿‡ipè®¿é—®, åç»­å¯ä»¥é…ç½®nginxåå‘ä»£ç†</p>
</blockquote>
<p>jiraé¡µé¢æµç¨‹-é€‰æ‹©languageå’ŒI&rsquo;ll set it up myself(ç›—å›¾)</p>
<p><img src="/images/65/1.png" alt=""></p>
<p>jiraé¡µé¢æµç¨‹-è¿™é‡Œå¤åˆ¶ æœåŠ¡å™¨ID(ç›—å›¾)</p>
<p><img src="/images/65/2.png" alt=""></p>
<h3 id="ç”Ÿæˆç ´è§£éœ€è¦çš„è®¸å¯è¯è¿™é‡Œä¸ç”¨å»jiraå®˜æ–¹è·å–">ç”Ÿæˆç ´è§£éœ€è¦çš„è®¸å¯è¯(è¿™é‡Œä¸ç”¨å»jiraå®˜æ–¹è·å–)</h3>
<pre><code>docker exec -ti ${jiraId} bash
cd /opt/atlassian/jira/
# ç”Ÿæˆè®¸å¯è¯
javaÂ -jar atlassian-agent.jarÂ -dÂ -m test@test.comÂ -n BATÂ -p jiraÂ -o http://xxx.comÂ -s xxxxxx

# å¤åˆ¶ç”Ÿæˆçš„è®¸å¯è¯, è´´åˆ°å¦‚ä¸‹å›¾ä½ç½®:
</code></pre><p><img src="/images/65/3.png" alt=""></p>
<p>ä¹‹åç»§ç»­ä¸‹ä¸€æ­¥å³å¯, æŸ¥çœ‹æ˜¯å¦å·²ç»ç ´è§£</p>
<p><img src="/images/65/4.png" alt=""></p>
<h3 id="ç”Ÿæˆç ´è§£ç¬¬ä¸‰æ–¹æ’ä»¶éœ€è¦çš„è®¸å¯è¯ä¸ç”¨å»jiraå®˜æ–¹è·å–">ç”Ÿæˆç ´è§£ç¬¬ä¸‰æ–¹æ’ä»¶éœ€è¦çš„è®¸å¯è¯(ä¸ç”¨å»jiraå®˜æ–¹è·å–)</h3>
<pre><code>docker exec -ti ${jiraId} bash
cd /opt/atlassian/jira/
# å¤åˆ¶ç¬¬ä¸‰æ–¹æ’ä»¶çš„ æ’ä»¶å¯†é’¥, ç”Ÿæˆè®¸å¯è¯
java -jar /opt/atlassian/jira/atlassian-agent.jar -d -m test@test.com -n BAT -p com.innovalog.jmwe.jira-misc-workflow-extensions -o http://xxx.com -s xxxxxx

# å¤åˆ¶ç”Ÿæˆçš„è®¸å¯è¯, è´´åˆ°å¦‚ä¸‹å›¾ä½ç½®:
</code></pre><p><img src="/images/65/5.png" alt=""></p>
<h3 id="å£°æ˜">å£°æ˜ï¼š</h3>
<ul>
<li>æœ¬æ–‡æä¾›çš„ç ´è§£æ–¹æ³•å’Œç¨‹åºåªåšä¸ªäººå­¦ä¹ ç ”ç©¶ä¹‹â½¤ï¼Œä¸å¾—â½¤äºå•†ä¸šç”¨é€”ï¼</li>
<li>å•†ä¸šä½¿â½¤è¯·å‘Atlassianè´­ä¹°æ­£ç‰ˆï¼Œè°¢è°¢åˆä½œï¼</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Mysql5.7-alteré”è¡¨é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/64-mysql5.7-alter%E9%94%81%E8%A1%A8%E9%97%AE%E9%A2%98/</link>
			<pubDate>Tue, 19 Jan 2021 11:28:39 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/64-mysql5.7-alter%E9%94%81%E8%A1%A8%E9%97%AE%E9%A2%98/</guid>
			<description>ç”±äºéœ€è¦æ›´æ–° my_test_table çš„ styleå­—æ®µ ç”± tinyint(2) ä¸º int(10)  ç”±äºè®¤ä¸º mysql5.6å’Œ5.7 alter table ä¸ä¼šé”è¡¨, å› æ­¤åœ¨æ‰§è¡Œæ—¶ å¯¼è‡´äº†é”è¡¨æ— æ³• update my_test_table
  æ ¹æ®å®˜æ–¹è¯´æ˜ Changing the column data type ä¸æ”¯æŒ online ddl
  https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html  æ–°å¢ä¸´æ—¶è¡¨åšæµ‹è¯• å‡†å¤‡ä¸´æ—¶è¡¨, å¯¼å…¥éƒ¨åˆ†æ•°æ® -- ä¸»åº“æ‰§è¡Œ create table my_test_table_tmp_20210119 like my_test_table; show create table my_test_table\G ENGINE=InnoDB AUTO_INCREMENT=48544733 DEFAULT CHARSET=utf8 COMMENT=&amp;#39;æµ‹è¯•è¡¨&amp;#39; alter table my_test_table_tmp_20210119 AUTO_INCREMENT=49000000; æµ‹è¯•æ‰§è¡Œalter table ä¿®æ”¹å­—æ®µdata typeæ˜¯å¦ä¼šé”è¡¨ -- é¦–å…ˆç»ˆç«¯1 æ‰§è¡Œ alter alter table my_test_table_tmp_20210119 modify style int(10) not null default 0 comment &amp;#39;ä¸‹å•æ–¹å¼&amp;#39;; -- é¦–å…ˆç»ˆç«¯2 æ‰§è¡Œ update(æ˜¯ä¼šå¡ä½) update my_test_table_tmp_20210119 set status =1 limit 1; -- æŸ¥çœ‹ processlist (å¦‚ä¸‹å›¾,å‡ºç°Waiting for table metadata lock) show full processlist å¼€å§‹æµ‹è¯• pt-online-schema-change å·¥å…·  å‚è€ƒæ–‡æ¡£: https://www.</description>
			<content type="html"><![CDATA[<h3 id="ç”±äºéœ€è¦æ›´æ–°-my_test_table-çš„-styleå­—æ®µ-ç”±-tinyint2-ä¸º-int10">ç”±äºéœ€è¦æ›´æ–° my_test_table çš„ styleå­—æ®µ ç”± tinyint(2) ä¸º int(10)</h3>
<blockquote>
<p>ç”±äºè®¤ä¸º mysql5.6å’Œ5.7 alter table ä¸ä¼šé”è¡¨, å› æ­¤åœ¨æ‰§è¡Œæ—¶ å¯¼è‡´äº†é”è¡¨æ— æ³• update my_test_table</p>
</blockquote>
<blockquote>
<p>æ ¹æ®å®˜æ–¹è¯´æ˜ Changing the column data type ä¸æ”¯æŒ online ddl</p>
</blockquote>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html</a></li>
</ul>
<h3 id="æ–°å¢ä¸´æ—¶è¡¨åšæµ‹è¯•">æ–°å¢ä¸´æ—¶è¡¨åšæµ‹è¯•</h3>
<h4 id="å‡†å¤‡ä¸´æ—¶è¡¨-å¯¼å…¥éƒ¨åˆ†æ•°æ®">å‡†å¤‡ä¸´æ—¶è¡¨, å¯¼å…¥éƒ¨åˆ†æ•°æ®</h4>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- ä¸»åº“æ‰§è¡Œ
</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="n">my_test_table_tmp_20210119</span> <span class="k">like</span> <span class="n">my_test_table</span><span class="p">;</span>

<span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="n">my_test_table</span><span class="err">\</span><span class="k">G</span>
<span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">48544733</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;æµ‹è¯•è¡¨&#39;</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">my_test_table_tmp_20210119</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">49000000</span><span class="p">;</span>

</code></pre></div><h3 id="æµ‹è¯•æ‰§è¡Œalter-table-ä¿®æ”¹å­—æ®µdata-typeæ˜¯å¦ä¼šé”è¡¨">æµ‹è¯•æ‰§è¡Œalter table ä¿®æ”¹å­—æ®µdata typeæ˜¯å¦ä¼šé”è¡¨</h3>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- é¦–å…ˆç»ˆç«¯1 æ‰§è¡Œ alter
</span><span class="c1"></span><span class="k">alter</span> <span class="k">table</span> <span class="n">my_test_table_tmp_20210119</span> <span class="k">modify</span> <span class="n">style</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="mi">0</span> <span class="k">comment</span> <span class="s1">&#39;ä¸‹å•æ–¹å¼&#39;</span><span class="p">;</span>
<span class="c1">-- é¦–å…ˆç»ˆç«¯2 æ‰§è¡Œ update(æ˜¯ä¼šå¡ä½)
</span><span class="c1"></span><span class="k">update</span> <span class="n">my_test_table_tmp_20210119</span> <span class="k">set</span> <span class="n">status</span> <span class="o">=</span><span class="mi">1</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">-- æŸ¥çœ‹ processlist (å¦‚ä¸‹å›¾,å‡ºç°Waiting for table metadata lock)
</span><span class="c1"></span><span class="k">show</span> <span class="k">full</span> <span class="n">processlist</span>
</code></pre></div><h3 id="å¼€å§‹æµ‹è¯•-pt-online-schema-change-å·¥å…·">å¼€å§‹æµ‹è¯• pt-online-schema-change å·¥å…·</h3>
<ul>
<li>å‚è€ƒæ–‡æ¡£: <a href="https://www.cnblogs.com/xinysu/p/6758170.html">https://www.cnblogs.com/xinysu/p/6758170.html</a></li>
</ul>
<h4 id="ç®€å•å®‰è£…è¯´æ˜">ç®€å•å®‰è£…è¯´æ˜</h4>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- ä»å®˜æ–¹ä¸‹è½½åŒ…
</span><span class="c1"></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">downloads</span><span class="p">.</span><span class="n">percona</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">percona</span><span class="o">-</span><span class="n">toolkit</span><span class="o">/</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="o">/</span><span class="nb">binary</span><span class="o">/</span><span class="n">redhat</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">percona</span><span class="o">-</span><span class="n">toolkit</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span>
<span class="c1">-- yum å®‰è£…
</span><span class="c1"></span><span class="n">yum</span> <span class="n">localinstall</span> <span class="n">percona</span><span class="o">-</span><span class="n">toolkit</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span>

<span class="c1">-- è®¢å•åº“ä¸»åº“teståº“æ·»åŠ è¡¨dsns
</span><span class="c1"></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">dsns</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">parent_id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">dsn</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">6</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>

<span class="c1">-- insertä»åº“ä¿¡æ¯ï¼Œæœ‰2ä¸ªä»åº“(æ·»åŠ ä¹‹åä¸ä¼šæœ‰ä¸»ä»å»¶è¿Ÿ)
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">dsns</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span> <span class="k">select</span> <span class="s2">&#34;h=ä»åº“ ip&#34;</span><span class="p">;</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">dsns</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span> <span class="k">select</span> <span class="s2">&#34;h=ä»åº“2 ip&#34;</span><span class="p">;</span>
</code></pre></div><h4 id="ç¼–å†™è„šæœ¬">ç¼–å†™è„šæœ¬</h4>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="o">[</span> <span class="nv">$#</span> !<span class="o">=</span> <span class="m">3</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;Please input dbname and tablename and alter statement!&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="nv">dbname</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">tablename</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">alter_statement</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">MYSQL_USER</span><span class="o">=</span>dbaç”¨æˆ·
<span class="nv">MYSQL_HOST</span><span class="o">=</span>ä¸»åº“åœ°å€
<span class="nv">MYSQL_PWD</span><span class="o">=</span>dbaç”¨æˆ·å¯†ç 
<span class="nv">exec_time</span><span class="o">=</span><span class="sb">`</span>date +%Y%m%d%H%M%S<span class="sb">`</span>

<span class="c1">#num_triggers=`mysql -u$MYSQL_USER -h$MYSQL_HOST -p$MYSQL_PWD $dbname -e &#34;show triggers like \&#34;$tablename\&#34;&#34; | wc -l`</span>
<span class="c1">#[ $num_triggers -gt 0 ] &amp;&amp; { echo -e &#34;\033[31mException: $dbname.$tablename have triggers!\033[0m&#34;;exit;}</span>

<span class="nv">log_file</span><span class="o">=</span><span class="s2">&#34;/root/pt_osc_log/&#34;</span><span class="si">${</span><span class="nv">tablename</span><span class="si">}</span>_<span class="si">${</span><span class="nv">exec_time</span><span class="si">}</span>.log
<span class="nv">exec_statement</span><span class="o">=</span><span class="s2">&#34;nohup pt-online-schema-change --nocheck-replication-filters --max-load \&#34;Threads_connected:200\&#34; --alter \&#34;</span><span class="nv">$alter_statement</span><span class="s2">\&#34; A=utf8,u=</span><span class="nv">$MYSQL_USER</span><span class="s2">,h=</span><span class="nv">$MYSQL_HOST</span><span class="s2">,p=</span><span class="nv">$MYSQL_PWD</span><span class="s2">,D=</span><span class="nv">$dbname</span><span class="s2">,t=</span><span class="nv">$tablename</span><span class="s2"> --recursion-method dsn=D=test,t=dsns --execute &gt;</span><span class="nv">$log_file</span><span class="s2"> 2&gt;&amp;1 &amp;&#34;</span>
<span class="nv">exec_statement</span><span class="o">=</span><span class="si">${</span><span class="nv">exec_statement</span><span class="p">//</span><span class="se">\`</span><span class="p">/</span><span class="se">\\\`</span><span class="si">}</span>

<span class="nb">echo</span> -e <span class="s2">&#34;\033[32mæ‰§è¡Œå‘½ä»¤ä¸ºï¼š\033[0m&#34;</span>
<span class="nb">echo</span> -e <span class="s2">&#34;\033[35m</span><span class="nv">$exec_statement</span><span class="s2">\033[0m&#34;</span>
<span class="nb">echo</span> -e -n <span class="s2">&#34;\033[32mè¯·ç¡®è®¤,ç»§ç»­æ‰§è¡ŒæŒ‰\033[31mã€y|Yã€‘\033[32mï¼Œå¦åˆ™æŒ‰ä»»æ„é”®é€€å‡ºï¼š\033[0m&#34;</span>
<span class="nb">read</span> -n1 isexec
<span class="nb">echo</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$isexec</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;y&#34;</span> -o <span class="s2">&#34;</span><span class="nv">$isexec</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Y&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
  <span class="nb">eval</span> <span class="nv">$exec_statement</span>
  <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mæŸ¥çœ‹æ‰§è¡Œç»“æœï¼š\033[33m</span><span class="nv">$log_file</span><span class="s2">\033[0m&#34;</span>
<span class="k">else</span>
  <span class="nb">echo</span> -e <span class="s2">&#34;\033[31mä¸­æ–­æ‰§è¡Œ\033[0m&#34;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
</code></pre></div><h4 id="æ‰§è¡Œå‘½ä»¤æµ‹è¯•">æ‰§è¡Œå‘½ä»¤æµ‹è¯•</h4>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sh pt_osc.sh hzkj_zh my_test_table_tmp_20210119 <span class="s2">&#34;modify style int(11) not null default 0 comment &#39;æ–¹å¼&#39;;&#34;</span>
</code></pre></div><h3 id="æ€»ç»“">æ€»ç»“</h3>
<pre><code>1. æ ¹æ®å®˜æ–¹æ–‡æ¡£, åœ¨change column data typeçš„æ—¶å€™ é»˜è®¤æ˜¯é€šè¿‡ copy to tmp table æ–¹æ³•, ä¸æ”¯æŒ algorithm=inplace
    æ‰§è¡Œ: 	alter table my_test_table_tmp_20210119 modify issendbean int(10) not null default 0 comment 'ä¸‹å•æ–¹å¼',algorithm=inplace;
    æŠ¥é”™: 	ERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.
2. æ‰€ä»¥åœ¨æ‰§è¡Œ change column data type çš„sqlæ—¶å€™, éœ€è¦é€šè¿‡ pt-online-schema-change å·¥å…·æ‰§è¡Œ alter table
</code></pre>]]></content>
		</item>
		
		<item>
			<title>Gitlab-Ceçš„httpså¼€å¯é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/63-gitlab-ce%E7%9A%84https%E5%BC%80%E5%90%AF%E9%97%AE%E9%A2%98/</link>
			<pubDate>Tue, 15 Dec 2020 11:15:52 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/63-gitlab-ce%E7%9A%84https%E5%BC%80%E5%90%AF%E9%97%AE%E9%A2%98/</guid>
			<description>å‰è¨€
 é¦–å…ˆéœ€è¦å¼€å¯httpså¹¶ä¸ä¼šå› ä¸ºä¹‹å‰æ²¡æœ‰å¼€å¯, ä¹‹å‰å·²ç»æ˜¯httpsè®¿é—®, é€šè¿‡nginxåå‘ä»£ç†åˆ°gitlab-ce:10080ç«¯å£
ä½†æ˜¯ç”±äºæ–°ç‰ˆChromeæµè§ˆå™¨å¯¹äºhttpsçš„åŸŸåå†…éƒ¨postè°ƒç”¨httpæ—¶ ä¼šæç¤ºä¸å®‰å…¨
è¿™ç§æƒ…å†µä¸‹æ‰å‡†å¤‡å°†gitlabç›´æ¥é€šè¿‡httpså¯åŠ¨, ç„¶ånginxåä»£åˆ°httpsçš„gitlab-ceä¸Š
é¦–å…ˆä¿®æ”¹ä¸‹gitlab.rb  external_url &#39;https://gitlab.xxx.com&#39; nginx[&#39;redirect_http_to_https&#39;] = true nginx[&#39;redirect_http_to_https_port&#39;] = 80 nginx[&#39;listen_port&#39;] = 80 nginx[&#39;ssl_certificate&#39;] = &amp;quot;/etc/gitlab/ssl/server.pem&amp;quot; nginx[&#39;ssl_certificate_key&#39;] = &amp;quot;/etc/gitlab/ssl/server.key&amp;quot;  è¿™é‡Œæœ‰ä¸ªæ’æ›², å› ä¸ºæˆ‘ä¹‹å‰é…ç½®çš„æ—¶å€™docker ç«¯å£æ˜ å°„æ˜¯10080:10080, æ‰€ä»¥å®¹å™¨çš„gitlab.rbé…ç½®æ˜¯è¿™æ ·:
  nginx[&#39;redirect_http_to_https_port&#39;] = 10080 nginx[&#39;listen_port&#39;] = 10080 è¿™æ ·å°±å¯¼è‡´å¼€å¯httpsçš„redirect å¯èƒ½æœ‰ç‚¹é—®é¢˜(å¯èƒ½æ¼æ”¹, æˆ–è€…æŸäº›é»˜è®¤é…ç½®çš„é—®é¢˜), å…¶å®æ²¡å¿…è¦, ç›®å‰æ”¹æˆå®¹å™¨å†…é»˜è®¤çš„80
ç„¶åreconfigureå³å¯ gitlab-ctl reconfigure ç”±äºæˆ‘æ˜¯docker swarmå¯åŠ¨ version:&amp;#34;3&amp;#34;services:gitlab:image:hub.xxx.com/bq/gitlab-ce:11.5.4hostname:&amp;#39;gitlab.xxx.com&amp;#39;environment:TZ:&amp;#39;Asia/Shanghai&amp;#39;GITLAB_OMNIBUS_CONFIG:|gitlab_rails[&amp;#39;time_zone&amp;#39;] = &amp;#39;Asia/Shanghai&amp;#39;volumes:- /data/container/gitlab-ce/logs:/var/log/gitlab- /data/container/gitlab-ce/data/:/var/opt/gitlab:rw- /data/container/gitlab-ce/config/:/etc/gitlab:rwdeploy:replicas:1restart_policy:condition:on-failureports:- 10443:443- 10080:80- 10022:22networks:- gitlabnetenvironment:HOSTNAME:gitlab.xxx.comnetworks:gitlabnet:nginxä»£ç†ä¿®æ”¹ server { listen 80; listen 443 ssl http2; charset utf-8; server_name gitlab.</description>
			<content type="html"><![CDATA[<blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>é¦–å…ˆéœ€è¦å¼€å¯httpså¹¶ä¸ä¼šå› ä¸ºä¹‹å‰æ²¡æœ‰å¼€å¯, ä¹‹å‰å·²ç»æ˜¯httpsè®¿é—®, é€šè¿‡nginxåå‘ä»£ç†åˆ°gitlab-ce:10080ç«¯å£</p>
<p>ä½†æ˜¯ç”±äºæ–°ç‰ˆChromeæµè§ˆå™¨å¯¹äºhttpsçš„åŸŸåå†…éƒ¨postè°ƒç”¨httpæ—¶ ä¼šæç¤ºä¸å®‰å…¨</p>
<p><img src="/images/63/63-1.png" alt=""></p>
<p>è¿™ç§æƒ…å†µä¸‹æ‰å‡†å¤‡å°†gitlabç›´æ¥é€šè¿‡httpså¯åŠ¨, ç„¶ånginxåä»£åˆ°httpsçš„gitlab-ceä¸Š</p>
<h3 id="é¦–å…ˆä¿®æ”¹ä¸‹gitlabrb">é¦–å…ˆä¿®æ”¹ä¸‹gitlab.rb</h3>
<pre><code> external_url 'https://gitlab.xxx.com'
 nginx['redirect_http_to_https'] = true
 nginx['redirect_http_to_https_port'] = 80
 nginx['listen_port'] = 80
 nginx['ssl_certificate'] = &quot;/etc/gitlab/ssl/server.pem&quot;
 nginx['ssl_certificate_key'] = &quot;/etc/gitlab/ssl/server.key&quot;
</code></pre><blockquote>
<p>è¿™é‡Œæœ‰ä¸ªæ’æ›², å› ä¸ºæˆ‘ä¹‹å‰é…ç½®çš„æ—¶å€™docker ç«¯å£æ˜ å°„æ˜¯10080:10080, æ‰€ä»¥å®¹å™¨çš„gitlab.rbé…ç½®æ˜¯è¿™æ ·:</p>
</blockquote>
<pre><code> nginx['redirect_http_to_https_port'] = 10080
 nginx['listen_port'] = 10080
</code></pre><p>è¿™æ ·å°±å¯¼è‡´å¼€å¯httpsçš„redirect å¯èƒ½æœ‰ç‚¹é—®é¢˜(å¯èƒ½æ¼æ”¹, æˆ–è€…æŸäº›é»˜è®¤é…ç½®çš„é—®é¢˜), å…¶å®æ²¡å¿…è¦, ç›®å‰æ”¹æˆå®¹å™¨å†…é»˜è®¤çš„80</p>
<h3 id="ç„¶åreconfigureå³å¯">ç„¶åreconfigureå³å¯</h3>
<pre><code>gitlab-ctl reconfigure
</code></pre><h3 id="ç”±äºæˆ‘æ˜¯docker-swarmå¯åŠ¨">ç”±äºæˆ‘æ˜¯docker swarmå¯åŠ¨</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">gitlab</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/bq/gitlab-ce:11.5.4</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gitlab.xxx.com&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">GITLAB_OMNIBUS_CONFIG</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        </span><span class="w">        </span><span class="l">gitlab_rails[&#39;time_zone&#39;] = &#39;Asia/Shanghai&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/gitlab-ce/logs:/var/log/gitlab</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/gitlab-ce/data/:/var/opt/gitlab:rw</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/container/gitlab-ce/config/:/etc/gitlab:rw</span><span class="w">
</span><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">restart_policy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">failure</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">10443</span><span class="p">:</span><span class="m">443</span><span class="w">
</span><span class="w">      </span>- <span class="m">10080</span><span class="p">:</span><span class="m">80</span><span class="w">
</span><span class="w">      </span>- <span class="m">10022</span><span class="p">:</span><span class="m">22</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">gitlabnet</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab.xxx.com</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">gitlabnet</span><span class="p">:</span><span class="w">
</span></code></pre></div><h3 id="nginxä»£ç†ä¿®æ”¹">nginxä»£ç†ä¿®æ”¹</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">server <span class="o">{</span>
        listen  80<span class="p">;</span>
        listen <span class="m">443</span> ssl http2<span class="p">;</span>
        charset utf-8<span class="p">;</span>
        server_name gitlab.xxx.com<span class="p">;</span>

        ssl_certificate   /etc/nginx/server.pem<span class="p">;</span>
        ssl_certificate_key   /etc/nginx/server.key<span class="p">;</span>
        ssl_session_timeout 5m<span class="p">;</span>
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span>
        ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL<span class="p">;</span>
        ssl_prefer_server_ciphers on<span class="p">;</span>

        client_max_body_size 300M<span class="p">;</span>
        access_log  /nginx_logs/gitlab.xxx.com.access.log  server_name_main<span class="p">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="nv">$scheme</span> <span class="o">=</span> http<span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
        <span class="o">}</span>

        location / <span class="o">{</span>
            <span class="c1">#add_header Strict-Transport-Security &#34;max-age=31536000;includeSubDomains&#34; ;</span>
            proxy_pass https://xxx:10443<span class="p">;</span>		//ä¿®æ”¹è¿™é‡Œ
            proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
            proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
            proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
            proxy_set_header X-Forwarded-Proto  <span class="nv">$scheme</span><span class="p">;</span>
        <span class="o">}</span>

        error_page   <span class="m">500</span> <span class="m">502</span> <span class="m">503</span> <span class="m">504</span>  /50x.html<span class="p">;</span>
        <span class="nv">location</span> <span class="o">=</span> /50x.html <span class="o">{</span>
            root   html<span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="å…¶ä»–ä¸€äº›è¯´æ˜">å…¶ä»–ä¸€äº›è¯´æ˜</h3>
<pre><code> gitlab_rails['gitlab_shell_ssh_port'] = 10022
</code></pre>]]></content>
		</item>
		
		<item>
			<title>linuxé‡åˆ°ä¸€äº›é—®é¢˜ç»Ÿè®¡</title>
			<link>https://www.ngirl.xyz/posts/9-linux%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E7%BB%9F%E8%AE%A1%E6%80%BB%E7%BB%93/</link>
			<pubDate>Tue, 08 Dec 2020 17:42:54 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/9-linux%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E7%BB%9F%E8%AE%A1%E6%80%BB%E7%BB%93/</guid>
			<description>è®°å½•ä¸€äº›Linux,nginxæˆ–å…¶ä»–æœåŠ¡ä¸€äº›é—®é¢˜
  åˆ†å¸ƒå¼é—®é¢˜: åˆ†å¸ƒå¼ç®—æ³• Basic paxos ç®—æ³• 1. è·å–ä¸€ä¸ªProposal ID nï¼Œä¸ºäº†ä¿è¯Proposal IDå”¯ä¸€ï¼Œå¯é‡‡ç”¨æ—¶é—´æˆ³+Server IDç”Ÿæˆï¼› 2. Proposerå‘æ‰€æœ‰Acceptorså¹¿æ’­Prepare(n)è¯·æ±‚ï¼› 3. Acceptoræ¯”è¾ƒnå’ŒminProposalï¼Œå¦‚æœn&amp;gt;minProposalï¼ŒminProposal=nï¼Œå¹¶ä¸”å°† acceptedProposal å’Œ acceptedValue è¿”å›ï¼› 4. Proposeræ¥æ”¶åˆ°è¿‡åŠæ•°å›å¤åï¼Œå¦‚æœå‘ç°æœ‰acceptedValueè¿”å›ï¼Œå°†æ‰€æœ‰å›å¤ä¸­acceptedProposalæœ€å¤§çš„acceptedValueä½œä¸ºæœ¬æ¬¡ææ¡ˆçš„valueï¼Œå¦åˆ™å¯ä»¥ä»»æ„å†³å®šæœ¬æ¬¡ææ¡ˆçš„valueï¼› 5. åˆ°è¿™é‡Œå¯ä»¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œå¹¿æ’­Accept (n,value) åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼› 6. Acceptoræ¯”è¾ƒnå’ŒminProposalï¼Œå¦‚æœn&amp;gt;=minProposalï¼Œåˆ™acceptedProposal=minProposal=nï¼ŒacceptedValue=valueï¼Œæœ¬åœ°æŒä¹…åŒ–åï¼Œè¿”å›ï¼›å¦åˆ™ï¼Œè¿”å›minProposalã€‚ 7. æè®®è€…æ¥æ”¶åˆ°è¿‡åŠæ•°è¯·æ±‚åï¼Œå¦‚æœå‘ç°æœ‰è¿”å›å€¼result &amp;gt;nï¼Œè¡¨ç¤ºæœ‰æ›´æ–°çš„æè®®ï¼Œè·³è½¬åˆ°1ï¼›å¦åˆ™valueè¾¾æˆä¸€è‡´ã€‚ Multi-Paxos ç®—æ³•  ä¸ºäº†è§£å†³å®é™…åº”ç”¨ä¸­è¿ç»­å¤šå€¼ä¼ è¾“çš„é«˜æ•ˆæ€§,æ”¹è¿›äº†Basix Paxosä¸ºMulti-Paxos:
 1. é’ˆå¯¹æ¯ä¸€ä¸ªè¦ç¡®å®šçš„å€¼ï¼Œè¿è¡Œä¸€æ¬¡Paxosç®—æ³•å®ä¾‹ï¼ˆInstanceï¼‰ï¼Œå½¢æˆå†³è®®ã€‚æ¯ä¸€ä¸ªPaxoså®ä¾‹ä½¿ç”¨å”¯ä¸€çš„Instance IDæ ‡è¯†ã€‚ 2. åœ¨æ‰€æœ‰Proposersä¸­é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç”±Leaderå”¯ä¸€åœ°æäº¤Proposalç»™Acceptorsè¿›è¡Œè¡¨å†³ã€‚è¿™æ ·æ²¡æœ‰Proposerç«äº‰ï¼Œè§£å†³äº†æ´»é”é—®é¢˜ã€‚åœ¨ç³»ç»Ÿä¸­ä»…æœ‰ä¸€ä¸ªLeaderè¿›è¡ŒValueæäº¤çš„æƒ…å†µä¸‹ï¼ŒPrepareé˜¶æ®µå°±å¯ä»¥è·³è¿‡ï¼Œä»è€Œå°†ä¸¤é˜¶æ®µå˜ä¸ºä¸€é˜¶æ®µï¼Œæé«˜æ•ˆç‡ã€‚ raft  ä¸ºäº†æ›´ç®€ä¾¿ç†è§£å’Œå®ç°,æ”¹è¿›äº†Multi-Paxos ä¸ºraft
 1. å‘é€çš„logçš„æ˜¯è¿ç»­çš„, ä¹Ÿå°±æ˜¯è¯´raft çš„append æ“ä½œå¿…é¡»æ˜¯è¿ç»­çš„. è€Œpaxos å¯ä»¥å¹¶å‘çš„. (å…¶å®è¿™é‡Œå¹¶å‘åªæ˜¯append log çš„å¹¶å‘æé«˜, åº”ç”¨çš„state machine è¿˜æ˜¯å¿…é¡»æ˜¯æœ‰åºçš„) 2. é€‰ä¸»æ˜¯æœ‰é™åˆ¶çš„, å¿…é¡»æœ‰æœ€æ–°, æœ€å…¨çš„æ—¥å¿—èŠ‚ç‚¹æ‰å¯ä»¥å½“é€‰. è€Œmulti-paxos æ˜¯éšæ„çš„ æ‰€ä»¥raft å¯ä»¥çœ‹æˆæ˜¯ç®€åŒ–ç‰ˆæœ¬çš„multi paxos(è¿™é‡Œmulti-paxos å› ä¸ºå…è®¸å¹¶å‘çš„å†™log, å› æ­¤ä¸å­˜åœ¨ä¸€ä¸ªæœ€æ–°, æœ€å…¨çš„æ—¥å¿—èŠ‚ç‚¹, å› æ­¤åªèƒ½è¿™ä¹ˆåš.</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›Linux,nginxæˆ–å…¶ä»–æœåŠ¡ä¸€äº›é—®é¢˜</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="åˆ†å¸ƒå¼é—®é¢˜-åˆ†å¸ƒå¼ç®—æ³•">åˆ†å¸ƒå¼é—®é¢˜: åˆ†å¸ƒå¼ç®—æ³•</h3>
<h4 id="basic-paxos-ç®—æ³•">Basic paxos ç®—æ³•</h4>
<pre><code>1. è·å–ä¸€ä¸ªProposal ID nï¼Œä¸ºäº†ä¿è¯Proposal IDå”¯ä¸€ï¼Œå¯é‡‡ç”¨æ—¶é—´æˆ³+Server IDç”Ÿæˆï¼›
2. Proposerå‘æ‰€æœ‰Acceptorså¹¿æ’­Prepare(n)è¯·æ±‚ï¼›
3. Acceptoræ¯”è¾ƒnå’ŒminProposalï¼Œå¦‚æœn&gt;minProposalï¼ŒminProposal=nï¼Œå¹¶ä¸”å°† acceptedProposal å’Œ acceptedValue è¿”å›ï¼›
4. Proposeræ¥æ”¶åˆ°è¿‡åŠæ•°å›å¤åï¼Œå¦‚æœå‘ç°æœ‰acceptedValueè¿”å›ï¼Œå°†æ‰€æœ‰å›å¤ä¸­acceptedProposalæœ€å¤§çš„acceptedValueä½œä¸ºæœ¬æ¬¡ææ¡ˆçš„valueï¼Œå¦åˆ™å¯ä»¥ä»»æ„å†³å®šæœ¬æ¬¡ææ¡ˆçš„valueï¼›
5. åˆ°è¿™é‡Œå¯ä»¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œå¹¿æ’­Accept (n,value) åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼›
6. Acceptoræ¯”è¾ƒnå’ŒminProposalï¼Œå¦‚æœn&gt;=minProposalï¼Œåˆ™acceptedProposal=minProposal=nï¼ŒacceptedValue=valueï¼Œæœ¬åœ°æŒä¹…åŒ–åï¼Œè¿”å›ï¼›å¦åˆ™ï¼Œè¿”å›minProposalã€‚
7. æè®®è€…æ¥æ”¶åˆ°è¿‡åŠæ•°è¯·æ±‚åï¼Œå¦‚æœå‘ç°æœ‰è¿”å›å€¼result &gt;nï¼Œè¡¨ç¤ºæœ‰æ›´æ–°çš„æè®®ï¼Œè·³è½¬åˆ°1ï¼›å¦åˆ™valueè¾¾æˆä¸€è‡´ã€‚
</code></pre><h4 id="multi-paxos-ç®—æ³•">Multi-Paxos ç®—æ³•</h4>
<blockquote>
<p>ä¸ºäº†è§£å†³å®é™…åº”ç”¨ä¸­è¿ç»­å¤šå€¼ä¼ è¾“çš„é«˜æ•ˆæ€§,æ”¹è¿›äº†Basix Paxosä¸ºMulti-Paxos:</p>
</blockquote>
<pre><code>1. é’ˆå¯¹æ¯ä¸€ä¸ªè¦ç¡®å®šçš„å€¼ï¼Œè¿è¡Œä¸€æ¬¡Paxosç®—æ³•å®ä¾‹ï¼ˆInstanceï¼‰ï¼Œå½¢æˆå†³è®®ã€‚æ¯ä¸€ä¸ªPaxoså®ä¾‹ä½¿ç”¨å”¯ä¸€çš„Instance IDæ ‡è¯†ã€‚
2. åœ¨æ‰€æœ‰Proposersä¸­é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç”±Leaderå”¯ä¸€åœ°æäº¤Proposalç»™Acceptorsè¿›è¡Œè¡¨å†³ã€‚è¿™æ ·æ²¡æœ‰Proposerç«äº‰ï¼Œè§£å†³äº†æ´»é”é—®é¢˜ã€‚åœ¨ç³»ç»Ÿä¸­ä»…æœ‰ä¸€ä¸ªLeaderè¿›è¡ŒValueæäº¤çš„æƒ…å†µä¸‹ï¼ŒPrepareé˜¶æ®µå°±å¯ä»¥è·³è¿‡ï¼Œä»è€Œå°†ä¸¤é˜¶æ®µå˜ä¸ºä¸€é˜¶æ®µï¼Œæé«˜æ•ˆç‡ã€‚

</code></pre><h4 id="raft">raft</h4>
<blockquote>
<p>ä¸ºäº†æ›´ç®€ä¾¿ç†è§£å’Œå®ç°,æ”¹è¿›äº†Multi-Paxos ä¸ºraft</p>
</blockquote>
<pre><code>1. å‘é€çš„logçš„æ˜¯è¿ç»­çš„, ä¹Ÿå°±æ˜¯è¯´raft çš„append æ“ä½œå¿…é¡»æ˜¯è¿ç»­çš„. è€Œpaxos å¯ä»¥å¹¶å‘çš„. (å…¶å®è¿™é‡Œå¹¶å‘åªæ˜¯append log çš„å¹¶å‘æé«˜, åº”ç”¨çš„state machine è¿˜æ˜¯å¿…é¡»æ˜¯æœ‰åºçš„)
2. é€‰ä¸»æ˜¯æœ‰é™åˆ¶çš„, å¿…é¡»æœ‰æœ€æ–°, æœ€å…¨çš„æ—¥å¿—èŠ‚ç‚¹æ‰å¯ä»¥å½“é€‰. è€Œmulti-paxos æ˜¯éšæ„çš„ æ‰€ä»¥raft å¯ä»¥çœ‹æˆæ˜¯ç®€åŒ–ç‰ˆæœ¬çš„multi paxos(è¿™é‡Œmulti-paxos å› ä¸ºå…è®¸å¹¶å‘çš„å†™log, å› æ­¤ä¸å­˜åœ¨ä¸€ä¸ªæœ€æ–°, æœ€å…¨çš„æ—¥å¿—èŠ‚ç‚¹, å› æ­¤åªèƒ½è¿™ä¹ˆåš. è¿™æ ·å¸¦æ¥çš„éº»çƒ¦å°±æ˜¯é€‰ä¸»ä»¥å, éœ€è¦å°†ä¸»é‡Œé¢æ²¡æœ‰çš„log ç»™è¡¥å…¨, å¹¶æ‰§è¡Œcommit è¿‡ç¨‹)

</code></pre><h3 id="åˆ†å¸ƒå¼é—®é¢˜-å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹é—®é¢˜">åˆ†å¸ƒå¼é—®é¢˜: å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹é—®é¢˜</h3>
<h4 id="redis6å¤šçº¿ç¨‹è¯´æ˜">redis6å¤šçº¿ç¨‹è¯´æ˜</h4>
<ul>
<li>å¤šçº¿ç¨‹æ–¹å¼</li>
</ul>
<pre><code>1. memcachedçš„å¤šçº¿ç¨‹æ–¹å¼æ˜¯master-work, workæ˜¯ç‹¬ç«‹å®Œæˆæ‰€æœ‰æ“ä½œåŒ…æ‹¬æ‰§è¡Œæ“ä½œ
2. redisçš„å¤šçº¿ç¨‹æ–¹å¼ä¹Ÿæ˜¯master-work,ä½†æ˜¯ä»…ä»…æ˜¯ioå’Œå†…å­˜æ–¹é¢çš„æ…¢æ“ä½œæ˜¯é€šè¿‡workè¿›ç¨‹æ‰§è¡Œ, workè¿›ç¨‹å’Œmasteré—´é€šè¿‡ç®¡é“é€šä¿¡,æœ€åæ‰§è¡Œæ“ä½œéƒ½æ˜¯åœ¨masterè¿›ç¨‹æ‰§è¡Œ

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="tcpé—®é¢˜-ä»€ä¹ˆæ˜¯tcpè¿æ¥é˜Ÿåˆ—">Tcpé—®é¢˜: ä»€ä¹ˆæ˜¯tcpè¿æ¥é˜Ÿåˆ—</h3>
<ul>
<li><a href="https://blog.csdn.net/luoyu_/article/details/105361742">TCP SYNé˜Ÿåˆ—ä¸Accepté˜Ÿåˆ—è¯¦è§£</a></li>
<li><a href="https://www.cnxct.com/something-about-phpfpm-s-backlog/">TCP SOCKETä¸­backlogå‚æ•°çš„ç”¨é€”æ˜¯ä»€ä¹ˆ?</a></li>
<li><a href="https://blog.csdn.net/chen8238065/article/details/80457150">tcp ç›¸å…³æ€»ç»“</a></li>
<li><a href="https://blog.csdn.net/weixin_34088838/article/details/92562556?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param">æ·±å…¥ç†è§£Linux TCP backlog</a></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">1.	net.ipv4.tcp_max_syn_backlog:		åŠè¿æ¥é˜Ÿåˆ—,ä¿å­˜SYN_RECVçŠ¶æ€çš„è¿æ¥<span class="o">(</span>tcpæ¡æ‰‹ç¬¬ä¸€æ¬¡å®Œæˆå, serverç«¯ä¼šå°†è¿æ¥æ·»åŠ åˆ°sync queueé˜Ÿåˆ— <span class="o">)</span>
2.	min<span class="o">(</span>net.core.somaxconn,backlog<span class="o">)</span>: 	å…¨è¿æ¥é˜Ÿåˆ—,ä¿å­˜ESTABLISHEDçŠ¶æ€çš„è¿æ¥<span class="o">(</span>tcpæ¡æ‰‹ç¬¬ä¸‰æ¬¡å®Œæˆå‘¨, serverç«¯ä¼šå°†è¿æ¥æ·»åŠ åˆ°accept queueé˜Ÿåˆ—<span class="o">)</span>

é€šè¿‡netstat -s <span class="p">|</span> egrep <span class="s2">&#34;listen|LISTEN&#34;</span> æŸ¥çœ‹ æ˜¯å¦æ˜¯åŠè¿æ¥é˜Ÿåˆ—æ»¡äº†
<span class="m">667399</span> <span class="nb">times</span> the listen queue of a socket overflowed   <span class="o">(</span>? è¿™ä¸ªå’ŒTCPBacklogDrop å“ªä¸ªæ˜¯å…¨è¿æ¥é˜Ÿåˆ—??<span class="o">)</span>
<span class="m">667399</span> SYNs to LISTEN sockets ignored

é€šè¿‡netstat -s<span class="p">|</span>grep TCPBacklogDrop æŸ¥çœ‹ æ˜¯å¦æ˜¯å…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†
    TCPBacklogDrop: <span class="m">1862</span>

ä»¥ä¸Šä¹Ÿå¯ä»¥ç”¨ nstat -a -z å‘½ä»¤

å¦å¤–å¦‚æœå…¨è¿æ¥æ»¡äº†å¤„ç†æ–¹å¼æ˜¯ ç›´æ¥ä¸¢å¼ƒ, å¦‚æœä¿®æ”¹ä¸º1 åˆ™è¡¨ç¤ºå‘é€resetåŒ…ç»™å®¢æˆ·ç«¯
cat cat /proc/sys/net/ipv4/tcp_abort_on_overflow
<span class="m">0</span>

é€šè¿‡ss -lå¯ä»¥æŸ¥åˆ°åˆ°nginxçš„é»˜è®¤backlog æ˜¯511
ss -l<span class="p">|</span>grep http

é€šè¿‡ä¿®æ”¹nginxé…ç½®å¢åŠ è¯¥å€¼,reload nginx<span class="o">(</span>å‰ææ˜¯å·²ç»ä¿®æ”¹äº†net.core.somaxconn<span class="o">)</span>
 listen  <span class="m">80</span> <span class="nv">backlog</span><span class="o">=</span>4096<span class="p">;</span>
 listen <span class="m">443</span> ssl <span class="nv">backlog</span><span class="o">=</span>4096<span class="p">;</span>

</code></pre></div><p><img src="/images/tcp3.png" alt="ä¸‰æ¬¡æ¡æ‰‹å›¾">
<img src="/images/tcp-queue.png" alt="tcpé˜Ÿåˆ—å›¾">
<img src="/images/tcp-queue2.png" alt="tcpé˜Ÿåˆ—å›¾2"></p>
<blockquote>
<p>ç»“è®º</p>
</blockquote>
<pre><code># è¿™é‡Œå·²php -&gt; mysql ä¸ºä¾‹:
php å‘syn ç»™tcp:3306  -&gt; mysql å…ˆå­˜å…¥syn queueé˜Ÿåˆ—(å¼€å¯äº†syncookie,æ‰€ä»¥ä¸ä¼šæ»¡) -&gt; ç„¶åå›å¤php syn+ack -&gt;  php å›å¤ackä¹‹å è¿›å…¥ established çŠ¶æ€  æ¡æ‰‹å®Œæˆ  -&gt; æœ¬æ¬¡tcpè¿æ¥è¯·æ±‚å­˜å…¥ accpet queueé˜Ÿåˆ—(ä¹Ÿå°±æ˜¯listen backlog)  -&gt; å¦‚æœé˜Ÿåˆ—æ»¡äº†ç›´æ¥å¿½ç•¥, php è¶…æ—¶é‡ä¼ , å¦‚æœé˜Ÿåˆ—æ²¡æ»¡ å°±accept() æˆåŠŸè¿æ¥åˆ°mysqlæœåŠ¡ (max-connections - 1)

ç”±äºè¯¥æ•°å€¼æˆ–é«˜ä¼šå¯¼è‡´fpmå¤„ç†ä¸è¿‡æ¥,å‡ºç°504 gateway timeout(110: Connection timed out), è¿‡ä½ä¼šå¯¼è‡´é«˜å¹¶å‘æ— æ³•å»ºç«‹tcpè¿æ¥(111: Connection refused)
å› æ­¤ä¸€èˆ¬è®¾ç½®è¯¥å€¼ç­‰äºQPS
</code></pre><h3 id="tcpé—®é¢˜-syn-flood-æ”»å‡»">Tcpé—®é¢˜: syn flood æ”»å‡»</h3>
<ul>
<li><a href="https://www.cnblogs.com/zengkefu/p/5606696.html">https://www.cnblogs.com/zengkefu/p/5606696.html</a></li>
</ul>
<pre><code>&gt; Sep  9 12:04:01 db kernel: possible SYN flooding on port 3306. Sending cookies.

è¿™ç§ç¨‹åºå¯ä»¥é€šè¿‡ä¸å­˜åœ¨çš„ipå»å‘é€tcpè¯·æ±‚åˆ°server, serverå°±ä¼šå›å¤ack, ä½†æ˜¯ç”±äºæœåŠ¡å™¨ä¸å­˜åœ¨, æ‰€ä»¥å°±ä¸€ç›´é‡è¯•, å¯¼è‡´å ç”¨tcpè¿æ¥, å¦‚æœæ­£å¸¸è¯·æ±‚è¿›æ¥,åˆ™ç”±äºsyn queueé˜Ÿåˆ—æ»¡äº†, å°±å¿½ç•¥äº†æ­£å¸¸çš„tcpè¯·æ±‚, æ— æ³•æä¾›æœåŠ¡

</code></pre><h3 id="linuxé—®é¢˜-tcpdumpæŠ“åŒ…tcp-ackä¸º1">linuxé—®é¢˜: tcpdumpæŠ“åŒ…tcp ackä¸º1</h3>
<ul>
<li>æ‰§è¡Œå‘½ä»¤ç›‘å¬: tcpdump -n port 80 (æƒ³è¦è¯¦ç»†ä¿¡æ¯åŠ  -vv)</li>
</ul>
<blockquote>
<p>å®¢æˆ·ç«¯ telnet x.x.x.x 80</p>
</blockquote>
<p>æ—¥å¿—å¦‚ä¸‹:</p>
<pre><code>tcpdump  -n port 80
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
11:16:40.689157 IP 192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [SEW], seq 1306124348, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458678777 ecr 0,sackOK,eol], length 0
11:16:40.689724 IP 192.168.53.106.http &gt; 192.168.54.141.53444: Flags [S.E], seq 1553518959, ack 1306124349, win 64308, options [mss 1410,sackOK,TS val 4208119240 ecr 458678777,nop,wscale 7], length 0
11:16:40.690320 IP 192.168.54.141.53444 &gt; 192.168.53.106.http: Flags [.], ack 1, win 4106, options [nop,nop,TS val 458678778 ecr 4208119240], length 0
</code></pre><p>è¿™é‡Œç¬¬ä¸€å’Œç¬¬äºŒæ¬¡æ¡æ‰‹éƒ½æ²¡æœ‰é—®é¢˜, ç¬¬ä¸‰æ¬¡ ack 1, å¹¶éæ˜¯seq+1</p>
<p>è¿™é‡Œæä¸€ä¸‹ACK, ACK æ˜¯ç¡®è®¤å€¼, ack æ˜¯ç¡®è®¤ç¼–å·, ç¬¬ä¸€æ¬¡æ¡æ‰‹ACK=0,åœ¨ç¬¬äºŒæ¬¡æ¡æ‰‹å¼€å§‹ACK=1, è€Œackæ˜¯=seq+1(æ”¶åˆ°çš„éšæœºæ•°+1)</p>
<p>é‚£ä¹ˆè¿™é‡Œack 1 æ˜¯å•¥å‘¢?  &hellip; åº”è¯¥å°±æ˜¯é»˜è®¤tcpdump æ˜¾ç¤ºæˆç›¸å¯¹å€¼äº†, é€šè¿‡-S å‚æ•°ä¼šæ˜¾ç¤ºç»å¯¹å€¼</p>
<ul>
<li>æ‰§è¡Œå‘½ä»¤ç›‘å¬: tcpdump -S  -n port 80</li>
</ul>
<pre><code>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
11:16:54.806628 IP 192.168.54.141.53516 &gt; 192.168.53.106.http: Flags [S], seq 316359286, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 458692791 ecr 0,sackOK,eol], length 0
11:16:54.806861 IP 192.168.53.106.http &gt; 192.168.54.141.53516: Flags [S.], seq 1113466641, ack 316359287, win 64308, options [mss 1410,sackOK,TS val 4208133357 ecr 458692791,nop,wscale 7], length 0
11:16:54.807576 IP 192.168.54.141.53516 &gt; 192.168.53.106.http: Flags [.], ack 1113466642, win 4106, options [nop,nop,TS val 458692792 ecr 4208133357], length 0
</code></pre><p>ä¸‰æ¬¡æ¡æ‰‹å›¾
<img src="/images/tcp%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%BE.png" alt="ä¸‰æ¬¡æ¡æ‰‹å›¾"></p>
<p>å››æ¬¡æŒ¥æ‰‹å›¾
<img src="/images/tcp%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E5%9B%BE.png" alt="å››æ¬¡æŒ¥æ‰‹å›¾"></p>
<h3 id="linuxé—®é¢˜-ä¸€æ¬¡dnsmasqè¿ç§»é—®é¢˜">Linuxé—®é¢˜: ä¸€æ¬¡dnsmasqè¿ç§»é—®é¢˜</h3>
<blockquote>
<p>ç½‘å¡é…ç½®å¦‚ä¸‹</p>
</blockquote>
<pre><code>DEVICE=em1
HWADDR=x
TYPE=Ethernet
UUID=x
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
IPADDR0=172.16.76.100
PREFIX0=24
GATEWAY=172.16.76.1
DNS1=172.16.76.100
DNS2=172.16.76.101
</code></pre><blockquote>
<p>è¿™é‡Œæœ‰ä¸ªå¤§é—®é¢˜, ç”±äºæœ¬èº«å°±æ˜¯dnsæœåŠ¡å™¨, ä½†é…ç½®çš„DNS1å±…ç„¶æ˜¯æœ¬æœº, è¿™å¯¼è‡´service network restart çš„æ—¶å€™ä¼šå»ä¿®æ”¹ /etc/resolv.conf çš„é…ç½®ä¸º DNS1 å’ŒDNS2çš„ip, æ­¤æ—¶dnsæœåŠ¡å™¨å°†æ— æ³•è§£æå¤–ç½‘åŸŸå</p>
</blockquote>
<blockquote>
<p>å› æ­¤æ­£ç¡®çš„é…ç½®æ˜¯</p>
</blockquote>
<pre><code>DNS1=119.29.29.29
DNS2=223.5.5.5
DNS3=114.114.114.114
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="linuxé—®é¢˜-å‡çº§å†…æ ¸">Linuxé—®é¢˜: å‡çº§å†…æ ¸</h3>
<pre><code>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm

# æŸ¥çœ‹å¯å‡çº§çš„å†…æ ¸
yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available
yum --enablerepo=elrepo-kernel install kernel-ml

# æŸ¥çœ‹å·²ç»å®‰è£…çš„å†…æ ¸
cat /boot/grub2/grub.cfg |grep menuentry

# è®¾ç½®5.3çš„ä¸ºé»˜è®¤
grub2-set-default 'CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)'

# grub2-editenv list
saved_entry=CentOS Linux (5.3.13-1.el7.elrepo.x86_64) 7 (Core)
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="linuxé—®é¢˜-ç¦ping">linuxé—®é¢˜: ç¦ping</h3>
<pre><code># ä¸€æ¬¡æ€§ä¿®æ”¹
echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all

# å¼€æœºè‡ªåŠ¨ä¿®æ”¹
echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all

# æ°¸ä¹…ç¦ç”¨,åŠ å…¥åˆ°/etc/sysctl.conf
net.ipv4.icmp_echo_ignore_all=1
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="linuxé—®é¢˜-æ–‡ä»¶é”é—®é¢˜">linuxé—®é¢˜: æ–‡ä»¶é”é—®é¢˜</h3>
<pre><code>é—®é¢˜æè¿°: php slowlog å‡ºç°session_start() æ…¢
é—®é¢˜åŸå› : æˆ‘ä»¬è¿™è¾¹æœ‰A å’ŒB ä¸¤ä¸ªäºŒçº§åŸŸå,A ä¼šè¯·æ±‚ B, å¹¶ä¸”ç”±äºæµ‹è¯•ç¯å¢ƒåœ¨åŒä¸€å°æœåŠ¡å™¨,å…¬ç”¨ä¸€ä¸ªphp,æ‰€ä»¥åœ¨å‘ç”Ÿè°ƒç”¨çš„æ—¶å€™åŒæ—¶å†™äº†session,è€Œphpçš„sessionsé…ç½®æ˜¯é»˜è®¤çš„fileæ–¹å¼, è¿™å°±é€ æˆäº†é”çš„é—®é¢˜
é—®é¢˜è§£å†³:
1. ä¿®æ”¹ä»£ç éƒ¨åˆ†
2. phpçš„sessioné…ç½®æ”¹æˆredis
    session.save_handler = redis
    session.save_path = &quot;tcp://x.x.x.x:xxxx&quot;
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="linuxé—®é¢˜-å†…å­˜é‡Šæ”¾é—®é¢˜">linuxé—®é¢˜: å†…å­˜é‡Šæ”¾é—®é¢˜</h3>
<pre><code>é—®é¢˜æè¿°: å¼€å‘è¿™è¾¹å†™äº†ä¸ªç»Ÿè®¡è„šæœ¬, å ç”¨49Gå†…å­˜, ä»æ—¥å¿—å‘ç°è„šæœ¬å·²ç»å…¨éƒ¨æ‰§è¡Œå®Œæˆ, ä½†æ˜¯phpè„šæœ¬ä¾ç„¶å­˜åœ¨
é—®é¢˜åŸå› : é€šè¿‡ strace -p pid è§‚å¯Ÿè¿›ç¨‹, å‘ç°æ˜¯æŒç»­æ€§çš„åšå†…å­˜é‡Šæ”¾æ“ä½œ munmap(0x7f6db77ad000, 266240)          = 0
æŒç»­æ‰§è¡Œmunmapå‡½æ•°æ˜¯å› ä¸ºä¸€ç›´åœ¨é‡Šæ”¾å†…å­˜(æ¯•ç«Ÿ49G), ç»“æœ =0 è¯´æ˜å†…å­˜é‡Šæ”¾æ‰§è¡Œå‡½æ•°æ˜¯è¿”å›æ­£å¸¸äº†
é—®é¢˜è§£å†³:
1. ä¿®æ”¹ä»£ç é™ä½å†…å­˜
2. ç­‰å¾…ä¸€æ®µæ—¶é—´å†…å­˜ä¼šé‡Šæ”¾å®Œæˆ(æµ‹è¯•80åˆ†é’Ÿé‡Šæ”¾å®Œæ¯•)
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-å„ç§é€€å‡ºä¿¡å·ä½¿ç”¨">nginxé—®é¢˜: å„ç§é€€å‡ºä¿¡å·ä½¿ç”¨</h3>
<pre><code>1. hup(kill -1):	é‡æ–°è¯»å–é…ç½®å¹¶æ˜¯æœåŠ¡é…ç½®ç”Ÿæ•ˆ(nginx -s reload)
2. quit(kill -3): 	ä¼˜é›…å…³é—­è¿›ç¨‹
3. kill(kill -9):	å¼ºåˆ¶å…³é—­(å¿…æ€)
4. usr1(kill -10):	é‡æ–°æ‰“å¼€æœåŠ¡(é€šå¸¸ç”¨nginxæ—¥å¿—åˆ†å‰²)
5. usr2(kill -12):	å¹³æ»‘å‡çº§åˆ°æ–°ç‰ˆæœ¬çš„ç¨‹åº
6. term(kill -15):	å¼ºåˆ¶å…³é—­(å…ˆæ¸…ç†å–„å)
</code></pre><h3 id="nginxé—®é¢˜-å•åŸŸåé€šè¿‡cookieè·³è½¬ä¸åŒåç«¯">nginxé—®é¢˜: å•åŸŸåé€šè¿‡cookieè·³è½¬ä¸åŒåç«¯</h3>
<ul>
<li>
<ol>
<li>æµè§ˆå™¨è®¿é—® supervisor.xxxx.com?to=1 , ç„¶ååœ¨è®¿é—® supervisor.xxxx.com ä¼šè¯·æ±‚åˆ°commoné˜Ÿåˆ—</li>
</ol>
</li>
<li>
<ol start="2">
<li>æµè§ˆå™¨è®¿é—® supervisor.xxxx.com?to=2 , ç„¶ååœ¨è®¿é—® supervisor.xxxx.com ä¼šè¯·æ±‚åˆ°testé˜Ÿåˆ—</li>
</ol>
</li>
<li>
<ol start="3">
<li>curlè¯·æ±‚æ–¹å¼:
<code>curl &quot;http://supervisor.xxxx.com/index.html?action=restartall&quot; --cookie &quot;bqxserver=test&quot;</code></li>
</ol>
</li>
</ul>
<pre><code>server {
        listen 80 ;
        charset utf-8;
        server_name supervisor.xxxx.com;

        location / {
           if ($arg_to = &quot;1&quot;){
                 add_header Set-Cookie &quot;bqxserver=common&quot;;
                 add_header Content-Type &quot;text/plain;charset=utf-8&quot;;
                 return 200 &quot;å½“å‰çš„æ•°æ®æœåŠ¡å™¨ä½ç½®:common supervisor&quot;;
                }
           if ($arg_to = &quot;2&quot;){
                 add_header Set-Cookie &quot;bqxserver=test&quot;;
                 add_header Content-Type &quot;text/plain;charset=utf-8&quot;;
                 return 200 &quot;å½“å‰çš„æ•°æ®æœåŠ¡å™¨ä½ç½®:test supervisor&quot;;
                }
            set $proxy_name '127.0.0.1:32019';
            if ($cookie_bqxserver = &quot;test&quot;){
                set $proxy_name  '127.0.0.1:32020';
            }
            if ($cookie_bqxserver = &quot;common&quot;){
                set $proxy_name  '127.0.0.1:32019';
            }
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header HOST $http_host;
                proxy_set_header X-NginX-Proxy true;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Server $host;
                proxy_pass http://$proxy_name;
  }
}
</code></pre><h3 id="nginxé—®é¢˜-æç¤ºtmpæ— æƒé™é—®é¢˜">nginxé—®é¢˜: æç¤ºtmpæ— æƒé™é—®é¢˜</h3>
<pre><code>2020/12/08 17:14:52 [crit] 111455#0: *1842 open() &quot;/var/lib/nginx/tmp/client_body/0000001489&quot; failed (13: Permission denied), client: 10.10.154.36, server: xxx.com, request: &quot;POST /?xxx HTTP/1.0&quot;, host: &quot;xxx.com&quot;, referrer: &quot;http://&quot;
</code></pre><p>é¦–å…ˆç”±äºè¯¥ç¯å¢ƒnginxé…ç½®ä¿®æ”¹äº†ç”¨æˆ·ç”± nginxç”¨æˆ· å˜æˆnobodyç”¨æˆ·çš„åŸå› , å¯¼è‡´æ”¹ç›®å½•æ— æƒé™å†™å…¥&hellip;</p>
<p>çŸ¥é“é—®é¢˜äº†, é‚£ä¸ºå•¥ä¼šå†™åˆ°è¿™ä¸ªç›®å½•å‘¢?éœ€è¦çœ‹ä¸‹é¢ä¸¤ä¸ªå‚æ•°</p>
<pre><code>client_max_body_size	1m;
client_body_buffer_size 16k;
</code></pre><p><code>client_max_body_size</code> é»˜è®¤ 1Mï¼Œè¡¨ç¤º å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æœ€å¤§å…è®¸å¤§å°ï¼Œåœ¨<code>Content-Length</code>è¯·æ±‚å¤´ä¸­æŒ‡å®šã€‚å¦‚æœè¯·æ±‚çš„æ­£æ–‡æ•°æ®å¤§äº<code>client_max_body_size</code>ï¼ŒHTTPåè®®ä¼šæŠ¥é”™ <code>413 Request Entity Too Large</code>ã€‚</p>
<p>é‚£è¿™é‡Œä¸ºå•¥ä¼šå†™tmpç›®å½•å‘¢?</p>
<p>çœ‹ä¸‹<code>client_body_buffer_size</code>, é»˜è®¤ 16k , å°äºè¿™ä¸ªå€¼ä¼šç›´æ¥å†™å…¥å†…å­˜,  ä½†å¦‚æœ <code>client_body_buffer_size</code> è¯·æ±‚æ•°æ® &lt; <code>client_max_body_size</code> , é‚£ä¹ˆæ­¤æ—¶å°±ä¼šå†™ä¸´æ—¶ç›®å½•,é»˜è®¤<code>/var/lib/nginx/tmp/client_body</code></p>
<h3 id="nginxé—®é¢˜-http_x_real_ipé—®é¢˜">nginxé—®é¢˜: http_x_real_ipé—®é¢˜</h3>
<p>nginxçš„åå‘ä»£ç†æœåŠ¡å™¨ä¸€èˆ¬éƒ½éœ€è¦åŠ ä¸Š <code>proxy_set_header X-Real-IP $remote_addr;</code>, ä¸ºå•¥éœ€è¦åŠ ä¸Šè¿™ä¸ªå‘¢?</p>
<p>æ¯”å¦‚æˆ‘æœ‰å¦‚ä¸‹æ¶æ„ä»£ç†:
<a href="http://www.test.com">www.test.com</a>(clientip: 1.1.1.1) -&gt; proxy1(2.1.1.1) -&gt; proxy2(2.1.1.2) -&gt; real server(2.1.1.3)</p>
<p>å› ä¸ºä¸åŠ çš„è¯<code>$http_x_real_ip</code> ä¼šä¸€ç›´æ˜¯ç©º, å¹¶ä¸”åœ¨åå‘ä»£ç†æœåŠ¡å™¨åç«¯çš„real server åŒæ ·æ˜¯ç©º
è¿™ä¸€ç‚¹å’Œ<code>$http_x_forwarded_for</code> ä¸åŒ,æ¯”å¦‚åœ¨<code>proxy1</code>ä¸Šä¸ºç©º, ä½†æ˜¯åœ¨<code>proxy2</code>ä¹‹åçš„æœåŠ¡å™¨ä¸Šä¸ä¸ºç©º</p>
<p>åŠ äº†ä¹‹åå°±æ˜¯çœŸå®å®¢æˆ·ç«¯ipäº†å—?</p>
<ul>
<li>proxy1æœåŠ¡å™¨: (2.1.1.1)</li>
</ul>
<pre><code>1. $remote_addr = 1.1.1.1
2. $http_x_real_ip = ç©º
3. $http_x_forwarded_for = ç©º
</code></pre><ul>
<li>proxy2æœåŠ¡å™¨: (2.1.1.2)</li>
</ul>
<pre><code>1. $remote_addr = 2.1.1.1
2. $http_x_real_ip = 1.1.1.1
3. $http_x_forwarded_for = 1.1.1.1
</code></pre><ul>
<li>real serveræœåŠ¡å™¨: (2.1.1.3)</li>
</ul>
<pre><code>1. $remote_addr = 2.1.1.2
2. $http_x_real_ip = 2.1.1.1
3. $http_x_forwarded_for = 1.1.1.1,2.1.1.1
</code></pre><p>ä¸€èˆ¬æ¥è¯´ å½“æœ‰å¤šä¸ªä»£ç†æ—¶å€™ï¼Œå¯ä»¥åœ¨ç¬¬ä¸€ä¸ªåå‘ä»£ç†ä¸Šé…ç½®<code>proxy_set_header X-Real-IP $remote_addr</code> è·å–çœŸå®å®¢æˆ·ç«¯IP</p>
<p>å¦‚æ­¤çœ‹æ¥å‡å¦‚æ•´ä¸ªè¯·æ±‚,åå‘ä»£ç†åªæœ‰ä¸€å±‚, æ²¡æœ‰proxy2, real serverè·å–<code>$http_x_real_ip</code> å’Œ<code>$http_x_forwarded_for</code>æ˜¯ä¸€æ ·çš„, å°±æ˜¯çœŸå®å®¢æˆ·ç«¯ip</p>
<p>ä½†æ˜¾ç„¶å³ä¾¿æˆ‘ä»¬åå‘ä»£ç†åªæœ‰ä¸€å±‚,  åœ¨proxy1ä¹‹å‰,äº’è”ç½‘ä¸­å¯èƒ½è¿˜æœ‰åå‘ä»£ç†, ä¾‹å¦‚ç»è¿‡cdnä¹‹å, ä¾‹å¦‚ä»–äººä»£ç† éƒ½å°†éšè—çœŸå®ip.</p>
<h3 id="nginxé—®é¢˜-nginx-ifæ¡ä»¶çš„å®ç°">nginxé—®é¢˜: nginx ifæ¡ä»¶&amp;&amp;çš„å®ç°</h3>
<ul>
<li>1 å…è®¸æ‰€æœ‰äººè®¿é—® a.php|b.php|c.php|d.php|e.php</li>
<li>2 ä»…å…è®¸127.0.0.1|172.16.0.2 ipå¯ä»¥è®¿é—® aa.php|bb.php</li>
</ul>
<pre><code>set $flag &quot;allow&quot;;
# ä»¥ä¸‹php æ‰€æœ‰äººå¯ä»¥è®¿é—®
if ( $fastcgi_script_name ~ (a.php|b.php|c.php|d.php|e.php) ) {
        set $flag &quot;allow_php_ip&quot;;
}

# ä»¥ä¸‹php ä»…å›ºå®šipå¯ä»¥è®¿é—®
if ($fastcgi_script_name ~ (aa.php|bb.php)) {
        set $flag &quot;${flag}_php&quot;;
}

if ( $proxy_add_x_forwarded_for ~ (127.0.0.1|172.16.0.2)) {
        set $flag &quot;${flag}_ip&quot;;
}
# å†™åŒ…å«æ˜¯ $flag å¯èƒ½ä¸º &quot;allow_php_ip_ip&quot; (åœ¨å…è®¸çš„ipæœåŠ¡å™¨(127.0.0.1)ä¸Šè®¿é—® /a.php)
if ( $flag !~ &quot;allow_php_ip&quot; ) {
        return 403;
}
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-é™æ€æ–‡ä»¶åˆ†ç¦»">nginxé—®é¢˜: é™æ€æ–‡ä»¶åˆ†ç¦»</h3>
<p>å¯¹äºä¸€èˆ¬çš„nginx+phpçš„æ–¹å¼, æˆ‘ä»¬phpé‡‡ç”¨nobodyç”¨æˆ·,è€Œä»£ç /lumené‡‡ç”¨web-wwwç”¨æˆ·, è¿™æ ·çš„å¥½å¤„æ˜¯é¡µé¢è®¿é—®åˆ°/lumenæ—¶æ˜¯nobodyç”¨æˆ·, æ˜¯æ— æ³•ä¿®æ”¹ä»£ç çš„</p>
<p>å¯èƒ½æˆ‘ä»¬éœ€æ±‚æ˜¯ä¸Šç”¨æˆ·uploadå›¾ç‰‡ç­‰, è¿™æ—¶å€™å°±å¯èƒ½è¢«ä¼ ä¸ŠæŸä¸ªa.php, è¿™å°±æœ‰å¯èƒ½è¢«ä»£ç æ³¨å…¥(ä¸€èˆ¬æ¥è¯´å›¾ç‰‡æ˜¯æ”¾cdn,é…ç½®å•ç‹¬åŸŸåå›æºçš„,è¿™é‡Œæ˜¯ç›´æ¥å­˜åœ¨é¡¹ç›®ç›®å½•)</p>
<p>æ‰€ä»¥ä¸ºäº†é˜²æ­¢ä»£ç æ³¨å…¥,æˆ‘ä»¬éœ€è¦é™åˆ¶uploadç›®å½•çš„è®¿é—®æƒé™</p>
<pre><code># nginxé…ç½®å¦‚ä¸‹
        location ~ /images/.*\.(gif|jpg|jpeg|png)$ {
            root /lumen/storage/uploads/;
        }

</code></pre><p>è¿™æ ·æˆ‘ä»¬å›¾ç‰‡ä¼ åˆ° /lumen/storage/uploads/images/ ç›®å½•, è®¿é—®æ˜¯ <a href="http://www.xxx.com/images/x.png">www.xxx.com/images/x.png</a> æ¥è®¿é—® ä¸”ä¸å…è®¸å…¶ä»–ç±»å‹æ–‡ä»¶è®¿é—®.</p>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-root-å’Œalias">nginxé—®é¢˜: root å’Œalias</h3>
<p>åœ¨é…ç½®æ–‡ä»¶æ˜ å°„çš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°æ— æ³•è®¿é—®æ–‡ä»¶ï¼Œnginxå¯èƒ½ä¼šå°†æ‰€æœ‰çš„
æ–‡ä»¶éƒ½æ˜ å°„æˆä¸ºæ–‡ä»¶å¤¹ï¼Œå¯¼è‡´æ–‡ä»¶æ˜ å°„å¤±è´¥çš„æƒ…å†µå‡ºç°ï¼›</p>
<ul>
<li>rootçš„ä¾‹å­</li>
</ul>
<pre><code>location /a/ {
	root /lumen/public;
}
è¿™é‡Œå®é™…è®¿é—®çš„è·¯å¾„: www.xxx.com/a/ -&gt; /lumen/public/a/
</code></pre><ul>
<li>aliasçš„ä¾‹å­</li>
</ul>
<pre><code># æ³¨æ„è¿™é‡Œç›®å½•æœ€ååŠ ä¸Š/
location /a/ {
        alias /lumen/public/;
}
è¿™é‡Œå®é™…è®¿é—®çš„è·¯å¾„: www.xxx.com/a/ -&gt; /lumen/public/
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-éšè—ç‰ˆæœ¬ä¿¡æ¯">nginxé—®é¢˜: éšè—ç‰ˆæœ¬ä¿¡æ¯</h3>
<pre><code>Syntax:  server_tokens on | off | build | string;
Default:  server_tokens on;
Context:  http, server, location
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-æ—¥å¿—å‡ºç°encodeå†…å®¹å¦‚ä½•æŸ¥çœ‹">nginxé—®é¢˜: æ—¥å¿—å‡ºç°encodeå†…å®¹å¦‚ä½•æŸ¥çœ‹</h3>
<pre><code># python2 æ‰§è¡Œdecode
&gt;&gt;&gt; print &quot;\x22content\x22\x0D\x0A\x0D\x0A\xE8\x8A\x8A\xE8\x8A\x8A\xE8\xBF\x98\xE6\x80\x95\xE5\xA6\x9E\xE5\xA6\x9E\xE4\xB8\x8D\xE8\x80\x81\xE5\xAE\x9E\xEF\xBC\x8C\xE7\x89\xB9\xE5\x9C\xB0\xE8\xBF\x87\xE6\x9D\xA5\xE8\xA7\x86\xE5\xAF\x9F\xE4\xB8\x80\xE4\xB8\x8B\x0D\x0A&quot;.decode('utf-8')
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-defaulté…ç½®æœªè®¾ç½®">nginxé—®é¢˜: defaulté…ç½®æœªè®¾ç½®</h3>
<p>nginx æœªè®¾ç½®defaultæ—¶, å¦‚æœç›´æ¥è®¿é—®æœåŠ¡å™¨å¤–ç½‘ip, ä¼šå»è¯·æ±‚åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„serveræ®µ, æœ‰å¯èƒ½ä¼šè¯·æ±‚åˆ°åç«¯çš„æœåŠ¡å™¨çš„å†…å®¹, è¿™å¾ˆæœ‰å¯èƒ½æš´éœ²æˆ‘ä»¬ä¸æƒ³æš´éœ²çš„æœåŠ¡
ä¸€èˆ¬æ¥è¯´å¼€å¤´æ·»åŠ å¦‚ä¸‹é…ç½®</p>
<pre><code>    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        deny all;
	}
</code></pre><p>nginx é…ç½®å·²ç»é…ç½®åŸŸåæ–¹å¼è®¿é—®, å¦‚æœè®¿é—®ipä¼šè¿”å›403, æ­£å¸¸æ¥è¯´è¿”å›403å·²ç»ä¸ä¼šå¯¹æœåŠ¡å™¨é€ æˆå‹åŠ›äº†</p>
<blockquote>
<p>å¯æ˜¯ä¸‡ä¸‡æ²¡æƒ³åˆ°è™½ç„¶è¿”å›äº†403, ä½†æ˜¯ä¹Ÿæœ‰700å­—èŠ‚å¤§å°, å¤§é‡è¯·æ±‚å¯¹å°å¸¦å®½æ¥è¯´è¿˜æ˜¯æœ‰å‹åŠ›çš„</p>
</blockquote>
<pre><code>#
server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        return 499;
   }

#å…¶ä»–location,ifé…ç½®,
if ($host != a.example.com) {
    return 499;
}

</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="nginxé—®é¢˜-nginx111ä»¥å‰trace_id-ç”Ÿæˆ">nginxé—®é¢˜: nginx1.11ä»¥å‰trace_id ç”Ÿæˆ</h3>
<ul>
<li>å¦‚æœæ˜¯å‰ç«¯(upstream)</li>
</ul>
<pre><code>log_format  server_name_main '&quot;$request_trace_id&quot; [ $host $request_time ] ' '[ $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '  '$body_bytes_sent &quot;$http_referer&quot; '
                     '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$bytes_sent&quot;'    '{$request_body}' ;
...

server {
        set $request_trace_id $pid$connection$bytes_sent$msec;
        if ( $http_x_request_id != &quot;&quot; ){
                set $request_trace_id $http_x_request_id;
        }
        add_header  Bq_F_Traceid $request_trace_id;

	# ä¸€å®šè¦å†™åˆ°locationä¸­, å› ä¸ºproxy_pass
	location / {

		proxy_pass http://xxxx;
                proxy_set_header  X-Request-Id        $request_trace_id;

	}
}
</code></pre><ul>
<li>å¦‚æœæ˜¯åç«¯èŠ‚ç‚¹</li>
</ul>
<pre><code># ä¸€å®šè¦å†™åˆ°serveræ®µ, å¦åˆ™åç«¯å¯èƒ½æŠ¥404é”™è¯¯
server {
	listen 80;
    	server_name  openapi-community-alpha.zhangzw.com ;

        set $request_trace_id $pid$connection$bytes_sent$msec;
        if ( $http_x_request_id != &quot;&quot; ){
                set $request_trace_id $http_x_request_id;
        }
        add_header  Bq_X_Traceid $request_trace_id;

	location / {
		try_files $uri $uri/ /index.php?$query_string;
	}
}
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ç½‘ç»œé—®é¢˜-è½¬å‘æ­£ä»£å’Œåä»£">ç½‘ç»œé—®é¢˜: è½¬å‘,æ­£ä»£å’Œåä»£</h3>
<pre><code>1. æ­£ä»£: å†…ç½‘å®¢æˆ·ç«¯172.16.88.88æƒ³è¦è®¿é—®google,é€šè¿‡æµè§ˆå™¨é…ç½®ä»£ç†æœåŠ¡å™¨ip(172.16.88.2:1080) å»è®¿é—®google, ä»£ç†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘
2. åä»£: å†…ç½‘æœåŠ¡ç«¯10.10.88.88ä¸Šæœ‰httpæœåŠ¡,é€šè¿‡é…ç½®ä»£ç†æœåŠ¡å™¨(10.10.88.2:80 å¤–ç½‘åœ°å€:1.1.1.1:80)ç»‘å®šåŸŸåwww.googoo.comå¯¹å¤–æä¾›æœåŠ¡, ä»£ç†æœåŠ¡å™¨å’ŒæœåŠ¡ç«¯åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘
3. è½¬å‘: åªæ˜¯æ•°æ®è½¬å‘, ä¸ä¼šé‡æ–°å»ºç«‹tcpè¿æ¥,ä»£ç†æ˜¯éœ€è¦ä¸ä¸Šæ¸¸å’Œä¸‹æ¸¸éƒ½å»ºç«‹tcpè¿æ¥
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å…¶ä»–é—®é¢˜-ä¿®æ”¹swap">å…¶ä»–é—®é¢˜: ä¿®æ”¹swap</h3>
<pre><code>dd if=/dev/zero of=/data/swapfilenew bs=4096 count=4096000

swapoff -a

/sbin/mkswap  /data/swapfilenew
/sbin/swapon  /data/swapfilenew

vim /etc/fstab
/data/swapfilenew none swap defaults 0 0
</code></pre><h3 id="å…¶ä»–é—®é¢˜-jenkins-uiç‰¹åˆ«æ…¢-jobsæ•°é‡100">å…¶ä»–é—®é¢˜: jenkins uiç‰¹åˆ«æ…¢ (jobsæ•°é‡100+)</h3>
<p>åŸæ–‡: <a href="https://www.coder.work/article/6390497">jenkins GUIéå¸¸æ…¢-æµè§ˆå™¨ç¼“å­˜æ¸…é™¤åå¾ˆå¿«</a></p>
<pre><code>ç³»ç»Ÿç®¡ç† -&gt; å…¨å±€å®‰å…¨é…ç½® -&gt; å‹¾é€‰ Disable remember me
</code></pre><h3 id="å…¶ä»–é—®é¢˜-postgresqlæ—¶åŒºä¿®æ”¹">å…¶ä»–é—®é¢˜: postgreSqlæ—¶åŒºä¿®æ”¹</h3>
<h4 id="dockerå¯åŠ¨é€šè¿‡å˜é‡ä¼ å…¥">dockerå¯åŠ¨é€šè¿‡å˜é‡ä¼ å…¥</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;PRC&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">PGTZ</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;PRC&#39;</span><span class="w">
</span></code></pre></div><h4 id="ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶">ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">vim /var/lib/pgsql/9.4/data/postgresql.conf
<span class="nv">log_timezone</span> <span class="o">=</span> <span class="s1">&#39;PRC&#39;</span>
<span class="nv">timezone</span> <span class="o">=</span> <span class="s1">&#39;PRC&#39;</span>
</code></pre></div><h3 id="å…¶ä»–é—®é¢˜-kafkaå’Œrocketmqæ¯”è¾ƒ">å…¶ä»–é—®é¢˜: kafkaå’ŒrocketMQæ¯”è¾ƒ</h3>
<ul>
<li><a href="https://blog.csdn.net/lppl010_/article/details/86662346">é˜¿é‡Œ RocketMQ ä¼˜åŠ¿å¯¹æ¯”</a></li>
</ul>
<p>RocketMQ æ˜¯å¯¹kafkaçš„ä¸€ç§ä¼˜åŒ–, kafkaä¸­çš„æ¯ä¸ªtopicçš„æ¯ä¸ªåˆ†åŒºéƒ½ä¼šå¯¹åº”ä¸€ä¸ªç‰©ç†æ–‡ä»¶, ä½†topicæ•°é‡è¶Šå¤šæ—¶, åˆ†åŒºåˆ†æ•£æ›´æ˜æ˜¾,å°±ä¼šå¯¼è‡´ç£ç›˜IOæˆä¸ºç“¶é¢ˆ, è€ŒrocketMQæ‰€æœ‰çš„æ¶ˆæ¯æ˜¯ä¿å­˜åœ¨åŒä¸€ä¸ªç‰©ç†æ–‡ä»¶ä¸­, topicå’Œåˆ†åŒºæ•°å¯¹rocketMQåªæ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µ, å› æ­¤éšç€topicå¢åŠ , kafkaæ€§èƒ½æ€¥å‰§ä¸‹é™, rocketMQå½±å“ä¸å¤§</p>
<h3 id="å…¶ä»–é—®é¢˜-è®°å½•ä¸€ä¸ªphpæ‰©å±•åŠ¨æ€å®‰è£…çš„é”™è¯¯é—®é¢˜">å…¶ä»–é—®é¢˜: è®°å½•ä¸€ä¸ªphpæ‰©å±•åŠ¨æ€å®‰è£…çš„é”™è¯¯é—®é¢˜</h3>
<p>åŒäº‹åœ¨è‡ªå·±çš„vagrantå®‰è£…php7.0çš„mongodb1.7.5æ‰©å±•,ä½†æ˜¯æ·»åŠ åˆ°iniçš„æ—¶å€™æŠ¥é”™å¦‚ä¸‹:</p>
<pre><code>undefined symbol: zend_string_init_interned
</code></pre><ul>
<li>åˆ†æ</li>
</ul>
<pre><code>1 é¦–å…ˆæ‰©å±•è¢«å®‰è£…åˆ° /usr/lib/php/20180731ç›®å½•
2 æŠ¥é”™æ˜¾ç¤ºæ— æ³•åŠ è½½çš„åŠ¨æ€åº“
</code></pre><ul>
<li>é—®é¢˜1 ç”±äºphp7.0çš„extension_diré…ç½®æŸ¥çœ‹å‘ç°æ˜¯/usr/lib/php/20151012,æ‰€ä»¥æ”¹åŠ¨æ€ç¼–è¯‘å¹¶æœªç”Ÿæˆåˆ°æ­£ç¡®çš„è·¯å¾„</li>
<li>é—®é¢˜2 è¯¥æŠ¥é”™å¯èƒ½æ˜¯åŠ¨æ€åº“ä¸èƒ½è¯†åˆ«é—®é¢˜</li>
</ul>
<p>ç»è¿‡ç¡®è®¤è¯¥ç¯å¢ƒå®‰è£…äº†å¤šä¸ªphpç‰ˆæœ¬, æœ€æ–°çš„æ˜¯php7.4, è€Œphpå‘½ä»¤é»˜è®¤æ˜¯linkåˆ°php7.0, ä½†æ˜¯åŠ¨æ€æ‰©å±•ç¼–è¯‘çš„å‘½ä»¤å¦‚ä¸‹:</p>
<pre><code>/usr/php/phpize
./configure
make
make install
</code></pre><p>æ˜¾ç„¶é—®é¢˜å°±åœ¨è¿™, è¿™é‡Œphpize å’Œconfigureä¼šèµ°é»˜è®¤çš„é…ç½®, é»˜è®¤çš„é…ç½®å¯èƒ½æ˜¯æœ€æ–°çš„php7.4(å¤§æ¦‚æ˜¯ä»…ä»…phpå‘½ä»¤linkåˆ°äº†php7.0)
å› æ­¤é‡æ–°ç¼–è¯‘å¦‚ä¸‹:</p>
<pre><code>/usr/php/phpize7.0
./configure --with-php-config=/path/to/php-config7.0
make
make install
</code></pre>]]></content>
		</item>
		
		<item>
			<title>TcpdumpæŠ“åŒ…åˆ†ætcpä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</title>
			<link>https://www.ngirl.xyz/posts/62-tcpdump%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90tcp%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</link>
			<pubDate>Fri, 13 Nov 2020 17:28:38 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/62-tcpdump%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90tcp%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</guid>
			<description>å‘½ä»¤å‚æ•°è¯´æ˜  -n ä¸»æœºååŸŸåæ˜¾ç¤ºæˆip -S ç”¨ç»å¯¹è€Œéç›¸å¯¹æ•°å€¼åˆ—å‡ºTCPå…³è”æ•°ã€‚ -i æ¥å£å,æŒ‡å®šç½‘å¡å host è¯·æ±‚åœ°å€: www.baidu.com tcp è¯·æ±‚ç«¯å£: tcp:80  æ ‡å¿—è¯´æ˜  Flags [S]: è¯·æ±‚è¿æ¥(SYN) Flags [S.]: sync+ack(SYN+ACK) Flags [.]: ack(ACK) Flags [P.]: å‘é€æ•°æ®åŒ…(PUSH) Flags [F]: å‘é€æ–¹æ²¡æœ‰æ›´å¤šåŒ…å‘é€äº†(FIN) Flags [R]: è¡¨æ˜packetçš„å‘é€æ–¹é©¬ä¸Šå°±è¦æ–­å¼€å½“å‰è¿æ¥äº†(RST)   å‚è€ƒå®˜æ–¹æ‰‹å†Œ
 æœ¬æ¬¡æŠ“å–çš„ç»“æœ  é€šè¿‡curl http://www.baiu.comå¾—åˆ°
 # æŠ“å– enp0s3 ç½‘å¡è¯·æ±‚ http://www.baidu.com çš„åŒ…å¹¶æ˜¾ç¤ºipå’Œå®é™…å‘é€seqå’Œack tcpdump -n -S -i enp0s3 host www.baidu.com and tcp port 80 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes # ä¸‰æ¬¡æ¡æ‰‹åŒ… 15:35:23.</description>
			<content type="html"><![CDATA[<h3 id="å‘½ä»¤å‚æ•°è¯´æ˜">å‘½ä»¤å‚æ•°è¯´æ˜</h3>
<ul>
<li>-n ä¸»æœºååŸŸåæ˜¾ç¤ºæˆip</li>
<li>-S ç”¨ç»å¯¹è€Œéç›¸å¯¹æ•°å€¼åˆ—å‡ºTCPå…³è”æ•°ã€‚</li>
<li>-i æ¥å£å,æŒ‡å®šç½‘å¡å</li>
<li>host è¯·æ±‚åœ°å€: <a href="http://www.baidu.com">www.baidu.com</a></li>
<li>tcp  è¯·æ±‚ç«¯å£: tcp:80</li>
</ul>
<h3 id="æ ‡å¿—è¯´æ˜">æ ‡å¿—è¯´æ˜</h3>
<ul>
<li>Flags [S]: è¯·æ±‚è¿æ¥(SYN)</li>
<li>Flags [S.]: sync+ack(SYN+ACK)</li>
<li>Flags [.]: ack(ACK)</li>
<li>Flags [P.]: å‘é€æ•°æ®åŒ…(PUSH)</li>
<li>Flags [F]: å‘é€æ–¹æ²¡æœ‰æ›´å¤šåŒ…å‘é€äº†(FIN)</li>
<li>Flags [R]: è¡¨æ˜packetçš„å‘é€æ–¹é©¬ä¸Šå°±è¦æ–­å¼€å½“å‰è¿æ¥äº†(RST)</li>
</ul>
<blockquote>
<p>å‚è€ƒ<a href="http://www.tcpdump.org/manpages/tcpdump.1.html">å®˜æ–¹æ‰‹å†Œ</a></p>
</blockquote>
<h3 id="æœ¬æ¬¡æŠ“å–çš„ç»“æœ">æœ¬æ¬¡æŠ“å–çš„ç»“æœ</h3>
<blockquote>
<p>é€šè¿‡<code>curl http://www.baiu.com</code>å¾—åˆ°</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># æŠ“å– enp0s3 ç½‘å¡è¯·æ±‚ http://www.baidu.com çš„åŒ…å¹¶æ˜¾ç¤ºipå’Œå®é™…å‘é€seqå’Œack</span>
tcpdump -n -S -i enp0s3 host www.baidu.com and tcp port <span class="m">80</span>
tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
listening on enp0s3, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes


<span class="c1"># ä¸‰æ¬¡æ¡æ‰‹åŒ…</span>
15:35:23.254118 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>S<span class="o">]</span>, seq 2358640817, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">1164279598</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
15:35:23.262005 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 1212165121, ack 2358640818, win 8192, options <span class="o">[</span>mss 1452,sackOK,nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,wscale 5<span class="o">]</span>, length <span class="m">0</span>
15:35:23.262068 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212165122, win 229, length <span class="m">0</span>

<span class="c1"># æ•°æ®ä¼ è¾“åŒ…</span>
15:35:23.262260 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 2358640818:2358640895, ack 1212165122, win 229, length 77: HTTP: GET / HTTP/1.1
15:35:23.272385 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>.<span class="o">]</span>, ack 2358640895, win 908, length <span class="m">0</span>
15:35:23.273343 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1212165122:1212167903, ack 2358640895, win 908, length 2781: HTTP: HTTP/1.1 <span class="m">200</span> OK
15:35:23.273403 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212167903, win 272, length <span class="m">0</span>

<span class="c1"># å››æ¬¡æŒ¥æ‰‹åŒ…</span>
15:35:23.273657 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 2358640895, ack 1212167903, win 272, length <span class="m">0</span>
15:35:23.282240 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>.<span class="o">]</span>, ack 2358640896, win 908, length <span class="m">0</span>
15:35:23.282290 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 1212167903, ack 2358640896, win 908, length <span class="m">0</span>
15:35:23.282322 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212167904, win 272, length <span class="m">0</span>

<span class="c1"># RSTåŒ…</span>
15:35:26.295824 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>R<span class="o">]</span>, seq 1212167904, win 0, length <span class="m">0</span>

</code></pre></div><p><img src="/images/tcp_open_close.jpg" alt=""></p>
<blockquote>
<p>è¯´æ˜: è¿™è¾¹write()ä¼ è¾“æ•°æ®ä¸º0çš„æ—¶å€™,é»˜è®¤+1,å¦åˆ™è¿›å…¥æ­»å¾ªç¯,seq=ackå°±åŒä¸€ä¸ªå€¼åœ¨æ ¡éªŒäº†,æ‰€ä»¥seq=x+1,ACK=y+1æ˜¯æ²¡é—®é¢˜çš„, æˆ‘è¿™è¾¹è¯·æ±‚ç™¾åº¦çš„æ•°æ®å‘é€æ˜¯: 77,åé¢ç™¾åº¦æœåŠ¡ç«¯å›å¤çš„æ•°æ®é•¿åº¦æ˜¯: 2781, æ‰€ä»¥å¦‚æœlengthä¸ä¸ºç©ºçš„æ—¶å€™,seq=x+len</p>
</blockquote>
<blockquote>
<p>è¿™é‡Œæˆ‘<code>telnet 80</code> ç«¯å£æµ‹è¯•è¿æ¥ å¹¶å‘é€æ•°æ®<code>1</code>,ç»“æœå½“ç„¶nginxä¼šç»™<code>400</code>, å¯ä»¥çœ‹åˆ°è¿™è¾¹<code>length=3</code></p>
<p>ä¸ºå•¥æ˜¯3å‘¢?</p>
<p>(çŒœæµ‹å“ˆ)&hellip; é¦–å…ˆå›è½¦åº”è¯¥ä¹Ÿç®—äº†ä¸€ä¸ªå­—èŠ‚,æ•°æ®<code>1</code>ç®—ä¸€ä¸ªå­—èŠ‚, ç°åœ¨å°±ä¸¤ä¸ªå­—èŠ‚äº†, è¿˜æœ‰ä¸€ä¸ªåº”è¯¥æ˜¯æ¯æ¬¡ackçš„<code>+1</code>å§? ä½†å¥½åƒæœ‰ç‚¹ç‰µå¼º&hellip;</p>
</blockquote>
<p>å‚è€ƒ: <a href="http://c.biancheng.net/view/2352.html">è¯¦ç»†åˆ†æTCPæ•°æ®çš„ä¼ è¾“è¿‡ç¨‹</a></p>
<blockquote>
<p>æ‰€ä»¥: 1669015475 = 1669015472 + 2(å‘é€å­—èŠ‚æ•°) +1 ???  é‚£ä¸ºå•¥ lengthè¦è®°æˆ3å‘¢&hellip; è®°å½•æˆ2æ›´åˆç†å§,æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜</p>
</blockquote>
<pre><code>17:44:35.874189 IP 172.xx.xx.xx.58623 &gt; 172.16.56.116.http: Flags [P.], seq 1669015472:1669015475, ack 2645576909, win 4117, options [nop,nop,TS val 531802073 ecr 1306189625], length 3: HTTP
17:44:35.874291 IP 172.16.56.116.http &gt; 172.xx.xx.xx.58623: Flags [.], ack 1669015475, win 227, options [nop,nop,TS val 1306191841 ecr 531802073], length 0
17:44:35.874869 IP 172.16.56.116.http &gt; 172.xx.xx.xx.58623: Flags [P.], seq 2645576909:2645577234, ack 1669015475, win 227, options [nop,nop,TS val 1306191842 ecr 531802073], length 325: HTTP: HTTP/1.1 400 Bad Request
</code></pre><h3 id="åˆ†æä¸‰æ¬¡æ¡æ‰‹åŒ…">åˆ†æä¸‰æ¬¡æ¡æ‰‹åŒ…</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">15:35:23.254118 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>S<span class="o">]</span>, seq 2358640817, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">1164279598</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
15:35:23.262005 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 1212165121, ack 2358640818, win 8192, options <span class="o">[</span>mss 1452,sackOK,nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,wscale 5<span class="o">]</span>, length <span class="m">0</span>
15:35:23.262068 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212165122, win 229, length <span class="m">0</span>
</code></pre></div><ul>
<li>
<ol>
<li>å®¢æˆ·ç«¯å‘èµ·å…³é—­,å‘é€SYNåŒ…,   <code>Flags [S]</code> ä»£è¡¨<code>syn</code>æ ‡å¿—,  å‘é€éšæœºæ•°<code>seq=2358640817</code>, <code>win=29200</code>, å‘é€æ•°æ®<code>length=0</code></li>
</ol>
</li>
<li>
<ol start="2">
<li>æœåŠ¡ç«¯å›å¤ç¡®è®¤åŒ…å¹¶ä¸”å‘é€SYNåŒ…, <code>Flags [S.]</code>ä¸­çš„. ä»£è¡¨<code>ack</code>, è¿™é‡Œ<code>ack=2358640817+1</code>, æ–°çš„æœåŠ¡ç«¯å‘é€éšæœºæ•°<code>seq=2358640817</code>, <code>win=8192</code>,</li>
</ol>
</li>
<li>
<ol start="3">
<li>å®¢æˆ·ç«¯å›å¤SYNç¡®è®¤åŒ…,    å›å¤<code>ack=1212165121+1</code></li>
</ol>
</li>
</ul>
<h3 id="åˆ†ææ•°æ®ä¼ è¾“åŒ…">åˆ†ææ•°æ®ä¼ è¾“åŒ…</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">15:35:23.262260 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 2358640818:2358640895, ack 1212165122, win 229, length 77: HTTP: GET / HTTP/1.1
15:35:23.272385 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>.<span class="o">]</span>, ack 2358640895, win 908, length <span class="m">0</span>
15:35:23.273343 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1212165122:1212167903, ack 2358640895, win 908, length 2781: HTTP: HTTP/1.1 <span class="m">200</span> OK
15:35:23.273403 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212167903, win 272, length <span class="m">0</span>

</code></pre></div><ul>
<li>
<ol>
<li><code>Flags [P.]</code>  <code>P</code>è¡¨ç¤ºå‘é€æ•°æ®, <code>.</code>è¡¨ç¤ºackå›å¤, è¿™é‡Œseqä¸­ <code>2358640895=2358640818+77</code>(æ•°æ®é•¿åº¦) 2358640818å°±æ˜¯ä¸Šæ¬¡çš„<code>ack</code>å€¼, <code>ack=1212165122</code></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Flags [.]</code>   <code>.</code>è¡¨ç¤º<code>ack 2358640895=2358640818+77</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><code>Flags [P.]</code>  Pè¡¨ç¤ºå‘é€æ•°æ®, .è¡¨ç¤ºackå›å¤, è¿™é‡Œseqä¸­ <code>1212167903=1212165122+2781</code>(æ•°æ®é•¿åº¦), <code>ack=2358640895</code></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Flags [.]</code>   <code>.</code>è¡¨ç¤º<code>ack 1212167903=1212165122+2781</code></li>
</ol>
</li>
</ul>
<h3 id="å››æ¬¡æŒ¥æ‰‹åŒ…">å››æ¬¡æŒ¥æ‰‹åŒ…</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">15:35:23.273657 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 2358640895, ack 1212167903, win 272, length <span class="m">0</span>
15:35:23.282240 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>.<span class="o">]</span>, ack 2358640896, win 908, length <span class="m">0</span>
15:35:23.282290 IP 180.101.49.11.http &gt; 172.xx.xx.xx.54646: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 1212167903, ack 2358640896, win 908, length <span class="m">0</span>
15:35:23.282322 IP 172.xx.xx.xx.54646 &gt; 180.101.49.11.http: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1212167904, win 272, length <span class="m">0</span>
</code></pre></div><ul>
<li>
<ol>
<li><code>Flags [F.]</code>  å®¢æˆ·ç«¯å‘èµ·finåŒ…,  <code>F</code>è¡¨ç¤ºå‘èµ·æŒ¥æ‰‹FIN,<code>.</code>è¡¨ç¤º<code>ack</code>, <code>seq=2358640895</code>å°±æ˜¯ä¸Šæ¬¡çš„<code>ack</code>å€¼, <code>ack=1212167903</code></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Flags [.]</code>   æœåŠ¡ç«¯å›å¤ç¡®è®¤åŒ…, <code>.</code>è¡¨ç¤º<code>ack</code>,<code>ack=2358640895+1</code>,</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>Flags [F.]</code>  æœåŠ¡ç«¯å‘èµ·finåŒ…, <code>F</code>è¡¨ç¤ºå‘èµ·æŒ¥æ‰‹FIN,<code>.</code>è¡¨ç¤º<code>ack</code>,  <code>seq=1212167903</code>æ˜¯ä¸Šæ¬¡çš„<code>ack</code>å€¼,, <code>ack=2358640895+1</code></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Flags [.]</code>   å®¢æˆ·ç«¯å›å¤ç¡®è®¤åŒ…, <code>.</code>è¡¨ç¤º<code>ack=1212167903+1</code>,</li>
</ol>
</li>
</ul>
<h3 id="å…¶ä»–æ–‡ç« ">å…¶ä»–æ–‡ç« </h3>
<ul>
<li><a href="https://www.cnblogs.com/nzbbody/p/8622497.html">ä»€ä¹ˆæ˜¯win</a></li>
<li><a href="https://blog.csdn.net/Mr_rsq/article/details/81082127">TCPä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æ–­å¼€åŠ11ç§çŠ¶æ€è½¬å˜</a></li>
<li><a href="https://testerhome.com/topics/22107">Tcpdump ç»“æœè¯´æ˜</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>k8sé‡åˆ°çš„ä¸€äº›é—®é¢˜ç»Ÿè®¡æ€»ç»“</title>
			<link>https://www.ngirl.xyz/posts/3-k8s%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E7%BB%9F%E8%AE%A1%E6%80%BB%E7%BB%93/</link>
			<pubDate>Tue, 10 Nov 2020 14:06:41 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/3-k8s%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E7%BB%9F%E8%AE%A1%E6%80%BB%E7%BB%93/</guid>
			<description>ä¸å®šæ—¶æ›´æ–°,æ–‡ç« å¯èƒ½æ¯”è¾ƒæ•£ä¹±,&amp;gt;_&amp;lt;
  1. å•æœºç‰ˆk8s podä¸€ç›´æ˜¯pendingçš„é—®é¢˜  describeä¸€ä¸‹podä¼šå‘ç°é”™è¯¯: 1 node(s) had taints that the pod didnt tolerate. è¿™æ˜¯å› ä¸ºmasterä¸Šå­˜åœ¨æ±¡ç‚¹,podä¸ä¼šå†æ”¹èŠ‚ç‚¹ä¸Šåˆ›å»º ä¸¤ç§åŠæ³•:
  deploy çš„æ—¶å€™åŠ ä¸Š å®¹å¿è¯¥æ±¡ç‚¹ ç›´æ¥å–æ¶ˆmasterä¸Šçš„æ±¡ç‚¹  # å–æ¶ˆmasterä¸Šæ±¡ç‚¹ kubectl taint nodes --all node-role.kubernetes.io/master- # æŸ¥çœ‹taint kubectl describe node node1   2. ä¿®æ”¹service-node-port-range  ç”±äºtraefikéƒ¨ç½²éœ€è¦å¯¹å¤–å¼€æ”¾80ç«¯å£, ä½†é»˜è®¤ä»…å…è®¸30000ä»¥ä¸Šç«¯å£
 # kubeadm 1.14 é…ç½® apiServer: extraArgs: authorization-mode: Node,RBAC service-node-port-range: 79-33000 # kubeadm 1.10é…ç½® apiServerExtraArgs: service-node-port-range: 79-33000   3. traefikæ–­ç”µåé‡æ–°å¯åŠ¨æŠ¥é”™ command traefik error: field not found, node: redirect çœ‹åˆ°è¿™ä¸ªé”™è¯¯çŒœæµ‹å¯èƒ½æ˜¯ç”¨çš„latesté•œåƒé—®é¢˜, ä»`hub.</description>
			<content type="html"><![CDATA[<p>ä¸å®šæ—¶æ›´æ–°,æ–‡ç« å¯èƒ½æ¯”è¾ƒæ•£ä¹±,&gt;_&lt;</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="1-å•æœºç‰ˆk8s-podä¸€ç›´æ˜¯pendingçš„é—®é¢˜">1. å•æœºç‰ˆk8s podä¸€ç›´æ˜¯pendingçš„é—®é¢˜</h3>
<blockquote>
<p>describeä¸€ä¸‹podä¼šå‘ç°é”™è¯¯: 1 node(s) had taints that the pod didnt tolerate.
è¿™æ˜¯å› ä¸ºmasterä¸Šå­˜åœ¨æ±¡ç‚¹,podä¸ä¼šå†æ”¹èŠ‚ç‚¹ä¸Šåˆ›å»º
ä¸¤ç§åŠæ³•:</p>
</blockquote>
<ul>
<li>deploy çš„æ—¶å€™åŠ ä¸Š å®¹å¿è¯¥æ±¡ç‚¹</li>
<li>ç›´æ¥å–æ¶ˆmasterä¸Šçš„æ±¡ç‚¹</li>
</ul>
<pre><code># å–æ¶ˆmasterä¸Šæ±¡ç‚¹
  kubectl taint nodes --all node-role.kubernetes.io/master-

# æŸ¥çœ‹taint
kubectl describe node node1
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="2-ä¿®æ”¹service-node-port-range">2. ä¿®æ”¹service-node-port-range</h3>
<blockquote>
<p>ç”±äºtraefikéƒ¨ç½²éœ€è¦å¯¹å¤–å¼€æ”¾80ç«¯å£, ä½†é»˜è®¤ä»…å…è®¸30000ä»¥ä¸Šç«¯å£</p>
</blockquote>
<pre><code># kubeadm 1.14 é…ç½®
apiServer:
  extraArgs:
    authorization-mode: Node,RBAC
    service-node-port-range: 79-33000

# kubeadm 1.10é…ç½®
apiServerExtraArgs:
  service-node-port-range: 79-33000
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="3-traefikæ–­ç”µåé‡æ–°å¯åŠ¨æŠ¥é”™-command-traefik-error-field-not-found-node-redirect">3. traefikæ–­ç”µåé‡æ–°å¯åŠ¨æŠ¥é”™ command traefik error: field not found, node: redirect</h3>
<pre><code>çœ‹åˆ°è¿™ä¸ªé”™è¯¯çŒœæµ‹å¯èƒ½æ˜¯ç”¨çš„latesté•œåƒé—®é¢˜, ä»`hub.docker.com` æŸ¥çœ‹æ›´æ–°äº†v2.0+çš„ç‰ˆæœ¬

å°†`traefik`çš„`deployment`é…ç½®ä¸­ imageæ”¹æˆ `traefik:1.7`

é‡æ–°éƒ¨ç½²å é—®é¢˜è§£
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="4-æŸ¥çœ‹å½“å‰é›†ç¾¤çš„customresourcedefinition">4. æŸ¥çœ‹å½“å‰é›†ç¾¤çš„(CustomResourceDefinition)</h3>
<pre><code># æŸ¥çœ‹k8sæœ‰å“ªäº›api
kubectl api-versions

# æŸ¥çœ‹å½“å‰crd
kubectl get crd

# å…¶æ¬¡æŸ¥çœ‹è¯¥apiæ˜¯ä»€ä¹ˆç‰ˆæœ¬
kubectl describe crd destinationrules.networking.istio.io

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="5-å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet-è¯ä¹¦è¯ä¹¦æœªè¿‡æœŸ">5. å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet è¯ä¹¦(è¯ä¹¦æœªè¿‡æœŸ)</h3>
<p>å‚è€ƒ: <a href="https://www.cnblogs.com/skymyyang/p/11093686.html">Kubeadmè¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´</a></p>
<p><code>kubelet</code>è¯ä¹¦åˆ†ä¸ºserverå’Œclientä¸¤ç§ï¼Œ k8s 1.9é»˜è®¤å¯ç”¨äº†clientè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢ï¼Œä½†serverè¯ä¹¦è‡ªåŠ¨è½®æ¢éœ€è¦ç”¨æˆ·å¼€å¯</p>
<p>å¢åŠ  kubelet å‚æ•°</p>
<pre><code># åœ¨/etc/systemd/system/kubelet.service.d/10-kubeadm.conf å¢åŠ å¦‚ä¸‹å‚æ•°

Environment=&quot;KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true&quot;
</code></pre><p>å¢åŠ  controller-manager å‚æ•°</p>
<pre><code># åœ¨/etc/kubernetes/manifests/kube-controller-manager.yaml æ·»åŠ å¦‚ä¸‹å‚æ•°
  - command:
    - kube-controller-manager
    - --experimental-cluster-signing-duration=87600h0m0s
    - --feature-gates=RotateKubeletServerCertificate=true
    - ....
</code></pre><p>åˆ›å»º rbac å¯¹è±¡
åˆ›å»º rbacå¯¹è±¡ï¼Œå…è®¸èŠ‚ç‚¹è½®æ¢kubelet serverè¯ä¹¦ï¼š</p>
<pre><code>cat &gt; ca-update.yaml &lt;&lt; EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver
rules:
- apiGroups:
  - certificates.k8s.io
  resources:
  - certificatesigningrequests/selfnodeserver
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubeadm:node-autoapprove-certificate-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
EOF

kubectl create â€“f ca-update.yaml
</code></pre><p>é‡æ–°å¯åŠ¨kubelet</p>
<pre><code>systemctl daemon-reload
systemctl enable kubelet
systemctl restart kubelet
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="6-hpaçš„ä¸€ä¸ªcpu-percentç™¾åˆ†æ¯”é—®é¢˜">6. hpaçš„ä¸€ä¸ªcpu-percentç™¾åˆ†æ¯”é—®é¢˜</h3>
<pre><code>kubectl autoscale deployment php-admintest-nginx-dev --cpu-percent=80 --min=1 --max=2 -n php-dev
</code></pre><p>ä¾‹å¦‚ä»¥ä¸Š,æˆ‘å¸Œæœ›åœ¨å¹³å‡cpuè¶…è¿‡80%æ—¶,podèƒ½è‡ªåŠ¨è°ƒæ•´ä¸º2ä¸ª</p>
<p>em&hellip;è¿™æ²¡å•¥é—®é¢˜</p>
<p>ä½†æˆ‘åšç®€å•abå‹æµ‹å‘ç°, æˆ‘æŠŠcpuå‹åˆ°äº†100000% &hellip;</p>
<p>æˆ‘çš„deployment é…ç½®ä¸­æ˜¯è¿™æ ·é™åˆ¶cpuçš„</p>
<pre><code>        resources:
          requests:
            cpu: &quot;1m&quot;
          limits:
            cpu: &quot;1000m&quot;
</code></pre><p>æ˜¾ç„¶æˆ‘çš„podå¯ä»¥ä½¿ç”¨1ä¸ªæ ¸cpu, é‚£è¿™ä¸ªå¹³å‡cpuæ˜¯ç­‰äºå•¥å‘¢?</p>
<p>cpu-percent = 1000m/resources.request.cpu =&gt; 1000m/1m =100000%</p>
<p>-_-!!!</p>
<p>ç¨å¾®è§£é‡Šä¸‹,ä¸ºå•¥æˆ‘è¦è®¾ç½®request.cpu=1m:
æ¯”å¦‚å•æœº4æ ¸k8s,æˆ‘å¯åŠ¨äº†1ä¸ªpod,limitæ˜¯4cpu,é‚£ä¹ˆæˆ‘request.cpuå…¶å®é»˜è®¤ä¹Ÿæ˜¯1, æ‰€ä»¥é›†ç¾¤å°±å·²ç»é¢„ç•™äº†4cpu, æ­¤æ—¶å¦‚æœåœ¨å¯åŠ¨pod, åœ¨é…ç½®limitçš„æ—¶å€™å°±æ— æ³•æˆåŠŸå¯åŠ¨pod,å› ä¸ºæ ¸å¿ƒä¸å¤Ÿäº†,éƒ½ç»™é‚£ä»€ä¹ˆç©æ„äº†&hellip;(å½“ç„¶è¿™æ ·æ”¹åŠ¨ä¹Ÿçš„ç¡®ä¼šå‡ºç°è¿‡åº¦åˆ†é…)</p>
<blockquote>
<p>å› æ­¤å»ºè®® ä¿®æ”¹requests.cpu=500m,  &ndash;cpu-percentå¯è®¾èŒƒå›´: 0~200% ,æˆ–è€…ä½ä¸€äº› 250m -&gt; 0~400%</p>
</blockquote>
<p>æ€»ç»“:
request.cpu å¿…é¡»è®¾ç½®, è¿™ä¸ªæ˜¯å¯¹æ¯”çš„å¯¹è±¡</p>
<p>å¦å¤–:
å¯¹äºæ‰©å®¹è€Œè¨€ï¼Œè¿™ä¸ªæ—¶é—´æ®µä¸º3åˆ†é’Ÿï¼Œç¼©å®¹ä¸º5åˆ†é’Ÿ(å¯ä»¥é€šè¿‡ <code>--horizontal-pod-autoscaler-downscale-delay</code> ï¼Œ <code>--horizontal-pod-autoscaler-upscale-delay è¿›è¡Œè°ƒæ•´</code>)ã€‚</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="7-k8s1162metrics-v035-deploymenté‡å¯ä¹‹åhpaå°±å¤±æ•ˆæ— æ³•è·å–åˆ°æ•°æ®">7 k8s1.16.2+metrics v0.3.5 deploymenté‡å¯ä¹‹åhpaå°±å¤±æ•ˆ,æ— æ³•è·å–åˆ°æ•°æ®</h3>
<pre><code>The HPA was unable to compute the replica count: unable to get metrics for resource cpu: no metrics returned from resource metrics API 
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="8-k8sæœºå™¨è¿›ç¨‹æ•°è¾¾åˆ°500å¤šçš„æ—¶å€™-sshè¿æ¥åˆ°æœåŠ¡æŠ¥é”™-shell-request-failed-on-channel-0">8 k8sæœºå™¨è¿›ç¨‹æ•°è¾¾åˆ°500å¤šçš„æ—¶å€™, sshè¿æ¥åˆ°æœåŠ¡æŠ¥é”™ shell request failed on channel 0</h3>
<pre><code>åŸå› ï¼šç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿè¿›ç¨‹æ•°å¤ªå°ï¼Œå¯¼è‡´ä¸èƒ½è¿æ¥

è§£å†³ï¼šéœ€è¦ä¿®æ”¹/etc/security/limits.d/20-nproc.confæ–‡ä»¶ä¸­çš„å€¼ï¼ŒæŠŠ4096æ”¹å¤§ä¸€ç‚¹ï¼Œå¦‚ 65535

#cat /etc/security/limits.d/20-nproc.conf
* Â  Â  Â  Â  Â soft Â  Â nproc Â  Â  4096
root Â  Â  Â  soft Â  Â nproc Â  Â  unlimited

é‡æ–°sshï¼Œå³å¯ã€‚

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="9-centos8å®‰è£…k8s118flannel-podé—´ä¸é€š">9 centos8å®‰è£…k8s1.18+flannel podé—´ä¸é€š</h3>
<p>åœ¨æŸ¥çœ‹åˆ°<a href="https://zhangguanzhang.github.io/">é¦†é•¿</a>çš„<a href="https://zhangguanzhang.github.io/2020/10/20/kylin-v10-k8s-overlay-error/">é“¶æ²³éº’éºŸarm64ç³»ç»Ÿä¸Šk8sé›†ç¾¤è·¨èŠ‚ç‚¹ä¸é€šçš„ä¸€æ¬¡æ’æŸ¥</a>é—®é¢˜, å‘ä¸‹æˆ‘çš„flannelç½‘ç»œåŒæ ·æ˜¯ <code>lo</code> ä¹Ÿçš„ç¡®å¯ç”¨äº† <code>NetworkManager</code>, ä¸è¿‡é‡å¯å¹¶æœªæœ‰æ•ˆæœ</p>
<blockquote>
<p>é…ç½®å¦‚ä¸‹:</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ ip route get <span class="k">$(</span>ip a s flannel.1 <span class="p">|</span>grep -w inet<span class="p">|</span>awk -F <span class="s1">&#39;inet|/&#39;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">local</span> 10.244.0.0 dev lo src 10.244.0.0 uid <span class="m">0</span>
    cache &lt;local&gt;

$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.23.0.1       0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> eth0
10.5.27.0       0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> docker0
10.23.0.0       0.0.0.0         255.255.0.0     U     <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> eth0
10.244.0.0      0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> cni0
10.244.1.0      10.244.1.0      255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> flannel.1
192.168.212.64  0.0.0.0         255.255.255.192 U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> *

</code></pre></div><p>äºæ˜¯æˆ‘é‡å¯</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ systemctl restart NetworkManager

$ docker restart <span class="k">$(</span>docker ps <span class="p">|</span>grep flanneld<span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>

$ ip route get <span class="k">$(</span>ip a s flannel.1 <span class="p">|</span>grep -w inet<span class="p">|</span>awk -F <span class="s1">&#39;inet|/&#39;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
broadcast 10.244.0.0 dev cni0 src 10.244.0.1 uid <span class="m">0</span>
    cache &lt;local,brd&gt;
</code></pre></div><p>ä½†æœ€ç»ˆæˆ‘çš„ç°è±¡æ˜¯, masteré‡å¯åä»<code>lo</code>å˜æˆäº†<code>cni0</code>, ä½†æ˜¯å¦å¤–ä¸€å°nodeä¸€ç›´æ— æ•ˆ, é‡å¯å®¹å™¨ååˆå˜æˆ<code>lo</code>, è‡³æ­¤<code>pod</code>é—´ç½‘ç»œä¾ç„¶ä¸é€š</p>
<p>æŒ‰ç…§æ–‡ç« <a href="https://zhuanlan.zhihu.com/p/112834020">Centos8.1éƒ¨ç½²kubernetes1.17 é—®é¢˜ ä½¿ç”¨iptablesæ‰“é€šç½‘ç»œ</a> ä¸­æè¿°æŸ¥çœ‹äº†<code>iptables</code>, æœç„¶<code>Chain FORWARD (policy DROP)</code>, é€šè¿‡<code>iptables -P FORWARD ACCEPT</code>çš„ç¡®è§£å†³äº†é—®é¢˜, ä½†æ˜¾ç„¶è¿™å¹¶ä¸å®‰å…¨.</p>
<p>å…¶ä»–é“¾æ¥:</p>
<ul>
<li>dockeråœ¨ 1.13 ç‰ˆæœ¬ä¹‹åï¼Œå°†ç³»ç»Ÿiptables ä¸­ FORWARD é“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸º DROP: <a href="https://github.com/moby/moby/issues/14041">https://github.com/moby/moby/issues/14041</a></li>
<li>docker&amp;k8så¡«å‘è®° nodeport æ— æ³•è®¿é—®: <a href="https://www.cnblogs.com/tylerzhou/p/10975062.html">https://www.cnblogs.com/tylerzhou/p/10975062.html</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>Kubectlå‘½ä»¤ç®€å•ç†Ÿæ‚‰</title>
			<link>https://www.ngirl.xyz/posts/61-kubectl%E5%91%BD%E4%BB%A4%E7%AE%80%E5%8D%95%E7%86%9F%E6%82%89/</link>
			<pubDate>Thu, 29 Oct 2020 11:15:58 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/61-kubectl%E5%91%BD%E4%BB%A4%E7%AE%80%E5%8D%95%E7%86%9F%E6%82%89/</guid>
			<description>kubectlå‘½ä»¤ç†Ÿæ‚‰ # åˆ›å»ºnamespace kubectl create ns test # æŸ¥çœ‹namespace kubectl get ns # å‘½ä»¤åˆ›å»ºdeployment kubectl create deployment my-nginx --image=nginx --replicas=1 -n test # å‘½ä»¤åˆ é™¤deployment kubectl delete deployments.apps my-nginx -n test # å®¹å™¨æ‰§è¡Œå‘½ä»¤ kubectl exec -ti deployments.apps/nginx -n test -- nginx -v nginx version: nginx/1.16.0 # é€šè¿‡yamlåˆ›å»ºdeployment kubectl apply -f nginx.yaml --record # é€šè¿‡æ–°å¢æˆ–ä¿®æ”¹æ³¨é‡Šæ–¹å¼æ›´æ–°deployment kubectl patch -f nginx.yaml -p &amp;#34;{\&amp;#34;spec\&amp;#34;:{\&amp;#34;template\&amp;#34;:{\&amp;#34;metadata\&amp;#34;:{\&amp;#34;annotations\&amp;#34;:{\&amp;#34;test-last-updated\&amp;#34;:\&amp;#34;$(date +&amp;#39;%F %T&amp;#39;)\&amp;#34;}}}}}&amp;#34; # ä¿®æ”¹image kubectl set image deployment/nginx nginx=nginx:1.16.0 -n test # æ»šåŠ¨å‡çº§ kubectl scale deployment nginx --replicas=2 -n test # åŠ ä¸Š--record historyå°±èƒ½çœ‹åˆ°å˜æ›´ä¿¡æ¯(ä½†æ„Ÿè§‰å·¦å³ä¸å¤§) kubectl rollout history deployment nginx -n test # describe å…¶å®æ›´è¯¦ç»† kubectl describe deployment nginx -n test # æŸ¥çœ‹yamlé…ç½® kubectl get deployment.</description>
			<content type="html"><![CDATA[<h3 id="kubectlå‘½ä»¤ç†Ÿæ‚‰">kubectlå‘½ä»¤ç†Ÿæ‚‰</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># åˆ›å»ºnamespace</span>
kubectl create ns <span class="nb">test</span>

<span class="c1"># æŸ¥çœ‹namespace</span>
kubectl get ns

<span class="c1"># å‘½ä»¤åˆ›å»ºdeployment</span>
kubectl create deployment my-nginx --image<span class="o">=</span>nginx --replicas<span class="o">=</span><span class="m">1</span> -n <span class="nb">test</span> 

<span class="c1"># å‘½ä»¤åˆ é™¤deployment</span>
kubectl delete deployments.apps my-nginx -n <span class="nb">test</span>

<span class="c1"># å®¹å™¨æ‰§è¡Œå‘½ä»¤</span>
kubectl <span class="nb">exec</span> -ti deployments.apps/nginx -n <span class="nb">test</span> -- nginx -v
nginx version: nginx/1.16.0

<span class="c1"># é€šè¿‡yamlåˆ›å»ºdeployment</span>
kubectl apply -f nginx.yaml --record 

<span class="c1"># é€šè¿‡æ–°å¢æˆ–ä¿®æ”¹æ³¨é‡Šæ–¹å¼æ›´æ–°deployment</span>
kubectl patch -f nginx.yaml -p <span class="s2">&#34;{\&#34;spec\&#34;:{\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;test-last-updated\&#34;:\&#34;</span><span class="k">$(</span>date +<span class="s1">&#39;%F %T&#39;</span><span class="k">)</span><span class="s2">\&#34;}}}}}&#34;</span>

<span class="c1"># ä¿®æ”¹image</span>
kubectl <span class="nb">set</span> image deployment/nginx <span class="nv">nginx</span><span class="o">=</span>nginx:1.16.0 -n <span class="nb">test</span>

<span class="c1"># æ»šåŠ¨å‡çº§</span>
kubectl scale deployment nginx --replicas<span class="o">=</span><span class="m">2</span> -n <span class="nb">test</span>

<span class="c1"># åŠ ä¸Š--record historyå°±èƒ½çœ‹åˆ°å˜æ›´ä¿¡æ¯(ä½†æ„Ÿè§‰å·¦å³ä¸å¤§)</span>
kubectl rollout <span class="nb">history</span> deployment nginx -n <span class="nb">test</span>

<span class="c1"># describe å…¶å®æ›´è¯¦ç»†</span>
kubectl describe deployment nginx -n <span class="nb">test</span>

<span class="c1"># æŸ¥çœ‹yamlé…ç½®</span>
kubectl get deployment.apps/nginx -n <span class="nb">test</span> -o yaml

<span class="c1"># è®¾ç½®èµ„æºé™åˆ¶</span>
kubectl <span class="nb">set</span> resources deployment nginx --limits<span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>500m,memory<span class="o">=</span>128Mi -n <span class="nb">test</span>

<span class="c1"># æ–°å¢labels</span>
kubectl label deployments.apps nginx <span class="nv">test</span><span class="o">=</span><span class="nb">true</span> -n <span class="nb">test</span>

<span class="c1"># æŸ¥çœ‹labels</span>
kubectl get deployments.apps nginx  -n <span class="nb">test</span> --show-labels
NAME    READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
nginx   2/2     <span class="m">2</span>            <span class="m">2</span>           11m   <span class="nv">app</span><span class="o">=</span>nginx,test<span class="o">=</span><span class="nb">true</span>

<span class="c1"># å›æ»šç‰ˆæœ¬(æ»šåˆ°ç¬¬ä¸€ä¸ªç‰ˆæœ¬)</span>
kubectl rollout undo deployment nginx -n <span class="nb">test</span> --to-revision<span class="o">=</span><span class="m">1</span>

<span class="c1"># å›åˆ°ä¸Šä¸ªç‰ˆæœ¬</span>
kubectl rollout undo deployment nginx -n <span class="nb">test</span>


<span class="c1"># åˆ›å»ºä¸€ä¸ªservice</span>
kubectl create service nodeport nginx --tcp<span class="o">=</span>31112:80 -n <span class="nb">test</span>
</code></pre></div><h3 id="é™„å½•">é™„å½•</h3>
<h4 id="1-nginxyaml">1. nginx.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test-last-updated</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-10-29&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Golandå¿«æ·é”®è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/60-goland%E5%BF%AB%E6%8D%B7%E9%94%AE%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Tue, 20 Oct 2020 16:42:57 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/60-goland%E5%BF%AB%E6%8D%B7%E9%94%AE%E8%AE%B0%E5%BD%95/</guid>
			<description>1. è®°å½•ä¸€äº›å¸¸è§çš„golandå¿«æ·é”®(mac) 1. command + alt + â† | â†’ // å›é€€|å‰è¿› åˆ°ä¸Šæ¬¡æµè§ˆçš„ä½ç½®  2. command d | x // å¤åˆ¶è¡Œ |åˆ é™¤è¡Œ  3. command b = command + å•å‡» // å¿«é€Ÿæ‰“å¼€å…‰æ ‡å¤„çš„ç±»æˆ–æ–¹æ³•  4. command alt l // é‡æ–°æ ¼å¼åŒ–ä»£ç   5. ä»£ç æŠ˜å å’Œå±•å¼€ - command shift + / - // ä»£ç å…¨éƒ¨å±•å¼€ / æŠ˜å  (é¡¹ç›®æ‰€æœ‰goæ–‡ä»¶å…¨éƒ¨å±•å¼€/æŠ˜å ) - command alt + / - // ä»£ç é€’å½’å±•å¼€ / æŠ˜å  (æ‰€é€‰å†…å®¹è¡Œå†…å…¨éƒ¨å±•å¼€/æŠ˜å ) - command + / - // ä»£ç å±•å¼€ / æŠ˜å  (æ‰€é€‰å†…å®¹å±•å¼€/æŠ˜å )  6.</description>
			<content type="html"><![CDATA[<h3 id="1-è®°å½•ä¸€äº›å¸¸è§çš„golandå¿«æ·é”®mac">1. è®°å½•ä¸€äº›å¸¸è§çš„golandå¿«æ·é”®(mac)</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="mf">1.</span> <span class="nx">command</span> <span class="o">+</span> <span class="nx">alt</span> <span class="o">+</span> <span class="err">â†</span> <span class="p">|</span> <span class="err">â†’</span> 
<span class="c1">//  å›é€€|å‰è¿› åˆ°ä¸Šæ¬¡æµè§ˆçš„ä½ç½®
</span><span class="c1"></span>
<span class="mf">2.</span> <span class="nx">command</span> <span class="nx">d</span> <span class="p">|</span> <span class="nx">x</span>
<span class="c1">// å¤åˆ¶è¡Œ |åˆ é™¤è¡Œ
</span><span class="c1"></span>
<span class="mf">3.</span> <span class="nx">command</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">command</span> <span class="o">+</span> <span class="nx">å•å‡»</span>
<span class="c1">// å¿«é€Ÿæ‰“å¼€å…‰æ ‡å¤„çš„ç±»æˆ–æ–¹æ³•
</span><span class="c1"></span>
<span class="mf">4.</span> <span class="nx">command</span> <span class="nx">alt</span> <span class="nx">l</span> 
<span class="c1">// é‡æ–°æ ¼å¼åŒ–ä»£ç 
</span><span class="c1"></span>
<span class="mf">5.</span> <span class="nx">ä»£ç æŠ˜å å’Œå±•å¼€</span>
<span class="o">-</span> <span class="nx">command</span> <span class="nx">shift</span> <span class="o">+</span> <span class="o">/</span> <span class="o">-</span> 
<span class="c1">// ä»£ç å…¨éƒ¨å±•å¼€ / æŠ˜å  (é¡¹ç›®æ‰€æœ‰goæ–‡ä»¶å…¨éƒ¨å±•å¼€/æŠ˜å )
</span><span class="c1"></span><span class="o">-</span> <span class="nx">command</span> <span class="nx">alt</span> <span class="o">+</span> <span class="o">/</span> <span class="o">-</span> 
<span class="c1">// ä»£ç é€’å½’å±•å¼€ / æŠ˜å  (æ‰€é€‰å†…å®¹è¡Œå†…å…¨éƒ¨å±•å¼€/æŠ˜å )
</span><span class="c1"></span><span class="o">-</span> <span class="nx">command</span> <span class="o">+</span> <span class="o">/</span> <span class="o">-</span>
<span class="c1">// ä»£ç å±•å¼€ / æŠ˜å  (æ‰€é€‰å†…å®¹å±•å¼€/æŠ˜å )
</span><span class="c1"></span>
<span class="mf">6.</span> <span class="nx">åˆ—æ“ä½œ</span>
<span class="s">`Shift + option(alt) + é¼ æ ‡å·¦é”®é€‰æ‹©`</span>

<span class="mf">7.</span> <span class="nx">é‡æ„</span>
<span class="nx">shift</span> <span class="o">+</span> <span class="nx">f6</span>

<span class="mf">8.</span> <span class="nx">å¯¼å…¥</span> <span class="nx">typeæƒ³å®ç°çš„æ¥å£çš„æ–¹æ³•</span>
<span class="nx">control</span> <span class="o">+</span> <span class="nx">i</span>
</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Hugoåšå®¢ä½¿ç”¨è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/58-hugo%E5%8D%9A%E5%AE%A2%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Fri, 16 Oct 2020 17:01:36 +0800</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/58-hugo%E5%8D%9A%E5%AE%A2%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</guid>
			<description>&lt;p&gt;ç”±äºhexoç”Ÿæˆåšå®¢æ•´çš„å¾ˆæ…¢, è€Œä¸”å¾ˆå cpu, ç”šè‡³å¯¼è‡´è€macå¡æ­»äº†&amp;hellip; hugoçœŸçš„å¾ˆé¦™&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç”±äºhexoç”Ÿæˆåšå®¢æ•´çš„å¾ˆæ…¢, è€Œä¸”å¾ˆå cpu, ç”šè‡³å¯¼è‡´è€macå¡æ­»äº†&hellip; hugoçœŸçš„å¾ˆé¦™</p>
<h3 id="1-hugoä¸­å¦‚ä½•å†…åµŒhtml">1. hugoä¸­å¦‚ä½•å†…åµŒhtml</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># config.toml </span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">markup]</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="l">markup.goldmark]</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="l">markup.goldmark.renderer]</span><span class="w">
</span><span class="w">      </span><span class="l">unsafe = true</span><span class="w">
</span></code></pre></div><ul>
<li>ç„¶ååˆ°mdåšå®¢ä¸­æ·»åŠ å¦‚ä¸‹html</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">center</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;//zhangzw001.github.io/images/dockerniu.jpeg&#34;</span> <span class="na">width </span><span class="o">=</span> <span class="s">&#34;100&#34;</span> <span class="na">height </span><span class="o">=</span> <span class="s">&#34;100&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;border: 0&#34;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">font</span> <span class="na">color</span><span class="o">=</span><span class="s">&#34;blue&#34;</span> <span class="na">face</span><span class="o">=</span><span class="s">&#34;é»‘ä½“&#34;</span> <span class="na">size</span><span class="o">=</span><span class="s">5</span><span class="p">&gt;</span> è¿™ä¸ªå°±æ˜¯æ•ˆæœå›¾å’¯ <span class="p">&lt;/</span><span class="nt">font</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">center</span><span class="p">&gt;</span>
</code></pre></div><blockquote>
<p>æ•ˆæœå¦‚ä¸‹:</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> è¿™ä¸ªå°±æ˜¯æ•ˆæœå›¾å’¯ </font>
</center>
<h3 id="2-hugo-drafts">2. hugo Drafts</h3>
<blockquote>
<p>drafts è¡¨ç¤ºæ˜¯å¦buildæˆhtml</p>
</blockquote>
<pre><code>é¦–å…ˆç¼–è¾‘ archetypes/default.md ä¸­ drafts, é»˜è®¤æ˜¯true, è¡¨ç¤ºæ‰§è¡Œ hugo å‘½ä»¤æ—¶ä¸ä¼šbuild æˆhmtlæ–‡ä»¶å‘å¸ƒ
ç­‰åˆ°åšå®¢å®Œæˆä¹‹åå¯ä»¥æ‰‹å·¥ä¿®æ”¹ drafts: false 

æœ¬åœ°æµ‹è¯•å¯ä»¥æ‰‹å·¥æ‰§è¡Œ:
hugo serve --buildDrafts
</code></pre>]]></content>
		</item>
		
		<item>
			<title>ginè®°å½•è¯´æ˜</title>
			<link>https://www.ngirl.xyz/posts/57-gin%E8%AE%B0%E5%BD%95%E8%AF%B4%E6%98%8E/</link>
			<pubDate>Thu, 15 Oct 2020 14:16:49 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/57-gin%E8%AE%B0%E5%BD%95%E8%AF%B4%E6%98%8E/</guid>
			<description>ç®€å•è®°å½•ä¸€äº›ginæ¡†æ¶å­¦ä¹ é‡åˆ°çš„ä¸€äº›é—®é¢˜
 ### 1. unknown driver &#34;mysql&#34; (forgotten import?) ``` _ &#34;github.com/go-sql-driver/mysql&#34; ``` </description>
			<content type="html"><![CDATA[<p>ç®€å•è®°å½•ä¸€äº›ginæ¡†æ¶å­¦ä¹ é‡åˆ°çš„ä¸€äº›é—®é¢˜</p>
<!-- more->>



###  1. unknown driver "mysql" (forgotten import?)

```
 _ "github.com/go-sql-driver/mysql"

```
]]></content>
		</item>
		
		<item>
			<title>centos8åˆä½“éªŒ</title>
			<link>https://www.ngirl.xyz/posts/56-centos8%E5%88%9D%E4%BD%93%E9%AA%8C/</link>
			<pubDate>Fri, 25 Sep 2020 10:11:28 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/56-centos8%E5%88%9D%E4%BD%93%E9%AA%8C/</guid>
			<description>&lt;p&gt;ç®€å•è®°å½•ä¸‹ centos8çš„ä¸€äº›æ–°çš„å†…å®¹&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç®€å•è®°å½•ä¸‹ centos8çš„ä¸€äº›æ–°çš„å†…å®¹</p>
<h3 id="1-æ—¶é—´åŒæ­¥é€šè¿‡chrony-æ”¯æŒ">1. æ—¶é—´åŒæ­¥é€šè¿‡chrony æ”¯æŒ</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">dnf install -y chrony

systemctl start chronyd.service
systemctl <span class="nb">enable</span> chronyd.service

<span class="c1"># æŸ¥çœ‹æ‰€æœ‰å¯ç”¨åŒº</span>
timedatectl list-timezones

<span class="c1"># è®¾ç½®æ—¶åŒº</span>
timedatectl set-timezone Asia/Shanghai

<span class="c1"># æ‰‹åŠ¨åŒæ­¥</span>
chronyc -a makestep
</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>helméƒ¨ç½²metabaseç®€ä»‹</title>
			<link>https://www.ngirl.xyz/posts/55-helm%E9%83%A8%E7%BD%B2metabase%E7%AE%80%E4%BB%8B/</link>
			<pubDate>Wed, 16 Sep 2020 18:18:05 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/55-helm%E9%83%A8%E7%BD%B2metabase%E7%AE%80%E4%BB%8B/</guid>
			<description>helm ç®€å•éƒ¨ç½²metabase
ç‰ˆæœ¬ç»Ÿè®¡ 1. k8s: 1.15.11 2. metabase: v0.36.3 3. mysql: 5.7.24 é¦–å…ˆä»chartsæ‹‰å–æœ€æ–°çš„æ¨¡æ¿ # é¦–å…ˆsearchæŸ¥çœ‹ä¸€ä¸‹ helm search metabase NAME CHART VERSION APP VERSION DESCRIPTION stable/metabase 0.3.2 v0.27.2 The easy, open source way for everyone in your company to... # è¿™é‡Œç›´æ¥é€šè¿‡helmå®‰è£…åªæœ‰ v0.27.2çš„ç‰ˆæœ¬, æˆ‘ä»¬æƒ³è¦å®‰è£…æœ€æ–°çš„ç‰ˆæœ¬ æ‰€ä»¥è¿™é‡Œæˆ‘ä»helmå®˜æ–¹å…‹éš†äº†charts git clone https://github.com/helm/charts.git cd charts/stable/metabase # æ‹‰å–é…ç½® docker pull metabase/metabase:v0.36.3 docker tag metabase/metabase:v0.36.3 xxx.com/metabase:v0.36.3 docker push xxx.com/metabase:v0.36.3 ä¿®æ”¹values.yamlé…ç½® # è¿™é‡Œæ”¹æˆç§æœ‰é•œåƒimage:repository:xxx.com/metabase# ä¿®æ”¹æ•°æ®åº“é…ç½®database:type:mysqlhost:k8s-db-t.xxx.comport:3336dbname:metabaseusername:metabasepassword:metabase.123# ä¿®æ”¹æ—¶åŒºtimeZone:Asia/Shanghai# ä¿®æ”¹nodeportservice:name:metabasetype:NodePortexternalPort:80internalPort:3000# Used to fix NodePort when service.</description>
			<content type="html"><![CDATA[<p>helm ç®€å•éƒ¨ç½²metabase</p>
<!-- more-->
<h3 id="ç‰ˆæœ¬ç»Ÿè®¡">ç‰ˆæœ¬ç»Ÿè®¡</h3>
<pre><code>1. k8s:   1.15.11
2. metabase:  v0.36.3
3. mysql:  5.7.24
</code></pre><h3 id="é¦–å…ˆä»chartsæ‹‰å–æœ€æ–°çš„æ¨¡æ¿">é¦–å…ˆä»chartsæ‹‰å–æœ€æ–°çš„æ¨¡æ¿</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># é¦–å…ˆsearchæŸ¥çœ‹ä¸€ä¸‹</span>
helm search metabase
NAME            CHART VERSION APP VERSION DESCRIPTION
stable/metabase 0.3.2         v0.27.2     The easy, open <span class="nb">source</span> way <span class="k">for</span> everyone in your company to...

<span class="c1"># è¿™é‡Œç›´æ¥é€šè¿‡helmå®‰è£…åªæœ‰ v0.27.2çš„ç‰ˆæœ¬, æˆ‘ä»¬æƒ³è¦å®‰è£…æœ€æ–°çš„ç‰ˆæœ¬</span>
æ‰€ä»¥è¿™é‡Œæˆ‘ä»helmå®˜æ–¹å…‹éš†äº†charts
git clone https://github.com/helm/charts.git

<span class="nb">cd</span> charts/stable/metabase

<span class="c1"># æ‹‰å–é…ç½®</span>
docker pull metabase/metabase:v0.36.3
docker tag metabase/metabase:v0.36.3 xxx.com/metabase:v0.36.3
docker push xxx.com/metabase:v0.36.3
</code></pre></div><h3 id="ä¿®æ”¹valuesyamlé…ç½®">ä¿®æ”¹values.yamlé…ç½®</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># è¿™é‡Œæ”¹æˆç§æœ‰é•œåƒ</span><span class="w">
</span><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/metabase</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># ä¿®æ”¹æ•°æ®åº“é…ç½®</span><span class="w">
</span><span class="w"></span><span class="nt">database</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-db-t.xxx.com</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3336</span><span class="w">
</span><span class="w">  </span><span class="nt">dbname</span><span class="p">:</span><span class="w"> </span><span class="l">metabase</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">metabase</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">metabase.123</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># ä¿®æ”¹æ—¶åŒº</span><span class="w">
</span><span class="w"></span><span class="nt">timeZone</span><span class="p">:</span><span class="w"> </span><span class="l">Asia/Shanghai</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># ä¿®æ”¹nodeport</span><span class="w">
</span><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">metabase</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">externalPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span><span class="nt">internalPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">  </span><span class="c"># Used to fix NodePort when service.type: NodePort.</span><span class="w">
</span><span class="w">  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">33000</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># è¿™é‡Œä¹ŸåŒæ—¶å¼€å¯äº†ingress,</span><span class="w">
</span><span class="w"></span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># Used to create Ingress record (should used with service.type: ClusterIP).</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">metabase-dev.xxx.com</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># è®¾ç½®èµ„æºé™åˆ¶</span><span class="w">
</span><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">4096Mi</span><span class="w">
</span><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></code></pre></div><h3 id="k8s-db-tä¸Šéƒ¨ç½²metabase">k8s-db-tä¸Šéƒ¨ç½²metabase</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">cd</span> /data/k8s-config/helm/charts/stable/metabase

<span class="c1">## é¦–æ¬¡å®‰è£…</span>
helm install --name android-metabase-dev --namespace android .

<span class="c1">## æ›´æ–°</span>
helm upgrade android-metabase-dev --namespace android .

</code></pre></div><h3 id="éƒ¨ç½²mysql-configmap">éƒ¨ç½²mysql-configmap</h3>
<ul>
<li>k8s-android-metabase-mysql-dev-configmap.yml</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">my.cnf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    [client]
</span><span class="sd">    port = 3306
</span><span class="sd">    socket = /data/mysql.sock
</span><span class="sd">
</span><span class="sd">    [mysql]
</span><span class="sd">    no-auto-rehash
</span><span class="sd">
</span><span class="sd">    [mysqld]
</span><span class="sd">    #å…³é—­åˆå¹¶ç´¢å¼•
</span><span class="sd">    optimizer_switch=&#34;index_merge_intersection=off&#34;
</span><span class="sd">    #skip-slave-start
</span><span class="sd">    sql_mode=&#39;ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;
</span><span class="sd">
</span><span class="sd">    binlog-ignore-db=information_schema
</span><span class="sd">    binlog-ignore-db=mysql
</span><span class="sd">    binlog-ignore-db=performance_schema
</span><span class="sd">    binlog-ignore-db=test
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    user = mysql
</span><span class="sd">    port = 3306
</span><span class="sd">    basedir = /usr/local/mysql
</span><span class="sd">    datadir = /data/
</span><span class="sd">    socket = /data/mysql.sock
</span><span class="sd">    pid-file = /data/metabase.pid
</span><span class="sd">    tmpdir = /data/
</span><span class="sd">    server-id = 0
</span><span class="sd">    character-set-server = utf8
</span><span class="sd">    skip_name_resolve = 1
</span><span class="sd">    innodb_file_per_table = 1
</span><span class="sd">    explicit_defaults_for_timestamp = 0
</span><span class="sd">    read_only = 0
</span><span class="sd">
</span><span class="sd">    # buffer&amp;cache
</span><span class="sd">    table_open_cache = 100
</span><span class="sd">    table_definition_cache = 400
</span><span class="sd">    table_open_cache_instances = 64
</span><span class="sd">    sort_buffer_size = 4M
</span><span class="sd">    join_buffer_size = 4M
</span><span class="sd">    read_buffer_size = 8M
</span><span class="sd">    read_rnd_buffer_size = 4M
</span><span class="sd">
</span><span class="sd">    # thread&amp;connection
</span><span class="sd">    thread_stack = 256K
</span><span class="sd">    thread_cache_size = 768
</span><span class="sd">    back_log = 1024
</span><span class="sd">    max_connections = 3000
</span><span class="sd">    max_connect_errors = 1000000
</span><span class="sd">
</span><span class="sd">    # temptable
</span><span class="sd">    tmp_table_size = 32M
</span><span class="sd">    max_heap_table_size = 32M
</span><span class="sd">
</span><span class="sd">    # network
</span><span class="sd">    max_allowed_packet = 32M
</span><span class="sd">    #lock_wait_timeout = 3600
</span><span class="sd">    #interactive_timeout = 600
</span><span class="sd">    #wait_timeout = 600
</span><span class="sd">
</span><span class="sd">    # query cache
</span><span class="sd">    query_cache_size = 0
</span><span class="sd">    query_cache_type = 0
</span><span class="sd">
</span><span class="sd">    # è®¾ç½®errorlogã€slowlogå’Œgenerallogçš„æ—¶åŒºï¼Œé»˜è®¤UTC
</span><span class="sd">    log_timestamps = SYSTEM
</span><span class="sd">
</span><span class="sd">    # error-log
</span><span class="sd">    log_error = /data/mysqld.log
</span><span class="sd">
</span><span class="sd">    # slow-log
</span><span class="sd">    slow_query_log = 1
</span><span class="sd">    slow_query_log_file = /data/metabase_slow.log
</span><span class="sd">    long_query_time = 1
</span><span class="sd">    log_queries_not_using_indexes =1
</span><span class="sd">    log_throttle_queries_not_using_indexes = 60
</span><span class="sd">    min_examined_row_limit = 100
</span><span class="sd">    log_slow_admin_statements = 1
</span><span class="sd">    log_slow_slave_statements = 1
</span><span class="sd">
</span><span class="sd">    # general log
</span><span class="sd">    #general-log = 1
</span><span class="sd">    general_log_file=/data/query.log
</span><span class="sd">
</span><span class="sd">    # binlog
</span><span class="sd">    binlog_format = row
</span><span class="sd">    binlog_checksum = 1
</span><span class="sd">    log-bin = /data/metabase-bin
</span><span class="sd">    log-bin-index = /data/metabase-bin.index
</span><span class="sd">    sync_binlog = 0
</span><span class="sd">    binlog_cache_size = 4M
</span><span class="sd">    max_binlog_size = 512M
</span><span class="sd">    expire_logs_days = 15
</span><span class="sd">
</span><span class="sd">    # GTID
</span><span class="sd">    gtid_mode = off
</span><span class="sd">    enforce_gtid_consistency = 1
</span><span class="sd">    log_slave_updates
</span><span class="sd">
</span><span class="sd">    # Replication
</span><span class="sd">    master_info_repository = TABLE
</span><span class="sd">    relay_log_info_repository = TABLE
</span><span class="sd">    slave-rows-search-algorithms = &#39;INDEX_SCAN,HASH_SCAN&#39;
</span><span class="sd">    relay_log_recovery = 1
</span><span class="sd">    relay_log_purge = 1
</span><span class="sd">    relay-log=/data/metabase-relay-bin
</span><span class="sd">    relay-log-index=/data/metabase-relay-bin.index
</span><span class="sd">
</span><span class="sd">    # innodb-buffer&amp;cache
</span><span class="sd">    innodb_buffer_pool_size = 1G
</span><span class="sd">    innodb_buffer_pool_instances = 4
</span><span class="sd">    #innodb_additional_mem_pool_size = 16M
</span><span class="sd">    innodb_max_dirty_pages_pct = 50
</span><span class="sd">
</span><span class="sd">    # innodb log
</span><span class="sd">    innodb_data_file_path = ibdata1:512M:autoextend
</span><span class="sd">    innodb_log_file_size = 512M
</span><span class="sd">    innodb_log_files_in_group = 2
</span><span class="sd">    innodb_flush_log_at_trx_commit = 2
</span><span class="sd">    innodb_log_buffer_size = 32M
</span><span class="sd">    #innodb_max_undo_log_size = 4G
</span><span class="sd">    #innodb_undo_directory = undolog
</span><span class="sd">    innodb_undo_tablespaces = 0
</span><span class="sd">
</span><span class="sd">    # innodb-io
</span><span class="sd">    innodb_flush_method = O_DIRECT
</span><span class="sd">    innodb_io_capacity = 600
</span><span class="sd">    innodb_io_capacity_max = 2000
</span><span class="sd">    innodb_flush_sync = 0
</span><span class="sd">    innodb_flush_neighbors = 0
</span><span class="sd">    #innodb_lru_scan_depth = 4000
</span><span class="sd">    innodb_write_io_threads = 8
</span><span class="sd">    innodb_read_io_threads = 8
</span><span class="sd">    innodb_purge_threads = 4
</span><span class="sd">    innodb_page_cleaners = 4
</span><span class="sd">
</span><span class="sd">    # transaction,lock
</span><span class="sd">    #innodb_sync_spin_loops = 100
</span><span class="sd">    #innodb_spin_wait_delay = 30
</span><span class="sd">    innodb_lock_wait_timeout = 10
</span><span class="sd">    innodb_print_all_deadlocks = 1
</span><span class="sd">    innodb_rollback_on_timeout = 1
</span><span class="sd">
</span><span class="sd">    innodb_open_files = 65535
</span><span class="sd">
</span><span class="sd">    innodb_online_alter_log_max_size = 1G
</span><span class="sd">
</span><span class="sd">    # innodb status
</span><span class="sd">    innodb_status_file = 1
</span><span class="sd">    # æ³¨æ„: å¼€å¯ innodb_status_output &amp; innodb_status_output_locks å, å¯èƒ½ä¼šå¯¼è‡´log-erroræ–‡ä»¶å¢é•¿è¾ƒå¿«
</span><span class="sd">    innodb_status_output = 0
</span><span class="sd">    innodb_status_output_locks = 0
</span><span class="sd">
</span><span class="sd">    #performance_schema
</span><span class="sd">    performance_schema = 1
</span><span class="sd">    performance_schema_instrument = &#39;%=on&#39;
</span><span class="sd">
</span><span class="sd">    #innodb monitor
</span><span class="sd">    innodb_monitor_enable=&#34;module_innodb&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_server&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_dml&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_ddl&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_trx&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_os&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_purge&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_log&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_lock&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_buffer&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_index&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_ibuf_system&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_buffer_page&#34;
</span><span class="sd">    innodb_monitor_enable=&#34;module_adaptive_hash&#34;
</span><span class="sd">
</span><span class="sd">    # MyISAM
</span><span class="sd">    key_buffer_size = 4G
</span><span class="sd">    bulk_insert_buffer_size = 64M
</span><span class="sd">    myisam_sort_buffer_size = 256M
</span><span class="sd">    myisam_repair_threads = 1
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    [mysqldump]
</span><span class="sd">    quick
</span><span class="sd">    max_allowed_packet = 32M</span><span class="w">    
</span></code></pre></div><h3 id="éƒ¨ç½²mysql">éƒ¨ç½²mysql</h3>
<ul>
<li>k8s-android-metabase-mysql-dev.yml</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">         </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/mysql:5.7.24</span><span class="w">
</span><span class="w">         </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-port</span><span class="w">
</span><span class="w">         </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">           </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1000m&#34;</span><span class="w">
</span><span class="w">         </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MYSQL_ROOT_PASSWORD</span><span class="w">
</span><span class="w">           </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxx.123&#34;</span><span class="w">
</span><span class="w">         </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev-data</span><span class="w">
</span><span class="w">           </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev-conf</span><span class="w">
</span><span class="w">           </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/mysql/my.cnf</span><span class="w">
</span><span class="w">           </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">my.cnf</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev-data</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.xxx.xxx.194</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s-db-t/android-metabase-mysql-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev-conf</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-port</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">3336</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">android-metabase-mysql-dev</span><span class="w">
</span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>goå•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•</title>
			<link>https://www.ngirl.xyz/posts/54-go%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</link>
			<pubDate>Wed, 12 Aug 2020 16:44:10 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/54-go%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</guid>
			<description>&lt;p&gt;ç®€å•è®°å½•ä¸€ä¸‹å•å…ƒæµ‹è¯• å’Œæ€§èƒ½æµ‹è¯•çš„ä¾‹å­&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç®€å•è®°å½•ä¸€ä¸‹å•å…ƒæµ‹è¯• å’Œæ€§èƒ½æµ‹è¯•çš„ä¾‹å­</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="é¦–å…ˆè¿™é‡Œæœ‰ä¸‰ä¸ªæ–æ³¢é‚£å¥‘çš„å‡½æ•°-fibgo">é¦–å…ˆè¿™é‡Œæœ‰ä¸‰ä¸ªæ–æ³¢é‚£å¥‘çš„å‡½æ•° fib.go</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="nf">Fib</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span> <span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
 <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nf">Fib</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">Fib</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">Fib2</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">f</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Fib3</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">n</span><span class="p">,</span><span class="nx">m</span> <span class="kt">int</span>
 <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
   <span class="nx">n</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  <span class="nx">n</span><span class="p">,</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">n</span><span class="o">+</span><span class="nx">m</span><span class="p">,</span><span class="nx">n</span>
  <span class="k">return</span> <span class="nx">m</span>
 <span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h3 id="å…ˆåšä¸€ä¸ªå•å…ƒæµ‹è¯•-fib_testgo">å…ˆåšä¸€ä¸ªå•å…ƒæµ‹è¯• fib_test.go</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">testFib</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">144</span><span class="p">,</span><span class="mi">233</span><span class="p">,</span><span class="mi">377</span><span class="p">,</span><span class="mi">610</span><span class="p">,</span><span class="mi">987</span><span class="p">,</span><span class="mi">1597</span><span class="p">,</span><span class="mi">2584</span><span class="p">,</span><span class="mi">4181</span><span class="p">,</span><span class="mi">6765</span><span class="p">,</span><span class="mi">10946</span><span class="p">,</span><span class="mi">17711</span><span class="p">,</span><span class="mi">28657</span><span class="p">,</span><span class="mi">46368</span><span class="p">,</span><span class="mi">75025</span><span class="p">,</span><span class="mi">121393</span><span class="p">,</span><span class="mi">196418</span><span class="p">,</span><span class="mi">317811</span><span class="p">,</span><span class="mi">514229</span><span class="p">,</span><span class="mi">832040</span><span class="p">,</span><span class="mi">1346269</span><span class="p">,</span><span class="mi">2178309</span><span class="p">,</span><span class="mi">3524578</span><span class="p">,</span><span class="mi">5702887</span><span class="p">,</span><span class="mi">9227465</span><span class="p">,</span><span class="mi">14930352</span><span class="p">,</span><span class="mi">24157817</span><span class="p">,</span><span class="mi">39088169</span><span class="p">,</span><span class="mi">63245986</span><span class="p">,</span><span class="mi">102334155</span><span class="p">,</span><span class="mi">165580141</span><span class="p">,</span><span class="mi">267914296</span><span class="p">,</span><span class="mi">433494437</span><span class="p">,</span><span class="mi">701408733</span><span class="p">,</span><span class="mi">1134903170</span><span class="p">,</span><span class="mi">1836311903</span><span class="p">,</span><span class="mi">2971215073</span><span class="p">,</span><span class="mi">4807526976</span><span class="p">,</span><span class="mi">7778742049</span><span class="p">,</span><span class="mi">12586269025</span><span class="p">,</span><span class="mi">20365011074</span><span class="p">,</span><span class="mi">32951280099</span><span class="p">,</span><span class="mi">53316291173</span><span class="p">,</span><span class="mi">86267571272</span><span class="p">,</span><span class="mi">139583862445</span><span class="p">,</span><span class="mi">225851433717</span><span class="p">,</span><span class="mi">365435296162</span><span class="p">,</span><span class="mi">591286729879</span><span class="p">,</span><span class="mi">956722026041</span><span class="p">,</span><span class="mi">1548008755920</span><span class="p">,</span><span class="mi">2504730781961</span><span class="p">,</span><span class="mi">4052739537881</span><span class="p">,</span><span class="mi">6557470319842</span><span class="p">,</span><span class="mi">10610209857723</span><span class="p">,</span><span class="mi">17167680177565</span><span class="p">,</span><span class="mi">27777890035288</span><span class="p">,</span><span class="mi">44945570212853</span><span class="p">,</span><span class="mi">72723460248141</span><span class="p">,</span><span class="mi">117669030460994</span><span class="p">,</span><span class="mi">190392490709135</span><span class="p">,</span><span class="mi">308061521170129</span><span class="p">,</span><span class="mi">498454011879264</span><span class="p">,</span><span class="mi">806515533049393</span><span class="p">,</span><span class="mi">1304969544928657</span><span class="p">,</span><span class="mi">2111485077978050</span><span class="p">,</span><span class="mi">3416454622906707</span><span class="p">,</span><span class="mi">5527939700884757</span><span class="p">,</span><span class="mi">8944394323791464</span><span class="p">,</span><span class="mi">14472334024676221</span><span class="p">,</span><span class="mi">23416728348467685</span><span class="p">,</span><span class="mi">37889062373143906</span><span class="p">,</span><span class="mi">61305790721611591</span><span class="p">,</span><span class="mi">99194853094755497</span><span class="p">,</span><span class="mi">160500643816367088</span><span class="p">,</span><span class="mi">259695496911122585</span><span class="p">,</span><span class="mi">420196140727489673</span><span class="p">,</span><span class="mi">679891637638612258</span><span class="p">,</span><span class="mi">1100087778366101931</span><span class="p">,</span><span class="mi">1779979416004714189</span><span class="p">}</span>


<span class="kd">func</span> <span class="nf">TestFib</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">40</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Fib</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span> <span class="nx">f</span> <span class="o">!=</span> <span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
   <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Fib(%d) returned %d, want %d \n&#34;</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">f</span><span class="p">,</span><span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestFib2</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">40</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Fib2</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span> <span class="nx">f</span> <span class="o">!=</span> <span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
   <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Fib2(%d) returned %d, want %d \n&#34;</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">f</span><span class="p">,</span><span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestFib3</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">f3</span> <span class="o">:=</span> <span class="nf">Fib3</span><span class="p">()</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">40</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nf">f3</span><span class="p">();</span> <span class="nx">f</span> <span class="o">!=</span> <span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
   <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Fib3(%d) returned %d, want %d \n&#34;</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">f</span><span class="p">,</span><span class="nx">testFib</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>å‘½ä»¤è¡Œæ‰§è¡Œ</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">v</span>
<span class="o">==</span><span class="p">=</span> <span class="nx">RUN</span>   <span class="nx">TestFib</span>
<span class="o">---</span> <span class="nx">PASS</span><span class="p">:</span> <span class="nf">TestFib</span> <span class="p">(</span><span class="mf">1.34</span><span class="nx">s</span><span class="p">)</span>
<span class="o">==</span><span class="p">=</span> <span class="nx">RUN</span>   <span class="nx">TestFib2</span>
<span class="o">---</span> <span class="nx">PASS</span><span class="p">:</span> <span class="nf">TestFib2</span> <span class="p">(</span><span class="mf">0.00</span><span class="nx">s</span><span class="p">)</span>
<span class="o">==</span><span class="p">=</span> <span class="nx">RUN</span>   <span class="nx">TestFib3</span>
<span class="o">---</span> <span class="nx">PASS</span><span class="p">:</span> <span class="nf">TestFib3</span> <span class="p">(</span><span class="mf">0.00</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">PASS</span>
<span class="nx">ok</span>
</code></pre></div><h3 id="ç„¶åæ€§èƒ½æµ‹è¯•-fib_testgo">ç„¶åæ€§èƒ½æµ‹è¯• fib_test.go</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">BenchmarkFib</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">30</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
   <span class="nf">Fib</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkFib2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">90</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
   <span class="nf">Fib2</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkFib3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">f3</span> <span class="o">:=</span> <span class="nf">Fib3</span><span class="p">()</span>
 <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">90</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
   <span class="nf">f3</span><span class="p">()</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>

</code></pre></div><blockquote>
<p>å‘½ä»¤è¡Œæ‰§è¡Œ</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"> go <span class="nb">test</span> -bench<span class="o">=</span>.
goos: darwin
goarch: amd64
pkg: xxx
BenchmarkFib-4          <span class="m">100</span>   <span class="m">10504036</span> ns/op
BenchmarkFib2-4      <span class="m">128184</span>       <span class="m">8989</span> ns/op
BenchmarkFib3-4     <span class="m">3908799</span>        <span class="m">307</span> ns/op
PASS
ok
</code></pre></div><h3 id="gomodä½¿ç”¨è¯´æ˜">go.modä½¿ç”¨è¯´æ˜</h3>
<blockquote>
<p>ç›®å½•ç»“æ„</p>
</blockquote>
<pre><code>â”œâ”€â”€ fib
â”‚Â Â  â”œâ”€â”€ fib.go
â”‚Â Â  â””â”€â”€ fib_test.go
â”œâ”€â”€ main.go
â””â”€â”€ go.mod
</code></pre><blockquote>
<p>main.go</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;fib&#34;</span>
 <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span><span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span><span class="p">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d,&#34;</span><span class="p">,</span><span class="nx">fib</span><span class="p">.</span><span class="nf">Fib</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
 <span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span><span class="mi">1</span> <span class="p">;</span> <span class="nx">i</span><span class="p">&lt;</span> <span class="mi">90</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d,&#34;</span><span class="p">,</span><span class="nx">fib</span><span class="p">.</span><span class="nf">Fib2</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
 <span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
 <span class="nx">f3</span> <span class="o">:=</span> <span class="nx">fib</span><span class="p">.</span><span class="nf">Fib3</span><span class="p">()</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span><span class="mi">1</span> <span class="p">;</span> <span class="nx">i</span><span class="p">&lt;</span> <span class="mi">90</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d,&#34;</span><span class="p">,</span><span class="nf">f3</span><span class="p">())</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<pre><code>1. goç‰ˆæœ¬æœ€å¥½æ˜¯1.13 (go1.11å¼€å§‹æ”¯æŒ)
2. é¦–å…ˆ go mod init , å¹¶ä¿®æ”¹go.mod
    å¢åŠ : replace fib =&gt; ./fib
3. ç„¶åè¿›å»åˆ°fibç›®å½•, æ‰§è¡Œgo mod init
4. åœ¨æ‰§è¡Œmain.go å³å¯

</code></pre><h3 id="è¯´æ˜">è¯´æ˜</h3>
<pre><code>1. æµ‹è¯•å‡½æ•°å¿…é¡»å¯¼å…¥testingåŒ…
2. æµ‹è¯•å‡½æ•°çš„åå­—å¿…é¡»ä»¥Testå¼€å¤´ï¼Œå¯é€‰çš„åç¼€åå¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼š
</code></pre><h3 id="ä¸€äº›å¸¸ç”¨å‘½ä»¤">ä¸€äº›å¸¸ç”¨å‘½ä»¤</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="mf">1.</span> <span class="k">go</span> <span class="nx">test</span> 	<span class="c1">// è¿”å›æ­£ç¡® æˆ–è€…è¿”å›é”™è¯¯è¯¦æƒ…
</span><span class="c1"></span><span class="mf">2.</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">v</span> 	<span class="c1">// è¿”å›è¯¦æƒ…,åŒ…æ‹¬æ­£ç¡®çš„æµ‹è¯•æ¡ˆä¾‹
</span><span class="c1"></span><span class="mf">3.</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">v</span> <span class="o">-</span><span class="nx">run</span><span class="p">=</span><span class="s">&#34;French|Can.*l&#34;</span>	<span class="c1">// æ‰§è¡ŒæŒ‡å®šçš„æµ‹è¯•æ¡ˆä¾‹(å‚æ•°-runå¯¹åº”ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼)
</span><span class="c1"></span><span class="mf">4.</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">run</span><span class="p">=</span><span class="nx">Fib</span> <span class="o">-</span><span class="nx">coverprofile</span><span class="p">=</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">.</span> <span class="c1">//ç”Ÿæˆc.out
</span><span class="c1"></span><span class="mf">5.</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">cover</span> <span class="o">-</span><span class="nx">html</span><span class="p">=</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="c1">//å°†c.outè½¬æˆhtmlæ ¼å¼æ‰“å¼€
</span><span class="c1"></span><span class="mf">6.</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">bench</span><span class="p">=</span><span class="nx">Fib</span> <span class="o">-</span><span class="nx">benchmem</span> <span class="c1">// åŸºå‡†æµ‹è¯• æ˜¾ç¤ºå†…å­˜å’Œå†…å­˜åˆ†é…æ¬¡æ•°
</span><span class="c1"></span><span class="mf">7.</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">bench</span> <span class="p">.</span> <span class="o">-</span><span class="nx">cpuprofile</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">out</span>	<span class="c1">// ç”Ÿæˆcpu.out
</span><span class="c1"></span><span class="mf">8.</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">pprof</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">out</span>   
   <span class="c1">// ç„¶åäº¤äº’å¼è¾“å…¥webæŸ¥çœ‹å›¾å½¢ç•Œé¢(ä½†æ˜¯éœ€è¦å®‰è£…brew install graphviz )
</span><span class="c1"></span>   <span class="c1">// æˆ–è€…äº¤äº’å¼è¾“å…¥png,ä¼šå¾—åˆ°ç±»å‹profile001.pngçš„æ–‡ä»¶, æ‰“å¼€æŸ¥çœ‹å³å¯
</span><span class="c1"></span><span class="mf">9.</span> <span class="k">go</span> <span class="nx">run</span> <span class="o">-</span><span class="nx">race</span> <span class="nx">a</span><span class="p">.</span><span class="k">go</span> <span class="c1">// æŸ¥çœ‹æ˜¯å¦å­˜åœ¨é”
</span><span class="c1"></span><span class="mf">10.</span>  <span class="nx">godoc</span> <span class="o">-</span><span class="nx">http</span> <span class="p">:</span><span class="mi">8000</span> <span class="c1">//å¯åŠ¨ä¸€ä¸ªgodoc
</span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>hexoéƒ¨ç½²åˆ°coding.netå¼€å¯é™æ€ç½‘ç«™</title>
			<link>https://www.ngirl.xyz/posts/53-hexo%E9%83%A8%E7%BD%B2%E5%88%B0coding-net%E5%BC%80%E5%90%AF%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/</link>
			<pubDate>Fri, 07 Aug 2020 16:00:08 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/53-hexo%E9%83%A8%E7%BD%B2%E5%88%B0coding-net%E5%BC%80%E5%90%AF%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/</guid>
			<description>&lt;p&gt;ç”±äºè®¿é—®githubä¼šæ¯”è¾ƒæ…¢,ç™¾åº¦æŠ“å–é—®é¢˜ç­‰, hexoåŒæ—¶éƒ¨ç½²åˆ°coding.netå¹¶å¼€å¯é™æ€ç½‘ç«™&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç”±äºè®¿é—®githubä¼šæ¯”è¾ƒæ…¢,ç™¾åº¦æŠ“å–é—®é¢˜ç­‰, hexoåŒæ—¶éƒ¨ç½²åˆ°coding.netå¹¶å¼€å¯é™æ€ç½‘ç«™</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="é¦–å…ˆå¾—æœ‰codingnet-ç½‘ç«™çš„è´¦æˆ·å¹¶é…ç½®è‡ªå·±çš„å…¬é’¥">é¦–å…ˆå¾—æœ‰coding.net ç½‘ç«™çš„è´¦æˆ·,å¹¶é…ç½®è‡ªå·±çš„å…¬é’¥</h3>
<blockquote>
<p>å³ä¸Šè§’ç‚¹å‡» ä¸ªäººè´¦æˆ·è®¾ç½® -&gt; SSHå…¬é’¥</p>
</blockquote>
<h3 id="åˆ›å»ºå¥½é¡¹ç›®ä¹‹å-ä¿®æ”¹hexoçš„_configyml">åˆ›å»ºå¥½é¡¹ç›®ä¹‹å, ä¿®æ”¹hexoçš„_config.yml</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">git</span><span class="w">
</span><span class="w"></span><span class="c">#  repository: git@github.com:zhangzw001/zhangzw001.github.io.git</span><span class="w">
</span><span class="w">  </span><span class="nt">repo</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">github</span><span class="p">:</span><span class="w"> </span><span class="l">git@github.com:zhangzw001/zhangzw001.github.io.git</span><span class="w">
</span><span class="w">    </span><span class="nt">coding</span><span class="p">:</span><span class="w"> </span><span class="l">git@e.coding.net:k1s/blog/blog.git</span><span class="w">
</span><span class="w">  </span><span class="nt">branch</span><span class="p">:</span><span class="w"> </span><span class="l">master</span><span class="w">
</span></code></pre></div><h3 id="å¼€å¯-é™æ€ç½‘ç«™-éƒ¨ç½²åŠŸèƒ½">å¼€å¯ é™æ€ç½‘ç«™ éƒ¨ç½²åŠŸèƒ½</h3>
<blockquote>
<p>ç‚¹å‡»é¡¹ç›®è¿›å» -&gt; å·¦ä¸‹è§’é¡¹ç›®è®¾ç½® -&gt; åŠŸèƒ½å¼€å…³ -&gt; æŒç»­éƒ¨ç½²
<img src="//zhangzw001.github.io/images/53/img1.jpg" alt=""></p>
</blockquote>
<blockquote>
<p>å›åˆ°é¡¹ç›® æŒç»­éƒ¨ç½² -&gt; é™æ€ç½‘ç«™</p>
</blockquote>
<p><img src="//zhangzw001.github.io/images/53/img2.jpg" alt=""></p>
<h3 id="ç°åœ¨å°†è‡ªå·±çš„åŸŸåç»‘å®šåˆ°è¯¥é¡¹ç›®">ç°åœ¨å°†è‡ªå·±çš„åŸŸåç»‘å®šåˆ°è¯¥é¡¹ç›®</h3>
<blockquote>
<p>ç‚¹å‡» è®¾ç½®</p>
</blockquote>
<p><img src="//zhangzw001.github.io/images/53/img3.jpg" alt=""></p>
<blockquote>
<p>æ³¨æ„ç»‘å®šåŸŸåå‰, å…ˆå»dnsæ·»åŠ ä¸€æ¡cnameè®°å½•(è®°å½•å€¼ä¸ºä½ çš„coding-pages.com)</p>
</blockquote>
<p><img src="//zhangzw001.github.io/images/53/img4.jpg" alt=""></p>]]></content>
		</item>
		
		<item>
			<title>istioç¯å¢ƒä¸‹é…ç½®nginx&#43;php</title>
			<link>https://www.ngirl.xyz/posts/52-istio%E6%B5%8B%E8%AF%95nginx-php%E9%A1%B9%E7%9B%AE/</link>
			<pubDate>Tue, 04 Aug 2020 16:22:10 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/52-istio%E6%B5%8B%E8%AF%95nginx-php%E9%A1%B9%E7%9B%AE/</guid>
			<description>&lt;p&gt;å°†nginx+phpçš„ç¯å¢ƒç»“åˆistioçš„æ™ºèƒ½è·¯ç”±åŠŸèƒ½åšä¸€ä¸ªç®€å•å®è·µ&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>å°†nginx+phpçš„ç¯å¢ƒç»“åˆistioçš„æ™ºèƒ½è·¯ç”±åŠŸèƒ½åšä¸€ä¸ªç®€å•å®è·µ</p>
<ul>
<li><a href="https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/">istioä¸­æ–‡å®˜æ–¹-åè®®é€‰æ‹©</a></li>
<li><a href="https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/">istioä¸­æ–‡å®˜æ–¹-virtualService</a></li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<blockquote>
<p>å®‰è£…éƒ¨ç½²è¯·å‚è€ƒå®˜æ–¹ <a href="https://istio.io/latest/zh/docs/setup/getting-started/">https://istio.io/latest/zh/docs/setup/getting-started/</a></p>
</blockquote>
<h3 id="ä¸€-éƒ¨ç½²nginxphpå¹¶è®¾ç½®ç®€å•æ™ºèƒ½è·¯ç”±">ä¸€ éƒ¨ç½²nginx+php,å¹¶è®¾ç½®ç®€å•æ™ºèƒ½è·¯ç”±</h3>
<blockquote>
<p>ç¯å¢ƒè¯´æ˜</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">1. k8s:     1.15.11
2. istio:   1.6.7
3. istio-alpha nsè®¾ç½®äº†è‡ªåŠ¨æ³¨å…¥:
    kubectl label namespace istio-alpha istio-injection<span class="o">=</span>enabled
    kubectl get namespaces istio-alpha --show-labels
</code></pre></div><h4 id="11-å®‰è£…éƒ¨ç½²php-fpm">1.1 å®‰è£…éƒ¨ç½²php-fpm</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v1</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/bq/php:7.0.13-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v1-data</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v1-data</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">x.x.x.x</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data        </span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v2</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/bq/php:7.0.13-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v2-data</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v2-data</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">x.x.x.x</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span></code></pre></div><h4 id="12-å®‰è£…éƒ¨ç½²nginx">1.2 å®‰è£…éƒ¨ç½²nginx</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/bq/nginx:1.16</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/nginx/conf.d/</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">x.x.x.x</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1-cm</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1-cm</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v1</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        server {
</span><span class="sd">                listen 80 default_server;
</span><span class="sd">                server_name  _;
</span><span class="sd">                root   /webwww/test-v1;
</span><span class="sd">                add_header &#34;X&#34; &#34;v1&#34;;
</span><span class="sd">                location = /50x.html {
</span><span class="sd">                    root   html;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">               location / {
</span><span class="sd">                    index index.php  index.html index.htm;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">                location ~ \.php$ {
</span><span class="sd">                    fastcgi_pass   php-fpm:9000;
</span><span class="sd">                    fastcgi_index  index.php;
</span><span class="sd">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
</span><span class="sd">                    fastcgi_param  HTTP_HOST          $server_name;
</span><span class="sd">                    include        fastcgi_params;
</span><span class="sd">                }
</span><span class="sd">        }</span><span class="w">        
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/bq/nginx:1.16</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/nginx/conf.d/</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">x.x.x.x</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/php-fpm-7-0-13/webwww-data</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2-cm</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2-cm</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-v2</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        server {
</span><span class="sd">         listen 80 default_server;
</span><span class="sd">                server_name  _;
</span><span class="sd">                root   /webwww/test-v2;
</span><span class="sd">                add_header &#34;X&#34; &#34;v2&#34;;
</span><span class="sd">                location = /50x.html {
</span><span class="sd">                    root   html;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">               location / {
</span><span class="sd">                    index index.php  index.html index.htm;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">                location ~ \.php$ {
</span><span class="sd">                    fastcgi_pass   php-fpm:9000;
</span><span class="sd">                    fastcgi_index  index.php;
</span><span class="sd">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
</span><span class="sd">                    fastcgi_param  HTTP_HOST          $server_name;
</span><span class="sd">                    include        fastcgi_params;
</span><span class="sd">                }
</span><span class="sd">        }</span><span class="w">        
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></div><h4 id="13-é…ç½®é»˜è®¤destinationrule">1.3 é…ç½®é»˜è®¤destinationRule</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DestinationRule</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DestinationRule</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span></code></pre></div><h4 id="14-é…ç½®nginxçš„gatewayå’Œvirtualservice">1.4 é…ç½®nginxçš„gatewayå’ŒVirtualService</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">istio</span><span class="p">:</span><span class="w"> </span><span class="l">ingressgateway</span><span class="w"> </span><span class="c"># use istio default controller</span><span class="w">
</span><span class="w">  </span><span class="nt">servers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-80</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">/phpinfo.php</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">90</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></code></pre></div><blockquote>
<p>ä»¥ä¸Šé…ç½®ä¹‹åå³å¯åœ¨kialiæŸ¥çœ‹ graph</p>
</blockquote>
<p><img src="//zhangzw001.github.io/images/52/img-all.png" alt=""></p>
<h4 id="15-ç®€å•é…ç½®æµé‡å…¨éƒ¨åˆ‡åˆ°v1-æˆ–v2">1.5 ç®€å•é…ç½®æµé‡å…¨éƒ¨åˆ‡åˆ°v1 æˆ–v2</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">/phpinfo.php</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span></code></pre></div><blockquote>
<p>å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®uri matché€‰æ‹©ä¸åŒçš„è·¯ç”±</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">nginx-gateway</span><span class="w">
</span><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">/phpinfo.php</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">/a.php</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></code></pre></div><h4 id="16-é…ç½®php-fpmçš„virtualservice">1.6 é…ç½®php-fpmçš„virtualService</h4>
<blockquote>
<p>å°†æµé‡å…¨éƒ¨è½¬åˆ° v1ç‰ˆæœ¬</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></code></pre></div><blockquote>
<p>å°†æµé‡åˆ†æˆ1:9</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">90</span><span class="w">
</span></code></pre></div><p><img src="//zhangzw001.github.io/images/52/img-fpm-1-9.png" alt=""></p>
<p><img src="//zhangzw001.github.io/images/52/img-all2.jpg" alt=""></p>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="-é—®é¢˜è¯´æ˜">$ é—®é¢˜è¯´æ˜</h3>
<h4 id="1-åè®®é€‰æ‹©è¯´æ˜">$.1 åè®®é€‰æ‹©è¯´æ˜</h4>
<blockquote>
<p>é€šè¿‡å£°æ˜ä¸€ä¸ª Service ç«¯å£ï¼Œåè®®å¯ä»¥è¢«æ‰‹åŠ¨æŒ‡å®š <code>name: &lt;protocol&gt;[-&lt;suffix&gt;]</code>ã€‚ ä¸‹åˆ—åè®®æ˜¯è¢«æ”¯æŒçš„ï¼š</p>
</blockquote>
<pre><code>grpc
grpc-web
http
http2
https
mongo
mysql*
redis*
tcp
tls
udp
</code></pre><blockquote>
<p>å› æ­¤æ³¨æ„,æˆ‘ä»¬åœ¨éƒ¨ç½²deploymentå’Œserviceçš„æ—¶å€™, ports.name ä¼šè¢«istio è®¤ä¸ºæ˜¯åè®®</p>
</blockquote>
<blockquote>
<p>ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­, name: tcp, å¦‚æœé…ç½®äº†å…¶ä»–çš„å€¼, ä¼šå¯¼è‡´nginx-&gt;php-fpm åè®®å¼‚å¸¸, å¯èƒ½ä¼šå‡ºç°é”™è¯¯:</p>
</blockquote>
<p><code>upstream sent unsupported FastCGI protocol version: 72 while reading response header from upstream</code></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm-v1</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">php:7.0.13-fpm</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">          </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-alpha</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">php-fpm</span><span class="w">
</span></code></pre></div><hr>]]></content>
		</item>
		
		<item>
			<title>k8sæ­å»ºradius</title>
			<link>https://www.ngirl.xyz/posts/51-k8s%E6%90%AD%E5%BB%BAradius/</link>
			<pubDate>Mon, 27 Jul 2020 10:19:25 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/51-k8s%E6%90%AD%E5%BB%BAradius/</guid>
			<description>æ­å»ºlnmp+freeradiusçš„è´¦å·è®¤è¯æœåŠ¡
  ä¸€ è®°å½• docker: 17.03.2-ce k8s: 1.15.11 php: 7.0.13 mysql: 5.6 freeraidus: 3.0.21 daloradius: 1.1-2 / 08 Aug 2019  é…ç½®ä¿®æ”¹ç®€å•è¯´æ˜:
 1. æ•°æ®åº“åˆ›å»ºè¯´æ˜ create database radius; grant all on radius.* to radius@&#39;%&#39; identified by &#39;xxx&#39;; flush privileges; # å¯¼å…¥è¡¨ç»“æ„ mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &amp;lt; mods-config/sql/main/mysql/schema.sql mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &amp;lt; daloradius-php/contrib/db/mysql-daloradius.sql mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &amp;lt; daloradius-php/contrib/db/fr2-mysql-daloradius-and-freeradius.sql 2. ä¿®æ”¹freeRADIUSé…ç½® vim /etc/raddb/radiusd.conf # è¿™é‡Œæˆ‘æ˜¯é…åˆnginx,phpç»Ÿä¸€è·¯å¾„ logdir = /nginx_logs 3.</description>
			<content type="html"><![CDATA[<p>æ­å»ºlnmp+freeradiusçš„è´¦å·è®¤è¯æœåŠ¡</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ä¸€-è®°å½•">ä¸€ è®°å½•</h3>
<pre><code>docker:   17.03.2-ce
k8s:   1.15.11
php:   7.0.13
mysql:   5.6
freeraidus:  3.0.21
daloradius:  1.1-2 / 08 Aug 2019

</code></pre><blockquote>
<p>é…ç½®ä¿®æ”¹ç®€å•è¯´æ˜:</p>
</blockquote>
<pre><code>1. æ•°æ®åº“åˆ›å»ºè¯´æ˜
create database radius;
grant all on radius.* to radius@'%' identified by 'xxx';
flush privileges;

# å¯¼å…¥è¡¨ç»“æ„
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sql
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/mysql-daloradius.sql
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/fr2-mysql-daloradius-and-freeradius.sql

2. ä¿®æ”¹freeRADIUSé…ç½®
vim /etc/raddb/radiusd.conf
# è¿™é‡Œæˆ‘æ˜¯é…åˆnginx,phpç»Ÿä¸€è·¯å¾„
logdir = /nginx_logs 

3. ä¿®æ”¹ä¸ºsqlè®¤è¯
 cd /etc/raddb/mods-enabled
 ln -s ../mods-available/sql

4. ä¿®æ”¹FreeRADIUSä¸­çš„mysql é…ç½®æ–‡ä»¶
 dialect = &quot;mysql&quot;
 //ä¸‹åˆ—é…ç½®å‰çš„æ³¨é‡Šå»æ‰
 server = &quot;k8s-db-t.xxx.com&quot; //mysqlæœåŠ¡å™¨åœ°å€,å¦‚æœæ˜¯åŒä¸€ä¸ªk8sé›†ç¾¤, å†™k8så†…ç½‘çš„svcåŸŸåå³å¯,ä¾‹å¦‚: freeradius-mysql-dev æˆ– freeradius-mysql-dev.radius-dev.svc.cluster.local
 port = 3326 //mysql ç«¯å£å·
 login = &quot;radius&quot; //myqsl ç™»å½•ç”¨æˆ·å
 password = &quot;xxx&quot; //mysql ç™»å½•å¯†ç 
 read_clients = yes

5. å¼€æ”¾daloradiusæœåŠ¡å™¨éªŒè¯æƒé™
vim /etc/raddb/clients.conf
client php-fpm {
 ipaddr = php-fpm
 secret  = testing123
}

6. ä¿®æ”¹daloradiusé»˜è®¤phpé…ç½®
vim daloradius-php/library/daloradius.conf.php
$configValues['CONFIG_MAINT_TEST_USER_RADIUSSERVER'] = 'radius';
$configValues['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'testing123';
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="äºŒ-é¦–å…ˆæ­å»ºæ•°æ®åº“">äºŒ é¦–å…ˆæ­å»ºæ•°æ®åº“</h3>
<h4 id="k8s-freeradius-mysql-dev_5636-configmapyml">k8s-freeradius-mysql-dev_5.6.36-configmap.yml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">my.cnf</span><span class="p">:</span><span class="w"> </span><span class="l">|</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="l">mysqld]</span><span class="w">
</span><span class="w">    </span><span class="l">innodb_file_per_table=1</span><span class="w">
</span><span class="w">    </span><span class="l">user=mysql</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">datadir=/data</span><span class="w">
</span><span class="w">    </span><span class="l">socket=/data/mysql.sock</span><span class="w">
</span><span class="w">    </span><span class="l">symbolic-links=0</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">binlog_format=mixed</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c">#log-bin=mysql-bin</span><span class="w">
</span><span class="w">    </span><span class="l">log-bin=/data/mysql-bin.log</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c">#general_log   = 1</span><span class="w">
</span><span class="w">    </span><span class="c">#general_log_file = /data/general.log</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c">#æ—¥å¿—</span><span class="w">
</span><span class="w">    </span><span class="l">log-error=/data/mysqld.log</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">innodb_log_file_size = 256M</span><span class="w">
</span><span class="w">    </span><span class="l">thread_cache_size = 50</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">max_allowed_packet=16M</span><span class="w">
</span><span class="w">    </span><span class="l">max_binlog_size=500M</span><span class="w">
</span><span class="w">    </span><span class="c">#old_passwords=1</span><span class="w">
</span><span class="w">    </span><span class="l">character-set-server=utf8</span><span class="w">
</span><span class="w">    </span><span class="l">max_connections=3000</span><span class="w">
</span><span class="w">    </span><span class="l">skip-name-resolve</span><span class="w">
</span><span class="w">    </span><span class="l">max_allowed_packet=64M</span><span class="w">
</span><span class="w">    </span><span class="l">tmp_table_size=200M</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">server-id=101</span><span class="w">
</span><span class="w">    </span><span class="l">port=3306</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">skip_slave_start</span><span class="w">
</span><span class="w">    </span><span class="l">expire_logs_days=7</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="l">mysqld_safe]</span><span class="w">
</span><span class="w">    </span><span class="l">log-error=/data/mysqld.log</span><span class="w">
</span><span class="w">    </span><span class="l">pid-file=/data/mysqld.pid</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="l">mysql]</span><span class="w">
</span><span class="w">    </span><span class="kc">no</span>-<span class="l">auto-rehash</span><span class="w">
</span><span class="w">    </span><span class="l">user=root</span><span class="w">
</span><span class="w">    </span><span class="l">default-character-set=utf8</span><span class="w">
</span><span class="w">    </span><span class="l">socket=/data/mysql.sock</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="l">client]</span><span class="w">
</span><span class="w">    </span><span class="l">socket=/data/mysql.sock</span><span class="w">
</span></code></pre></div><h4 id="k8s-freeradius-mysql-dev_5636yml">k8s-freeradius-mysql-dev_5.6.36.yml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">         </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/mysql:5.6.36-Asia</span><span class="w">
</span><span class="w">         </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-port</span><span class="w">
</span><span class="w">         </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">           </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">         </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MYSQL_ROOT_PASSWORD</span><span class="w">
</span><span class="w">           </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxx&#34;</span><span class="w">
</span><span class="w">         </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev-data</span><span class="w">
</span><span class="w">           </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev-conf</span><span class="w">
</span><span class="w">           </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/mysql/my.cnf</span><span class="w">
</span><span class="w">           </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">my.cnf</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev-data</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.xxx.xxx.194</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s-db-t/freeradius-mysql-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev-conf</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-port</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">3326</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-mysql-dev</span><span class="w">
</span></code></pre></div><h4 id="åˆ›å»ºåº“å’Œè´¦å·">åˆ›å»ºåº“å’Œè´¦å·</h4>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">create database radius<span class="p">;</span>
grant all on radius.* to radius@<span class="s1">&#39;%&#39;</span> identified by <span class="s1">&#39;xxxxxxxxxxxxxxxxxx&#39;</span><span class="p">;</span>
flush privileges<span class="p">;</span>

<span class="c1"># æµ‹è¯•ç™»å½•</span>
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p
<span class="c1"># å¯¼å…¥è¡¨ç»“æ„</span>
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; mods-config/sql/main/mysql/schema.sql
mysql -hk8s-db-t.xxx.com -P3326 -uradius -p &lt; daloradius-php/contrib/db/mysql-daloradius.sql
</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ä¸‰-éƒ¨ç½²freeradius">ä¸‰ éƒ¨ç½²freeradius</h3>
<h4 id="deployment-freeradiusyml">deployment-freeradius.yml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/freeradius-server:3.0.21</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">1812</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1812</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">1813</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1813</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-sql-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/raddb/mods-available/sql</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">sql</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-sql-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/raddb/mods-enabled/sql</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">sql</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-radiusd-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/raddb/radiusd.conf</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">radiusd.conf</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-clients-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/raddb/clients.conf</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">clients.conf</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-log</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/nginx_logs</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-sql-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-sql-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-radiusd-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-radiusd-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-clients-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-clients-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-log</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.xxx.xxx.194</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/daloradius-php/nginx_logs</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1812</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1812</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1813</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1813</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev-svc</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1812</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1812</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">1812</span><span class="w">
</span><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">1812</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">port-1813</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1813</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">1813</span><span class="w">
</span><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">1813</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">freeradius-dev</span><span class="w">
</span></code></pre></div><h4 id="configmap-freeradius-radiusd-confyaml">configmap-freeradius-radiusd-conf.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-radiusd-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-radiusd-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">radiusd.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    prefix = /usr
</span><span class="sd">    exec_prefix = /usr
</span><span class="sd">    sysconfdir = /etc
</span><span class="sd">    localstatedir = /var
</span><span class="sd">    sbindir = ${exec_prefix}/sbin
</span><span class="sd">    logdir = /nginx_logs
</span><span class="sd">    raddbdir = /etc/freeradius
</span><span class="sd">    radacctdir = ${logdir}/radacct
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    name = freeradius
</span><span class="sd">    confdir = ${raddbdir}
</span><span class="sd">    modconfdir = ${confdir}/mods-config
</span><span class="sd">    certdir = ${confdir}/certs
</span><span class="sd">    cadir   = ${confdir}/certs
</span><span class="sd">    run_dir = ${localstatedir}/run/${name}
</span><span class="sd">
</span><span class="sd">    # Should likely be ${localstatedir}/lib/radiusd
</span><span class="sd">    db_dir = ${raddbdir}
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    libdir = /usr/lib/freeradius
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    pidfile = ${run_dir}/${name}.pid
</span><span class="sd">
</span><span class="sd">    correct_escapes = true
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    max_request_time = 30
</span><span class="sd">
</span><span class="sd">    cleanup_delay = 5
</span><span class="sd">
</span><span class="sd">    max_requests = 16384
</span><span class="sd">
</span><span class="sd">    hostname_lookups = no
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    log {
</span><span class="sd">
</span><span class="sd">     destination = files
</span><span class="sd">
</span><span class="sd">     colourise = yes
</span><span class="sd">
</span><span class="sd">     file = ${logdir}/radius.log
</span><span class="sd">
</span><span class="sd">     syslog_facility = daemon
</span><span class="sd">
</span><span class="sd">     stripped_names = no
</span><span class="sd">
</span><span class="sd">     auth = yes
</span><span class="sd">
</span><span class="sd">     # auth_accept = no
</span><span class="sd">     # auth_reject = no
</span><span class="sd">     auth_badpass = yes
</span><span class="sd">     auth_goodpass = yes
</span><span class="sd">     msg_denied = &#34;You are already logged in - access denied&#34;
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">    checkrad = ${sbindir}/checkrad
</span><span class="sd">
</span><span class="sd">    ENV {
</span><span class="sd">
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    security {
</span><span class="sd">
</span><span class="sd">     user = freerad
</span><span class="sd">     group = freerad
</span><span class="sd">
</span><span class="sd">     allow_core_dumps = no
</span><span class="sd">
</span><span class="sd">     max_attributes = 200
</span><span class="sd">
</span><span class="sd">     reject_delay = 1
</span><span class="sd">
</span><span class="sd">     status_server = yes
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">    proxy_requests  = yes
</span><span class="sd">    $INCLUDE proxy.conf
</span><span class="sd">
</span><span class="sd">    $INCLUDE clients.conf
</span><span class="sd">
</span><span class="sd">    thread pool {
</span><span class="sd">
</span><span class="sd">     start_servers = 5
</span><span class="sd">
</span><span class="sd">     max_servers = 32
</span><span class="sd">
</span><span class="sd">     min_spare_servers = 3
</span><span class="sd">     max_spare_servers = 10
</span><span class="sd">
</span><span class="sd">     max_requests_per_server = 0
</span><span class="sd">
</span><span class="sd">     auto_limit_acct = no
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">    modules {
</span><span class="sd">
</span><span class="sd">     $INCLUDE mods-enabled/
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    instantiate {
</span><span class="sd">
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    policy {
</span><span class="sd">     $INCLUDE policy.d/
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">    $INCLUDE sites-enabled/</span><span class="w">    
</span><span class="w">
</span><span class="w">
</span></code></pre></div><h4 id="configmap-freeradius-clients-confyaml">configmap-freeradius-clients-conf.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-clients-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-freeradius-clients-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">clients.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    client php-fpm {
</span><span class="sd">     ipaddr = php-fpm
</span><span class="sd">     secret  = testing123
</span><span class="sd">    }
</span><span class="sd">    client localhost {
</span><span class="sd">     ipaddr = 127.0.0.1
</span><span class="sd">     proto = *
</span><span class="sd">     secret = testing123
</span><span class="sd">     require_message_authenticator = no
</span><span class="sd">     nas_type  = other # localhost isn&#39;t usually a NAS...
</span><span class="sd">     limit {
</span><span class="sd">      max_connections = 16
</span><span class="sd">      lifetime = 0
</span><span class="sd">      idle_timeout = 30
</span><span class="sd">     }
</span><span class="sd">    }
</span><span class="sd">    client localhost_ipv6 {
</span><span class="sd">     ipv6addr = ::1
</span><span class="sd">     secret  = testing123
</span><span class="sd">    }</span><span class="w">    
</span></code></pre></div><h4 id="configmap-freeradius-sqlyaml">configmap-freeradius-sql.yaml</h4>
<blockquote>
<p>ä¸»è¦æ˜¯ä¿®æ”¹ Connection info çš„å†…å®¹</p>
</blockquote>
<pre><code>---
kind: ConfigMap
metadata:
  name: daloradius-freeradius-sql-dev
  labels:
    app: daloradius-freeradius-sql-dev
  namespace: radius-dev
apiVersion: v1
data:
  sql: |
    sql {
        dialect = &quot;mysql&quot;
        driver = &quot;rlm_sql_mysql&quot;
        sqlite {
            filename = &quot;/tmp/freeradius.db&quot;
            busy_timeout = 200
            bootstrap = &quot;${modconfdir}/${..:name}/main/sqlite/schema.sql&quot;
    }

    mysql {
        }
        warnings = auto
    }

    postgresql {
        send_application_name = yes
    }

    mongo {
        appname = &quot;freeradius&quot;
        tls {
             certificate_file = /path/to/file
             certificate_password = &quot;password&quot;
             ca_file = /path/to/file
             ca_dir = /path/to/directory
             crl_file = /path/to/file
             weak_cert_validation = false
             allow_invalid_hostname = false
            }
    }

    server = &quot;k8s-db-t.xxx.com&quot;
    port = 3326
    login = &quot;radius&quot;
    password = &quot;xxxxxxxxxxxxxxxxxx&quot;
    read_clients = yes
    radius_db = &quot;radius&quot;
    acct_table1 = &quot;radacct&quot;
    acct_table2 = &quot;radacct&quot;
    postauth_table = &quot;radpostauth&quot;
    authcheck_table = &quot;radcheck&quot;
    groupcheck_table = &quot;radgroupcheck&quot;
    authreply_table = &quot;radreply&quot;
    groupreply_table = &quot;radgroupreply&quot;
    usergroup_table = &quot;radusergroup&quot;
    delete_stale_sessions = yes

    pool {
        start = ${thread[pool].start_servers}
        min = ${thread[pool].min_spare_servers}
        max = ${thread[pool].max_servers}
        spare = ${thread[pool].max_spare_servers}
        uses = 0
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }
    client_table = &quot;nas&quot;
    group_attribute = &quot;SQL-Group&quot;
    $INCLUDE ${modconfdir}/${.:name}/main/${dialect}/queries.conf
    }
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å››-éƒ¨ç½²nignxphp7çš„daloradius-webç®¡ç†åå°">å›› éƒ¨ç½²nignx+php7çš„daloradius webç®¡ç†åå°</h3>
<h4 id="php7éƒ¨ç½²é…ç½®">php7éƒ¨ç½²é…ç½®</h4>
<h5 id="phpé•œåƒå®‰è£…æ‰©å±•-dockerfile">phpé•œåƒå®‰è£…æ‰©å±• Dockerfile</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">from hub.xxx.com/php:develop</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">user root</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">RUN pear install DB \</span><span class="w">
</span><span class="w">  </span><span class="cp">&amp;&amp;</span><span class="w"> </span><span class="l">pear install -a Mail \</span><span class="w">
</span><span class="w">  </span><span class="cp">&amp;&amp;</span><span class="w"> </span><span class="l">pear install -a Mail_Mime</span><span class="w">
</span></code></pre></div><h5 id="deployment-phpyml">deployment-php.yml</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/php:radius</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fpm-9000</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;600m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-cfg-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/usr/local/etc/php/php.ini&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">php.ini</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-fpm-cfg-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/usr/local/etc/php-fpm.d/www.conf&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">www.conf</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.xxx.xxx.194</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/daloradius-php</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-cfg-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-cfg-dev</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-fpm-cfg-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-fpm-cfg-dev</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fpm-9000</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev-svc</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fpm-9000</span><span class="w">
</span><span class="w">     </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">     </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">     </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32101</span><span class="w">
</span><span class="w">     </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></code></pre></div><h5 id="configmap-php-fpmyaml">configmap-php-fpm.yaml</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-fpm-cfg-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-fpm-cfg-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">www.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        [www]
</span><span class="sd">        user = 101
</span><span class="sd">        group = 101
</span><span class="sd">        listen = 127.0.0.1:9000
</span><span class="sd">        pm = static
</span><span class="sd">        pm.max_children = 20
</span><span class="sd">        pm.start_servers = 10
</span><span class="sd">        pm.min_spare_servers = 5
</span><span class="sd">        pm.max_spare_servers = 5</span><span class="w">        
</span></code></pre></div><h5 id="configmap-phpyaml">configmap-php.yaml</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-cfg-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-php-cfg-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">php.ini</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        [PHP]
</span><span class="sd">        engine = On
</span><span class="sd">        short_open_tag = Off
</span><span class="sd">        precision = 14
</span><span class="sd">        output_buffering = 4096
</span><span class="sd">        zlib.output_compression = Off
</span><span class="sd">        implicit_flush = Off
</span><span class="sd">        unserialize_callback_func =
</span><span class="sd">        serialize_precision = 17
</span><span class="sd">        disable_functions =
</span><span class="sd">        disable_classes =
</span><span class="sd">        zend.enable_gc = On
</span><span class="sd">        expose_php = On
</span><span class="sd">        max_execution_time = 30
</span><span class="sd">        max_input_time = 60
</span><span class="sd">        memory_limit = 128M
</span><span class="sd">        max_input_vars = 10000
</span><span class="sd">        error_reporting = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT
</span><span class="sd">        display_errors = On
</span><span class="sd">        display_startup_errors = Off
</span><span class="sd">        log_errors = On
</span><span class="sd">        log_errors_max_len = 1024
</span><span class="sd">        ignore_repeated_errors = Off
</span><span class="sd">        ignore_repeated_source = Off
</span><span class="sd">        report_memleaks = On
</span><span class="sd">        track_errors = Off
</span><span class="sd">        html_errors = On
</span><span class="sd">        error_log = php_errors.log
</span><span class="sd">        variables_order = &#34;GPCS&#34;
</span><span class="sd">        request_order = &#34;GP&#34;
</span><span class="sd">        register_argc_argv = Off
</span><span class="sd">        auto_globals_jit = On
</span><span class="sd">        post_max_size = 8M
</span><span class="sd">        auto_prepend_file =
</span><span class="sd">        auto_append_file =
</span><span class="sd">        default_mimetype = &#34;text/html&#34;
</span><span class="sd">        default_charset = &#34;UTF-8&#34;
</span><span class="sd">        doc_root =
</span><span class="sd">        user_dir =
</span><span class="sd">        enable_dl = Off
</span><span class="sd">        file_uploads = On
</span><span class="sd">        upload_max_filesize = 2M
</span><span class="sd">        max_file_uploads = 20
</span><span class="sd">        allow_url_fopen = On
</span><span class="sd">        allow_url_include = Off
</span><span class="sd">        default_socket_timeout = 60
</span><span class="sd">        [CLI Server]
</span><span class="sd">        cli_server.color = On
</span><span class="sd">        [Date]
</span><span class="sd">        date.timezone =Asia/Shanghai
</span><span class="sd">        [filter]
</span><span class="sd">        [iconv]
</span><span class="sd">        [intl]
</span><span class="sd">        [sqlite3]
</span><span class="sd">        [Pcre]
</span><span class="sd">        [Pdo]
</span><span class="sd">        [Pdo_mysql]
</span><span class="sd">        pdo_mysql.cache_size = 2000
</span><span class="sd">        pdo_mysql.default_socket=
</span><span class="sd">        [Phar]
</span><span class="sd">        [mail function]
</span><span class="sd">        SMTP = localhost
</span><span class="sd">        smtp_port = 25
</span><span class="sd">        mail.add_x_header = On
</span><span class="sd">        [SQL]
</span><span class="sd">        sql.safe_mode = Off
</span><span class="sd">        [ODBC]
</span><span class="sd">        odbc.allow_persistent = On
</span><span class="sd">        odbc.check_persistent = On
</span><span class="sd">        odbc.max_persistent = -1
</span><span class="sd">        odbc.max_links = -1
</span><span class="sd">        odbc.defaultlrl = 4096
</span><span class="sd">        odbc.defaultbinmode = 1
</span><span class="sd">        [Interbase]
</span><span class="sd">        ibase.allow_persistent = 1
</span><span class="sd">        ibase.max_persistent = -1
</span><span class="sd">        ibase.max_links = -1
</span><span class="sd">        ibase.timestampformat = &#34;%Y-%m-%d %H:%M:%S&#34;
</span><span class="sd">        ibase.dateformat = &#34;%Y-%m-%d&#34;
</span><span class="sd">        ibase.timeformat = &#34;%H:%M:%S&#34;
</span><span class="sd">        [MySQLi]
</span><span class="sd">        mysqli.max_persistent = -1
</span><span class="sd">        mysqli.allow_persistent = On
</span><span class="sd">        mysqli.max_links = -1
</span><span class="sd">        mysqli.cache_size = 2000
</span><span class="sd">        mysqli.default_port = 3306
</span><span class="sd">        mysqli.default_socket =
</span><span class="sd">        mysqli.default_host =
</span><span class="sd">        mysqli.default_user =
</span><span class="sd">        mysqli.default_pw =
</span><span class="sd">        mysqli.reconnect = Off
</span><span class="sd">        [mysqlnd]
</span><span class="sd">        mysqlnd.collect_statistics = On
</span><span class="sd">        mysqlnd.collect_memory_statistics = Off
</span><span class="sd">        [OCI8]
</span><span class="sd">        [PostgreSQL]
</span><span class="sd">        pgsql.allow_persistent = On
</span><span class="sd">        pgsql.auto_reset_persistent = Off
</span><span class="sd">        pgsql.max_persistent = -1
</span><span class="sd">        pgsql.max_links = -1
</span><span class="sd">        pgsql.ignore_notice = 0
</span><span class="sd">        pgsql.log_notice = 0
</span><span class="sd">        [bcmath]
</span><span class="sd">        bcmath.scale = 0
</span><span class="sd">        [browscap]
</span><span class="sd">        [Session]
</span><span class="sd">        session.save_handler = redis
</span><span class="sd">        session.save_path = &#34;tcp://xxx.xxx.xxx.194:6399&#34;
</span><span class="sd">        session.use_strict_mode = 0
</span><span class="sd">        session.use_cookies = 1
</span><span class="sd">        session.use_only_cookies = 1
</span><span class="sd">        session.name = PHPSESSID
</span><span class="sd">        session.auto_start = 0
</span><span class="sd">        session.cookie_lifetime = 0
</span><span class="sd">        session.cookie_path = /
</span><span class="sd">        session.cookie_domain =
</span><span class="sd">        session.cookie_httponly =
</span><span class="sd">        session.serialize_handler = php
</span><span class="sd">        session.gc_probability = 1
</span><span class="sd">        session.gc_divisor = 1000
</span><span class="sd">        session.gc_maxlifetime = 1440
</span><span class="sd">        session.referer_check =
</span><span class="sd">        session.cache_limiter = nocache
</span><span class="sd">        session.cache_expire = 180
</span><span class="sd">        session.use_trans_sid = 0
</span><span class="sd">        session.hash_function = 0
</span><span class="sd">        session.hash_bits_per_character = 5
</span><span class="sd">        url_rewriter.tags = &#34;a=href,area=href,frame=src,input=src,form=fakeentry&#34;
</span><span class="sd">        [Assertion]
</span><span class="sd">        zend.assertions = -1
</span><span class="sd">        tidy.clean_output = Off
</span><span class="sd">        [soap]
</span><span class="sd">        soap.wsdl_cache_enabled=1
</span><span class="sd">        soap.wsdl_cache_dir=&#34;/tmp&#34;
</span><span class="sd">        soap.wsdl_cache_ttl=86400
</span><span class="sd">        soap.wsdl_cache_limit = 5
</span><span class="sd">        [sysvshm]
</span><span class="sd">        [ldap]
</span><span class="sd">        ldap.max_links = -1</span><span class="w">        
</span></code></pre></div><h4 id="nginxéƒ¨ç½²é…ç½®">nginxéƒ¨ç½²é…ç½®</h4>
<h5 id="deployment-nginxyml">deployment-nginx.yml</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/nginx:1.16.0-develop</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-80</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;500m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/webwww</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/nginx/nginx.conf</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.conf</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-www-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.xxx.xxx.194</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/disk/k8s-nfs-data/k8s1-t/daloradius-php</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev-cm</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev-cm</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w"> </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w"> </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-80</span><span class="w">
</span><span class="w">     </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">     </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">     </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32100</span><span class="w">
</span><span class="w">     </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w"> </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span></code></pre></div><h5 id="configmap-php-nginxyaml">configmap-php-nginx.yaml</h5>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev-cm</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    user  www-data;
</span><span class="sd">    worker_processes  1;
</span><span class="sd">
</span><span class="sd">    error_log  /var/log/nginx/error.log warn;
</span><span class="sd">    pid        /var/run/nginx.pid;
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    events {
</span><span class="sd">        worker_connections  1024;
</span><span class="sd">    }
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">    http {
</span><span class="sd">        include       /etc/nginx/mime.types;
</span><span class="sd">        default_type  application/octet-stream;
</span><span class="sd">
</span><span class="sd">        log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
</span><span class="sd">                          &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
</span><span class="sd">                          &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span><span class="sd">
</span><span class="sd">        access_log  /var/log/nginx/access.log  main;
</span><span class="sd">
</span><span class="sd">        sendfile        on;
</span><span class="sd">        #tcp_nopush     on;
</span><span class="sd">
</span><span class="sd">        keepalive_timeout  65;
</span><span class="sd">
</span><span class="sd">        #gzip  on;
</span><span class="sd">
</span><span class="sd">        include /etc/nginx/conf.d/*.conf;
</span><span class="sd">        server {
</span><span class="sd">                listen 80 default_server;
</span><span class="sd">                server_name  radius.xxx.com ;
</span><span class="sd">                root   /webwww;
</span><span class="sd">
</span><span class="sd">                location = /50x.html {
</span><span class="sd">                    root   html;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">               location / {
</span><span class="sd">                    index index.php  index.html index.htm;
</span><span class="sd">                }
</span><span class="sd">
</span><span class="sd">                location ~ \.php$ {
</span><span class="sd">                    fastcgi_pass   daloradius-php-dev:9000;
</span><span class="sd">                    fastcgi_index  index.php;
</span><span class="sd">                    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
</span><span class="sd">                    fastcgi_param  HTTP_HOST          $server_name;
</span><span class="sd">                    include        fastcgi_params;
</span><span class="sd">                }
</span><span class="sd">        }
</span><span class="sd">    }</span><span class="w">    
</span></code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="äº”-æµ‹è¯•">äº” æµ‹è¯•</h3>
<h4 id="é€šè¿‡å‰ç«¯nginxä»£ç†è½¬å‘åˆ°nodeportç«¯å£">é€šè¿‡å‰ç«¯nginxä»£ç†è½¬å‘åˆ°nodeportç«¯å£</h4>
<pre><code> server {
        listen  80;
        charset utf-8;
        listen 443 ssl http2;
        server_name radius.xxx.com;

        ssl_certificate   /etc/nginx/server.pem;
        ssl_certificate_key   /etc/nginx/server.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;
        ssl_prefer_server_ciphers on;

        #è½¬å‘é¢„å‘å¸ƒç¯å¢ƒ
        location / {
            proxy_pass http://xxx.xxx.xxx.221:32100/;
            proxy_redirect http://$host:32100  http://$host;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
</code></pre><h4 id="é…ç½®k8sçš„ingress">é…ç½®k8sçš„ingress</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">radius-dev</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;traefik&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">radius.xxx.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">daloradius-nginx-dev</span><span class="w">
</span><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></div><h4 id="ç™»å½•æµ‹è¯•">ç™»å½•æµ‹è¯•</h4>
<pre><code>ç™»å½•åœ°å€: radius.xxx.com
è´¦å·å¯†ç : administrator/radius
</code></pre><h4 id="é€šè¿‡åå°æ–°å»ºè´¦å·ä¹‹å-æµ‹è¯•è´¦å·è¿é€šæ€§">é€šè¿‡åå°æ–°å»ºè´¦å·ä¹‹å, æµ‹è¯•è´¦å·è¿é€šæ€§</h4>
<h5 id="å‘½ä»¤è¡Œ">å‘½ä»¤è¡Œ</h5>
<pre><code># åœ¨freeradius å®¹å™¨å†…æ”¯çº¿
radtest xxx xxx 127.0.0.1 0 testing123


</code></pre><h4 id="é€šè¿‡radiusxxxcom-ç®¡ç†é¡µé¢æµ‹è¯•è¿é€šæ€§">é€šè¿‡radius.xxx.com ç®¡ç†é¡µé¢æµ‹è¯•è¿é€šæ€§</h4>
<blockquote>
<p>è¿™æ˜¯è®¤è¯é€šè¿‡çš„
<img src="//zhangzw001.github.io/images/51/img2.jpg" alt=""></p>
</blockquote>
<blockquote>
<p>è¿™æ˜¯è¢«rejected
<img src="//zhangzw001.github.io/images/51/img.jpg" alt=""></p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡windowså®‰è£…OpenSSHé—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/50-%E8%AE%B0%E4%B8%80%E6%AC%A1windows%E5%AE%89%E8%A3%85openssh%E9%97%AE%E9%A2%98/</link>
			<pubDate>Fri, 12 Jun 2020 18:06:26 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/50-%E8%AE%B0%E4%B8%80%E6%AC%A1windows%E5%AE%89%E8%A3%85openssh%E9%97%AE%E9%A2%98/</guid>
			<description>&lt;p&gt;windowsä¸€æ¬¡å®‰è£…openssh serveré—®é¢˜&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>windowsä¸€æ¬¡å®‰è£…openssh serveré—®é¢˜</p>
<h3 id="é¦–å…ˆæ˜¯å®‰è£…">é¦–å…ˆæ˜¯å®‰è£…</h3>
<p><a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH">å®˜æ–¹æ•™ç¨‹</a>
<a href="https://github.com/PowerShell/Win32-OpenSSH/releases">å®˜æ–¹releasesç‰ˆæœ¬</a></p>
<blockquote>
<p>è¿™é‡Œç›´æ¥ä¸‹è½½æœ€æ–° : OpenSSH-Win64.zip, Symbolsåº”è¯¥æ˜¯ddl</p>
</blockquote>
<p>SSH-2.0-OpenSSH_for_Windows_8.1</p>
<h4 id="è§£å‹åŒ…æ”¾åœ¨ç›®å½•-cprogram-filesopenssh">è§£å‹åŒ…æ”¾åœ¨ç›®å½•: C:\Program Files\OpenSSH</h4>
<pre><code># è¿›å…¥åˆ°è§£å‹ç›®å½•
cd C:\Program Files\OpenSSH

# æ‰§è¡Œå®‰è£…å‘½ä»¤
powershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1

</code></pre><h4 id="é…ç½®sshd_config">é…ç½®sshd_config</h4>
<pre><code># é¦–å…ˆåˆ›å»ºauthorized_keysæ–‡ä»¶
cd C:\ProgramData\ssh
echo &quot;&lt;you ssh public key&gt;&quot; &gt; authorized_keys

# ä½¿ç”¨icaclså‘½ä»¤ä¿®æ”¹æƒé™(ä»…å…è®¸SYSTEMå’ŒAdministratorsç»„æœ‰æƒé™å†™,å…¶ä»–ç”¨æˆ·åªè¯»)
icacls authorized_keys /inheritance:r
icacls authorized_keys /grant SYSTEM:(F)
icacls authorized_keys /grant BUILTIN\Administrators:(F)

# sshd_configä¿®æ”¹
å¼€å¯å¯†é’¥è®¿é—®ï¼šPubkeyAuthentication yes
ç¦ç”¨å¯†ç è®¿é—®ï¼šPasswordAuthentication no
ç¦ç”¨ç©ºå¯†ç ï¼šPermitEmptyPasswords no
å…³é—­DNSæŸ¥æ‰¾: UseDNS no
è®¾ç½®authorized_keysè·¯å¾„: AuthorizedKeysFile C:/ProgramData/ssh/authorized_keys  
</code></pre><blockquote>
<p>è¿™é‡Œé…ç½®AuthorizedKeysFile ä¸ºå…¨è·¯å¾„, ä¹‹å‰é…ç½®å˜é‡å¯¼è‡´æŠ¥é”™</p>
</blockquote>
<h4 id="å¯åŠ¨">å¯åŠ¨</h4>
<pre><code>net start sshd
net stop sshd

</code></pre><h4 id="å¸è½½">å¸è½½</h4>
<pre><code>powershell.exe -ExecutionPolicy Bypass -File uninstall-sshd.ps1

</code></pre><h3 id="é”™è¯¯1-read-from-socket-failed-connection-reset-by-peer">é”™è¯¯1 Read from socket failed: Connection reset by peer</h3>
<pre><code>AuthorizedKeysFile çš„è·¯å¾„é…ç½®çš„å˜é‡, ä¹‹åæ”¹æˆç»å¯¹è·¯å¾„ç¼ºæˆåŠŸäº†
</code></pre>]]></content>
		</item>
		
		<item>
			<title>goç®€å•è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/49-go%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Wed, 27 May 2020 17:25:31 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/49-go%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</guid>
			<description>&lt;p&gt;goçš„ä¸€äº›ç®€å•è®°å½•&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>goçš„ä¸€äº›ç®€å•è®°å½•</p>
<h3 id="1-goä¸­çš„ç”¨æ³•">1. goä¸­'&hellip;&lsquo;çš„ç”¨æ³•</h3>
<ul>
<li>ç¬¬ä¸€ä¸ªç”¨æ³•: ç”¨äºå‡½æ•°æœ‰å¤šä¸ªä¸å®šå‚æ•°çš„æƒ…å†µ,å¯ä»¥æ¥å—å¤šä¸ªä¸ç¡®å®šä¸ªæ•°å‚æ•°, å°†å¤šä¸ªå‚æ•°ä½œä¸ºsliceä¼ é€’äº†</li>
<li>ç¬¬äºŒä¸ªç”¨æ³•: ç”¨äºsliceæ‰“æ•£è¿›è¡Œä¼ é€’</li>
</ul>
<h4 id="ä¾‹ä¸€">ä¾‹ä¸€</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">sum</span><span class="p">(</span><span class="nx">nums</span> <span class="o">...</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">nums</span><span class="p">)</span>
 <span class="nx">totols</span> <span class="o">:=</span><span class="mi">0</span>
 <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">num</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nums</span><span class="p">{</span>
  <span class="nx">totols</span> <span class="o">+=</span><span class="nx">num</span>
 <span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">totols</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="nx">slice1</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
 <span class="c1">//åˆ‡ç‰‡è¢«æ‰“æ•£ä¼ å…¥
</span><span class="c1"></span> <span class="nf">sum</span><span class="p">(</span><span class="nx">slice1</span><span class="o">...</span><span class="p">)</span>
 <span class="nx">slice2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
 <span class="c1">//å…ƒç´ è¢«æ‰“æ•£ä¸€ä¸ªä¸ªappend
</span><span class="c1"></span> <span class="nx">slice2</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">slice2</span><span class="p">,</span><span class="nx">slice1</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><hr>
<h3 id="2-golangä¸­å¼•ç”¨ç±»å‹-sliceåˆ‡ç‰‡mapå­—å…¸channelç®¡é“">2. golangä¸­å¼•ç”¨ç±»å‹ slice(åˆ‡ç‰‡)ã€map(å­—å…¸)ã€channel(ç®¡é“)</h3>
<blockquote>
<p>intç±»å‹çš„é›¶å€¼æ˜¯0,stringç±»å‹çš„é›¶å€¼æ˜¯&quot;&quot;ï¼Œå¼•ç”¨ç±»å‹çš„é›¶å€¼æ˜¯nil</p>
</blockquote>
<ul>
<li>å€¼ç±»å‹</li>
</ul>
<blockquote>
<p>è¿™é‡Œaæ•°ç»„æ˜¯å€¼ç±»å‹, èµ‹å€¼ç»™b,ä¿®æ”¹bä¸ä¼šå¯¼è‡´aæ”¹å˜</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">a</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="nx">b</span> <span class="o">:=</span> <span class="nx">a</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span>
<span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="mi">4</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span>
</code></pre></div><ul>
<li>å¼•ç”¨ç±»å‹</li>
</ul>
<blockquote>
<p>è¿™é‡Œaæ˜¯ä¸ªsliceå¼•ç”¨ç±»å‹,ä¿®æ”¹bä¼šæ”¹å˜a, sliceçš„å¤åˆ¶æ˜¯å¼•ç”¨ç±»å‹</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"> <span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
 <span class="nx">b</span> <span class="o">:=</span> <span class="nx">a</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v:\t%p,%v:\t%p\n&#34;</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span>	<span class="c1">//[1 2 3]:        0xc000090020,[1 2 3]:   0xc000090020
</span><span class="c1"></span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="mi">4</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v:\t%p,%v:\t%p\n&#34;</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span>	<span class="c1">//[1 2 4]:        0xc000090020,[1 2 4]:   0xc000090020
</span><span class="c1"></span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v:\t%p,%v:\t%p\n&#34;</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>	<span class="c1">//[1 2 4]:        0xc000090020,[2 4]:     0xc000090028
</span><span class="c1"></span>
</code></pre></div><hr>
<h3 id="3-golangæŸ¥çœ‹å˜é‡ç±»å‹">3. golangæŸ¥çœ‹å˜é‡ç±»å‹</h3>
<ul>
<li>ç¬¬ä¸€ç§</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">arr</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="nx">sli</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%T,%T\n&#34;</span><span class="p">,</span><span class="nx">arr</span><span class="p">,</span><span class="nx">sli</span><span class="p">)</span>  <span class="c1">//[3]int,[]int
</span></code></pre></div><blockquote>
<p>æ˜¾ç¤ºçš„ç»“æœå¯ä»¥çœ‹åˆ°, ä¸€ä¸ªæ˜¯æ•°ç»„, ä¸€ä¸ªæ˜¯åˆ‡ç‰‡</p>
</blockquote>
<ul>
<li>ç¬¬äºŒç§</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"> <span class="nx">arr</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
 <span class="nx">sli</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;type:&#34;</span><span class="p">,</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">)</span>  <span class="c1">//type: [3]int
</span><span class="c1"></span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;type:&#34;</span><span class="p">,</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">sli</span><span class="p">)</span> <span class="p">)</span>  <span class="c1">//type: []int
</span></code></pre></div><h3 id="4-goä¸­å†…ç½®åˆ†é…å†…å­˜å‡½æ•°newå’Œmakeçš„ç”¨æ³•">4. goä¸­å†…ç½®åˆ†é…å†…å­˜å‡½æ•°newå’Œmakeçš„ç”¨æ³•</h3>
<p>åŸæ–‡: <a href="https://www.cnblogs.com/xhhgo/p/10916254.html">goè¯­è¨€å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹ç†è§£</a></p>
<ul>
<li>make ä»…ç”¨äº slice, map, channel, è¿”å›ç±»å‹æ˜¯æœ¬èº«, å¹¶ä¸”ä¼šåˆå§‹åŒ–</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nb">make</span><span class="p">(</span><span class="nx">t</span> <span class="nx">Type</span><span class="p">,</span> <span class="nx">size</span> <span class="o">...</span><span class="nx">IntegerType</span><span class="p">)</span> <span class="nx">Type</span>
</code></pre></div><ul>
<li>new è¿”å›ç±»å‹æ˜¯æŒ‡é’ˆ(å¼•ç”¨ç±»å‹)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// The new built-in function allocates memory. The first argument is a type,
</span><span class="c1">// not a value, and the value returned is a pointer to a newly
</span><span class="c1">// allocated zero value of that type.
</span><span class="c1"></span><span class="kd">func</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Type</span><span class="p">)</span> <span class="o">*</span><span class="nx">Type</span>
<span class="c1">//å®ƒåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ï¼Œåˆ†é…å¥½å†…å­˜åï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ç±»å‹å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚åŒæ—¶è¯·æ³¨æ„å®ƒåŒæ—¶æŠŠåˆ†é…çš„å†…å­˜ç½®ä¸ºé›¶ï¼Œä¹Ÿå°±æ˜¯ç±»å‹çš„é›¶å€¼ã€‚
</span></code></pre></div><h3 id="5-æŸ¥çœ‹sliceçš„é•¿åº¦å’Œå®¹é‡">5. æŸ¥çœ‹sliceçš„é•¿åº¦å’Œå®¹é‡</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"> <span class="c1">// åˆå§‹åŒ–ä¸€ä¸ª3ä¸ª0çš„slice,åˆ†é…å†…å®¹çš„å®¹é‡æ˜¯10ä¸ªint
</span><span class="c1"></span> <span class="nx">s3</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s3</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s3</span><span class="p">))</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">cap</span><span class="p">(</span><span class="nx">s3</span><span class="p">))</span>
</code></pre></div><h3 id="6-é—­åŒ…çš„è¯´æ˜">6. é—­åŒ…çš„è¯´æ˜</h3>
<p>åŸæ–‡: <a href="https://www.jianshu.com/p/faf7ef7fbcf8">é—­åŒ…ä¸åŒ¿åå‡½æ•°</a></p>
<h4 id="é—­åŒ…ä¸å¤–éƒ¨å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸ">é—­åŒ…ä¸å¤–éƒ¨å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸ</h4>
<blockquote>
<p>å†…å‡½æ•°å¯¹å¤–å‡½æ•°çš„ä¿®æ”¹ æ˜¯å¯¹å˜é‡çš„å¼•ç”¨, æ‰€ä»¥å†…å‡½æ•°ç»“æŸåå˜é‡ä¸ä¼šé‡Šæ”¾, å˜é‡çš„å†…å­˜åœ°å€ä¸å˜</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">n</span><span class="o">++</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">B</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">n</span><span class="o">++</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">A1</span><span class="o">:=</span><span class="nf">A</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">A1</span><span class="p">)</span>  <span class="c1">//0x48e3d0  åœ¨è¿™å„¿å·²ç»å®šä¹‰äº†n=20 ï¼Œç„¶åæ‰§è¡Œ++ æ“ä½œï¼Œæ‰€ä»¥æ˜¯21 ã€‚
</span><span class="c1"></span>    <span class="nf">A1</span><span class="p">()</span>     <span class="c1">//21 åé¢å¯¹é—­åŒ…çš„è°ƒç”¨ï¼Œæ²¡æœ‰å¯¹næ‰§è¡ŒåŠ ä¸€æ“ä½œï¼Œæ‰€ä»¥ä¸€ç›´æ˜¯21
</span><span class="c1"></span>    <span class="nf">A1</span><span class="p">()</span>     <span class="c1">//21
</span><span class="c1"></span>
    <span class="nx">B1</span><span class="o">:=</span><span class="nf">B</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">B1</span><span class="p">)</span>  <span class="c1">//0x48e340   è¿™å„¿å®šä¹‰äº†n ä¸º10
</span><span class="c1"></span>    <span class="nf">B1</span><span class="p">()</span>       <span class="c1">//11  åé¢å¯¹é—­åŒ…çš„è°ƒç”¨ï¼Œæ¯æ¬¡éƒ½å¯¹nè¿›è¡ŒåŠ 1æ“ä½œã€‚
</span><span class="c1"></span>    <span class="nf">B1</span><span class="p">()</span>       <span class="c1">//12
</span><span class="c1"></span>
<span class="p">}</span>
</code></pre></div><h3 id="7-åå¼•å·">7. åå¼•å·</h3>
<ul>
<li>åå¼•å·ä¼šåŸæ ·è¾“å‡º, ä¸èƒ½ä½¿ç”¨è½¬ä¹‰, \nä¹Ÿä¼šåŸæ ·è¾“å‡º</li>
<li>\r ç±»ä¼¼pythoné‡Œé¢çš„ \r ï¼Œæ¯æ¬¡éƒ½è¦†ç›–ä¸Šä¸€æ¬¡è¾“å‡ºçš„å†…å®¹</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">spinner</span><span class="p">(</span><span class="nx">delay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">for</span> <span class="p">{</span>
  <span class="c1">//for _, r := range `-\|/` {
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="s">&#34;-\\|/&#34;</span> <span class="p">{</span>
   <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\r%c&#34;</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span>
   <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr>
<h3 id="8-ç¼–è¯‘ä¸åŒå¹³å°å¯æ‰§è¡Œæ–‡ä»¶">8. ç¼–è¯‘ä¸åŒå¹³å°å¯æ‰§è¡Œæ–‡ä»¶</h3>
<h4 id="1macä¸‹ç¼–è¯‘linux-windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åº">1ã€Macä¸‹ç¼–è¯‘Linux, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">linux</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
<span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">windows</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
</code></pre></div><h4 id="2linuxä¸‹ç¼–è¯‘mac-windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åº">2ã€Linuxä¸‹ç¼–è¯‘Mac, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">darwin</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
<span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">windows</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
</code></pre></div><h4 id="3windowsä¸‹ç¼–è¯‘mac-linuxå¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åº">3ã€Windowsä¸‹ç¼–è¯‘Mac, Linuxå¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">SET</span> <span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span><span class="nx">SET</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">darwin3</span> <span class="nx">SET</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
<span class="nx">SET</span> <span class="nx">CGO_ENABLED</span><span class="p">=</span><span class="mi">0</span> <span class="nx">SET</span> <span class="nx">GOOS</span><span class="p">=</span><span class="nx">linux</span> <span class="nx">SET</span> <span class="nx">GOARCH</span><span class="p">=</span><span class="nx">amd64</span> <span class="k">go</span> <span class="nx">build</span>  <span class="nx">test</span><span class="p">.</span><span class="k">go</span>
</code></pre></div><hr>
<h3 id="9-æ–æ³¢é‚£å¥‘æ•°åˆ—">9. æ–æ³¢é‚£å¥‘æ•°åˆ—</h3>
<h4 id="1-é€’å½’å†™æ³•n-è¶Šå¤§-å°±è´¼æ…¢">1 é€’å½’å†™æ³•(n è¶Šå¤§ å°±è´¼æ…¢)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Fib</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span> <span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span><span class="mi">1</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span> <span class="p">}</span>
	<span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nf">fib</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><h4 id="2-å¾ªç¯çš„å†™æ³•">2 å¾ªç¯çš„å†™æ³•</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Fib2</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span> <span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">f</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">2</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="p">}</span>
</code></pre></div><h4 id="3-åŒ¿åå‡½æ•°å†™æ³•">3 åŒ¿åå‡½æ•°å†™æ³•</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Fib3</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">n</span><span class="p">,</span><span class="nx">m</span> <span class="kt">int</span>
 <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
   <span class="nx">n</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  <span class="nx">n</span><span class="p">,</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">n</span><span class="o">+</span><span class="nx">m</span><span class="p">,</span><span class="nx">n</span>
  <span class="k">return</span> <span class="nx">m</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="10-stringæ–¹æ³•">10. String()æ–¹æ³•</h3>
<blockquote>
<p>goä¸­å¦‚æœç±»å‹Aå®ç°äº†String()æ–¹æ³•(string() ä¸è¡Œ),é‚£ä¹ˆåœ¨è¾“å‡ºAçš„æ—¶å€™,ä¼šè‡ªåŠ¨è°ƒç”¨String() æ–¹æ³•</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="kt">string</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">A</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;this is String() : %v\n&#34;</span><span class="p">,</span><span class="nx">a</span><span class="p">.</span><span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">:=</span> <span class="nx">A</span><span class="p">{</span><span class="s">&#34;test&#34;</span><span class="p">}</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>  <span class="c1">//this is String() : test
</span><span class="c1"></span>
<span class="p">}</span>

</code></pre></div><h3 id="11-printfç”¨æ³•">11. Printfç”¨æ³•</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//ç¬¬ä¸€, é€šå¸¸Printfæ ¼å¼åŒ–å­—ç¬¦ä¸²åŒ…å«å¤šä¸ª%å‚æ•°æ—¶å°†ä¼šåŒ…å«å¯¹åº”ç›¸åŒæ•°é‡çš„é¢å¤–æ“ä½œæ•°ï¼Œä½†æ˜¯%ä¹‹åçš„[1]å‰¯è¯å‘Šè¯‰Printfå‡½æ•°å†æ¬¡ä½¿ç”¨ç¬¬ä¸€ä¸ªæ“ä½œæ•°ã€‚
</span><span class="c1">//ç¬¬äºŒ, %åçš„#å‰¯è¯å‘Šè¯‰Printfåœ¨ç”¨%oã€%xæˆ–%Xè¾“å‡ºæ—¶ç”Ÿæˆ0ã€0xæˆ–0Xå‰ç¼€ã€‚
</span><span class="c1"></span><span class="nx">o</span> <span class="o">:=</span> <span class="mo">0666</span>
<span class="nx">x</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d %[1]o %#[1]o , %d %[2]x %#[2]x %#[2]X\n&#34;</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span> <span class="c1">// &#34;438 666 0666 , 3735928559 deadbeef 0xdeadbeef 0XDEADBEEF&#34;
</span><span class="c1"></span>
</code></pre></div><h3 id="12-fmtprintf">12. fmt.Printf</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="o">%</span><span class="nx">p</span>	<span class="o">-</span><span class="p">&gt;</span> <span class="nx">å†…å­˜åœ°å€</span>
<span class="o">%</span><span class="nx">q</span>	<span class="o">-</span><span class="p">&gt;</span> <span class="nx">è¯¥å€¼å¯¹åº”çš„å•å¼•å·æ‹¬èµ·æ¥çš„goè¯­æ³•å­—ç¬¦å­—é¢å€¼</span><span class="err">ï¼Œ</span><span class="nx">å¿…è¦æ—¶ä¼šé‡‡ç”¨å®‰å…¨çš„è½¬ä¹‰è¡¨ç¤º</span>
<span class="o">%+</span><span class="nx">v</span>	<span class="o">-</span><span class="p">&gt;</span> <span class="nx">è¾“å‡ºç»“æ„ä½“æ—¶</span><span class="p">,</span> <span class="nx">ä¼šæ‰“å°å­—æ®µåç§°</span>
</code></pre></div><ul>
<li>%+v ä¾‹å­</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">info</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name&#34;`</span>
  <span class="nx">Age</span>  <span class="kt">int</span>    <span class="s">`json:&#34;age&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">i</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">{</span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">}</span>
	<span class="nx">j</span> <span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v, %+v, %v \n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">j</span><span class="p">))</span>
	<span class="c1">//{test 11}, {Name:test Age:11}, {&#34;name&#34;:&#34;test&#34;,&#34;age&#34;:11}
</span><span class="c1"></span>
<span class="p">}</span>
</code></pre></div><h3 id="13-ç±»å‹æ–­è¨€">13. ç±»å‹æ–­è¨€</h3>
<ul>
<li>è½¬<a href="https://blog.csdn.net/cbmljs/article/details/82966907">Go-ç±»å‹æ–­è¨€ é—®é¢˜</a></li>
<li>è½¬<a href="https://www.cnblogs.com/believepd/p/10945700.html">Go-ç±»å‹æ–­è¨€ æœ€ä½³å®è·µ</a></li>
</ul>
<blockquote>
<p>ç±»å‹æ–­è¨€ï¼šç”±äºæ¥å£æ˜¯ä¸€èˆ¬ç±»å‹ï¼Œä¸çŸ¥é“å…·ä½“ç±»å‹ï¼Œå¦‚æœè¦è½¬æˆå…·ä½“ç±»å‹ï¼Œå°±éœ€è¦ä½¿ç”¨ç±»å‹æ–­è¨€ã€‚</p>
</blockquote>
<blockquote>
<p>struct æ˜¯ç›¸åŒçš„å±æ€§, interface æ˜¯ç›¸åŒçš„æ–¹æ³•</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Usb</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nf">Connect</span><span class="p">()</span>
 <span class="nf">Disconnect</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Phone</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">Camera</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">Name</span> <span class="kt">string</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">Phone</span><span class="p">)</span> <span class="nf">Connect</span><span class="p">()</span>     <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%sè¿æ¥ä¸­...\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">Phone</span><span class="p">)</span> <span class="nf">Disconnect</span><span class="p">()</span>  <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%sæ–­å¼€è¿æ¥ä¸­...\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Camera</span><span class="p">)</span> <span class="nf">Connect</span><span class="p">()</span>    <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%sè¿æ¥ä¸­...\n&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Camera</span><span class="p">)</span> <span class="nf">Disconnect</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%sæ–­å¼€è¿æ¥ä¸­...\n&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// Phoneç»“æ„ä½“ç‰¹æœ‰çš„æ–¹æ³•Call
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">Phone</span><span class="p">)</span> <span class="nf">Call</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨ä½¿ç”¨%sæ‰“ç”µè¯...\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">}</span>
<span class="c1">// Camera
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Camera</span><span class="p">)</span> <span class="nf">Photograph</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨ä½¿ç”¨%sæ‹ç…§...\n&#34;</span><span class="p">,</span><span class="nx">c</span><span class="p">.</span><span class="nx">Name</span><span class="p">)}</span>
<span class="kd">type</span> <span class="nx">Computer</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Computer</span><span class="p">)</span> <span class="nf">Working</span><span class="p">(</span><span class="nx">usb</span> <span class="nx">Usb</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">usb</span><span class="p">.</span><span class="nf">Connect</span><span class="p">()</span>
 <span class="nx">usb</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">()</span>
 <span class="c1">// å¦‚æœ usb æ˜¯æŒ‡å‘ Phone ç»“æ„ä½“å˜é‡ï¼Œåˆ™è¿˜éœ€è¦è°ƒç”¨ Call æ–¹æ³•
</span><span class="c1"></span> <span class="c1">//phone, ok := usb.(Phone) // ç±»å‹æ–­è¨€
</span><span class="c1"></span> <span class="c1">//if ok {
</span><span class="c1"></span> <span class="c1">// phone.Call()
</span><span class="c1"></span> <span class="c1">//}
</span><span class="c1"></span> <span class="k">switch</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">usb</span><span class="p">.(</span><span class="kd">type</span><span class="p">){</span>
 <span class="k">case</span> <span class="nx">Phone</span><span class="p">:</span>
  <span class="nx">v</span><span class="p">.</span><span class="nf">Call</span><span class="p">()</span>
 <span class="k">case</span> <span class="nx">Camera</span><span class="p">:</span>
  <span class="nx">v</span><span class="p">.</span><span class="nf">Photograph</span><span class="p">()</span>
 <span class="k">default</span><span class="p">:</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸æ”¯æŒçš„è®¾å¤‡&#34;</span><span class="p">)</span>

 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="c1">// å®šä¹‰ä¸€ä¸ª Usb æ¥å£æ•°ç»„ï¼Œå¯ä»¥å­˜æ”¾ Phone å’Œ Camera ç»“æ„ä½“çš„å®ä¾‹
</span><span class="c1"></span> <span class="kd">var</span> <span class="nx">usbArr</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">Usb</span>
 <span class="nx">usbArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">Phone</span><span class="p">{</span><span class="s">&#34;è‹¹æœ&#34;</span><span class="p">}</span>
 <span class="nx">usbArr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">Camera</span><span class="p">{</span><span class="s">&#34;å°¼åº·&#34;</span><span class="p">}</span>
 <span class="kd">var</span> <span class="nx">computer</span> <span class="nx">Computer</span>
 <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">usbArr</span> <span class="p">{</span>
  <span class="nx">computer</span><span class="p">.</span><span class="nf">Working</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">usbArr</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><h3 id="14-select-å’Œswitch">14 select å’Œswitch</h3>
<p>select æ“ä½œè¯­å¥åªèƒ½æ˜¯ã€IO æ“ä½œã€‘,ä¸€èˆ¬ç”¨äºchannel</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="nf">worker</span><span class="p">()</span>  <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="p">{</span>
	<span class="nx">workerChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">()))</span>
	<span class="nx">workTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Int63n</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">workTime</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">workerChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
	<span class="p">}()</span>
	<span class="k">return</span>  <span class="nx">workerChan</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">timeout</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">10</span>
	<span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span>
	<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">myWorkerTime</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">{</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">myWorkerTime</span> <span class="p">=</span> <span class="nf">worker</span><span class="p">()</span>
		<span class="p">}()</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;timer.c &gt;&gt;&gt; timeout &#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ticker.c &gt;&gt;&gt;&#34;</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span> <span class="nx">myWorkerTime</span><span class="p">:</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;workerTime &gt;&gt;&gt;&#34;</span><span class="p">)</span>
			<span class="nx">timer</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span>
		<span class="k">default</span><span class="p">:</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h3 id="15-channelç®€å•ä¾‹å­">15 channelç®€å•ä¾‹å­</h3>
<blockquote>
<p>channel å¯¼è‡´ deadlock æ˜¯ç”±äºæœª close channel</p>
<p>close channelä¹‹å,è¿˜å¯ä»¥è¯»å– channel</p>
<ol>
<li>
<p>value,ok := &lt;- channel ä½†æ˜¯è¿”å›value=0,ok=false</p>
</li>
<li>
<p>for value := range channel çš„æ—¶å€™ä¼šé€€å‡º for å¾ªç¯</p>
</li>
</ol>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="nf">write</span><span class="p">(</span><span class="nx">ch1</span> <span class="kd">chan</span> <span class="kt">int</span> <span class="p">,</span> <span class="nx">done</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">ch1</span> <span class="o">&lt;-</span> <span class="nx">i</span>
		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="c1">// å¿…é¡»è¦ close
</span><span class="c1"></span>	<span class="nb">close</span><span class="p">(</span><span class="nx">ch1</span><span class="p">)</span>
    <span class="c1">// æˆ–è€…é€šè¿‡ done æ¥é€€å‡º
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">done</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
    <span class="p">}()</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">read</span><span class="p">(</span><span class="nx">ch1</span> <span class="kd">chan</span> <span class="kt">int</span> <span class="p">,</span> <span class="nx">done</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch1</span><span class="p">:</span>
            <span class="c1">// å¦‚æœ close è¿™é‡Œä¼šæ”¶åˆ° not ok
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;not OK&#34;</span><span class="p">,</span><span class="nx">v</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;v:&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;received done channel finish&#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">ch1</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="k">go</span> <span class="nf">write</span><span class="p">(</span><span class="nx">ch1</span><span class="p">,</span><span class="nx">done</span><span class="p">,</span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">)</span>
	<span class="k">go</span> <span class="nf">read</span><span class="p">(</span><span class="nx">ch1</span><span class="p">,</span><span class="nx">done</span><span class="p">,</span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">)</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></div><h3 id="16-syncwaitgroup-ä½¿ç”¨">16 sync.WaitGroup ä½¿ç”¨</h3>
<blockquote>
<p>åŒä¸Š</p>
</blockquote>
<h3 id="17-åŒ…å¯¼å…¥çš„å‡ ç‚¹è¯´æ˜">17 åŒ…å¯¼å…¥çš„å‡ ç‚¹è¯´æ˜</h3>
<blockquote>
<p>è¯¦æƒ…è§<a href="http://shouce.jb51.net/gopl-zh/ch10/ch10-03.html">goåœ£ç»</a></p>
</blockquote>
<ul>
<li>å¯¼å…¥è·¯å¾„åçš„çº¦å®š</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">å…³äºé»˜è®¤åŒ…åä¸€èˆ¬é‡‡ç”¨å¯¼å…¥è·¯å¾„åçš„æœ€åä¸€æ®µçš„çº¦å®šä¹Ÿæœ‰ä¸‰ç§ä¾‹å¤–æƒ…å†µã€‚
1. ç¬¬ä¸€ä¸ªä¾‹å¤–ï¼ŒåŒ…å¯¹åº”ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œä¹Ÿå°±æ˜¯mainåŒ…ï¼Œè¿™æ—¶å€™mainåŒ…æœ¬èº«çš„å¯¼å…¥è·¯å¾„æ˜¯æ— å…³ç´§è¦çš„ã€‚åå­—ä¸ºmainçš„åŒ…æ˜¯ç»™go buildæ„å»ºå‘½ä»¤ä¸€ä¸ªä¿¡æ¯ï¼Œè¿™ä¸ªåŒ…ç¼–è¯‘å®Œä¹‹åå¿…é¡»è°ƒç”¨è¿æ¥å™¨ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚

2. ç¬¬äºŒä¸ªä¾‹å¤–ï¼ŒåŒ…æ‰€åœ¨çš„ç›®å½•ä¸­å¯èƒ½æœ‰ä¸€äº›æ–‡ä»¶åæ˜¯ä»¥_test.goä¸ºåç¼€çš„Goæºæ–‡ä»¶ï¼ˆè¯‘æ³¨ï¼šå‰é¢å¿…é¡»æœ‰å…¶å®ƒçš„å­—ç¬¦ï¼Œå› ä¸ºä»¥_æˆ–.å¼€å¤´çš„æºæ–‡ä»¶ä¼šè¢«æ„å»ºå·¥å…·å¿½ç•¥ï¼‰ï¼Œå¹¶ä¸”è¿™äº›æºæ–‡ä»¶å£°æ˜çš„åŒ…åä¹Ÿæ˜¯ä»¥_testä¸ºåç¼€åçš„ã€‚è¿™ç§ç›®å½•å¯ä»¥åŒ…å«ä¸¤ç§åŒ…ï¼šä¸€ç§æ˜¯æ™®é€šåŒ…ï¼Œå¦ä¸€ç§åˆ™æ˜¯æµ‹è¯•çš„å¤–éƒ¨æ‰©å±•åŒ…ã€‚
æ‰€æœ‰ä»¥_testä¸ºåç¼€åŒ…åçš„æµ‹è¯•å¤–éƒ¨æ‰©å±•åŒ…éƒ½ç”±go testå‘½ä»¤ç‹¬ç«‹ç¼–è¯‘ï¼Œæ™®é€šåŒ…å’Œæµ‹è¯•çš„å¤–éƒ¨æ‰©å±•åŒ…æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚æµ‹è¯•çš„å¤–éƒ¨æ‰©å±•åŒ…ä¸€èˆ¬ç”¨æ¥é¿å…æµ‹è¯•ä»£ç ä¸­çš„å¾ªç¯å¯¼å…¥ä¾èµ–

3. ç¬¬ä¸‰ä¸ªä¾‹å¤–ï¼Œä¸€äº›ä¾èµ–ç‰ˆæœ¬å·çš„ç®¡ç†å·¥å…·ä¼šåœ¨å¯¼å…¥è·¯å¾„åè¿½åŠ ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œä¾‹å¦‚<span class="s2">&#34;gopkg.in/yaml.v2&#34;</span>ã€‚è¿™ç§æƒ…å†µä¸‹åŒ…çš„åå­—å¹¶ä¸åŒ…å«ç‰ˆæœ¬å·åç¼€ï¼Œè€Œæ˜¯yamlã€‚
</code></pre></div><ul>
<li>åŒ¿åå¯¼å…¥</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">_</span> <span class="s">&#34;image/png&#34;</span> <span class="c1">// register PNG decoder
</span></code></pre></div><ul>
<li>æ„å»ºåŒ…(go doc go/build)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">1. å¦‚æœä¸€ä¸ªæ–‡ä»¶ååŒ…å«äº†ä¸€ä¸ªæ“ä½œç³»ç»Ÿæˆ–å¤„ç†å™¨ç±»å‹åå­—ï¼Œä¾‹å¦‚net_linux.goæˆ–asm_amd64.sï¼ŒGoè¯­è¨€çš„æ„å»ºå·¥å…·å°†åªåœ¨å¯¹åº”çš„å¹³å°ç¼–è¯‘è¿™äº›æ–‡ä»¶

2. å¦‚æœæ–‡ä»¶ä¸­å¯èƒ½åŒ…å«ä¸‹é¢çš„æ³¨é‡Šï¼š
  // +build linux darwin	//åªåœ¨ç¼–è¯‘ç¨‹åºå¯¹åº”çš„ç›®æ ‡æ“ä½œç³»ç»Ÿæ˜¯Linuxæˆ–Mac OS Xæ—¶æ‰ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶
  // +build ignore		//ä¸ç¼–è¯‘
</code></pre></div><ul>
<li>ä¸€äº›å‘</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">1. å¯¼å…¥åŒ…å¦‚æœæ˜¯å¤§å†™å¼€å¤´å¯¼è‡´go mod tidyï¼Œgo mod downloadç­‰å‘½ä»¤æ— æ³•ä½¿ç”¨ã€‚ä¾‹å¦‚: github.com/Unknwon/com, å¯ä»¥replaceä¸ºgithub.com/unknwon/com,ç›®å‰ç›´æ¥ä½¿ç”¨go get github.com/unknwon/com å³å¯
</code></pre></div><h3 id="18-go-get-è¶…æ—¶çš„é”™è¯¯">18 go get è¶…æ—¶çš„é”™è¯¯</h3>
<blockquote>
<p>å¦‚æœé‡åˆ°è¶…æ—¶é”™è¯¯&quot;https fetch: Get &hellip; connect: connection timed out&quot;, è¯·è®¾ç½®ä»£ç†åé‡è¯•ï¼Œè¯¦è§ <a href="https://www.bfe-networks.net/zh_cn/faq/installation/">å®‰è£…å¸¸è§é—®é¢˜</a></p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">go env -w <span class="nv">GO111MODULE</span><span class="o">=</span>on
go env -w <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
</code></pre></div><h3 id="19-bitcountçš„ä»£ç è§£æ">19 bitCountçš„ä»£ç è§£æ</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// æ¯æ¬¡ &amp; æ“ä½œéƒ½ä¼šæ¶ˆè€—ä¸€ä¸ªäºŒè¿›åˆ¶çš„1
</span><span class="c1">// 10110 &amp; 10101 = 10100   æ¶ˆè€—äº†ç¬¬å››ä¸ªçš„1
</span><span class="c1">// 10100 &amp; 10011 = 10000   æ¶ˆè€—äº†ç¬¬ä¸‰ä¸ªçš„1
</span><span class="c1">// 10000 &amp; 01111 = 0       æ¶ˆè€—äº†ç¬¬ä¸€ä¸ªçš„1
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">getCount</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>  <span class="p">{</span>
 <span class="nx">t</span> <span class="o">:=</span> <span class="mi">0</span>
 <span class="k">for</span> <span class="nx">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">&amp;=</span> <span class="nx">a</span><span class="o">-</span><span class="mi">1</span>
  <span class="nx">t</span><span class="o">++</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nx">t</span>
<span class="p">}</span>
</code></pre></div><h3 id="20-ç®€å•ä»‹ç»æ¥å£çš„å®ç°">20 ç®€å•ä»‹ç»æ¥å£çš„å®ç°</h3>
<p><a href="https://blog.csdn.net/think2me/article/details/108149326">goä¸­å®ç°æ¥å£çš„å‡ ç§æ–¹å¼</a></p>
<p>ä¸¾ä¸ªç®€å•ä¾‹å­è¯´æ˜</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//å®šä¹‰ä¸€ä¸ªæ¥å£,å­˜åœ¨Valueæ–¹æ³•
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">emptyInterface</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nf">Value</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// å®šä¹‰ä¸€ä¸ªemptyç±»å‹
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">empty</span> <span class="kt">int</span>

<span class="c1">// å®šä¹‰emptyç±»å‹çš„Valueæ–¹æ³•,å®ç°emptyInterface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">empty</span><span class="p">)</span> <span class="nf">Value</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
 <span class="k">return</span> <span class="nx">key</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="c1">// å®šä¹‰ä¸€ä¸ªemptyç±»å‹ç»“æ„ä½“
</span><span class="c1"></span> <span class="nx">e</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">empty</span><span class="p">)</span>
 <span class="c1">// å®šä¹‰ä¸€ä¸ªemptyInterfaceç±»å‹æ¥å£
</span><span class="c1"></span> <span class="kd">var</span> <span class="nx">eIface</span> <span class="nx">emptyInterface</span>
 <span class="c1">// æ¥å£èµ‹å€¼,å®Œæˆæ–¹æ³•çš„é‡å†™
</span><span class="c1"></span> <span class="nx">eIface</span> <span class="p">=</span> <span class="nx">e</span>
 <span class="c1">// å¯¹æ¥å£è¿›è¡Œè°ƒç”¨
</span><span class="c1"></span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">eIface</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
 <span class="c1">// æ˜¾ç„¶é€šè¿‡ç»“æ„ä½“ä¹Ÿèƒ½è°ƒç”¨, ä½†æ˜¯ä¸€èˆ¬æˆ‘ä»¬ä¸è¿™ä¹ˆåš
</span><span class="c1"></span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>

</code></pre></div><p>æ‹¿ä¸ªcontextä¾‹å­è¯´æ˜, é¦–å…ˆContextæ¥å£æœ‰å››ä¸ªæ–¹æ³•</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Context</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nf">Deadline</span><span class="p">()</span> <span class="p">(</span><span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
 <span class="nf">Done</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
 <span class="nf">Err</span><span class="p">()</span> <span class="kt">error</span>
 <span class="nf">Value</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div><p>å¹¶ä¸”emptyCtxç±»å‹å®ç°äº†Contextæ¥å£</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">emptyCtx</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptyCtx</span><span class="p">)</span> <span class="nf">Deadline</span><span class="p">()</span> <span class="p">(</span><span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptyCtx</span><span class="p">)</span> <span class="nf">Done</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="p">{</span>
 <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptyCtx</span><span class="p">)</span> <span class="nf">Err</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
 <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptyCtx</span><span class="p">)</span> <span class="nf">Value</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
 <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></div><p>é‚£ä¹ˆæˆ‘ä»¬å°±è¯´emptyCtx å®ç°äº†Context æ¥å£, é‚£å®ç°äº†è¿™ä¸ªæ¥å£å…·ä½“è¦æ€ä¹ˆåšå‘¢?</p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·, èµ‹å€¼, ä½†è¿™é‡Œä½¿ç”¨çš„å‡½æ•°è¿”å›:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
 <span class="nx">background</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">emptyCtx</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">Background</span><span class="p">()</span> <span class="nx">Context</span> <span class="p">{</span>
 <span class="k">return</span> <span class="nx">background</span>
<span class="p">}</span>

</code></pre></div><h3 id="21-swaggeræœ¬åœ°æµ‹è¯•çš„ä¸€ä¸ªé—®é¢˜">21. swaggeræœ¬åœ°æµ‹è¯•çš„ä¸€ä¸ªé—®é¢˜</h3>
<h4 id="211-åœ¨æ‰§è¡Œtry-it-out-çš„æ—¶å€™æŠ¥é”™-typeerror-failed-to-fetch">21.1 åœ¨æ‰§è¡Œtry it out çš„æ—¶å€™æŠ¥é”™: TypeError: Failed to fetch</h4>
<p>åŸå› æ˜¯swaggerçš„é…ç½®ä¸­ <code>host=&quot;localhost:8880&quot;</code> , è€Œæˆ‘æµè§ˆå™¨æ‰“å¼€çš„æ˜¯ <code>127.0.0.1:8880</code> , ä»æ—¥å¿—ä¹Ÿèƒ½çœ‹åˆ°æ˜¯ä¸åŒçš„è¯·æ±‚</p>
<pre><code># TypeError: Failed to fetch é”™è¯¯çš„è¯·æ±‚æ—¥å¿—:
[GIN] 2020/12/01 - 16:12:49 | 404 |         790ns |             ::1 | OPTIONS  &quot;/admin_login/login&quot;

# æ­£å¸¸çš„è¯·æ±‚æ—¥å¿—:
[GIN] 2020/12/01 - 16:15:24 | 200 |     452.808Âµs |             ::1 | POST     &quot;/admin_login/login&quot;
</code></pre><p>æ‰€ä»¥åªè¦ä¿æŒä¸€è‡´å³å¯, é…ç½®çš„æ˜¯<code>localhost</code>è¯·æ±‚å°±ä¸è¦ç”¨<code>127.0.0.1</code></p>
<h4 id="212-æ‰“å¼€é¡µé¢æ—¥å¿—æŠ¥é”™-not-yet-registered-swag">21.2 æ‰“å¼€é¡µé¢æ—¥å¿—æŠ¥é”™: not yet registered swag</h4>
<blockquote>
<p>å½“å‰é…ç½®:</p>
</blockquote>
<pre><code># é¦–å…ˆå·²ç»æ·»åŠ äº†è·¯ç”±è§„åˆ™
e.GET(&quot;/swagger/*any&quot;,ginSwagger.WrapHandler(swaggerFiles.Handler))
</code></pre><blockquote>
<p>è§£å†³æ–¹æ³•:</p>
</blockquote>
<pre><code># å¯¼å…¥é¡¹ç›®ä¸­çš„docsç›®å½•
import	_ &quot;github.com/zhangzw001/learnGin/docs&quot;

</code></pre><h3 id="22-gorm">22. gorm.</h3>
<p><a href="https://segmentfault.com/a/1190000021363996">GORMä¹‹ErrRecordNotFoundé‡‡å‘è®°å½•</a></p>
<blockquote>
<p>gorm.DB çš„Findæˆ–Firstç­‰æ–¹æ³•, åœ¨ä¼ å…¥strucçš„æ—¶å€™ , å¯èƒ½è¿”å›ErrRecordNotFound, åœ¨ä¼ å…¥listçš„æ—¶å€™, å¯èƒ½è¿”å›nil</p>
</blockquote>
<h3 id="23-goè½¬æ±‡ç¼–">23. goè½¬æ±‡ç¼–</h3>
<pre><code># ç¬¬ä¸€ç§
go tool compile -S go-main-slice.go
# ç¬¬äºŒç§
GOSSAFUNC=main go build go-main-slice.go
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8så‡çº§(1.10-&gt;1.15)</title>
			<link>https://www.ngirl.xyz/posts/48-k8s%E5%8D%87%E7%BA%A7-1-10-1-15/</link>
			<pubDate>Mon, 18 May 2020 17:43:27 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/48-k8s%E5%8D%87%E7%BA%A7-1-10-1-15/</guid>
			<description>&lt;p&gt;k8så‡çº§ä¸€èˆ¬ä¸èƒ½è·¨ç‰ˆæœ¬å‡çº§, æ‰€ä»¥è¿™é‡Œé—´æ–­ä»‹ç»å‡çº§è¿‡ç¨‹, æ¯æ¬¡å‡çº§ä¸€ä¸ªå¤§ç‰ˆæœ¬&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>k8så‡çº§ä¸€èˆ¬ä¸èƒ½è·¨ç‰ˆæœ¬å‡çº§, æ‰€ä»¥è¿™é‡Œé—´æ–­ä»‹ç»å‡çº§è¿‡ç¨‹, æ¯æ¬¡å‡çº§ä¸€ä¸ªå¤§ç‰ˆæœ¬</p>
<h3 id="k8så‡çº§">k8så‡çº§</h3>
<ul>
<li><a href="https://blog.51cto.com/newfly/2440901?source=dra">kubernetesé›†ç¾¤ç‰ˆæœ¬å‡çº§æ”»ç•¥</a></li>
<li><a href="https://kuboard.cn/install/upgrade-k8s/1.15.x-1.16.x.html">kuboardç½‘å€k8så‡çº§æ”»ç•¥</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">å®˜æ–¹kubeadmå‡çº§æ–‡æ¡£</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">å®˜æ–¹k8sç‰ˆæœ¬changelog</a></li>
</ul>
<h3 id="ç‰ˆæœ¬å…³ç³»">ç‰ˆæœ¬å…³ç³»</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">Kubernetes 1.18.0 --&gt;Dockerç‰ˆæœ¬1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03
Kubernetes 1.17.0 --&gt;Dockerç‰ˆæœ¬1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09, 19.03
Kubernetes 1.16.0 --&gt;Dockerç‰ˆæœ¬1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09
Kubernetes 1.15.0 --&gt;Dockerç‰ˆæœ¬1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09
Kubernetes 1.14.0 --&gt;Dockerç‰ˆæœ¬1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09
Kubernetes 1.13.0 --&gt;Dockerç‰ˆæœ¬1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06
Kubernetes 1.12.0 --&gt;Dockerç‰ˆæœ¬1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06
Kubernetes 1.11.* --&gt;Dockerç‰ˆæœ¬1.11.2 to 1.13.1 and 17.03.x <span class="o">(</span>ref<span class="o">)</span>
Kubernetes 1.10.* --&gt;Dockerç‰ˆæœ¬1.11.2 to 1.13.1 and 17.03.x <span class="o">(</span>ref<span class="o">)</span>
</code></pre></div><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.10 -> k8s1.11 </font>
</center>
<h3 id="k8s110---k8s111">k8s1.10 -&gt; k8s1.11</h3>
<ul>
<li>æ³¨æ„æˆ‘è¿™é‡Œæ˜¯å•æœº,æ‰€ä»¥æ²¡æœ‰ç¦æ­¢è°ƒåº¦,é›†ç¾¤åœ¨å‡çº§å‰éœ€è¦ç¦æ­¢è°ƒåº¦:</li>
</ul>
<blockquote>
<p>kubectl taint node master-01 node-role.kubernetes.io/master=&quot;&quot;:NoExecute
kubectl taint node &ndash;all node-role.kubernetes.io/master-</p>
</blockquote>
<ul>
<li>æ³¨æ„å¤‡ä»½etcd</li>
</ul>
<pre><code>export ETCDCTL_API=3
# å¤‡ä»½
etcdctl snapshot save backup-$(date +%Y%m%d_%H).db
# æ¢å¤
etcdctl snapshot restore backup-xxxx.db --data-dir=/data/etcd/data

</code></pre><ul>
<li>æ›´ç¨³å¦¥çš„æ–¹æ³•åº”è¯¥æ˜¯å…ˆ k8s1.10 -&gt; k8s1.10.13(å°ç‰ˆæœ¬æœ€åä¸€ä¸ªç‰ˆæœ¬) -&gt; k8s1.11.0</li>
</ul>
<h4 id="kubeadmå‡çº§å‡†å¤‡">kubeadmå‡çº§å‡†å¤‡</h4>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.10.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.11.0
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

kubeadm config view &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>

<span class="c1"># k8s1.10ç‰ˆæœ¬è¦æ±‚cniå¿…é¡»æ˜¯ä½äºkubernetes-cni-0.6.0-0ç‰ˆæœ¬</span>
yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$version</span>

<span class="c1"># è¿™é‡Œæ‰§è¡Œä¸ä¼šå‡çº§kubelet</span>
yum install  kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes -y


<span class="c1"># æŸ¥çœ‹æ˜¯å¦å¯ä»¥æ›´æ–°</span>
kubeadm upgrade plan
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
<span class="o">[</span>upgrade<span class="o">]</span> Making sure the cluster is healthy:
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster...
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
I0520 09:32:03.264259   <span class="m">30047</span> feature_gate.go:230<span class="o">]</span> feature gates: <span class="p">&amp;</span><span class="o">{</span>map<span class="o">[]}</span>
<span class="o">[</span>upgrade<span class="o">]</span> Fetching available versions to upgrade to
<span class="o">[</span>upgrade/versions<span class="o">]</span> Cluster version: v1.10.0
<span class="o">[</span>upgrade/versions<span class="o">]</span> kubeadm version: v1.11.0
<span class="o">[</span>upgrade/versions<span class="o">]</span> WARNING: Couldn<span class="s1">&#39;t fetch latest stable version from the internet: unable to get URL &#34;https://dl.k8s.io/release/stable.txt&#34;: Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: dial tcp 34.64.4.80:443: i/o timeout
</span><span class="s1">[upgrade/versions] WARNING: Falling back to current kubeadm version as latest stable version
</span><span class="s1">[upgrade/versions] Latest version in the v1.10 series: v1.10.13
</span><span class="s1">
</span><span class="s1">External components that should be upgraded manually before you upgrade the control plane with &#39;</span>kubeadm upgrade apply<span class="s1">&#39;:
</span><span class="s1">COMPONENT   CURRENT   AVAILABLE
</span><span class="s1">Etcd        3.3.11    3.1.12
</span><span class="s1">
</span><span class="s1">Components that must be upgraded manually after you have upgraded the control plane with &#39;</span>kubeadm upgrade apply<span class="s1">&#39;:
</span><span class="s1">COMPONENT   CURRENT       AVAILABLE
</span><span class="s1">Kubelet     1 x v1.10.1   v1.10.13
</span><span class="s1">
</span><span class="s1">Upgrade to the latest version in the v1.10 series:
</span><span class="s1">
</span><span class="s1">COMPONENT            CURRENT   AVAILABLE
</span><span class="s1">API Server           v1.10.0   v1.10.13
</span><span class="s1">Controller Manager   v1.10.0   v1.10.13
</span><span class="s1">Scheduler            v1.10.0   v1.10.13
</span><span class="s1">Kube Proxy           v1.10.0   v1.10.13
</span><span class="s1">CoreDNS              1.0.6     1.1.3
</span><span class="s1">
</span><span class="s1">You can now apply the upgrade by executing the following command:
</span><span class="s1">
</span><span class="s1"> kubeadm upgrade apply v1.10.13
</span><span class="s1">
</span><span class="s1">_____________________________________________________________________
</span><span class="s1">
</span><span class="s1">External components that should be upgraded manually before you upgrade the control plane with &#39;</span>kubeadm upgrade apply<span class="s1">&#39;:
</span><span class="s1">COMPONENT   CURRENT   AVAILABLE
</span><span class="s1">Etcd        3.3.11    3.2.18
</span><span class="s1">
</span><span class="s1">Components that must be upgraded manually after you have upgraded the control plane with &#39;</span>kubeadm upgrade apply<span class="err">&#39;</span>:
COMPONENT   CURRENT       AVAILABLE
Kubelet     <span class="m">1</span> x v1.10.1   v1.11.0

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.10.0   v1.11.0
Controller Manager   v1.10.0   v1.11.0
Scheduler            v1.10.0   v1.11.0
Kube Proxy           v1.10.0   v1.11.0
CoreDNS              1.0.6     1.1.3

You can now apply the upgrade by executing the following command:

 kubeadm upgrade apply v1.11.0

_____________________________________________________________________


</code></pre></div><h4 id="æ‰§è¡Œå‡çº§æ“ä½œ">æ‰§è¡Œå‡çº§æ“ä½œ</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run


<span class="c1"># ä¿®æ”¹ä¸‹kubeadmin-10-view.confé…ç½® imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth</span>
vim <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth


docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-controller-manager-amd64:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-scheduler-amd64:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-apiserver-amd64:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/coredns:1.1.3


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>

</code></pre></div><h4 id="å‡çº§kubelet-kubectl">å‡çº§kubelet kubectl</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">yum install -y kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes

<span class="c1"># ä¿®æ”¹ä¸‹kubeleté…ç½®(å¦åˆ™é›†ç¾¤ä¼šæŠ¥é”™)</span>
vim /var/lib/kubelet/kubeadm-flags.env
å¢åŠ --pod-infra-container-image<span class="o">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

systemctl daemon-reload
systemctl stop kubelet
systemctl start kubelet
kubectl version
kubelet --version
kubectl get nodes
</code></pre></div><blockquote>
<p>è¿™é‡Œæ‰§è¡Œå®Œ, æˆ‘çš„pod mysqlå’Œredisç­‰æœåŠ¡å™¨å¹¶æ²¡æœ‰è¢«é‡å¯</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.11 -> k8s1.12 </font>
</center>
<h3 id="k8s111---k8s112">k8s1.11 -&gt; k8s1.12</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># åœ¨è¿™ä¹‹å‰å…ˆåœä¸€ä¸‹æŒ‡æ ‡ metrics-server å’Œ prometheus-adapter (æˆ‘è¿™é‡Œä¼šå¯¼è‡´api-serveræ— æ³•å¯åŠ¨æˆåŠŸ,æ‰¾ä¸åˆ°metrics.k8s.io/v1beta1 ç­‰)</span>
kubectl delete -f /data/k8s-config/prometheus/prometheus-adapter 
kubectl delete -f /data/k8s-config/metrics-server/metrics-server-0.3.2/deploy/1.8+/


<span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.11.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.12.0
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

kubeadm config view &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
<span class="c1"># æˆ–è€…é€šè¿‡configmap (æ³¨æ„æ˜¯ ClusterConfiguration)</span>
kubectl get configmap -n kube-system kubeadm-config -o <span class="nv">jsonpath</span><span class="o">={</span>.data.MasterConfiguration<span class="o">}</span> &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$version</span>

yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes


kubeadm upgrade plan
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.11    3.2.24

Upgrade to the latest version in the v1.11 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.11.0   v1.12.0
Controller Manager   v1.11.0   v1.12.0
Scheduler            v1.11.0   v1.12.0
Kube Proxy           v1.11.0   v1.12.0
CoreDNS              1.1.3     1.2.2






<span class="c1">#ä¿®æ”¹imageåœ°å€(ä¹‹å‰æ˜¯registry.cn-hangzhou.aliyuncs.com/k8sth)</span>
vim <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.2
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.2.24

kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


yum install -y kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes

systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes

</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.12 -> k8s1.13 </font>
</center>
<h3 id="k8s112---k8s113">k8s1.12 -&gt; k8s1.13</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">

<span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.12.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.13.0
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

<span class="c1"># é€šè¿‡configmap</span>
kubectl get configmap -n kube-system kubeadm-config -o <span class="nv">jsonpath</span><span class="o">={</span>.data.ClusterConfiguration<span class="o">}</span> &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>

yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$version</span>

yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes

kubeadm upgrade plan
External components that should be upgraded manually before you upgrade the control plane with <span class="s1">&#39;kubeadm upgrade apply&#39;</span>:
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.11    3.2.24

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.12.0   v1.13.0
Controller Manager   v1.12.0   v1.13.0
Scheduler            v1.12.0   v1.13.0
Kube Proxy           v1.12.0   v1.13.0
CoreDNS              1.2.2     1.2.6





kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.2.6

kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>

yum install -y kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> --disableexcludes<span class="o">=</span>kubernetes


systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.13 -> k8s1.14 </font>
</center>
<h3 id="k8s113---k8s114">k8s1.13 -&gt; k8s1.14</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.13.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.14.0
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

<span class="c1"># config viewæˆ–è€…é€šè¿‡configmap(2é€‰1)</span>
kubeadm config view &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
kubectl get configmap -n kube-system kubeadm-config -o <span class="nv">jsonpath</span><span class="o">={</span>.data.ClusterConfiguration<span class="o">}</span> &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$version</span>


<span class="c1"># ä¸€èµ·å®‰è£…æ˜¯å› ä¸ºkubeadmå®‰è£…æ—¶ä¼šä¾èµ–kubelet, kubeletä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬(1.18.2) </span>
<span class="c1"># (è¿™é‡Œ1.14ä¼šä¾èµ–kubernetes-cni:0.7.5-0)</span>
yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>  --disableexcludes<span class="o">=</span>kubernetes


kubeadm upgrade plan


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.14 -> k8s1.15 </font>
</center>
<h3 id="k8s114---k8s115">k8s1.14 -&gt; k8s1.15</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.14.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.15.0
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

<span class="c1"># config viewæˆ–è€…é€šè¿‡configmap(2é€‰1)</span>
kubeadm config view &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
kubectl get configmap -n kube-system kubeadm-config -o <span class="nv">jsonpath</span><span class="o">={</span>.data.ClusterConfiguration<span class="o">}</span> &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

<span class="c1"># ä¸€èµ·å®‰è£…æ˜¯å› ä¸ºkubeadmå®‰è£…æ—¶ä¼šä¾èµ–kubelet, kubeletä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬(1.18.2) </span>
yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>  --disableexcludes<span class="o">=</span>kubernetes

kubeadm upgrade plan

kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8s1.15.0 -> k8s1.15.11 </font>
</center>
<h3 id="k8s1150---k8s11511-é€‰æ‹©11æ˜¯å› ä¸ºgoogle_containerskube-proxyv11512-not-found">k8s1.15.0 -&gt; k8s1.15.11 (é€‰æ‹©11æ˜¯å› ä¸ºgoogle_containers/kube-proxy:v1.15.12 not found)</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ä¿å­˜é…ç½®</span>
<span class="nb">export</span> <span class="nv">k8s_old_version</span><span class="o">=</span>1.15.0
<span class="nb">export</span> <span class="nv">k8s_version</span><span class="o">=</span>1.15.11
<span class="nb">export</span> <span class="nv">kubeadm_config</span><span class="o">=</span>kubeadmin-<span class="si">${</span><span class="nv">k8s_old_version</span><span class="si">}</span>-view.conf

<span class="c1"># config viewæˆ–è€…é€šè¿‡configmap(2é€‰1)</span>
kubeadm config view &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>
kubectl get configmap -n kube-system kubeadm-config -o <span class="nv">jsonpath</span><span class="o">={</span>.data.ClusterConfiguration<span class="o">}</span> &gt; <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>


yum makecache all
<span class="nv">version</span><span class="o">=</span><span class="k">$(</span>yum list kubeadm --showduplicates <span class="p">|</span> sort -r<span class="p">|</span>grep <span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

<span class="c1"># ä¸€èµ·å®‰è£…æ˜¯å› ä¸ºkubeadmå®‰è£…æ—¶ä¼šä¾èµ–kubelet, kubeletä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬(1.18.2) </span>
yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>  --disableexcludes<span class="o">=</span>kubernetes

kubeadm upgrade plan
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.11    3.3.10

COMPONENT            CURRENT   AVAILABLE
API Server           v1.15.0   v1.15.11
Controller Manager   v1.15.0   v1.15.11
Scheduler            v1.15.0   v1.15.11
Kube Proxy           v1.15.0   v1.15.11
CoreDNS              1.3.1     1.3.1

kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>  --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span> --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v<span class="si">${</span><span class="nv">k8s_version</span><span class="si">}</span> --config <span class="si">${</span><span class="nv">kubeadm_config</span><span class="si">}</span>

yum install -y kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>  --disableexcludes<span class="o">=</span>kubernetes

systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
</code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å‡çº§docker </font>
</center>
<h3 id="å‡çº§docker-æ…ç”¨">å‡çº§docker (æ…ç”¨)</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">yum install docker-ce-18.09.9 docker-ce-cli-18.09.9

<span class="c1"># é‡å¯docker, k8sé›†ç¾¤ä¼šé—´æ–­(å¦‚æœæ˜¯å¤šå°, å°†é‡å¯çš„èŠ‚ç‚¹taintå‰”é™¤é›†ç¾¤é‡å¯å³å¯)</span>
service docker restart

</code></pre></div><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å‡çº§å•æœºç‰ˆrancher </font>
</center>
<h3 id="å‡çº§å•æœºç‰ˆrancher">å‡çº§å•æœºç‰ˆrancher</h3>
<blockquote>
<p>è¿™é‡Œä¹‹å‰æ˜¯2.1.9ç‰ˆæœ¬, æ›´æ–°ä¸ºstable(2.4.3) ,æˆ‘è¿™é‡Œrancheråªæ˜¯ç”¨å¯¼å…¥æ–¹å¼,rancherå®•æœºä¸å½±å“k8sé›†ç¾¤</p>
</blockquote>
<ol>
<li>é¦–å…ˆå°†swarmå¯åŠ¨çš„rancheråœç”¨:
<code>docker service rm rancher_rancher</code></li>
<li>å…¶æ¬¡å°†dataç›®å½•å¤‡ä»½
<code>cp -ra /data/rancher /data/rancher_2.1.9_2020-05-20_bak</code></li>
<li>ä¿®æ”¹docker-compose.ymlé‡æ–°å¯åŠ¨
<code>docker stack deploy -c docker-compose.yml rancher</code></li>
<li>æŸ¥çœ‹æ—¥å¿—
<code>docker logs -f $(docker ps|grep rancher_rancher|awk '{print $1}')</code></li>
<li>æ¢å¤(åœæ­¢æœåŠ¡,å°†å¤‡ä»½çš„ç›®å½•è¿˜åŸé‡æ–°å¯åŠ¨å³å¯)</li>
</ol>
<ul>
<li>docker-compose.yml</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">rancher</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">rancher</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">rancher/rancher:stable</span><span class="w">
</span><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">restart_policy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">failure</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">/data/rancher/data/:/var/lib/rancher/</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">10080</span><span class="p">:</span><span class="m">80</span><span class="w">
</span><span class="w">      </span>- <span class="m">10443</span><span class="p">:</span><span class="m">443</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">rancher_net</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">rancher_net</span><span class="p">:</span><span class="w">
</span></code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> é—®é¢˜ </font>
</center>
<hr>
<h3 id="é—®é¢˜">é—®é¢˜</h3>
<h4 id="1-ç‰ˆæœ¬é€‰æ‹©çš„imageé…ç½®é—®é¢˜">1. ç‰ˆæœ¬é€‰æ‹©çš„imageé…ç½®é—®é¢˜</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">å¼€å§‹é€‰æ‹©å‡çº§åˆ°k8s1.11.10ç‰ˆæœ¬, ä½†æ˜¯é•œåƒç‰ˆæœ¬åªæœ‰registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1.11.0 , æ²¡æœ‰æ‰¾åˆ°v1.11.10
</code></pre></div><h4 id="2-112ç‰ˆæœ¬å¼€å§‹é˜¿é‡Œäº‘é•œåƒåœ°å€å˜åŒ–">2. 1.12ç‰ˆæœ¬å¼€å§‹é˜¿é‡Œäº‘é•œåƒåœ°å€å˜åŒ–</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.12.0
registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

</code></pre></div><h4 id="3-å¦‚æœæ‰§è¡Œå‡çº§ä¸­æ–­æˆ–åœæ­¢-å¯ä»¥">3. å¦‚æœæ‰§è¡Œå‡çº§ä¸­æ–­æˆ–åœæ­¢, å¯ä»¥</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubeadm upgrade --forceã€‚
</code></pre></div><h4 id="4-å¦‚æœè·¨ç‰ˆæœ¬å‡çº§">4. å¦‚æœè·¨ç‰ˆæœ¬å‡çº§</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"> - Specified version to upgrade to <span class="s2">&#34;v1.16.2&#34;</span> is too high<span class="p">;</span> kubeadm can upgrade only <span class="m">1</span> minor version at a <span class="nb">time</span>
 - Specified version to upgrade to <span class="s2">&#34;v1.16.2&#34;</span> is at least one minor release higher than the kubeadm minor release <span class="o">(</span><span class="m">16</span> &gt; 11<span class="o">)</span>. Such an upgrade is not supported
</code></pre></div><h4 id="5-k8s111-å¼€å¯ä½¿ç”¨äº†pause31">5. k8s1.11 å¼€å¯ä½¿ç”¨äº†pause:3.1</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">k8s1.11å¼€å§‹kubeletçš„é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸º:
vim /var/lib/kubelet/kubeadm-flags.env
å¢åŠ --pod-infra-container-image<span class="o">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

</code></pre></div><h4 id="6-åœ¨112-113å‡çº§å®ŒæˆåæŠ¥é”™-openapi-spec-for-v1beta1metricsk8sio-failed-with-openapi-spec-does-not-exists">6. åœ¨1.12-&gt;1.13å‡çº§å®ŒæˆåæŠ¥é”™: OpenAPI spec for &ldquo;v1beta1.metrics.k8s.io&rdquo; failed with: OpenAPI spec does not exists</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 1.11 -&gt; 1.12 k8s_kube-apiserveræ—¥å¿—</span>
E0520 06:21:09.369346       <span class="m">1</span> memcache.go:134<span class="o">]</span> couldn<span class="s1">&#39;t get resource list for crd.projectcalico.org/v1: the server could not find the requested resource
</span><span class="s1">E0520 06:21:09.369725       1 memcache.go:134] couldn&#39;</span>t get resource list <span class="k">for</span> authentication.istio.io/v1alpha1: the server could not find the requested resource
E0520 06:21:09.370842       <span class="m">1</span> memcache.go:134<span class="o">]</span> couldn<span class="s1">&#39;t get resource list for certmanager.k8s.io/v1alpha1: the server could not find the requested resource
</span><span class="s1">E0520 06:21:09.371925       1 memcache.go:134] couldn&#39;</span>t get resource list <span class="k">for</span> rbac.istio.io/v1alpha1: the server could not find the requested resource
E0520 06:21:09.373016       <span class="m">1</span> memcache.go:134<span class="o">]</span> couldn<span class="s1">&#39;t get resource list for config.istio.io/v1alpha2: the server could not find the requested resource
</span><span class="s1">E0520 06:21:09.374083       1 memcache.go:134] couldn&#39;</span>t get resource list <span class="k">for</span> networking.istio.io/v1alpha3: the server could not find the requested resource
E0520 06:21:09.375179       <span class="m">1</span> memcache.go:134<span class="o">]</span> couldn<span class="err">&#39;</span>t get resource list <span class="k">for</span> metrics.k8s.io/v1beta1: the server could not find the requested resource

<span class="c1"># 1.12-&gt;1.13 k8s_kube-apiserveræ—¥å¿—</span>
OpenAPI spec <span class="k">for</span> <span class="s2">&#34;v1beta1.metrics.k8s.io&#34;</span> failed with: OpenAPI spec does not exists

åŸå› æ˜¯æˆ‘è¿™è¾¹metrics-server å’Œprometheus-adapter éƒ¨ç½²çš„æ—¶å€™ç”¨åˆ°äº†metrics.k8s.io/v1beta1
ä½†æ˜¯å‡çº§ä¹‹åè¿™ä¸ªapi-versionä¸¢å¤±äº†, æ‰€ä»¥å¯¼è‡´apiserverä¸€ç›´æŠ¥é”™, æ— æ³•å¯åŠ¨æˆåŠŸ


</code></pre></div><h4 id="7-å•æœºk8så‡çº§ä¼šé€ æˆæœåŠ¡ä¸­æ–­">7. å•æœºk8så‡çº§ä¼šé€ æˆæœåŠ¡ä¸­æ–­</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 1.10 ~ 1.13</span>
å‡çº§ä¼šå¯¼è‡´æ ¸å¿ƒç»„ä»¶apiserver,scheduler,controller,coredns,ç½‘ç»œcalicoç­‰ç”±äºç‰ˆæœ¬å‡çº§éƒ½éœ€è¦é‡æ–°å¯åŠ¨äº†ä¸€æ¬¡, éƒ¨åˆ†å…¶ä»–ä¸šåŠ¡podä¹Ÿä¼šé‡å¯
å…¶ä¸­nodejsæœåŠ¡ä¼špm2é‡å¯,mysqlç­‰ä¹Ÿä¼šé‡å¯ ,ä¼šå¯¼è‡´æœåŠ¡å™¨å‹åŠ›ä¸Šå‡
è¿™é‡Œæ£€æµ‹åˆ°æœ‰çŠ¶æ€statefulsetçš„æœåŠ¡å¹¶æ²¡æœ‰é‡å¯, è€Œæ— çŠ¶æ€çš„deploymentä¼šé‡å¯, ç”±äºå•æœº1ä¸ªpodçš„æœåŠ¡é‡å¯ä¼šå¯¼è‡´ä¸­æ–­
æ‰€ä»¥é¿å…ä¸šåŠ¡ä¸­æ–­å¿…é¡»æ˜¯å¤šä¸»æœºé›†ç¾¤, åœ¨å‡çº§ä¹‹å‰å…ˆtaintæœºå™¨å‡çº§

<span class="c1"># 1.13 -&gt; 1.14</span>
è¿™æœŸé—´æœ‰çŠ¶æ€statefulsetçš„æœåŠ¡ä¹Ÿé‡å¯äº†

<span class="c1"># 1.14 ~ 1.15.11</span>
è¿™æœŸé—´æœ‰çŠ¶æ€statefulsetçš„æœåŠ¡æ²¡æœ‰é‡å¯

</code></pre></div><h4 id="8-æ³¨æ„113-114çš„æ—¶å€™å®‰è£…kubeadmå¯èƒ½ä¼šä¾èµ–kubeletè‡ªåŠ¨å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬">8. æ³¨æ„1.13-&gt;1.14çš„æ—¶å€™å®‰è£…kubeadmå¯èƒ½ä¼šä¾èµ–kubeletè‡ªåŠ¨å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ä¸€èµ·å®‰è£…æ˜¯å› ä¸ºkubeadmå®‰è£…æ—¶ä¼šä¾èµ–kubelet, kubeletä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬(1.18.2) </span>
<span class="c1"># (è¿™é‡Œ1.14ä¼šä¾èµ–kubernetes-cni:0.7.5-0)</span>
yum install -y kubeadm-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubelet-<span class="si">${</span><span class="nv">version</span><span class="si">}</span> kubectl-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>  --disableexcludes<span class="o">=</span>kubernetes

</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>k8så®‰è£…promethues&#43;alertmanager&#43;grafana</title>
			<link>https://www.ngirl.xyz/posts/47-k8s%E5%AE%89%E8%A3%85promethues-alertmanager-grafana/</link>
			<pubDate>Thu, 14 May 2020 18:34:47 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/47-k8s%E5%AE%89%E8%A3%85promethues-alertmanager-grafana/</guid>
			<description>æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹prometheus ç®€å•éƒ¨ç½² , è€ƒè™‘åˆ°æµ‹è¯•èµ„æºæœ‰é™,ä¸ºæ›´ç²¾ç®€è‡ªå®šä¹‰æŒ‰ç…§ç›‘æ§,å‡å°‘å¤šä½™èµ„æºå ç”¨, ä¹ŸåŒæ—¶æ›´äº†è§£prometheusçš„æ›´å¤šç»†èŠ‚, è¿™é‡Œæ²¡æœ‰ä½¿ç”¨prometheus-operator
 1 K8sä¸Šéƒ¨ç½²åŸç”Ÿçš„prometheus 2 prometheus-operator æ–¹å¼éƒ¨ç½² 3 docker-composeå¿«é€Ÿæ­å»º Prometheus+Grafanaç›‘æ§ç³»ç»Ÿ 4 ä¸€å¥—prometheusç›‘æ§å¤šä¸ªk8sé›†ç¾¤,è¯¦ç»†è®²è§£é…ç½® 5 ä½¿ç”¨prometheusç›‘æ§traefikã€redisã€k8sé›†ç¾¤å„èŠ‚ç‚¹ã€å„èŠ‚ç‚¹kubelet 6 grafana ç›‘æ§æ¨¡æ¿ä¸‹è½½     æ­å»ºprometheus åˆ›å»ºns tee ns.yml &amp;lt;&amp;lt;- EOF apiVersion: v1 kind: Namespace metadata: name: monitoring EOF kubectl apply -f ns.yml prometheus-clusterRole.yml tee prometheus-clusterRole.yml &amp;lt;&amp;lt;- EOF apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: prometheus-k8s rules: - apiGroups: - &amp;quot;&amp;quot; resources: - nodes/metrics verbs: - get - nonResourceURLs: - /metrics verbs: - get EOF prometheus-clusterRoleBinding.</description>
			<content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹prometheus ç®€å•éƒ¨ç½² , è€ƒè™‘åˆ°æµ‹è¯•èµ„æºæœ‰é™,ä¸ºæ›´ç²¾ç®€è‡ªå®šä¹‰æŒ‰ç…§ç›‘æ§,å‡å°‘å¤šä½™èµ„æºå ç”¨, ä¹ŸåŒæ—¶æ›´äº†è§£prometheusçš„æ›´å¤šç»†èŠ‚, è¿™é‡Œæ²¡æœ‰ä½¿ç”¨prometheus-operator</p>
<!-- more -->
<ul>
<li>1 <a href="https://juejin.im/post/5d4ac8e9f265da03e921b463">K8sä¸Šéƒ¨ç½²åŸç”Ÿçš„prometheus</a></li>
<li>2 <a href="https://www.qikqiak.com/post/first-use-prometheus-operator/">prometheus-operator æ–¹å¼éƒ¨ç½²</a></li>
<li>3 <a href="https://blog.51cto.com/msiyuetian/2369130">docker-composeå¿«é€Ÿæ­å»º Prometheus+Grafanaç›‘æ§ç³»ç»Ÿ</a></li>
<li>4 <a href="https://jeremy-xu.oschina.io/2018/11/%E4%BD%BF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E5%A4%9Ak8s%E9%9B%86%E7%BE%A4/">ä¸€å¥—prometheusç›‘æ§å¤šä¸ªk8sé›†ç¾¤,è¯¦ç»†è®²è§£é…ç½®</a></li>
<li>5 <a href="https://blog.csdn.net/ywq935/article/details/80847161">ä½¿ç”¨prometheusç›‘æ§traefikã€redisã€k8sé›†ç¾¤å„èŠ‚ç‚¹ã€å„èŠ‚ç‚¹kubelet</a></li>
<li>6 <a href="https://grafana.com/grafana/dashboards?dataSource=prometheus&amp;search=docker&amp;orderBy=name&amp;direction=asc">grafana ç›‘æ§æ¨¡æ¿ä¸‹è½½</a></li>
</ul>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="æ­å»ºprometheus">æ­å»ºprometheus</h3>
<h4 id="åˆ›å»ºns">åˆ›å»ºns</h4>
<pre><code>tee ns.yml &lt;&lt;- EOF
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
EOF


kubectl apply -f ns.yml

</code></pre><h4 id="prometheus-clusterroleyml">prometheus-clusterRole.yml</h4>
<pre><code>tee prometheus-clusterRole.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-k8s
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/metrics
    verbs:
      - get
  - nonResourceURLs:
      - /metrics
    verbs:
      - get
EOF
</code></pre><h4 id="prometheus-clusterrolebindingyml">prometheus-clusterRoleBinding.yml</h4>
<pre><code>tee prometheus-clusterRoleBinding.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-k8s
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-k8s
subjects:
  - kind: ServiceAccount
    name: prometheus-k8s
    namespace: monitoring
EOF
</code></pre><h4 id="prometheus-serviceaccountyml">prometheus-serviceAccount.yml</h4>
<pre><code>tee prometheus-serviceAccount.yml &lt;&lt;- EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-k8s
  namespace: monitoring
EOF
</code></pre><h4 id="åˆ›å»ºè§’è‰²">åˆ›å»ºè§’è‰²</h4>
<pre><code>kubectl apply -f prometheus-clusterRole.yml
kubectl apply -f prometheus-clusterRoleBinding.yml
kubectl apply -f prometheus-serviceAccount.yml

</code></pre><blockquote>
<p>è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†ä¸€ä¸ª ServiceAccountï¼Œåä¸º prometheus-k8sï¼Œè¿™ä¸ª ServiceAccount ä¸ä»…ç°åœ¨å¯ä»¥ç”¨æ¥è·å– kubelet çš„ç›‘æ§æŒ‡æ ‡ï¼Œåç»­ Prometheus ä¹Ÿä¼šä½¿ç”¨è¿™ä¸ª serviceAccount å¯åŠ¨ã€‚</p>
</blockquote>
<h4 id="åˆ›å»ºå®Œæˆåä¼šè‡ªåŠ¨åœ¨ç”Ÿæˆä¸€ä¸ª-secreté‡Œé¢åŒ…å«äº†-token">åˆ›å»ºå®Œæˆåï¼Œä¼šè‡ªåŠ¨åœ¨ç”Ÿæˆä¸€ä¸ª secretï¼Œé‡Œé¢åŒ…å«äº† tokenï¼š</h4>
<pre><code>kubectl get secret -n monitoring
NAME                         TYPE                                  DATA      AGE
prometheus-k8s-token-6v9m9   kubernetes.io/service-account-token   3         13s
</code></pre><h4 id="è·å–token">è·å–token</h4>
<pre><code>token=$(kubectl get secret prometheus-k8s-token-6v9m9 -n monitoring -o json|jq -r '.data.token'|base64 -d)
token=$(kubectl get secret prometheus-k8s-token-pl2wx -n monitoring -o json|jq -r '.data.token'|base64 -d)
</code></pre><h4 id="é€šè¿‡tokenæŸ¥çœ‹metrics">é€šè¿‡tokenæŸ¥çœ‹metrics</h4>
<pre><code>curl https://127.0.0.1:10250/metrics/cadvisor -k -H &quot;Authorization: Bearer $token&quot;
</code></pre><blockquote>
<p>kubelet é™¤äº† /metrics/cadvisor è¿™ä¸ª url ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª /metricsï¼Œè¿™æ˜¯å®ƒæœ¬èº«çš„ç›‘æ§æŒ‡æ ‡è€Œé pod çš„</p>
</blockquote>
<h3 id="æŸ¥çœ‹etcæŒ‡æ ‡é¡µé¢">æŸ¥çœ‹etcæŒ‡æ ‡é¡µé¢</h3>
<p>etcd çš„æŒ‡æ ‡é¡µé¢çš„ url ä¹Ÿæ˜¯ /metricsï¼Œä½†æ˜¯ä½ æƒ³è¦è®¿é—®å®ƒéœ€è¦æä¾›è¯ä¹¦ï¼Œå› ä¸ºå®ƒä¼šéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚å½“ç„¶ä½ å¯ä»¥åœ¨å®ƒçš„å¯åŠ¨å‚æ•°ä¸­é€šè¿‡ &ndash;listen-metrics-urls http://ip:port è®©ç›‘æ§æŒ‡æ ‡é¡µä½¿ç”¨ http è€Œé httpsï¼Œè¿™æ ·å°±ä¸ç”¨æä¾›è¯ä¹¦äº†ã€‚
etcd è™½ç„¶éƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº† hostNetworkï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—® master çš„ 2379 ç«¯å£è®¿é—®å®ƒã€‚é»˜è®¤å®ƒä¼šé‡‡ç”¨äº† httpsï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æä¾›å®ƒçš„ peer è¯ä¹¦ã€‚å¦‚æœ k8s æ˜¯ä½¿ç”¨ kubeadm å®‰è£…çš„ï¼Œetcd çš„è¯ä¹¦åœ¨ /etc/kubernetes/pki/etcd/ ç›®å½•ä¸‹ã€‚
å› æ­¤è®¿é—® etcd çš„å‘½ä»¤ä¸ºï¼š
curl https://127.0.0.1:2379/metrics &ndash;cacert /etc/kubernetes/pki/etcd/ca.crt &ndash;cert /etc/kubernetes/pki/etcd/healthcheck-client.crt &ndash;key /etc/kubernetes/pki/etcd/healthcheck-client.key
å¤åˆ¶ä»£ç åé¢æˆ‘ä»¬éœ€è¦å°†è¿™ä¸‰ä¸ªæ–‡ä»¶æŒ‚è½½åˆ° Prometheus å®¹å™¨ä¸­ï¼Œä»¥ä¾¿å®ƒèƒ½æ”¶é›† etcd ç›‘æ§æ•°æ®ã€‚</p>
<p>å¦‚æœä½ å¹¶éå®¹å™¨éƒ¨ç½²çš„etcd,è¯·ä½¿ç”¨ä½ çš„etcdç«¯å£è®¿é—®</p>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å®‰è£…-prometheus">å®‰è£… Prometheus</h3>
<h4 id="æˆ‘ä»¬å…ˆåˆ›å»ºä¸¤ä¸ª-configmapä¸€ä¸ªæ˜¯-prometheus-çš„é…ç½®æ–‡ä»¶å¦ä¸€ä¸ªæ˜¯å‘Šè­¦çš„è§„åˆ™æ–‡ä»¶">æˆ‘ä»¬å…ˆåˆ›å»ºä¸¤ä¸ª configmapï¼Œä¸€ä¸ªæ˜¯ Prometheus çš„é…ç½®æ–‡ä»¶ï¼Œå¦ä¸€ä¸ªæ˜¯å‘Šè­¦çš„è§„åˆ™æ–‡ä»¶</h4>
<pre><code>tee prometheus-configmap.yml &lt;&lt;- EOF
apiVersion: v1
data:
  prometheus.yml: |
    global:
      evaluation_interval: 30s
      scrape_interval: 30s
      external_labels:
        prometheus: monitoring/k8s
    rule_files:
    - /etc/prometheus/rules/*.yml
    scrape_configs:
    - job_name: prometheus
      honor_labels: false
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - monitoring
      scrape_interval: 30s
      relabel_configs:
      - action: keep
        source_labels:
        - __meta_kubernetes_service_label_prometheus
        regex: k8s
      - source_labels:
        - __meta_kubernetes_endpoint_address_target_kind
        - __meta_kubernetes_endpoint_address_target_name
        separator: ;
        regex: Pod;(.*)
        replacement: ${1}
        target_label: pod
      - source_labels:
        - __meta_kubernetes_namespace
        target_label: namespace
      - source_labels:
        - __meta_kubernetes_service_name
        target_label: service
      - source_labels:
        - __meta_kubernetes_pod_name
        target_label: pod
      - source_labels:
        - __meta_kubernetes_service_name
        target_label: job
        replacement: ${1}
      - target_label: endpoint
        replacement: web
kind: ConfigMap
metadata:
  name: prometheus
  namespace: monitoring
EOF
</code></pre><blockquote>
<p>é¦–å…ˆçœ‹è¿™æ®µé…ç½®</p>
</blockquote>
<pre><code>kubernetes_sd_configs:
- role: endpoints
  namespaces:
    names:
    - monitoring
scrape_interval: 30s
</code></pre><p>è¿™æ®µé…ç½®ä½¿ç”¨çš„æ˜¯ endpoint çš„æ–¹å¼å¯¹ Prometheus æœ¬èº«è¿›è¡Œè‡ªåŠ¨å‘ç°ï¼Œä½ å¯ä»¥æœ‰ç–‘é—®äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å¯¹è‡ªèº«çš„ 127.0.0.1:9090 è¿›è¡Œé‡‡é›†å‘¢ï¼Ÿå› ä¸ºè€ƒè™‘åˆ° Prometheus å¯èƒ½ä¼šæœ‰å¤šå°ï¼Œè¿™æ ·å³ä½¿æœ‰å¤šå°ï¼Œå®ƒä»¬ä¹Ÿéƒ½åœ¨ä¸€ä¸ª job ä¸‹é¢ã€‚</p>
<p>kubernetes_sd_configs é…ç½®å¯ä»¥è‡ªåŠ¨å‘ç° k8s ä¸­ nodeã€serviceã€podã€endpointã€ingressï¼Œå¹¶ä¸ºå…¶æ·»åŠ ç›‘æ§, è¯¦è§:  <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">kubernetes_sd_configså®˜æ–¹æ–‡æ¡£</a></p>
<blockquote>
<p>å†çœ‹ä¸‹é¢è¿™æ®µé…ç½®</p>
</blockquote>
<pre><code>- action: keep
  source_labels:
    - __meta_kubernetes_service_label_prometheus
  regex: k8s
</code></pre><p>è¡¨ç¤ºå¹¶éæ‰€æœ‰çš„endpoint éƒ½ä¼šè¢«æŠ“å–,  è¿™é‡ŒåªæŠ“å–label æ˜¯ prometheus=k8sçš„æ ‡ç­¾, æ‰€ä»¥åªä¼šç›‘æ§prometheusçš„endpoint</p>
<p>é»˜è®¤ä¸æŒ‡å®šurl å°±æ˜¯/metrics</p>
<blockquote>
<p>æ¥ç€çœ‹è¿™æ®µé…ç½®</p>
</blockquote>
<pre><code>- source_labels:
    - __meta_kubernetes_endpoint_address_target_kind
    - __meta_kubernetes_endpoint_address_target_name
  separator: ;
  regex: Pod;(.*)
  replacement: ${1}
  target_label: pod

</code></pre><p>å¦‚æœ __meta_kubernetes_endpoint_address_target_kind çš„å€¼ä¸º Podï¼Œ__meta_kubernetes_endpoint_address_target_name çš„å€¼ä¸º prometheus-0ï¼Œåœ¨å®ƒä»¬ä¹‹é—´åŠ ä¸Šä¸€ä¸ª ; ä¹‹åï¼Œå®ƒä»¬åˆèµ·æ¥å°±æ˜¯ Pod;prometheus-0ã€‚ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ Pod;(.*) å¯¹å…¶è¿›è¡ŒåŒ¹é…ï¼Œé‚£ä¹ˆ ${1} å°±æ˜¯å–ç¬¬ä¸€ä¸ªåˆ†ç»„ï¼Œå®ƒå€¼å°±æ˜¯ prometheus-0ï¼Œæœ€åå°†è¿™ä¸ªå€¼äº¤ç»™ pod è¿™ä¸ªæ ‡ç­¾ã€‚
å› æ­¤è¿™ä¸€æ®µé…ç½®å°±æ˜¯ä¸ºæ‰€æœ‰é‡‡é›†åˆ°çš„ç›‘æ§æŒ‡æ ‡å¢åŠ ä¸€ä¸ª pod=prometheus-0 çš„æ ‡ç­¾ã€‚</p>
<blockquote>
<p>ä»¥ä¸Šé…ç½®å…¶å®å¯ä»¥å»æ‰, è¿™é‡Œprometheus=k8sçš„åŒ¹é…æ¡ä»¶ä»¥åŠå”¯ä¸€,è¿™æ®µkindå’Œnameé…ç½®å»æ‰å½±å“ä¸å¤§</p>
</blockquote>
<h4 id="åˆ›å»ºconfigmap">åˆ›å»ºconfigmap</h4>
<pre><code>kubectl apply -f prometheus-configmap.yml
</code></pre><h4 id="prometheus-è§„åˆ™æ–‡ä»¶-åé¢ä¼šæ›´æ–°">Prometheus è§„åˆ™æ–‡ä»¶ (åé¢ä¼šæ›´æ–°)</h4>
<pre><code>tee prometheus-config-rulefiles.yml &lt;&lt;- EOF
apiVersion: v1
data:
  k8s.yml: &quot;&quot;
kind: ConfigMap
metadata:
  name: prometheus-rulefiles
  namespace: monitoring
EOF


kubectl apply -f prometheus-config-rulefiles.yml

</code></pre><h3 id="role-å’Œ-rolebinding">role å’Œ roleBinding</h3>
<p>å› ä¸º Prometheus ä¼šä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„ saï¼ˆserviceAccountï¼‰prometheus-k8s è¿è¡Œï¼Œé‚£ä¹ˆå…‰ç°åœ¨ prometheus-k8s è¿™ä¸ª sa çš„æƒé™æ˜¯æ²¡æœ‰åŠæ³•æŸ¥çœ‹ service ä»¥åŠ endpoint çš„ã€‚
æˆ‘ä»¬ä½¿ç”¨ kubernetes_sd_config ä¸»è¦ä¼šä½¿ç”¨ endpoint è¿›è¡Œå‘ç°ï¼Œå› æ­¤ prometheus-k8s å¿…é¡»å…·å¤‡æ›´å¤šçš„æƒé™ã€‚
æˆ‘ä»¬éœ€è¦åˆ›å»ºæ›´å¤šçš„ roleï¼Œå¹¶é€šè¿‡ roleBinding å°†è¿™äº›æƒé™ç»‘å®šåˆ° prometheus-k8s è¿™ä¸ª sa ä¸Šï¼Œä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ clusterRole æ˜¯ä¸ºäº†æƒé™æœ€å°åŒ–ã€‚
è¿™é‡Œä¼šåˆ›å»º prometheus-roleConfig.ymlã€prometheus-roleBindingConfig.ymlã€prometheus-roleSpecificNamespaces.ymlã€prometheus-roleBindingSpecificNamespaces.yml è¿™å››ä¸ªæ–‡ä»¶ï¼Œå®ƒä»¬çš„å†…å®¹å¦‚ä¸‹ã€‚</p>
<pre><code>tee prometheus-roleConfig.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-k8s-config
  namespace: monitoring
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    verbs:
      - get
EOF


tee prometheus-roleBindingConfig.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prometheus-k8s-config
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s-config
subjects:
  - kind: ServiceAccount
    name: prometheus-k8s
    namespace: monitoring
EOF

tee prometheus-roleSpecificNamespaces.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleList
items:
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: prometheus-k8s
      namespace: default
    rules:
      - apiGroups:
          - &quot;&quot;
        resources:
          - services
          - endpoints
          - pods
        verbs:
          - get
          - list
          - watch
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: prometheus-k8s
      namespace: kube-system
    rules:
      - apiGroups:
          - &quot;&quot;
        resources:
          - services
          - endpoints
          - pods
        verbs:
          - get
          - list
          - watch
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: prometheus-k8s
      namespace: monitoring
    rules:
      - apiGroups:
          - &quot;&quot;
        resources:
          - services
          - endpoints
          - pods
        verbs:
          - get
          - list
          - watch
EOF

tee prometheus-roleBindingSpecificNamespaces.yml &lt;&lt;- EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBindingList
items:
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: prometheus-k8s
      namespace: default
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: prometheus-k8s
    subjects:
      - kind: ServiceAccount
        name: prometheus-k8s
        namespace: monitoring
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: prometheus-k8s
      namespace: kube-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: prometheus-k8s
    subjects:
      - kind: ServiceAccount
        name: prometheus-k8s
        namespace: monitoring
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: prometheus-k8s
      namespace: monitoring
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: prometheus-k8s
    subjects:
      - kind: ServiceAccount
        name: prometheus-k8s
        namespace: monitoring
EOF

</code></pre><p>ä¸Šé¢çš„æƒé™ä¸­ï¼Œconfig æ˜¯ç”¨æ¥è¯» configmap çš„ï¼Œåé¢çš„å°±æ˜¯ Prometheus ç”¨æ¥è¿›è¡Œ k8s å‘ç°æ—¶å¿…é¡»è¦çš„æƒé™äº†ï¼Œæœ€åä½¿ç”¨ rulebinding å°†è¿™äº›æ‰€æœ‰çš„æƒé™éƒ½ç»‘å®šåˆ° prometheus-k8s è¿™ä¸ª sa ä¸Šã€‚</p>
<pre><code>kubectl delete -f prometheus-roleBindingConfig.yml
kubectl delete -f prometheus-roleBindingSpecificNamespaces.yml
kubectl delete -f prometheus-roleConfig.yml
kubectl delete -f prometheus-roleSpecificNamespaces.yml


kubectl apply -f prometheus-roleBindingConfig.yml
kubectl apply -f prometheus-roleBindingSpecificNamespaces.yml
kubectl apply -f prometheus-roleConfig.yml
kubectl apply -f prometheus-roleSpecificNamespaces.yml

</code></pre><h4 id="æ‰‹åŠ¨åˆ›å»ºpv-æˆ‘è¿™é‡Œæ²¡ç”¨ä¸Š-ç”¨çš„æ˜¯storageclass">æ‰‹åŠ¨åˆ›å»ºpv (æˆ‘è¿™é‡Œæ²¡ç”¨ä¸Š, ç”¨çš„æ˜¯storageclass)</h4>
<pre><code>tee prometheus-pv.yml &lt;&lt;- EOF
apiVersion: v1
kind: PersistentVolume
metadata:
  name: prometheus
  labels:
    name: prometheus
spec:
  nfs:
    path: /disk/k8s-nfs-data/k8s-db-t/prometheus
    server: 172.16.xx.xx
  accessModes: [&quot;ReadWriteMany&quot;, &quot;ReadWriteOnce&quot;]
  capacity:
    storage: 50Gi
EOF

kubectl apply -f prometheus-pv.yml

</code></pre><h4 id="åˆ›å»º-service">åˆ›å»º service</h4>
<pre><code>tee prometheus-service.yml &lt;&lt;- EOF
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    prometheus: k8s
spec:
  clusterIP: None
  ports:
    - name: web
      port: 9090
      protocol: TCP
      targetPort: web
  selector:
    app: prometheus
  type: ClusterIP

EOF

kubectl apply -f prometheus-service.yml
</code></pre><p>è¿™é‡Œserviceå®šä¹‰äº† app=prometheus è¿™æ ·çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå› æ­¤ Prometheus å®¹å™¨StatefulSetçš„æ—¶å€™å¿…é¡»å­˜åœ¨è¿™ä¸ªæ ‡ç­¾ã€‚</p>
<h4 id="éƒ¨ç½²-prometheus">éƒ¨ç½² Prometheus</h4>
<pre><code>tee prometheus-statefulset.yml &lt;&lt;- EOF
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
    prometheus: k8s
  name: prometheus
  namespace: monitoring
spec:
  replicas: 1
  volumeClaimTemplates:
  - metadata:
      name: prometheus-data
      annotations:
        volume.beta.kubernetes.io/storage-class: &quot;nfs-retain&quot; # è¿™é‡Œé…ç½® ä¸Šé¢åˆ›å»ºçš„ storageclass çš„åç§°
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 20Gi
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: prometheus
      prometheus: k8s
  serviceName: prometheus
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: prometheus
        prometheus: k8s
    spec:
      serviceAccount: prometheus-k8s
      containers:
        - args:
            - --web.console.templates=/etc/prometheus/consoles
            - --web.console.libraries=/etc/prometheus/console_libraries
            - --config.file=/etc/prometheus/config/prometheus.yml
            - --storage.tsdb.path=/prometheus
            - --web.enable-admin-api
            - --storage.tsdb.retention.time=20d
            - --web.enable-lifecycle
            - --storage.tsdb.no-lockfile
            - --web.external-url=http://promethes-dev.k1s.club/
            - --web.route-prefix=/
          image: prom/prometheus:v2.11.1
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /-/healthy
              port: web
              scheme: HTTP
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          name: prometheus
          ports:
            - containerPort: 9090
              name: web
              protocol: TCP
          readinessProbe:
            failureThreshold: 120
            httpGet:
              path: /-/ready
              port: web
              scheme: HTTP
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            requests:
              memory: 400Mi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /etc/prometheus/config
              name: config
              readOnly: true
            - mountPath: /prometheus
              name: prometheus-data
              #subPath: prometheus-db
            - mountPath: /etc/prometheus/rules/
              name: prometheus-rulefiles
            - mountPath: /etc/prometheus/secrets/etcd-client-cert
              name: secret-etcd-client-cert
              readOnly: true
      volumes:
        - name: config
          configMap:
            defaultMode: 420
            name: prometheus
        - name: prometheus-rulefiles
          configMap:
            defaultMode: 420
            name: prometheus-rulefiles
        - name: secret-etcd-client-cert
          secret:
            defaultMode: 420
            secretName: etcd-client-cert

EOF

kubectl apply -f prometheus-statefulset.yml
</code></pre><blockquote>
<p>æ³¨æ„ä¸‹è¿™é‡Œå¦‚æœä½ å¹¶éå®¹å™¨å®‰è£…çš„etcd, åˆ™mountçš„secret-etcd-client-certå¯èƒ½ä¸å­˜åœ¨, è¯·è‡ªè¡ŒæŒ‚è½½æ­£ç¡®çš„ç›®å½•, å¦‚æœetcdæ˜¯httpè®¿é—®, åˆ™ä¸éœ€è¦è¯ä¹¦æŒ‚è½½</p>
</blockquote>
<p>åŸºç¡€çš„ statfulset ç›¸å…³çš„çŸ¥è¯†æˆ‘å°±ä¸å¤šæäº†ï¼Œè¯´å‡ ä¸ªé‡ç‚¹å§ï¼š</p>
<p>1 &ndash;storage.tsdb.retention.time=20d è¿™ä¸ªå¯åŠ¨é€‰é¡¹è¡¨ç¤º Prometheus æ‰€æ”¶é›†çš„ç›‘æ§æ•°æ®åªä¿ç•™ 20 å¤©ï¼Œè¿™ä¸ªå€¼æœ€å¥½ä¸è¦å¤ªå¤§ã€‚å¦‚æœå†å²æ•°æ®ä¿å­˜å¾ˆä¹…ï¼Œå»ºè®®å†™åˆ°æŒä¹…å­˜å‚¨ä¸­ï¼Œæ¯”å¦‚ VictoriaMetricsã€thanosã€influxdbã€opentsdb ç­‰ï¼›
2 &ndash;web.enable-admin-api è¿™ä¸ªå¯åŠ¨é€‰é¡¹è¡¨ç¤ºå¯åŠ¨ç®¡ç†å‘˜ apiï¼Œä½ å¯ä»¥é€šè¿‡ api å¯¹ç›‘æ§æ•°æ®è¿›è¡Œåˆ é™¤ç­‰ï¼›
3 serviceAccount å®ƒçš„å€¼å¿…é¡»æ˜¯ prometheus-k8sï¼Œä¸ç„¶å‰é¢çš„èµ‹æƒæ“ä½œéƒ½ç™½å¹²äº†ï¼›
4 pod å¿…é¡»å­˜åœ¨ app: prometheus è¿™ä¸ªæ ‡ç­¾ï¼Œä¸ç„¶æ— æ³•è¢«å‰é¢åˆ›å»ºçš„ service é€‰æ‹©åˆ°ï¼›
5 æŒ‚è½½äº†ä¸¤ä¸ª configmapã€ä¸€ä¸ª secret è¿˜æœ‰ä¸€ä¸ªå­˜å‚¨å·ã€‚(æˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨storageclass, å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„æ‰‹åŠ¨åˆ›å»ºpv)</p>
<h4 id="åˆ›å»ºä¸€ä¸ªingress">åˆ›å»ºä¸€ä¸ªingress</h4>
<pre><code>tee prometheus-ingress.yml &lt;&lt;- EOF
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: prometheus
  namespace: monitoring
spec:
  rules:
    - host: prometheus-dev.k1s.club
      http:
        paths:
          - path: /
            backend:
              serviceName: prometheus
              servicePort: 9090

EOF

kubectl apply -f prometheus-ingress.yml
</code></pre><p>è‡³æ­¤, æˆ‘ä»¬å°±ç›‘æ§äº†prometheusæœ¬èº«
<img src="assets/prometheus-01-01.png" alt=""></p>
<hr>
<h3 id="é—®é¢˜1-k8s110æŠ¥é”™rbacæƒé™é”™è¯¯">é—®é¢˜1 k8s1.10æŠ¥é”™rbacæƒé™é”™è¯¯</h3>
<blockquote>
<p>level=error ts=2020-05-11T10:00:03.091Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=&quot;/app/discovery/kubernetes/kubernetes.go:335: Failed to list *v1.Node: nodes is forbidden: User &quot;system:serviceaccount:monitoring:prometheus-k8s&quot; cannot list nodes at the cluster scope&quot;</p>
</blockquote>
<p>æŒ‰ç…§ä»¥ä¸‹rbacå¢åŠ äº†æƒé™,åˆ™æ­£å¸¸</p>
<pre><code>prometheus-rbac.yml
apiVersion: v1
kind: ServiceAccount
metadata:
 name: prometheus-k8s
 namespace: monitoring
 labels:
   kubernetes.io/cluster-service: &quot;true&quot;
   addonmanager.kubernetes.io/mode: Reconcile
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
 name: prometheus-k8s
 labels:
   kubernetes.io/cluster-service: &quot;true&quot;
   addonmanager.kubernetes.io/mode: Reconcile
rules:
 - apiGroups:
     - &quot;&quot;
   resources:
     - nodes
     - nodes/metrics
     - services
     - endpoints
     - pods
   verbs:
     - get
     - list
     - watch
 - apiGroups:
     - &quot;&quot;
   resources:
     - configmaps
   verbs:
     - get
 - nonResourceURLs:
     - &quot;/metrics&quot;
   verbs:
     - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
 name: prometheus-k8s
 labels:
   kubernetes.io/cluster-service: &quot;true&quot;
   addonmanager.kubernetes.io/mode: Reconcile
roleRef:
 apiGroup: rbac.authorization.k8s.io
 kind: ClusterRole
 name: prometheus-k8s
subjects:
- kind: ServiceAccount
 name: prometheus-k8s
 namespace: monitoring

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ç›‘æ§etcd">ç›‘æ§etcd</h3>
<h4 id="å¦‚æœæ˜¯å®¹å™¨å®‰è£…çš„etcdé›†ç¾¤">å¦‚æœæ˜¯å®¹å™¨å®‰è£…çš„etcdé›†ç¾¤</h4>
<pre><code>tee kube-etcd-service.yml &lt;&lt;- EOF
apiVersion: v1
kind: Service
metadata:
  name: kube-etcd
  labels:
    k8s-app: kube-etcd
  namespace: kube-system
spec:
  clusterIP: None
  ports:
    - name: http-metrics
      port: 2379
      protocol: TCP
      targetPort: 2379
  selector:
    component: etcd
  type: ClusterIP

EOF
</code></pre><ul>
<li>ç”±äº etcd å¤„äº kube-system åç§°ç©ºé—´ï¼Œæ‰€ä»¥è¿™é‡Œçš„ namespace ä¹Ÿåº”è¯¥æ˜¯ kube-systemï¼›</li>
<li>å› ä¸º etcd pod æœ¬èº«ä¼šå­˜åœ¨ component=etcd è¿™ä¸ªæ ‡ç­¾ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€‰æ‹©å™¨ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚</li>
</ul>
<pre><code>kubectl apply -f kube-etcd-service.yml
kubectl -n kube-system get endpoints kube-etcd

</code></pre><p>ç°åœ¨é€šè¿‡è¿™ä¸ª endpoint å°±èƒ½å¤Ÿè®¿é—®åˆ°åé¢ä¸‰å° etcdï¼Œç°åœ¨åªéœ€è¦åœ¨ Prometheus ä¸­æ·»åŠ å¯¹åº”çš„é…ç½®å³å¯ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ã€‚</p>
<pre><code>- job_name: kube-etcd
  honor_labels: false
  kubernetes_sd_configs:
    - role: endpoints
      namespaces:
        names:
          - kube-system
  scheme: https
  tls_config:
    insecure_skip_verify: false
    ca_file: /etc/prometheus/secrets/etcd-client-cert/ca.crt
    cert_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.crt
    key_file: /etc/prometheus/secrets/etcd-client-cert/healthcheck-client.key
  relabel_configs:
    - action: keep
      source_labels:
        - __meta_kubernetes_service_label_k8s_app
      regex: kube-etcd
    - source_labels:
        - __meta_kubernetes_namespace
      target_label: namespace
    - source_labels:
        - __meta_kubernetes_service_name
      target_label: service
    - source_labels:
        - __meta_kubernetes_pod_name
      target_label: pod
    - target_label: endpoint
      replacement: http-metrics
  metric_relabel_configs:
    - action: drop
      regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*
      source_labels:
        - __name__

</code></pre><h4 id="æˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªç¯å¢ƒæ˜¯httpè®¿é—®çš„-åˆ™ç›´æ¥é€šè¿‡http17216xxxx2379metrics-ç›‘æ§å³å¯">æˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªç¯å¢ƒæ˜¯httpè®¿é—®çš„, åˆ™ç›´æ¥é€šè¿‡http://172.16.xx.xx:2379/metrics ç›‘æ§å³å¯</h4>
<pre><code>- job_name: 'etcd'
  scrape_interval: 60s
  static_configs:
    - targets: ['172.16.xx.xx:2379']
  metric_relabel_configs:
  - action: drop
    regex: (etcd_debugging|etcd_disk|etcd_request|etcd_server|grpc_server).*
    source_labels:
      - __name__
</code></pre><blockquote>
<p>ç„¶åé‡æ–°åŠ è½½configmap</p>
</blockquote>
<pre><code>kubectl apply -f prometheus-configmap.yml

# è¯¥é…ç½®ä¸ç”¨é‡å¯prometheuså³å¯é‡æ–°åŠ è½½é…ç½®
curl -XPOST prometheus-dev.k1s.club/-/reload
</code></pre><h3 id="ç›‘æ§-apiserver">ç›‘æ§ apiserver</h3>
<p>apiserver çš„ç›‘æ§æ–¹å¼æ›´ç®€å•ï¼Œå› ä¸ºå®ƒçš„ service å·²ç»è‡ªåŠ¨åˆ›å»ºäº†ã€‚ä½†ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒçš„ service åˆ›å»ºåœ¨ default åç§°ç©ºé—´ï¼Œåä¸º kubernetesã€‚</p>
<pre><code>- job_name: kube-apiserver
  honor_labels: false
  kubernetes_sd_configs:
    - role: endpoints
      namespaces:
        names:
          - default
  scrape_interval: 30s
  scheme: https
  tls_config:
    insecure_skip_verify: false
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabel_configs:
    - action: keep
      source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
      separator: ;
      regex: default;kubernetes;https
  metric_relabel_configs:
    - source_labels:
        - __name__
      action: drop
      regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)
</code></pre><h3 id="ç›‘æ§-pod">ç›‘æ§ pod</h3>
<p>pod çš„ç›‘æ§æŒ‡æ ‡æ˜¯ kubelet æä¾›çš„ï¼Œå‰é¢ä¹Ÿå·²ç»ä½¿ç”¨ curl å‘½ä»¤çœ‹åˆ°äº†ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæ˜¯ç›´æ¥å¹²ã€‚
prometheus-operator ä½¿ç”¨çš„åŒæ ·æ˜¯ endpoints å‘ç°çš„æ–¹å¼ï¼Œä½†æ˜¯ kubelet æ˜¯æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ï¼Œå¹¶ä¸æ˜¯ podï¼Œå› æ­¤é€šè¿‡åˆ›å»º service çš„æ–¹å¼æ˜¯ä¸å¯èƒ½åˆ›å»ºå¯¹åº”çš„ endpoint çš„ï¼Œä¹Ÿä¸çŸ¥é“å®ƒä¸ºå•¥å¯ä»¥åšåˆ°ã€‚
ä¸ºäº†æ›´é€šç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é€šè¿‡ node å‘ç°çš„æ–¹å¼è¿›è¡Œçš„ã€‚ä½¿ç”¨ node å‘ç°ï¼Œä½ æ— æ³•æŒ‡å®šç«¯å£ï¼Œprometheus ä¼šè‡ªåŠ¨è®¿é—®å‘ç° node çš„ 10250 ç«¯å£ã€‚</p>
<pre><code>- job_name: pods
  honor_labels: true
  kubernetes_sd_configs:
  - role: node
  scrape_interval: 30s
  metrics_path: /metrics/cadvisor
  scheme: https
  tls_config:
    insecure_skip_verify: true
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token


</code></pre><blockquote>
<p>k8s çš„å…¶ä»–ç»„ä»¶æˆ‘å°±ä¸ç»§ç»­ç›‘æ§äº†ï¼ŒåŒ…æ‹¬ kubeletã€controller managerã€coredns ç­‰ï¼Œå®ƒä»¬ç›‘æ§çš„æ‰‹æ®µå’Œä¹‹å‰çš„å‡ ä¸ªç»„ä»¶éƒ½å·®ä¸å¤š</p>
</blockquote>
<h3 id="å®‰è£…-kube-state-metrics">å®‰è£… kube-state-metrics</h3>
<blockquote>
<p>å¸¸è§åº”ç”¨
ä½¿ç”¨kube-state-metricsåçš„å¸¸ç”¨åœºæ™¯æœ‰ï¼š</p>
</blockquote>
<p>å­˜åœ¨æ‰§è¡Œå¤±è´¥çš„Job:</p>
<ul>
<li>kube_job_status_failed{job=&ldquo;kubernetes-service-endpoints&rdquo;,k8s_app=&ldquo;kube-state-metrics&rdquo;}==1</li>
<li>é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€é”™è¯¯: kube_node_status_condition{condition=&ldquo;Ready&rdquo;,status!=&ldquo;true&rdquo;}==1</li>
<li>é›†ç¾¤ä¸­å­˜åœ¨å¯åŠ¨å¤±è´¥çš„Podï¼škube_pod_status_phase{phase=~&ldquo;Failed|Unknown&rdquo;}==1</li>
<li>æœ€è¿‘30åˆ†é’Ÿå†…æœ‰Podå®¹å™¨é‡å¯: changes(kube_pod_container_status_restarts[30m])&gt;0
é…åˆæŠ¥è­¦å¯ä»¥æ›´å¥½åœ°ç›‘æ§é›†ç¾¤çš„è¿è¡Œ</li>
</ul>
<h4 id="rbac-æƒé™">RBAC æƒé™</h4>
<blockquote>
<p>å› ä¸ºå®ƒè¦è®¿é—®é›†ç¾¤å†…çš„æ‰€æœ‰èµ„æºï¼Œæ‰èƒ½å°†å®ƒä»¬çš„ä¿¡æ¯æä¾›å‡ºå»ï¼Œå› æ­¤éƒ¨ç½²å®ƒä¹‹å‰ï¼Œå…ˆä¸ºå®ƒåˆ›å»ºä¸€äº›æƒé™ã€‚è¿™äº›æƒé™éƒ½ä¼šç»‘å®šåˆ°ä¸€ä¸ª serviceAccount ä¸Šï¼Œç„¶åæˆ‘ä»¬ç”¨è¿™ä¸ª sa è¿è¡Œ kube-state-metrics å°±è¡Œ</p>
</blockquote>
<h4 id="kube-state-metrics-clusterroleyml">kube-state-metrics-clusterRole.yml</h4>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-state-metrics
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
      - secrets
      - nodes
      - pods
      - services
      - resourcequotas
      - replicationcontrollers
      - limitranges
      - persistentvolumeclaims
      - persistentvolumes
      - namespaces
      - endpoints
    verbs:
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - daemonsets
      - deployments
      - replicasets
      - ingresses
    verbs:
      - list
      - watch
  - apiGroups:
      - apps
    resources:
      - statefulsets
      - daemonsets
      - deployments
      - replicasets
    verbs:
      - list
      - watch
  - apiGroups:
      - batch
    resources:
      - cronjobs
      - jobs
    verbs:
      - list
      - watch
  - apiGroups:
      - autoscaling
    resources:
      - horizontalpodautoscalers
    verbs:
      - list
      - watch
  - apiGroups:
      - authentication.k8s.io
    resources:
      - tokenreviews
    verbs:
      - create
  - apiGroups:
      - authorization.k8s.io
    resources:
      - subjectaccessreviews
    verbs:
      - create
  - apiGroups:
      - policy
    resources:
      - poddisruptionbudgets
    verbs:
      - list
      - watch
  - apiGroups:
      - certificates.k8s.io
    resources:
      - certificatesigningrequests
    verbs:
      - list
      - watch

</code></pre><h4 id="kube-state-metrics-clusterrolebindingyml">kube-state-metrics-clusterRoleBinding.yml</h4>
<pre><code>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-state-metrics
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-state-metrics
subjects:
  - kind: ServiceAccount
    name: kube-state-metrics
    namespace: monitoring

</code></pre><h4 id="kube-state-metrics-roleyml">kube-state-metrics-role.yml</h4>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kube-state-metrics
  namespace: monitoring
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - pods
    verbs:
      - get
  - apiGroups:
      - extensions
    resourceNames:
      - kube-state-metrics
    resources:
      - deployments
    verbs:
      - get
      - update
  - apiGroups:
      - apps
    resourceNames:
      - kube-state-metrics
    resources:
      - deployments
    verbs:
      - get
      - update

</code></pre><h4 id="kube-state-metrics-rolebindingyml">kube-state-metrics-roleBinding.yml</h4>
<pre><code>
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kube-state-metrics
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kube-state-metrics
subjects:
  - kind: ServiceAccount
    name: kube-state-metrics

</code></pre><h4 id="kube-state-metrics-serviceaccountyml">kube-state-metrics-serviceAccount.yml</h4>
<pre><code>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-state-metrics
  namespace: monitoring

</code></pre><pre><code>kubectl apply -f kube-state-metrics-clusterRole.yml
kubectl apply -f kube-state-metrics-clusterRoleBinding.yml
kubectl apply -f kube-state-metrics-role.yml
kubectl apply -f kube-state-metrics-roleBinding.yml
kubectl apply -f kube-state-metrics-serviceAccount.yml
</code></pre><h3 id="deployment-å’Œ-service">deployment å’Œ service</h3>
<blockquote>
<p>kube-state-metrics ä¼šæä¾›ä¸¤ä¸ªæŒ‡æ ‡é¡µé¢ï¼Œä¸€ä¸ªæ˜¯æš´éœ²é›†ç¾¤å†…èµ„æºçš„ï¼Œå¦ä¸€ä¸ªæ˜¯å®ƒè‡ªèº«çš„ï¼Œå®ƒè‡ªèº«çš„å¯ä»¥é€‰æ‹©æ€§çš„å…³æ³¨</p>
</blockquote>
<h4 id="kube-state-metrics-deploymentyml">kube-state-metrics-deployment.yml</h4>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: kube-state-metrics
  name: kube-state-metrics
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kube-state-metrics
  template:
    metadata:
      labels:
        app: kube-state-metrics
    spec:
      containers:
        - args:
            - --port=10000
            - --telemetry-port=10001
          image: quay.io/coreos/kube-state-metrics:v1.6.0
          name: kube-state-metrics
          resources:
            limits:
              cpu: 100m
              memory: 150Mi
            requests:
              cpu: 100m
              memory: 150Mi
        - command:
            - /pod_nanny
            - --container=kube-state-metrics
            - --cpu=100m
            - --extra-cpu=2m
            - --memory=150Mi
            - --extra-memory=30Mi
            - --threshold=5
            - --deployment=kube-state-metrics
          env:
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
          image: k8s.gcr.io/addon-resizer:1.8.4
          name: addon-resizer
          resources:
            limits:
              cpu: 50m
              memory: 30Mi
            requests:
              cpu: 10m
              memory: 30Mi
      nodeSelector:
        kubernetes.io/os: linux
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      serviceAccountName: kube-state-metrics
</code></pre><p>æŒ‡å®šäº†ä¸¤ä¸ªå¯åŠ¨å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªç«¯å£ï¼Œå…¶ä¸­ 10000 æ˜¯æš´éœ²é›†ç¾¤èµ„æºæŒ‡æ ‡çš„ç«¯å£ï¼Œ10001 å°±æ˜¯å®ƒè‡ªèº«äº†ã€‚é™¤äº† kube-state-metrics ä¹‹å¤–ï¼Œè¿˜å¯åŠ¨äº† addon-resizer è¿™ä¸ªå®¹å™¨</p>
<h4 id="æœ€åæ˜¯-service-æ–‡ä»¶-kube-state-metrics-serviceyml">æœ€åæ˜¯ service æ–‡ä»¶ kube-state-metrics-service.yml</h4>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    k8s-app: kube-state-metrics
  name: kube-state-metrics
  namespace: monitoring
spec:
  clusterIP: None
  ports:
    - name: http-main
      port: 10000
      targetPort: 10000
    - name: http-self
      port: 10001
      targetPort: 10001
  selector:
    app: kube-state-metrics

</code></pre><pre><code>docker pull registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4
docker tag registry.cn-beijing.aliyuncs.com/minminmsn/addon-resizer:1.8.4 k8s.gcr.io/addon-resizer:1.8.4
</code></pre><pre><code>kubectl apply -f kube-state-metrics-deployment.yml
kubectl apply -f kube-state-metrics-service.yml
</code></pre><p>ä¸¤ä¸ªç«¯å£éƒ½æš´éœ²å‡ºæ¥ï¼Œä½ å¯ä»¥éƒ½æ”¶é›†æˆ–è€…åªæ”¶é›† 10000 ç«¯å£ã€‚å¦‚æœåªæ”¶é›† 10000ï¼Œä½ å¯ä»¥åªæš´éœ²ä¸€ä¸ªç«¯å£ï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ªéƒ½æš´éœ²ï¼Œç„¶ååœ¨ Prometheus é…ç½®ä¸­è¿‡æ»¤æ‰ä¸€ä¸ªç«¯å£å³å¯ã€‚</p>
<h4 id="æ”¶é›†ç›‘æ§æ•°æ®">æ”¶é›†ç›‘æ§æ•°æ®</h4>
<p>å°†ä¸Šé¢æ‰€æœ‰çš„æ–‡ä»¶éƒ½ apply ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥é…ç½® Prometheus è¿›è¡Œæ”¶é›†äº†ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ curl å‘½ä»¤è®¿é—®å®ƒçš„æŒ‡æ ‡é¡µé¢ï¼Œçœ‹çœ‹é‡Œé¢éƒ½æœ‰å•¥ï¼š</p>
<pre><code>kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools -n monitoring

# é¦–å…ˆçœ‹ä¸€ä¸‹å¥åº·æƒ…å†µ
curl kube-state-metrics:10000/healthz
# åœ¨çœ‹çœ‹æŒ‡æ ‡ (è¿™é‡Œæœ‰éå¸¸å¤šæŒ‡æ ‡)
curl kube-state-metrics:10000/metrics
</code></pre><h4 id="ä¿®æ”¹ä¸‹prometheus-configmapyml-æ–‡ä»¶">ä¿®æ”¹ä¸‹prometheus-configmap.yml æ–‡ä»¶</h4>
<pre><code>- job_name: kube-state-metrics
  honor_labels: true
  kubernetes_sd_configs:
    - role: endpoints
      namespaces:
        names:
          - monitoring
  scrape_interval: 30s
  scrape_timeout: 30s
  tls_config:
    insecure_skip_verify: true
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabel_configs:
    - action: keep
      source_labels:
        - __meta_kubernetes_service_label_k8s_app
      regex: kube-state-metrics
    - action: keep
      source_labels:
        - __meta_kubernetes_endpoint_port_name
      regex: http-main
  metric_relabel_configs:
    - source_labels:
        - __name__
      regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready)
      action: keep

</code></pre><blockquote>
<p>è¿™é‡Œæ˜¯åªå…³æ³¨åŒ¹é…åˆ°çš„æŒ‡æ ‡, å…¶ä»–æŒ‡æ ‡å¿½ç•¥(ç™½åå•)</p>
</blockquote>
<pre><code>kubectl apply -f prometheus-configmap.yml
# è¯¥é…ç½®ä¸ç”¨é‡å¯prometheuså³å¯é‡æ–°åŠ è½½é…ç½®
curl -XPOST prometheus-dev.k1s.club/-/reload
</code></pre><h3 id="é…ç½®ä¸€ä¸ªgrafana">é…ç½®ä¸€ä¸ªgrafana</h3>
<h4 id="é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹ä½ æ˜¯å¦é…ç½®äº†storageclass">é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹ä½ æ˜¯å¦é…ç½®äº†storageclass</h4>
<pre><code>kubectl get storageclass
NAME            PROVISIONER       AGE
nfs (default)   nfs.com/nfs-ssd   248d
nfs-retain      nfs.com/nfs-ssd   248d
</code></pre><h4 id="k8s-statefulset_grafanayml">k8s-StatefulSet_grafana.yml</h4>
<pre><code>---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: grafana-dev
  namespace: monitoring
spec:
  serviceName: &quot;grafana-dev&quot;
  updateStrategy:
    type: RollingUpdate
  replicas: 1
  volumeClaimTemplates:
  - metadata:
      name: grafana-data
      annotations:
        volume.beta.kubernetes.io/storage-class: &quot;nfs-retain&quot; # è¿™é‡Œé…ç½® ä¸Šé¢åˆ›å»ºçš„ storageclass çš„åç§°
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 5Gi
  template:
    metadata:
      labels:
        app: grafana-dev
    spec:
      containers:
      - name: grafana-dev
        image: grafana/grafana
        ports:
        - containerPort: 3000
          name: grafana-port
        resources:
          requests:
            cpu: &quot;50m&quot;
          limits:
            cpu: &quot;512m&quot;
        volumeMounts:
        - mountPath: /var/lib/grafana
          name: grafana-data
---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: grafana-dev
  name: grafana-dev-service
  namespace: monitoring
spec:
  clusterIP: None
  type: ClusterIP
  ports:
    - port: 3000
      name: grafana-port
      protocol: TCP
      targetPort: 3000
  selector:
    app: grafana-dev
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: grafana-dev
  namespace: monitoring
spec:
  rules:
    - host: grafana-dev.k1s.club
      http:
        paths:
          - path: /
            backend:
              serviceName: grafana-dev-service
              servicePort: 3000
</code></pre><h4 id="é€šè¿‡-k8s-grafana-dashboardæ¨¡æ¿httpsgrafanacomgrafanadashboards8588--ç›‘æ§æ•ˆæœå¦‚ä¸‹">é€šè¿‡ <a href="https://grafana.com/grafana/dashboards/8588">k8s grafana dashboardæ¨¡æ¿</a>  ç›‘æ§æ•ˆæœå¦‚ä¸‹</h4>
<p><img src="assets/prometheus-02-01.png" alt=""></p>
<h4 id="é€šè¿‡ä»¥ä¸Šçš„ç»éªŒ-å¦‚æœæˆ‘å¸Œæœ›é€šè¿‡aé›†ç¾¤çš„prometheus-æ¥ç›‘æ§-bé›†ç¾¤-æ‰€ä»¥ä¸€äº›æŒ‡æ ‡çš„å¯é€šè¿‡tokenè®¿é—®b-api">é€šè¿‡ä»¥ä¸Šçš„ç»éªŒ, å¦‚æœæˆ‘å¸Œæœ›é€šè¿‡Aé›†ç¾¤çš„Prometheus æ¥ç›‘æ§ Bé›†ç¾¤, æ‰€ä»¥ä¸€äº›æŒ‡æ ‡çš„å¯é€šè¿‡tokenè®¿é—®B api</h4>
<pre><code># æŸ¥çœ‹Bé›†ç¾¤çš„api
kubectl cluster-info

kubectl create serviceaccount --namespace=monitoring prometheus-dev
kubectl create clusterrolebinding prometheus-k8s --clusterrole=cluster-admin --serviceaccount=monitoring:prometheus-dev

# åˆ›å»ºä¸€ä¸ªå«adminçš„serviceaccount
kubectl -n kube-system create serviceaccount admin
# ç»™è¿™ä¸ªadminçš„serviceaccountç»‘ä¸Šcluser-adminçš„clusterrole
kubectl -n kube-system create clusterrolebinding sa-cluster-admin --serviceaccount kube-system:admin --clusterrole cluser-admin
# æŸ¥è¯¢adminçš„secret
kubectl -n kube-system get serviceaccounts admin -o json|jq -r '.secrets[0].name'
admin-token-h4zz4

# æŸ¥çœ‹token
kubectl get secret admin-token-h4zz4 -n kube-system -o json|jq -r &quot;.data.token&quot;|base64 -d &gt;&gt;/etc/kubernetes/pki/admin-token-9dg92
</code></pre><h4 id="ç„¶ååœ¨aé›†ç¾¤çš„prometheusé…ç½®å¦‚ä¸‹">ç„¶ååœ¨Aé›†ç¾¤çš„prometheusé…ç½®å¦‚ä¸‹</h4>
<pre><code>- job_name: k8s_B-kube-state-metrics
   honor_labels: true
   kubernetes_sd_configs:
     - role: endpoints
       api_server: https://172.16.xx.xx:6443
       tls_config:
         insecure_skip_verify: true
       bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'
       namespaces:
         names:
           - monitoring
   scrape_interval: 30s
   scrape_timeout: 30s
   tls_config:
     insecure_skip_verify: true
   bearer_token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwcm9tZXRoZXVzLWRldi10b2tlbi1zZ3pidiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWRldiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjliODI5NTYwLTkzNGYtMTFlYS1hMGE3LTE4NjZkYWY0NjY3NCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpwcm9tZXRoZXVzLWRldiJ9.xa8gDA0lwEi_NDGzCL3JSsZUsUD7gKiF0sfFofykyAlEYcjnPmPaksduHWzRKaUJhkvgAJN5Jl3pt8-wplQUJggGAaPVdqJVTYISi4QkPcLkDInoYm8p3OeRgvNpQJJ0VID8zp0-RBWoYe8bAh-7qT6JInt308AA-21vzDKDHtj3aa8Re1nuBxB7f0omNKcAhW0R04p59jshg95HRSBXbVQe7gX6NBjgaOWqj5i0MkKL6k2hdFKdQYgjhQjRAZmXL6F0Qx197y3HAw4zmrUPG-13RcXk38X5F4K8CWtHdOvrqUZxolaWBWin8n73Sr87KyFcEu8YA2oJbzvCKzy9Kg'
   relabel_configs:
     - action: keep
       source_labels:
         - __meta_kubernetes_service_label_k8s_app
       regex: kube-state-metrics
     - action: keep
       source_labels:
         - __meta_kubernetes_endpoint_port_name
       regex: http-main
   metric_relabel_configs:
     - source_labels:
         - __name__
       regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed)
       action: keep
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="éƒ¨ç½²alertmanager">éƒ¨ç½²alertmanager</h3>
<h4 id="alertmanager-configmapyml">alertmanager-configmap.yml</h4>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  config.yml: |-
    global:
      # åœ¨æ²¡æœ‰æŠ¥è­¦çš„æƒ…å†µä¸‹å£°æ˜ä¸ºå·²è§£å†³çš„æ—¶é—´
      resolve_timeout: 5m
      # é…ç½®é‚®ä»¶å‘é€ä¿¡æ¯
      smtp_smarthost: 'smtp.163.com:25'
      smtp_from: 'xxx@163.com'
      smtp_auth_username: 'xxx@163.com'
      smtp_auth_password: 'xxx'
      smtp_require_tls: false
      # æ‰€æœ‰æŠ¥è­¦ä¿¡æ¯è¿›å…¥åçš„æ ¹è·¯ç”±ï¼Œç”¨æ¥è®¾ç½®æŠ¥è­¦çš„åˆ†å‘ç­–ç•¥
    route:
      # è¿™é‡Œçš„æ ‡ç­¾åˆ—è¡¨æ˜¯æ¥æ”¶åˆ°æŠ¥è­¦ä¿¡æ¯åçš„é‡æ–°åˆ†ç»„æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰ cluster=A å’Œ alertname=LatncyHigh è¿™æ ·çš„æ ‡ç­¾çš„æŠ¥è­¦ä¿¡æ¯å°†ä¼šæ‰¹é‡è¢«èšåˆåˆ°ä¸€ä¸ªåˆ†ç»„é‡Œé¢
      group_by: ['alertname', 'cluster']
      # å½“ä¸€ä¸ªæ–°çš„æŠ¥è­¦åˆ†ç»„è¢«åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…è‡³å°‘group_waitæ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æ‚¨èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„æ¥è·å–å¤šä¸ªè­¦æŠ¥ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯ã€‚
      group_wait: 30s
      # å½“ç¬¬ä¸€ä¸ªæŠ¥è­¦å‘é€åï¼Œç­‰å¾…'group_interval'æ—¶é—´æ¥å‘é€æ–°çš„ä¸€ç»„æŠ¥è­¦ä¿¡æ¯ã€‚
      group_interval: 1m
      # å¦‚æœä¸€ä¸ªæŠ¥è­¦ä¿¡æ¯å·²ç»å‘é€æˆåŠŸäº†ï¼Œç­‰å¾…'repeat_interval'æ—¶é—´æ¥é‡æ–°å‘é€ä»–ä»¬
      repeat_interval: 2h
      # é»˜è®¤çš„receiverï¼šå¦‚æœä¸€ä¸ªæŠ¥è­¦æ²¡æœ‰è¢«ä¸€ä¸ªrouteåŒ¹é…ï¼Œåˆ™å‘é€ç»™é»˜è®¤çš„æ¥æ”¶å™¨
      receiver: default
    receivers:
    - name: 'default'
      email_configs:
      - to: 'zhangzw@xxx.com'
        send_resolved: true
</code></pre><h4 id="alertmanager-deploymentyml">alertmanager-deployment.yml</h4>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager
        args:
          - &quot;--config.file=/etc/alertmanager/config.yml&quot;
          - &quot;--storage.path=/alertmanager&quot;
        ports:
        - name: alertmanager
          containerPort: 9093
        volumeMounts:
        - name: alertmanager-cm
          mountPath: /etc/alertmanager
      volumes:
      - name: alertmanager-cm
        configMap:
          name: alertmanager-config
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  selector:
    app: alertmanager
  ports:
    - port: 80
      targetPort: 9093
</code></pre><h4 id="æœ€åé…ç½®prometheusçš„ruleæ–‡ä»¶-prometheus-config-rulefilesyml-ä¿®æ”¹">æœ€åé…ç½®prometheusçš„ruleæ–‡ä»¶ prometheus-config-rulefiles.yml (ä¿®æ”¹)</h4>
<blockquote>
<p>è¿™é‡Œä»…é’ˆå¯¹æˆ‘è¿™é‡Œprometheuséƒ¨ç½²çš„æ—¶å€™æ˜¯é€šè¿‡configmapæŒ‚è½½çš„ruleæ–‡ä»¶</p>
</blockquote>
<pre><code>
kind: ConfigMap
metadata:
  name: prometheus-rulefiles
  namespace: monitoring
apiVersion: v1
data:
  k8s.yml: |
    groups:
    - name: cpu-load-rule
      rules:
      - alert: cpu-load-high
        expr: irate(container_cpu_usage_seconds_total{image!=&quot;&quot;}[1m]) &gt; 0.1
        for: 1m
        labels:
          serverity: warning
        annotations:
          summary: &quot;{{ $labels.instance }} container_name: {{ $labels.container_name }}  pod_name: {{ $labels.pod_name }} , namespace: {{ $labels.namespace}}&quot;


</code></pre><h4 id="ä¹Ÿè´´ä¸Šprometheusçš„statefulset-é…ç½®">ä¹Ÿè´´ä¸Šprometheusçš„StatefulSet é…ç½®</h4>
<pre><code>&gt;  prometheus-statefulset.yml é…ç½®å¯ä»¥çœ‹åˆ°prometheus-rulefiles è¿™ä¸ªconfigmapæ˜¯ æŒ‚è½½åˆ° /etc/prometheus/rules/ ç›®å½•
&gt;  prometheus-configmap.yml é…ç½®å¯ä»¥çœ‹åˆ°     rule_files: - /etc/prometheus/rules/*.yml,  æ‰€ä»¥ ä»¥ä¸Šprometheus-rulefiles è¿™ä¸ªconfigmap çš„k8s.ymlå°±è¢«prometheuså½“åšruleæ–‡ä»¶äº†
</code></pre><ul>
<li>prometheus-statefulset.yml</li>
</ul>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
 labels:
   app: prometheus
   prometheus: k8s
 name: prometheus
 namespace: monitoring
spec:
 replicas: 1
 volumeClaimTemplates:
 - metadata:
     name: prometheus-data
     annotations:
       volume.beta.kubernetes.io/storage-class: &quot;nfs-retain&quot; # è¿™é‡Œé…ç½® ä¸Šé¢åˆ›å»ºçš„ storageclass çš„åç§°
   spec:
     accessModes: [ &quot;ReadWriteOnce&quot; ]
     resources:
       requests:
         storage: 20Gi
 revisionHistoryLimit: 10
 selector:
   matchLabels:
     app: prometheus
     prometheus: k8s
 serviceName: prometheus
 updateStrategy:
   type: RollingUpdate
 template:
   metadata:
     creationTimestamp: null
     labels:
       app: prometheus
       prometheus: k8s
   spec:
     serviceAccount: prometheus-k8s
     containers:
       - args:
           - --web.console.templates=/etc/prometheus/consoles
           - --web.console.libraries=/etc/prometheus/console_libraries
           - --config.file=/etc/prometheus/config/prometheus.yml
           - --storage.tsdb.path=/prometheus
           - --web.enable-admin-api
           - --storage.tsdb.retention.time=20d
           - --web.enable-lifecycle
           - --storage.tsdb.no-lockfile
           - --web.external-url=http://prometheus1-dev.xxx.com/
           - --web.route-prefix=/
         image: prom/prometheus:v2.11.1
         imagePullPolicy: IfNotPresent
         livenessProbe:
           failureThreshold: 6
           httpGet:
             path: /-/healthy
             port: web
             scheme: HTTP
           periodSeconds: 5
           successThreshold: 1
           timeoutSeconds: 3
         name: prometheus
         ports:
           - containerPort: 9090
             name: web
             protocol: TCP
         readinessProbe:
           failureThreshold: 120
           httpGet:
             path: /-/ready
             port: web
             scheme: HTTP
           periodSeconds: 5
           successThreshold: 1
           timeoutSeconds: 3
         resources:
           requests:
             memory: 400Mi
         terminationMessagePath: /dev/termination-log
         terminationMessagePolicy: File
         volumeMounts:
           - mountPath: /etc/prometheus/config
             name: config
             readOnly: true
           - mountPath: /prometheus
             name: prometheus-data
             #subPath: prometheus-db
           - mountPath: /etc/prometheus/rules/
             name: prometheus-rulefiles
     volumes:
       - name: config
         configMap:
           defaultMode: 420
           name: prometheus
       - name: prometheus-rulefiles
         configMap:
           defaultMode: 420
           name: prometheus-rulefiles
</code></pre><ul>
<li>prometheus-configmap.yml</li>
</ul>
<pre><code>kind: ConfigMap
metadata:
  name: prometheus
  namespace: monitoring
apiVersion: v1
data:
  prometheus.yml: |
    global:
      evaluation_interval: 30s
      scrape_interval: 30s
      external_labels:
        prometheus: monitoring/k8s
    alerting:
      alertmanagers:
      - static_configs:
        - targets: ['alertmanager:80']
    rule_files:
    - /etc/prometheus/rules/*.yml
    scrape_configs:
    - job_name: prometheus
      honor_labels: false
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - monitoring
      scrape_interval: 30s
      relabel_configs:
      - action: keep
        source_labels:
        - __meta_kubernetes_service_label_prometheus
        regex: k8s
      - source_labels:
        - __meta_kubernetes_namespace
        target_label: namespace
      - source_labels:
        - __meta_kubernetes_service_name
        target_label: service
      - source_labels:
        - __meta_kubernetes_pod_name
        target_label: pod
      - source_labels:
        - __meta_kubernetes_service_name
        target_label: job
        replacement:
      - target_label: endpoint
        replacement: web

    - job_name: k8s-db-t-kube-apiserver
      honor_labels: false
      kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
              - default
      scrape_interval: 30s
      scheme: https
      tls_config:
        insecure_skip_verify: false
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
        - action: keep
          source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          separator: ;
          regex: default;kubernetes;https
      metric_relabel_configs:
        - source_labels:
            - __name__
          action: drop
          regex: (apiserver_storage_data_key_generation_latencies_microseconds_bucket|apiserver_admission_controller_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_bucket|apiserver_admission_step_admission_latencies_milliseconds_summary|apiserver_request_latencies_bucket|apiserver_request_latencies_summary|apiserver_storage_data_key_generation_latencies_microseconds_bucket|rest_client_request_latency_seconds_bucket)

    - job_name: k8s-db-t-pods
      honor_labels: true
      kubernetes_sd_configs:
      - role: node
      scrape_interval: 30s
      metrics_path: /metrics/cadvisor
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token


    - job_name: k8s-db-t-kube-state-metrics
      honor_labels: true
      kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
              - monitoring
      scrape_interval: 30s
      scrape_timeout: 30s
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
        - action: keep
          source_labels:
            - __meta_kubernetes_service_label_k8s_app
          regex: kube-state-metrics
        - action: keep
          source_labels:
            - __meta_kubernetes_endpoint_port_name
          regex: http-main
      metric_relabel_configs:
        - source_labels:
            - __name__
          regex: (kube_daemonset_status_number_ready|kube_daemonset_status_number_unavailable|kube_deployment_status_replicas_unavailable|kube_deployment_spec_paused|kube_deployment_spec_strategy_rollingupdate_max_surge|kube_deployment_spec_strategy_rollingupdate_max_unavailable|kube_endpoint_address_available|kube_endpoint_address_not_ready|kube_node_info|kube_node_spec_unschedulable|kube_node_status_condition|kube_node_status_capacity|kube_node_status_capacity|kube_node_status_allocatable|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_status_phase|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolume_status_phase|kube_persistentvolume_info|kube_persistentvolume_capacity_bytes|kube_pod_info|kube_pod_status_phase|kube_pod_status_ready|kube_pod_container_info|kube_pod_container_status_waiting|kube_pod_container_status_waiting_reason|kube_pod_container_status_running|kube_pod_container_status_terminated_reason|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_restarts_total|kube_pod_container_resource_limits|kube_service_info|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_deployment_status_replicas_available|kube_deployment_status_replicas|kube_node_status_allocatable_memory_bytes|kube_deployment_status_replicas|kube_statefulset_replicas|kube_daemonset_status_desired_number_scheduled|kube_statefulset_status_replicas|changes|kube_job_status_failed)
          action: keep


</code></pre>]]></content>
		</item>
		
		<item>
			<title>dockerå®‰è£…nginxç¬¬ä¸‰æ–¹æ¨¡å—</title>
			<link>https://www.ngirl.xyz/posts/46-docker%E5%AE%89%E8%A3%85nginx%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97/</link>
			<pubDate>Wed, 13 May 2020 11:12:01 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/46-docker%E5%AE%89%E8%A3%85nginx%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97/</guid>
			<description>&lt;p&gt;ç”±äºhub.docker.com å®˜æ–¹çš„nginx å¹¶ä¸ä¼šåŒ…æ‹¬ç¬¬ä¸‰æ–¹åŒ…, è¿™é‡Œç®€è¦è¯´æ˜å¦‚ä½•å®‰è£…nginx_upstream_check_moduleæ¨¡å—&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç”±äºhub.docker.com å®˜æ–¹çš„nginx å¹¶ä¸ä¼šåŒ…æ‹¬ç¬¬ä¸‰æ–¹åŒ…, è¿™é‡Œç®€è¦è¯´æ˜å¦‚ä½•å®‰è£…nginx_upstream_check_moduleæ¨¡å—</p>
<h3 id="å¥åº·æ£€æŸ¥">å¥åº·æ£€æŸ¥</h3>
<ul>
<li><a href="https://github.com/yaoweibin/nginx_upstream_check_module">nginx_upstream_check_module github åœ°å€</a></li>
</ul>
<h3 id="dockerå®‰è£…nginx">dockerå®‰è£…nginx</h3>
<blockquote>
<p>å¦‚æœä½¿ç”¨å®˜æ–¹çš„nginxé•œåƒ, è¿™é‡Œæ— æ³•å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—,å¹¶æ²¡æœ‰åƒphpçš„docker-php-ext-install å·¥å…·,  å› æ­¤è¿™é‡Œé‡‡ç”¨æºç å®‰è£…</p>
</blockquote>
<blockquote>
<p>è¿™é‡Œé•œåƒçš„å¤§å°ä¹Ÿæ§åˆ¶çš„è¿˜å¯ä»¥</p>
</blockquote>
<pre><code># è‡ªå·±æºç å®‰è£…çš„é•œåƒ
hub.xxx.com/nginx  1.16.1-debian-buster-slim    5b5884f7927e        34 seconds ago      120MB

# å®˜æ–¹é•œåƒ
nginx              1.16                         588bb5d559c2        6 weeks ago         127MB
</code></pre><h4 id="dockerfile">dockerfile</h4>
<pre><code>FROM debian:buster-slim

LABEL maintainer=&quot;zhangzw zhangzw@xxx.com&quot;

ENV NGINX_VERSION   1.16.1
workdir /opt


RUN apt-get update \
   &amp;&amp; apt-get install wget unzip gcc make openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev net-tools patch -y\
   &amp;&amp; wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \
   &amp;&amp; wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master \
   &amp;&amp; tar -xvf  nginx-${NGINX_VERSION}.tar.gz \
   &amp;&amp; unzip master \
   &amp;&amp; cd nginx-${NGINX_VERSION} \
   &amp;&amp; patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.16.1+.patch \
   &amp;&amp; ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module  --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module  --add-module=../nginx_upstream_check_module-master/ &amp;&amp; make &amp;&amp; make install \
  &amp;&amp; rm -rf /opt/* \
  &amp;&amp; apt-get remove --purge -y wget unzip gcc make patch \
  &amp;&amp; apt-get autoremove -y \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/* \
  &amp;&amp; useradd nginx

run  ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
 &amp;&amp; echo 'Asia/Shanghai' &gt;/etc/timezone

expose 80

CMD [&quot;/usr/sbin/nginx&quot;, &quot;-c&quot;, &quot;/etc/nginx/nginx.conf&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]
</code></pre>]]></content>
		</item>
		
		<item>
			<title>gitlab-ciä¸k8sç»“åˆ</title>
			<link>https://www.ngirl.xyz/posts/45-gitlab-ci%E4%B8%8Ek8s%E7%BB%93%E5%90%88/</link>
			<pubDate>Thu, 23 Apr 2020 16:20:33 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/45-gitlab-ci%E4%B8%8Ek8s%E7%BB%93%E5%90%88/</guid>
			<description>æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡gitlab-ciæ•´åˆk8så®ç°æµæ°´çº¿éƒ¨ç½²
  https://www.cnblogs.com/Sinte-Beuve/p/11739196.html https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/   ç¯å¢ƒç‰ˆæœ¬ç»Ÿè®¡ 1 gitlab/gitlab-runner 0.15.0 2 helm 2.16 3 k8s 1.16.4 4 gitlab 11.5 5 CentOS Linux release 7.7 /kernel 5.2  å°èŠ‚
 1. gitlab é€šè¿‡adminç®¡ç†é¡µé¢çš„runneré…ç½®, å®‰è£…gitlab-runner, å®‰è£…æ–¹å¼å¯ä»¥æ˜¯äºŒè¿›åˆ¶, docker æˆ–k8s (è¿™é‡Œæ˜¯k8s) 2. gitlab é¡¹ç›®ç›®å½•çš„ Operations -&amp;gt; kubernetes -&amp;gt; Add Kubernetes Cluster -&amp;gt; Add existing cluster æ˜¯ç»“åˆk8s, æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªk8sé›†ç¾¤,k8sé›†ç¾¤éœ€è¦é…ç½®rbacæƒé™ 3. ci åœ¨æäº¤åˆ°ç§æœ‰harborä¸Šæ˜¯éœ€è¦éªŒè¯è´¦å·å¯†ç , ç§æœ‰ä»“åº“æ‹‰å–ä¹Ÿéœ€è¦éªŒè¯  å®‰è£…æ–¹æ³•ä¸€   k8s yamlç›´æ¥éƒ¨ç½² gitlab-ci-token-secret.yaml  å…·ä½“tokenå€¼ è¯·æŸ¥çœ‹ gitlabçš„adminé¡µé¢-&amp;gt; Overview -&amp;gt; Runners æŸ¥çœ‹, ç„¶åbase64åŠ å¯†</description>
			<content type="html"><![CDATA[<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡gitlab-ciæ•´åˆk8så®ç°æµæ°´çº¿éƒ¨ç½²</p>
<!--more -->
<blockquote>
<ol>
<li><a href="https://www.cnblogs.com/Sinte-Beuve/p/11739196.html">https://www.cnblogs.com/Sinte-Beuve/p/11739196.html</a></li>
<li><a href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/">https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/</a></li>
</ol>
</blockquote>
<h3 id="ç¯å¢ƒç‰ˆæœ¬ç»Ÿè®¡">ç¯å¢ƒç‰ˆæœ¬ç»Ÿè®¡</h3>
<pre><code>1 gitlab/gitlab-runner 0.15.0
2 helm 2.16
3 k8s 1.16.4
4 gitlab 11.5
5 CentOS Linux release 7.7 /kernel 5.2
</code></pre><blockquote>
<p>å°èŠ‚</p>
</blockquote>
<pre><code>1. gitlab é€šè¿‡adminç®¡ç†é¡µé¢çš„runneré…ç½®, å®‰è£…gitlab-runner, å®‰è£…æ–¹å¼å¯ä»¥æ˜¯äºŒè¿›åˆ¶, docker æˆ–k8s (è¿™é‡Œæ˜¯k8s)
2. gitlab é¡¹ç›®ç›®å½•çš„ Operations -&gt; kubernetes -&gt; Add Kubernetes Cluster -&gt; Add existing cluster æ˜¯ç»“åˆk8s, æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªk8sé›†ç¾¤,k8sé›†ç¾¤éœ€è¦é…ç½®rbacæƒé™
3. ci åœ¨æäº¤åˆ°ç§æœ‰harborä¸Šæ˜¯éœ€è¦éªŒè¯è´¦å·å¯†ç , ç§æœ‰ä»“åº“æ‹‰å–ä¹Ÿéœ€è¦éªŒè¯
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å®‰è£…æ–¹æ³•ä¸€ </font>
</center>
<h3 id="k8s-yamlç›´æ¥éƒ¨ç½²">k8s yamlç›´æ¥éƒ¨ç½²</h3>
<h4 id="gitlab-ci-token-secretyaml">gitlab-ci-token-secret.yaml</h4>
<blockquote>
<p>å…·ä½“tokenå€¼ è¯·æŸ¥çœ‹ gitlabçš„adminé¡µé¢-&gt; Overview -&gt; Runners æŸ¥çœ‹, ç„¶åbase64åŠ å¯†</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-token</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">GITLAB_CI_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">$(echo &#34;gitlab_ci_token&#34;|base64)</span><span class="w">
</span></code></pre></div><h4 id="runner-configmapyaml">runner-configmap.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-cm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">REGISTER_NON_INTERACTIVE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">REGISTER_LOCKED</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">METRICS_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.0.0.0:9100&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">CI_SERVER_URL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://gitlab.xxx.com/ci&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">RUNNER_REQUEST_CONCURRENCY</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">RUNNER_EXECUTOR</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubernetes&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kube-ops&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_PRIVILEGED</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_CPU_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_MEMORY_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1Gi&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_SERVICE_CPU_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_SERVICE_MEMORY_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1Gi&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_HELPER_CPU_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;500m&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_HELPER_MEMORY_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100Mi&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_PULL_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;if-not-present&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_TERMINATIONGRACEPERIODSECONDS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_POLL_INTERVAL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">KUBERNETES_POLL_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;360&#34;</span><span class="w">
</span></code></pre></div><h4 id="runner-rbacyaml">runner-rbac.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></div><h4 id="runner-scripts-cmyaml">runner-scripts-cm.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">run.sh</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    #!/bin/bash
</span><span class="sd">    unregister() {
</span><span class="sd">        kill %1
</span><span class="sd">        echo &#34;Unregistering runner ${RUNNER_NAME} ...&#34;
</span><span class="sd">        /usr/bin/gitlab-ci-multi-runner unregister -t &#34;$(/usr/bin/gitlab-ci-multi-runner list 2&gt;&amp;1 | tail -n1 | awk &#39;{print $4}&#39; | cut -d&#39;=&#39; -f2)&#34; -n ${RUNNER_NAME}
</span><span class="sd">        exit $?
</span><span class="sd">    }
</span><span class="sd">    trap &#39;unregister&#39; EXIT HUP INT QUIT PIPE TERM
</span><span class="sd">    echo &#34;Registering runner ${RUNNER_NAME} ...&#34;
</span><span class="sd">    /usr/bin/gitlab-ci-multi-runner register -r ${GITLAB_CI_TOKEN}
</span><span class="sd">    sed -i &#39;s/^concurrent.*/concurrent = &#39;&#34;${RUNNER_REQUEST_CONCURRENCY}&#34;&#39;/&#39; /home/gitlab-runner/.gitlab-runner/config.toml
</span><span class="sd">    echo &#34;Starting runner ${RUNNER_NAME} ...&#34;
</span><span class="sd">    /usr/bin/gitlab-ci-multi-runner run -n ${RUNNER_NAME} &amp;
</span><span class="sd">    wait</span><span class="w">    
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-scripts</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span></code></pre></div><h4 id="runner-statefulsetyaml">runner-statefulset.yaml</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-ops</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-scripts</span><span class="w">
</span><span class="w">        </span><span class="nt">projected</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">sources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-scripts</span><span class="w">
</span><span class="w">              </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">run.sh</span><span class="w">
</span><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">run.sh</span><span class="w">
</span><span class="w">                </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="m">0755</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">999</span><span class="w">
</span><span class="w">        </span><span class="nt">supplementalGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">999</span><span class="p">]</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab/gitlab-runner:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;800m&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">/scripts/run.sh</span><span class="w">
</span><span class="w">        </span><span class="nt">envFrom</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">configMapRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-cm</span><span class="w">
</span><span class="w">        </span>- <span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-token</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">RUNNER_NAME</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9100</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-metrics</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gitlab-ci-runner-scripts</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/scripts&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></code></pre></div><h4 id="éƒ¨ç½²å’Œæ£€æŸ¥">éƒ¨ç½²å’Œæ£€æŸ¥</h4>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">kubectl apply -f ../</span><span class="w">
</span><span class="w"></span><span class="l">kubectl get all -n kube-ops</span><span class="w">
</span></code></pre></div><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å®‰è£…æ–¹æ³•äºŒ </font>
</center>
<h3 id="helm216å®‰è£…">helm2.16å®‰è£…</h3>
<pre><code>wget https://get.helm.sh/helm-v2.16.2-linux-amd64.tar.gz
tar -xvf helm-v2.16.2-linux-amd64.tar.gz
mv linux-amd64/helm /usr/local/bin/helm

kubectl create serviceaccount --namespace=kube-system tiller
kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller

helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.2 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --service-account tiller


</code></pre><p><img src="//zhangzw001.github.io/images/45/02.png" alt=""></p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ä»å®˜æ–¹æ‹‰å–helm2-é…ç½®æ–‡ä»¶">ä»å®˜æ–¹æ‹‰å–helm2 é…ç½®æ–‡ä»¶</h3>
<pre><code># æ·»åŠ æº
helm repo add gitlab https://charts.gitlab.io

# æŸ¥çœ‹
helm search runner
gitlab/gitlab-runner 0.15.0        12.9.0      GitLab Runner

# ä¸‹è½½chartså‹ç¼©åŒ…gitlab-runner-0.15.0.tgz
helm fetch gitlab/gitlab-runner

# åˆ›å»ºgitlab-runnerçš„rbacè´¦å·
kubectl create serviceaccount  gitlab-cluster-admin
kubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default

# ç„¶åä¿®æ”¹ values.yaml
gitlabUrl: http://gitlab.zhangzw.com #gitlabæœåŠ¡å™¨ä¸Šç®¡ç†é¡µé¢ä¸Šçš„URL
runnerRegistrationToken: #gitlabæœåŠ¡å™¨ç®¡ç†é¡µé¢çš„token
serviceAccountName: gitlab-cluster-admin

# ä¿®æ”¹ templates/configmap.yaml (å¦‚æœåé¢é…ç½®dindé‡‡ç”¨tcp://0.0.0.0:2375çš„æ–¹å¼åº”è¯¥ä¸ç”¨æŒ‚è½½sockæ–‡ä»¶)
    #
    if ! sh /scripts/register-the-runner; then
      exit 1
    fi

    # add new config start
    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF
      [[runners.kubernetes.volumes.host_path]]
            name = &quot;docker&quot;
            mount_path = &quot;/var/run/docker.sock&quot;
            read_only = false
            host_path = &quot;/var/run/docker.sock&quot;
    EOF
    # add new config end

    # Start the runner
    exec /entrypoint run --user=gitlab-runner \
      --working-directory=/home/gitlab-runner


# helmå¯åŠ¨,æ›´æ–°,åˆ é™¤gitlab-runner
helm install  --name gitlab-runner .
helm upgrade gitlab-runner .
helm delete --purge gitlab-runner
</code></pre><h3 id="ç™»å½•åˆ°gitlab-runner-é•œåƒregisteræ³¨å†Œ">ç™»å½•åˆ°gitlab-runner é•œåƒregisteræ³¨å†Œ</h3>
<blockquote>
<p>ä»¥ä¸‹å¤§éƒ¨åˆ†éƒ½æ˜¯å›è½¦, åªæœ‰tokenéœ€è¦æ‰‹åŠ¨è¾“å…¥(è¾“å…¥values.yamlä¸­çš„runnerRegistrationTokenå³å¯)</p>
</blockquote>
<pre><code>bash-5.0$ gitlab-runner register
Runtime platform                                    arch=amd64 os=linux pid=4257 revision=4c96e5ad version=12.9.0
WARNING: Running in user-mode.                     
WARNING: The user-mode requires you to manually start builds processing:
WARNING: $ gitlab-runner run                       
WARNING: Use sudo for system-mode:                 
WARNING: $ sudo gitlab-runner...                   

Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.zhangzw.com/):
[http://gitlab.zhangzw.com]:
Please enter the gitlab-ci token for this runner:
djs47LiKFy-64FxAACp5
Please enter the gitlab-ci description for this runner:
[gitlab-runner-gitlab-runner-6cf8c6bff4-rhhs5]:
Please enter the gitlab-ci tags for this runner (comma separated):

Registering runner... succeeded                     runner=djs47LiK
Please enter the executor: docker+machine, docker-ssh+machine, kubernetes, docker, docker-ssh, shell, ssh, virtualbox, custom, parallels:
[kubernetes]:
Runner registered successfully. Feel free to start it, but if its running already the config should be automatically reloaded!
bash-5.0$
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="åœ¨é¡¹ç›®çš„é¡µé¢ç‚¹å‡»-add-kubernetes-cluster---add-existing-cluster">åœ¨é¡¹ç›®çš„é¡µé¢ç‚¹å‡» Add Kubernetes Cluster -&gt; Add existing cluster</h3>
<ul>
<li>
<ol>
<li>API URL æ˜¯ä½ çš„é›†ç¾¤çš„apiserverçš„åœ°å€ï¼Œ ä¸€èˆ¬å¯ä»¥é€šè¿‡è¾“å…¥kubectl cluster-infoè·å–</li>
</ol>
</li>
</ul>
<pre><code>kubectl cluster-info

Kubernetes master is running at https://master.k8s.io:16443
KubeDNS is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://master.k8s.io:16443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
</code></pre><ul>
<li>
<ol start="2">
<li>CAè¯ä¹¦</li>
</ol>
</li>
</ul>
<blockquote>
<p>ç”±äºæˆ‘ä»¬åœ¨éƒ¨ç½²é˜¶æ®µéœ€è¦å»åˆ›å»ºã€åˆ é™¤ä¸€äº›èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹è±¡çš„ RBAC æƒé™ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ–°å»ºä¸€ä¸ª ServiceAccountï¼Œç»‘å®šä¸Šä¸€ä¸ªcluster-adminçš„æƒé™(gitlab-serviceAccount.yaml)</p>
</blockquote>
<pre><code>---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab
  namespace: gitlab

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: gitlab
  namespace: gitlab
subjects:
  - kind: ServiceAccount
    name: gitlab
    namespace: gitlab
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
</code></pre><pre><code>#å¯ä»¥é€šè¿‡ä¸Šé¢åˆ›å»ºçš„ ServiceAccount è·å– CA è¯ä¹¦å’Œ Tokenï¼š
kubectl get serviceaccount gitlab -n gitlab -o json | jq -r '.secrets[0].name'
gitlab-token-9jlpr

# ç„¶åæ ¹æ®ä¸Šé¢çš„Secretæ‰¾åˆ°CAè¯ä¹¦
kubectl get secret gitlab-token-9jlpr -n gitlab -o json | jq -r '.data[&quot;ca.crt&quot;]' | base64 -d
xxxxxCAè¯ä¹¦å†…å®¹xxxxx

# å½“ç„¶è¦æ‰¾åˆ°å¯¹åº”çš„ Token ä¹Ÿå¾ˆç®€å•
kubectl get secret gitlab-token-9jlpr  -n gitlab -o json | jq -r '.data.token' | base64 -d
xxxxxxtokenå€¼xxxx
</code></pre><blockquote>
<p>ç„¶åå¤åˆ¶å¯¹åº”çš„å€¼è´´åˆ°é¡¹ç›®çš„k8sé…ç½®ä¸­å³å¯</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ç®€å•æµ‹è¯•">ç®€å•æµ‹è¯•</h3>
<pre><code>#.gitlab-ci.yml
image: busybox
stages:
  - build
  - deploy
Job1:
  stage: build
  script:
    - echo &quot;go go go !!!~&quot;
  only:
    - master

deploy:
  stage: deploy
  script:
    - echo &quot;éƒ¨ç½²å¼€å§‹&quot;
  only:
    - master

</code></pre><p><img src="//zhangzw001.github.io/images/45/03.png" alt=""></p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="gitlab-ciyamlé…ç½®">.gitlab-ci.yamlé…ç½®</h3>
<blockquote>
<p>ä»¥ä¸‹ä¸€äº›é…ç½®å†™åˆ°gitlabé¡¹ç›®é¡µé¢-&gt; Settings -&gt; CI/CD -&gt; Variables
å…¶å®ä¹Ÿå¯ä»¥å†™åˆ°.gitlab-ca.yamlä¸­, æˆ‘åœ¨deployment.yamlä¹Ÿæ— æ³•ç”¨å¦‚ä¸‹å˜é‡</p>
</blockquote>
<pre><code>CI_REGISTRY_USER: admin
CI_REGISTRY_PASSWORD: xxxxx
CI_REGISTRY: hub.xxx.com
CI_REGISTRY_IMAGE: hub.xxx.com/public/nginx
</code></pre><pre><code>variables:
  GIT_CURL_VERBOSE: 1
  GIT_TRACE: 1

stages:
  - release
  - review
  - deploy



buildPushImage:
  stage: release
  image: docker:latest
  services:
    - name: docker:dind
      command: [&quot;--insecure-registry=hub.zhangzw.com&quot;]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://192.168.0.136:2375
  script:
    - docker login -u &quot;${CI_REGISTRY_USER}&quot; -p &quot;${CI_REGISTRY_PASSWORD}&quot; &quot;${CI_REGISTRY}&quot;
    - docker build -t &quot;${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}&quot; .
    - docker push &quot;${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}&quot;

deploy_review:
  image: bitnami/kubectl:1.16.3
  stage: review
  only:
    - branches
  except:
    - tags
  environment:
    name: dev
    url: http://dev-gitlab-k8s-demo.zhangzw.com
    on_stop: stop_review
  script:
    - kubectl version
    - cd deploy/
    - sed -i &quot;s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/&quot; deployment.yaml ingress.yaml service.yaml
    - sed -i &quot;s/__VERSION__/${CI_COMMIT_REF_NAME}/&quot; deployment.yaml ingress.yaml service.yaml
    - |
      if kubectl apply -f deployment.yaml | grep -q unchanged; then
          echo &quot;=&gt; Patching deployment to force image update.&quot;
          kubectl patch -f deployment.yaml -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{\&quot;ci-last-updated\&quot;:\&quot;$(date +'%s')\&quot;}}}}}&quot;
      else
          echo &quot;=&gt; Deployment apply has changed the object, no need to force image update.&quot;
      fi
    - kubectl apply -f service.yaml || true
    - kubectl apply -f ingress.yaml
    - kubectl rollout status -f deployment.yaml
    - kubectl get all,ing -l ref=${CI_ENVIRONMENT_SLUG}


stop_review:
  image: bitnami/kubectl:1.16.3
  stage: review
  variables:
    GIT_STRATEGY: none
  when: manual
  only:
    - branches
  except:
    - master
    - tags
  environment:
    name: dev
    action: stop
  script:
    - kubectl version
    - kubectl delete ing -l ref=${CI_ENVIRONMENT_SLUG}
    - kubectl delete all -l ref=${CI_ENVIRONMENT_SLUG}


deploy_live:
  image: bitnami/kubectl:1.16.3
  stage: deploy
  environment:
    name: live
    url: http://live-gitlab-k8s-demo.zhangzw.com
  script:
    - echo &quot;éƒ¨ç½²å¼€å§‹&quot;
    - cd deploy
    - sed -i &quot;s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/&quot; deployment.yaml ingress.yaml service.yaml
    - sed -i &quot;s/__VERSION__/${CI_COMMIT_REF_NAME}/&quot; deployment.yaml ingress.yaml service.yaml
    - kubectl apply -f deployment.yaml
    - kubectl apply -f service.yaml
    - kubectl apply -f ingress.yaml
    - kubectl rollout status -f deployment.yaml
    - kubectl get all,ing -l ref=${CI_ENVIRONMENT_SLUG}
  only:
    - tags
  when: manual

</code></pre><h3 id="deploydeploymentyaml">deploy/deployment.yaml</h3>
<pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__
  labels:
    app: gitlab-k8s-demo
    ref: __CI_ENVIRONMENT_SLUG__
    track: stable
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gitlab-k8s-demo
      ref: __CI_ENVIRONMENT_SLUG__
  template:
    metadata:
      labels:
        app: gitlab-k8s-demo
        ref: __CI_ENVIRONMENT_SLUG__
        track: stable
    spec:
      imagePullSecrets:
        - name: myregistry
      containers:
      - name: app
        image: hub.zhangzw.com/bq/nginx:__VERSION__
        imagePullPolicy: Always
        ports:
        - name: http-metrics
          protocol: TCP
          containerPort: 80
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 3
          timeoutSeconds: 2
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 3
          timeoutSeconds: 2
</code></pre><h3 id="å¦‚æœæˆ‘ä»¬harborä¸­è®¾ç½®çš„æ˜¯ç§æœ‰é•œåƒ-åˆ™éœ€è¦è®¾ç½®imagepullsecret-æ‰èƒ½æ‹‰å–é•œåƒ">å¦‚æœæˆ‘ä»¬harborä¸­è®¾ç½®çš„æ˜¯ç§æœ‰é•œåƒ, åˆ™éœ€è¦è®¾ç½®imagePullSecret æ‰èƒ½æ‹‰å–é•œåƒ</h3>
<pre><code>kubectl create secret docker-registry gitlab-hub-secret --docker-server=hub.zhangzw.com --docker-username=xxx --docker-password=xxx --docker-email=zhangzw@zhangzw.com
</code></pre><h3 id="deployserviceyaml">deploy/service.yaml</h3>
<pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__
  labels:
    app: gitlab-k8s-demo
    ref: __CI_ENVIRONMENT_SLUG__
  annotations:
    prometheus.io/scrape: &quot;true&quot;
    prometheus.io/port: &quot;80&quot;
    prometheus.io/scheme: &quot;http&quot;
    prometheus.io/path: &quot;/&quot;
spec:
  type: ClusterIP
  ports:
    - name: http-metrics
      port: 80
      protocol: TCP
  selector:
    app: gitlab-k8s-demo
    ref: __CI_ENVIRONMENT_SLUG__
</code></pre><h3 id="deployingressyaml">deploy/ingress.yaml</h3>
<pre><code>---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__
  labels:
    app: gitlab-k8s-demo
    ref: __CI_ENVIRONMENT_SLUG__
  annotations:
    kubernetes.io/ingress.class: &quot;traefik&quot;
spec:
  rules:
  - host: __CI_ENVIRONMENT_SLUG__-gitlab-k8s-demo.zhangzw.com
    http:
      paths:
      - path: /
        backend:
          serviceName: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__
          servicePort: 80
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h3>
<h4 id="err1--æµæ°´çº¿æ‰“åŒ…çš„æ—¶å€™æç¤ºæ²¡æœ‰æƒé™">err1.  æµæ°´çº¿æ‰“åŒ…çš„æ—¶å€™æç¤ºæ²¡æœ‰æƒé™</h4>
<pre><code>ERROR: Job failed (system failure): pods is forbidden: User &quot;system:serviceaccount:default:default&quot; cannot create resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;


kubectl create serviceaccount  gitlab-cluster-admin
kubectl create clusterrolebinding gitlab-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccounts --namespace=default
</code></pre><h4 id="err2-æµæ°´çº¿æ‰“åŒ…æç¤ºæ— æ³•æ‹‰å–é¡¹ç›®">err2. æµæ°´çº¿æ‰“åŒ…æç¤ºæ— æ³•æ‹‰å–é¡¹ç›®</h4>
<pre><code>fatal: unable to access 'http://gitlab.zhangzw.com/k8s/rancher-dev-php.git/': Failed to connect to gitlab.zhangzw.com port 80: Connection refused
Uploading artifacts for failed job
ERROR: Job failed: command terminated with exit code 1
</code></pre><blockquote>
<p>éš¾é“æ˜¯å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ˜¯ç§æœ‰é¡¹ç›®?</p>
</blockquote>
<p>æ˜¾ç„¶æˆ‘ä»¬åœ¨å®˜ç½‘ <a href="https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html">https://docs.gitlab.zhangzw.com/runner/configuration/advanced-configuration.html</a> è¿™é‡Œçœ‹åˆ°ä¸‹é¢ä¸€å¥è¯</p>
<pre><code>Only if the clone_url is set, the runner will construct a clone URL in the form of http://gitlab-ci-token:s3cr3tt0k3n@192.168.1.23/namespace/project.git.

# å°è¯•ä¿®æ”¹ values.yaml
cloneUrl: http://gitlab.zhangzw.com
</code></pre><blockquote>
<p>ä¹‹åè¿˜æ˜¯å‡ºç°äº†è¯¥é—®é¢˜</p>
</blockquote>
<blockquote>
<p>æ‰€ä»¥è¿™åº”è¯¥æ˜¯gitlab-runner registerçš„é—®é¢˜</p>
</blockquote>
<blockquote>
<p>ä½†æ˜¯è¿™é‡Œè¯¡å¼‚çš„æ˜¯, æˆ‘ä¸‰ä¸ªæ­¥éª¤,å‰ä¸¤ä¸ªéƒ½æ˜¯æ­£å¸¸, ç¬¬ä¸‰ä¸ªä¸€ç›´æ˜¯æŠ¥é”™connection refused, ä½†æ˜¯æˆ‘é‡è¯•äº†ä¸‰éåˆæ­£å¸¸äº†, è¿™ä¹ˆä¸ç¨³å®šçš„å—?</p>
</blockquote>
<p><img src="//zhangzw001.github.io/images/45/01.png" alt=""></p>
<blockquote>
<p>çœ‹æ—¥å¿—é”™è¯¯æœ‰ç‚¹åƒæ˜¯è¿™ä¹ˆå›äº‹, æˆ‘çš„nginxåå‘ä»£ç†äº†gitlab.zhangzw.com proxy_passçš„æ˜¯ip:10080, è€Œæ—¥å¿—ä¸­çœ‹èµ·æ¥æŠ¥é”™æç¤ºæ˜¯é“¾æ¥åˆ°ip:80</p>
</blockquote>
<p>æˆ‘è¿™é‡Œè¯•ç€å°†helmå®‰è£…gitlab-runnerçš„é…ç½®æ–‡ä»¶values.yamlä¿®æ”¹å¦‚ä¸‹:</p>
<pre><code>gitlabUrl: http://192.168.0.65:10080
  cloneUrl: http://192.168.0.65:10080
</code></pre><blockquote>
<p>æµ‹è¯•ä¹‹åè¿˜æ˜¯ä¼šå‡ºç°æ— æ³•è¿æ¥, æ‰€ä»¥ä¹Ÿä¸æ˜¯è¿™ä¸ªé—®é¢˜, è¿™é‡Œgit clone http æ–¹å¼ç»è¿‡nginxä»£ç†æ˜¯æ²¡é—®é¢˜çš„</p>
</blockquote>
<p>å¦‚æœæ˜¯é¡¹ç›®æƒé™é—®é¢˜, é‚£æˆ‘æ–°å»ºä¸€ä¸ªpublicé¡¹ç›®åº”è¯¥ä¸ä¼šæŠ¥é”™</p>
<blockquote>
<p>æµ‹è¯•ä¹‹åè¿˜æ˜¯ä¼šå‡ºç°æ— æ³•è¿æ¥, çœ‹èµ·é—®é¢˜è¿˜æ˜¯ç½‘ç»œæ–¹é¢é—®é¢˜, ä¸ºä»€ä¹ˆä¼šç½‘ç»œæ— æ³•è¿æ¥å‘¢?</p>
</blockquote>
<p>å—¯??? æˆ‘æŸ¥çœ‹äº†ä¸‹ gitlab admin -&gt; runners -&gt; ç‚¹å‡»Runner token è¿›å…¥ -&gt; Assigned projects  è¿™é‡Œæˆ‘ä¹‹å‰æ˜¯åŠ è¿‡çš„, ä½†æ˜¯helm å®‰è£…çš„gitlab-runner upgradeä¹‹åå°±å¥½åƒä¸¢å¤±äº†, å¯èƒ½æ˜¯æˆ‘è¿™è¾¹æ²¡æœ‰mountæ•°æ®å­˜å‚¨åˆ°nfs, ä¸è¿‡è¿™é‡Œå¯ä»¥ä¸ç”¨æŒ‰ç…§åˆ†é…çš„æ–¹å¼, å°±è®¾ç½®ä¸ºshareå³å¯,å¦‚æœæœ‰å¤šä¸ªrunner,éœ€è¦æ›´ç»†è‡´çš„æƒé™éƒ¨ç½²åˆ’åˆ†,å¯ä»¥è®¾ç½®</p>
<p>æ‰€ä»¥ç°åœ¨è¿™ä¸ªé—®é¢˜å°±å˜æˆ, æœ‰å¯èƒ½ç¬¬ä¸€æ¬¡ä¼šæˆåŠŸ, æœ‰å¯èƒ½ä¼šå¤±è´¥, æœ‰å¯èƒ½ç¬¬äºŒä¸ªæ­¥éª¤å¤±è´¥ , ç„¶åretry 2æ¬¡?3æ¬¡æˆ–6æ¬¡åˆæˆåŠŸäº†, è›‹ç–¼ä¸­&hellip;</p>
<p><code>2020-04-24 15:58:40 è¡¥:  æˆ‘è¿™è¾¹æµ‹è¯•çš„gitlab-runnerå®‰è£…çš„ç½‘æ®µå’Œgitlabçš„ç½‘æ®µä¹‹é—´ç½‘ç»œé—®é¢˜,  ç°åœ¨æ–°æ­å»ºçš„gitlab-runnerå’Œgitlabåœ¨åŒä¸€ç½‘æ®µå°±ä¸åœ¨æŠ¥é”™äº†...</code></p>
<h4 id="err3-k8s116å®‰è£…helm214çš„æœ‰æŠ¥é”™-error-error-installing-the-server-could-not-find-the-requested-resource-è¿™æ˜¯ç”±äº-extensionsv1beta1-å·²ç»è¢«-appsv1-æ›¿ä»£ç›¸ä¿¡åœ¨215-æˆ–è€…-3-ç‰ˆæœ¬å‘å¸ƒä¹‹å-åº”è¯¥å°±ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜äº†è¿˜æ˜¯ç”Ÿæ€æ¯”è¾ƒæ…¢çš„åŸå› ">err3. k8s1.16å®‰è£…helm2.14çš„æœ‰æŠ¥é”™: Error: error installing: the server could not find the requested resource, è¿™æ˜¯ç”±äº extensions/v1beta1 å·²ç»è¢« apps/v1 æ›¿ä»£ã€‚ç›¸ä¿¡åœ¨2.15 æˆ–è€… 3 ç‰ˆæœ¬å‘å¸ƒä¹‹å, åº”è¯¥å°±ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜äº†ã€‚è¿˜æ˜¯ç”Ÿæ€æ¯”è¾ƒæ…¢çš„åŸå› ã€‚</h4>
<pre><code>helm init -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.3 --stable-repo-url http://mirror.azure.cn/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.'name'='tiller',spec.selector.matchLabels.'app'='helm' --output yaml | sed 's@apiVersion: extensions/v1beta1@apiVersion: apps/v1@' | kubectl apply -f -
</code></pre><h4 id="err4-cannot-connect-to-the-docker-daemon-at-unixvarrundockersock-is-the-docker-daemon-running">err4. Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</h4>
<pre><code>ä¸ç¡®å®šä¸ºä»€ä¹ˆä¼šæŠ¥è¿™ä¸ªé”™è¯¯, ç¬¬äºŒæ¬¡å¯åŠ¨åˆæ²¡é—®é¢˜äº†
</code></pre><h4 id="err5-time2020-04-22t023912z-levelerror-msgfailed-to-dial-grpc-cannot-connect-to-the-docker-daemon-is-docker-daemon-running-on-this-host-dial-tcp-1270012375-connect-connection-refused">err5. time=&ldquo;2020-04-22T02:39:12Z&rdquo; level=error msg=&ldquo;failed to dial gRPC: cannot connect to the Docker daemon. Is &lsquo;docker daemon&rsquo; running on this host?: dial tcp 127.0.0.1:2375: connect: connection refused&rdquo;</h4>
<pre><code>è¿™ç§æƒ…å†µéœ€è¦dockeræˆ–è€…k8sçš„dockerå¯åŠ¨æ–¹å¼æ·»åŠ tcpæ–¹å¼
vim /usr/lib/systemd/system/docker.service
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock -H fd:// --containerd=/run/containerd/containerd.sock
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8séƒ¨ç½²fluentd&#43;kafka&#43;logstash&#43;es</title>
			<link>https://www.ngirl.xyz/posts/44-k8s%E9%83%A8%E7%BD%B2fluentd-kafka-logstash-es/</link>
			<pubDate>Thu, 09 Apr 2020 17:40:58 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/44-k8s%E9%83%A8%E7%BD%B2fluentd-kafka-logstash-es/</guid>
			<description>å®¢æˆ·ç«¯é‡‡é›†æ•°æ®çš„è½¯ä»¶æ¯”è¾ƒå¤š, æœ‰logstash,flume,fluentd/fluent-bit,filebeatç­‰,è¿™é‡Œåœ¨k8sé›†ç¾¤ä¸­éƒ¨ç½²fluentdå¼€å¯UDPç«¯å£æ¥æ”¶ä»£ç å†™å…¥çš„jsonæ—¥å¿—,å¹¶å†™å…¥åˆ°kafkaä¸­
  1. ä¸€äº›æœåŠ¡ç‰ˆæœ¬ dockeré•œåƒ: docker pull fluentd:v1.9.1-1.0 kafka: kafka-server-0.10.0+kafka2.1.0-1.2.1.0.p0.63.el6.noarch fluent-plugin-kafka: 0.5.7   2. fluentd é•œåƒå®‰è£…kafkaæ‰©å±• Dockerfile  ç”±äºfluent-plugin-kafkaç‰ˆæœ¬è¦æ±‚ æˆ‘ä»¬çš„kafkaæ˜¯0.10, æ‰€ä»¥é«˜ç‰ˆæœ¬æœ‰é—®é¢˜, å®‰è£…äº†fluent-plugin-kafka 0.5.7 åˆ™æ­£å¸¸
 å®˜æ–¹æ–‡æ¡£: https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7
from fluentd:v1.9.1-1.0 MAINTAINER zhangzw &amp;lt;zhangzw@xxx.com&amp;gt; USER root RUN fluent-gem install fluent-plugin-kafka -v 0.5.7 USER fluent   3. fluentdé…ç½®æ–‡ä»¶ fluent-udp-to-kafka.conf  &amp;lt;source&amp;gt; @type udp @label @mainstream tag udplog # required &amp;lt;parse&amp;gt; @type regexp expression /^(?&amp;lt;message&amp;gt;.*)$/ &amp;lt;/parse&amp;gt; port 12301 # optional. 5160 by default bind 0.</description>
			<content type="html"><![CDATA[<p>å®¢æˆ·ç«¯é‡‡é›†æ•°æ®çš„è½¯ä»¶æ¯”è¾ƒå¤š, æœ‰logstash,flume,fluentd/fluent-bit,filebeatç­‰,è¿™é‡Œåœ¨k8sé›†ç¾¤ä¸­éƒ¨ç½²fluentdå¼€å¯UDPç«¯å£æ¥æ”¶ä»£ç å†™å…¥çš„jsonæ—¥å¿—,å¹¶å†™å…¥åˆ°kafkaä¸­</p>
<!--more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="1-ä¸€äº›æœåŠ¡ç‰ˆæœ¬">1. ä¸€äº›æœåŠ¡ç‰ˆæœ¬</h3>
<pre><code>dockeré•œåƒ: docker pull fluentd:v1.9.1-1.0
kafka: kafka-server-0.10.0+kafka2.1.0-1.2.1.0.p0.63.el6.noarch
fluent-plugin-kafka: 0.5.7
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="2-fluentd-é•œåƒå®‰è£…kafkaæ‰©å±•-dockerfile">2. fluentd é•œåƒå®‰è£…kafkaæ‰©å±• Dockerfile</h3>
<blockquote>
<p>ç”±äºfluent-plugin-kafkaç‰ˆæœ¬è¦æ±‚
æˆ‘ä»¬çš„kafkaæ˜¯0.10, æ‰€ä»¥é«˜ç‰ˆæœ¬æœ‰é—®é¢˜, å®‰è£…äº†fluent-plugin-kafka 0.5.7 åˆ™æ­£å¸¸</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£: <a href="https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7">https://rubygems.org/gems/fluent-plugin-kafka/versions/0.5.7</a></p>
<pre><code>from fluentd:v1.9.1-1.0

MAINTAINER zhangzw &lt;zhangzw@xxx.com&gt;

USER root

RUN fluent-gem install fluent-plugin-kafka -v 0.5.7

USER fluent

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="3-fluentdé…ç½®æ–‡ä»¶-fluent-udp-to-kafkaconf">3. fluentdé…ç½®æ–‡ä»¶ fluent-udp-to-kafka.conf</h3>
<pre><code>
&lt;source&gt;
  @type udp
  @label @mainstream
  tag udplog # required
  &lt;parse&gt;
    @type regexp
    expression /^(?&lt;message&gt;.*)$/
  &lt;/parse&gt;
  port 12301               # optional. 5160 by default
  bind 0.0.0.0             # optional. 0.0.0.0 by default
  message_length_limit 1MB # optional. 4096 bytes by default
&lt;/source&gt;

&lt;filter **&gt;
  @type stdout
&lt;/filter&gt;

&lt;label @mainstream&gt;
  &lt;match **&gt;
    @type kafka2

    # list of seed brokersï¼Œè¿™ä¸ªåœ°æ–¹å¯ä»¥é€šè¿‡é€—å·å†™å¤šä¸ªåœ°å€æ¯”å¦‚ host1:9092,host2:9092
    brokers 192.168.xxx.142:9092
    use_event_time true

    # buffer settings
    &lt;buffer topic&gt;
    @type file
    # ä¸‹é¢çš„pathå¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼Œå¹¶ç»™å†™å…¥æƒé™ï¼Œæˆ‘ç›´æ¥ç»™äº†777
    path /fluentd/log/td-agent/buffer/td
    flush_interval 3s
    &lt;/buffer&gt;

    # data type settings
    &lt;format&gt;
    @type json
    &lt;/format&gt;

    # kafkaä¸­åˆ›å»ºçš„topic
    topic_key udplog
    # é»˜è®¤topic
    default_topic udplog
    get_kafka_client_log true
    # producer settings
    required_acks -1
    compression_codec gzip
  &lt;/match&gt;
&lt;/label&gt;
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="4-k8séƒ¨ç½²-å¼€å¯input-udp-12301æ¥æ”¶æ•°æ®-å¹¶outputç»™kafka">4. k8séƒ¨ç½² å¼€å¯input udp 12301æ¥æ”¶æ•°æ®, å¹¶outputç»™kafka</h3>
<pre><code>k8s-fluentd-udplog-udp-to-kafka.yml
---
kind: Deployment
apiVersion: apps/v1beta2
metadata:
  labels:
    elastic-app: fluentd-udplog
  name: fluentd-udplog
  namespace: ns-elastic7
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      elastic-app: fluentd-udplog
  template:
    metadata:
      labels:
        elastic-app: fluentd-udplog
    spec:
      containers:
        - name: fluentd-udplog
          image: hub.xxx.com/bq/fluentd:v1.9.1-1.0-kafka-0.10
          ports:
            - containerPort: 12301
              name: port12301
              protocol: UDP
          resources:
            requests:
              cpu: &quot;50m&quot;
            limits:
              cpu: &quot;500m&quot;
          volumeMounts:
            - name: fluentd-udplog-logs
              mountPath: /fluentd/log
            - name: fluentd-udplog-cfg
              mountPath: /fluentd/etc/fluent.conf
      volumes:
        - name: fluentd-udplog-logs
          hostPath:
            path: /data/k8s-container/elk-7.2.0/fluentd/logs/
        - name: fluentd-udplog-cfg
          hostPath:
            path: /data/k8s-container/elk-7.2.0/fluentd/fluent-udp-to-kafka.conf

---
kind: Service
apiVersion: v1
metadata:
 labels:
   elastic-app: fluentd-udplog
 name: fluentd-udplog-service-nodeport
 namespace: ns-elastic7
spec:
 type: NodePort
 ports:
   - name: port12301
     port: 12301
     targetPort: 12301
     nodePort: 12301
     protocol: UDP
 selector:
   elastic-app: fluentd-udplog
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="5-ä¿®æ”¹logstashçš„é…ç½®">5. ä¿®æ”¹logstashçš„é…ç½®</h3>
<pre><code>config/pipeline/logstash.conf
input {
 kafka{
  type =&gt;&quot;php-mysql-dev-252-log&quot;
  bootstrap_servers =&gt; &quot;192.168.xxx.142:9092&quot;
  topics =&gt; &quot;php-mysql-dev-0-slowlog&quot;
 }

        kafka{
                type =&gt;&quot;udplog&quot;
                bootstrap_servers =&gt; &quot;192.168.xxx.142:9092&quot;
                topics =&gt; &quot;udplog&quot;
        }

}



filter{

###############
    if [type] == &quot;php-mysql-dev-252-log&quot; {
 	json {
  		source =&gt; &quot;message&quot;
 	}

 	mutate {
     		gsub =&gt; [ &quot;message&quot;, &quot;\n&quot;, &quot;&quot; ]
  	}
 	grok {
  		match =&gt; [&quot;message&quot;,&quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @  \[%{IP:clientip}\]# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}(?&lt;dbnameall&gt;.*)SET\s+timestamp=%{NUMBER:timestamp_mysql:int};(?&lt;query&gt;.*)&quot;]
 	}
 	date {
  		match =&gt; [&quot;timestamp_mysql&quot;, &quot;UNIX&quot;]
  		target =&gt; &quot;@timestamp&quot;
 	}
    }
######
    if [type] == &quot;udplog&quot; {
 	grok {
          match =&gt; {
            &quot;message&quot; =&gt; &quot;&lt;%{NUMBERğŸ†”int}&gt;%{NUMBER:id_N:int} (?&lt;http_time&gt;\S+) %{DATA:hostname} %{DATA:ident} %{NUMBER:pid:int} - - %{DATA:logLevel}: X-Request-Id:%{DATA:Request_Id} module:%{DATA:moduleName} act:%{DATA:Act} sql:(?&lt;sql&gt;(.*)) cost:%{NUMBER:sqlDuring:int}ms \[\] \[\]&quot;
                }
     	}
       	grok {
         match =&gt; {&quot;sql&quot; =&gt;&quot; %{DATA:operation} &quot;}
       	}

   	if &quot;_grokparsefailure&quot; not in [tags] {
      	 if [sqlDuring] &lt; 5 {
          drop {}
        }
   }
   else {
    	 drop {}
   	}
    }

}

output {
###
   if [type] == &quot;php-mysql-dev-252-log&quot; {
      elasticsearch {
        hosts =&gt;  [ &quot;http://192.168.xxx.120:19230&quot; ]
        index =&gt; &quot;php-mysql-dev-252-%{+YYYY.MM.dd}&quot;
      }
   }
###
    if [type] == &quot;udplog&quot; {
      elasticsearch {
        hosts =&gt;  [ &quot;http://192.168.xxx.120:19230&quot; ]
        index =&gt; &quot;udplog-%{+YYYY.MM.dd}&quot;
      }
    }
}

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="6-éƒ¨ç½²k8s-logstash-åˆ†æåå†™å…¥åˆ°esä¸­-k8s-logstash-720-kafka-to-esyml">6. éƒ¨ç½²k8s logstash åˆ†æåå†™å…¥åˆ°esä¸­ k8s-logstash-7.2.0-kafka-to-es.yml</h3>
<pre><code>---
kind: Deployment
apiVersion: apps/v1beta2
metadata:
  labels:
    elastic-app:  slowlog-logstash-kafka-to-es
  name: slowlog-logstash-kafka-to-es
  namespace: ns-elastic7
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      elastic-app: slowlog-logstash-kafka-to-es
  template:
    metadata:
      labels:
        elastic-app: slowlog-logstash-kafka-to-es
    spec:
      containers:
        - name: slowlog-logstash-kafka-to-es
          image: hub.xxx.com/bq/logstash:7.2.0
          resources:
            requests:
              cpu: &quot;50m&quot;
            limits:
              cpu: &quot;500m&quot;
          volumeMounts:
            - name: slowlog-toes-cfg
              mountPath: /usr/share/logstash/config
      volumes:
        - name: slowlog-toes-cfg
          hostPath:
            path: /data/k8s-container/elk-7.2.0/mysqlslowlog-logstash-7.2.0/config
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule

</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8sçš„yamlé…ç½®åè¯è§£é‡Š(æ¨¡æ¿)</title>
			<link>https://www.ngirl.xyz/posts/43-k8s%E7%9A%84yaml%E9%85%8D%E7%BD%AE%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-%E6%A8%A1%E6%9D%BF/</link>
			<pubDate>Tue, 31 Mar 2020 17:21:23 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/43-k8s%E7%9A%84yaml%E9%85%8D%E7%BD%AE%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-%E6%A8%A1%E6%9D%BF/</guid>
			<description>é’ˆå¯¹Deploymentçš„yamlé…ç½®è§£é‡Šè¯´æ˜
   åŸæ–‡: K8s Deployment YAML åè¯è§£é‡Š
 Deployment API ç‰ˆæœ¬å¯¹ç…§è¡¨ Kubernetes ç‰ˆæœ¬ Deployment ç‰ˆæœ¬ v1.5-v1.15 extensions/v1beta1 v1.7-v1.15 apps/v1beta1 v1.8-v1.15 apps/v1beta2 v1.9+ apps/v1 Deployment yaml åè¯è§£é‡Šï¼š apiVersion:apps/v1 # æŒ‡å®šapiç‰ˆæœ¬ï¼Œæ­¤å€¼å¿…é¡»åœ¨kubectl api-versionsä¸­ kind:Deployment # æŒ‡å®šåˆ›å»ºèµ„æºçš„è§’è‰²/ç±»å‹ metadata:# èµ„æºçš„å…ƒæ•°æ®/å±æ€§name:demo # èµ„æºçš„åå­—ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­å¿…é¡»å”¯ä¸€namespace:default# éƒ¨ç½²åœ¨å“ªä¸ªnamespaceä¸­labels:# è®¾å®šèµ„æºçš„æ ‡ç­¾app:demoversion:stablespec:# èµ„æºè§„èŒƒå­—æ®µreplicas:1# å£°æ˜å‰¯æœ¬æ•°ç›®revisionHistoryLimit:3# ä¿ç•™å†å²ç‰ˆæœ¬selector:# é€‰æ‹©å™¨matchLabels:# åŒ¹é…æ ‡ç­¾app:demoversion:stablestrategy:# ç­–ç•¥rollingUpdate:# æ»šåŠ¨æ›´æ–°maxSurge:30%# æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°maxUnavailable:30%# ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­èƒ½å¤Ÿè¿›å…¥ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°type:RollingUpdate# æ»šåŠ¨æ›´æ–°ç­–ç•¥template:# æ¨¡ç‰ˆmetadata:# èµ„æºçš„å…ƒæ•°æ®/å±æ€§annotations:# è‡ªå®šä¹‰æ³¨è§£åˆ—è¡¨sidecar.istio.io/inject:&amp;#34;false&amp;#34;# è‡ªå®šä¹‰æ³¨è§£åå­—labels:# è®¾å®šèµ„æºçš„æ ‡ç­¾app:demoversion:stablespec:# èµ„æºè§„èŒƒå­—æ®µcontainers:- name:demo# å®¹å™¨çš„åå­— image:demo:v1# å®¹å™¨ä½¿ç”¨çš„é•œåƒåœ°å€ imagePullPolicy:IfNotPresent# æ¯æ¬¡Podå¯åŠ¨æ‹‰å–é•œåƒç­–ç•¥ï¼Œä¸‰ä¸ªé€‰æ‹© Alwaysã€Neverã€IfNotPresent# Alwaysï¼Œæ¯æ¬¡éƒ½æ£€æŸ¥ï¼›Neverï¼Œæ¯æ¬¡éƒ½ä¸æ£€æŸ¥ï¼ˆä¸ç®¡æœ¬åœ°æ˜¯å¦æœ‰ï¼‰ï¼›IfNotPresentï¼Œå¦‚æœæœ¬åœ°æœ‰å°±ä¸æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰å°±æ‹‰å–resources:# èµ„æºç®¡ç†limits:# æœ€å¤§ä½¿ç”¨cpu:300m# CPUï¼Œ1æ ¸å¿ƒ = 1000mmemory:500Mi# å†…å­˜ï¼Œ1G = 1000Mirequests:# å®¹å™¨è¿è¡Œæ—¶ï¼Œæœ€ä½èµ„æºéœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å°‘éœ€è¦å¤šå°‘èµ„æºå®¹å™¨æ‰èƒ½æ­£å¸¸è¿è¡Œcpu:100mmemory:100MilivenessProbe:# pod å†…éƒ¨å¥åº·æ£€æŸ¥çš„è®¾ç½®httpGet:# é€šè¿‡httpgetæ£€æŸ¥å¥åº·ï¼Œè¿”å›200-399ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ­£å¸¸path:/healthCheck# URIåœ°å€port:8080# ç«¯å£scheme:HTTP# åè®®# host: 127.</description>
			<content type="html"><![CDATA[<p>é’ˆå¯¹Deploymentçš„yamlé…ç½®è§£é‡Šè¯´æ˜</p>
<!--more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<blockquote>
<p>åŸæ–‡: <a href="https://zhuanlan.zhihu.com/p/100237194">K8s Deployment YAML åè¯è§£é‡Š</a></p>
</blockquote>
<h3 id="deployment-api-ç‰ˆæœ¬å¯¹ç…§è¡¨">Deployment API ç‰ˆæœ¬å¯¹ç…§è¡¨</h3>
<pre><code>Kubernetes ç‰ˆæœ¬ Deployment ç‰ˆæœ¬

v1.5-v1.15 extensions/v1beta1
v1.7-v1.15 apps/v1beta1
v1.8-v1.15 apps/v1beta2
v1.9+ apps/v1
</code></pre><h3 id="deployment-yaml-åè¯è§£é‡Š">Deployment yaml åè¯è§£é‡Šï¼š</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1 </span><span class="w"> </span><span class="c"># æŒ‡å®šapiç‰ˆæœ¬ï¼Œæ­¤å€¼å¿…é¡»åœ¨kubectl api-versionsä¸­  </span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment </span><span class="w"> </span><span class="c"># æŒ‡å®šåˆ›å»ºèµ„æºçš„è§’è‰²/ç±»å‹   </span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">  </span><span class="c"># èµ„æºçš„å…ƒæ•°æ®/å±æ€§</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo </span><span class="w"> </span><span class="c"># èµ„æºçš„åå­—ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­å¿…é¡»å”¯ä¸€</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w"> </span><span class="c"># éƒ¨ç½²åœ¨å“ªä¸ªnamespaceä¸­</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">  </span><span class="c"># è®¾å®šèµ„æºçš„æ ‡ç­¾</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºè§„èŒƒå­—æ®µ</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># å£°æ˜å‰¯æœ¬æ•°ç›®</span><span class="w">
</span><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># ä¿ç•™å†å²ç‰ˆæœ¬</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># é€‰æ‹©å™¨</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># åŒ¹é…æ ‡ç­¾</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># ç­–ç•¥</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># æ»šåŠ¨æ›´æ–°</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­èƒ½å¤Ÿè¿›å…¥ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># æ¨¡ç‰ˆ</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºçš„å…ƒæ•°æ®/å±æ€§</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> </span><span class="c"># è‡ªå®šä¹‰æ³¨è§£åˆ—è¡¨</span><span class="w">
</span><span class="w">        </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w"> </span><span class="c"># è‡ªå®šä¹‰æ³¨è§£åå­—</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># è®¾å®šèµ„æºçš„æ ‡ç­¾</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºè§„èŒƒå­—æ®µ</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w"> </span><span class="c"># å®¹å™¨çš„åå­—   </span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">demo:v1</span><span class="w"> </span><span class="c"># å®¹å™¨ä½¿ç”¨çš„é•œåƒåœ°å€   </span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># æ¯æ¬¡Podå¯åŠ¨æ‹‰å–é•œåƒç­–ç•¥ï¼Œä¸‰ä¸ªé€‰æ‹© Alwaysã€Neverã€IfNotPresent</span><span class="w">
</span><span class="w">                                      </span><span class="c"># Alwaysï¼Œæ¯æ¬¡éƒ½æ£€æŸ¥ï¼›Neverï¼Œæ¯æ¬¡éƒ½ä¸æ£€æŸ¥ï¼ˆä¸ç®¡æœ¬åœ°æ˜¯å¦æœ‰ï¼‰ï¼›IfNotPresentï¼Œå¦‚æœæœ¬åœ°æœ‰å°±ä¸æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰å°±æ‹‰å–</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºç®¡ç†</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># æœ€å¤§ä½¿ç”¨</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">300m</span><span class="w"> </span><span class="c"># CPUï¼Œ1æ ¸å¿ƒ = 1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">500Mi</span><span class="w"> </span><span class="c"># å†…å­˜ï¼Œ1G = 1000Mi</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">  </span><span class="c"># å®¹å™¨è¿è¡Œæ—¶ï¼Œæœ€ä½èµ„æºéœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å°‘éœ€è¦å¤šå°‘èµ„æºå®¹å™¨æ‰èƒ½æ­£å¸¸è¿è¡Œ</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># pod å†…éƒ¨å¥åº·æ£€æŸ¥çš„è®¾ç½®</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># é€šè¿‡httpgetæ£€æŸ¥å¥åº·ï¼Œè¿”å›200-399ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ­£å¸¸</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/healthCheck</span><span class="w"> </span><span class="c"># URIåœ°å€</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># ç«¯å£</span><span class="w">
</span><span class="w">            </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w"> </span><span class="c"># åè®®</span><span class="w">
</span><span class="w">            </span><span class="c"># host: 127.0.0.1 # ä¸»æœºåœ°å€</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># è¡¨æ˜ç¬¬ä¸€æ¬¡æ£€æµ‹åœ¨å®¹å™¨å¯åŠ¨åå¤šé•¿æ—¶é—´åå¼€å§‹</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># æ£€æµ‹çš„è¶…æ—¶æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># æ£€æŸ¥é—´éš”æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># æˆåŠŸé—¨æ§›</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># å¤±è´¥é—¨æ§›ï¼Œè¿æ¥å¤±è´¥5æ¬¡ï¼Œpodæ€æ‰ï¼Œé‡å¯ä¸€ä¸ªæ–°çš„pod</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod å‡†å¤‡æœåŠ¡å¥åº·æ£€æŸ¥è®¾ç½®</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/healthCheck</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">            </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">       </span><span class="c">#ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ–¹æ³•   </span><span class="w">
</span><span class="w">       </span><span class="c">#exec: æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•è¿›è¡Œç›‘æµ‹ï¼Œå¦‚æœå…¶é€€å‡ºç ä¸ä¸º0ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ­£å¸¸   </span><span class="w">
</span><span class="w">       </span><span class="c">#  command:   </span><span class="w">
</span><span class="w">       </span><span class="c">#    - cat   </span><span class="w">
</span><span class="w">       </span><span class="c">#    - /tmp/health   </span><span class="w">
</span><span class="w">       </span><span class="c">#ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ–¹æ³•   </span><span class="w">
</span><span class="w">       </span><span class="c">#tcpSocket: # é€šè¿‡tcpSocketæ£€æŸ¥å¥åº·  </span><span class="w">
</span><span class="w">       </span><span class="c">#  port: number</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># åç§°</span><span class="w">
</span><span class="w">            </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># å®¹å™¨å¼€å‘å¯¹å¤–çš„ç«¯å£</span><span class="w">
</span><span class="w">            </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># åè®®</span><span class="w">
</span><span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="c"># é•œåƒä»“åº“æ‹‰å–å¯†é’¥</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-certification</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="c"># äº²å’Œæ€§è°ƒè¯•</span><span class="w">
</span><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w"> </span><span class="c"># èŠ‚ç‚¹äº²å’ŒåŠ›</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># pod å¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Š</span><span class="w">
</span><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w"> </span><span class="c"># èŠ‚ç‚¹æ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥</span><span class="w">
</span><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># æœ‰å¤šä¸ªé€‰é¡¹ï¼Œåˆ™åªæœ‰åŒæ—¶æ»¡è¶³è¿™äº›é€»è¾‘é€‰é¡¹çš„èŠ‚ç‚¹æ‰èƒ½è¿è¡Œ pod</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">beta.kubernetes.io/arch</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">amd64</span><span class="w">
</span></code></pre></div><h3 id="service-yaml-åè¯è§£é‡Š">Service yaml åè¯è§£é‡Šï¼š</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># æŒ‡å®šapiç‰ˆæœ¬ï¼Œæ­¤å€¼å¿…é¡»åœ¨kubectl api-versionsä¸­ </span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w"> </span><span class="c"># æŒ‡å®šåˆ›å»ºèµ„æºçš„è§’è‰²/ç±»å‹ </span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºçš„å…ƒæ•°æ®/å±æ€§</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w"> </span><span class="c"># èµ„æºçš„åå­—ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­å¿…é¡»å”¯ä¸€</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w"> </span><span class="c"># éƒ¨ç½²åœ¨å“ªä¸ªnamespaceä¸­</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># è®¾å®šèµ„æºçš„æ ‡ç­¾</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># èµ„æºè§„èŒƒå­—æ®µ</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w"> </span><span class="c"># ClusterIP ç±»å‹</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># service ç«¯å£</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># å®¹å™¨æš´éœ²çš„ç«¯å£</span><span class="w">
</span><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># åè®®</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># ç«¯å£åç§°</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># é€‰æ‹©å™¨</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>kubeadmå®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤</title>
			<link>https://www.ngirl.xyz/posts/42-kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8k8s%E9%9B%86%E7%BE%A4/</link>
			<pubDate>Tue, 24 Mar 2020 11:10:41 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/42-kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8k8s%E9%9B%86%E7%BE%A4/</guid>
			<description>ç®€å•è®°å½•kubeadmæ–¹å¼å®‰è£…k8s1.16.4é«˜å¯ç”¨é›†ç¾¤,haproxyé€šè¿‡keepalivedç»‘å®šçš„vipæ¥è´Ÿè½½å‡è¡¡åˆ°ä¸‰å°master, å…¶ä¸­keepalivedåˆ™åä¹‹å•æœºæ•…éšœ,haproxyåˆ™è®©ä¸‰å°masterå¯ä»¥åŒæ—¶æä¾›æœåŠ¡.
 Centos7.6éƒ¨ç½²k8s v1.16.4é«˜å¯ç”¨é›†ç¾¤(ä¸»å¤‡æ¨¡å¼) ä½¿ç”¨kubeadmæ­å»ºé«˜å¯ç”¨k8s v1.16.3é›†ç¾¤(keepalived+haproxy)
   ä¸€ã€ å®‰è£…å‡†å¤‡  1.1 ä¸»æœºå  192.168.53.106 master01.k8s.io 192.168.53.107 master02.k8s.io 192.168.53.108 master03.k8s.io 192.168.53.137 master.k8s.io  1.2 åŒæ­¥æ—¶é—´, è®¾ç½®æ—¶åŒº  * * * * * /usr/sbin/ntpdate time.nist.gov timedatectl set-timezone Asia/Shanghai æˆ–è€… ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  1.3 å…³é—­SElinux  setenforce 0 sed -i &amp;quot;s/^SELINUX=enforcing/SELINUX=disabled/g&amp;quot; /etc/sysconfig/selinux sed -i &amp;quot;s/^SELINUX=enforcing/SELINUX=disabled/g&amp;quot; /etc/selinux/config sed -i &amp;quot;s/^SELINUX=permissive/SELINUX=disabled/g&amp;quot; /etc/sysconfig/selinux sed -i &amp;quot;s/^SELINUX=permissive/SELINUX=disabled/g&amp;quot; /etc/selinux/config  1.4 å…³é—­swap(å¦åˆ™kubeadm initæˆ–joinä¼šæŠ¥é”™)  &amp;gt; swapoff -a &amp;amp;&amp;amp; sysctl -w vm.</description>
			<content type="html"><![CDATA[<p>ç®€å•è®°å½•kubeadmæ–¹å¼å®‰è£…k8s1.16.4é«˜å¯ç”¨é›†ç¾¤,haproxyé€šè¿‡keepalivedç»‘å®šçš„vipæ¥è´Ÿè½½å‡è¡¡åˆ°ä¸‰å°master, å…¶ä¸­keepalivedåˆ™åä¹‹å•æœºæ•…éšœ,haproxyåˆ™è®©ä¸‰å°masterå¯ä»¥åŒæ—¶æä¾›æœåŠ¡.</p>
<p><img src="//zhangzw001.github.io/images/42/01.png" alt=""></p>
<!--more -->
<blockquote>
<p><a href="https://www.kubernetes.org.cn/6632.html">Centos7.6éƒ¨ç½²k8s v1.16.4é«˜å¯ç”¨é›†ç¾¤(ä¸»å¤‡æ¨¡å¼)</a>
<a href="https://www.cnblogs.com/ssgeek/p/11942062.html">ä½¿ç”¨kubeadmæ­å»ºé«˜å¯ç”¨k8s v1.16.3é›†ç¾¤(keepalived+haproxy)</a></p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ä¸€-å®‰è£…å‡†å¤‡">ä¸€ã€ å®‰è£…å‡†å¤‡</h3>
<ul>
<li>1.1 ä¸»æœºå</li>
</ul>
<pre><code>192.168.53.106 master01.k8s.io
192.168.53.107 master02.k8s.io
192.168.53.108 master03.k8s.io
192.168.53.137 master.k8s.io
</code></pre><ul>
<li>1.2 åŒæ­¥æ—¶é—´, è®¾ç½®æ—¶åŒº</li>
</ul>
<pre><code>* * * * * /usr/sbin/ntpdate time.nist.gov

timedatectl set-timezone Asia/Shanghai
æˆ–è€…
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre><ul>
<li>1.3 å…³é—­SElinux</li>
</ul>
<pre><code>setenforce  0
sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/selinux/config  
</code></pre><ul>
<li>1.4 å…³é—­swap(å¦åˆ™kubeadm initæˆ–joinä¼šæŠ¥é”™)</li>
</ul>
<pre><code>&gt; swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
vm.swappiness = 0
æˆ– swapoff -a

#/etc/fstabä¹Ÿè¦æ³¨è§£æ‰SWAPæŒ‚è½½ã€‚
sed -i.$(date +%F).bak '/swap/s/^/#/' /etc/fstab
#sed -i 's/.*swap.*/#&amp;/' /etc/fstab

</code></pre><ul>
<li>1.5 é…ç½®ç³»ç»Ÿå†…æ ¸å‚æ•°</li>
</ul>
<pre><code>ä½¿æµè¿‡ç½‘æ¡¥çš„æµé‡ä¹Ÿè¿›å…¥iptables/netfilteræ¡†æ¶ä¸­ï¼Œåœ¨/etc/sysctl.confä¸­æ·»åŠ ä»¥ä¸‹é…ç½®
cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

sysctl -p /etc/sysctl.d/k8s.conf
</code></pre><blockquote>
<p>å¦‚æœå‡ºç°æŠ¥é”™</p>
</blockquote>
<pre><code>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory
sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory
</code></pre><blockquote>
<p>æŠ¥é”™è§£å†³:</p>
</blockquote>
<pre><code># æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
1 modprobe br_netfilter
2 ls /proc/sys/net/bridge
3 sysctl -p /etc/sysctl.d/k8s.conf
</code></pre><ul>
<li>1.6 è®¾ç½®k8sæº</li>
</ul>
<pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum clean all
yum makecache -y
</code></pre><pre><code>[] ä¸­æ‹¬å·ä¸­çš„æ˜¯repository idï¼Œå”¯ä¸€ï¼Œç”¨æ¥æ ‡è¯†ä¸åŒä»“åº“
name ä»“åº“åç§°ï¼Œè‡ªå®šä¹‰
baseurl ä»“åº“åœ°å€
enable æ˜¯å¦å¯ç”¨è¯¥ä»“åº“ï¼Œé»˜è®¤ä¸º1è¡¨ç¤ºå¯ç”¨
gpgcheck æ˜¯å¦éªŒè¯ä»è¯¥ä»“åº“è·å¾—ç¨‹åºåŒ…çš„åˆæ³•æ€§ï¼Œ1ä¸ºéªŒè¯
repo_gpgcheck æ˜¯å¦éªŒè¯å…ƒæ•°æ®çš„åˆæ³•æ€§ å…ƒæ•°æ®å°±æ˜¯ç¨‹åºåŒ…åˆ—è¡¨ï¼Œ1ä¸ºéªŒè¯
gpgkey=URL æ•°å­—ç­¾åçš„å…¬é’¥æ–‡ä»¶æ‰€åœ¨ä½ç½®ï¼Œå¦‚æœgpgcheckå€¼ä¸º1ï¼Œæ­¤å¤„å°±éœ€è¦æŒ‡å®šgpgkeyæ–‡ä»¶çš„ä½ç½®ï¼Œå¦‚æœgpgcheckå€¼ä¸º0å°±ä¸éœ€è¦æ­¤é¡¹äº†
</code></pre><ul>
<li>
<p>1.7 å…å¯†ç™»å½•é…ç½®</p>
<p>ç•¥</p>
</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="äºŒ-dockerç‰ˆæœ¬å®‰è£…">äºŒã€ dockerç‰ˆæœ¬å®‰è£…</h3>
<ul>
<li>2.1 é…ç½®æº</li>
</ul>
<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2 bash-completion
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y

# é«˜ç‰ˆæœ¬é™çº§
yum downgrade --setopt=obsoletes=0 -y docker-ce-18.09.9 docker-ce-cli-18.09.9
</code></pre><ul>
<li>2.2 é…ç½®é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿå™¨</li>
</ul>
<blockquote>
<p>ç™»é™†åœ°å€ä¸ºï¼šhttps://cr.console.aliyun.com ,æœªæ³¨å†Œçš„å¯ä»¥å…ˆæ³¨å†Œé˜¿é‡Œäº‘è´¦æˆ·</p>
</blockquote>
<pre><code>mkdir -p /etc/docker
tee /etc/docker/daemon.json &lt;&lt;-'EOF'
{
&quot;registry-mirrors&quot;: [&quot;https://0aqwccdy.mirror.aliyuncs.com&quot;]
}
EOF
</code></pre><ul>
<li>2.3 å¯åŠ¨docker</li>
</ul>
<pre><code>systemctl restart docker
systemctl enable docker
</code></pre><ul>
<li>2.4 ä¿®æ”¹Cgroup Driver</li>
</ul>
<blockquote>
<p>ä¿®æ”¹daemon.jsonï¼Œæ–°å¢â€˜â€exec-optsâ€: [â€œnative.cgroupdriver=systemdâ€â€™</p>
</blockquote>
<pre><code>cat /etc/docker/daemon.json
{
  &quot;registry-mirrors&quot;: [&quot;https://0aqwccdy.mirror.aliyuncs.com&quot;],
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
</code></pre><blockquote>
<p>é‡æ–°åŠ è½½docker</p>
</blockquote>
<pre><code>systemctl restart docker
systemctl enable docker
</code></pre><blockquote>
<p>ä¿®æ”¹cgroupdriveræ˜¯ä¸ºäº†æ¶ˆé™¤å‘Šè­¦ï¼š</p>
</blockquote>
<pre><code>[WARNING IsDockerSystemdCheck]: detected â€œcgroupfsâ€ as the Docker cgroup driver. The recommended driver is â€œsystemdâ€. Please follow the guide at https://kubernetes.io/docs/setup/cri/
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ä¸‰-keepalivedå®‰è£…">ä¸‰ã€ keepalivedå®‰è£…</h3>
<ul>
<li>3.1 å®‰è£…</li>
</ul>
<pre><code>yum -y install keepalived
</code></pre><ul>
<li>3.2 master01.k8s.ioä¸Šé…ç½®</li>
</ul>
<pre><code>tee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'
! Configuration File for keepalived
global_defs {
   router_id master01.k8s.io
}

vrrp_script check_haproxy {
    script &quot;killall -0 haproxy&quot;
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface enp0s3
    virtual_router_id 51
    priority 250
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.53.137
    }
    track_script {
        check_haproxy
    }
}
EOF
</code></pre><ul>
<li>3.3 master02.k8s.io,master03.k8s.ioä¸Šé…ç½®</li>
</ul>
<pre><code>tee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'
! Configuration File for keepalived
global_defs {
   router_id master02.k8s.io
}

vrrp_script check_haproxy {
    script &quot;killall -0 haproxy&quot;
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state BACKUP
    interface enp0s3
    virtual_router_id 51
    priority 200
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
       192.168.53.137
    }
    track_script {
        check_haproxy
    }
}
EOF


tee /etc/keepalived/keepalived.conf &lt;&lt;- 'EOF'
! Configuration File for keepalived
global_defs {
   router_id master03.k8s.io
}

vrrp_script check_haproxy {
    script &quot;killall -0 haproxy&quot;
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state BACKUP
    interface enp0s3
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.53.137
    }
    track_script {
        check_haproxy
    }
}
EOF
</code></pre><ul>
<li>3.4 master02.k8s.io,master03.k8s.ioä¸Šå¯åŠ¨keepalived</li>
</ul>
<pre><code>service keepalived start
systemctl enable keepalived
</code></pre><ul>
<li>3.5 æµ‹è¯•</li>
</ul>
<pre><code># é¦–å…ˆ ip aæŸ¥çœ‹ipå¦åˆ™ç»‘å®šæˆåŠŸ

# ping 192.168.53.137 æ˜¯å¦æ­£å¸¸

# åœ¨master01.k8s.ioä¸Š åœæ­¢æœåŠ¡ service keepalived stop

# åœ¨master02.k8s.ioæˆ–master03.k8s.ioä¸ŠæŸ¥çœ‹ip aæ˜¯å¦å­˜åœ¨192.168.53.137, æ£€æŸ¥ping 192.168.53.137 æ˜¯å¦æ­£å¸¸
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å››-haproxyå®‰è£…">å››ã€ haproxyå®‰è£…</h3>
<ul>
<li>
<p>4.1 å®‰è£…</p>
<pre><code></code></pre></li>
</ul>
<p>yum install -y haproxy</p>
<pre><code>
- 4.2 é…ç½®
&gt; ä¸‰å°masterèŠ‚ç‚¹çš„é…ç½®å‡ç›¸åŒï¼Œé…ç½®ä¸­å£°æ˜äº†åç«¯ä»£ç†çš„ä¸‰ä¸ªmasterèŠ‚ç‚¹æœåŠ¡å™¨ï¼ŒæŒ‡å®šäº†haproxyè¿è¡Œçš„ç«¯å£ä¸º16443ç­‰ï¼Œå› æ­¤16443ç«¯å£ä¸ºé›†ç¾¤çš„å…¥å£ï¼Œå…¶ä»–çš„é…ç½®ä¸åšèµ˜è¿°ã€‚
</code></pre><p>tee  /etc/haproxy/haproxy.cfg &laquo;- &lsquo;EOF&rsquo;
#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</p>
<h1 id="global-settings">Global settings</h1>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
global
# to have these messages end up in /var/log/haproxy.log you will
# need to:
# 1) configure syslog to accept network log events.  This is done
#    by adding the &lsquo;-r&rsquo; option to the SYSLOGD_OPTIONS in
#    /etc/sysconfig/syslog
# 2) configure local2 events to go to the /var/log/haproxy.log
#   file. A line like the following can be added to
#   /etc/sysconfig/syslog
#
#    local2.*                       /var/log/haproxy.log
#
log         127.0.0.1 local2</p>
<pre><code>chroot      /var/lib/haproxy
pidfile     /var/run/haproxy.pid
maxconn     4000
user        haproxy
group       haproxy
daemon

# turn on stats unix socket
stats socket /var/lib/haproxy/stats
</code></pre>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</p>
<h1 id="common-defaults-that-all-the-listen-and-backend-sections-will">common defaults that all the &lsquo;listen&rsquo; and &lsquo;backend&rsquo; sections will</h1>
<h1 id="use-if-not-designated-in-their-block">use if not designated in their block</h1>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;<br>
defaults
mode                    http
log                     global
option                  httplog
option                  dontlognull
option http-server-close
option forwardfor       except 127.0.0.0/8
option                  redispatch
retries                 3
timeout http-request    10s
timeout queue           1m
timeout connect         10s
timeout client          1m
timeout server          1m
timeout http-keep-alive 10s
timeout check           10s
maxconn                 3000
#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</p>
<h1 id="kubernetes-apiserver-frontend-which-proxys-to-the-backends">kubernetes apiserver frontend which proxys to the backends</h1>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
frontend kubernetes-apiserver
mode                 tcp
bind                 *:16443
option               tcplog
default_backend      kubernetes-apiserver <br>
#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</p>
<h1 id="round-robin-balancing-between-the-various-backends">round robin balancing between the various backends</h1>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
backend kubernetes-apiserver
mode        tcp
balance     roundrobin
server      master01.k8s.io   192.168.53.106:6443 check
server      master02.k8s.io   192.168.53.107:6443 check
server      master03.k8s.io   192.168.53.108:6443 check
#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</p>
<h1 id="collection-haproxy-statistics-message">collection haproxy statistics message</h1>
<p>#&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
listen stats
bind                 *:1080
stats auth           admin:awesomePassword
stats refresh        5s
stats realm          HAProxy\ Statistics
stats uri            /admin?stats
EOF</p>
<pre><code>
- 4.3 å¯åŠ¨

</code></pre><p>systemctl enable haproxy
systemctl start haproxy
systemctl status haproxy
netstat -lnptu|grep haproxy</p>
<pre><code>
&lt;center&gt;
&lt;img src=&quot;//zhangzw001.github.io/images/dockerniu.jpeg&quot; width = &quot;100&quot; height = &quot;100&quot; style=&quot;border: 0&quot;/&gt;
&lt;/center&gt;

### äº”ã€ k8så®‰è£…

- 5.1 ç‰ˆæœ¬æŸ¥çœ‹

</code></pre><p>yum list kubelet &ndash;showduplicates | sort -r</p>
<pre><code>
&gt; æœ¬æ–‡å®‰è£…çš„kubeletç‰ˆæœ¬æ˜¯1.16.4ï¼Œè¯¥ç‰ˆæœ¬æ”¯æŒçš„dockerç‰ˆæœ¬ä¸º1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09ã€‚

- 5.2 å®‰è£…kubeletã€kubeadmå’Œkubectl

</code></pre><p>yum install -y kubelet-1.16.4 kubeadm-1.16.4 kubectl-1.16.4</p>
<pre><code>
&gt; kubelet è¿è¡Œåœ¨é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œç”¨äºå¯åŠ¨Podå’Œå®¹å™¨ç­‰å¯¹è±¡çš„å·¥å…·
&gt; kubeadm ç”¨äºåˆå§‹åŒ–é›†ç¾¤ï¼Œå¯åŠ¨é›†ç¾¤çš„å‘½ä»¤å·¥å…·
&gt; kubectl ç”¨äºå’Œé›†ç¾¤é€šä¿¡çš„å‘½ä»¤è¡Œï¼Œé€šè¿‡kubectlå¯ä»¥éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ï¼ŒæŸ¥çœ‹å„ç§èµ„æºï¼Œåˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°å„ç§ç»„ä»¶

- 5.3 å¯åŠ¨kubelet

</code></pre><p>systemctl enable kubelet
systemctl start kubelet</p>
<pre><code>
- 5.4 kubectlå‘½ä»¤è¡¥å…¨

</code></pre><h1 id="bash">bash</h1>
<p>echo &ldquo;source &lt;(kubectl completion bash)&rdquo; &raquo; ~/.bash_profile
source ~/.bash_profile</p>
<h1 id="zsh">zsh</h1>
<p>echo &ldquo;source &lt;(kubectl completion zsh)&rdquo; &raquo; ~/.zshrc
source ~/.zshrc</p>
<pre><code>
- 5.5 ä¸‹è½½é•œåƒ
&gt; å¤–ç½‘çš„æ…¢, ä»é˜¿é‡Œäº‘ä¸‹è½½åæ‰“ä¸ªå®˜æ–¹tagå³å¯

</code></pre><p>tee /root/image.sh &laquo;- &lsquo;EOF&rsquo;
#!/bin/bash
#url=registry.cn-hangzhou.aliyuncs.com/loong576
url=registry.aliyuncs.com/google_containers
version=v1.16.4
images=(<code>kubeadm config images list --kubernetes-version=$version|awk -F '/' '{print $2}'</code>)
for imagename in ${images[@]} ; do
docker pull $url/$imagename
docker tag $url/$imagename k8s.gcr.io/$imagename
docker rmi -f $url/$imagename
done
EOF</p>
<h1 id="ä¸‹è½½">ä¸‹è½½</h1>
<p>sh  /root/image.sh</p>
<h1 id="éªŒè¯">éªŒè¯</h1>
<p>docker images|grep 1.16.4
k8s.gcr.io/kube-apiserver                  v1.16.4              3722a80984a0        3 months ago        217MB
k8s.gcr.io/kube-controller-manager         v1.16.4              fb4cca6b4e4c        3 months ago        163MB
k8s.gcr.io/kube-proxy                      v1.16.4              091df896d78f        3 months ago        86.1MB
k8s.gcr.io/kube-scheduler                  v1.16.4              2984964036c8        3 months ago        87.3MB
k8s.gcr.io/metrics-server-amd64            v0.3.5               abf04c0f54ff        6 months ago        39.9MB
k8s.gcr.io/etcd                            3.3.15-0             b2756210eeab        6 months ago        247MB
k8s.gcr.io/coredns                         1.6.2                bf261d157914        7 months ago        44.1MB
k8s.gcr.io/pause                           3.1                  da86e6ba6ca1        2 years ago         742kB</p>
<pre><code>
&lt;center&gt;
&lt;img src=&quot;//zhangzw001.github.io/images/dockerniu.jpeg&quot; width = &quot;100&quot; height = &quot;100&quot; style=&quot;border: 0&quot;/&gt;
&lt;/center&gt;

### å…­ã€åˆå§‹åŒ–master

- 6.1 kubeadm.1.16.4.conf

&gt; åœ¨å…·æœ‰vipçš„masterä¸Šæ“ä½œï¼Œè¿™é‡Œä¸ºmaster01.k8s.io

</code></pre><p>tee /data/k8s-config/kubeadm.1.16.4.conf &laquo;- &lsquo;EOF&rsquo;
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.16.4
apiServer:
certSANs:    #å¡«å†™æ‰€æœ‰kube-apiserverèŠ‚ç‚¹çš„hostnameã€IPã€VIP</p>
<ul>
<li>master01.k8s.io</li>
<li>master02.k8s.io</li>
<li>master03.k8s.io</li>
<li>master.k8s.io</li>
<li>dk-node1</li>
<li>192.168.53.106</li>
<li>192.168.53.107</li>
<li>192.168.53.108</li>
<li>192.168.53.137</li>
<li>192.168.0.136</li>
<li>127.0.0.1
controlPlaneEndpoint: &ldquo;master.k8s.io:16443&rdquo;
networking:
podSubnet: &ldquo;10.244.0.0/16&rdquo;
EOF</li>
</ul>
<pre><code>
- 6.2 masteråˆå§‹åŒ–

</code></pre><p>kubeadm init &ndash;config=kubeadm.1.16.4.conf</p>
<pre><code>
</code></pre><p>You can now join any number of control-plane nodes by copying certificate authorities
and service account keys on each node and then running the following as root:</p>
<p>kubeadm join master.k8s.io:16443 &ndash;token ynaob5.49rz8ofxavp6hzes<br>
&ndash;discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac<br>
&ndash;control-plane</p>
<p>Then you can join any number of worker nodes by running the following on each as root:</p>
<p>kubeadm join master.k8s.io:16443 &ndash;token ynaob5.49rz8ofxavp6hzes<br>
&ndash;discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac</p>
<pre><code>
- 6.3 åŠ è½½ç¯å¢ƒå˜é‡

</code></pre><p>echo &ldquo;export KUBECONFIG=/etc/kubernetes/admin.conf&rdquo; &raquo; ~/.zshrc
source ~/.zshrc</p>
<pre><code>
  æœ¬æ–‡æ‰€æœ‰æ“ä½œéƒ½åœ¨rootç”¨æˆ·ä¸‹æ‰§è¡Œï¼Œè‹¥ä¸ºérootç”¨æˆ·ï¼Œåˆ™æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

</code></pre><p>mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config</p>
<pre><code>
- 6.4 å®‰è£…flannelç½‘ç»œ

</code></pre><p>kubectl apply -f <a href="https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</a></p>
<p>podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds-amd64 created
daemonset.apps/kube-flannel-ds-arm64 created
daemonset.apps/kube-flannel-ds-arm created
daemonset.apps/kube-flannel-ds-ppc64le created
daemonset.apps/kube-flannel-ds-s390x created</p>
<pre><code>
&lt;center&gt;
&lt;img src=&quot;//zhangzw001.github.io/images/dockerniu.jpeg&quot; width = &quot;100&quot; height = &quot;100&quot; style=&quot;border: 0&quot;/&gt;
&lt;/center&gt;

### ä¸ƒã€control planeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤

- 7.1 è¯ä¹¦åˆ†å‘

  &gt; åœ¨master01.k8s.ioä¸Šè¿è¡Œè„šæœ¬cert-main-master.shï¼Œå°†è¯ä¹¦åˆ†å‘è‡³master02.k8s.io

</code></pre><p>tee /root/cert-main-master.sh  &laquo;- &lsquo;EOF&rsquo;
USER=root # customizable
CONTROL_PLANE_IPS=&ldquo;192.168.53.107 192.168.53.108&rdquo;
CONTROL_PLANE_pkidir=&quot;/etc/kubernetes/pki&quot;</p>
<p>for host in ${CONTROL_PLANE_IPS}; do
ssh root@${host} &ldquo;mkdir -p ${CONTROL_PLANE_pkidir}/etcd&rdquo;
scp /etc/kubernetes/pki/ca.crt &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/ca.key &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/sa.key &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/sa.pub &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/front-proxy-ca.crt &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/front-proxy-ca.key &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/
scp /etc/kubernetes/pki/etcd/ca.crt &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/etcd/ca.crt
# Quote this line if you are using external etcd
scp /etc/kubernetes/pki/etcd/ca.key &ldquo;${USER}&quot;@$host:${CONTROL_PLANE_pkidir}/etcd/ca.key
done
EOF</p>
<p>sh /root/cert-main-master.sh</p>
<pre><code>
- 7.2 master02.k8s.io,master03.k8s.ioåŠ å…¥é›†ç¾¤

</code></pre><p>kubeadm join master.k8s.io:16443 &ndash;token ynaob5.49rz8ofxavp6hzes<br>
&ndash;discovery-token-ca-cert-hash sha256:6e7859f3b9d8ede08e2202d3cd63c42f56c7d2503dc8c6fb9dc5f050b5c17bac<br>
&ndash;control-plane</p>
<pre><code>
- 6.3 master02.k8s.io,master03.k8s.ioåŠ è½½ç¯å¢ƒå˜é‡

</code></pre><p>echo &ldquo;export KUBECONFIG=/etc/kubernetes/admin.conf&rdquo; &raquo; ~/.zshrc
source ~/.zshrc</p>
<pre><code>
  æœ¬æ–‡æ‰€æœ‰æ“ä½œéƒ½åœ¨rootç”¨æˆ·ä¸‹æ‰§è¡Œï¼Œè‹¥ä¸ºérootç”¨æˆ·ï¼Œåˆ™æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

</code></pre><p>mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config</p>
<pre><code>

- 7.4 é›†ç¾¤èŠ‚ç‚¹æŸ¥çœ‹
</code></pre><h1 id="kubectl-get-nodes">kubectl get nodes</h1>
<p>NAME              STATUS   ROLES    AGE   VERSION
master01.k8s.io   Ready    master   6m    v1.16.4
master02.k8s.io   Ready    master   99s   v1.16.4
master03.k8s.io   Ready    master   46s   v1.16.4</p>
<h1 id="kubectl-get-pod--n-kube-system">kubectl get pod -n kube-system</h1>
<p>NAME                                      READY   STATUS    RESTARTS   AGE
coredns-5644d7b6d9-fz77l                  1/1     Running   0          4h
coredns-5644d7b6d9-qvh6b                  1/1     Running   0          4h
etcd-master01.k8s.io                      1/1     Running   1          4h15m
etcd-master02.k8s.io                      1/1     Running   0          4h12m
etcd-master03.k8s.io                      1/1     Running   0          4h11m
kube-apiserver-master01.k8s.io            1/1     Running   1          4h15m
kube-apiserver-master02.k8s.io            1/1     Running   0          4h12m
kube-apiserver-master03.k8s.io            1/1     Running   0          4h10m
kube-controller-manager-master01.k8s.io   1/1     Running   2          4h15m
kube-controller-manager-master02.k8s.io   1/1     Running   1          4h12m
kube-controller-manager-master03.k8s.io   1/1     Running   0          4h10m
kube-flannel-ds-amd64-84b6w               1/1     Running   1          4h15m
kube-flannel-ds-amd64-df99l               1/1     Running   0          4h11m
kube-flannel-ds-amd64-jzt62               1/1     Running   1          4h12m
kube-flannel-ds-amd64-lwd8m               1/1     Running   0          12m
kube-proxy-fgcmg                          1/1     Running   0          4h11m
kube-proxy-mss74                          1/1     Running   0          12m
kube-proxy-r9rz2                          1/1     Running   1          4h16m
kube-proxy-s47gj                          1/1     Running   0          4h12m
kube-scheduler-master01.k8s.io            1/1     Running   2          4h15m
kube-scheduler-master02.k8s.io            1/1     Running   1          4h12m
kube-scheduler-master03.k8s.io            1/1     Running   0          4h10m</p>
<h1 id="kubectl-get-cs">kubectl get cs</h1>
<p>NAME                 AGE
scheduler            <unknown>
controller-manager   <unknown>
etcd-0               <unknown></p>
<pre><code>
  &gt; æ‰§è¡Œ`kubectl get cs`æ˜¾ç¤º`&lt;unknown&gt;`æ˜¯ä¸€ä¸ª`1.16`ç‰ˆæœ¬å·²çŸ¥çš„`bug`ï¼Œåç»­å®˜æ–¹åº”è¯¥ä¼šè§£å†³å¤„ç†ï¼Œæœ‰å¤§ä½¬åˆ†æäº†æºç å¹¶ä¸”æäº¤äº†prï¼Œå¯[ç‚¹æ­¤å‚è€ƒ](https://segmentfault.com/a/1190000020912684)


- 7.5 æµ‹è¯•é›†ç¾¤
</code></pre><h1 id="1-æŸ¥çœ‹leader">1 æŸ¥çœ‹leader</h1>
<h1 id="kubectl-get-endpoints-kube-controller-manager--n-kube-system--o-yaml-grep-holderidentity">kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity</h1>
<p>control-plane.alpha.kubernetes.io/leader: &lsquo;{&ldquo;holderIdentity&rdquo;:&ldquo;master01.k8s.io_4b4f63f3-551e-4514-8aa9-a8fdbb13f1b4&rdquo;,&ldquo;leaseDurationSeconds&rdquo;:15,&ldquo;acquireTime&rdquo;:&ldquo;2020-03-24T02:40:32Z&rdquo;,&ldquo;renewTime&rdquo;:&ldquo;2020-03-24T02:45:47Z&rdquo;,&ldquo;leaderTransitions&rdquo;:1}&rsquo;</p>
<h1 id="2-åœ¨master01k8sio-ä¸Šæ‰§è¡Œ-init-0-å…³æœº-æ¨¡æ‹Ÿå®•æœº">2 åœ¨master01.k8s.io ä¸Šæ‰§è¡Œ init 0 å…³æœº æ¨¡æ‹Ÿå®•æœº</h1>
<h1 id="3-controller-managerå’Œschedulerä¹Ÿå‘ç”Ÿäº†è¿ç§»">3 controller-managerå’Œschedulerä¹Ÿå‘ç”Ÿäº†è¿ç§»</h1>
<h1 id="kubectl-get-endpoints-kube-controller-manager--n-kube-system--o-yaml-grep-holderidentity-1">kubectl get endpoints kube-controller-manager -n kube-system -o yaml |grep holderIdentity</h1>
<p>control-plane.alpha.kubernetes.io/leader: &lsquo;{&ldquo;holderIdentity&rdquo;:&ldquo;master02.k8s.io_457a8d6d-d0e4-4a8e-afbe-0c37f0dadf8d&rdquo;,&ldquo;leaseDurationSeconds&rdquo;:15,&ldquo;acquireTime&rdquo;:&ldquo;2020-03-24T02:46:03Z&rdquo;,&ldquo;renewTime&rdquo;:&ldquo;2020-03-24T02:50:50Z&rdquo;,&ldquo;leaderTransitions&rdquo;:2}&rsquo;</p>
<h1 id="4-é›†ç¾¤æ­¤æ—¶è¿˜æ˜¯èƒ½æ­£å¸¸æ“ä½œ">4 é›†ç¾¤æ­¤æ—¶è¿˜æ˜¯èƒ½æ­£å¸¸æ“ä½œ</h1>
<h1 id="kubectl-get-nodes-1">kubectl get nodes</h1>
<p>NAME              STATUS     ROLES    AGE   VERSION
master01.k8s.io   NotReady   master   17m   v1.16.4
master02.k8s.io   Ready      master   12m   v1.16.4
master03.k8s.io   Ready      master   11m   v1.16.4</p>
<pre><code>
  ![](//zhangzw001.github.io/images/42/02.png)

  ![](//zhangzw001.github.io/images/42/03.png)


- 7.6 å¯¼å…¥é›†ç¾¤åˆ°rancher
</code></pre><h1 id="è¿™é‡Œè¯·è‡ªè¡Œåœ¨rancherç•Œé¢ç”Ÿæˆæˆ‘è¿™é‡Œæ˜¯rancherv235">è¿™é‡Œè¯·è‡ªè¡Œåœ¨rancherç•Œé¢ç”Ÿæˆ(æˆ‘è¿™é‡Œæ˜¯rancherv2.3.5)</h1>
<p>curl &ndash;insecure -sfL <a href="https://rancher-dev.xxx.com/v3/import/68nzw8nlch92gshktcx2v5d8xvlvlk57nfgffz9jr7hxwfkwcbbtpz.yaml">https://rancher-dev.xxx.com/v3/import/68nzw8nlch92gshktcx2v5d8xvlvlk57nfgffz9jr7hxwfkwcbbtpz.yaml</a> | kubectl apply -f -</p>
<pre><code>
  ![](//zhangzw001.github.io/images/42/04.png)

</code></pre>]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡esé›†ç¾¤å†…å­˜æº¢å‡ºçš„é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/41-%E8%AE%B0%E4%B8%80%E6%AC%A1es%E9%9B%86%E7%BE%A4%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E7%9A%84%E9%97%AE%E9%A2%98/</link>
			<pubDate>Thu, 19 Mar 2020 10:26:49 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/41-%E8%AE%B0%E4%B8%80%E6%AC%A1es%E9%9B%86%E7%BE%A4%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E7%9A%84%E9%97%AE%E9%A2%98/</guid>
			<description>esæœºå™¨æŠ¥è­¦ç£ç›˜ / ç©ºé—´ä¸è¶³,æŸ¥çœ‹æ˜¯ç”Ÿæˆäº† .hprof æ–‡ä»¶, å†…å­˜æº¢å‡ºçš„å…¸å‹ç‰¹å¾
  ä»¥ä¸Šé—®é¢˜ä¸»è¦æ˜¯ä¸¤ç‚¹
 ç”±äºelasticsearchç”¨æˆ·å®¶ç›®å½•æ˜¯/home/elasticsearch, æ‰€ä»¥å†…å­˜æº¢å‡ºæ—¶ å†™çš„.hprofæ–‡ä»¶ä¼šç”Ÿæˆåˆ°å®¶ç›®å½•, å¹¶ä¸”å¤§å°æœ‰6G+, è¿™ä¼šå¯¼è‡´/ç›®å½•ç£ç›˜ç©ºé—´ä¸è¶³æŠ¥è­¦, æ˜¯å¦å¯ä»¥è®¾ç½®è¯¥æ—¥å¿—ç›®å½•? æˆ–è€…å–å·§è®¾ç½®elasticsearchå®¶ç›®å½•åˆ°/dataæŒ‚è½½ç›˜ä¸Š? å†…å­˜æº¢å‡ºçš„é—®é¢˜, æ˜¯å¦å¯ä»¥ä¼˜åŒ–å¹¶è§£å†³  é—®é¢˜1 æˆ‘è¿™é‡Œå¹¶æœªæ‰¾åˆ°è®¾ç½®.hprofæ–‡ä»¶çš„ç”Ÿæˆç›®å½•è·¯å¾„è®¾ç½®, æ‰€ä»¥æˆ‘å°±å°†æ ¹ç›®å½•åšäº†ä¸€ä¸ªé“¾æ¥ mv /home/elasticsearch /data/ ln -s /data/elasticsearch /home/elasticsearch æˆ–è€…ä¿®æ”¹elasticsearchç”¨æˆ·çš„å®¶ç›®å½•(ä¸è¿‡éœ€è¦ç”¨æˆ·æ²¡æœ‰åœ¨loginä¸­) lsof |grep elasticsearch usermod -d /data/elasticsearch elasticsearch é—®é¢˜2 å†…å­˜æº¢å‡ºçš„é—®é¢˜,æˆ‘ä»¬è®¾ç½® indices.fielddata.cache.size: 20%  elasticsearch2.x é™åˆ¶å†…å­˜ä½¿ç”¨
 indices.fielddata.cache.size æ§åˆ¶ä¸º fielddata åˆ†é…çš„å †ç©ºé—´å¤§å°ã€‚ å½“ä½ å‘èµ·ä¸€ä¸ªæŸ¥è¯¢ï¼Œåˆ†æå­—ç¬¦ä¸²çš„èšåˆå°†ä¼šè¢«åŠ è½½åˆ° fielddataï¼Œå¦‚æœè¿™äº›å­—ç¬¦ä¸²ä¹‹å‰æ²¡æœ‰è¢«åŠ è½½è¿‡ã€‚å¦‚æœç»“æœä¸­ fielddata å¤§å°è¶…è¿‡äº†æŒ‡å®š å¤§å° ï¼Œå…¶ä»–çš„å€¼å°†ä¼šè¢«å›æ”¶ä»è€Œè·å¾—ç©ºé—´ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¾ç½®éƒ½æ˜¯ unbounded ï¼ŒElasticsearch æ°¸è¿œéƒ½ä¸ä¼šä» fielddata ä¸­å›æ”¶æ•°æ®ã€‚ è¿™ä¸ªé»˜è®¤è®¾ç½®æ˜¯åˆ»æ„é€‰æ‹©çš„ï¼šfielddata ä¸æ˜¯ä¸´æ—¶ç¼“å­˜ã€‚å®ƒæ˜¯é©»ç•™å†…å­˜é‡Œçš„æ•°æ®ç»“æ„ï¼Œå¿…é¡»å¯ä»¥å¿«é€Ÿæ‰§è¡Œè®¿é—®ï¼Œè€Œä¸”æ„å»ºå®ƒçš„ä»£ä»·ååˆ†é«˜æ˜‚ã€‚å¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½é‡è½½æ•°æ®ï¼Œæ€§èƒ½ä¼šååˆ†ç³Ÿç³•ã€‚
ç›‘æ§fielddata  æŒ‰ç´¢å¼•ä½¿ç”¨ indices-stats API ï¼š  GET /_stats/fielddata?</description>
			<content type="html"><![CDATA[<p>esæœºå™¨æŠ¥è­¦ç£ç›˜ / ç©ºé—´ä¸è¶³,æŸ¥çœ‹æ˜¯ç”Ÿæˆäº† .hprof æ–‡ä»¶, å†…å­˜æº¢å‡ºçš„å…¸å‹ç‰¹å¾</p>
<!--more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<p>ä»¥ä¸Šé—®é¢˜ä¸»è¦æ˜¯ä¸¤ç‚¹</p>
<ol>
<li>ç”±äºelasticsearchç”¨æˆ·å®¶ç›®å½•æ˜¯/home/elasticsearch, æ‰€ä»¥å†…å­˜æº¢å‡ºæ—¶ å†™çš„.hprofæ–‡ä»¶ä¼šç”Ÿæˆåˆ°å®¶ç›®å½•, å¹¶ä¸”å¤§å°æœ‰6G+, è¿™ä¼šå¯¼è‡´/ç›®å½•ç£ç›˜ç©ºé—´ä¸è¶³æŠ¥è­¦, æ˜¯å¦å¯ä»¥è®¾ç½®è¯¥æ—¥å¿—ç›®å½•? æˆ–è€…å–å·§è®¾ç½®elasticsearchå®¶ç›®å½•åˆ°/dataæŒ‚è½½ç›˜ä¸Š?</li>
<li>å†…å­˜æº¢å‡ºçš„é—®é¢˜, æ˜¯å¦å¯ä»¥ä¼˜åŒ–å¹¶è§£å†³</li>
</ol>
<h3 id="é—®é¢˜1-æˆ‘è¿™é‡Œå¹¶æœªæ‰¾åˆ°è®¾ç½®hprofæ–‡ä»¶çš„ç”Ÿæˆç›®å½•è·¯å¾„è®¾ç½®-æ‰€ä»¥æˆ‘å°±å°†æ ¹ç›®å½•åšäº†ä¸€ä¸ªé“¾æ¥">é—®é¢˜1 æˆ‘è¿™é‡Œå¹¶æœªæ‰¾åˆ°è®¾ç½®.hprofæ–‡ä»¶çš„ç”Ÿæˆç›®å½•è·¯å¾„è®¾ç½®, æ‰€ä»¥æˆ‘å°±å°†æ ¹ç›®å½•åšäº†ä¸€ä¸ªé“¾æ¥</h3>
<pre><code>mv /home/elasticsearch /data/
ln -s /data/elasticsearch /home/elasticsearch
æˆ–è€…ä¿®æ”¹elasticsearchç”¨æˆ·çš„å®¶ç›®å½•(ä¸è¿‡éœ€è¦ç”¨æˆ·æ²¡æœ‰åœ¨loginä¸­)
lsof |grep elasticsearch
usermod -d /data/elasticsearch elasticsearch
</code></pre><h3 id="é—®é¢˜2-å†…å­˜æº¢å‡ºçš„é—®é¢˜æˆ‘ä»¬è®¾ç½®--indicesfielddatacachesize--20">é—®é¢˜2 å†…å­˜æº¢å‡ºçš„é—®é¢˜,æˆ‘ä»¬è®¾ç½®  indices.fielddata.cache.size:  20%</h3>
<blockquote>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_limiting_memory_usage.html#fielddata-size">elasticsearch2.x é™åˆ¶å†…å­˜ä½¿ç”¨</a></p>
</blockquote>
<p>indices.fielddata.cache.size æ§åˆ¶ä¸º fielddata åˆ†é…çš„å †ç©ºé—´å¤§å°ã€‚ å½“ä½ å‘èµ·ä¸€ä¸ªæŸ¥è¯¢ï¼Œåˆ†æå­—ç¬¦ä¸²çš„èšåˆå°†ä¼šè¢«åŠ è½½åˆ° fielddataï¼Œå¦‚æœè¿™äº›å­—ç¬¦ä¸²ä¹‹å‰æ²¡æœ‰è¢«åŠ è½½è¿‡ã€‚å¦‚æœç»“æœä¸­ fielddata å¤§å°è¶…è¿‡äº†æŒ‡å®š å¤§å° ï¼Œå…¶ä»–çš„å€¼å°†ä¼šè¢«å›æ”¶ä»è€Œè·å¾—ç©ºé—´ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¾ç½®éƒ½æ˜¯ unbounded ï¼ŒElasticsearch æ°¸è¿œéƒ½ä¸ä¼šä» fielddata ä¸­å›æ”¶æ•°æ®ã€‚
è¿™ä¸ªé»˜è®¤è®¾ç½®æ˜¯åˆ»æ„é€‰æ‹©çš„ï¼šfielddata ä¸æ˜¯ä¸´æ—¶ç¼“å­˜ã€‚å®ƒæ˜¯é©»ç•™å†…å­˜é‡Œçš„æ•°æ®ç»“æ„ï¼Œå¿…é¡»å¯ä»¥å¿«é€Ÿæ‰§è¡Œè®¿é—®ï¼Œè€Œä¸”æ„å»ºå®ƒçš„ä»£ä»·ååˆ†é«˜æ˜‚ã€‚å¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½é‡è½½æ•°æ®ï¼Œæ€§èƒ½ä¼šååˆ†ç³Ÿç³•ã€‚</p>
<h3 id="ç›‘æ§fielddata">ç›‘æ§fielddata</h3>
<ul>
<li>æŒ‰ç´¢å¼•ä½¿ç”¨ indices-stats API ï¼š</li>
</ul>
<pre><code>GET /_stats/fielddata?fields=*
</code></pre><ul>
<li>æŒ‰èŠ‚ç‚¹ä½¿ç”¨ nodes-stats API ï¼š</li>
</ul>
<pre><code>GET /_nodes/stats/indices/fielddata?fields=*
</code></pre><ul>
<li>æŒ‰ç´¢å¼•èŠ‚ç‚¹ï¼š</li>
</ul>
<pre><code>GET /_nodes/stats/indices/fielddata?level=indices&amp;fields=*
</code></pre><p>ä½¿ç”¨è®¾ç½® ?fields=* ï¼Œå¯ä»¥å°†å†…å­˜ä½¿ç”¨åˆ†é…åˆ°æ¯ä¸ªå­—æ®µã€‚</p>
<h3 id="æ–­è·¯å™¨">æ–­è·¯å™¨</h3>
<p>æœºæ•çš„è¯»è€…å¯èƒ½å·²ç»å‘ç° fielddata å¤§å°è®¾ç½®çš„ä¸€ä¸ªé—®é¢˜ã€‚fielddata å¤§å°æ˜¯åœ¨æ•°æ®åŠ è½½ ä¹‹å æ£€æŸ¥çš„ã€‚ å¦‚æœä¸€ä¸ªæŸ¥è¯¢è¯•å›¾åŠ è½½æ¯”å¯ç”¨å†…å­˜æ›´å¤šçš„ä¿¡æ¯åˆ° fielddata ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç­”æ¡ˆå¾ˆä¸‘é™‹ï¼šæˆ‘ä»¬ä¼šç¢°åˆ° OutOfMemoryException ã€‚</p>
<p>Elasticsearch åŒ…æ‹¬ä¸€ä¸ª fielddata æ–­ç†”å™¨ ï¼Œè¿™ä¸ªè®¾è®¡å°±æ˜¯ä¸ºäº†å¤„ç†ä¸Šè¿°æƒ…å†µã€‚ æ–­ç†”å™¨é€šè¿‡å†…éƒ¨æ£€æŸ¥ï¼ˆå­—æ®µçš„ç±»å‹ã€åŸºæ•°ã€å¤§å°ç­‰ç­‰ï¼‰æ¥ä¼°ç®—ä¸€ä¸ªæŸ¥è¯¢éœ€è¦çš„å†…å­˜ã€‚å®ƒç„¶åæ£€æŸ¥è¦æ±‚åŠ è½½çš„ fielddata æ˜¯å¦ä¼šå¯¼è‡´ fielddata çš„æ€»é‡è¶…è¿‡å †çš„é…ç½®æ¯”ä¾‹ã€‚</p>
<p>å¦‚æœä¼°ç®—æŸ¥è¯¢çš„å¤§å°è¶…å‡ºé™åˆ¶ï¼Œå°±ä¼š è§¦å‘ æ–­è·¯å™¨ï¼ŒæŸ¥è¯¢ä¼šè¢«ä¸­æ­¢å¹¶è¿”å›å¼‚å¸¸ã€‚è¿™éƒ½å‘ç”Ÿåœ¨æ•°æ®åŠ è½½ ä¹‹å‰ ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸ä¼šå¼•èµ· OutOfMemoryException ã€‚</p>
<pre><code>å¯ç”¨çš„æ–­è·¯å™¨ï¼ˆAvailable Circuit Breakersï¼‰

Elasticsearch æœ‰ä¸€ç³»åˆ—çš„æ–­è·¯å™¨ï¼Œå®ƒä»¬éƒ½èƒ½ä¿è¯å†…å­˜ä¸ä¼šè¶…å‡ºé™åˆ¶ï¼š

indices.breaker.fielddata.limit
fielddata æ–­è·¯å™¨é»˜è®¤è®¾ç½®å †çš„ 60% ä½œä¸º fielddata å¤§å°çš„ä¸Šé™ã€‚
indices.breaker.request.limit
request æ–­è·¯å™¨ä¼°ç®—éœ€è¦å®Œæˆå…¶ä»–è¯·æ±‚éƒ¨åˆ†çš„ç»“æ„å¤§å°ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ªèšåˆæ¡¶ï¼Œé»˜è®¤é™åˆ¶æ˜¯å †å†…å­˜çš„ 40%ã€‚
indices.breaker.total.limit
total æ‰åˆ request å’Œ fielddata æ–­è·¯å™¨ä¿è¯ä¸¤è€…ç»„åˆèµ·æ¥ä¸ä¼šä½¿ç”¨è¶…è¿‡å †å†…å­˜çš„ 70%ã€‚
</code></pre><p>æ–­è·¯å™¨çš„é™åˆ¶å¯ä»¥åœ¨æ–‡ä»¶ config/elasticsearch.yml ä¸­æŒ‡å®šï¼Œå¯ä»¥åŠ¨æ€æ›´æ–°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„é›†ç¾¤ï¼š</p>
<pre><code>PUT /_cluster/settings
{
  &quot;persistent&quot; : {
    &quot;indices.breaker.fielddata.limit&quot; : &quot;40%&quot; 
  }
}
</code></pre><p>æœ€å¥½ä¸ºæ–­è·¯å™¨è®¾ç½®ä¸€ä¸ªç›¸å¯¹ä¿å®ˆç‚¹çš„å€¼ã€‚ è®°ä½ fielddata éœ€è¦ä¸ request æ–­è·¯å™¨å…±äº«å †å†…å­˜ã€ç´¢å¼•ç¼“å†²å†…å­˜å’Œè¿‡æ»¤å™¨ç¼“å­˜ã€‚Lucene çš„æ•°æ®è¢«ç”¨æ¥æ„é€ ç´¢å¼•ï¼Œä»¥åŠå„ç§å…¶ä»–ä¸´æ—¶çš„æ•°æ®ç»“æ„ã€‚ æ­£å› å¦‚æ­¤ï¼Œå®ƒé»˜è®¤å€¼éå¸¸ä¿å®ˆï¼Œåªæœ‰ 60% ã€‚è¿‡äºä¹è§‚çš„è®¾ç½®å¯èƒ½ä¼šå¼•èµ·æ½œåœ¨çš„å †æ ˆæº¢å‡ºï¼ˆOOMï¼‰å¼‚å¸¸ï¼Œè¿™ä¼šä½¿æ•´ä¸ªèŠ‚ç‚¹å®•æ‰ã€‚</p>
<blockquote>
<p>åœ¨ Fielddataçš„å¤§å° ä¸­ï¼Œæˆ‘ä»¬æè¿‡å…³äºç»™ fielddata çš„å¤§å°åŠ ä¸€ä¸ªé™åˆ¶ï¼Œä»è€Œç¡®ä¿æ—§çš„æ— ç”¨ fielddata è¢«å›æ”¶çš„æ–¹æ³•ã€‚ indices.fielddata.cache.size å’Œ indices.breaker.fielddata.limit ä¹‹é—´çš„å…³ç³»éå¸¸é‡è¦ã€‚ å¦‚æœæ–­è·¯å™¨çš„é™åˆ¶ä½äºç¼“å­˜å¤§å°ï¼Œæ²¡æœ‰æ•°æ®ä¼šè¢«å›æ”¶ã€‚ä¸ºäº†èƒ½æ­£å¸¸å·¥ä½œï¼Œæ–­è·¯å™¨çš„é™åˆ¶ å¿…é¡» è¦æ¯”ç¼“å­˜å¤§å°è¦é«˜ã€‚</p>
</blockquote>
<h3 id="åœ¨è®¾ç½®-elasticsearch-å †å¤§å°æ—¶éœ€è¦é€šè¿‡-es_heap_size-ç¯å¢ƒå˜é‡åº”ç”¨ä¸¤ä¸ªè§„åˆ™">åœ¨è®¾ç½® Elasticsearch å †å¤§å°æ—¶éœ€è¦é€šè¿‡ $ES_HEAP_SIZE ç¯å¢ƒå˜é‡åº”ç”¨ä¸¤ä¸ªè§„åˆ™ï¼š</h3>
<h2 id="å¦‚æœå †å¤§å°å°äº-32-gbjvm-å¯ä»¥åˆ©ç”¨æŒ‡é’ˆå‹ç¼©è¿™å¯ä»¥å¤§å¤§é™ä½å†…å­˜çš„ä½¿ç”¨æ¯ä¸ªæŒ‡é’ˆ-4-å­—èŠ‚è€Œä¸æ˜¯-8-å­—èŠ‚">1 ä¸è¦è¶…è¿‡å¯ç”¨ RAM çš„ 50%
Lucene èƒ½å¾ˆå¥½åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜ï¼Œå®ƒæ˜¯é€šè¿‡ç³»ç»Ÿå†…æ ¸ç®¡ç†çš„ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ç©ºé—´ï¼Œæ€§èƒ½ä¼šå—åˆ°å½±å“ã€‚ æ­¤å¤–ï¼Œä¸“ç”¨äºå †çš„å†…å­˜è¶Šå¤šæ„å‘³ç€å…¶ä»–æ‰€æœ‰ä½¿ç”¨ doc values çš„å­—æ®µå†…å­˜è¶Šå°‘ã€‚
2 ä¸è¦è¶…è¿‡ 32 GB
å¦‚æœå †å¤§å°å°äº 32 GBï¼ŒJVM å¯ä»¥åˆ©ç”¨æŒ‡é’ˆå‹ç¼©ï¼Œè¿™å¯ä»¥å¤§å¤§é™ä½å†…å­˜çš„ä½¿ç”¨ï¼šæ¯ä¸ªæŒ‡é’ˆ 4 å­—èŠ‚è€Œä¸æ˜¯ 8 å­—èŠ‚ã€‚</h2>
]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡è·¨åŸŸçš„nginxé…ç½®é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/40-%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B7%A8%E5%9F%9F%E7%9A%84nginx%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</link>
			<pubDate>Wed, 18 Mar 2020 18:26:35 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/40-%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B7%A8%E5%9F%9F%E7%9A%84nginx%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</guid>
			<description>&lt;p&gt;nginxè·¨åŸŸçš„Access-Control-Allow-Originçš„é…ç½® å’Œå¤šåŸŸåé…ç½®çš„é—®é¢˜&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>nginxè·¨åŸŸçš„Access-Control-Allow-Originçš„é…ç½® å’Œå¤šåŸŸåé…ç½®çš„é—®é¢˜</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> ç®€å•é…ç½® </font>
</center>
<h3 id="1-nginx-é…ç½®å•ä¸ªåŸŸå">1. nginx é…ç½®å•ä¸ªåŸŸå</h3>
<pre><code>        add_header Access-Control-Allow-Origin &quot;a.test.com&quot;;
        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;
        add_header Access-Control-Allow-Headers authorization,sign,vary-client;
</code></pre><h3 id="2-nginx-é…ç½®æ‰€æœ‰åŸŸå">2. nginx é…ç½®æ‰€æœ‰åŸŸå</h3>
<pre><code>        add_header Access-Control-Allow-Origin &quot;*&quot;;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;
        add_header Access-Control-Allow-Headers authorization,sign,vary-client;
</code></pre><h3 id="3-nginx-é…ç½®å¤šåŸŸå">3. nginx é…ç½®å¤šåŸŸå</h3>
<blockquote>
<p>ä¸€å¼€å§‹æˆ‘æ˜¯è¿™æ ·é…ç½®çš„:</p>
</blockquote>
<pre><code>        ###################è¿™é‡Œæ˜¯é…ç½®å¤šåŸŸåè·¨åŸŸé…ç½®
	set $F_Allow_Origin &quot;127.0.0.1&quot;;
        #å¦‚æœæ˜¯å…è®¸çš„åŸŸååˆ™è®¾ç½®Access-Control-Allow-Origin ä¸ºè¯¥$http_origin
        if ( &quot;$http_origin&quot; ~ &quot;[a-z]+.zhangzw.com&quot; ) {
               set $F_Allow_Origin &quot;$http_origin&quot;;
        }
        add_header F_Allow_Origin &quot;$http_origin&quot;;
        add_header Access-Control-Allow-Origin &quot;$http_origin&quot;;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;
        add_header Access-Control-Allow-Headers authorization,sign,vary-client;
        ###################è¿™é‡Œæ˜¯é…ç½®å¤šåŸŸåè·¨åŸŸé…ç½®
</code></pre><p>æµ‹è¯•ä¹‹åå‘ç°é¡µé¢è¿˜æ˜¯æŠ¥æ²¡æœ‰Access-Control-Allow-Origin å¤´, åŸå› æ˜¯æˆ‘è¿™è¾¹ç”±b.test.com -&gt; a.test.com, F_Allow_Originè‡ªå®šä¹‰å¤´å¹¶æ²¡æœ‰å‘ä¸‹ä¼ é€’.</p>
<pre><code>        ###################è¿™é‡Œæ˜¯é…ç½®å¤šåŸŸåè·¨åŸŸé…ç½®
        #å¦‚æœæ˜¯å…è®¸çš„åŸŸååˆ™è®¾ç½®Access-Control-Allow-Origin ä¸ºè¯¥$http_origin
        #if ( &quot;$http_origin&quot; !~ &quot;[a-z]+.zhangzw.com&quot; ) {
        #       return 403;
        #}
        add_header Bq_F_Allow_Origin &quot;$http_origin&quot;;
        #add_header Access-Control-Allow-Origin &quot;$http_origin&quot;;
        add_header Access-Control-Allow-Origin &quot;*&quot;;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Allow-Methods GET,HEAD,PUT,PATCH,POST,DELETE;
        add_header Access-Control-Allow-Headers authorization,sign,vary-client;
        ###################è¿™é‡Œæ˜¯é…ç½®å¤šåŸŸåè·¨åŸŸé…ç½®
</code></pre>]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡nginxçš„request_time å’Œupstream_response_timeå·®å€¼å¾ˆå¤§é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/39-%E8%AE%B0%E4%B8%80%E6%AC%A1nginx%E7%9A%84request-time-%E5%92%8Cupstream-response-time%E5%B7%AE%E5%80%BC%E5%BE%88%E5%A4%A7%E9%97%AE%E9%A2%98/</link>
			<pubDate>Wed, 18 Mar 2020 10:43:34 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/39-%E8%AE%B0%E4%B8%80%E6%AC%A1nginx%E7%9A%84request-time-%E5%92%8Cupstream-response-time%E5%B7%AE%E5%80%BC%E5%BE%88%E5%A4%A7%E9%97%AE%E9%A2%98/</guid>
			<description>&lt;p&gt;é‡åˆ°ä¸€ä¸ªæ¥å£, ç»è¿‡äº†nginxåå‘ä»£ç†,request_timeæ—¶é—´æ˜¯60s+, upstream_response_time åœ¨0.5så·¦å³&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>é‡åˆ°ä¸€ä¸ªæ¥å£, ç»è¿‡äº†nginxåå‘ä»£ç†,request_timeæ—¶é—´æ˜¯60s+, upstream_response_time åœ¨0.5så·¦å³</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<p>é¦–å…ˆé—®é¢˜æè¿°æˆ‘ä»¬å‘ç°åç«¯å“åº”æ—¶é—´æ²¡é—®é¢˜, ä»å‰ç«¯å’Œåç«¯çš„æ—¥å¿—éƒ½å‘ç°å“åº”çŠ¶æ€æ˜¯200, è¯´æ˜è¯·æ±‚éƒ½æ˜¯æ­£å¸¸çš„</p>
<p>é‚£ä¸ºå•¥ä¼šå“åº”æ—¶é—´è¿™ä¹ˆé•¿å‘¢?</p>
<ul>
<li>
<p>request_time:  		æŒ‡çš„æ˜¯ (Nginx å»ºç«‹è¿æ¥ åˆ° æ¥æ”¶å®Œæ•°æ®å¹¶å…³é—­è¿æ¥)
ä»ä»£ç†nginxåˆ°åç«¯(è¿™é‡Œæ˜¯php)å»ºç«‹è¿æ¥åˆ°æ¥å—å®Œæ•°æ®ç„¶åå…³é—­è¿æ¥ä¸ºæ­¢çš„æ—¶é—´</p>
</li>
<li>
<p>upstream_response_time:	æŒ‡çš„æ˜¯ (æ¥å—ç”¨æˆ·è¯·æ±‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ åˆ° å‘é€å®Œå“åº”æ•°æ®)
ä»æ¥å—ç”¨æˆ·è¯·æ±‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ åˆ°å‘é€å®Œå“åº”æ•°æ®çš„æ—¶é—´(åŒ…æ‹¬æ¥å—è¯·æ±‚æ•°æ®æ—¶é—´,ç¨‹åºå“åº”æ—¶é—´,è¾“å‡ºå“åº”æ—¶é—´)</p>
</li>
</ul>
<p>é€šè¿‡æŸ¥çœ‹æ—¥å¿—å‘ç°å“åº”è¿”å›çš„å­—èŠ‚é‡åœ¨ 300kå·¦å³, äºæ˜¯å»çœ‹äº†ä¸‹å‰ç«¯nginxçš„å¸¦å®½, å¹¶æ²¡æœ‰å‘ç°è¶…è¿‡100%, è€Œä¸”æ—¥å¿—çš„åŒä¸€æ—¶é—´çš„å¹¶ä¸æ˜¯æ‰€æœ‰è¯·æ±‚éƒ½è¶…è¿‡60s+</p>
<p>å› æ­¤çœ‹èµ·æ¥æœåŠ¡ç«¯ä¹Ÿæ­£å¸¸, åº”è¯¥æ˜¯å®¢æˆ·ç«¯é—®é¢˜</p>
<p>é€šè¿‡è¯¢é—®å¼€å‘, å‘ç°æ˜¯æµ‹è¯•åœ¨æœ¬æœºç–¯ç‹‚çš„ç‚¹å‡»,å¯¼è‡´å¹¶å‘é«˜, è€Œæµ‹è¯•çš„ç½‘ç»œç¯å¢ƒæ˜¯é™é€Ÿ5m, æ˜¾ç„¶å®¢æˆ·ç«¯å¸¦å®½æ¥æ”¶æ•°æ®é™åˆ¶å¯¼è‡´äº†æœåŠ¡ç«¯å‘é€å»¶è¿Ÿ.</p>
<p>æ˜¾ç„¶æˆ‘ä»¬çŸ¥é“request_time:  æŒ‡çš„æ˜¯ ä»æ¥å—ç”¨æˆ·è¯·æ±‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ åˆ°å‘é€å®Œå“åº”æ•°æ®çš„æ—¶é—´(åŒ…æ‹¬æ¥å—è¯·æ±‚æ•°æ®æ—¶é—´,ç¨‹åºå“åº”æ—¶é—´,è¾“å‡ºå“åº”æ—¶é—´)</p>]]></content>
		</item>
		
		<item>
			<title>macä¸€äº›å¸¸ç”¨å‘½ä»¤</title>
			<link>https://www.ngirl.xyz/posts/37-mac%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</link>
			<pubDate>Tue, 10 Mar 2020 17:39:36 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/37-mac%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</guid>
			<description>è®°å½•ä¸€äº›å¸¸ç”¨çš„macå·¥å…·å’Œæ–¹æ³•
 1. Item2     1.1 åŒæ—¶æŒ‰ä½ option(alt) é”®ï¼Œå¯ä»¥ä»¥åˆ—é€‰ä¸­ï¼Œç±»ä¼¼äº sublime3ä¸­ æŒ‰ä½ altçš„åˆ—é€‰ä¸­ ã€‚ Command + option(alt) 
  1.2 å‰ªè´´æ¿å†å²è®°å½• Command + Shift + h
  1.3 å°†æ–‡æœ¬å†…å®¹å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ pbcopy &amp;lt; a.txt
   N. å…¶ä»–    n.1 å‰è¿›çš„å¿«æ·é”®  1. sublime3 command + shift + z (æ¯”åé€€ command + z å¤šä¸€ä¸ªshift) æˆ–è€… command + y  n.2 ä»linuxç”Ÿæˆçš„.csvæ–‡ä»¶åˆ°macä¸Šä¹±ç   iconv -f UTF8 -t GB18030 2020-12-02.</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›å¸¸ç”¨çš„macå·¥å…·å’Œæ–¹æ³•</p>
<!-- more-->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> 1. Item2 </font>
</center>
<ul>
<li>
<p>1.1 åŒæ—¶æŒ‰ä½ option(alt) é”®ï¼Œå¯ä»¥ä»¥åˆ—é€‰ä¸­ï¼Œç±»ä¼¼äº sublime3ä¸­ æŒ‰ä½ altçš„åˆ—é€‰ä¸­ ã€‚
<code>Command + option(alt) </code></p>
</li>
<li>
<p>1.2 å‰ªè´´æ¿å†å²è®°å½•
<code>Command + Shift + h</code></p>
</li>
<li>
<p>1.3 å°†æ–‡æœ¬å†…å®¹å¤åˆ¶åˆ°å‰ªåˆ‡æ¿
<code>pbcopy &lt; a.txt</code></p>
</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> N. å…¶ä»– </font>
</center>
<ul>
<li>n.1 å‰è¿›çš„å¿«æ·é”®</li>
</ul>
<pre><code>1. sublime3
command + shift + z   (æ¯”åé€€ command + z å¤šä¸€ä¸ªshift)
æˆ–è€…
command + y
</code></pre><ul>
<li>n.2 ä»linuxç”Ÿæˆçš„.csvæ–‡ä»¶åˆ°macä¸Šä¹±ç </li>
</ul>
<pre><code>iconv -f UTF8 -t GB18030 2020-12-02.csv &gt; 2020-12-02-2.csv
</code></pre><ul>
<li>n.3 è¾“å…¥å¦‚ä½•è¾“å…¥ä¸­æ–‡å¥å·ã€‚ ï¼Ÿ</li>
</ul>
<pre><code>ç”±äºæˆ‘çš„æœç‹—è¾“å…¥æ³• åå¥½è®¾ç½® å¼€å¯äº† ä¸­æ–‡ä¸‹ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹, æ‰€ä»¥æˆ‘æ‰€æœ‰çš„æ ‡ç‚¹ç¬¦å·éƒ½æ˜¯è‹±æ–‡çš„
å› æ­¤æˆ‘è¦åˆ‡æ¢çš„è¿˜è¾“å…¥ control+. , å°±ä¼šåˆ‡æ¢åˆ°ä¸­æ–‡ä¸‹çš„æ ‡ç‚¹
</code></pre>]]></content>
		</item>
		
		<item>
			<title>centoså•ç½‘å¡é…ç½®å¤šipçš„å‡ ç§æ–¹æ³•</title>
			<link>https://www.ngirl.xyz/posts/36-centos%E5%8D%95%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E5%A4%9Aip%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/</link>
			<pubDate>Thu, 27 Feb 2020 11:48:51 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/36-centos%E5%8D%95%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E5%A4%9Aip%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/</guid>
			<description>centoså•ç½‘å¡é…ç½®å¤šipçš„å‡ ç§æ–¹æ³•
  æ–¹æ³•ä¸€ æ–°å»ºIPåˆ«å  ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯
 ifconfig enp0s3:1 192.168.53.109/24 ifconfig enp0s3:1 down  é…ç½®æ–‡ä»¶è®¾ç½®, éœ€è¦é‡å¯
 #cat ifcfg-enp0s3:1 DEVICE=enp0s3 IPADDR=192.168.53.109 NETMASK=255.255.255.0 # é‡å¯ç½‘ç»œ service network restart # æŸ¥çœ‹(ifconfig ä¹Ÿå¯ä»¥æŸ¥çœ‹) ip a æˆ–ifconfig æ–¹æ³•äºŒ ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯ ip addr add 192.168.53.110/24 dev enp0s3 label enp0s3:2 æ–¹æ³•ä¸‰ ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯ ifconfig enp0s3:3 192.168.53.111 netmask 255.255.255.0 æ–¹æ³•å›› åŒä¸€ä¸ªé…ç½®æ–‡ä»¶è®¾ç½®, éœ€è¦é‡å¯ã€‚IPåœ°å€æ²¡æœ‰åˆ«åä¸å¥½è¿›è¡Œç®¡ç†ã€‚ #cat ifcfg-enp0s3 DEVICE=enp0s3 IPADDR=192.168.53.106 IPADDR1=192.168.53.112 IPADDR2=192.168.53.113 PREFIX=24 PREFIX1=24 PREFIX2=24 # é‡å¯ç½‘ç»œ service network restart # æŸ¥çœ‹(ifconfig ä¸å¯ä»¥æŸ¥çœ‹) ip a  æ³¨: è¿™é‡Œå¥‡æ€ªçš„æ˜¯, å®é™…é…ç½®ä¸­,å‡ºç°ä¸ªåˆ«ipä½¿ç”¨æ–¹æ³•äºŒ,ä¸‰æ—¶ä»…éƒ¨åˆ†å†…ç½‘å¯ä»¥è”é€š,ä¾‹å¦‚ 10.</description>
			<content type="html"><![CDATA[<p>centoså•ç½‘å¡é…ç½®å¤šipçš„å‡ ç§æ–¹æ³•</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="æ–¹æ³•ä¸€-æ–°å»ºipåˆ«å">æ–¹æ³•ä¸€ æ–°å»ºIPåˆ«å</h3>
<blockquote>
<p>ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯</p>
</blockquote>
<pre><code>ifconfig enp0s3:1 192.168.53.109/24
ifconfig enp0s3:1 down
</code></pre><blockquote>
<p>é…ç½®æ–‡ä»¶è®¾ç½®, éœ€è¦é‡å¯</p>
</blockquote>
<pre><code>#cat ifcfg-enp0s3:1
DEVICE=enp0s3
IPADDR=192.168.53.109
NETMASK=255.255.255.0

# é‡å¯ç½‘ç»œ
service network restart

# æŸ¥çœ‹(ifconfig ä¹Ÿå¯ä»¥æŸ¥çœ‹)
ip a æˆ–ifconfig
</code></pre><h3 id="æ–¹æ³•äºŒ--ä¸´æ—¶è®¾ç½®-ä¸éœ€è¦é‡å¯">æ–¹æ³•äºŒ  ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯</h3>
<pre><code>ip addr add 192.168.53.110/24 dev enp0s3 label enp0s3:2
</code></pre><h3 id="æ–¹æ³•ä¸‰--ä¸´æ—¶è®¾ç½®-ä¸éœ€è¦é‡å¯">æ–¹æ³•ä¸‰  ä¸´æ—¶è®¾ç½®, ä¸éœ€è¦é‡å¯</h3>
<pre><code>ifconfig enp0s3:3 192.168.53.111 netmask 255.255.255.0
</code></pre><h3 id="æ–¹æ³•å››-åŒä¸€ä¸ªé…ç½®æ–‡ä»¶è®¾ç½®-éœ€è¦é‡å¯ipåœ°å€æ²¡æœ‰åˆ«åä¸å¥½è¿›è¡Œç®¡ç†">æ–¹æ³•å›› åŒä¸€ä¸ªé…ç½®æ–‡ä»¶è®¾ç½®, éœ€è¦é‡å¯ã€‚IPåœ°å€æ²¡æœ‰åˆ«åä¸å¥½è¿›è¡Œç®¡ç†ã€‚</h3>
<pre><code>#cat ifcfg-enp0s3
DEVICE=enp0s3
IPADDR=192.168.53.106
IPADDR1=192.168.53.112
IPADDR2=192.168.53.113
PREFIX=24
PREFIX1=24
PREFIX2=24

# é‡å¯ç½‘ç»œ
service network restart

# æŸ¥çœ‹(ifconfig ä¸å¯ä»¥æŸ¥çœ‹)
ip a 
</code></pre><blockquote>
<p>æ³¨:
è¿™é‡Œå¥‡æ€ªçš„æ˜¯, å®é™…é…ç½®ä¸­,å‡ºç°ä¸ªåˆ«ipä½¿ç”¨æ–¹æ³•äºŒ,ä¸‰æ—¶ä»…éƒ¨åˆ†å†…ç½‘å¯ä»¥è”é€š,ä¾‹å¦‚
10.10.76.1 é€šè¿‡æ–¹æ³•äºŒé…ç½®, ä»10.10.76.2ä¸Šå¯ä»¥pingé€š, ä½†æ˜¯ä»10.10.53.1ä¸Šæ— æ³•pingé€š(10.10.53.1å’Œ10.10.76.2æ˜¯å¯ä»¥pingé€š)
ä½†æ˜¯é€šè¿‡æ–¹æ³•å››é…ç½®å°±æ­£å¸¸&hellip; ç›®å‰æ²¡æœ‰æ‰¾åˆ°åŸå› &hellip; æˆ–ä¸å…¬å¸è·¯ç”±å™¨æœ‰å…³</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>raid1ç›˜æ•°æ®è¿ç§»</title>
			<link>https://www.ngirl.xyz/posts/35-raid1%E7%9B%98%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</link>
			<pubDate>Thu, 27 Feb 2020 09:54:38 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/35-raid1%E7%9B%98%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</guid>
			<description>dell PowerEdge 1950 æœåŠ¡å™¨ä¸¤å—ç›˜åšraid1çš„linuxæ“ä½œç³»ç»Ÿ, å¼€æœºåæ— é™é‡å¯çš„ä¸€æ¬¡æ•°æ®è¿ç§»
   è€ƒè™‘åˆ°raid1æ•°æ®æ˜¯äº’ä¸ºå¤‡ä»½,ç›´æ¥å–ä¸€å—ç›˜åº”è¯¥èƒ½å¤Ÿæ‹¿åˆ°æ‰€æœ‰æ•°æ®
  é¦–å…ˆå¯¹dell PowerEdge 1950 æœåŠ¡å™¨ å¼€æœº, åœ¨æç¤ºctrl +cçš„é¡µé¢ä¸Šè¿›å…¥sasé¡µé¢, è¿›å…¥é€‰ä¸­ç£ç›˜åå›è½¦, ç„¶åé€‰æ‹© SAS Topologyé¡µé¢, å¯ä»¥çœ‹åˆ°æ˜¯ä¸¤å—ç›˜åšçš„raid1   raid1 ä¿¡æ¯ç¡®è®¤å®Œæ¯•
  å…³é—­1950æœåŠ¡å™¨, å–ä¸‹å…¶ä¸­ä¸€å—ç›˜, è¿™é‡Œçœ‹åˆ°ç¡¬ç›˜æ˜¯sataç›˜
  è€ƒè™‘åˆ°è¯¥ç›˜ä¸ç¡®å®šæ˜¯å¦æ”¯æŒçƒ­æ’æ‹”, è¿™é‡Œæ˜¯å°†sataç›˜æ”¾å…¥usbç›˜æ¥åˆ°æŸå°LinuxæœåŠ¡å™¨, ç„¶åæŒ‚è½½, æŒ‚è½½æ³¨æ„fdisk -l çœ‹ä¸‹å…·ä½“åˆ†åŒº, æˆ‘è¿™é‡Œæ˜¯/dev/sdb3
mount /data /dev/sdb3
  è¿›å…¥/data, å°±ä¼šçœ‹åˆ°raid1ç¡¬ç›˜ä¸­ä¿ç•™çš„æ‰€æœ‰æ•°æ®
  </description>
			<content type="html"><![CDATA[<p>dell PowerEdge 1950 æœåŠ¡å™¨ä¸¤å—ç›˜åšraid1çš„linuxæ“ä½œç³»ç»Ÿ, å¼€æœºåæ— é™é‡å¯çš„ä¸€æ¬¡æ•°æ®è¿ç§»</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<blockquote>
<p>è€ƒè™‘åˆ°raid1æ•°æ®æ˜¯äº’ä¸ºå¤‡ä»½,ç›´æ¥å–ä¸€å—ç›˜åº”è¯¥èƒ½å¤Ÿæ‹¿åˆ°æ‰€æœ‰æ•°æ®</p>
</blockquote>
<ol>
<li>é¦–å…ˆå¯¹dell PowerEdge 1950 æœåŠ¡å™¨ å¼€æœº, åœ¨æç¤ºctrl +cçš„é¡µé¢ä¸Šè¿›å…¥sasé¡µé¢, è¿›å…¥é€‰ä¸­ç£ç›˜åå›è½¦, ç„¶åé€‰æ‹© SAS Topologyé¡µé¢, å¯ä»¥çœ‹åˆ°æ˜¯ä¸¤å—ç›˜åšçš„raid1</li>
</ol>
<blockquote>
<p>raid1 ä¿¡æ¯ç¡®è®¤å®Œæ¯•</p>
</blockquote>
<ol start="2">
<li>
<p>å…³é—­1950æœåŠ¡å™¨, å–ä¸‹å…¶ä¸­ä¸€å—ç›˜,  è¿™é‡Œçœ‹åˆ°ç¡¬ç›˜æ˜¯sataç›˜</p>
</li>
<li>
<p>è€ƒè™‘åˆ°è¯¥ç›˜ä¸ç¡®å®šæ˜¯å¦æ”¯æŒçƒ­æ’æ‹”, è¿™é‡Œæ˜¯å°†sataç›˜æ”¾å…¥usbç›˜æ¥åˆ°æŸå°LinuxæœåŠ¡å™¨, ç„¶åæŒ‚è½½, æŒ‚è½½æ³¨æ„fdisk -l çœ‹ä¸‹å…·ä½“åˆ†åŒº, æˆ‘è¿™é‡Œæ˜¯/dev/sdb3</p>
<p>mount /data /dev/sdb3</p>
</li>
<li>
<p>è¿›å…¥/data, å°±ä¼šçœ‹åˆ°raid1ç¡¬ç›˜ä¸­ä¿ç•™çš„æ‰€æœ‰æ•°æ®</p>
</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>k8sä¸€äº›å‘½ä»¤æ€»ç»“</title>
			<link>https://www.ngirl.xyz/posts/34-k8s%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</link>
			<pubDate>Thu, 05 Dec 2019 09:25:59 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/34-k8s%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</guid>
			<description>è®°å½•ä¸€äº›kubectlå‘½ä»¤
kubectlå‘½ä»¤è¡¨
  å¸¸ç”¨å‘½ä»¤ # è®©å†…ç½‘å¯ä»¥è®¿é—® k8s proxy(k8smasteræ˜¯:192.168.1.111 kubectl proxy --address=&#39;192.168.1.111&#39; -p 10000 --accept-hosts=&#39;^172.*$&#39; # æŸ¥çœ‹apiç±»å‹ kubectl api-versions # è®©masterä¹Ÿè¿è¡Œpodï¼ˆé»˜è®¤masterä¸è¿è¡Œpod,å•æœºä¼šç”¨åˆ°ï¼‰ kubectl taint nodes --all node-role.kubernetes.io/master- # patchè¡¥ä¸, å¼ºåˆ¶æ›´æ–° kubectl patch -f deployment.yaml -p &amp;quot;{\&amp;quot;spec\&amp;quot;:{\&amp;quot;template\&amp;quot;:{\&amp;quot;metadata\&amp;quot;:{\&amp;quot;annotations\&amp;quot;:{\&amp;quot;ci-last-updated\&amp;quot;:\&amp;quot;$(date +&#39;%s&#39;)\&amp;quot;}}}}}&amp;quot; # ç«¯å£è½¬å‘ kubectl -n default port-forward service/prometheus-server 30080:80   scale ä½¿ç”¨ # é€šè¿‡å°†rcçš„å‰¯æœ¬æ•°é‡æ–°è®¾ç½®ä¸º0åï¼Œå†å°†å‰¯æœ¬æ•°è®¾ç½®ä¸º2ï¼Œè¾¾åˆ°é‡å¯nginxçš„æ•ˆæœã€‚ kubectl scale deployment bq-front1 --replicas=0 -n web kubectl scale deployment bq-front1 --replicas=2 -n web   metrics ç›¸å…³ # æŸ¥çœ‹node èµ„æº kubectl top nodes # æŸ¥çœ‹pods èµ„æº kubectl top pods -n php-dev # è·å–metricsæ¥å£æ‰€æœ‰æ•°æ® kubectl get --raw /metrics # patchå¼ºåˆ¶æ›´æ–°(æ…ç”¨) kubectl patch -f deployment.</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›kubectlå‘½ä»¤</p>
<!-- more -->
<p><a href="http://docs.kubernetes.org.cn/683.html">kubectlå‘½ä»¤è¡¨</a></p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h3>
<pre><code># è®©å†…ç½‘å¯ä»¥è®¿é—® k8s proxy(k8smasteræ˜¯:192.168.1.111
kubectl proxy --address='192.168.1.111' -p 10000 --accept-hosts='^172.*$'

# æŸ¥çœ‹apiç±»å‹
kubectl api-versions 

# è®©masterä¹Ÿè¿è¡Œpodï¼ˆé»˜è®¤masterä¸è¿è¡Œpod,å•æœºä¼šç”¨åˆ°ï¼‰
kubectl taint nodes --all node-role.kubernetes.io/master-

# patchè¡¥ä¸, å¼ºåˆ¶æ›´æ–°
kubectl patch -f deployment.yaml -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{\&quot;ci-last-updated\&quot;:\&quot;$(date +'%s')\&quot;}}}}}&quot;

# ç«¯å£è½¬å‘
kubectl -n default port-forward service/prometheus-server 30080:80

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="scale-ä½¿ç”¨">scale ä½¿ç”¨</h3>
<pre><code># é€šè¿‡å°†rcçš„å‰¯æœ¬æ•°é‡æ–°è®¾ç½®ä¸º0åï¼Œå†å°†å‰¯æœ¬æ•°è®¾ç½®ä¸º2ï¼Œè¾¾åˆ°é‡å¯nginxçš„æ•ˆæœã€‚
kubectl scale deployment bq-front1 --replicas=0 -n web
kubectl scale deployment bq-front1 --replicas=2 -n web
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="metrics-ç›¸å…³">metrics ç›¸å…³</h3>
<pre><code># æŸ¥çœ‹node èµ„æº
kubectl top nodes
# æŸ¥çœ‹pods èµ„æº
kubectl top pods -n php-dev
# è·å–metricsæ¥å£æ‰€æœ‰æ•°æ®
kubectl get --raw /metrics

# patchå¼ºåˆ¶æ›´æ–°(æ…ç”¨)
kubectl patch -f deployment.yaml -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{\&quot;ci-last-updated\&quot;:\&quot;$(date +'%s')\&quot;}}}}}&quot;

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="æ ¹æ®ç‰ˆæœ¬ç¼©æ”¾">æ ¹æ®ç‰ˆæœ¬ç¼©æ”¾</h3>
<pre><code>#æŸ¥çœ‹Deploymentçš„å˜æ›´ä¿¡æ¯ï¼ˆä»¥ä¸‹ä¿¡æ¯å¾—ä»¥ä¿å­˜ï¼Œæ˜¯åˆ›å»ºæ—¶å€™åŠ çš„â€œ--recordâ€è¿™ä¸ªé€‰é¡¹èµ·çš„ä½œç”¨ï¼‰ï¼š
kubectl rollout history deployment/bq-nginx-php7 -n web
kubectl rollout undo deployment/bq-nginx-php7        # å›é€€åˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/bq-nginx-php7 --to-revision=2  # å›é€€åˆ°æŒ‡å®šç‰ˆæœ¬

kubectl describe deployments/bq-nginx-php7 -n web       #æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ï¼Œè·å–å‡çº§è¿›åº¦
kubectl rollout pause deployment/bq-nginx-php7  -n web  #æš‚åœå‡çº§
kubectl rollout resume deployment/bq-nginx-php7  -n web #ç»§ç»­å‡çº§
kubectl rollout undo deployment/bq-nginx-php7  -n web   #å‡çº§å›æ»š
kubectl scale deployment bq-nginx-php7 --replicas 2  -n web   #å¼¹æ€§ä¼¸ç¼©Podæ•°é‡

kubectl get ns --show-labels  # æŸ¥çœ‹æ ‡ç­¾,é™¤äº†ns, ä¹Ÿå¯ä»¥æ˜¯node,podç­‰
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k3så®‰è£…é…ç½®</title>
			<link>https://www.ngirl.xyz/posts/29-k3s%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</link>
			<pubDate>Tue, 03 Dec 2019 16:06:28 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/29-k3s%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</guid>
			<description>ä½“éªŒè½»é‡çº§k8sé›†ç¾¤,é€‚ç”¨äºä½é…ä¸ªäººå¼€å‘æµ‹è¯•ä½¿ç”¨
 k3s, 5 less than k8s   è¯¦æƒ…å‚è€ƒå®˜æ–¹: k3s githubåœ°å€
å‡†å¤‡  1 selinux å…³é—­  getenforce # æœ¬æ¬¡å…³é—­ setenforce 0 # é‡å¯åå…³é—­ sed -i &#39;/SELINUX=enforcing/s/enforcing/disabled/&#39; /etc/sysconfig/selinux  2 å…³é—­swap(å¯é€‰)  # æœ¬æ¬¡å…³é—­ swapoff on # é‡å¯åå…³é—­ sed -i &#39;/swap/s@^/@#/@&#39; /etc/fstab  3 å…³é—­firewalld(å¿…é¡»)  systemctl stop firewalld.service systemctl disable firewalld.service  4 åœ¨å†…æ ¸3.10,4.16,5.2,5.3 éƒ½æ­£å¸¸è¿è¡Œ  Step 1: å®‰è£…K3Sé›†ç¾¤ # ä¸‹è½½k3s äºŒè¿›åˆ¶æ–‡ä»¶æ‰“å¼€å„ç‰ˆæœ¬ç‚¹å‡»è¯¦æƒ…å¯ä»¥æŸ¥è¯¢k3sç‰ˆæœ¬å¯¹åº”çš„k8sç‰ˆæœ¬(https://github.com/rancher/k3s/releases) wget https://github.com/rancher/k3s/releases/download/v1.0.0/k3s k3s v1.0.0 -&amp;gt; k8s1.16.3 # https://github.</description>
			<content type="html"><![CDATA[<p>ä½“éªŒè½»é‡çº§k8sé›†ç¾¤,é€‚ç”¨äºä½é…ä¸ªäººå¼€å‘æµ‹è¯•ä½¿ç”¨</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k3s, 5 less than k8s </font>
</center>
<p>è¯¦æƒ…å‚è€ƒå®˜æ–¹: <a href="https://github.com/rancher/k3s">k3s githubåœ°å€</a></p>
<h3 id="å‡†å¤‡">å‡†å¤‡</h3>
<ul>
<li>1 selinux å…³é—­</li>
</ul>
<pre><code>getenforce
# æœ¬æ¬¡å…³é—­
setenforce 0

# é‡å¯åå…³é—­
sed -i '/SELINUX=enforcing/s/enforcing/disabled/' /etc/sysconfig/selinux
</code></pre><ul>
<li>2 å…³é—­swap(å¯é€‰)</li>
</ul>
<pre><code># æœ¬æ¬¡å…³é—­
swapoff on
# é‡å¯åå…³é—­
sed -i '/swap/s@^/@#/@' /etc/fstab
</code></pre><ul>
<li>3 å…³é—­firewalld(å¿…é¡»)</li>
</ul>
<pre><code>systemctl stop firewalld.service
systemctl disable firewalld.service
</code></pre><ul>
<li>4 åœ¨å†…æ ¸3.10,4.16,5.2,5.3 éƒ½æ­£å¸¸è¿è¡Œ</li>
</ul>
<h3 id="step-1-å®‰è£…k3sé›†ç¾¤">Step 1: å®‰è£…K3Sé›†ç¾¤</h3>
<pre><code># ä¸‹è½½k3s äºŒè¿›åˆ¶æ–‡ä»¶æ‰“å¼€å„ç‰ˆæœ¬ç‚¹å‡»è¯¦æƒ…å¯ä»¥æŸ¥è¯¢k3sç‰ˆæœ¬å¯¹åº”çš„k8sç‰ˆæœ¬(https://github.com/rancher/k3s/releases)
wget https://github.com/rancher/k3s/releases/download/v1.0.0/k3s
k3s v1.0.0 -&gt; k8s1.16.3

# https://github.com/rancher/k3s/tags
k3s v0.9.0 -&gt; k8s1.15.4
k3s v0.10.0 -&gt; k8s1.16.2

æˆ‘è¿™é‡Œä¸‹è½½æœ€æ–°çš„k3s v1.0.0, ä½†æ˜¯ç”±äºmetrics-serverå¥½åƒå¯¹k8s1.16.3æœ€æ–°æœ‰ç‚¹é—®é¢˜, è¿˜æ˜¯å…ˆç­‰å¾…metrics-serveræ›´æ–°æŠŠ
æµ‹è¯•äº†k3s v0.10.0 æµ‹è¯•äº†ä¸‹, ä½†é—æ†¾çš„æ˜¯é»˜è®¤å¥½åƒæ²¡æœ‰å®‰è£…metrics-server...

mv k3s /usr/local/bin/k3s
chmod +x /usr/local/bin/k3s

#k3s --version
k3s version v1.0.0 (18bd921c)

# ä¸‹è½½pauseé•œåƒ(è¿™é‡Œä¸¾1,å…¶ä»–å›½å†…åœ°å€å‚è€ƒå®˜æ–¹)
docker pull registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1
docker tag registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 k8s.gcr.io/pause:3.1

# éªŒè¯ä¸€ä¸‹
docker images | grep &quot;k8s.gcr.io/pause&quot;
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="step-2-å®‰è£…k3s-server">Step 2: å®‰è£…k3s server</h3>
<pre><code># centoså®˜æ–¹å®‰è£…
curl -sfL https://get.k3s.io | sh -

# è‡³æ­¤serverå·²ç»å®‰è£…å®Œäº†,ä½†ç”±äºk8sé»˜è®¤æ˜¯ç”¨Containerd, å¹¶édocker, æ‰€ä»¥éœ€è¦æ‰‹å·¥ä¿®æ”¹é…ç½®(å½“ç„¶å¦‚æœä½ ç†Ÿæ‚‰ctr æ“ä½œContainerdä¹Ÿæ²¡é—®é¢˜)
# ä¿®æ”¹ExecStartå†…å®¹
# 1: --docker è¡¨ç¤ºk3s serverä½¿ç”¨dockerå¼•æ“
# 2: --no-deploy traefik è¡¨ç¤ºä¸å®‰è£…traefik
vim /etc/systemd/system/multi-user.target.wants/k3s.service
ExecStart=/usr/local/bin/k3s server --docker --no-deploy traefik

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
service k3s restart

# éªŒè¯
k3s kubectl get node
</code></pre><blockquote>
<p>æƒ³å»æ‰k3så‘½ä»¤? kubectlå‘½ä»¤ç®¡ç†k3s</p>
</blockquote>
<pre><code># ç®€å•åšä¸€ä¸ªalias
alias kubectl='k3s kubectl'

# æˆ–è€…
rm -rf ~/.kube
mkdir -p ~/.kube
cp /etc/rancher/k3s/k3s.yaml ~/.kube/config

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="step-3-å®¢æˆ·ç«¯å®‰è£…">Step 3: å®¢æˆ·ç«¯å®‰è£…</h3>
<p>å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://rancher.com/docs/k3s/latest/en/installation/install-options/">å®‰è£…å’Œé…ç½®é€‰é¡¹</a></p>
<pre><code># åŒæ ·ä¸‹è½½äºŒè¿›åˆ¶åŒ…
wget https://github.com/rancher/k3s/releases/download/v1.0.0/k3s
mv k3s /usr/local/bin/k3s
chmod +x /usr/local/bin/k3s
</code></pre><h3 id="åŠ å…¥åˆ°serveræœ‰ä¸¤ç§">åŠ å…¥åˆ°serveræœ‰ä¸¤ç§</h3>
<ul>
<li>æ‰‹åŠ¨åŠ å…¥ (å…¶å®ä¸Šé¢æˆ‘ä»¬å·²ç»æ‹‰å–äº†image, å¹¶ä¸”tagæˆå®˜æ–¹åœ°å€äº†,æ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥ä¸ç”¨æŒ‡å®š)</li>
</ul>
<pre><code>nohup k3s agent --docker   --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1 --server https://k3s-server:6443 --token ${NODE_TOKEN} &amp;
nohup k3s agent --docker --server https://k3s-server:6443 --token ${NODE_TOKEN} &amp;
</code></pre><ul>
<li>è„šæœ¬åŠ å…¥</li>
</ul>
<pre><code>curl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=${NODE_TOKEN} INSTALL_K3S_EXEC=&quot;agent --docker  --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1&quot; sh -s -
curl -sfL https://get.k3s.io | K3S_URL=https://k3s-server:6443 K3S_TOKEN=${NODE_TOKEN} INSTALL_K3S_EXEC=&quot;agent --docker&quot; sh -s -

# ps aux|grep k3s
/usr/local/bin/k3s agent --docker --pause-image registry.cn-beijing.aliyuncs.com/ilemonrain/pause-amd64:3.1
</code></pre><blockquote>
<p>å½“ç„¶å¦‚ä¸‹å·®åˆ«ä¸å¤§, éƒ½æ˜¯ä¼šå¯åŠ¨ä¸€ä¸ªk3sçš„è¿›ç¨‹</p>
</blockquote>
<h3 id="rancher-import">rancher import</h3>
<pre><code>curl --insecure -sfL https://rancher-dev.xxx.com/v3/import/x8jc277zmjkxjgcmc9f67pzn9f7ffsjpszlv9dxc79vhmndqcms4nr.yaml | k3s kubectl apply -f -
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å¸è½½">å¸è½½</h3>
<pre><code>sh /usr/local/bin/k3s-uninstall.sh
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k3s1.16éƒ¨ç½²nginx&#43;php5.2.17</title>
			<link>https://www.ngirl.xyz/posts/33-k3s1.16%E9%83%A8%E7%BD%B2nginx&#43;php5.2.17/</link>
			<pubDate>Tue, 03 Dec 2019 11:46:42 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/33-k3s1.16%E9%83%A8%E7%BD%B2nginx&#43;php5.2.17/</guid>
			<description>&lt;p&gt;è€é¡¹ç›®æ˜¯ç”¨php5.2.17çš„,è‡ªå·±ç¼–è¯‘æ‰“åŒ…é•œåƒç®€å•éƒ¨ç½²&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>è€é¡¹ç›®æ˜¯ç”¨php5.2.17çš„,è‡ªå·±ç¼–è¯‘æ‰“åŒ…é•œåƒç®€å•éƒ¨ç½²</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å¼€å§‹éƒ¨ç½² </font>
</center>
<h3 id="å‡†å¤‡dockerfile">å‡†å¤‡dockerfile</h3>
<ul>
<li>Dockerfile</li>
</ul>
<pre><code>FROM centos:6.9
MAINTAINER zhangzw zhangzw@zhangzw.com

ENV PHP_DIR /usr/local/php
ENV WORK_DIR_tar /usr/loca/src/
ENV PHP_VERSION 5.2.17
ENV PHP_EXT_CURL curl-7.20.0
# php åŠæ‰©å±• åŒ…,åŒ…æ‹¬ä»¥ä¸‹å†…å®¹
# php-5.2.17-patch-fpm.tar.gz curl-7.20.0.tar.gz  freetype-2.4.0.tar.gz  ImageMagick-6.9.0-4.tar.gz  imagick-3.0.1.tgz zendopcache-7.0.5.tgz  phpredis-2.2.2.zip                 
# php-fpm.conf php.ini              
copy tar ${WORK_DIR_tar}


run yum install -y wget \
 &amp;&amp; wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo \
 &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6 \
 &amp;&amp; yum install -y epel-release \
 &amp;&amp; yum install -y freetype freetype-devel gcc make cmake ncurses-devel gcc-c++ autoconf automake zlib-devel dos2unix nc lrzsz openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel libpng-devel bzip2-devel libjpeg libjpeg-turbo-devel libmcrypt-devel mhash-devel mysql-devel libtool-ltdl libtool-ltdl-devel git bzip2-devel git supervisor autoconf automake xz unzip \
    &amp;&amp; yum clean all
    &amp;&amp; cd ${WORK_DIR_tar} \
        &amp;&amp; ls *gz|xargs -i tar -xf {} \
 &amp;&amp; cd ${PHP_EXT_CURL} \
                &amp;&amp; ./configure --prefix=/usr/local/curl \
                &amp;&amp; make \
                &amp;&amp; make install \
    &amp;&amp; cd ${WORK_DIR_tar} \
 &amp;&amp; cd php-${PHP_VERSION} \
 &amp;&amp; ln -s /usr/lib64/libpng.so /usr/lib/ \
 &amp;&amp; ln -s /usr/lib64/libjpeg.so /usr/lib/ \
 &amp;&amp; ln -s /usr/lib64/mysql/libmysqlclient.so.16.0.0 /usr/lib/libmysqlclient.so \
        &amp;&amp; ./configure \
            --prefix=${PHP_DIR} \
            --with-config-file-path=${PHP_DIR}/etc \
            --with-mysql \
            --with-mysqli \
            --with-openssl \
            --enable-fastcgi \
            --enable-fpm \
            --enable-mbstring \
            --enable-bcmath \
            --with-freetype-dir \
            --with-jpeg-dir \
            --with-png-dir \
            --with-zlib-dir \
            --with-libxml-dir=/usr \
            --enable-xml \
            --with-mhash \
            --with-mcrypt \
            --enable-pcntl \
            --enable-sockets \
            --with-bz2 \
            --with-curl=https://www.ngirl.xyz/usr/local/curl \
            --with-curlwrappers \
            --enable-mbregex \
            --with-gd \
            --enable-gd-native-ttf \
            --enable-zip \
            --enable-soap \
            --with-iconv \
            --enable-pdo \
 &amp;&amp; make \
 &amp;&amp; make install \
    &amp;&amp; cd ${WORK_DIR_tar} \
        &amp;&amp; cd ImageMagick-6.9.0-4 \
                &amp;&amp; ./configure --prefix=/usr/local/imagemagick \
                &amp;&amp; make \
                &amp;&amp; make install \
        &amp;&amp; cd ${WORK_DIR_tar} \
        &amp;&amp; cd imagick-3.0.1 \
                &amp;&amp; ln -s /usr/local/imagemagick/include/ImageMagick-6 /usr/local/imagemagick/include/ImageMagick \
                &amp;&amp; ${PHP_DIR}/bin/phpize \
                &amp;&amp; ./configure --with-php-config=${PHP_DIR}/bin/php-config --with-imagick=/usr/local/imagemagick \
                &amp;&amp; make \
                &amp;&amp; make install \
    &amp;&amp; cd ${WORK_DIR_tar} \
        &amp;&amp; unzip phpredis-2.2.2.zip \
        &amp;&amp; cd phpredis-2.2.2 \
                &amp;&amp; ${PHP_DIR}/bin/phpize \
                &amp;&amp; ./configure --with-php-config=${PHP_DIR}/bin/php-config \
                &amp;&amp; make \
                &amp;&amp; make install \
    &amp;&amp; cd ${WORK_DIR_tar} \
        &amp;&amp; cd zendopcache-7.0.5 \
                &amp;&amp; ${PHP_DIR}/bin/phpize \
                &amp;&amp; ./configure --with-php-config=${PHP_DIR}/bin/php-config \
                &amp;&amp; make \
                &amp;&amp; make install \
    &amp;&amp; groupadd -r www \
    &amp;&amp; useradd -M -s /sbin/nologin -r -g www www \
    &amp;&amp; cd ${WORK_DIR_tar} \
   &amp;&amp; \cp -r ${WORK_DIR_tar}/php-fpm.conf ${PHP_DIR}/etc/ \
   &amp;&amp; \cp -r ${WORK_DIR_tar}/php.ini ${PHP_DIR}/etc/ \
   &amp;&amp; rm -rf ${WORK_DIR_tar}

copy supervisord-fpm.conf /etc/supervisord.conf
copy start.sh /root/start.sh

ENTRYPOINT [&quot;/bin/sh&quot;, &quot;/root/start.sh&quot;]

</code></pre><ul>
<li>build æ‰“åŒ…</li>
</ul>
<pre><code># é…ç½®è‡ªå·±çš„ç§æœ‰ä»“åº“åœ°å€
docker build -t xxx.com/centos-php:5.2.17  .
docker push xxx.com/centos-php:5.2.17
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<p>å¯å‚è€ƒk3så®‰è£…æ•™ç¨‹:</p>
<ul>
<li><a href="https://zhangzw001.github.io/2019/12/03/29-k3s%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">k3så®‰è£…é…ç½®</a></li>
<li><a href="https://github.com/rancher/k3s">å®˜æ–¹æ•™ç¨‹</a></li>
</ul>
<h3 id="åœ¨k3sä¸­å¯åŠ¨è¿™é‡Œæœ¬åœ°æŒ‚è½½æ–¹å¼å•èŠ‚ç‚¹">åœ¨k3sä¸­å¯åŠ¨(è¿™é‡Œæœ¬åœ°æŒ‚è½½æ–¹å¼,å•èŠ‚ç‚¹)</h3>
<ul>
<li>nginx.conf éƒ¨åˆ†é…ç½®</li>
</ul>
<pre><code>server {
        listen 80 default_server;
        server_name  _;
        access_log  /webwww/nginx_logs/test_access.log  main;
        error_log /webwww/nginx_logs/test_error.log debug;
        root   /webwww/test;

        location = /50x.html {
            root   html;
        }

        location / {
            index index.php  index.html index.htm;
        }

        location ~ \.php$ {
            fastcgi_pass   php-fpm-dev:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            fastcgi_param  HTTP_HOST          $server_name;
            include        fastcgi_params;
        }
}
</code></pre><ul>
<li>nginxéƒ¨ç½² nginx/php-nginx-dev.yml</li>
</ul>
<pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-nginx-dev
  namespace: php-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: php-nginx-dev
  template:
    metadata:
      labels:
        app: php-nginx-dev
    spec:
      containers:
      - name: php-nginx-dev
        image: hub.zhangzw.com/bq/nginx:1.15.12
        ports:
        - containerPort: 80
          name: nginx-80
          protocol: TCP
        resources:
          requests:
            cpu: &quot;10m&quot;
          limits:
            cpu: &quot;500m&quot;
        volumeMounts:
        - name: nginx-www-dev
          mountPath: /webwww
        - name: nginx-cfg-dev
          mountPath: &quot;/etc/nginx/nginx.conf&quot;
      volumes:
        - name: nginx-www-dev
          hostPath:
            path: /data/k8s-container/php-5.2.17/webwww-data
        - name: nginx-cfg-dev
          hostPath:
            path: /data/k8s-container/php-5.2.17/nginx/nginx.conf
---
kind: Service
apiVersion: v1
metadata:
 labels:
   app: php-nginx-dev
 name: php-nginx-dev-service
 namespace: php-dev
spec:
 type: NodePort
 ports:
   - name: nginx-80
     port: 80
     targetPort: 80
     nodePort: 32001
     protocol: TCP
 selector:
   app: php-nginx-dev
</code></pre><ul>
<li>fpm éƒ¨ç½²é…ç½® php-fpm/php-fpm-dev.yml</li>
</ul>
<pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-fpm-dev
  namespace: php-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: php-fpm-dev
  template:
    metadata:
      labels:
        app: php-fpm-dev
    spec:
      containers:
      - name: php-fpm-dev
        image: hub.zhangzw.com/bq/centos-php:5.2.17
        ports:
        - containerPort: 9000
          name: fpm-9000
          protocol: TCP
        resources:
          requests:
            cpu: &quot;50m&quot;
          limits:
            cpu: &quot;1500m&quot;
        volumeMounts:
        - name: nginx-www-dev
          mountPath: /webwww
        - name: php-cfg-dev
          mountPath: &quot;/usr/local/php/etc/php.ini&quot;
        - name: fpm-cfg-dev
          mountPath: &quot;/usr/local/php/etc/php-fpm.conf&quot;
      volumes:
        - name: nginx-www-dev
          hostPath:
            path: /data/k8s-container/php-5.2.17/webwww-data
        - name: php-cfg-dev
          hostPath:
            path: /data/k8s-container/php-5.2.17/php-fpm/php.ini
        - name: fpm-cfg-dev
          hostPath:
            path: /data/k8s-container/php-5.2.17/php-fpm/php-fpm.conf

---
apiVersion: v1
kind: Service
metadata:
  name: php-fpm-dev
  namespace: php-dev
spec:
  clusterIP: None
  selector:
    app: php-fpm-dev
  ports:
   - name: fpm-9000
     port: 9000

---
</code></pre><ul>
<li>éƒ¨ç½²å‘½ä»¤</li>
</ul>
<pre><code># å…ˆå¯åŠ¨fpm,å¦åˆ™nginxä¼šæŠ¥é”™æ‰¾ä¸åˆ° php-fpm-dev
kubectl apply -f php-fpm/php-fpm-dev.yml
kubectl apply -f nginx/php-nginx-dev.yml
</code></pre>]]></content>
		</item>
		
		<item>
			<title>phpé”™è¯¯502é—®é¢˜æ€»ç»“</title>
			<link>https://www.ngirl.xyz/posts/32-php%E9%94%99%E8%AF%AF502%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</link>
			<pubDate>Mon, 02 Dec 2019 17:45:01 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/32-php%E9%94%99%E8%AF%AF502%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</guid>
			<description>&lt;p&gt;è¿‘æœŸä¸€æ¬¡ 502æŠ¥é”™, ä½†æ˜¯æ²¡æœ‰è¾¾åˆ°timeoutçš„å€¼,ç‰¹æ­¤è®°å½•&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>è¿‘æœŸä¸€æ¬¡ 502æŠ¥é”™, ä½†æ˜¯æ²¡æœ‰è¾¾åˆ°timeoutçš„å€¼,ç‰¹æ­¤è®°å½•</p>
<h3 id="æŸ¥çœ‹errorlog-å†…å®¹-recv-failed-104-connection-reset-by-peer-while-reading-response-header-from-upstream">æŸ¥çœ‹error.log å†…å®¹: recv() failed (104: Connection reset by peer) while reading response header from upstream</h3>
<pre><code>ä¸€èˆ¬æ¥è¯´502 ä¸»è¦æ˜¯fpmè¶…æ—¶è¿›ç¨‹ä¸­æ­¢äº† æˆ–è€…å°±æ˜¯ å†…å­˜ä¸è¶³å¯¼è‡´ fpmä¸­æ­¢


è¿™é‡ŒæŸ¥çœ‹äº†fpmé…ç½® request_terminate_timeoutå€¼, å‘ç°å¹¶ä¸æ˜¯è¯¥åŸå› 

é€šè¿‡ top æŸ¥çœ‹äº†fpmå†…å­˜, å…¶ä¸­å•ä¸ªå†…å­˜å·²ç»è¾¾åˆ°äº†700M

è¿™é‡Œfpmé…ç½®çš„pm æ˜¯static, ç”±äºè¯¥æœåŠ¡å¹¶å‘ä¸æ˜¯å¾ˆé«˜, å¯ä»¥é€‚å½“å‡å°‘max_childrençš„å€¼, æˆ–è€…é‡‡ç”¨dynamic åŠ¨æ€æ–¹å¼

è¿™é‡Œè®¾ç½®çš„max_requests = 5500,  å¯ä»¥è€ƒè™‘å‡å°è¯¥å€¼
</code></pre><h3 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h3>
<pre><code>1 è¿™é‡Œå¯¹fpm reload å³å¯
2 æ”¹åŠ¨dynamic æ–¹å¼
3 åˆç†é…ç½®max_requests
</code></pre>]]></content>
		</item>
		
		<item>
			<title>systemdä¸€äº›å‘½ä»¤</title>
			<link>https://www.ngirl.xyz/posts/31-systemd%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4/</link>
			<pubDate>Tue, 26 Nov 2019 10:34:10 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/31-systemd%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4/</guid>
			<description>&lt;p&gt;è®°å½•ä¸€äº›éœ€è¦systemdå‘½ä»¤&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›éœ€è¦systemdå‘½ä»¤</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="systemdå‘½ä»¤">systemdå‘½ä»¤</h3>
<ul>
<li>
<p>æŸ¥çœ‹æœåŠ¡å¯åŠ¨é…ç½®: <code>systemctl cat k3s</code></p>
</li>
<li>
<p>æŸ¥çœ‹å¼€æœºå¯åŠ¨çš„æœåŠ¡åˆ—è¡¨ï¼š<code>systemctl list-unit-files|grep enabled</code></p>
</li>
<li>
<p>æŸ¥çœ‹å¯åŠ¨å¤±è´¥çš„æœåŠ¡åˆ—è¡¨ï¼š<code>systemctl --failed</code></p>
</li>
<li>
<p>é‡å¯æœåŠ¡ï¼š<code>systemctl restart firewalld.service</code></p>
</li>
<li>
<p>æ˜¾ç¤ºçŠ¶æ€ï¼š<code>systemctl status firewalld.service</code></p>
</li>
<li>
<p>å¼€æœºå¯ç”¨æœåŠ¡ï¼š<code>systemctl enable firewalld.service</code></p>
</li>
<li>
<p>å¼€æœºç¦ç”¨æœåŠ¡ï¼š<code>systemctl disable firewalld.service</code></p>
</li>
<li>
<p>æŸ¥çœ‹å¼€æœºå¯åŠ¨ï¼š<code>systemctl is-enabled firewalld.service</code></p>
</li>
</ul>]]></content>
		</item>
		
		<item>
			<title>k3sé›†ç¾¤éƒ¨ç½²é¡¹ç›®æŠ¥æŒ‚è½½nfsé”™è¯¯</title>
			<link>https://www.ngirl.xyz/posts/30-k3s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%8A%A5%E6%8C%82%E8%BD%BDnfs%E9%94%99%E8%AF%AF/</link>
			<pubDate>Mon, 25 Nov 2019 17:37:23 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/30-k3s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%8A%A5%E6%8C%82%E8%BD%BDnfs%E9%94%99%E8%AF%AF/</guid>
			<description>ä½“éªŒè½»é‡çº§k8sé›†ç¾¤é‡åˆ°ä¸€äº›nfsé—®é¢˜
  éƒ¨ç½²æœåŠ¡å™¨æŸ¥çœ‹describeä¿¡æ¯å¦‚ä¸‹: Mounting command: systemd-run Mounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605 --scope -- mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605 Output: Running scope as unit run-14829.scope. mount: æ–‡ä»¶ç³»ç»Ÿç±»å‹é”™è¯¯ã€é€‰é¡¹é”™è¯¯ã€192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 ä¸Šæœ‰åè¶…çº§å—ã€ ç¼ºå°‘ä»£ç é¡µæˆ–åŠ©æ‰‹ç¨‹åºï¼Œæˆ–å…¶ä»–é”™è¯¯ (å¯¹æŸäº›æ–‡ä»¶ç³»ç»Ÿ(å¦‚ nfsã€cifs) æ‚¨å¯èƒ½éœ€è¦ ä¸€æ¬¾ /sbin/mount.&amp;lt;ç±»å‹&amp;gt; åŠ©æ‰‹ç¨‹åº)   åˆ†æ  çŒœæµ‹1 å¯èƒ½æ˜¯nfsçš„ç³»ç»Ÿæ ¼å¼å’Œé›†ç¾¤nodeèŠ‚ç‚¹æ–‡ä»¶æ ¼å¼ä¸åŒ  # æŸ¥çœ‹å‘ç°nfsæ˜¯ext4, ç„¶åé›†ç¾¤ä¸­å…¶ä»–çš„ç£ç›˜éƒ½æ˜¯xfs df -T|egrep -v &amp;quot;contai|var|overl&amp;quot; æ‰€ä»¥æ–°æŒ‚äº†å—ç£ç›˜,æ ¼å¼åŒ–ä¸ºxfsç„¶åå†æ¬¡å®éªŒ,å‘ç°é”™è¯¯åŒæ ·...  çŒœæµ‹2 å¯èƒ½æ˜¯å®¢æˆ·ç«¯æ— æ³•è¯†åˆ«nfsæ ¼å¼  # åšä¸ªæµ‹è¯• mkdir /tmp/abc mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /tmp/abc # æœç„¶æŠ¥é”™ mount: wrong fs type, bad option, bad superblock on 192.</description>
			<content type="html"><![CDATA[<p>ä½“éªŒè½»é‡çº§k8sé›†ç¾¤é‡åˆ°ä¸€äº›nfsé—®é¢˜</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="éƒ¨ç½²æœåŠ¡å™¨æŸ¥çœ‹describeä¿¡æ¯å¦‚ä¸‹">éƒ¨ç½²æœåŠ¡å™¨æŸ¥çœ‹describeä¿¡æ¯å¦‚ä¸‹:</h3>
<pre><code>Mounting command: systemd-run
Mounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605 --scope -- mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /var/lib/kubelet/pods/369daaef-1e90-446b-92ce-3d562f94b429/volumes/kubernetes.io~nfs/pvc-f462c606-5796-4c48-8928-7822f3fa0605
Output: Running scope as unit run-14829.scope.
mount: æ–‡ä»¶ç³»ç»Ÿç±»å‹é”™è¯¯ã€é€‰é¡¹é”™è¯¯ã€192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 ä¸Šæœ‰åè¶…çº§å—ã€
       ç¼ºå°‘ä»£ç é¡µæˆ–åŠ©æ‰‹ç¨‹åºï¼Œæˆ–å…¶ä»–é”™è¯¯
       (å¯¹æŸäº›æ–‡ä»¶ç³»ç»Ÿ(å¦‚ nfsã€cifs) æ‚¨å¯èƒ½éœ€è¦
       ä¸€æ¬¾ /sbin/mount.&lt;ç±»å‹&gt; åŠ©æ‰‹ç¨‹åº)
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="åˆ†æ">åˆ†æ</h3>
<ul>
<li>çŒœæµ‹1 å¯èƒ½æ˜¯nfsçš„ç³»ç»Ÿæ ¼å¼å’Œé›†ç¾¤nodeèŠ‚ç‚¹æ–‡ä»¶æ ¼å¼ä¸åŒ</li>
</ul>
<pre><code># æŸ¥çœ‹å‘ç°nfsæ˜¯ext4, ç„¶åé›†ç¾¤ä¸­å…¶ä»–çš„ç£ç›˜éƒ½æ˜¯xfs
df -T|egrep -v &quot;contai|var|overl&quot;

æ‰€ä»¥æ–°æŒ‚äº†å—ç£ç›˜,æ ¼å¼åŒ–ä¸ºxfsç„¶åå†æ¬¡å®éªŒ,å‘ç°é”™è¯¯åŒæ ·...
</code></pre><ul>
<li>çŒœæµ‹2 å¯èƒ½æ˜¯å®¢æˆ·ç«¯æ— æ³•è¯†åˆ«nfsæ ¼å¼</li>
</ul>
<pre><code># åšä¸ªæµ‹è¯•
mkdir /tmp/abc
mount -t nfs 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-es520-2-dev-1-pvc-f462c606-5796-4c48-8928-7822f3fa0605 /tmp/abc


# æœç„¶æŠ¥é”™
mount: wrong fs type, bad option, bad superblock on 192.168.x.x:/data-nfs/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins,
       missing codepage or helper program, or other error
       (for several filesystems (e.g. nfs, cifs) you might
       need a /sbin/mount.&lt;type&gt; helper program)

       In some cases useful info is found in syslog - try
       dmesg | tail or so.
</code></pre><p>æ‰€ä»¥å®‰è£…äº†nfså³å¯</p>
<pre><code>yum install nfs
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8s1.16ä½¿ç”¨æ—§ymléƒ¨ç½²é…ç½®é—®é¢˜</title>
			<link>https://www.ngirl.xyz/posts/28-k8s1-16%E4%BD%BF%E7%94%A8%E6%97%A7yml%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</link>
			<pubDate>Mon, 25 Nov 2019 15:41:48 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/28-k8s1-16%E4%BD%BF%E7%94%A8%E6%97%A7yml%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</guid>
			<description>&lt;p&gt;ä½¿ç”¨k8s 1.16é‡åˆ°çš„é—®é¢˜&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ä½¿ç”¨k8s 1.16é‡åˆ°çš„é—®é¢˜</p>
<h3 id="1-appversionçš„æ”¹å˜">1 appversionçš„æ”¹å˜</h3>
<pre><code>no matches for kind &quot;StatefulSet&quot; in version &quot;apps/v1beta1&quot;
no matches for kind &quot;Deployment&quot; in version &quot;extensions/v1beta1&quot;
</code></pre><pre><code># Deployment(extensions/v1beta1 èˆå¼ƒ)
apiVersion: extensions/v1beta1 -&gt; apiVersion: apps/v1
# StatefulSet
apiVersion: apps/v1beta1       -&gt; apiVersion: apps/v1


# ç„¶åæ ¹æ®æç¤ºåœ¨spec ä¸‹æ·»åŠ selector.matchLabels
spec:
  replicas: 3
  selector:
    matchLabels:
      app: test1

å¯ä»¥é€šè¿‡kubectl convert æ›´æ–°yamlæ–‡ä»¶
</code></pre><ul>
<li>å®Œæ•´ç¤ºä¾‹:</li>
</ul>
<pre><code>&gt; nginx1.yml &lt;&lt;- EOF  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx1
  template:
    metadata:
      labels:
        app: nginx1
    spec:
      containers:
      - image: nginx
        name: nginx1
        imagePullPolicy: Always
        resources:
          requests:
            cpu: &quot;10m&quot;
            memory: &quot;10Mi&quot;
          limits:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
EOF

</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8sä¸€æ¡å‘½ä»¤éƒ¨ç½²es5.2.0é›†ç¾¤</title>
			<link>https://www.ngirl.xyz/posts/27-k8s%E4%B8%80%E6%9D%A1%E5%91%BD%E4%BB%A4%E9%83%A8%E7%BD%B2es5-2-0%E9%9B%86%E7%BE%A4/</link>
			<pubDate>Thu, 21 Nov 2019 18:13:35 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/27-k8s%E4%B8%80%E6%9D%A1%E5%91%BD%E4%BB%A4%E9%83%A8%E7%BD%B2es5-2-0%E9%9B%86%E7%BE%A4/</guid>
			<description>&lt;p&gt;ç”±äºè€é¡¹ç›®æ˜¯åŸºäºes5.2.0, æ‰€ä»¥å‡†å¤‡åœ¨k8såŸºäºnfså­˜å‚¨æ­å»ºä¸€å¥—,ä¸‹é¢ç®€å•ä»‹ç»&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ç”±äºè€é¡¹ç›®æ˜¯åŸºäºes5.2.0, æ‰€ä»¥å‡†å¤‡åœ¨k8såŸºäºnfså­˜å‚¨æ­å»ºä¸€å¥—,ä¸‹é¢ç®€å•ä»‹ç»</p>
<h3 id="å‡†å¤‡å¥½ç¯å¢ƒå’Œå®˜æ–¹é•œåƒ">å‡†å¤‡å¥½ç¯å¢ƒå’Œå®˜æ–¹é•œåƒ</h3>
<pre><code>1 é•œåƒ: elasticsearch:5.2.0
2 k8sç¯å¢ƒ: k8s.1.10
3 å­˜å‚¨: nfs storageclass å­˜å‚¨
4 æ’ä»¶: ikåˆ†è¯å‹ç¼©åŒ…(è¿™é‡Œikåˆ†è¯ç›´æ¥ä½¿ç”¨æ—§çš„esé…ç½®, ä¹Ÿå¯ä»¥è‡ªè¡Œä¸‹)
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å¼€å§‹éƒ¨ç½² </font>
</center>
<h3 id="éƒ¨ç½²å‘½ä»¤">éƒ¨ç½²å‘½ä»¤</h3>
<pre><code>kubectl apply -f k8s-StatefulSet-es520-nfs.yml
</code></pre><h3 id="é…ç½®æ–‡ä»¶-k8s-statefulset-es520-nfsyml">é…ç½®æ–‡ä»¶ k8s-StatefulSet-es520-nfs.yml</h3>
<pre><code>apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: es520-2-dev
  namespace: ns-elastic5
spec:
  serviceName: &quot;es520-2-dev&quot;
  replicas: 2
  volumeClaimTemplates:
  - metadata:
      name: es520-2-dev-nfs
      annotations:
        volume.beta.kubernetes.io/storage-class: &quot;nfs-retain&quot; # è¿™é‡Œé…ç½® ä¸Šé¢åˆ›å»ºçš„ storageclass çš„åç§°
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 2Gi
  template:
    metadata:
      labels:
        app: es520-2-dev
    spec:
      containers:
      - name: es520-2-dev
        image: elasticsearch:5.2.0
        ports:
        - containerPort: 9200
          name: es520-2-9200
          protocol: TCP
        - containerPort: 9300
          name: es520-2-9300
          protocol: TCP
        resources:
          requests:
            cpu: &quot;50m&quot;
          limits:
            cpu: &quot;500m&quot;
        volumeMounts:
        - name: es520-2-dev-nfs
          mountPath: /usr/share/elasticsearch/data/
        - name: es520-2-dev-cfg
          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml
          subPath: elasticsearch.yml
        - name: es520-2-dev-jvm
          mountPath: /usr/share/elasticsearch/config/jvm.options
          subPath: jvm.options
        - name: es520-2-dev-plu
          mountPath: /usr/share/elasticsearch/plugins
      volumes:
      - name: es520-2-dev-cfg
        configMap:
          name: es520-2-dev-cfg
          items:
          - key: elasticsearch.yml
            path: elasticsearch.yml
      - name: es520-2-dev-jvm
        configMap:
          name: es520-2-dev-jvm
          items:
          - key: jvm.options
            path: jvm.options
      - name: es520-2-dev-plu
        nfs:
            server: 192.168.53.106
            path: /data/nfs/k3s/ns-elastic5-es520-2-dev-nfs-plugins
---
kind: Service
apiVersion: v1
metadata:
 labels:
   app: es520-2-dev
 name: es520-2-dev
 namespace: ns-elastic5
spec:
 type: NodePort
 ports:
   - name: es520-2-9200
     port: 9200
     targetPort: 9200
     nodePort: 31201
     protocol: TCP
   - name: es520-2-9300
     port: 9300
     targetPort: 9300
     nodePort: 31301
     protocol: TCP
 selector:
   app: es520-2-dev

---
apiVersion: v1
kind: Service
metadata:
  name: es520-2-dev-hl
spec:
  clusterIP: None
  selector:
    app: es520-2-dev
  ports:
   - name: es520-2-9200
     port: 9200
   - name: es520-2-9300
     port: 9300
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: es520-2-dev-cfg
  namespace: ns-elastic5
data:
  elasticsearch.yml: |

   cluster.name: k8s-test-nfs
   network.host: 0.0.0.0
   bootstrap.system_call_filter: false
   discovery.zen.ping.unicast.hosts: [&quot;es520-2-dev-0.es520-2-dev:9300&quot;,&quot;es520-2-dev-1.es520-2-dev:9300&quot;,&quot;es520-2-dev-2.es520-2-dev:9300&quot;]
   http.cors.enabled: true
   http.cors.allow-origin: &quot;*&quot;
   thread_pool.bulk.queue_size: 3000

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: es520-2-dev-jvm
  namespace: ns-elastic5
data:
  jvm.options: |
   -Xms512m
   -Xmx512m
   -XX:+UseConcMarkSweepGC
   -XX:CMSInitiatingOccupancyFraction=75
   -XX:+UseCMSInitiatingOccupancyOnly
   -XX:+DisableExplicitGC
   -XX:+AlwaysPreTouch
   -server
   -Xss1m
   -Djava.awt.headless=true
   -Dfile.encoding=UTF-8
   -Djna.nosys=true
   -Djdk.io.permissionsUseCanonicalPath=true
   -Dio.netty.noUnsafe=true
   -Dio.netty.noKeySetOptimization=true
   -Dio.netty.recycler.maxCapacityPerThread=0
   -Dlog4j.shutdownHookEnabled=false
   -Dlog4j2.disable.jmx=true
   -Dlog4j.skipJansi=true
   -XX:+HeapDumpOnOutOfMemoryError
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> æ•ˆæœå›¾ </font>
</center>
<h3 id="rancher-ä¸Šæ•ˆæœ">rancher ä¸Šæ•ˆæœ</h3>
<img src="//zhangzw001.github.io/images/27/img1.png">
<h3 id="elasticsearch-head-ä¸Šæ•ˆæœå›¾">elasticsearch-head ä¸Šæ•ˆæœå›¾</h3>
<img src="//zhangzw001.github.io/images/27/img2.jpg">]]></content>
		</item>
		
		<item>
			<title>logstashé…ç½®</title>
			<link>https://www.ngirl.xyz/posts/26-logstash%E9%85%8D%E7%BD%AE/</link>
			<pubDate>Fri, 08 Nov 2019 17:28:26 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/26-logstash%E9%85%8D%E7%BD%AE/</guid>
			<description>è®°å½•ä¸€äº›logstashçš„é…ç½®é—®é¢˜
æƒ³è¦æ’é™¤æŸäº›ä¿¡æ¯ å®˜æ–¹æ–‡æ¡£
if &amp;quot;_grokparsefailure&amp;quot; not in [tags] { if [sqlDuring] &amp;lt; 5 { drop {} } } else { drop {} }  è¯·åŠ¡å¿…æ³¨æ„ å¦‚æœfailure å¯èƒ½ä¼šå¯¼è‡´æ‰¾ä¸åˆ° sqlDuringå˜é‡ è€ŒæŠ¥é”™
 [2019-12-05T17:53:03,017][FATAL][logstash.runner ] An unexpected error occurred! {:error=&amp;gt;#&amp;lt;NoMethodError: undefined method `&amp;lt;&#39; for nil:NilClass&amp;gt;, :backtrace=&amp;gt;[&amp;quot;(eval):139:in `initialize&#39;&amp;quot;, &amp;quot;org/jruby/RubyArray.java:1613:in `each&#39;&amp;quot;, &amp;quot;(eval):137:in `initialize&#39;&amp;quot;, &amp;quot;org/jruby/RubyProc.java:281:in `call&#39;&amp;quot;, &amp;quot;(eval):96:in `filter_func&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:260:in `filter_batch&#39;&amp;quot;, &amp;quot;org/jruby/RubyProc.java:281:in `call&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:186:in `each&#39;&amp;quot;, &amp;quot;org/jruby/RubyHash.java:1342:in `each&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:185:in `each&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:258:in `filter_batch&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:246:in `worker_loop&#39;&amp;quot;, &amp;quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:225:in `start_workers&#39;&amp;quot;]} </description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›logstashçš„é…ç½®é—®é¢˜</p>
<!-- more -->
<h3 id="æƒ³è¦æ’é™¤æŸäº›ä¿¡æ¯">æƒ³è¦æ’é™¤æŸäº›ä¿¡æ¯</h3>
<p><a href="https://www.elastic.co/guide/en/logstash/5.4/event-dependent-configuration.html#conditionals">å®˜æ–¹æ–‡æ¡£</a></p>
<pre><code>if &quot;_grokparsefailure&quot; not in [tags] {
        if [sqlDuring] &lt; 5 {
                 drop {}
         }
}
else {
        drop {}
}
</code></pre><blockquote>
<p>è¯·åŠ¡å¿…æ³¨æ„ å¦‚æœfailure å¯èƒ½ä¼šå¯¼è‡´æ‰¾ä¸åˆ° sqlDuringå˜é‡ è€ŒæŠ¥é”™</p>
</blockquote>
<pre><code>[2019-12-05T17:53:03,017][FATAL][logstash.runner          ] An unexpected error occurred! {:error=&gt;#&lt;NoMethodError: undefined method `&lt;' for nil:NilClass&gt;, :backtrace=&gt;[&quot;(eval):139:in `initialize'&quot;, &quot;org/jruby/RubyArray.java:1613:in `each'&quot;, &quot;(eval):137:in `initialize'&quot;, &quot;org/jruby/RubyProc.java:281:in `call'&quot;, &quot;(eval):96:in `filter_func'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:260:in `filter_batch'&quot;, &quot;org/jruby/RubyProc.java:281:in `call'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:186:in `each'&quot;, &quot;org/jruby/RubyHash.java:1342:in `each'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/util/wrapped_synchronous_queue.rb:185:in `each'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:258:in `filter_batch'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:246:in `worker_loop'&quot;, &quot;/usr/local/logstash-5.0.2/logstash-core/lib/logstash/pipeline.rb:225:in `start_workers'&quot;]}
</code></pre>]]></content>
		</item>
		
		<item>
			<title>Linuxä¸€äº›è„šæœ¬æ±‡æ€»</title>
			<link>https://www.ngirl.xyz/posts/25-linux%E4%B8%80%E4%BA%9B%E8%84%9A%E6%9C%AC%E6%B1%87%E6%80%BB/</link>
			<pubDate>Fri, 01 Nov 2019 17:50:26 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/25-linux%E4%B8%80%E4%BA%9B%E8%84%9A%E6%9C%AC%E6%B1%87%E6%80%BB/</guid>
			<description>è®°å½•ä¸€äº›shellè„šæœ¬
1 æ¸…ç†eså‡ å¤©å‰çš„ç´¢å¼•è„šæœ¬ 2 ä»mysqlå¯¼å‡ºè¡¨åˆ°clickhouseè„šæœ¬
 ###å‘½ä»¤æ±‡æ€»
ç”Ÿæˆå­—ç¬¦ä¸² tr -dc A-Za-z0-9_@$\%\^\/\+ &amp;lt; /dev/urandom|head -c 16|xargs grepéœ€è¦è½¬ä¹‰çš„å­—ç¬¦ grep &#39;&amp;quot;ç¬¬ä¸€ä¸ªè½¬ä¹‰\$ç¬¬äºŒä¸ªè½¬ä¹‰\[{&#39; a.txt æˆ–è€…ç›´æ¥ä½¿ç”¨-F grep -F &#39;&amp;quot;$[{&#39; a.txt sedå‘½ä»¤ # æ›¿æ¢24ä½å­—ç¬¦ /abcd...123 ä¸º /5fcb9ab67195b854c35afd12 sed &#39;s/\/[a-z0-9]\{24\}/\/5fcb9ab67195b854c35afd12/g&#39; shellå‚æ•° while [ -n &amp;quot;$1&amp;quot; ] do case &amp;quot;$1&amp;quot; in -a) a=$2;shift 2;; -s) s=$2;shift 2;; *) ;; case done #%å¤„ç†å˜é‡ tmpDir=/dir1/dir2/dir3/my.file.txt ${tmpDir#*/}	-&amp;gt; dir1/dir2/dir3/my.file.txt	(å·¦)åˆ é™¤ä»å·¦å¾€å³ç¬¬ä¸€ä¸ª /ä»¥åŠå·¦è¾¹çš„æ‰€æœ‰å†…å®¹ ${tmpDir##*/}	-&amp;gt; my.file.txt	(å·¦)åˆ é™¤ä»å·¦å¾€å³æœ€åä¸€ä¸ª/ä»¥åŠå·¦è¾¹çš„æ‰€æœ‰å†…å®¹ ${tmpDir%/*}	-&amp;gt; /dir1/dir2/dir3/	(å³)åˆ é™¤ä»å³å¾€å·¦ç¬¬ä¸€ä¸ª /ä»¥åŠå³è¾¹çš„æ‰€æœ‰å†…å®¹ ${tmpDir%%/*}	-&amp;gt; ç©º	(å³)åˆ é™¤ä»å³å¾€å·¦æœ€åä¸€ä¸ª/ä»¥åŠå³è¾¹çš„æ‰€æœ‰å†…å®¹ dd+grep  æ¥è‡ª:â€œï¿½ï¿½ï¿½â€å¼•å‘çš„çº¿ä¸Šäº‹æ•…</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›shellè„šæœ¬</p>
<!-- more -->
<p>1 <a href="//zhangzw001.github.io/sh/clean_es_data.sh.sh">æ¸…ç†eså‡ å¤©å‰çš„ç´¢å¼•è„šæœ¬</a>
2 <a href="//zhangzw001.github.io/sh/clickhouse_from_mysql.sh">ä»mysqlå¯¼å‡ºè¡¨åˆ°clickhouseè„šæœ¬</a></p>
<hr>
<p>###å‘½ä»¤æ±‡æ€»</p>
<h4 id="ç”Ÿæˆå­—ç¬¦ä¸²">ç”Ÿæˆå­—ç¬¦ä¸²</h4>
<pre><code>tr -dc A-Za-z0-9_@$\%\^\/\+ &lt; /dev/urandom|head -c 16|xargs

</code></pre><h4 id="grepéœ€è¦è½¬ä¹‰çš„å­—ç¬¦">grepéœ€è¦è½¬ä¹‰çš„å­—ç¬¦</h4>
<pre><code>grep '&quot;ç¬¬ä¸€ä¸ªè½¬ä¹‰\$ç¬¬äºŒä¸ªè½¬ä¹‰\[{'  a.txt
æˆ–è€…ç›´æ¥ä½¿ç”¨-F
grep -F '&quot;$[{' a.txt
</code></pre><h4 id="sedå‘½ä»¤">sedå‘½ä»¤</h4>
<pre><code># æ›¿æ¢24ä½å­—ç¬¦ /abcd...123 ä¸º /5fcb9ab67195b854c35afd12 
sed  's/\/[a-z0-9]\{24\}/\/5fcb9ab67195b854c35afd12/g'
</code></pre><h4 id="shellå‚æ•°">shellå‚æ•°</h4>
<pre><code>while [ -n &quot;$1&quot; ]
do
 case &quot;$1&quot; in 
  -a) a=$2;shift 2;;
  -s) s=$2;shift 2;;
  *) ;;
 case
done
</code></pre><h3 id="å¤„ç†å˜é‡">#%å¤„ç†å˜é‡</h3>
<pre><code>tmpDir=/dir1/dir2/dir3/my.file.txt
${tmpDir#*/}	-&gt; dir1/dir2/dir3/my.file.txt	(å·¦)åˆ é™¤ä»å·¦å¾€å³ç¬¬ä¸€ä¸ª  /ä»¥åŠå·¦è¾¹çš„æ‰€æœ‰å†…å®¹
${tmpDir##*/}	-&gt; my.file.txt			(å·¦)åˆ é™¤ä»å·¦å¾€å³æœ€åä¸€ä¸ª/ä»¥åŠå·¦è¾¹çš„æ‰€æœ‰å†…å®¹
${tmpDir%/*}	-&gt; /dir1/dir2/dir3/		(å³)åˆ é™¤ä»å³å¾€å·¦ç¬¬ä¸€ä¸ª  /ä»¥åŠå³è¾¹çš„æ‰€æœ‰å†…å®¹
${tmpDir%%/*}	-&gt; ç©º				(å³)åˆ é™¤ä»å³å¾€å·¦æœ€åä¸€ä¸ª/ä»¥åŠå³è¾¹çš„æ‰€æœ‰å†…å®¹
</code></pre><h3 id="ddgrep">dd+grep</h3>
<blockquote>
<p>æ¥è‡ª:<a href="https://qcrao.com/2020/04/27/codec-accident/">â€œï¿½ï¿½ï¿½â€å¼•å‘çš„çº¿ä¸Šäº‹æ•…</a></p>
</blockquote>
<p>ç”±äºä¸€äº›å¤§æ–‡ä»¶grepå¾ˆæ…¢,é€šè¿‡dd+grepæŸ¥æ‰¾, è¿™é‡Œç®€å•ä¸¾ä¾‹è¯´æ˜</p>
<pre><code>#a.txt
123
456
789
abc
kkk
</code></pre><p>æœ‰è¿™ä¹ˆä¸€ä¸ªæ–‡ä»¶a.txt,éœ€è¦æ‰¾åˆ°abc</p>
<pre><code># bsä»£è¡¨æ¯æ¬¡è¾“å…¥è¾“å‡ºå—çš„å¤§å°
# skipä»£è¡¨è·³è¿‡çš„bytes = bs * skip 
# countä»£è¡¨copyå¤šä¸ªå—,æœ€åè¾“å‡ºæ€»bytes = bs * count

$ dd if=a.txt bs=2 skip=0 count=5
123
456
785+0 records in
5+0 records out
10 bytes (10 B) copied, 4.4648e-05 s, 224 kB/s
</code></pre><pre><code># å¦‚ä¸‹ä¼šè·³è¿‡10å­—èŠ‚,ç„¶åè¾“å‡º10å­—èŠ‚å†…å®¹
$ dd if=a.txt bs=2 skip=5 count=5
9
abc
kkk
5+0 records in
5+0 records out
10 bytes (10 B) copied, 6.1424e-05 s, 163 kB/s
</code></pre>]]></content>
		</item>
		
		<item>
			<title>filebeat7æ”¶é›†mysqlæ…¢æ—¥å¿—åˆ°es</title>
			<link>https://www.ngirl.xyz/posts/24-filebeat7%E6%94%B6%E9%9B%86mysql%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%B0es/</link>
			<pubDate>Wed, 30 Oct 2019 16:56:37 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/24-filebeat7%E6%94%B6%E9%9B%86mysql%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%B0es/</guid>
			<description>&lt;p&gt;æ…¢æ—¥å¿—æä¾›ç»™å¼€å‘æŸ¥çœ‹, é‡‡ç”¨elkç»Ÿä¸€æä¾›,è¿™é‡Œé‡‡ç”¨k8sç¯å¢ƒæ­å»º&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>æ…¢æ—¥å¿—æä¾›ç»™å¼€å‘æŸ¥çœ‹, é‡‡ç”¨elkç»Ÿä¸€æä¾›,è¿™é‡Œé‡‡ç”¨k8sç¯å¢ƒæ­å»º</p>
<p>åŸæ–‡: <a href="https://www.cnblogs.com/smail-bao/p/9528072.html">ELKæ”¶é›†mysql_slow.log</a>
å…¶ä»–: <a href="https://blog.csdn.net/u012491646/article/details/90750571">filebeat ï¼ˆ7.1.0ï¼‰dockerå®¹å™¨</a></p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="slowlogå†…å®¹åˆ†æ">slowlogå†…å®¹åˆ†æ</h3>
<ul>
<li>5.5 ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</li>
</ul>
<pre><code># Time: 191030 17:03:13
# User@Host: myuser[myuser] @  [10.10.0.1]
# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182
SET timestamp=1572426193;
select * from a where name = 1 limit 1;
</code></pre><ul>
<li>5.6 ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</li>
</ul>
<pre><code># Time: 191030 17:03:13
# User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111
# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182
use db_name;
SET timestamp=1572426193;
select * from a where name = 1 limit 1;
</code></pre><ul>
<li>5.7 ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</li>
</ul>
<pre><code># Time: 2019-10-06T13:25:38.703546+08:00
# User@Host: myuser[myuser] @  [10.10.0.1] Id: 1111
# Query_time: 3.329673  Lock_time: 0.000107 Rows_sent: 0  Rows_examined: 3971182
SET timestamp=1572426193;
select * from a where name = 1 limit 1;
</code></pre><ul>
<li>é™¤ä»¥ä¸Šæ ¼å¼ä»¥å¤–,è¿˜éœ€è¦æ³¨æ„æ…¢æŸ¥è¯¢ä»£ç å—,å¯èƒ½å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½æœ‰ # Time</li>
</ul>
<blockquote>
<p>ä¸€æ¡å®Œæ•´çš„æ—¥å¿—ï¼šæœ€ç»ˆå°†ä»¥# User@Host: å¼€å§‹çš„è¡Œï¼Œå’Œä»¥SQLè¯­å¥ç»“å°¾çš„è¡Œåˆå¹¶ä¸ºä¸€æ¡å®Œæ•´çš„æ…¢æ—¥å¿—è¯­å¥</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å¼€å§‹éƒ¨ç½²filebeat7 </font>
</center>
<h3 id="å‡†å¤‡é•œåƒ">å‡†å¤‡é•œåƒ</h3>
<pre><code>docker pull store/elastic/filebeat:7.2.0
</code></pre><h3 id="filebeaté…ç½®æ–‡ä»¶">filebeaté…ç½®æ–‡ä»¶</h3>
<pre><code>filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /opt/slow.log

  exclude_lines: ['^\# Time']

  multiline.pattern: '^\# Time|^\# User'
  multiline.negate: true
  multiline.match: after

  tail_files: true

output.elasticsearch:
  enabled: true
  hosts: [&quot;10.0.0.100:9200&quot;]
  protocol: &quot;http&quot;
  indices:
    - index: &quot;es-index-name&quot;
</code></pre><h3 id="k8séƒ¨ç½²æ–‡ä»¶">k8séƒ¨ç½²æ–‡ä»¶</h3>
<pre><code>k8s-filebeat-7.2.0.yml
kind: Deployment
apiVersion: apps/v1beta2
metadata:
  labels:
    elastic-app: filebeat
  name: filebeat
  namespace: ns-elastic7
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      elastic-app: filebeat
  template:
    metadata:
      labels:
        elastic-app: filebeat
    spec:
      containers:
        - name: filebeat
          image: store/elastic/filebeat:7.2.0
          volumeMounts:
            - name: filebeat-config
              mountPath: /usr/share/filebeat/filebeat.yml
            - name: mysql-dev-252
              mountPath: /opt/php-mysql-dev-0-slow.log
      volumes:
        - name: filebeat-config
          hostPath:
            path: /data/k8s-container/elk-7.2.0/filebeat-7.2.0/filebeat.yml
        - name: mysql-dev-252
          hostPath:
            path: /data/k8s-container/mysql5.5/slow.log
</code></pre><h3 id="logstashåˆ†æmysqlæ—¥å¿—">logstashåˆ†æmysqlæ—¥å¿—</h3>
<blockquote>
<p>çœç•¥inputçš„kafka å’Œouputçš„es</p>
</blockquote>
<pre><code>    if [type] == &quot;showlog1&quot; or [type] == &quot;showlog2&quot; {
        json {
                source =&gt; &quot;message&quot;
        }

        mutate {
                gsub =&gt; [ &quot;message&quot;, &quot;\n&quot;, &quot;&quot; ]
        }
        grok {
                match =&gt; [&quot;message&quot;,&quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @  \[%{IP:clientip}\]  Id: %{NUMBER:Id:int}# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}(?&lt;dbnameall&gt;.*)SET\s+timestamp=%{NUMBER:timestamp_mysql:int};(?&lt;query&gt;.*)&quot;]
        }
        date {
                match =&gt; [&quot;timestamp_mysql&quot;, &quot;UNIX&quot;]
                target =&gt; &quot;@timestamp&quot;
        }
    }
</code></pre>]]></content>
		</item>
		
		<item>
			<title>mysql5.5ä¸»ä¸mysql5.7ä»éƒ¨ç½²é…ç½®</title>
			<link>https://www.ngirl.xyz/posts/23-mysql5-5%E4%B8%BB%E4%B8%8Emysql5-7%E4%BB%8E%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE/</link>
			<pubDate>Tue, 29 Oct 2019 14:56:55 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/23-mysql5-5%E4%B8%BB%E4%B8%8Emysql5-7%E4%BB%8E%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE/</guid>
			<description>ç”±äºéœ€è¦å°†æ—§ç‰ˆmysql5.5çš„æ•°æ®åŒæ­¥åˆ°æ–°mysql5.7, å¹¶ä¸”ä¼šå¯¹éƒ¨åˆ†è¡¨åˆ†åº“
å‚è€ƒæ•™ç¨‹: mysqlä»5.5ç›´æ¥å‡çº§åˆ°5.7
 mysql5.5å‡çº§åˆ°mysql5.7   é‡‡ç”¨mysql5.5æ•°æ®ç›®å½•å‡çº§ä¸ºmysql5.7 1 ä»mysql5.5çš„ä»åº“ copy /dataæ•°æ® 2 ä¿®æ”¹æ–°çš„mysql5.7é…ç½®æ–‡ä»¶ my.cnfï¼Œæ·»åŠ datadirï¼ŒæŒ‡å‘5.5æ•°æ®ç›®å½• 3 æ–°å®‰è£…æ•°æ®åº“æ‰§è¡Œ(æœ¬æ¬¡ä¸éœ€è¦æ‰§è¡Œ) /usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/disk/u01 4 å¯åŠ¨mysql 5 æ­¤æ—¶æ•°æ®ç›®å½•è¿˜æ˜¯5.5çš„ï¼Œéœ€è¦æ‰§è¡Œmysql_upgradeè¿›è¡Œå‡çº§ï¼Œåœ¨æ‰§è¡Œè¡¨ä¿®å¤å‰ï¼Œéœ€è¦ç¡®è®¤ä¸€ä¸ªå‚æ•°innodb_file_per_tableï¼Œmysqlå®˜ç½‘å¯¹è¯¥å‚æ•°çš„è§£é‡Šå¦‚ä¸‹ è¯¥å‚æ•°åœ¨5.5ç‰ˆæœ¬é»˜è®¤ä¸ºOFFï¼Œæ‰€æœ‰è¡¨å’Œç´¢å¼•éƒ½å¯¼å…¥ä¸€ä¸ªå…±äº«æ–‡ä»¶ä¸­ï¼Œåä¸ºibdata1,ä½†åœ¨5.6.7åŠä»¥åç‰ˆæœ¬ï¼Œæ”¹å‚æ•°è¢«é»˜è®¤è®¾ç½®ä¸ºONï¼Œå³æ¯å¼ è¡¨éƒ½æœ‰å¯¹åº”çš„è¡¨å’Œç´¢å¼•å­˜å‚¨æ–‡ä»¶ï¼Œæ¯ä¸ªschemaä¸‹ï¼Œæ¯ä¸ªfrmæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ibdæ–‡ä»¶ã€‚ åœ¨æ‰§è¡Œmysql_upgradeæ—¶ï¼Œä¼šä¿®å¤ç³»ç»Ÿè¡¨ï¼Œå¹¶ä¸”å¦‚æœè¯¥å‚æ•°åœ¨5.5å’Œ5.7ç‰ˆæœ¬å‡ä½¿ç”¨é»˜è®¤å€¼ï¼Œåˆ™ä¼šå°†ä¹‹å‰å…±äº«è¡¨å’Œç´¢å¼•çš„å­˜å‚¨æ–¹å¼æ”¹ä¸ºæ¯å¼ è¡¨å•ç‹¬å­˜å‚¨è¡¨å’Œç´¢å¼•çš„å½¢å¼ï¼Œæ•…ä¼šå‡ºç°æ‹·è´å¤åˆ¶çš„æ“ä½œï¼Œå¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œåˆ™ç”¨æ—¶å°±ä¼šå¾ˆé•¿ï¼Œ ä½¿ç”¨nnodb_file_per_table=1ï¼ŒåŠè¡¨å’Œç´¢å¼•å•ç‹¬å­˜å‚¨çš„ä¼˜ç¼ºç‚¹ï¼Œå¯æŸ¥çœ‹mysqlå®˜ç½‘ä»‹ç»ã€‚ 6 ä½¿ç”¨mysql_upgradeæ£€æµ‹å¹¶ä¿®å¤è¡¨ /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock  ä»¥ä¸Šå·²ç»å®Œæˆå¯¹mysql5.5æ•°æ®å‡çº§ åœ¨mysql5.7è¿è¡Œçš„åŠŸèƒ½
  é…ç½®mysql5.5ä¸»ä¸mysql5.7ä»   å°†msyql5.7ä½œä¸ºmysql5.5çš„ä»åº“  # ä»åº“æ‰§è¡Œ, POSä½ç½®ä»¥ show master status\G æŸ¥è¯¢ä¸ºå‡† stop slave; SET GLOBAL read_only=0; reset slave all; CHANGE MASTER TO MASTER_HOST=&#39;db_master.prod.zhangzw.com&#39;,MASTER_PORT=3306,MASTER_USER=&#39;xxx&#39;,MASTER_PASSWORD=&#39;xxx&#39;,MASTER_LOG_FILE=&#39;m1-master-bin.000001&#39;,MASTER_LOG_POS=107; start slave; åœ¨ä¸»åº“æµ‹è¯•åˆ›å»ºè¡¨, æŸ¥çœ‹æ˜¯å¦ä¼šåŒæ­¥åˆ°mysql5.7ä»åº“ create table tutorials_tbl( tutorial_id INT NOT NULL AUTO_INCREMENT, tutorial_title VARCHAR(100) NOT NULL, tutorial_author VARCHAR(40) NOT NULL, submission_date DATE, PRIMARY KEY ( tutorial_id ) );  ä¿®æ”¹mysql5.</description>
			<content type="html"><![CDATA[<p>ç”±äºéœ€è¦å°†æ—§ç‰ˆmysql5.5çš„æ•°æ®åŒæ­¥åˆ°æ–°mysql5.7, å¹¶ä¸”ä¼šå¯¹éƒ¨åˆ†è¡¨åˆ†åº“</p>
<!-- more -->
<p>å‚è€ƒæ•™ç¨‹: <a href="https://www.cnblogs.com/qq931399960/p/10243758.html">mysqlä»5.5ç›´æ¥å‡çº§åˆ°5.7</a></p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> mysql5.5å‡çº§åˆ°mysql5.7 </font>
</center>
<h3 id="é‡‡ç”¨mysql55æ•°æ®ç›®å½•å‡çº§ä¸ºmysql57">é‡‡ç”¨mysql5.5æ•°æ®ç›®å½•å‡çº§ä¸ºmysql5.7</h3>
<pre><code>1 ä»mysql5.5çš„ä»åº“ copy /dataæ•°æ®
2 ä¿®æ”¹æ–°çš„mysql5.7é…ç½®æ–‡ä»¶ my.cnfï¼Œæ·»åŠ datadirï¼ŒæŒ‡å‘5.5æ•°æ®ç›®å½•
3 æ–°å®‰è£…æ•°æ®åº“æ‰§è¡Œ(æœ¬æ¬¡ä¸éœ€è¦æ‰§è¡Œ)
  /usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/disk/u01
4 å¯åŠ¨mysql
5 æ­¤æ—¶æ•°æ®ç›®å½•è¿˜æ˜¯5.5çš„ï¼Œéœ€è¦æ‰§è¡Œmysql_upgradeè¿›è¡Œå‡çº§ï¼Œåœ¨æ‰§è¡Œè¡¨ä¿®å¤å‰ï¼Œéœ€è¦ç¡®è®¤ä¸€ä¸ªå‚æ•°innodb_file_per_tableï¼Œmysqlå®˜ç½‘å¯¹è¯¥å‚æ•°çš„è§£é‡Šå¦‚ä¸‹
 è¯¥å‚æ•°åœ¨5.5ç‰ˆæœ¬é»˜è®¤ä¸ºOFFï¼Œæ‰€æœ‰è¡¨å’Œç´¢å¼•éƒ½å¯¼å…¥ä¸€ä¸ªå…±äº«æ–‡ä»¶ä¸­ï¼Œåä¸ºibdata1,ä½†åœ¨5.6.7åŠä»¥åç‰ˆæœ¬ï¼Œæ”¹å‚æ•°è¢«é»˜è®¤è®¾ç½®ä¸ºONï¼Œå³æ¯å¼ è¡¨éƒ½æœ‰å¯¹åº”çš„è¡¨å’Œç´¢å¼•å­˜å‚¨æ–‡ä»¶ï¼Œæ¯ä¸ªschemaä¸‹ï¼Œæ¯ä¸ªfrmæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ibdæ–‡ä»¶ã€‚
 åœ¨æ‰§è¡Œmysql_upgradeæ—¶ï¼Œä¼šä¿®å¤ç³»ç»Ÿè¡¨ï¼Œå¹¶ä¸”å¦‚æœè¯¥å‚æ•°åœ¨5.5å’Œ5.7ç‰ˆæœ¬å‡ä½¿ç”¨é»˜è®¤å€¼ï¼Œåˆ™ä¼šå°†ä¹‹å‰å…±äº«è¡¨å’Œç´¢å¼•çš„å­˜å‚¨æ–¹å¼æ”¹ä¸ºæ¯å¼ è¡¨å•ç‹¬å­˜å‚¨è¡¨å’Œç´¢å¼•çš„å½¢å¼ï¼Œæ•…ä¼šå‡ºç°æ‹·è´å¤åˆ¶çš„æ“ä½œï¼Œå¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œåˆ™ç”¨æ—¶å°±ä¼šå¾ˆé•¿ï¼Œ
 ä½¿ç”¨nnodb_file_per_table=1ï¼ŒåŠè¡¨å’Œç´¢å¼•å•ç‹¬å­˜å‚¨çš„ä¼˜ç¼ºç‚¹ï¼Œå¯æŸ¥çœ‹mysqlå®˜ç½‘ä»‹ç»ã€‚
6 ä½¿ç”¨mysql_upgradeæ£€æµ‹å¹¶ä¿®å¤è¡¨
 /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock
</code></pre><blockquote>
<p>ä»¥ä¸Šå·²ç»å®Œæˆå¯¹mysql5.5æ•°æ®å‡çº§ åœ¨mysql5.7è¿è¡Œçš„åŠŸèƒ½</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> é…ç½®mysql5.5ä¸»ä¸mysql5.7ä» </font>
</center>
<h3 id="å°†msyql57ä½œä¸ºmysql55çš„ä»åº“">å°†msyql5.7ä½œä¸ºmysql5.5çš„ä»åº“</h3>
<pre><code> # ä»åº“æ‰§è¡Œ, POSä½ç½®ä»¥ show master status\G æŸ¥è¯¢ä¸ºå‡†
 stop slave;
 SET GLOBAL read_only=0;
 reset slave all;
 CHANGE MASTER TO MASTER_HOST='db_master.prod.zhangzw.com',MASTER_PORT=3306,MASTER_USER='xxx',MASTER_PASSWORD='xxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=107;
 start slave;
</code></pre><h3 id="åœ¨ä¸»åº“æµ‹è¯•åˆ›å»ºè¡¨-æŸ¥çœ‹æ˜¯å¦ä¼šåŒæ­¥åˆ°mysql57ä»åº“">åœ¨ä¸»åº“æµ‹è¯•åˆ›å»ºè¡¨, æŸ¥çœ‹æ˜¯å¦ä¼šåŒæ­¥åˆ°mysql5.7ä»åº“</h3>
<pre><code>create table tutorials_tbl(
   tutorial_id INT NOT NULL AUTO_INCREMENT,
   tutorial_title VARCHAR(100) NOT NULL,
   tutorial_author VARCHAR(40) NOT NULL,
   submission_date DATE,
   PRIMARY KEY ( tutorial_id )
);
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> ä¿®æ”¹mysql5.7åº“å </font>
</center>
<h3 id="ä¿®æ”¹åº“å">ä¿®æ”¹åº“å</h3>
<blockquote>
<p>æ²¡é—®é¢˜ä¹‹å,æˆ‘ä»¬éœ€è¦å°†mysql5.7çš„mydatabaseåº“æ”¹æˆmydatabasenewåº“å, æ–­å¼€mysql5.5 å’Œmysql5.7ä¸»ä»åŒæ­¥(æœ€å¥½è®¾ç½®mysql5.5åªè¯»,é˜²æ­¢æ•°æ®å·®å¼‚), åœ¨mysql5.7ä¸Šæ‰§è¡Œæ”¹åº“å, ä»¥ä¸‹æœ‰è§¦å‘å™¨çš„è¡¨ä¼šä¿®æ”¹å¤±è´¥</p>
</blockquote>
<blockquote>
<p>æµ‹è¯•æ‰§è¡Œæ—¶é—´åœ¨15så·¦å³</p>
</blockquote>
<pre><code>#!/bin/bash
# å‡è®¾å°†sakilaæ•°æ®åº“åæ”¹ä¸ºnew_sakila
# MyISAMç›´æ¥æ›´æ”¹æ•°æ®åº“ç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯
new_database=mydatabasenew
old_database=mydatabase

mysql -S /disk/u01/mysql.sock -e 'create database if not exists ${new_database}'
list_table=$(mysql -S /disk/u01/mysql.sock -Nse  &quot;select table_name from information_schema.TABLES where TABLE_SCHEMA='${old_database}'&quot;)
for table in $list_table
do
    mysql -S /disk/u01/mysql.sock -e &quot;rename table ${old_database}.$table to ${new_database}.$table&quot;
done
</code></pre><h3 id="æ­¤æ—¶åœ¨é…ç½®æ–°çš„mysql57çš„ä¸»ä»æœºå™¨">æ­¤æ—¶åœ¨é…ç½®æ–°çš„mysql5.7çš„ä¸»ä»æœºå™¨</h3>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> ä¸€äº›é…ç½®é—®é¢˜ </font>
</center>
<hr>
<h3 id="gtid_mode-é…ç½®ä¸ç»Ÿä¸€">GTID_MODE é…ç½®ä¸ç»Ÿä¸€</h3>
<pre><code>The replication receiver thread cannot start because the master has GTID_MODE = OFF and this server has GTID_MODE = ON.

# æ°¸ä¹…ä¿®æ”¹
gtid_mode = off

# ä¸€æ¬¡æ€§å…³é—­æ­¥éª¤ï¼š
stop slave;
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';
SET GLOBAL GTID_MODE = 'OFF';
start slave;
</code></pre><h3 id="mysql57-sql_mode">mysql5.7 sql_mode</h3>
<pre><code>sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'

</code></pre><hr>
<h3 id="æ³¨æ„ä¸€å°æœºå™¨å¤šä¸ªmysqlå¯åŠ¨è„šæœ¬ä¿®æ”¹é—®é¢˜">æ³¨æ„ä¸€å°æœºå™¨å¤šä¸ªmysqlå¯åŠ¨è„šæœ¬ä¿®æ”¹é—®é¢˜</h3>
<pre><code>#ä»¥ä¸‹ä¸¤å¤„ä¿®æ”¹ /etc/init.d/mysqld57 
parse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`
$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=&quot;$mysqld_pid_file_path&quot; $other_args &gt;/dev/null &amp;
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> ä¸€äº›infoä¿¡æ¯ </font>
</center>
<h3 id="usrlocalmysql57binmysql_upgrade--s-disku01mysqlsock-çš„éƒ¨åˆ†è®°å½•">/usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock çš„éƒ¨åˆ†è®°å½•</h3>
<pre><code># /usr/local/mysql57/bin/mysql_upgrade -S /disk/u01/mysql.sock
Checking if update is needed.
Checking server version.
Running queries to upgrade MySQL server.
mysql_upgrade: (non fatal) [WARNING] 1642: Pre-4.1 password hash found. It is deprecated and will be removed in a future release. Please upgrade it to a new format.
Checking system database.
mysql.columns_priv                                 OK
mysql.db                                           OK
mysql.engine_cost                                  OK
mysql.event                                        OK
mysql.func                                         OK
mysql.general_log                                  OK
mysql.gtid_executed                                OK
mysql.help_category                                OK
mysql.help_keyword                                 OK
mysql.help_relation                                OK
mysql.help_topic                                   OK
mysql.host                                         OK
mysql.innodb_index_stats                           OK
mysql.innodb_table_stats                           OK
mysql.ndb_binlog_index                             OK
mysql.plugin                                       OK
mysql.proc                                         OK
mysql.procs_priv                                   OK
mysql.proxies_priv                                 OK
mysql.server_cost                                  OK
mysql.servers                                      OK
mysql.slave_master_info                            OK
mysql.slave_relay_log_info                         OK
mysql.slave_worker_info                            OK
mysql.slow_log                                     OK
...

</code></pre><h3 id="é™„å½•-my57cnf">é™„å½• my57.cnf</h3>
<pre><code>[client]
port = 3308
socket = /disk/u01/mysql.sock

[mysql]
prompt=&quot;\u@m1_618_u [\d]&gt; &quot;
no-auto-rehash

[mysqld]
sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'
replicate-wild-do-table=mydatabase.%

binlog-ignore-db=information_schema
binlog-ignore-db=mysql
binlog-ignore-db=performance_schema
binlog-ignore-db=test

binlog-do-db=mydatabase

user = mysql
port = 3308
basedir = /usr/local/mysql57
datadir = /disk/u01
socket = /disk/u01/mysql.sock
pid-file = /disk/u01/dbm1_u.pid
tmpdir = /disk/u02
server-id = 123
character-set-server = utf8
skip_name_resolve = 1
innodb_file_per_table = 1
explicit_defaults_for_timestamp = 0
read_only = 1

# buffer&amp;cache
table_open_cache = 100
table_definition_cache = 400
table_open_cache_instances = 64
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 8M
read_rnd_buffer_size = 4M

# thread&amp;connection
thread_stack = 256K
thread_cache_size = 768
back_log = 1024
max_connections = 3000
max_connect_errors = 1000000

# temptable
tmp_table_size = 32M
max_heap_table_size = 32M

# network
max_allowed_packet = 32M
#lock_wait_timeout = 3600
#interactive_timeout = 600
#wait_timeout = 600

# query cache
query_cache_size = 0
query_cache_type = 0

# è®¾ç½®errorlogã€slowlogå’Œgenerallogçš„æ—¶åŒºï¼Œé»˜è®¤UTC
log_timestamps = SYSTEM

# error-log
log_error = /disk/u02/mysqld.log

# slow-log
slow_query_log = 1
slow_query_log_file = /disk/u02/slow.log
long_query_time = 0.1
log_queries_not_using_indexes =1
log_throttle_queries_not_using_indexes = 60
min_examined_row_limit = 100
log_slow_admin_statements = 1
log_slow_slave_statements = 1

# general log
#general-log = 1
general_log_file=/disk/u02/query.log

# binlog
binlog_format = row
binlog_checksum = 1
log-bin = /disk/u02/m1-bin
log-bin-index = /disk/u02/m1-bin.index
sync_binlog = 0
binlog_cache_size = 4M
max_binlog_cache_size = 1G
max_binlog_size = 512M
expire_logs_days = 15

# GTID
gtid_mode = off
enforce_gtid_consistency = 1
log_slave_updates

# Replication
master_info_repository = TABLE
relay_log_info_repository = TABLE
slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'
relay_log_recovery = 1
relay_log_purge = 1
relay-log=/disk/u02/m1-relay-bin
relay-log-index=/disk/u02/m1-relay-bin.index

# innodb-buffer&amp;cache
innodb_buffer_pool_size = 1G
innodb_buffer_pool_instances = 4
#innodb_additional_mem_pool_size = 16M
innodb_max_dirty_pages_pct = 50

# innodb log
innodb_data_file_path = ibdata1:256M:autoextend
innodb_log_file_size = 256M
innodb_log_files_in_group = 2
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 32M
#innodb_max_undo_log_size = 4G
#innodb_undo_directory = undolog
innodb_undo_tablespaces = 0

# innodb-io
innodb_flush_method = O_DIRECT
innodb_io_capacity = 600
innodb_io_capacity_max = 2000
innodb_flush_sync = 0
innodb_flush_neighbors = 0
#innodb_lru_scan_depth = 4000
innodb_write_io_threads = 8
innodb_read_io_threads = 8
innodb_purge_threads = 4
innodb_page_cleaners = 4

# transaction,lock
#innodb_sync_spin_loops = 100
#innodb_spin_wait_delay = 30
innodb_lock_wait_timeout = 10
innodb_print_all_deadlocks = 1
innodb_rollback_on_timeout = 1

innodb_open_files = 65535

innodb_online_alter_log_max_size = 1G

# innodb status
innodb_status_file = 1
# æ³¨æ„: å¼€å¯ innodb_status_output &amp; innodb_status_output_locks å, å¯èƒ½ä¼šå¯¼è‡´log-erroræ–‡ä»¶å¢é•¿è¾ƒå¿«
innodb_status_output = 0
innodb_status_output_locks = 0

#performance_schema
performance_schema = 1
performance_schema_instrument = '%=on'

#innodb monitor
innodb_monitor_enable=&quot;module_innodb&quot;
innodb_monitor_enable=&quot;module_server&quot;
innodb_monitor_enable=&quot;module_dml&quot;
innodb_monitor_enable=&quot;module_ddl&quot;
innodb_monitor_enable=&quot;module_trx&quot;
innodb_monitor_enable=&quot;module_os&quot;
innodb_monitor_enable=&quot;module_purge&quot;
innodb_monitor_enable=&quot;module_log&quot;
innodb_monitor_enable=&quot;module_lock&quot;
innodb_monitor_enable=&quot;module_buffer&quot;
innodb_monitor_enable=&quot;module_index&quot;
innodb_monitor_enable=&quot;module_ibuf_system&quot;
innodb_monitor_enable=&quot;module_buffer_page&quot;
innodb_monitor_enable=&quot;module_adaptive_hash&quot;

# MyISAM
key_buffer_size = 1024M
bulk_insert_buffer_size = 64M
myisam_sort_buffer_size = 128M
myisam_repair_threads = 1


[mysqldump]
quick
max_allowed_packet = 32M
</code></pre>]]></content>
		</item>
		
		<item>
			<title>es5é›†ç¾¤ç£ç›˜æ‰©å®¹</title>
			<link>https://www.ngirl.xyz/posts/22-es%E9%9B%86%E7%BE%A4%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/</link>
			<pubDate>Mon, 28 Oct 2019 14:59:52 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/22-es%E9%9B%86%E7%BE%A4%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/</guid>
			<description>esé›†ç¾¤ç£ç›˜ä¸è¶³,å¯¹ç£ç›˜æ‰©å®¹é‡åˆ°ä¸€äº›çš„é—®é¢˜
  é‡å¯é›†ç¾¤å‰ï¼Œå…ˆè®¾ç½®é›†ç¾¤åœæ­¢åˆ†ç‰‡ç§»åŠ¨ï¼š curl -XPUT http://localhost:9200/_cluster/settings -d &#39;{ &amp;quot;transient&amp;quot; : { &amp;quot;cluster.routing.allocation.enable&amp;quot; : &amp;quot;none&amp;quot; } }&#39; å¯¹ç£ç›˜è¿›è¡Œæ‰©å®¹,æ¯æ¬¡æ“ä½œä¸€ä¸ªèŠ‚ç‚¹ # ç›´æ¥æ‰©å®¹ç£ç›˜åˆ°2T //é’ˆå¯¹ext4æ–‡ä»¶æ ¼å¼çš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚CentOS6ï¼‰ï¼š// umount /dev/vdb e2fsck -f /dev/vdb resize2fs /dev/vdb mount /dev/vdb /data # æˆ–è€…æ–°å¢ 2Täº‘ç›˜/dev/vdc umount /data/ mkdir /data2 mount /dev/vdb /data2 mkfs.ext4 /dev/vdc mount /dev/vdc /data cp -ra /data2/* /data/ é‡å¯ä¹‹åï¼Œæ¢å¤åˆ†ç‰‡è‡ªåŠ¨åˆ†é…ï¼š curl -XPUT http://localhost:9200/_cluster/settings -d &#39;{ &amp;quot;transient&amp;quot; : { &amp;quot;cluster.routing.allocation.enable&amp;quot; : &amp;quot;all&amp;quot; } }&#39;    å¦‚æœéœ€è¦ä¸‹çº¿å…¶ä¸­çš„èŠ‚ç‚¹, å…ˆå°†åˆ†ç‰‡éƒ½è½¬ä¹‰åˆ°å…¶ä»–èŠ‚ç‚¹ # æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¼šè‡ªåŠ¨å°†10.</description>
			<content type="html"><![CDATA[<p>esé›†ç¾¤ç£ç›˜ä¸è¶³,å¯¹ç£ç›˜æ‰©å®¹é‡åˆ°ä¸€äº›çš„é—®é¢˜</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="é‡å¯é›†ç¾¤å‰å…ˆè®¾ç½®é›†ç¾¤åœæ­¢åˆ†ç‰‡ç§»åŠ¨">é‡å¯é›†ç¾¤å‰ï¼Œå…ˆè®¾ç½®é›†ç¾¤åœæ­¢åˆ†ç‰‡ç§»åŠ¨ï¼š</h3>
<pre><code>curl -XPUT http://localhost:9200/_cluster/settings -d '{
&quot;transient&quot; : {
&quot;cluster.routing.allocation.enable&quot; : &quot;none&quot;
}
}'
</code></pre><h3 id="å¯¹ç£ç›˜è¿›è¡Œæ‰©å®¹æ¯æ¬¡æ“ä½œä¸€ä¸ªèŠ‚ç‚¹">å¯¹ç£ç›˜è¿›è¡Œæ‰©å®¹,æ¯æ¬¡æ“ä½œä¸€ä¸ªèŠ‚ç‚¹</h3>
<pre><code># ç›´æ¥æ‰©å®¹ç£ç›˜åˆ°2T
//é’ˆå¯¹ext4æ–‡ä»¶æ ¼å¼çš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚CentOS6ï¼‰ï¼š//
umount /dev/vdb
e2fsck -f /dev/vdb
resize2fs /dev/vdb
mount /dev/vdb /data


# æˆ–è€…æ–°å¢ 2Täº‘ç›˜/dev/vdc
umount /data/
mkdir /data2
mount /dev/vdb /data2
mkfs.ext4 /dev/vdc
mount /dev/vdc /data
cp -ra /data2/* /data/
</code></pre><h3 id="é‡å¯ä¹‹åæ¢å¤åˆ†ç‰‡è‡ªåŠ¨åˆ†é…">é‡å¯ä¹‹åï¼Œæ¢å¤åˆ†ç‰‡è‡ªåŠ¨åˆ†é…ï¼š</h3>
<pre><code>curl -XPUT http://localhost:9200/_cluster/settings -d '{
&quot;transient&quot; : {
&quot;cluster.routing.allocation.enable&quot; : &quot;all&quot;
}
}'
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å¦‚æœéœ€è¦ä¸‹çº¿å…¶ä¸­çš„èŠ‚ç‚¹-å…ˆå°†åˆ†ç‰‡éƒ½è½¬ä¹‰åˆ°å…¶ä»–èŠ‚ç‚¹">å¦‚æœéœ€è¦ä¸‹çº¿å…¶ä¸­çš„èŠ‚ç‚¹, å…ˆå°†åˆ†ç‰‡éƒ½è½¬ä¹‰åˆ°å…¶ä»–èŠ‚ç‚¹</h3>
<pre><code># æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¼šè‡ªåŠ¨å°†10.10.0.1 èŠ‚ç‚¹ä¸Šçš„åˆ†ç‰‡å…¨éƒ¨è¿ç§»åˆ°å…¶ä»–æœºå™¨, ç­‰å¾…è¿ç§»å®Œæˆ, å°†æ”¹ç©ºæœºå™¨ä¸‹çº¿å³å¯
curl -XPUT 127.0.0.1:9200/_cluster/settings -d '{
&quot;transient&quot; :{
&quot;cluster.routing.allocation.exclude._ip&quot; : &quot;10.10.0.1&quot;
}
}'
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å¦å¤–å¯¹äº--pathdata-é…ç½®å¤šå¿«ç›˜çš„é—®é¢˜">å¦å¤–å¯¹äº  path.data é…ç½®å¤šå¿«ç›˜çš„é—®é¢˜</h3>
<pre><code>æ¯”å¦‚es8é…ç½®äº†ä¸‰å—ç›˜:
/disk4/data -&gt; sde, /disk5/data -&gt; sdf, disk6/data -&gt; sdg

è¿™é‡Œæ³¨æ„ es nodeçš„data pathå°½é‡ä¿è¯ç›˜çš„å¤§å°å·®åˆ«ä¸è¦å¤ªå¤§, sde,sdf,sdgçš„å¤§å°ä¿éšœå·®ä¸å¤š, å¦åˆ™ç”±äºes shard å‡è¡¡çš„æ—¶å€™å¯èƒ½ä¼šä¼˜å…ˆåˆ†é…åˆ°ç£ç›˜å¤§çš„ç›®å½•, å¯èƒ½ä¼šå¯¼è‡´sde(å‡å¦‚è¿™ä¸ªç£ç›˜æœ€å¤§)çš„IOé«˜, è€Œsdfç­‰IOä½
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="ç®€å•çš„é…ç½®ä¿¡æ¯elasticsearch5">ç®€å•çš„é…ç½®ä¿¡æ¯elasticsearch5</h3>
<pre><code> cluster.name: es-dev
 node.name: es1-u
 path.data: /data/es/data
 path.logs: /data/es/logs
 network.host: 0.0.0.0
 discovery.zen.ping.unicast.hosts: [&quot;10.10.0.1:9300&quot;,&quot;10.10.0.2:9300&quot;,&quot;10.10.0.3:9300&quot;,&quot;10.10.0.4:9300&quot;]
 http.cors.enabled: true
 http.cors.allow-origin: &quot;*&quot;
 xpack.security.enabled: false
 bootstrap.system_call_filter: false
 thread_pool.bulk.queue_size: 3000
 # é˜²æ­¢è„‘è£‚
 discovery.zen.minimum_master_nodes: 2
</code></pre>]]></content>
		</item>
		
		<item>
			<title>æµé‡å¤åˆ¶å·¥å…·gor</title>
			<link>https://www.ngirl.xyz/posts/21-%E6%B5%81%E9%87%8F%E5%A4%8D%E5%88%B6%E5%B7%A5%E5%85%B7gor/</link>
			<pubDate>Mon, 28 Oct 2019 14:04:37 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/21-%E6%B5%81%E9%87%8F%E5%A4%8D%E5%88%B6%E5%B7%A5%E5%85%B7gor/</guid>
			<description>Gor æ˜¯ä¸€æ¬¾goè¯­è¨€å®ç°çš„ç®€å•çš„httpæµé‡å¤åˆ¶å·¥å…·ï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä½¿ä½ çš„ç”Ÿäº§ç¯å¢ƒHTTPçœŸå®æµé‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œé¢„å‘å¸ƒç¯å¢ƒé‡ç°
 æµé‡å¤åˆ¶å·¥å…·   ä¸‹è½½å®‰è£… githubä¸‹è½½åœ°å€: https://github.com/buger/goreplay/releases
tar -xvf gor_1.0.0_x64.tar.gz mv gor /usr/bin/ which gor å‘½ä»¤ 1 ä¿å­˜è¯·æ±‚åˆ°æ–‡ä»¶ # å°†æœ¬æœºæ‰€æœ‰80è¯·æ±‚ä¿å­˜åˆ°gor-20171120_0.logæ–‡ä»¶(æ³¨æ„ä¼šç”Ÿæˆå¾ˆå¤šæ–‡ä»¶) gor --input-raw :80 --output-file gor-%Y%m%d.log # --output-file-append ä¼šç”Ÿæˆgor-20171120.logæ–‡ä»¶ gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append 2 æ ¹æ®æ–‡ä»¶å›æ”¾è¯·æ±‚ # é•œåƒqpså›æ”¾ gor --input-file gor-aaaa-20171120.log --output-http aaaa-dev.test.com # ä¸¤å€é•œåƒqpså›æ”¾ gor --input-file &amp;quot;gor-aaaa-20171120.log|200%&amp;quot; --output-http aaaa-dev.test.com 3 è¿‡æ»¤urlåä¿å­˜è¯·æ±‚åˆ°æ–‡ä»¶ # æ’é™¤s.test.comçš„è¯·æ±‚ gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append --http-disallow-header &amp;quot;Host: s.test.com&amp;quot; --http-disallow-header &amp;quot;Host: www.test.com&amp;quot; --http-disallow-header &amp;quot;Host: bbs.</description>
			<content type="html"><![CDATA[<p>Gor æ˜¯ä¸€æ¬¾goè¯­è¨€å®ç°çš„ç®€å•çš„httpæµé‡å¤åˆ¶å·¥å…·ï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä½¿ä½ çš„ç”Ÿäº§ç¯å¢ƒHTTPçœŸå®æµé‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œé¢„å‘å¸ƒç¯å¢ƒé‡ç°</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> æµé‡å¤åˆ¶å·¥å…· </font>
</center>
<h3 id="ä¸‹è½½å®‰è£…">ä¸‹è½½å®‰è£…</h3>
<p>githubä¸‹è½½åœ°å€: <a href="https://github.com/buger/goreplay/releases">https://github.com/buger/goreplay/releases</a></p>
<pre><code>tar -xvf gor_1.0.0_x64.tar.gz
mv gor /usr/bin/

which gor
</code></pre><h3 id="å‘½ä»¤">å‘½ä»¤</h3>
<pre><code>1   ä¿å­˜è¯·æ±‚åˆ°æ–‡ä»¶
# å°†æœ¬æœºæ‰€æœ‰80è¯·æ±‚ä¿å­˜åˆ°gor-20171120_0.logæ–‡ä»¶(æ³¨æ„ä¼šç”Ÿæˆå¾ˆå¤šæ–‡ä»¶)
gor --input-raw :80 --output-file gor-%Y%m%d.log

# --output-file-append ä¼šç”Ÿæˆgor-20171120.logæ–‡ä»¶
gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append


2   æ ¹æ®æ–‡ä»¶å›æ”¾è¯·æ±‚
# é•œåƒqpså›æ”¾
gor --input-file gor-aaaa-20171120.log --output-http aaaa-dev.test.com
# ä¸¤å€é•œåƒqpså›æ”¾
gor --input-file &quot;gor-aaaa-20171120.log|200%&quot; --output-http aaaa-dev.test.com


3   è¿‡æ»¤urlåä¿å­˜è¯·æ±‚åˆ°æ–‡ä»¶
# æ’é™¤s.test.comçš„è¯·æ±‚
gor --input-raw :80 --output-file gor-%Y%m%d.log --output-file-append --http-disallow-header &quot;Host: s.test.com&quot; --http-disallow-header &quot;Host: www.test.com&quot;  --http-disallow-header &quot;Host: bbs.test.com&quot;
# åªå­˜å‚¨aaaa.test.comçš„è¯·æ±‚
gor --input-raw :80 --output-file gor-aaaa-%Y%m%d.log --output-file-append --http-allow-header &quot;Host: aaaa.test.com&quot;

# httpsçš„ä¸èƒ½æŠ“åŒ…
gor --input-raw :443 --output-file gor-ssl-aaaa-%Y%m%d.log --output-file-append --http-allow-header &quot;Host: aaaa.test.com&quot;





4   åœ¨çº¿é•œåƒå¤åˆ¶è¯·æ±‚
# å°†ç”Ÿäº§aaaa.test.comçš„è¯·æ±‚å¤åˆ¶åˆ° aaaa-dev.test.com ç¯å¢ƒ!
gor --input-raw :80 --output-http &quot;aaaa-dev.test.com&quot; --http-allow-header &quot;Host: aaaa.test.com&quot;
</code></pre><h3 id="ç¦»çº¿æ–‡ä»¶ç¼–è¾‘">ç¦»çº¿æ–‡ä»¶ç¼–è¾‘</h3>
<pre><code>æ–‡ä»¶çš„æ¯ä¸ªè¯·æ±‚é€šè¿‡ å¦‚ä¸‹å­—ç¬¦ä¸²åˆ†å‰²!
Ã°&lt;9f&gt;&lt;90&gt;ÂµÃ°&lt;9f&gt;&lt;99&gt;&lt;88&gt;Ã°&lt;9f&gt;&lt;99&gt;&lt;89&gt;
å¹¶ä¸”ç¬¬ä¸€è¡Œæ˜¯ è¯·æ±‚çš„å”¯ä¸€ç ? å’Œæ—¶é—´æˆ³!
1 9b366a8eab8d6cb8e557cb3bf43f69c36612cffb 1511165572419843000

æ‰€ä»¥å¯å½•åˆ¶æ¯”å¦‚åŠå°æ—¶çš„ç„¶åçªƒå–éœ€è¦çš„æ—¶é—´æ®µ!

</code></pre><h3 id="é—®é¢˜--https-ä¸èƒ½æŠ“åŒ…">é—®é¢˜  https ä¸èƒ½æŠ“åŒ…!</h3>
<blockquote>
<p>é€šè¿‡æ·»åŠ ä»£ç†, goræŠ“å–8000ç«¯å£</p>
</blockquote>
<pre><code># SSL termination
server {
  listen 443 ssl;
  server_name aaaa.test.com;

  ssl_certificate /etc/ssl/nginx/server.crt;
  ssl_certificate_key /etc/ssl/nginx/server.key;

  location / {
    proxy_set_header Host $host;
    proxy_pass http://localhost:8000;
  }
}

server {
  listen 8000;
  server_name aaaa.test.com;

  location / {
    proxy_set_header Host $host;
    proxy_pass http://production_shop_api_site;
  }
}

</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8sæ­å»ºmysql5.7.24ä¸»ä»</title>
			<link>https://www.ngirl.xyz/posts/20-k8s%E6%90%AD%E5%BB%BAmysql5-7-24%E4%B8%BB%E4%BB%8E/</link>
			<pubDate>Thu, 24 Oct 2019 18:35:00 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/20-k8s%E6%90%AD%E5%BB%BAmysql5-7-24%E4%B8%BB%E4%BB%8E/</guid>
			<description>k8sä¸Šç®€å•éƒ¨ç½²mysql5.7.24ä¸»ä»
 k8sæ­å»ºmysql5.7.24ä¸»ä»   å‚è€ƒæ–‡æ¡£ åˆ©ç”¨Kubernetesæ­å»ºmysqlä¸»ä»å¤åˆ¶é›†ç¾¤ å®˜æ–¹dockerfile
ä»hub.docker.comæ‹‰å–å®˜æ–¹é•œåƒ docker pull mysql:5.7.24  buildé•œåƒ   ä¸»åº“masterçš„Dockerfile from mysql:5.7.24 run sed -i &#39;/\[mysqld\]/a server-id=1\nlog-bin&#39; /etc/mysql/mysql.conf.d/mysqld.cnf COPY docker-entrypoint.sh /usr/local/bin/ ä¸»åº“çš„docker-entrypoint.sh  å…ˆä»åˆå§‹é•œåƒå– æˆ–è€…ä»githubå¯¹åº”ç‰ˆæœ¬ä¸Š  docker run -dti mysql:5.7.24 /bin/bash docker cp 2bfa6209d120c23:/usr/local/bin/docker-entrypoint.sh .  ä¿®æ”¹docker-entrypoint.sh  fi # æ·»åŠ ä»¥ä¸‹å†…å®¹ echo &amp;quot;CREATE USER &#39;$MYSQL_REPLICATION_USER&#39;@&#39;%&#39; IDENTIFIED BY &#39;$MYSQL_REPLICATION_PASSWORD&#39; ;&amp;quot; | &amp;quot;${mysql[@]}&amp;quot; echo &amp;quot;GRANT REPLICATION SLAVE ON *.* TO &#39;$MYSQL_REPLICATION_USER&#39;@&#39;%&#39; IDENTIFIED BY &#39;$MYSQL_REPLICATION_PASSWORD&#39; ;&amp;quot; | &amp;quot;${mysql[@]}&amp;quot; echo &amp;quot;FLUSH PRIVILEGES ;&amp;quot; | &amp;quot;${mysql[@]}&amp;quot; # æ·»åŠ ä»¥ä¸Šå†…å®¹ echo ls /docker-entrypoint-initdb.</description>
			<content type="html"><![CDATA[<p>k8sä¸Šç®€å•éƒ¨ç½²mysql5.7.24ä¸»ä»</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> k8sæ­å»ºmysql5.7.24ä¸»ä» </font>
</center>
<p>å‚è€ƒæ–‡æ¡£
<a href="https://www.jianshu.com/p/509b65e9a4f5">åˆ©ç”¨Kubernetesæ­å»ºmysqlä¸»ä»å¤åˆ¶é›†ç¾¤</a>
<a href="https://github.com/docker-library/mysql">å®˜æ–¹dockerfile</a></p>
<h3 id="ä»hubdockercomæ‹‰å–å®˜æ–¹é•œåƒ">ä»hub.docker.comæ‹‰å–å®˜æ–¹é•œåƒ</h3>
<pre><code>docker pull mysql:5.7.24
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> buildé•œåƒ </font>
</center>
<h3 id="ä¸»åº“masterçš„dockerfile">ä¸»åº“masterçš„Dockerfile</h3>
<pre><code>from mysql:5.7.24

run sed -i '/\[mysqld\]/a server-id=1\nlog-bin' /etc/mysql/mysql.conf.d/mysqld.cnf

COPY docker-entrypoint.sh /usr/local/bin/
</code></pre><h3 id="ä¸»åº“çš„docker-entrypointsh">ä¸»åº“çš„docker-entrypoint.sh</h3>
<ul>
<li>å…ˆä»åˆå§‹é•œåƒå– æˆ–è€…ä»githubå¯¹åº”ç‰ˆæœ¬ä¸Š</li>
</ul>
<pre><code>docker run -dti mysql:5.7.24 /bin/bash

docker cp 2bfa6209d120c23:/usr/local/bin/docker-entrypoint.sh .
</code></pre><ul>
<li>ä¿®æ”¹docker-entrypoint.sh</li>
</ul>
<pre><code>fi
# æ·»åŠ ä»¥ä¸‹å†…å®¹
echo &quot;CREATE USER '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;&quot; | &quot;${mysql[@]}&quot;
echo &quot;GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;&quot; | &quot;${mysql[@]}&quot;
echo &quot;FLUSH PRIVILEGES ;&quot; | &quot;${mysql[@]}&quot;
# æ·»åŠ ä»¥ä¸Šå†…å®¹
echo
  ls /docker-entrypoint-initdb.d/ &gt; /dev/null
</code></pre><ul>
<li>buildä¸»åº“é•œåƒ</li>
</ul>
<pre><code>docker build -t hub.zhangzw.com/bq/mysql-master:5.7.24 .
docker push hub.zhangzw.com/bq/mysql-master:5.7.24
</code></pre><h3 id="ä»åº“çš„docker-entrypointsh">ä»åº“çš„docker-entrypoint.sh</h3>
<ul>
<li>åŒä¸Šå…ˆä»åˆå§‹é•œåƒå– æˆ–è€…ä»githubå¯¹åº”ç‰ˆæœ¬ä¸Š æˆ–å¤åˆ¶ä¸Šé¢çš„æ–‡ä»¶</li>
<li>ä¿®æ”¹docker-entrypoint.sh</li>
</ul>
<pre><code>fi
# æ·»åŠ ä»¥ä¸‹å†…å®¹
 echo &quot;STOP SLAVE;&quot; | &quot;${mysql[@]}&quot;
 echo &quot;CHANGE MASTER TO master_host='$MYSQL_MASTER_SERVICE_HOST', master_user='$MYSQL_REPLICATION_USER', master_password='$MYSQL_REPLICATION_PASSWORD' ;&quot; |  &quot;${mysql[@]}&quot;
 echo &quot;START SLAVE;&quot; | &quot;${mysql[@]}&quot;
 # æ·»åŠ ä»¥ä¸Šå†…å®¹
echo
  ls /docker-entrypoint-initdb.d/ &gt; /dev/null

</code></pre><ul>
<li>buildä»åº“é•œåƒ</li>
</ul>
<pre><code>docker build -t hub.zhangzw.com/bq/mysql-slave:5.7.24 .
docker push hub.zhangzw.com/bq/mysql-slave:5.7.24
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å¼€å§‹éƒ¨ç½² </font>
</center>
<ul>
<li>k8s-master-mysql_5.7.24.yml</li>
</ul>
<pre><code>---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  labels:
    app: php-mysql-master-dev
  name: php-mysql-master-dev
  namespace: db
spec:
  serviceName: &quot;php-mysql-master-dev&quot;
  replicas: 1
  selector:
    matchLabels:
      app: php-mysql-master-dev
  template:
    metadata:
      labels:
        app: php-mysql-master-dev
    spec:
      containers:
       - name: php-mysql-master-dev
         image: hub.zhangzw.com/bq/mysql-master:5.7.24
         ports:
         - containerPort: 3306
           name: db-port
         resources:
           requests:
             cpu: &quot;50m&quot;
           limits:
             cpu: &quot;1000m&quot;
         env:
         - name: MYSQL_ROOT_PASSWORD
           value: &quot;admin&quot;
         - name: MYSQL_REPLICATION_USER
           value: &quot;repl&quot;
         - name: MYSQL_REPLICATION_PASSWORD
           value: &quot;7a5b21ac65712bd95e39d3c1&quot;
         volumeMounts:
         - name: order-master-dev-data
           mountPath: /var/lib/mysql
         - name: order-master-dev-cfg
           mountPath: /etc/mysql
      volumes:
        - name: order-master-dev-data
          hostPath:
            path: /data/k8s-container/php-mysql-dev/master/data
        - name: order-master-dev-cfg
          hostPath:
            path: /data/k8s-container/php-mysql-dev/master/etc-mysql

---

kind: Service
apiVersion: v1
metadata:
  labels:
    app: php-mysql-master-dev
  name: php-mysql-master-dev-service
  namespace: db
spec:
  type: NodePort
  ports:
    - port: 3306
      name: db-port
      targetPort: 3306
      nodePort: 23306
      protocol: TCP
  selector:
    app: php-mysql-master-dev
</code></pre><ul>
<li>k8s-slave-mysql_5.7.24.yml</li>
</ul>
<pre><code>---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  labels:
    app: php-mysql-slave-dev
  name: php-mysql-slave-dev
  namespace: db
spec:
  serviceName: &quot;php-mysql-slave-dev&quot;
  replicas: 1
  selector:
    matchLabels:
      app: php-mysql-slave-dev
  template:
    metadata:
      labels:
        app: php-mysql-slave-dev
    spec:
      containers:
       - name: php-mysql-slave-dev
         image: hub.zhangzw.com/bq/mysql-slave:5.7.24
         ports:
         - containerPort: 3306
           name: db-port
         resources:
           requests:
             cpu: &quot;50m&quot;
           limits:
             cpu: &quot;1000m&quot;
         env:
         - name: MYSQL_ROOT_PASSWORD
           value: &quot;admin&quot;
         - name: MYSQL_REPLICATION_USER
           value: &quot;repl&quot;
         - name: MYSQL_REPLICATION_PASSWORD
           value: &quot;7a5b21ac65712bd95e39d3c1&quot;
         - name: MYSQL_MASTER_SERVICE_HOST
           value: &quot;php-mysql-master-dev-service&quot;
         volumeMounts:
         - name: order-slave-dev-data
           mountPath: /var/lib/mysql
         - name: order-slave-dev-cfg
           mountPath: /etc/mysql
      volumes:
        - name: order-slave-dev-data
          hostPath:
            path: /data/k8s-container/php-mysql-dev/slave/data
        - name: order-slave-dev-cfg
          hostPath:
            path: /data/k8s-container/php-mysql-dev/slave/etc-mysql


---

kind: Service
apiVersion: v1
metadata:
  labels:
    app: php-mysql-slave-dev
  name: php-mysql-slave-dev-service
  namespace: db
spec:
  type: NodePort
  ports:
    - port: 3306
      name: db-port
      targetPort: 3306
      nodePort: 23307
      protocol: TCP
  selector:
    app: php-mysql-slave-dev
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> é—®é¢˜æ€»ç»“ </font>
</center>
<ul>
<li>ä»åº“çš„replay logåå­—ä¼šæ ¹æ®dockerä¸»æœºåå˜åŒ–, ä¹Ÿå¯ä»¥å†™åœ¨é…ç½®æ–‡ä»¶</li>
</ul>
<pre><code># Dockerfileä¸­å¯ä»¥æ·»åŠ 
run sed -i '/\[mysqld\]/a relay-log-index=php-mysql-shoporder-slave-dev-relay-bin.index' /etc/mysql/mysql.conf.d/mysqld.cnf
</code></pre><ul>
<li>
<p>æ³¨æ„MYSQL_MASTER_SERVICE_HOST å˜é‡çš„é…ç½®, æ ¹æ®ä½ masterçš„serviceå˜åŒ–</p>
</li>
<li>
<p>å…¶æ¬¡æˆ‘docker-entrypoint.sh æ–‡ä»¶å‡ æ¬¡æ‰‹åŠ¨ä»é¡µé¢å¤åˆ¶ç²˜è´´ä¸‹æ¥çš„å¯¼è‡´å„ç§è¯­æ³•é”™è¯¯,è¿™é‡Œå»ºè®®æ‰¾åˆ°å¯¹çš„ç‰ˆæœ¬ä»githubå…‹éš†, æˆ–è€…ä»mysql:5.7.24é•œåƒä¸­cp</p>
</li>
<li>
<p>é…ç½®etc-mysql/mysql.conf.d/mysqld.cnf</p>
</li>
</ul>
<pre><code>[mysqld]
# ä»åº“é…ç½®
read_only=1
super_read_only=1
character-set-server=utf8
# 1 å»æ‰STRICT_TRANS_TABLES è¡¨NOT NULLæ—¶æ— æ³•åˆ›å»ºè¡¨
# 2 ä¿®æ”¹NO_ZERO_DATEä¸ºALLOW_INVALID_DATES å…è®¸â€™0000-00-00â€™
#sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'
sql_mode='ONLY_FULL_GROUP_BY,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'
</code></pre><ul>
<li>é…ç½®etc-mysql/conf.d/mysql.cnf</li>
</ul>
<pre><code>[mysql]
no-auto-rehash
default-character-set=utf8
</code></pre><h3 id="é™„å½•">é™„å½•</h3>
<p><a href="//zhangzw001.github.io/sh/master-docker-entrypoint.sh">masteré…ç½®docker-entrypoint.sh</a>
<a href="//zhangzw001.github.io/sh/slave-docker-entrypoint.sh">slaveé…ç½®docker-entrypoint.sh</a></p>
]]></content>
		</item>
		
		<item>
			<title>shellä¸­gtå’Œ&gt;çš„åŒºåˆ«</title>
			<link>https://www.ngirl.xyz/posts/19-shell%E4%B8%ADgt%E5%92%8C%E7%9A%84%E5%8C%BA%E5%88%AB/</link>
			<pubDate>Thu, 17 Oct 2019 11:48:22 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/19-shell%E4%B8%ADgt%E5%92%8C%E7%9A%84%E5%8C%BA%E5%88%AB/</guid>
			<description>shellä¸­ gt å’Œ &amp;gt; çš„ä¸€äº›ç›¸å…³é—®é¢˜ä»‹ç»å’Œæµ‹è¯•
 ä»¥ä¸‹æ˜¯bashçš„æµ‹è¯•, æ³¨æ„å¦‚æœä½ æ˜¯zshå¯èƒ½ä¼šä¸åŒå–”ğŸ˜¯
  [[]] , [] å’Œtestæ¯”è¾ƒ   [] å’Œtest:	ä¸¤è€…æ˜¯ä¸€æ ·çš„ï¼Œåœ¨å‘½ä»¤è¡Œé‡Œtest exprå’Œ[ expr ]çš„æ•ˆæœç›¸åŒã€‚testä¸­å¯ç”¨çš„æ¯”è¾ƒè¿ç®—ç¬¦åªæœ‰==å’Œ!=ï¼Œä¸¤è€…éƒ½æ˜¯ç”¨äºå­—ç¬¦ä¸²æ¯”è¾ƒçš„ï¼Œä¸å¯ç”¨äºæ•´æ•°æ¯”è¾ƒï¼Œæ•´æ•°æ¯”è¾ƒåªèƒ½ä½¿ç”¨-eq, -gtè¿™ç§å½¢å¼ã€‚ é€šè¿‡which [ å’Œwhich test å¯ä»¥çœ‹åˆ°æ˜¯å‘½ä»¤
 [] å’Œtest ä¾‹å­
 [root@dk-centos6 ~]# a=&amp;quot;abcdef&amp;quot; [root@dk-centos6 ~]# test &amp;quot;$a&amp;quot; = &amp;quot;abcdef&amp;quot; [root@dk-centos6 ~]# echo $? 0 [root@dk-centos6 ~]# [ &amp;quot;$a&amp;quot; = &amp;quot;abcdef&amp;quot; ] [root@dk-centos6 ~]# echo $? 0 [[ ]]å…·ä½“åŠŸèƒ½:
  [[æ˜¯ bash ç¨‹åºè¯­è¨€çš„å…³é”®å­—ã€‚å¹¶ä¸æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œ[] ç»“æ„æ¯”ç»“æ„æ›´åŠ é€šç”¨ã€‚åœ¨[[å’Œ]]ä¹‹é—´æ‰€æœ‰çš„å­—ç¬¦éƒ½ä¸ä¼šå‘ç”Ÿæ–‡ä»¶åæ‰©å±•æˆ–è€…å•è¯åˆ†å‰²ï¼Œä½†æ˜¯ä¼šå‘ç”Ÿå‚æ•°æ‰©å±•å’Œå‘½ä»¤æ›¿æ¢ã€‚
  æ”¯æŒå­—ç¬¦ä¸²çš„æ¨¡å¼åŒ¹é…ï¼ˆä½¿ç”¨=~æ“ä½œç¬¦æ—¶ç”šè‡³æ”¯æŒshellçš„æ­£åˆ™è¡¨è¾¾ å¼ï¼‰,å³è¾¹çš„å­—ç¬¦ä¸²ä¸åŠ åŒå¼•å·çš„æƒ…å†µ,å¯ä»¥æŠŠå³è¾¹ä½œä¸ºæ¨¡å¼.</description>
			<content type="html"><![CDATA[<p>shellä¸­ gt å’Œ &gt; çš„ä¸€äº›ç›¸å…³é—®é¢˜ä»‹ç»å’Œæµ‹è¯•</p>
<!-- more-->
<blockquote>
<p>ä»¥ä¸‹æ˜¯bashçš„æµ‹è¯•, æ³¨æ„å¦‚æœä½ æ˜¯zshå¯èƒ½ä¼šä¸åŒå–”ğŸ˜¯</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=4> [[]] , [] å’Œtestæ¯”è¾ƒ </font>
</center>
<p>[] å’Œtest:	ä¸¤è€…æ˜¯ä¸€æ ·çš„ï¼Œåœ¨å‘½ä»¤è¡Œé‡Œtest exprå’Œ[ expr ]çš„æ•ˆæœç›¸åŒã€‚testä¸­å¯ç”¨çš„æ¯”è¾ƒè¿ç®—ç¬¦åªæœ‰==å’Œ!=ï¼Œä¸¤è€…éƒ½æ˜¯ç”¨äºå­—ç¬¦ä¸²æ¯”è¾ƒçš„ï¼Œä¸å¯ç”¨äºæ•´æ•°æ¯”è¾ƒï¼Œæ•´æ•°æ¯”è¾ƒåªèƒ½ä½¿ç”¨-eq, -gtè¿™ç§å½¢å¼ã€‚
é€šè¿‡which [ å’Œwhich test å¯ä»¥çœ‹åˆ°æ˜¯å‘½ä»¤</p>
<blockquote>
<p>[] å’Œtest ä¾‹å­</p>
</blockquote>
<pre><code>[root@dk-centos6 ~]# a=&quot;abcdef&quot;
[root@dk-centos6 ~]# test &quot;$a&quot; = &quot;abcdef&quot;
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [ &quot;$a&quot; = &quot;abcdef&quot; ]
[root@dk-centos6 ~]# echo $?
0
</code></pre><p>[[ ]]å…·ä½“åŠŸèƒ½:</p>
<ul>
<li>
<p>[[æ˜¯ bash ç¨‹åºè¯­è¨€çš„å…³é”®å­—ã€‚å¹¶ä¸æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œ[<input disabled="" type="checkbox"> ] ç»“æ„æ¯”<input disabled="" type="checkbox"> ç»“æ„æ›´åŠ é€šç”¨ã€‚åœ¨[[å’Œ]]ä¹‹é—´æ‰€æœ‰çš„å­—ç¬¦éƒ½ä¸ä¼šå‘ç”Ÿæ–‡ä»¶åæ‰©å±•æˆ–è€…å•è¯åˆ†å‰²ï¼Œä½†æ˜¯ä¼šå‘ç”Ÿå‚æ•°æ‰©å±•å’Œå‘½ä»¤æ›¿æ¢ã€‚</p>
</li>
<li>
<p>æ”¯æŒå­—ç¬¦ä¸²çš„æ¨¡å¼åŒ¹é…ï¼ˆä½¿ç”¨=~æ“ä½œç¬¦æ—¶ç”šè‡³æ”¯æŒshellçš„æ­£åˆ™è¡¨è¾¾ å¼ï¼‰,å³è¾¹çš„å­—ç¬¦ä¸²ä¸åŠ åŒå¼•å·çš„æƒ…å†µ,å¯ä»¥æŠŠå³è¾¹ä½œä¸ºæ¨¡å¼. æ¯”å¦‚[[ hello == hell? ]]ï¼Œç»“æœä¸ºçœŸã€‚å½“ç„¶åŠ å¼•å·å°±æ˜¯æ–‡æœ¬å­—ç¬¦ä¸²æ¯”è¾ƒ.</p>
</li>
<li>
<p>ä½¿ç”¨[[ &hellip; ]]æ¡ä»¶åˆ¤æ–­ç»“æ„ï¼Œè€Œä¸æ˜¯[ &hellip; ]ï¼Œèƒ½å¤Ÿé˜²æ­¢è„šæœ¬ä¸­çš„è®¸å¤šé€»è¾‘é”™è¯¯ã€‚æ¯”å¦‚ï¼Œ&amp;&amp;ã€||ã€&lt;å’Œ&gt; æ“ä½œç¬¦èƒ½å¤Ÿæ­£å¸¸å­˜åœ¨äº[<input disabled="" type="checkbox"> ]æ¡ä»¶åˆ¤æ–­ç»“æ„ä¸­ï¼Œä½†æ˜¯å¦‚æœå‡ºç°åœ¨<input disabled="" type="checkbox"> ç»“æ„ä¸­çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚æ¯”å¦‚å¯ä»¥ç›´æ¥ä½¿ç”¨if [[ $a != 1 &amp;&amp; $a != 2 ]], å¦‚æœä¸é€‚ç”¨åŒæ‹¬å·, åˆ™ä¸ºif [ $a -ne 1] &amp;&amp; [ $a != 2 ]æˆ–è€…if [ $a -ne 1 -a $a != 2 ]ã€‚</p>
</li>
</ul>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=4> çº¯æ•°å­—æ¯”è¾ƒ </font>
</center>
<h3 id="-é€šè¿‡æ¯”è¾ƒasciiå€¼gtä»…èƒ½æ¯”è¾ƒæ•°å­—">&gt; é€šè¿‡æ¯”è¾ƒASCIIå€¼,gtä»…èƒ½æ¯”è¾ƒæ•°å­—</h3>
<pre><code>[root@dk-centos6 ~]# [ 2 \&gt; 1 ]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [ 2 -gt 1 ]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [[ 2 &gt; 1 ]]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [[ 2 -gt 1 ]]
[root@dk-centos6 ~]# echo $?
0
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=4> å­—ç¬¦ä¸²æ¯”è¾ƒ </font>
</center>
<h3 id="å•æ‹¬å·ä¸­å¦‚æœè¦æ¯”è¾ƒç¬¦å·---éœ€è¦è½¬ä¹‰-å¦åˆ™åˆ¤æ–­ç»“æœé”™è¯¯">å•æ‹¬å·ä¸­å¦‚æœè¦æ¯”è¾ƒç¬¦å· &ldquo;&lt;&rdquo; &ldquo;&gt;&rdquo;, éœ€è¦è½¬ä¹‰, å¦åˆ™åˆ¤æ–­ç»“æœé”™è¯¯</h3>
<pre><code>[root@dk-centos6 ~]# [ &quot;b&quot; &gt; &quot;a&quot; ]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [ &quot;b&quot; &lt; &quot;a&quot; ]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [ &quot;b&quot; \&lt; &quot;a&quot; ]
[root@dk-centos6 ~]# echo $?
1
</code></pre><h3 id="åŒæ‹¬å·ä¸ç”¨è½¬ä¹‰--ç›´æ¥æ‰§è¡Œå³å¯">åŒæ‹¬å·ä¸ç”¨è½¬ä¹‰ , ç›´æ¥æ‰§è¡Œå³å¯</h3>
<pre><code>[root@dk-centos6 ~]# [[ &quot;b&quot; &gt; &quot;a&quot; ]]
[root@dk-centos6 ~]# echo $?
0
[root@dk-centos6 ~]# [[ &quot;b&quot; &lt; &quot;a&quot; ]]
[root@dk-centos6 ~]# echo $?
1
</code></pre>]]></content>
		</item>
		
		<item>
			<title>æ”¶è—é“¾æ¥</title>
			<link>https://www.ngirl.xyz/posts/18-%E6%94%B6%E8%97%8F%E9%93%BE%E6%8E%A5/</link>
			<pubDate>Thu, 17 Oct 2019 11:19:42 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/18-%E6%94%B6%E8%97%8F%E9%93%BE%E6%8E%A5/</guid>
			<description>è®°å½•ä¸€äº›å¥½çš„ç½‘å€
 å®¹å™¨    äº‘åŸç”Ÿå›¾ä¹¦ç¼–å¹´å² äº‘åŸç”Ÿå¤§ä½¬åšå®¢æ±‡æ€» (2000ä¸ª) kubernetes ç¤¾ç¾¤åˆ†äº« QA æ±‡æ€» k8s CRD(CustomResourceDefinition)è‡ªå®šä¹‰controller sample k8s é›†ç¾¤éƒ¨ç½²è¿è¥å®è·µæ€»ç»“ k8s åˆ›å»ºä¸€ä¸ªåªè¯»çš„ç”¨æˆ·æƒé™ kubectl åˆ›å»º Pod èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ ç™½è¯Kubernetesç½‘ç»œ(æ¨è) å¼ é¦†é•¿dockerç§‘æ™® cgroupç›¸å…³  linux cgroups ç®€ä»‹ cgroupsä¸systemd     è®¡ç®—æœºåŸºç¡€    MySQL 5.6, 5.7, 8.0ç‰ˆæœ¬çš„æ–°ç‰¹æ€§å¤§å…¨ nginx+luaå®ç°ç°åº¦å‘å¸ƒ è®¡ç®—æœºç½‘ç»œ æ ¹åŸŸåçš„çŸ¥è¯† å¸¸è§çŠ¶æ€ç  ä½ ç®¡è¿™ç ´ç©æ„å« IO å¤šè·¯å¤ç”¨ï¼Ÿ   golang    goå­¦ä¹ æŒ‡å— goåœ£ç» go-modå­¦ä¹  goåŒ… goç›¸å…³æºç   ã€ŠGo è¯­è¨€ç¼–ç¨‹ä¹‹æ—…ï¼šä¸€èµ·ç”¨ Go åšé¡¹ç›®ã€‹ vue+go åˆ©ç”¨goä¼˜è¶Šçš„æ€§èƒ½-è®¾è®¡ä¸å®ç°é«˜æ€§èƒ½ä¼ä¸šçº§å¾®æœåŠ¡ç½‘å…³     å¸¸ç”¨çš„å·¥å…·ç½‘å€    ä¸ç”¨ç¿»å¢™å°±èƒ½è°·æ­Œ deepl æ¯”è°·æ­Œç¿»è¯‘å¥½ç”¨çš„ç¿»è¯‘ tableconvert åœ¨çº¿excelè½¬markdown processon å…è´¹åœ¨çº¿ä½œå›¾ è¡¨æƒ…é”… è‡ªåˆ¶è¡¨æƒ…åŠ¨å›¾ åœ¨çº¿è§£æ å­ç½‘æ©ç æ¢ç®—ç­‰   å…¶ä»–æ–‡ç«     Raft ä¸ºä»€ä¹ˆæ˜¯æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³• Raft ä¸€æ­¥æ­¥åŠ¨æ€æ•™ä½ ç†è§£raftåè®® Raft æ›´å¤šå½¢è±¡åŒ–ç†è§£ Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ(ä¸€)-èŠ‚ç‚¹ç¯‡   æƒ³çœ‹çš„ä¹¦ç±    é‡‘å­—å¡”åŸç†  </description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›å¥½çš„ç½‘å€</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å®¹å™¨ </font>
</center>
<ul>
<li><a href="https://jimmysong.io/cloud-native/memo/books/">äº‘åŸç”Ÿå›¾ä¹¦ç¼–å¹´å²</a></li>
<li><a href="https://zhangzw001.github.io/2019/10/12/13-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/">äº‘åŸç”Ÿå¤§ä½¬åšå®¢æ±‡æ€»</a></li>
<li><a href="https://muzi502.github.io/archives/kubernetes-QA.html">(2000ä¸ª) kubernetes ç¤¾ç¾¤åˆ†äº« QA æ±‡æ€»</a></li>
<li><a href="https://github.com/kubernetes/sample-controller/blob/master/README.md">k8s CRD(CustomResourceDefinition)è‡ªå®šä¹‰controller sample</a></li>
<li><a href="https://jeremy-xu.oschina.io/2019/11/kubernetes%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E8%BF%90%E8%90%A5%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/">k8s é›†ç¾¤éƒ¨ç½²è¿è¥å®è·µæ€»ç»“</a></li>
<li><a href="http://www.huilog.com/?p=1173">k8s åˆ›å»ºä¸€ä¸ªåªè¯»çš„ç”¨æˆ·æƒé™</a></li>
<li><a href="https://fuckcloudnative.io/posts/what-happens-when-k8s/">kubectl åˆ›å»º Pod èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="https://juejin.im/entry/599d33ad6fb9a0247804d430">ç™½è¯Kubernetesç½‘ç»œ(æ¨è)</a></li>
<li><a href="https://github.com/zhangguanzhang/docker-need-to-know/blob/master/SUMMARY.md">å¼ é¦†é•¿dockerç§‘æ™®</a></li>
<li>cgroupç›¸å…³
<ul>
<li><a href="https://www.cnblogs.com/sparkdev/p/8296063.html">linux cgroups ç®€ä»‹</a></li>
<li><a href="https://www.imooc.com/article/72502">cgroupsä¸systemd</a></li>
</ul>
</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> è®¡ç®—æœºåŸºç¡€ </font>
</center>
<ul>
<li><a href="https://www.linuxidc.com/Linux/2019-09/160664.htm">MySQL 5.6, 5.7, 8.0ç‰ˆæœ¬çš„æ–°ç‰¹æ€§å¤§å…¨</a></li>
<li><a href="https://i4t.com/4070.html">nginx+luaå®ç°ç°åº¦å‘å¸ƒ</a></li>
<li><a href="https://github.com/CavsZhouyou/Front-End-Interview-Notebook/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.md">è®¡ç®—æœºç½‘ç»œ</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2018/05/root-domain.html">æ ¹åŸŸåçš„çŸ¥è¯†</a></li>
<li><a href="https://developer.qiniu.com/fusion/kb/1425/the-http-status-code-books">å¸¸è§çŠ¶æ€ç </a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&amp;mid=2247494866&amp;idx=1&amp;sn=0ebeb60dbc1fd7f9473943df7ce5fd95&amp;chksm=c2c5967ff5b21f69030636334f6a5a7dc52c0f4de9b668f7bac15b2c1a2660ae533dd9878c7c&amp;mpshare=1&amp;scene=1&amp;srcid=0506xrEXVNFE1oPIS2kHcFnE&amp;sharer_sharetime=1620271084754&amp;sharer_shareid=b31dab34e7f27cf6c4fb08ebfbae0c21#rd">ä½ ç®¡è¿™ç ´ç©æ„å« IO å¤šè·¯å¤ç”¨ï¼Ÿ</a></li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> golang </font>
</center>
<ul>
<li><a href="https://www.zhihu.com/question/30461290">goå­¦ä¹ æŒ‡å—</a></li>
<li><a href="http://shouce.jb51.net/gopl-zh/">goåœ£ç»</a></li>
<li><a href="https://zhangguanzhang.github.io/2020/03/10/go-mod-base-use/">go-modå­¦ä¹ </a></li>
<li><a href="https://godoc.org/">goåŒ…</a></li>
<li>goç›¸å…³æºç 
<ul>
<li><a href="https://github.com/go-programming-tour-book">ã€ŠGo è¯­è¨€ç¼–ç¨‹ä¹‹æ—…ï¼šä¸€èµ·ç”¨ Go åšé¡¹ç›®ã€‹</a></li>
<li><a href="https://github.com/e421083458">vue+go åˆ©ç”¨goä¼˜è¶Šçš„æ€§èƒ½-è®¾è®¡ä¸å®ç°é«˜æ€§èƒ½ä¼ä¸šçº§å¾®æœåŠ¡ç½‘å…³</a></li>
</ul>
</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å¸¸ç”¨çš„å·¥å…·ç½‘å€ </font>
</center>
<ul>
<li><a href="https://google.fuckcloudnative.io/">ä¸ç”¨ç¿»å¢™å°±èƒ½è°·æ­Œ</a></li>
<li><a href="https://www.deepl.com/translator">deepl æ¯”è°·æ­Œç¿»è¯‘å¥½ç”¨çš„ç¿»è¯‘</a></li>
<li><a href="https://tableconvert.com/">tableconvert åœ¨çº¿excelè½¬markdown</a></li>
<li><a href="https://www.processon.com/;jsessionid=F837B3EA415204DD1285A90441329673.jvm1">processon å…è´¹åœ¨çº¿ä½œå›¾</a></li>
<li><a href="https://app.xuty.tk/static/app/index.html">è¡¨æƒ…é”… è‡ªåˆ¶è¡¨æƒ…åŠ¨å›¾</a></li>
<li><a href="https://www.sojson.com/convert/subnetmask.html">åœ¨çº¿è§£æ å­ç½‘æ©ç æ¢ç®—ç­‰</a></li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> å…¶ä»–æ–‡ç«  </font>
</center>
<ul>
<li><a href="https://www.cnblogs.com/mindwind/p/5231986.html">Raft ä¸ºä»€ä¹ˆæ˜¯æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•</a></li>
<li><a href="http://thesecretlivesofdata.com/raft/">Raft ä¸€æ­¥æ­¥åŠ¨æ€æ•™ä½ ç†è§£raftåè®®</a></li>
<li><a href="https://raft.github.io/">Raft æ›´å¤šå½¢è±¡åŒ–ç†è§£</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/34858035">Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ(ä¸€)-èŠ‚ç‚¹ç¯‡</a></li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> æƒ³çœ‹çš„ä¹¦ç± </font>
</center>
<ul>
<li><a href="https://book.douban.com/subject/4882120/">é‡‘å­—å¡”åŸç†</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>markdownä¸€äº›å†™æ³•è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/17-markdown%E4%B8%80%E4%BA%9B%E5%86%99%E6%B3%95%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Wed, 16 Oct 2019 15:56:27 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/17-markdown%E4%B8%80%E4%BA%9B%E5%86%99%E6%B3%95%E8%AE%B0%E5%BD%95/</guid>
			<description>&lt;p&gt;è®°å½•ä¸€äº›éœ€è¦æ³¨æ„çš„å†™æ³•,markdown æ˜¯æ”¯æŒhtmlè¯­æ³•çš„&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›éœ€è¦æ³¨æ„çš„å†™æ³•,markdown æ˜¯æ”¯æŒhtmlè¯­æ³•çš„</p>
<h3 id="è¿™é‡Œæƒ³å†™ä¸€ä¸ªå±…ä¸­çš„æ ‡é¢˜å’Œå›¾ç‰‡">è¿™é‡Œæƒ³å†™ä¸€ä¸ªå±…ä¸­çš„æ ‡é¢˜å’Œå›¾ç‰‡</h3>
<pre><code>&lt;center&gt;
&lt;img src=&quot;//zhangzw001.github.io/images/dockerniu.jpeg&quot; width = &quot;100&quot; height = &quot;100&quot; style=&quot;border: 0&quot;/&gt;
&lt;font color=&quot;blue&quot; face=&quot;é»‘ä½“&quot; size=5&gt; è¿™ä¸ªå°±æ˜¯æ•ˆæœå›¾å’¯ &lt;/font&gt;
&lt;/center&gt;
</code></pre><blockquote>
<p>æ•ˆæœ:</p>
</blockquote>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5> è¿™ä¸ªå°±æ˜¯æ•ˆæœå›¾å’¯ </font>
</center>
<h3 id="è¡¨æ ¼æ¨¡æ¿">è¡¨æ ¼æ¨¡æ¿</h3>
<pre><code>|æ ‡é¢˜|å†…å®¹|
|----|----|
|æ ‡é¢˜1|å†…å®¹1|
|æ ‡é¢˜2|å†…å®¹2|
</code></pre><blockquote>
<p>æ•ˆæœ:</p>
</blockquote>
<table>
<thead>
<tr>
<th>æ ‡é¢˜</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡é¢˜1</td>
<td>å†…å®¹1</td>
</tr>
<tr>
<td>æ ‡é¢˜2</td>
<td>å†…å®¹2</td>
</tr>
</tbody>
</table>]]></content>
		</item>
		
		<item>
			<title>Dockerfileä»‹ç»</title>
			<link>https://www.ngirl.xyz/posts/16-dockerfile%E4%BB%8B%E7%BB%8D/</link>
			<pubDate>Wed, 16 Oct 2019 15:33:17 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/16-dockerfile%E4%BB%8B%E7%BB%8D/</guid>
			<description>Dockerfile   æœ¬æ–‡æ‘˜å½•äº: å¦‚ä½•å¿«é€Ÿå°†å®¹å™¨äº‘é•œåƒå¤§å°ç²¾ç®€98%ï¼Ÿ
Dockerfile æ–‡ä»¶æœ‰è‡ªå·±çš„ä¹¦å†™æ ¼å¼å’Œæ”¯æŒçš„å‘½ä»¤ï¼Œå¸¸ç”¨çš„Dockerfile æŒ‡ä»¤æœ‰ï¼š  FROM æŒ‡å®šåŸºé•œåƒã€‚ MAINTAINER è®¾ç½®é•œåƒçš„ä½œè€…ä¿¡æ¯ï¼Œå¦‚ä½œè€…å§“åã€é‚®ç®±ç­‰ã€‚ COPY å°†æ–‡ä»¶ä»æœ¬åœ°å¤åˆ¶åˆ°é•œåƒï¼Œæ‹·è´å‰éœ€è¦ä¿è¯æœ¬åœ°æºæ–‡ä»¶å­˜åœ¨ã€‚ ADD ä¸ COPY ç±»ä¼¼ï¼Œå¤åˆ¶æ–‡ä»¶åˆ°é•œåƒã€‚ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ–‡ä»¶æ˜¯å½’æ¡£æ–‡ä»¶ï¼ˆtar, zip, tgz, xz ç­‰ï¼‰ï¼Œä¼šè¢«è‡ªåŠ¨è§£å‹ã€‚ ENV è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ ¼å¼: ENV key=valueæˆ–ENV key valueï¼Œè¿è¡Œå®¹å™¨åï¼Œå¯ç›´æ¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ã€‚ EXPOSE æš´éœ²å®¹å™¨ä¸­æŒ‡å®šçš„ç«¯å£ï¼Œåªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œä¸»è¦ç”¨æˆ·äº†è§£åº”ç”¨ç›‘å¬çš„ç«¯å£ã€‚ VOLUME æŒ‚è½½å·åˆ°å®¹å™¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¿å­˜é•œåƒæ—¶ä¸ä¼šä¿å­˜å·ä¸­çš„æ•°æ®ã€‚ WORKDIR è®¾ç½®å½“å‰å·¥ä½œç›®å½•ï¼Œåç»­å„å±‚çš„å½“å‰ç›®å½•éƒ½è¢«æŒ‡å®šã€‚ RUN åœ¨å®¹å™¨ä¸­è¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ã€‚ CMD å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚Dockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª CMD æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚CMD å¯ä»¥è¢« docker run ä¹‹åçš„å‚æ•°æ›¿æ¢ã€‚ ENTRYPOINT è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚Dockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª ENTRYPOINT æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚CMD æˆ– docker run ä¹‹åçš„å‚æ•°ä¼šè¢«å½“åšå‚æ•°ä¼ é€’ç»™ ENTRYPOINTï¼Œè¿™ä¸ªæ˜¯ä¸CMDçš„åŒºåˆ«ã€‚   å®¹å™¨çš„åŸç†   å®¹å™¨é•œåƒä¸­æœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯layersï¼Œå³é•œåƒå±‚ã€‚
 å®¹å™¨çš„åŸç†
 é•œåƒå±‚ä¾èµ–äºä¸€ç³»åˆ—çš„åº•å±‚æŠ€æœ¯ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿ(filesystems)ã€å†™æ—¶å¤åˆ¶(copy-on-write)ã€è”åˆæŒ‚è½½(union mounts)ç­‰æŠ€æœ¯ æŸ¥çœ‹Docker å®˜æ–¹æ–‡æ¡£https://docs.docker.com/storage/storagedriver/è¿›è¡Œå­¦ä¹ ã€‚</description>
			<content type="html"><![CDATA[<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=5> Dockerfile </font>
</center>
<!-- more -->
<p>æœ¬æ–‡æ‘˜å½•äº: <a href="https://mp.weixin.qq.com/s/LOXNMYtZbnYeDR2lBI56fw">å¦‚ä½•å¿«é€Ÿå°†å®¹å™¨äº‘é•œåƒå¤§å°ç²¾ç®€98%ï¼Ÿ</a></p>
<h3 id="dockerfile-æ–‡ä»¶æœ‰è‡ªå·±çš„ä¹¦å†™æ ¼å¼å’Œæ”¯æŒçš„å‘½ä»¤å¸¸ç”¨çš„dockerfile-æŒ‡ä»¤æœ‰">Dockerfile æ–‡ä»¶æœ‰è‡ªå·±çš„ä¹¦å†™æ ¼å¼å’Œæ”¯æŒçš„å‘½ä»¤ï¼Œå¸¸ç”¨çš„Dockerfile æŒ‡ä»¤æœ‰ï¼š</h3>
<ul>
<li>FROM  æŒ‡å®šåŸºé•œåƒã€‚</li>
<li>MAINTAINER  è®¾ç½®é•œåƒçš„ä½œè€…ä¿¡æ¯ï¼Œå¦‚ä½œè€…å§“åã€é‚®ç®±ç­‰ã€‚</li>
<li>COPY  å°†æ–‡ä»¶ä»æœ¬åœ°å¤åˆ¶åˆ°é•œåƒï¼Œæ‹·è´å‰éœ€è¦ä¿è¯æœ¬åœ°æºæ–‡ä»¶å­˜åœ¨ã€‚</li>
<li>ADD  ä¸ COPY ç±»ä¼¼ï¼Œå¤åˆ¶æ–‡ä»¶åˆ°é•œåƒã€‚ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ–‡ä»¶æ˜¯å½’æ¡£æ–‡ä»¶ï¼ˆtar, zip, tgz, xz ç­‰ï¼‰ï¼Œä¼šè¢«è‡ªåŠ¨è§£å‹ã€‚</li>
<li>ENV  è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ ¼å¼: ENV key=valueæˆ–ENV key valueï¼Œè¿è¡Œå®¹å™¨åï¼Œå¯ç›´æ¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ã€‚</li>
<li>EXPOSE  æš´éœ²å®¹å™¨ä¸­æŒ‡å®šçš„ç«¯å£ï¼Œåªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œä¸»è¦ç”¨æˆ·äº†è§£åº”ç”¨ç›‘å¬çš„ç«¯å£ã€‚</li>
<li>VOLUME  æŒ‚è½½å·åˆ°å®¹å™¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¿å­˜é•œåƒæ—¶ä¸ä¼šä¿å­˜å·ä¸­çš„æ•°æ®ã€‚</li>
<li>WORKDIR  è®¾ç½®å½“å‰å·¥ä½œç›®å½•ï¼Œåç»­å„å±‚çš„å½“å‰ç›®å½•éƒ½è¢«æŒ‡å®šã€‚</li>
<li>RUN  åœ¨å®¹å™¨ä¸­è¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ã€‚</li>
<li>CMD  å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚Dockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª CMD æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚CMD å¯ä»¥è¢« docker run ä¹‹åçš„å‚æ•°æ›¿æ¢ã€‚</li>
<li>ENTRYPOINT  è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚Dockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª ENTRYPOINT æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚CMD æˆ– docker run ä¹‹åçš„å‚æ•°ä¼šè¢«å½“åšå‚æ•°ä¼ é€’ç»™ ENTRYPOINTï¼Œè¿™ä¸ªæ˜¯ä¸CMDçš„åŒºåˆ«ã€‚</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=5> å®¹å™¨çš„åŸç† </font>
</center>
<p>å®¹å™¨é•œåƒä¸­æœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯layersï¼Œå³é•œåƒå±‚ã€‚</p>
<blockquote>
<p>å®¹å™¨çš„åŸç†</p>
</blockquote>
<p><img src="/images/16/%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8E%9F%E7%90%86-1.png" alt="å®¹å™¨çš„åŸç†"></p>
<p>é•œåƒå±‚ä¾èµ–äºä¸€ç³»åˆ—çš„åº•å±‚æŠ€æœ¯ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿ(filesystems)ã€å†™æ—¶å¤åˆ¶(copy-on-write)ã€è”åˆæŒ‚è½½(union mounts)ç­‰æŠ€æœ¯
æŸ¥çœ‹Docker å®˜æ–¹æ–‡æ¡£<a href="https://docs.docker.com/storage/storagedriver/">https://docs.docker.com/storage/storagedriver/</a>è¿›è¡Œå­¦ä¹ ã€‚</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font  face="é»‘ä½“" size=5> æ¯æ¡æŒ‡ä»¤éƒ½åˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼Œä¼šå¢åŠ é•œåƒçš„å¤§å° </font>
</center>
<h3 id="ä¸‹é¢çœ‹ä¸ªä¾‹å­">ä¸‹é¢çœ‹ä¸ªä¾‹å­</h3>
<p>è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ª1.2Mçš„é•œåƒ</p>
<pre><code>docker images|grep busybox
busybox                 latest              19485c79a9bb        5 weeks ago         1.22MB
</code></pre><p>æˆ‘ä»¬åŸºäºbusyboxå†™ä¸€ä¸ªDockerfileæ¥build</p>
<pre><code>#cat Dockerfile
from busybox:latest

run mkdir /tmp/dir \
    &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10

run rm -f /tmp/dir/file1

</code></pre><p>æ‰§è¡Œbuild</p>
<pre><code>docker build -t busybox-test .
Sending build context to Docker daemon  2.048kB
Step 1/3 : from busybox:latest
 ---&gt; 19485c79a9bb
Step 2/3 : run mkdir /tmp/dir     &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10
 ---&gt; Running in 0426f92c77ed
10+0 records in
10+0 records out
10485760 bytes (10.0MB) copied, 0.003785 seconds, 2.6GB/s
Removing intermediate container 0426f92c77ed
 ---&gt; 5ec75db090c9
Step 3/3 : run rm -f /tmp/dir/file1
 ---&gt; Running in 540e7d0a5aea
Removing intermediate container 540e7d0a5aea
 ---&gt; 00041489cc0e
Successfully built 00041489cc0e
Successfully tagged busybox-test:latest
</code></pre><p>æŸ¥çœ‹imageå¤§å°</p>
<pre><code>docker images|grep busybox
busybox-test            latest              00041489cc0e        10 minutes ago      11.7MB
busybox                 latest              19485c79a9bb        5 weeks ago         1.22MB
</code></pre><p>??? æˆ‘ä¸æ˜¯rmåˆ é™¤äº†åˆ›å»ºçš„/tmp/dir/file1 æ–‡ä»¶å—? éš¾é“å®ƒè¿˜åœ¨? æ¥,æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹</p>
<pre><code># æŸ¥çœ‹ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶
docker run -ti busybox-test ls /tmp/dir
</code></pre><p>ç»“æœæ˜¾ç„¶æ˜¯ç©º&hellip;</p>
<p>å–”,,, å› ä¸º&quot;åœ¨Dockerfileä¸­ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼Œç»§è€Œä¼šå¢åŠ é•œåƒæ•´ä½“çš„å¤§å°&quot;, åœ¨çœ‹æˆ‘ä»¬å†™çš„Dockerfile,
æˆ‘ä»¬ç¬¬ä¸€ä¸ªrun æ‰§è¡Œçš„æ—¶å€™, è¿™é‡Œå‡è£…å« (run1å±‚), æˆ‘ä»¬ç”Ÿæˆäº†file1æ–‡ä»¶
å½“æ‰§è¡Œç¬¬äºŒä¸ªrunçš„æ—¶å€™, æˆ‘ä»¬å¤„åœ¨äº† (run2å±‚), (run1å±‚)å·²ç»æ˜¯çˆ¶å±‚,æ˜¯ä¸ªåªè¯»å±‚äº†,åªæœ‰å½“å‰å±‚å¯å†™, è™½ç„¶æˆ‘ä»¬åœ¨ (run2å±‚)åˆ é™¤äº†è¿™ä¸ªæ–‡ä»¶,ä½†åˆ é™¤çš„ä»…ä»…æ˜¯ä»½æ‹·è´è€Œå·², è¿™å°±æ˜¯å†™æ—¶å¤åˆ¶.</p>
<p>æ‰€ä»¥ä»¥ä¸Šçš„ä¼˜åŒ–åº”è¯¥æ˜¯: å†™æˆä¸€æ¡run</p>
<pre><code>#cat Dockerfile
from busybox:latest

run mkdir /tmp/dir \
    &amp;&amp; dd if=/dev/zero of=/tmp/dir/file1 bs=1M count=10 \
    &amp;&amp; rm -f /tmp/dir/file1

# build
docker build -t busybox-test2 .
</code></pre><p>ç»“æœæ˜¾ç„¶</p>
<pre><code>docker images|grep busybox
busybox-test2           latest              faf8b7d4f140        3 seconds ago       1.22MB
busybox-test            latest              00041489cc0e        10 minutes ago      11.7MB
busybox                 latest              19485c79a9bb        5 weeks ago         1.22MB
</code></pre><p>è™½ç„¶è¯´è¿™é‡Œçš„æµ‹è¯•æ²¡æœ‰å¹²ä»»ä½•äº‹æƒ…, ä½†æˆ‘ä»¬åœ¨å†™Dockerfileçš„æ—¶å€™éœ€è¦æ³¨æ„, ä¸¤ä¸ªrunä¹‹é—´æ˜¯ä¸¤ä¸ªä¸åŒçš„ å¯å†™å±‚!</p>
<p>ç®€å•æ€»ç»“ç²¾ç®€é•œåƒå¤§å°çš„æ–¹æ³•:</p>
<pre><code>1 ä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒ,æ³¨æ„ä¸€äº›å¾ˆå°çš„é•œåƒå¯èƒ½ç¼ºå°‘å¾ˆå¤šä¾èµ–åº“,ä¾‹å¦‚æŸ¥çœ‹redisä¾èµ–åº“ ldd /usr/bin/redis-cli
2 åˆå¹¶DockerfilecæŒ‡ä»¤ç²¾ç®€(å¯ä»¥çš„è¯å†™æˆä¸€æ¡run)
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font face="é»‘ä½“" size=5> ä¸€äº›å°çš„é•œåƒ </font>
</center>
<ul>
<li>
<p>1 scratch: ä¸€ä¸ªç©ºçš„é•œåƒ, æ— æ³•pull -.-!!! , å†™åœ¨Dockerfileæ˜¯å¯ä»¥çš„</p>
</li>
<li>
<p>2 alpine: 5Mçš„linuxé•œåƒ,æœ‰åŒ…ç®¡ç†å·¥å…·apk</p>
</li>
</ul>
<pre><code>FROM scratch
ADD alpine-minirootfs-3.10.2-x86_64.tar.gz /
CMD [&quot;/bin/sh&quot;]
</code></pre><ul>
<li>3 busybox: 1Må¤šçš„é•œåƒ,ç§°ä¸ºåµŒå…¥å¼linuxçš„ç‘å£«å†›åˆ€, Linuxå’Œunixä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</li>
</ul>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font face="é»‘ä½“" size=5> æ³¨æ„äº‹é¡¹ </font>
</center>
<ol>
<li>é•œåƒæ„å»ºçš„é¡ºåºä¼šå½±å“ç¼“å­˜çš„æœ‰æ•ˆæ€§,ç»å¸¸ä¿®æ”¹çš„å†…å®¹åº”è¯¥æ”¾åˆ°æœ€å</li>
<li>å°½å¯èƒ½çš„å†™åˆ°åŒä¸€ä¸ªRUN,åˆ é™¤ä¸å¿…è¦çš„ä¾‹å¤– &ndash;no-install-recommends, å¹¶ä¸”è®°å¾—åˆ é™¤åŒ…ç®¡ç†ç¼“å­˜ rm -rf /var/lib/apt/lists/*</li>
<li>å¤šé˜¶æ®µæ„å»ºçš„ä½¿ç”¨</li>
</ol>
<pre><code>from maven:3.6-jdk-8-alpine as mavencache
workdir /opt
copy pom.xml .
run mvn -e -B xx:xx
copy src ./src
run mvn -e -B xx

from openjdk:8-jdk-alpine
copy --from-mavencache /opt/target/xxx.jar /
cmd [&quot;java&quot;, &quot;-jar&quot;, &quot;/xxx.jar&quot;]
</code></pre><h3 id="dockerfileä¸­æ·»åŠ ä¸­æ–‡æ”¯æŒ">dockerfileä¸­æ·»åŠ ä¸­æ–‡æ”¯æŒ</h3>
<ul>
<li>debian8</li>
</ul>
<pre><code>from php:7.0.13-fpm

run apt-get update \
    &amp;&amp; apt-get install locales \
    &amp;&amp; sed -i '/zh_CN.UTF-8/s/^#//' /etc/locale.gen \
    &amp;&amp; locale-gen \
    &amp;&amp; rm -rf /usr/local/src/* \
    &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; apt-get purge -y --auto-remove $buildDeps

ENV LANG zh_CN.UTF-8

user www-data

CMD [ &quot;/bin/bash&quot;, &quot;-ce&quot;, &quot;tail -f /dev/stdout&quot; ]
</code></pre><ul>
<li>Ubuntu 18.04.1 LTS</li>
</ul>
<pre><code>RUN apt-get update \
    &amp;&amp; apt-get install language-pack-zh-hans -y \
    &amp;&amp; rm -rf /usr/local/src/* \
    &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; apt-get purge -y --auto-remove $buildDeps

ENV LANG zh_CN.utf8
</code></pre>]]></content>
		</item>
		
		<item>
			<title>dockerç®€ä»‹å’Œä½¿ç”¨</title>
			<link>https://www.ngirl.xyz/posts/15-docker%E7%AE%80%E4%BB%8B%E5%92%8C%E4%BD%BF%E7%94%A8/</link>
			<pubDate>Wed, 16 Oct 2019 15:31:08 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/15-docker%E7%AE%80%E4%BB%8B%E5%92%8C%E4%BD%BF%E7%94%A8/</guid>
			<description>ç®€å•ä»‹ç»docker
docker k8sæ”¯æŒçš„docker ç‰ˆæœ¬æŸ¥çœ‹ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¹´ä»½å‘½åç‰ˆæœ¬çš„docker-ceï¼Œå‡è®¾æˆ‘ä»¬è¦å®‰è£…v1.16.3çš„k8sï¼Œæˆ‘ä»¬å» https://github.com/kubernetes/kubernetes é‡Œè¿›å¯¹åº”ç‰ˆæœ¬çš„CHANGELOG-1.16.mdé‡ŒæœThe list of validated docker versions remainæŸ¥æ‰¾æ”¯æŒçš„dockerç‰ˆæœ¬ï¼Œdockerç‰ˆæœ¬ä¸ä¸€å®šå¾—åœ¨æ”¯æŒåˆ—è¡¨é‡Œï¼Œå®é™…ä¸Š19.03ä¹Ÿèƒ½ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨dockerå®˜æ–¹çš„å®‰è£…è„šæœ¬å®‰è£…docker(è¯¥è„šæœ¬æ”¯æŒcentoså’Œubuntu)
export VERSION=19.03 curl -fsSL &amp;quot;https://get.docker.com/&amp;quot; | bash -s -- --mirror Aliyun </description>
			<content type="html"><![CDATA[<p>ç®€å•ä»‹ç»docker</p>
<!-- more -->
<h3 id="docker">docker</h3>
<h3 id="k8sæ”¯æŒçš„docker-ç‰ˆæœ¬æŸ¥çœ‹">k8sæ”¯æŒçš„docker ç‰ˆæœ¬æŸ¥çœ‹</h3>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¹´ä»½å‘½åç‰ˆæœ¬çš„docker-ceï¼Œå‡è®¾æˆ‘ä»¬è¦å®‰è£…v1.16.3çš„k8sï¼Œæˆ‘ä»¬å» <a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a> é‡Œè¿›å¯¹åº”ç‰ˆæœ¬çš„<code>CHANGELOG-1.16.md</code>é‡Œæœ<code>The list of validated docker versions remain</code>æŸ¥æ‰¾æ”¯æŒçš„dockerç‰ˆæœ¬ï¼Œdockerç‰ˆæœ¬ä¸ä¸€å®šå¾—åœ¨æ”¯æŒåˆ—è¡¨é‡Œï¼Œå®é™…ä¸Š19.03ä¹Ÿèƒ½ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨dockerå®˜æ–¹çš„å®‰è£…è„šæœ¬å®‰è£…docker(è¯¥è„šæœ¬æ”¯æŒcentoså’Œubuntu)</p>
<pre><code>export VERSION=19.03
curl -fsSL &quot;https://get.docker.com/&quot; | bash -s -- --mirror Aliyun

</code></pre>]]></content>
		</item>
		
		<item>
			<title>mysql5.5ç›®å½•copyæ–¹å¼è¿ç§»</title>
			<link>https://www.ngirl.xyz/posts/14-mysql%E7%9B%AE%E5%BD%95copy%E6%96%B9%E5%BC%8F%E8%BF%81%E7%A7%BB/</link>
			<pubDate>Tue, 15 Oct 2019 10:44:27 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/14-mysql%E7%9B%AE%E5%BD%95copy%E6%96%B9%E5%BC%8F%E8%BF%81%E7%A7%BB/</guid>
			<description>&lt;p&gt;ä»ç°æœ‰çš„ä¸€å° ä»åº“ å…¨copy dataç›®å½•åˆ°2å°æ–°æœºå™¨ä¸Š, å†é…ç½®mysqlä¸»ä»&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>ä»ç°æœ‰çš„ä¸€å° ä»åº“ å…¨copy dataç›®å½•åˆ°2å°æ–°æœºå™¨ä¸Š, å†é…ç½®mysqlä¸»ä»</p>
<h3 id="ç›®å½•copyæ–¹å¼è¿ç§»">ç›®å½•copyæ–¹å¼è¿ç§»</h3>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<ul>
<li>ä¸è¦åˆ é™¤ibdata1,ä¼šå¯¼è‡´innodbè¡¨ä¸å­˜åœ¨</li>
<li>å¯ä»¥ä¸åˆ é™¤ib_logfile0,ib_logfile1, ä½†my.cnfé…ç½®å¤§å°ä¸€è‡´</li>
<li>åŒºåˆ«ç›®å½•æƒé™ä¸ºmysql,tmpç›®å½•å­˜åœ¨</li>
<li>è¯·è‡ªè¡Œå®‰è£…å¥½mysql5.5</li>
</ul>
<pre><code>1 é¦–å…ˆåœæ­¢mysql
/etc/init.d/mysqld stop

2 åŒæ­¥æ•°æ®ç›®å½•åˆ°æ–°æœºå™¨
/data/u01

3 ç¡®è®¤æ–°æœºå™¨ä¸Šmysqlç‰ˆæœ¬å¹¶é…ç½®/etc/my.cof
4 å®Œæ•´è¿ç§»æ—¶ä¸éœ€è¦åˆ é™¤å†…å®¹(innodb_log_file_size = 256M é…ç½®è¦ä¸€è‡´)
5 å¯åŠ¨mysql

</code></pre><h3 id="é…ç½®ä¸»ä»">é…ç½®ä¸»ä»</h3>
<ul>
<li>
<p>1 é¦–å…ˆ ç›®å½•copyæ–¹å¼ åŒæ­¥æŸä¸ªä»åº“åˆ°2å°æ–°æœºå™¨å¹¶å¯åŠ¨å®Œæˆ, æ­¤æ—¶ä¸¤ä¸ªmysqléƒ½å¼€å¯äº†slave</p>
</li>
<li>
<p>2 æš‚åœåŒæ­¥ï¼Œå¹¶è®¾ç½®è¯»å†™ï¼›</p>
</li>
</ul>
<pre><code>stop slave;
# è¯¥æ‰§è¡Œä»…ä¸»åº“ä¸Šæ‰§è¡Œ(é…ç½®å¯å†™)
SET GLOBAL read_only=0;
reset slave all;
-- RESET SLAVE ALLæ˜¯æ¸…é™¤ä»åº“çš„åŒæ­¥å¤åˆ¶ä¿¡æ¯ã€åŒ…æ‹¬è¿æ¥ä¿¡æ¯å’ŒäºŒè¿›åˆ¶æ–‡ä»¶åã€ä½ç½®
-- ä»åº“ä¸Šæ‰§è¡Œè¿™ä¸ªå‘½ä»¤åï¼Œä½¿ç”¨show slave statuså°†ä¸ä¼šæœ‰è¾“å‡ºã€‚
</code></pre><ul>
<li>3 2å°æ–°çš„mysqlä¸­ä¿®æ”¹ä»åº“slaveé…ç½®, è¿æ¥åˆ°æ–°çš„ä¸»åº“åœ°å€(æˆ‘è¿™é‡Œé€šè¿‡åŸŸåè§£æ)</li>
</ul>
<pre><code>CHANGE MASTER TO 
MASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88;
</code></pre><ul>
<li>4 ç”±äºæœ¬æœºéœ€è¦å®‰è£…mysql5.5å’Œmysql5.7æ‰€ä»¥æ³¨æ„ä¸€ä¸‹</li>
</ul>
<pre><code># åˆå§‹åŒ–æŒ‡å®šé…ç½®æ–‡ä»¶
/usr/local/mysql57/bin/mysqld --defaults-file=/etc/my57.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql57 --datadir=/data/u001

# ä¿®æ”¹/etc/init.d/mysqld57
parse_server_arguments `$print_defaults -c /etc/my57.cnf mysqld server mysql_server mysql.server`
$bindir/mysqld_safe --defaults-file=/etc/my57.cnf --pid-file=&quot;$mysqld_pid_file_path&quot; $other_args &gt;/dev/null &amp;
</code></pre><h3 id="æŠ¥é”™ç»Ÿè®¡">æŠ¥é”™ç»Ÿè®¡</h3>
<ul>
<li>ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</li>
</ul>
<pre><code>æ‰§è¡Œreset master; 
</code></pre><ul>
<li>The MySQL server is running with the&ndash;read-only option so it cannot execute this statement</li>
</ul>
<pre><code>æ‰§è¡Œ set global read_only=0;
</code></pre>]]></content>
		</item>
		
		<item>
			<title>äº‘åŸç”Ÿåšå®¢æ±‡æ€»</title>
			<link>https://www.ngirl.xyz/posts/13-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/</link>
			<pubDate>Sat, 12 Oct 2019 16:35:21 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/13-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/</guid>
			<description>&lt;p&gt;è®°å½•ä¸€äº›äº‘åŸç”ŸæŠ€æœ¯åšå®¢&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›äº‘åŸç”ŸæŠ€æœ¯åšå®¢</p>
<h3 id="æ¥è‡ªservicemesher8-ç¾¤">æ¥è‡ªServiceMesher[8] ç¾¤</h3>
<p><a href="https://k2r2bai.com/">KaiRen&rsquo;s Blog</a></p>
<p><a href="https://ieevee.com/">Zlatan Eevee</a></p>
<p><a href="https://hansedong.github.io/">å›½å—ä¹‹å¢ƒ</a></p>
<p><a href="http://gaocegege.com/Blog/">åšå®¢ | é«˜ç­–</a></p>
<p><a href="https://kkc.github.io/">Kakashi&rsquo;s Blog</a></p>
<p><a href="https://blog.yaodataking.com/">Alex Wu&rsquo;s blog | THINK BIG, START SMALL, DELIVER VALUE TO THE BUSINESS</a></p>
<p><a href="https://nicksors.cc/">å¼€å…ƒDevOpsçŸ¥è¯†åº“ - çŸ¥è¯†ç®¡ç†ï¼Œæ—¶é—´ç®¡ç†ï¼Œè‡ªæˆ‘ç®¡ç†</a></p>
<p><a href="https://xuchao918.github.io/">èµ·é£äº†</a></p>
<p><a href="https://maiyang.me/">èŒ¶æ­‡é©¿ç«™ - Gopher, OpenSource Fans, æˆé•¿ä¹‹è·¯æœ‰æˆ‘ç›¸ä¼´ã€‚</a></p>
<p><a href="https://docs.lvrui.io/">Polar Snow Documentation</a></p>
<p><a href="https://www.yangcs.net/">äº‘åŸç”Ÿå®éªŒå®¤ - ç±³å¼€æœ—åŸºæ¨çš„åšå®¢</a></p>
<p><a href="https://jimmysong.io/">Jimmy Song - å®‹å‡€è¶…çš„åšå®¢|Cloud Native|äº‘åŸç”Ÿå¸ƒé“å¸ˆ</a></p>
<p><a href="https://mritd.me/">æ¼ ç„¶çš„åšå®¢ | mritd Blog</a></p>
<p><a href="http://www.rhca.me/">DevOps â€“ æˆé•¿ä¹‹è·¯</a></p>
<p><a href="https://birdben.github.io/">birdben</a></p>
<p><a href="https://fs.tn/">æµ®ç”Ÿè‹¥æ¢¦</a></p>
<p><a href="https://landscape.cncf.io/">CNCF Cloud Native Interactive Landscape</a></p>
<p><a href="https://www.duyidong.com/">æœå±¹ä¸œçš„åšå®¢ | å­¦æ— æ­¢å¢ƒ</a></p>
<p><a href="https://blog.ihypo.net/index.html">æ¢¦æ—­éšæƒ³</a></p>
<p><a href="http://www.yangguanjun.com/">ictfox blog</a></p>
<p><a href="http://team.jiunile.com/">CloudNative æ¶æ„</a></p>
<p><a href="https://www.bladewan.com/">æˆ‘çˆ±è¥¿çº¢æŸ¿</a></p>
<p><a href="https://notes.doublemine.me/">Doublemine</a></p>
<p><a href="https://bingohuang.com/">Bingo Huang</a></p>
<p><a href="http://chunqi.li/">Arthur Chunqi Li&rsquo;s Blog</a></p>
<p><a href="http://chunqi.li/archives/">Archive | Arthur Chunqi Li&rsquo;s Blog</a></p>
<p><a href="https://www.lijiaocn.com/">ITæŠ€æœ¯å·¥ä½œå­¦ä¹ æŠ˜è…¾ç¬”è®° æä½¶æ¾³çš„åšå®¢</a></p>
<p><a href="http://moheqionglin.com/site/blogs/1/list.html">å¢¨è·ç¼æ—å®˜ç½‘-ç¼–ç¨‹æ—¥å¿—</a></p>
<p><a href="https://cmgs.me/archive">Archive - Nolla</a></p>
<p><a href="https://tomoyadeng.github.io/blog/">Tomoya&rsquo;s Blog</a></p>
<p><a href="https://youendless.com/">å›æ— æ­¢å¢ƒ</a></p>
<p><a href="https://jaminzhang.github.io/">Jamin Zhang</a></p>
<p><a href="https://imroc.io/">roc - imroc.io|rocçš„åšå®¢|Cloud Native|Kubernetes|Go|Golang</a></p>
<p><a href="https://sysdig.com/blog/">Blog | Sysdig</a></p>
<p><a href="https://sleele.com/">sleeleçš„åšå®¢</a></p>
<p><a href="https://www.tauceti.blog/">TauCeti blog Â· TauCeti blog</a></p>
<p><a href="http://ghoulich.xninja.org/">æ°´æ™¶å‘½åŒ£ | ç”Ÿå‘½åœ¨äºæŠ˜è…¾ï¼ŒæŠ˜è…¾ä¸‡å²ï¼</a></p>
<p><a href="https://soulteary.com/">è‹æ´‹åšå®¢</a></p>
<p><a href="https://linuxtoy.org/">LinuxTOY</a></p>
<p><a href="https://www.infvie.com/">Infvie&rsquo;s Blog | è¿ç»´SREç¤¾åŒºåšå®¢</a></p>
<p><a href="https://zhangchenchen.github.io/">Solar</a></p>
<p><a href="https://moelove.info/">MoeLove</a></p>
<p><a href="https://www.hwchiu.com/">Hwchiu Learning Notekubernetes/SDN/DevOps</a></p>
<p><a href="http://www.yangguanjun.com">å­˜å‚¨é¢†åŸŸ yangguanjun</a></p>]]></content>
		</item>
		
		<item>
			<title>awkç®€å•è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/12-awk%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Fri, 11 Oct 2019 15:23:48 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/12-awk%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</guid>
			<description>è®°å½•ä¸€äº›ç®€å•ä½¿ç”¨
å®ä¾‹1: è®¡ç®—nginxæ—¥å¿—ä¸­æŸä¸ªæ¥å£çš„æ¬¡æ•°å’Œå¹³å‡å“åº”æ—¶é—´ ä¾‹å¦‚æˆ‘çš„a.txt nginxæ—¥å¿—æ ¼å¼å¦‚ä¸‹ a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] &amp;quot;GET /v1/actionname?xxxx HTTP/1.1&amp;quot; 200 386 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36&amp;quot; &amp;quot;-&amp;quot; &amp;quot;0.023&amp;quot; a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] &amp;quot;GET /v1/actionname2?xxxx HTTP/1.1&amp;quot; 200 386 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36&amp;quot; &amp;quot;-&amp;quot; &amp;quot;0.016&amp;quot;  è¿™é‡Œæˆ‘åªæƒ³å–å‡ºæ¥å£å: /v1/actionname å’Œ 0.023 å“åº”æ—¶é—´
 é¦–å…ˆæˆ‘å–å‡ºè¿™ä¸¤åˆ— cat a.txt|awk -F &#39;&amp;quot;&#39; &#39;{print $(NF-1),$2}&#39;|awk -F &#39;?</description>
			<content type="html"><![CDATA[<p>è®°å½•ä¸€äº›ç®€å•ä½¿ç”¨</p>
<!-- more -->
<h3 id="å®ä¾‹1-è®¡ç®—nginxæ—¥å¿—ä¸­æŸä¸ªæ¥å£çš„æ¬¡æ•°å’Œå¹³å‡å“åº”æ—¶é—´">å®ä¾‹1: è®¡ç®—nginxæ—¥å¿—ä¸­æŸä¸ªæ¥å£çš„æ¬¡æ•°å’Œå¹³å‡å“åº”æ—¶é—´</h3>
<h4 id="ä¾‹å¦‚æˆ‘çš„atxt-nginxæ—¥å¿—æ ¼å¼å¦‚ä¸‹">ä¾‹å¦‚æˆ‘çš„a.txt nginxæ—¥å¿—æ ¼å¼å¦‚ä¸‹</h4>
<pre><code>a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] &quot;GET /v1/actionname?xxxx HTTP/1.1&quot; 200 386 &quot;-&quot; &quot;Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36&quot; &quot;-&quot; &quot;0.023&quot;
a.b.com 1.1.1.1 [08/Sep/2019:23:57:01 +0800] &quot;GET /v1/actionname2?xxxx HTTP/1.1&quot; 200 386 &quot;-&quot; &quot;Mozilla/5.0 (Linux; Android 9; V1831A Build/P00610; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/68.0.3440.91 Mobile Safari/537.36&quot; &quot;-&quot; &quot;0.016&quot;
</code></pre><blockquote>
<p>è¿™é‡Œæˆ‘åªæƒ³å–å‡ºæ¥å£å: /v1/actionname å’Œ 0.023 å“åº”æ—¶é—´</p>
</blockquote>
<h4 id="é¦–å…ˆæˆ‘å–å‡ºè¿™ä¸¤åˆ—">é¦–å…ˆæˆ‘å–å‡ºè¿™ä¸¤åˆ—</h4>
<pre><code>cat a.txt|awk -F '&quot;' '{print $(NF-1),$2}'|awk -F '?' '{print $1}'|awk '{print $1&quot; &quot;$3}' &gt; b.txt


cat b.txt
0.023 /v1/actionname
0.016 /v1/actionname2
...
</code></pre><h4 id="å‘½ä»¤è¯¦è§£">å‘½ä»¤è¯¦è§£</h4>
<pre><code>&gt; ç¬¬ä¸€æ­¥ å“åº”æ—¶é—´æ±‚å’Œ
{s[$2]+=$1}: æ¯é‡åˆ°ä¸€ä¸ª$2,æ¯”å¦‚é‡åˆ°/v1/actionname,è®°å½•ä¸€ä¸ªæ•°ç»„s[/v1/actionname] = æ‰€æœ‰$1çš„å€¼çš„æ€»å’Œ
&gt; ç¬¬äºŒæ­¥ ç®—æ¥å£çš„æ¬¡æ•°
{m[$2]++}:  æ¯é‡åˆ°ä¸€ä¸ª$2,æ¯”å¦‚é‡åˆ°/v1/actionname,è®°å½•ä¸€ä¸ªæ•°ç»„m[/v1/actionname] = æ‰€æœ‰$1çš„ä¸ªæ•°
&gt; ç¬¬ä¸‰æ­¥ å–å¹³å‡å€¼

# è¿™é‡Œè¾“å‡ºcsvæ–‡ä»¶
cat b.txt|awk '{m[$2]++} {s[$2]+=$1} ; END {for(i in m) {print s[i]/m[i] &quot;,&quot; m[i] &quot;,&quot; i}}'|awk -F &quot;,&quot; '$2 &gt; 20'|sort -k2nr &gt; test.csv
</code></pre><h4 id="ä¾‹å¦‚è®¡ç®—æ€»å“åº”æ—¶é—´æ€»æ•°å¹³å‡å€¼">ä¾‹å¦‚è®¡ç®—æ€»å“åº”æ—¶é—´,æ€»æ•°,å¹³å‡å€¼</h4>
<pre><code># è¿™é‡Œ$17 æ˜¯æ¥å£å : /v4.5/?xxx , $4 æ˜¯å“åº”æ—¶é—´ 
# æ¯é‡åˆ°ä¸€ä¸ª$17, å°±æŠŠ$4å“åº”æ—¶é—´ç´¯åŠ å­˜åˆ° sä¸­,  så¯èƒ½æ˜¯ s[&quot;/v4.5/?xxx&quot;]=4.75, s[&quot;/v3.8/?xxx&quot;]=1.469
# åŒç†mä¸€æ ·,  m[&quot;/v4.5/?xxx&quot;]=313, m[&quot;/v3.8/?xxx&quot;]=64

tail -1000 openapi.access.log |awk '{s[$17]+=$4} {m[$17]++} END {for(i in s) {print m[i],&quot;\t&quot;,s[i],&quot;\t&quot;,s[i]/m[i],&quot;\t&quot;,i} }'|sort -k1nr|head -10

313   4.75   0.0151757   /v4.5/?xxx
64   1.469   0.0229531   /v3.8/?xxx
</code></pre>]]></content>
		</item>
		
		<item>
			<title>mysqlç®€å•è®°å½•</title>
			<link>https://www.ngirl.xyz/posts/11-mysql%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Thu, 10 Oct 2019 10:40:20 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/11-mysql%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/</guid>
			<description>ç®€å•è®°å½•ä¸€äº›mysqlçŸ¥è¯†ç‚¹
  ### ä¸‰å¤§èŒƒå¼ - åˆ—ä¸å¯å†åˆ†: æœåŠ¡å,æœåŠ¡æè¿° - å±æ€§å®Œå…¨ä¾èµ–ä¸»é”®:	æœåŠ¡åä¾èµ–äºæœåŠ¡ID - å±æ€§ç›´æ¥ä¾èµ–ä¸»é”®: HTTP,TCP,GRPC è§„åˆ™å„ä¸ºä¸€å¼ è¡¨   SQL è¯­å¥ä¸»è¦å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªç±»åˆ« DDLï¼ˆData Definition Languagesï¼‰è¯­å¥ï¼šæ•°æ®å®šä¹‰è¯­è¨€ï¼Œè¿™äº›è¯­å¥å®šä¹‰äº†ä¸åŒçš„æ•°æ®æ®µã€æ•°æ®åº“ã€è¡¨ã€åˆ—ã€ç´¢å¼•ç­‰æ•°æ®åº“å¯¹è±¡çš„å®šä¹‰ã€‚å¸¸ç”¨çš„è¯­å¥å…³é”®å­—ä¸»è¦åŒ…æ‹¬ createã€dropã€alterç­‰ã€‚ DMLï¼ˆData Manipulation Languageï¼‰è¯­å¥ï¼šæ•°æ®æ“çºµè¯­å¥ï¼Œç”¨äºæ·»åŠ ã€åˆ é™¤ã€æ›´æ–°å’ŒæŸ¥è¯¢æ•°æ®åº“è®°å½•ï¼Œå¹¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼Œå¸¸ç”¨çš„è¯­å¥å…³é”®å­—ä¸»è¦åŒ…æ‹¬ insertã€deleteã€udpate å’Œselect ç­‰ã€‚(å¢æ·»æ”¹æŸ¥ï¼‰ DCLï¼ˆData Control Languageï¼‰è¯­å¥ï¼šæ•°æ®æ§åˆ¶è¯­å¥ï¼Œç”¨äºæ§åˆ¶ä¸åŒæ•°æ®æ®µç›´æ¥çš„è®¸å¯å’Œè®¿é—®çº§åˆ«çš„è¯­å¥ã€‚è¿™äº›è¯­å¥å®šä¹‰äº†æ•°æ®åº“ã€è¡¨ã€å­—æ®µã€ç”¨æˆ·çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ã€‚ä¸»è¦çš„è¯­å¥å…³é”®å­—åŒ…æ‹¬ grantã€revoke ç­‰ã€‚   æ¸…ç©ºè¡¨ åˆ é™¤è¡¨ä¿¡æ¯çš„æ–¹å¼æœ‰ä¸¤ç§ : truncate table table_name; delete * from table_name; æ³¨ : truncateæ“ä½œä¸­çš„tableå¯ä»¥çœç•¥ï¼Œdeleteæ“ä½œä¸­çš„*å¯ä»¥çœç•¥ truncateã€delete æ¸…ç©ºè¡¨æ•°æ®çš„åŒºåˆ« : 1&amp;gt; truncate æ˜¯æ•´ä½“åˆ é™¤ (é€Ÿåº¦è¾ƒå¿«)ï¼Œdeleteæ˜¯é€æ¡åˆ é™¤ (é€Ÿåº¦è¾ƒæ…¢) 2&amp;gt; truncate ä¸å†™æœåŠ¡å™¨ logï¼Œdelete å†™æœåŠ¡å™¨ logï¼Œä¹Ÿå°±æ˜¯ truncate æ•ˆç‡æ¯” deleteé«˜çš„åŸå›  3&amp;gt; truncate ä¸æ¿€æ´»trigger (è§¦å‘å™¨)ï¼Œä½†æ˜¯ä¼šé‡ç½®Identity (æ ‡è¯†åˆ—ã€è‡ªå¢å­—æ®µ)ï¼Œç›¸å½“äºè‡ªå¢åˆ—ä¼šè¢«ç½®ä¸ºåˆå§‹å€¼ï¼Œåˆé‡æ–°ä»1å¼€å§‹è®°å½•ï¼Œè€Œä¸æ˜¯æ¥ç€åŸæ¥çš„ IDæ•°ã€‚è€Œ delete åˆ é™¤ä»¥åï¼Œidentity ä¾æ—§æ˜¯æ¥ç€è¢«åˆ é™¤çš„æœ€è¿‘çš„é‚£ä¸€æ¡è®°å½•IDåŠ 1åè¿›è¡Œè®°å½•ã€‚å¦‚æœåªéœ€åˆ é™¤è¡¨ä¸­çš„éƒ¨åˆ†è®°å½•ï¼Œåªèƒ½ä½¿ç”¨ DELETEè¯­å¥é…åˆ whereæ¡ä»¶   å¤‡ä»½ # å…¨é‡é”è¡¨å¤‡ä»½(ä¸å¯å†™) mysqldump --lock-all-tables --all-databases &amp;gt; ALLDB.</description>
			<content type="html"><![CDATA[<p>ç®€å•è®°å½•ä¸€äº›mysqlçŸ¥è¯†ç‚¹</p>
<!-- more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
### ä¸‰å¤§èŒƒå¼
- åˆ—ä¸å¯å†åˆ†: 	æœåŠ¡å,æœåŠ¡æè¿°
- å±æ€§å®Œå…¨ä¾èµ–ä¸»é”®:	æœåŠ¡åä¾èµ–äºæœåŠ¡ID
- å±æ€§ç›´æ¥ä¾èµ–ä¸»é”®: 	HTTP,TCP,GRPC è§„åˆ™å„ä¸ºä¸€å¼ è¡¨
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="sql-è¯­å¥ä¸»è¦å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹-3-ä¸ªç±»åˆ«">SQL è¯­å¥ä¸»è¦å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªç±»åˆ«</h3>
<pre><code>DDLï¼ˆData Definition Languagesï¼‰è¯­å¥ï¼šæ•°æ®å®šä¹‰è¯­è¨€ï¼Œè¿™äº›è¯­å¥å®šä¹‰äº†ä¸åŒçš„æ•°æ®æ®µã€æ•°æ®åº“ã€è¡¨ã€åˆ—ã€ç´¢å¼•ç­‰æ•°æ®åº“å¯¹è±¡çš„å®šä¹‰ã€‚å¸¸ç”¨çš„è¯­å¥å…³é”®å­—ä¸»è¦åŒ…æ‹¬ createã€dropã€alterç­‰ã€‚
DMLï¼ˆData Manipulation Languageï¼‰è¯­å¥ï¼šæ•°æ®æ“çºµè¯­å¥ï¼Œç”¨äºæ·»åŠ ã€åˆ é™¤ã€æ›´æ–°å’ŒæŸ¥è¯¢æ•°æ®åº“è®°å½•ï¼Œå¹¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼Œå¸¸ç”¨çš„è¯­å¥å…³é”®å­—ä¸»è¦åŒ…æ‹¬ insertã€deleteã€udpate å’Œselect ç­‰ã€‚(å¢æ·»æ”¹æŸ¥ï¼‰
DCLï¼ˆData Control Languageï¼‰è¯­å¥ï¼šæ•°æ®æ§åˆ¶è¯­å¥ï¼Œç”¨äºæ§åˆ¶ä¸åŒæ•°æ®æ®µç›´æ¥çš„è®¸å¯å’Œè®¿é—®çº§åˆ«çš„è¯­å¥ã€‚è¿™äº›è¯­å¥å®šä¹‰äº†æ•°æ®åº“ã€è¡¨ã€å­—æ®µã€ç”¨æˆ·çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ã€‚ä¸»è¦çš„è¯­å¥å…³é”®å­—åŒ…æ‹¬ grantã€revoke ç­‰ã€‚
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="æ¸…ç©ºè¡¨">æ¸…ç©ºè¡¨</h3>
<pre><code>åˆ é™¤è¡¨ä¿¡æ¯çš„æ–¹å¼æœ‰ä¸¤ç§ :
truncate table table_name;
delete * from table_name;
æ³¨ : truncateæ“ä½œä¸­çš„tableå¯ä»¥çœç•¥ï¼Œdeleteæ“ä½œä¸­çš„*å¯ä»¥çœç•¥

truncateã€delete æ¸…ç©ºè¡¨æ•°æ®çš„åŒºåˆ« :
1&gt; truncate æ˜¯æ•´ä½“åˆ é™¤ (é€Ÿåº¦è¾ƒå¿«)ï¼Œdeleteæ˜¯é€æ¡åˆ é™¤ (é€Ÿåº¦è¾ƒæ…¢)
2&gt; truncate ä¸å†™æœåŠ¡å™¨ logï¼Œdelete å†™æœåŠ¡å™¨ logï¼Œä¹Ÿå°±æ˜¯ truncate æ•ˆç‡æ¯” deleteé«˜çš„åŸå› 
3&gt; truncate ä¸æ¿€æ´»trigger (è§¦å‘å™¨)ï¼Œä½†æ˜¯ä¼šé‡ç½®Identity (æ ‡è¯†åˆ—ã€è‡ªå¢å­—æ®µ)ï¼Œç›¸å½“äºè‡ªå¢åˆ—ä¼šè¢«ç½®ä¸ºåˆå§‹å€¼ï¼Œåˆé‡æ–°ä»1å¼€å§‹è®°å½•ï¼Œè€Œä¸æ˜¯æ¥ç€åŸæ¥çš„ IDæ•°ã€‚è€Œ delete åˆ é™¤ä»¥åï¼Œidentity ä¾æ—§æ˜¯æ¥ç€è¢«åˆ é™¤çš„æœ€è¿‘çš„é‚£ä¸€æ¡è®°å½•IDåŠ 1åè¿›è¡Œè®°å½•ã€‚å¦‚æœåªéœ€åˆ é™¤è¡¨ä¸­çš„éƒ¨åˆ†è®°å½•ï¼Œåªèƒ½ä½¿ç”¨ DELETEè¯­å¥é…åˆ whereæ¡ä»¶

</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="å¤‡ä»½">å¤‡ä»½</h3>
<pre><code># å…¨é‡é”è¡¨å¤‡ä»½(ä¸å¯å†™)
mysqldump --lock-all-tables --all-databases &gt; ALLDB.sql

# ä»…å¯¼å‡ºæ‰€æœ‰è¡¨çš„ç»“æ„
mysqldump --opt -d æ•°æ®åº“å -u root -p &gt; xxx.sql


</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="slave-ä¸­ä¿®æ”¹master_host">slave ä¸­ä¿®æ”¹master_host</h3>
<pre><code># æŸ¥çœ‹ master.infoä¸­ä¿¡æ¯

# æŸ¥çœ‹ show slave status\G ä¸­ Master_Host

# ä¿®æ”¹çš„æ­¥éª¤éœ€è¦å…ˆåœæ­¢slave
1 stop slave ;
2 change master to master_host='xxx.xxx.xxx';
  é¦–æ¬¡é…ç½®ä¸»åº“:
  CHANGE MASTER TO MASTER_HOST='a_master.b.com',MASTER_PORT=3306,MASTER_USER='repl_user',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='m1-master-bin.000001',MASTER_LOG_POS=88;
3 start slave ;
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="mysqlé—®é¢˜-navicatè¿æ¥æ•°æ®åº“å¾ˆæ…¢">mysqlé—®é¢˜: navicatè¿æ¥æ•°æ®åº“å¾ˆæ…¢</h3>
<pre><code>æŠ¥é”™: 2013-Lost connection to MYSQL server at 'reading for initial communication packet'
è¯´æ˜: åªæœ‰windows çš„navicatä¼šå‡ºç°ä¸Šé¢æŠ¥é”™, windowsä¸Šé€šè¿‡mysqlå‘½ä»¤è¿æ¥æ—¶ ä¹Ÿå¾ˆæ…¢

#æ·»åŠ å¦‚ä¸‹å†…å®¹:
[mysqld]
skip-name-resolve
</code></pre><hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="mysqlé—®é¢˜-mysql57-é”™è¯¯æ€»ç»“-error-1067-42000-invalid-default-value-for-timestamp">mysqlé—®é¢˜: mysql5.7 é”™è¯¯æ€»ç»“-ERROR 1067 (42000): Invalid default value for TIMESTAMP</h3>
<pre><code>show variables like 'sql_mode';
+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+
| Variable_name | Value                                                                                                                                     |
+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+
| sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+
</code></pre><p>è¿™æ˜¯å› ä¸ºsql_modeä¸­çš„NO_ZEROR_DATEå¯¼åˆ¶çš„ï¼Œåœ¨strict modeä¸­ä¸å…è®¸'0000-00-00&rsquo;ä½œä¸ºåˆæ³•æ—¥æœŸ</p>
<p>å°†ä¸Šé¢çš„NO_ZERO_DATEæ”¹ä¸ºä¸‹é¢çš„ ALLOW_INVALID_DATES</p>
<pre><code>set sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
set session  sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';

</code></pre><p>ä¸Šé¢çš„è®¾ç½®æ˜¯ä¸´æ—¶è®¾ç½®ï¼Œåœ¨é‡æ–°ç™»é™†åï¼Œè¯¥è®¾ç½®åˆæ¢å¤ä¸ºNO_ZERO_DATE</p>
<hr>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="mysql55ä¸»mysql57ä»-é—®é¢˜">mysql5.5ä¸»+mysql5.7ä» é—®é¢˜</h3>
<pre><code>ERROR 1794 (HY000): Slave is not configured or failed to initialize properly. You must at least set --server-id to enable either a master or a slave. Additional error messages can be found in the MySQL error log.
server_uuidæ˜¯5.6çš„gtidç‰¹æ€§å¼•å…¥çš„ä¸€ä¸ªé…ç½®ï¼Œ
æŠŠmysql5.7çš„ rpl_slave.ccæ–‡ä»¶ä¸­get_master_uuidå‡½æ•°æ¢æˆ5.6å¯¹åº”çš„å‡½æ•°å°±å¯ä»¥äº†ã€‚
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="mysqlä¸€äº›infoä¿¡æ¯ç»Ÿè®¡">mysqlä¸€äº›infoä¿¡æ¯ç»Ÿè®¡</h3>
<pre><code>#tbl_size.sql
use information_schema;
SELECT
    TABLE_NAME,
 ENGINE,
    ROUND((DATA_LENGTH/1024/1024),2) as DataM ,
    ROUND((INDEX_LENGTH/1024/1024),2) as IndexM,
    ROUND(((DATA_LENGTH+INDEX_LENGTH)/1024/1024),2) as AllM,
    TABLE_ROWS,
 TABLE_COMMENT
FROM
    TABLES
WHERE
    TABLE_SCHEMA = 'hzkj_zh'
ORDER BY AllM DESC;

# ç”Ÿæˆexcelè¡¨æ ¼
mysql test &lt;tbl_size.sql &gt;tbl_info_20191028.txt
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="è·³è¿‡ä¸»ä»åŒæ­¥é”™è¯¯">è·³è¿‡ä¸»ä»åŒæ­¥é”™è¯¯</h3>
<pre><code>stop slave;
SET GLOBAL sql_slave_skip_counter =1;
start slave;
show slave status\G;
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
</center>
<h3 id="mysql-information_schematablesè¡¨ä¸­çš„table_rows-å­—æ®µå€¼ä¸count-å€¼ä¸åŒ">mysql information_schema.TABLESè¡¨ä¸­çš„table_rows å­—æ®µå€¼ä¸&rsquo;count(*)' å€¼ä¸åŒ</h3>
<blockquote>
<p>æŸ¥çœ‹information_schema</p>
</blockquote>
<pre><code>use information_schema;
SELECT
    TABLE_NAME,
    TABLE_ROWS
FROM
    TABLES
WHERE
    TABLE_SCHEMA = 'zz' and TABLE_NAME = 'zzz';


+---------------------+------------+
| TABLE_NAME          | TABLE_ROWS |
+---------------------+------------+
|      zzz            |   42411396 |
+---------------------+------------+
</code></pre><p>ä½†æ˜¯ä¼šå‘ç°å’Œ</p>
<pre><code>&quot; select count(*) from æŸå¼ è¡¨; &quot;
</code></pre><p>æ‰§è¡Œå¾—åˆ°çš„å€¼æ˜¯ä¸ç›¸åŒçš„ï¼é‚£æ˜¯å› ä¸ºï¼š</p>
<ul>
<li>1: é»˜è®¤æƒ…å†µä¸‹ mysqlÂ å¯¹è¡¨è¿›è¡Œå¢åˆ æ“ä½œæ—¶ï¼Œæ˜¯ä¸ä¼šè‡ªåŠ¨æ›´æ–° information_schemaÂ åº“ä¸­Â tablesÂ è¡¨çš„Â table_rowsÂ å­—æ®µçš„ï¼Œåœ¨ç½‘ä¸Šæœç´¢ä¸€ä¸‹å‘ç°è¯´ï¼šåªæœ‰10%çš„è¡Œæ•°å‘ç”Ÿå˜åŒ–æ‰ä¼šè‡ªåŠ¨æ”¶é›†ï¼ˆæ²¡æœ‰äº²è‡ªéªŒè¯è¿‡ï¼ï¼‰ï¼›</li>
<li>2: æ‰§è¡ŒÂ Analyze table tableName;Â ä¼šç»Ÿè®¡æ‰€æœ‰è¡¨æ•°æ®ï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºä¼šé”è¡¨ï¼ï¼‰ï¼›
åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/David_jiahuan/article/details/98478740">mysql information_schema.TABLESè¡¨ä¸­çš„table_rows å­—æ®µå€¼ä¸countå€¼ä¸åŒ</a></li>
</ul>
<h3 id="mysqldump-å¯¼å‡ºçš„è§¦å‘å™¨å¯¼è‡´æµ‹è¯•åº“æŠ¥æƒé™ä¸è¶³é”™è¯¯">mysqldump å¯¼å‡ºçš„è§¦å‘å™¨å¯¼è‡´æµ‹è¯•åº“æŠ¥æƒé™ä¸è¶³é”™è¯¯</h3>
<ul>
<li>ç½‘ä¸Šæœ‰ä¸€äº›æ•™ç¨‹: <a href="https://stackoverflow.com/questions/10169960/mysql-error-1449-the-user-specified-as-a-definer-does-not-exist">https://stackoverflow.com/questions/10169960/mysql-error-1449-the-user-specified-as-a-definer-does-not-exist</a></li>
<li>mysqlå¦‚ä½•ä¿®æ”¹æ‰€æœ‰çš„definer: <a href="https://blog.csdn.net/weixin_30739595/article/details/95782340">https://blog.csdn.net/weixin_30739595/article/details/95782340</a></li>
</ul>
<blockquote>
<p>ä»çº¿ä¸Šå¯¼å‡ºè¡¨åˆ°æµ‹è¯•, å‘ç°æµ‹è¯•æŠ¥é”™: The user specified as a definer (&lsquo;xxx&rsquo;@&lsquo;x.x.%.%') does not exist</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">mysqldump --single-transaction --max-allowed-packet<span class="o">=</span><span class="m">1073741824</span> dbname tablename &gt; tablename.sql
</code></pre></div><blockquote>
<p>è¿™é‡Œç”¨äº†ä¸€ç§ä¸å¤ªå¥½çš„æ–¹æ³•è§£å†³äº†è¯¥é—®é¢˜(ä¸»è¦æ˜¯ä¸æ‡‚&hellip;)</p>
</blockquote>
<p>å°† tablename.sql æ–‡ä»¶ä¸­çš„ DEFINER=<code>xxx</code>@<code>x.x.%.%</code> æ”¹æˆæµ‹è¯•åº“ä¸­ä¹‹å‰çš„ç”¨æˆ·åæ¯”å¦‚è¯´: DEFINER=<code>test</code>@<code>%</code>
ç„¶åé‡æ–°å¯¼å…¥è¦†ç›–</p>
<p>æ‰€ä»¥è¯´è§¦å‘å™¨çš„definerä¸æ˜¯å¾ˆæ–¹ä¾¿ä¿®æ”¹</p>
<h3 id="change-column-å¯¼è‡´é”">change column å¯¼è‡´é”</h3>
<p>å®˜æ–¹online-ddlæ–‡æ¡£: <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html</a></p>
<h3 id="php-warning--mysql_fetch_array-supplied-argument-is-not-a-valid-mysql-result-resource-in">PHP Warning:  mysql_fetch_array(): supplied argument is not a valid MySQL result resource in</h3>
<blockquote>
<p>è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºæŸ¥è¯¢æ•°æ®åº“ç»“æœå¯èƒ½ä¸ºç©º, ç›´æ¥returnçš„æ—¶å€™æŠ¥warning</p>
</blockquote>
<h4 id="åŸç¤ºä¾‹">åŸç¤ºä¾‹:</h4>
<pre><code>function get($sql) {
    $row = mysql_fetch_array($this-&gt;query($sql));
    return $row[0]
    ...
}
</code></pre><h4 id="ä¿®æ”¹ç¤ºä¾‹">ä¿®æ”¹ç¤ºä¾‹:</h4>
<pre><code>function get($sql) {
  $query = $this-&gt;query($sql);
  if($query){
     $row = mysql_fetch_array($query);
     return $row[0]
  }
  ...
}   
</code></pre>]]></content>
		</item>
		
		<item>
			<title>centos6å®‰è£…nginx1.16&#43;php7.2</title>
			<link>https://www.ngirl.xyz/posts/10-centos6%E5%AE%89%E8%A3%85nginx1-16-php7-2/</link>
			<pubDate>Fri, 27 Sep 2019 14:39:07 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/10-centos6%E5%AE%89%E8%A3%85nginx1-16-php7-2/</guid>
			<description>è®°å½•ç®€å•çš„å®‰è£…nginxå’Œphpçš„é…ç½®,ä»…ä¾›å‚è€ƒ
å…ˆå‡†å¤‡ç¯å¢ƒ # æ›´æ–°æº mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo yum clean all yum makecache yum install -y epel-release # å®‰è£…ä¸€äº›ä¾èµ–åŒ… yum -y install gcc make cmake ncurses-devel libxml2-devel libtool-ltdl-devel gcc-c++ autoconf automake bison zlib-devel openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel autoconf automake libtool-ltdl libtool-ltdl-devel libjpeg libjpeg-turbo-devel libmcrypt-devel libpng-devel centos6ç¼–è¯‘å®‰è£…nginx #é¦–å…ˆå®˜ç½‘ä¸‹è½½1.16 cd /usr/local/src/ wget http://nginx.org/download/nginx-1.16.0.tar.gz tar -xvf nginx-1.16.0.tar.gz # ç¼–è¯‘ç®€å•çš„æ¨¡å— ./configure --prefix=/usr/local/nginx/ --with-http_ssl_module --with-http_stub_status_module --with-http_stub_status_module make -j4 make install # é€šè¿‡å¯åŠ¨è„šæœ¬å¯åŠ¨ chmod +x /etc/init.</description>
			<content type="html"><![CDATA[<p>è®°å½•ç®€å•çš„å®‰è£…nginxå’Œphpçš„é…ç½®,ä»…ä¾›å‚è€ƒ</p>
<!-- more -->
<h3 id="å…ˆå‡†å¤‡ç¯å¢ƒ">å…ˆå‡†å¤‡ç¯å¢ƒ</h3>
<pre><code># æ›´æ–°æº
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
yum clean all
yum makecache
yum install -y epel-release

# å®‰è£…ä¸€äº›ä¾èµ–åŒ…
yum -y install gcc make cmake ncurses-devel libxml2-devel libtool-ltdl-devel gcc-c++ autoconf automake bison  zlib-devel openssl-devel pcre-devel libxml2 libxml2-devel libcurl libcurl-devel autoconf automake  libtool-ltdl libtool-ltdl-devel libjpeg  libjpeg-turbo-devel libmcrypt-devel libpng-devel

</code></pre><h3 id="centos6ç¼–è¯‘å®‰è£…nginx">centos6ç¼–è¯‘å®‰è£…nginx</h3>
<pre><code>#é¦–å…ˆå®˜ç½‘ä¸‹è½½1.16
cd /usr/local/src/
wget http://nginx.org/download/nginx-1.16.0.tar.gz
tar -xvf nginx-1.16.0.tar.gz

# ç¼–è¯‘ç®€å•çš„æ¨¡å—
./configure --prefix=/usr/local/nginx/  --with-http_ssl_module --with-http_stub_status_module  --with-http_stub_status_module
make -j4
make install

# é€šè¿‡å¯åŠ¨è„šæœ¬å¯åŠ¨
chmod +x /etc/init.d/nginx
service nginx start
# å¼€æœºå¯åŠ¨
chkconfig nginx on
</code></pre><h3 id="nginx-å¯åŠ¨è„šæœ¬-etcinitdnginx">nginx å¯åŠ¨è„šæœ¬ /etc/init.d/nginx</h3>
<pre><code>#!/bin/bash
# nginx Startup script for the Nginx HTTP Server
# it is v.0.0.2 version.
# chkconfig: - 85 15
# description: Nginx is a high-performance web and proxy server.
#              It has a lot of features, but it's not for everyone.
# processname: nginx
# pidfile: /var/run/nginx.pid
# config: /usr/local/nginx/conf/nginx.conf

nginx=/usr/local/nginx/sbin/nginx
nginx_config=/usr/local/nginx/conf/nginx.conf
nginx_pid=/var/run/nginx.pid

RETVAL=0
prog=&quot;nginx&quot;
# Source function library.
.  /etc/rc.d/init.d/functions
# Source networking configuration.
.  /etc/sysconfig/network
# Check that networking is up.
[ ${NETWORKING} = &quot;no&quot; ] &amp;&amp; exit 0
[ -x $nginx ] || exit 0
# Start nginx daemons functions.
start() {
if [ -e $nginx_pid ];then
   echo &quot;nginx already running....&quot;
   exit 1
fi
   echo -n $&quot;Starting $prog: &quot;
   daemon $nginx -c ${nginx_config}
   RETVAL=$?
   echo
   [ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/nginx
   return $RETVAL
}
# Stop nginx daemons functions.
stop() {
        echo -n $&quot;Stopping $prog: &quot;
        killproc $nginx
        RETVAL=$?
        echo
        [ $RETVAL = 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx /usr/local//nginx/logs/nginx.pid
}

reload() {
    echo -n $&quot;Reloading $prog: &quot;
    #kill -HUP `cat ${nginx_pid}`
    killproc $nginx -HUP
    RETVAL=$?
    echo
}
# See how we were called.
case &quot;$1&quot; in
start)
        start
        ;;
stop)
        stop
        ;;
reload)
        reload
        ;;
restart)
        stop
        start
        ;;
status)
        status $prog
        RETVAL=$?
        ;;
*)
        echo $&quot;Usage: $prog {start|stop|restart|reload|status|help}&quot;
        exit 1
esac
exit $RETVAL
</code></pre><h3 id="nginxconfç®€å•é…ç½®">nginx.confç®€å•é…ç½®</h3>
<pre><code>user  nobody nobody;
worker_processes  auto;

worker_rlimit_nofile 102400;
pid        /var/run/nginx.pid;

events {
    use epoll;
    worker_connections 102400;
}


http {
    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                  '$status $body_bytes_sent &quot;$http_referer&quot; '
                 '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    ###å®šä¹‰ä¸€ä¸ªlog_format
    log_format  main '[ $host $request_time  $upstream_addr $upstream_response_time ] ' '$status ' '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '  '$body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for &quot; &quot;$bytes_sent&quot; &quot; $request_body&quot;' ;


    ###æ—¥å¿—ç›®å½•é…ç½®
    #æ—¥å¿—å…¨éƒ¨å†™å…¥/nginx_logs/access.log æ–‡ä»¶ä¸­ã€‚å…³é—­æœ€åä¸¤ä¸ªserver_nameçš„æ—¥å¿—
    access_log  /data/nginx_logs/access.log  server_name_main;
    error_log /data/nginx_logs/error.log notice;

    ###æ‚é¡¹é…ç½®
    charset utf-8;
    #server nameçš„hashè¡¨ï¼Œ
    server_names_hash_bucket_size 128;
    #è¯·æ±‚å¤´å¦‚æœè¿‡å°ï¼Œé‚£ä¹ˆä¼šå¼•èµ·400é”™è¯¯ã€‚ä¸€èˆ¬å¦‚æœcookieè¿‡å¤§ï¼Œä¼šå¼•èµ·é—®é¢˜ã€‚getconf PAGESIZEç³»ç»Ÿåˆ†é¡µ
    client_header_buffer_size 8k;
    client_body_buffer_size  512k;
    large_client_header_buffers 16 16k;
    client_max_body_size 30m;
    sendfile on;
    tcp_nopush     on;
    keepalive_timeout 60;
    tcp_nodelay on;

    #fastcgié€šç”¨é…ç½®
    fastcgi_connect_timeout 600;
    fastcgi_send_timeout 600;
    fastcgi_read_timeout 600;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 8 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;

    ###ä»£ç†æœ‰å…³çš„é…ç½®
    proxy_connect_timeout    600;
    proxy_read_timeout       600;
    proxy_send_timeout       600;
    proxy_buffer_size        512k;
    proxy_buffers            6 512k;
    proxy_busy_buffers_size 512k;
    proxy_temp_file_write_size 512k;

    #æˆ–è®¸åœ¨äºæµ‹è¯•,ä»£ç†æœåŠ¡å™¨ä¸ä¸»åŠ¨å…³é—­å®¢æˆ·ç«¯ï¼Œé˜²æ­¢499é”™è¯¯
    proxy_ignore_client_abort on;


    ###gzipé…ç½®
    gzip on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_types       text/plain application/x-javascript text/css application/xml;
    gzip_vary on;


    include             /usr/local/nginx/conf/mime.types;
    default_type        application/octet-stream;

    # éšè—nginxç‰ˆæœ¬ä¿¡æ¯
    server_tokens off;

    server {
        listen       80 default_server;
        server_name  _;
        #server_name  localhost;
        index  index.html index.htm;
        root   html;
        deny all;

        location / {
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }


}
</code></pre><h3 id="centos6ç¼–è¯‘å®‰è£…php7">centos6ç¼–è¯‘å®‰è£…php7</h3>
<pre><code># é¦–å…ˆå®‰è£…freetype2.4
tar -xvf freetype-2.4.0.tar.gz
cd freetype-2.4.0
./configure --prefix=/usr/local/freetype
make -j4 &amp;&amp; make install


# ç¼–è¯‘php7(ä¸éœ€è¦çš„å¯ä»¥å»æ‰)
tar -xvf php-7.2.2.tar.gz
cd php-7.2.2
./configure    --prefix=/usr/local/php   --with-libxml-dir=/usr/   --with-pdo-mysql=mysqlnd   --with-zlib   --with-libxml-dir   --with-openssl   --enable-mysqlnd   --enable-mbstring   --with-config-file-path=/usr/local/php/etc/   --with-config-file-scan-dir=/usr/local/php/etc/conf.d   --enable-fpm --with-freetype-dir=/usr/local/freetype  --with-jpeg-dir --with-png-dir --with-gd --enable-gd-native-ttf --enable-pdo --enable-mbstring --enable-bcmath

make -j 4 &amp;&amp; make install

# å®‰è£…composer
curl -sS https://getcomposer.org/installer | php &amp;&amp; mv composer.phar /usr/bin/composer
</code></pre><h3 id="é…ç½®">é…ç½®</h3>
<pre><code># php.inié…ç½®(å…·ä½“é…ç½®å†…å®¹è‡ªè¡Œä¿®æ”¹)
cp php.ini-production /usr/local/php7/etc/php.ini
cp /usr/local/php7/etc/php-fpm.conf.default /usr/local/php7/etc/php-fpm.conf
cp /usr/local/php7/etc/php-fpm.d/www.conf.default /usr/local/php7/etc/php-fpm.d/www.conf

# å¯åŠ¨è„šæœ¬
cp ./sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm
chmod +x /etc/init.d/php-fpm

# åˆ›å»ºlink
ln -s /usr/local/php7 /usr/local/php
</code></pre><h3 id="å¯åŠ¨php-fpm">å¯åŠ¨php-fpm</h3>
<pre><code>service php-fpm start
chkconfig php-fpm on
</code></pre>]]></content>
		</item>
		
		<item>
			<title>mysql5.7äºŒè¿›åˆ¶éƒ¨ç½²</title>
			<link>https://www.ngirl.xyz/posts/8-mysql5-7%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/</link>
			<pubDate>Thu, 26 Sep 2019 15:11:05 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/8-mysql5-7%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/</guid>
			<description>äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²mysql5.7
 ä¸‹è½½glibcäºŒè¿›åˆ¶åŒ… #æ‰“å¼€ä¸‹è½½é¡µé¢, å¯èƒ½ä¼šæœ‰å°ç‰ˆæœ¬æ›´æ–°(æ³¨æ„ï¼šé€‰æ‹©æ“ä½œç³»ç»Ÿæ—¶é€‰Linux-Genericï¼‰ https://dev.mysql.com/downloads/mysql/5.7.html#downloads # æœ€æ–°çš„å¯èƒ½æœ‰å°ç‰ˆæœ¬å˜åŒ– wget https://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz å®‰è£…é…ç½® tar -xvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz mv mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/ cd /usr/local/ # æˆ‘çš„é•œåƒæ˜¯å®‰è£…è¿‡5.5mysql, æ‰€ä»¥éœ€è¦mvä¸€ä¸‹ mv mysql mysql-5.5.37 # ç”±äºä»¥å‰å®‰è£…è¿‡phpæŒ‡å®šäº†è¯¥mysqç›®å½•, è¿™å¯èƒ½å¯¼è‡´ä»¥å‰å®‰è£…çš„phpç¼ºå°‘libmysqlclient.so.18 ln -s /usr/local/mysql-5.5.37/lib/libmysqlclient.so.18 /usr/local/mysql-5.7.24-linux-glibc2.12-x86_64/lib/libmysqlclient.so.18 ln -s mysql-5.7.24-linux-glibc2.12-x86_64 mysql # æ·»åŠ å¯åŠ¨æ–‡ä»¶ \cp mysql/support-files/mysql.server /etc/init.d/mysqld echo &amp;quot;PATH=$PATH:/usr/local/mysql/bin/&amp;quot; &amp;gt;&amp;gt;~/.bashrc # å¯é€‰ wget http://centos.mirrors.ucloud.cn/centos/6/os/x86_64/Packages/numactl-2.0.9-2.el6.x86_64.rpm yum localinstall numactl-2.0.9-2.el6.x86_64.rpm \rm numactl-2.0.9-2.el6.x86_64.rpm useradd mysql # é…ç½®ä¸‹mysqlçš„æ•°æ®ç›®å½• cd /data/ mkdir u01 mkdir u02 chown -R mysql.mysql u01 chown -R mysql.</description>
			<content type="html"><![CDATA[<blockquote>
<p>äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²mysql5.7</p>
</blockquote>
<!-- more -->
<h3 id="ä¸‹è½½glibcäºŒè¿›åˆ¶åŒ…">ä¸‹è½½glibcäºŒè¿›åˆ¶åŒ…</h3>
<pre><code>#æ‰“å¼€ä¸‹è½½é¡µé¢, å¯èƒ½ä¼šæœ‰å°ç‰ˆæœ¬æ›´æ–°(æ³¨æ„ï¼šé€‰æ‹©æ“ä½œç³»ç»Ÿæ—¶é€‰Linux-Genericï¼‰
https://dev.mysql.com/downloads/mysql/5.7.html#downloads

# æœ€æ–°çš„å¯èƒ½æœ‰å°ç‰ˆæœ¬å˜åŒ–
wget https://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz
</code></pre><h3 id="å®‰è£…é…ç½®">å®‰è£…é…ç½®</h3>
<pre><code>tar -xvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz
mv mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/
cd /usr/local/

# æˆ‘çš„é•œåƒæ˜¯å®‰è£…è¿‡5.5mysql, æ‰€ä»¥éœ€è¦mvä¸€ä¸‹
mv mysql mysql-5.5.37

# ç”±äºä»¥å‰å®‰è£…è¿‡phpæŒ‡å®šäº†è¯¥mysqç›®å½•, è¿™å¯èƒ½å¯¼è‡´ä»¥å‰å®‰è£…çš„phpç¼ºå°‘libmysqlclient.so.18
ln -s /usr/local/mysql-5.5.37/lib/libmysqlclient.so.18 /usr/local/mysql-5.7.24-linux-glibc2.12-x86_64/lib/libmysqlclient.so.18
ln -s mysql-5.7.24-linux-glibc2.12-x86_64 mysql

# æ·»åŠ å¯åŠ¨æ–‡ä»¶
\cp mysql/support-files/mysql.server /etc/init.d/mysqld
echo &quot;PATH=$PATH:/usr/local/mysql/bin/&quot; &gt;&gt;~/.bashrc

# å¯é€‰
wget http://centos.mirrors.ucloud.cn/centos/6/os/x86_64/Packages/numactl-2.0.9-2.el6.x86_64.rpm
yum localinstall numactl-2.0.9-2.el6.x86_64.rpm
\rm numactl-2.0.9-2.el6.x86_64.rpm

useradd mysql

# é…ç½®ä¸‹mysqlçš„æ•°æ®ç›®å½•
cd /data/
mkdir u01
mkdir u02
chown -R mysql.mysql u01
chown -R mysql.mysql u02
chmod 750 u01
chmod 750 u02
cd /data/u01/

# åˆå§‹åŒ–
/usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/u01
cat auto.cnf

# å¯åŠ¨æœåŠ¡ (åœ¨è¿™ä¹‹å‰å‡†å¤‡å¥½ /etc/my.cnf)
/etc/init.d/mysqld start

# è®°å½•ä¸‹variables
mysql -e &quot;show global variables&quot; &gt;mysql_option_default.log
</code></pre><h3 id="mycnf">my.cnf</h3>
<pre><code>[client]
port = 3306
socket = /data/u01/mysql.sock

[mysql]
prompt=&quot;\u@m1-u [\d]&gt; &quot;
no-auto-rehash

[mysqld]
user = mysql
port = 3306
basedir = /usr/local/mysql
datadir = /data/u01
socket = /data/u01/mysql.sock
pid-file = /data/u01/m1-u.pid
tmpdir = /data/u02
server-id = 1001
character-set-server = utf8
skip_name_resolve = 1
innodb_file_per_table = 1
explicit_defaults_for_timestamp = 0

# buffer&amp;cache
table_open_cache = 100
table_definition_cache = 400
table_open_cache_instances = 64
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 8M
read_rnd_buffer_size = 4M

# thread&amp;connection
thread_stack = 256K
thread_cache_size = 768
back_log = 1024
max_connections = 3000
max_connect_errors = 1000000

# temptable
tmp_table_size = 32M
max_heap_table_size = 32M

# network
max_allowed_packet = 32M
#lock_wait_timeout = 3600
#interactive_timeout = 600
#wait_timeout = 600

# query cache
query_cache_size = 0
query_cache_type = 0

# è®¾ç½®errorlogã€slowlogå’Œgenerallogçš„æ—¶åŒºï¼Œé»˜è®¤UTC
log_timestamps = SYSTEM

# error-log
log_error = /data/u02/mysqld.log

# slow-log
slow_query_log = 1
slow_query_log_file = /data/u02/slow.log
long_query_time = 0.1
log_queries_not_using_indexes =1
log_throttle_queries_not_using_indexes = 60
min_examined_row_limit = 100
log_slow_admin_statements = 1
log_slow_slave_statements = 1

# general log
#general-log = 1
general_log_file=/data/u02/query.log

# binlog
binlog_format = row
binlog_checksum = 1
log-bin = /data/u02/bdm1-bin
log-bin-index = /data/u02/bdm1-bin.index
sync_binlog = 0
binlog_cache_size = 4M
max_binlog_cache_size = 2G
max_binlog_size = 512M
expire_logs_days = 15

# GTID
gtid_mode = on
enforce_gtid_consistency = 1
log_slave_updates

# Replication
master_info_repository = TABLE
relay_log_info_repository = TABLE
slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'
relay_log_recovery = 1
relay_log_purge = 1
relay-log=/data/u02/bdm1-relay-bin
relay-log-index=/data/u02/bdm1-relay-bin.index

# innodb-buffer&amp;cache
innodb_buffer_pool_size = 2G
innodb_buffer_pool_instances = 4
#innodb_additional_mem_pool_size = 16M
innodb_max_dirty_pages_pct = 50

# innodb log
innodb_data_file_path = ibdata1:1G:autoextend
innodb_log_file_size = 1G
innodb_log_files_in_group = 2
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 32M
#innodb_max_undo_log_size = 4G
#innodb_undo_directory = undolog
innodb_undo_tablespaces = 4

# innodb-io
innodb_flush_method = O_DIRECT
innodb_io_capacity = 600
innodb_io_capacity_max = 2000
innodb_flush_sync = 0
innodb_flush_neighbors = 0
#innodb_lru_scan_depth = 4000
innodb_write_io_threads = 8
innodb_read_io_threads = 8
innodb_purge_threads = 4
innodb_page_cleaners = 4

# transaction,lock
#innodb_sync_spin_loops = 100
#innodb_spin_wait_delay = 30
innodb_lock_wait_timeout = 10
innodb_print_all_deadlocks = 1
innodb_rollback_on_timeout = 1

innodb_open_files = 65535

innodb_online_alter_log_max_size = 2G

# innodb status
innodb_status_file = 1
# æ³¨æ„: å¼€å¯ innodb_status_output &amp; innodb_status_output_locks å, å¯èƒ½ä¼šå¯¼è‡´log-erroræ–‡ä»¶å¢é•¿è¾ƒå¿«
innodb_status_output = 0
innodb_status_output_locks = 0

#performance_schema
performance_schema = 1
performance_schema_instrument = '%=on'

#innodb monitor
innodb_monitor_enable=&quot;module_innodb&quot;
innodb_monitor_enable=&quot;module_server&quot;
innodb_monitor_enable=&quot;module_dml&quot;
innodb_monitor_enable=&quot;module_ddl&quot;
innodb_monitor_enable=&quot;module_trx&quot;
innodb_monitor_enable=&quot;module_os&quot;
innodb_monitor_enable=&quot;module_purge&quot;
innodb_monitor_enable=&quot;module_log&quot;
innodb_monitor_enable=&quot;module_lock&quot;
innodb_monitor_enable=&quot;module_buffer&quot;
innodb_monitor_enable=&quot;module_index&quot;
innodb_monitor_enable=&quot;module_ibuf_system&quot;
innodb_monitor_enable=&quot;module_buffer_page&quot;
innodb_monitor_enable=&quot;module_adaptive_hash&quot;

# MyISAM
key_buffer_size = 1024M
bulk_insert_buffer_size = 64M
myisam_sort_buffer_size = 128M
myisam_repair_threads = 1


[mysqldump]
quick
max_allowed_packet = 32M
</code></pre>]]></content>
		</item>
		
		<item>
			<title>k8séƒ¨ç½²storageclassåŠ¨æ€åˆ›å»ºpv(nfs&amp;rbd)</title>
			<link>https://www.ngirl.xyz/posts/7-k8s%E9%83%A8%E7%BD%B2storageclass%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BApv-nfs-rbd/</link>
			<pubDate>Thu, 26 Sep 2019 14:12:49 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/7-k8s%E9%83%A8%E7%BD%B2storageclass%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BApv-nfs-rbd/</guid>
			<description>è€ƒè™‘åˆ°k8så­˜å‚¨çš„é—®é¢˜, æœ¬æœºç›®å½•æŒ‚è½½å­˜åœ¨å¤ªå¤§å±€é™æ€§, å¤šnodeå¤špodçš„æœåŠ¡å­˜å‚¨æ€¥è¿«éœ€è¦å…±äº«å­˜å‚¨, è¿™é‡Œç®€å•åº”ç”¨k8s storageclass nfså’Œrbdå­˜å‚¨
ç¬¬ä¸€éƒ¨åˆ† nfs è¿™é‡Œå•èŠ‚ç‚¹ç®€å•é…ç½®nfs(é«˜å¹¶å‘å¯é‡‡ç”¨nfs+rsync+inotifyæˆ–Sersync)  é«˜å¹¶å‘å‚è€ƒ
 NFSé«˜å¯ç”¨(NFS+keepalive+Sersync) inotify+rsyncå®æ—¶å¤‡ä»½æ€»ç»“
#å®‰è£…nfs yum install -y nfs-utils rpcbind # åˆ›å»ºç›®å½• mkdir /data/nfs echo &amp;quot;/data/nfs 192.168.0.0/24(rw,sync,no_root_squash) &amp;quot; &amp;gt;&amp;gt;/etc/exports # å¯åŠ¨æœåŠ¡ systemctl start rpcbind systemctl start nfs k8séƒ¨ç½²storageclassç¯å¢ƒ-nfs å¯¼å…¥å¤–éƒ¨é…ç½® git clone https://github.com/kubernetes-incubator/external-storage.git cd external-storage/nfs-client/deploy #æ³¨æ„ 1 nodeèŠ‚ç‚¹éœ€è¦å®‰è£…nfs-utils(centos7),nfs-common(ubuntu) ä¿®æ”¹deployment.yaml apiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner --- kind: Deployment apiVersion: extensions/v1beta1 metadata: name: nfs-client-provisioner spec: replicas: 1 strategy: type: Recreate template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.</description>
			<content type="html"><![CDATA[<p>è€ƒè™‘åˆ°k8så­˜å‚¨çš„é—®é¢˜, æœ¬æœºç›®å½•æŒ‚è½½å­˜åœ¨å¤ªå¤§å±€é™æ€§, å¤šnodeå¤špodçš„æœåŠ¡å­˜å‚¨æ€¥è¿«éœ€è¦å…±äº«å­˜å‚¨, è¿™é‡Œç®€å•åº”ç”¨k8s storageclass nfså’Œrbdå­˜å‚¨</p>
<!-- more -->
<h1 id="ç¬¬ä¸€éƒ¨åˆ†-nfs">ç¬¬ä¸€éƒ¨åˆ† nfs</h1>
<h3 id="è¿™é‡Œå•èŠ‚ç‚¹ç®€å•é…ç½®nfsé«˜å¹¶å‘å¯é‡‡ç”¨nfsrsyncinotifyæˆ–sersync">è¿™é‡Œå•èŠ‚ç‚¹ç®€å•é…ç½®nfs(é«˜å¹¶å‘å¯é‡‡ç”¨nfs+rsync+inotifyæˆ–Sersync)</h3>
<blockquote>
<p>é«˜å¹¶å‘å‚è€ƒ</p>
</blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1445884">NFSé«˜å¯ç”¨(NFS+keepalive+Sersync)</a>
<a href="https://blog.51cto.com/lzhnb/2088224">inotify+rsyncå®æ—¶å¤‡ä»½æ€»ç»“</a></p>
<pre><code>#å®‰è£…nfs
yum install -y nfs-utils rpcbind

# åˆ›å»ºç›®å½•
mkdir /data/nfs
echo &quot;/data/nfs 192.168.0.0/24(rw,sync,no_root_squash) &quot; &gt;&gt;/etc/exports

# å¯åŠ¨æœåŠ¡
systemctl start rpcbind
systemctl start nfs
</code></pre><h3 id="k8séƒ¨ç½²storageclassç¯å¢ƒ-nfs">k8séƒ¨ç½²storageclassç¯å¢ƒ-nfs</h3>
<h4 id="å¯¼å…¥å¤–éƒ¨é…ç½®">å¯¼å…¥å¤–éƒ¨é…ç½®</h4>
<pre><code>git clone https://github.com/kubernetes-incubator/external-storage.git
cd external-storage/nfs-client/deploy

#æ³¨æ„
1  nodeèŠ‚ç‚¹éœ€è¦å®‰è£…nfs-utils(centos7),nfs-common(ubuntu)
</code></pre><h4 id="ä¿®æ”¹deploymentyaml">ä¿®æ”¹deployment.yaml</h4>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
---
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: nfs-client-provisioner
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: quay.io/external_storage/nfs-client-provisioner:latest
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: nfs.com/nfs
            - name: NFS_SERVER
              value: 192.168.0.134
            - name: NFS_PATH
              value: /data/nfs
      volumes:
        - name: nfs-client-root
          nfs:
            server: 192.168.0.134
            path: /data/nfs
</code></pre><h4 id="ä¿®æ”¹classyaml">ä¿®æ”¹class.yaml</h4>
<pre><code>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs
provisioner: nfs.com/nfs
parameters:
  archiveOnDelete: &quot;false&quot;
</code></pre><h4 id="rbacyamlä¸ç”¨ä¿®æ”¹">rbac.yamlä¸ç”¨ä¿®æ”¹</h4>
<pre><code>rbac.yaml
kind: ServiceAccount
apiVersion: v1
metadata:
  name: nfs-client-provisioner
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;persistentvolumes&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;persistentvolumeclaims&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]
  - apiGroups: [&quot;storage.k8s.io&quot;]
    resources: [&quot;storageclasses&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;events&quot;]
    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;endpoints&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: default
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io
</code></pre><h4 id="éƒ¨ç½²nfsç¯å¢ƒåˆ›å»ºnfså­˜å‚¨ç±»">éƒ¨ç½²nfsç¯å¢ƒ(åˆ›å»ºnfså­˜å‚¨ç±»)</h4>
<pre><code>kubectl apply -f rbac.yaml -f class.yaml -f deployment.yaml
</code></pre><hr>
<h3 id="k8sä¸­éƒ¨ç½²nginxé¡¹ç›®é‡‡ç”¨nfså­˜å‚¨">k8sä¸­éƒ¨ç½²nginxé¡¹ç›®é‡‡ç”¨nfså­˜å‚¨</h3>
<h4 id="éƒ¨ç½²nginx-deployment-nfsyamlæµ‹è¯•nfs">éƒ¨ç½²nginx-deployment-nfs.yaml(æµ‹è¯•nfs)</h4>
<blockquote>
<p>è¿™ç§æ–¹å¼ä¼šåˆ›å»ºä¸€ä¸ªpvc æŒ‚è½½åˆ°å¤šä¸ªpodä¸­,è¿™ç§æ–¹å¼é€‚åˆnginx-htmlæŒ‚è½½</p>
</blockquote>
<pre><code>---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: html0-deploy-nfs
  annotations:
    volume.beta.kubernetes.io/storage-class: 'nfs'
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx0-deploy
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx0-deploy
    spec:
      containers:
      - name: nginx0-deploy
        image: hub.zhangzw.com/bq/nginx:1.15.12
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html0-deploy-nfs
          mountPath: /usr/share/nginx/html
        - name: nginx-config
          mountPath: &quot;/etc/nginx/conf.d&quot;
      volumes:
      - name: nginx-config
        configMap:
            name: nginx-config
      - name: html0-deploy-nfs
        persistentVolumeClaim:
          claimName: html0-deploy-nfs
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  default.conf: |
            server {
              listen       80;
              server_name  localhost;
              root   /usr/share/nginx/html/;
              access_log  /var/log/nginx/host_access.log;
              error_log  /var/log/nginx/host_error.log debug;
              location / {
                  root   /usr/share/nginx/html/;
                  index  index.html index.htm index.php;
              }
              error_page   500 502 503 504  /50x.html;

              location = /50x.html {
                  root   /usr/share/nginx/html;
              }
              }
</code></pre><h4 id="éƒ¨ç½²nginx-statefulset-nfsyamlæµ‹è¯•nfs">éƒ¨ç½²nginx-statefulset-nfs.yaml(æµ‹è¯•nfs)</h4>
<blockquote>
<p>è¿™é‡Œstatefulset æ–¹å¼ä¼šåˆ›å»ºå¤šä¸ªpvc, æ¯ä¸ªpodçš„htmlå°±å¯ä»¥éƒ½ä¸ä¸€æ ·!</p>
</blockquote>
<pre><code>---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: nginx3
spec:
  serviceName: &quot;nginx&quot;
  replicas: 2
  volumeClaimTemplates:
  - metadata:
      name: html
      annotations:
        volume.beta.kubernetes.io/storage-class: &quot;nfs&quot; # è¿™é‡Œé…ç½® ä¸Šé¢åˆ›å»ºçš„ storageclass çš„åç§°
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 2Gi
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: hub.zhangzw.com/bq/nginx:1.15.12
        volumeMounts:
        - mountPath: &quot;/usr/share/nginx/html/&quot;
          name: html
        - mountPath: &quot;/etc/nginx/conf.d&quot;
          name: nginx-config
      volumes:
      - name: nginx-config
        configMap:
            name: nginx-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  default.conf: |
            server {
              listen       80;
              server_name  localhost;
              root   /usr/share/nginx/html/;
              access_log  /var/log/nginx/host_access.log;
              error_log  /var/log/nginx/host_error.log debug;
              location / {
                  root   /usr/share/nginx/html/;
                  index  index.html index.htm index.php;
              }
              error_page   500 502 503 504  /50x.html;

              location = /50x.html {
                  root   /usr/share/nginx/html;
              }
              }
</code></pre><hr>
<h3 id="å¦å¤–è¯´æ˜ä¸€ä¸‹å°†nfsä½œä¸ºæ–‡ä»¶å­˜å‚¨ç±»ä¼¼mountæ–¹å¼è¿™ç§æ–¹å¼ä¸é€‚ç”¨äºå¤šå®¹å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²-æ˜¾ç„¶è¿™ç§å¹¶ä¸é€‚åˆceph-rbdå­˜å‚¨-cephfsæ˜¯å¯ä»¥çš„">å¦å¤–è¯´æ˜ä¸€ä¸‹å°†nfsä½œä¸ºæ–‡ä»¶å­˜å‚¨ç±»ä¼¼mountæ–¹å¼,è¿™ç§æ–¹å¼ä¸é€‚ç”¨äºå¤šå®¹å™¨è‡ªåŠ¨åŒ–éƒ¨ç½² ,æ˜¾ç„¶è¿™ç§å¹¶ä¸é€‚åˆceph rbdå­˜å‚¨, cephfsæ˜¯å¯ä»¥çš„</h3>
<h4 id="é¦–å…ˆéœ€è¦åœ¨nfsç›®å½•åˆ›å»ºéœ€è¦æŒ‚è½½çš„ç›®å½•">é¦–å…ˆéœ€è¦åœ¨nfsç›®å½•åˆ›å»ºéœ€è¦æŒ‚è½½çš„ç›®å½•</h4>
<pre><code>#ä¾‹å¦‚
mkdir -p /data/nfs/k8s-db-t/mysql-data-dev
</code></pre><h4 id="åœ¨éƒ¨ç½²çš„ymlä¸­ç›´æ¥mount-nfsçš„ç›®å½•">åœ¨éƒ¨ç½²çš„ymlä¸­ç›´æ¥mount nfsçš„ç›®å½•</h4>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql-server
  namespace: devops
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql-server
    spec:
      containers:
      - image: mysql:5.7.16
        imagePullPolicy: Always
        name: mysql-server
        ports:
        - containerPort: 3306
          protocol: TCP
        volumeMounts:
          - name: mysql-data
            mountPath: /var/lib/mysql
        resources:
          requests:
            cpu: 40m
            memory: 32Mi
          limits:
            cpu: &quot;300m&quot;
            memory: 256Mi
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: &quot;admin&quot;
        - name: MYSQL_DATABASE
          value: &quot;gogs&quot;
        - name: MYSQL_USER
          value: &quot;gogs&quot;
        - name: MYSQL_PASSWORD
          value: &quot;gogspass&quot;
        - name: TZ
          value: &quot;Asia/Shanghai&quot;
      volumes:
        - name: mysql-data
          nfs:
            server: 192.168.0.134
            path: /data/nfs/k8s-db-t/mysql-data-dev

---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: devops
spec:
  clusterIP: None
  selector:
    app: mysql-server
  ports:
  - name: http
    port: 3306
</code></pre><hr>
<h1 id="ç¬¬äºŒéƒ¨åˆ†-ceph">ç¬¬äºŒéƒ¨åˆ† ceph</h1>
<h3 id="k8séƒ¨ç½²storageclassç¯å¢ƒ-ceph">k8séƒ¨ç½²storageclassç¯å¢ƒ-ceph</h3>
<h4 id="å¦‚æœé›†ç¾¤æ˜¯ç”¨kubeadméƒ¨ç½²çš„ç”±äºcontroller-managerå®˜æ–¹é•œåƒä¸­æ²¡æœ‰rbdå‘½ä»¤æ‰€ä»¥æˆ‘ä»¬è¦å¯¼å…¥å¤–éƒ¨é…ç½®">å¦‚æœé›†ç¾¤æ˜¯ç”¨kubeadméƒ¨ç½²çš„ï¼Œç”±äºcontroller-managerå®˜æ–¹é•œåƒä¸­æ²¡æœ‰rbdå‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¼å…¥å¤–éƒ¨é…ç½®</h4>
<pre><code>git clone https://github.com/kubernetes-incubator/external-storage.git
cd external-storage/ceph/rbd/deploy
</code></pre><blockquote>
<p>ä»¥ä¸‹æ•´åˆåœ¨ä¸€ä¸ªæ–‡ä»¶, ä¸¤ä¸ªç‰ˆæœ¬,é»˜è®¤ å’Œretain</p>
</blockquote>
<h4 id="storageclass-cepmcom-rbdyaml">storageclass-cepm.com-rbd.yaml</h4>
<pre><code>---
apiVersion: v1
data:
  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==
kind: Secret
metadata:
  name: ceph-secret-admin
type: kubernetes.io/rbd
---
apiVersion: v1
data:
  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==
kind: Secret
metadata:
  name: ceph-secret-admin
  namespace: ns-elastic
type: kubernetes.io/rbd
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rbd
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;
provisioner: ceph.com/rbd
parameters:
  monitors: 192.168.0.134:6789
  adminId: admin
  adminSecretName: ceph-secret-admin
  adminSecretNamespace: default
  pool: storageclass-rbd
  userId: admin
  userSecretName: ceph-secret-admin
  fsType: ext4
  imageFormat: &quot;2&quot;
  imageFeatures: &quot;layering&quot;
</code></pre><h4 id="storageclass-cepmcom-rbd-retainyaml">storageclass-cepm.com-rbd-retain.yaml</h4>
<pre><code>---
apiVersion: v1
data:
  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==
kind: Secret
metadata:
  name: ceph-secret-admin
type: kubernetes.io/rbd
---
apiVersion: v1
data:
  key: QVFEYzJRbGQ1VjI5THhBQU00WUtPUU5sUVJqdWtLSWJ2VDZ0a3c9PQ==
kind: Secret
metadata:
  name: ceph-secret-admin
  namespace: ns-elastic
type: kubernetes.io/rbd
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rbd-retain
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;false&quot;
provisioner: ceph.com/rbd
reclaimPolicy: Retain
parameters:
  monitors: 192.168.0.134:6789
  adminId: admin
  adminSecretName: ceph-secret-admin
  adminSecretNamespace: default
  pool: storageclass-rbd-retain
  userId: admin
  userSecretName: ceph-secret-admin
  fsType: ext4
  imageFormat: &quot;2&quot;
  imageFeatures: &quot;layering&quot;
</code></pre><h4 id="k8sä¸­éƒ¨ç½²nginxé¡¹ç›®é‡‡ç”¨-cephcomrbd-å’Œnfsç±»ä¼¼-è¿™é‡Œçœç•¥">k8sä¸­éƒ¨ç½²nginxé¡¹ç›®é‡‡ç”¨ ceph.com/rbd å’Œnfsç±»ä¼¼, è¿™é‡Œçœç•¥</h4>
<blockquote>
<p>ä»¥ä¸Šé‡‡ç”¨çš„æ˜¯persistentVolumeClaim æ–¹å¼åŠ¨æ€åˆ†é…å…¨éƒ¨å†…å®¹</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>cephå®‰è£…éƒ¨ç½²</title>
			<link>https://www.ngirl.xyz/posts/6-ceph%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</link>
			<pubDate>Thu, 26 Sep 2019 11:13:40 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/6-ceph%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</guid>
			<description>Cephæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œè®¾è®¡åˆè¡·æ˜¯æä¾›è¾ƒå¥½çš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚
ç®€å•äº†è§£ä»€ä¹ˆæ˜¯å—å­˜å‚¨/å¯¹è±¡å­˜å‚¨/æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼Ÿ ceph ç›®å‰æä¾›å¯¹è±¡å­˜å‚¨ï¼ˆRADOSGWï¼‰ã€å—å­˜å‚¨RDBä»¥åŠ CephFS æ–‡ä»¶ç³»ç»Ÿè¿™ 3 ç§åŠŸèƒ½ã€‚å¯¹äºè¿™3ç§åŠŸèƒ½ä»‹ç»ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š
  å¯¹è±¡å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ„ä¹‰çš„é”®å€¼å­˜å‚¨ï¼Œå…¶æ¥å£å°±æ˜¯ç®€å•çš„GETã€PUTã€DEL å’Œå…¶ä»–æ‰©å±•ï¼Œä»£è¡¨ä¸»è¦æœ‰ Swift ã€S3 ä»¥åŠ Gluster ç­‰ï¼›
  å—å­˜å‚¨ï¼Œè¿™ç§æ¥å£é€šå¸¸ä»¥ QEMU Driver æˆ–è€… Kernel Module çš„æ–¹å¼å­˜åœ¨ï¼Œè¿™ç§æ¥å£éœ€è¦å®ç° Linux çš„ Block Device çš„æ¥å£æˆ–è€… QEMU æä¾›çš„ Block Driver æ¥å£ï¼Œå¦‚ Sheepdogï¼ŒAWS çš„ EBSï¼Œé’äº‘çš„äº‘ç¡¬ç›˜å’Œé˜¿é‡Œäº‘çš„ç›˜å¤ç³»ç»Ÿï¼Œè¿˜æœ‰ Ceph çš„ RBDï¼ˆRBDæ˜¯Cephé¢å‘å—å­˜å‚¨çš„æ¥å£ï¼‰ã€‚åœ¨å¸¸è§çš„å­˜å‚¨ä¸­ DASã€SAN æä¾›çš„ä¹Ÿæ˜¯å—å­˜å‚¨ï¼›
  æ–‡ä»¶å­˜å‚¨ï¼Œé€šå¸¸æ„ä¹‰æ˜¯æ”¯æŒ POSIX æ¥å£ï¼Œå®ƒè·Ÿä¼ ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå¦‚ Ext4 æ˜¯ä¸€ä¸ªç±»å‹çš„ï¼Œä½†åŒºåˆ«åœ¨äºåˆ†å¸ƒå¼å­˜å‚¨æä¾›äº†å¹¶è¡ŒåŒ–çš„èƒ½åŠ›ï¼Œå¦‚ Ceph çš„ CephFS (CephFSæ˜¯Cephé¢å‘æ–‡ä»¶å­˜å‚¨çš„æ¥å£)ï¼Œä½†æ˜¯æœ‰æ—¶å€™åˆä¼šæŠŠ GlusterFS ï¼ŒHDFS è¿™ç§éPOSIXæ¥å£çš„ç±»æ–‡ä»¶å­˜å‚¨æ¥å£å½’å…¥æ­¤ç±»ã€‚å½“ç„¶ NFSã€NASä¹Ÿæ˜¯å±äºæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼›
  å‚è€ƒæ•™ç¨‹ Kubernetes é›†æˆ Ceph åç«¯å­˜å‚¨æ•™ç¨‹ centos7å®‰è£…cephé›†ç¾¤
å‡†å¤‡ é…ç½®æº cat &amp;gt;/etc/yum.</description>
			<content type="html"><![CDATA[<p>Cephæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œè®¾è®¡åˆè¡·æ˜¯æä¾›è¾ƒå¥½çš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<!-- more-->
<h3 id="ç®€å•äº†è§£ä»€ä¹ˆæ˜¯å—å­˜å‚¨å¯¹è±¡å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨">ç®€å•äº†è§£ä»€ä¹ˆæ˜¯å—å­˜å‚¨/å¯¹è±¡å­˜å‚¨/æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼Ÿ</h3>
<p>ceph ç›®å‰æä¾›å¯¹è±¡å­˜å‚¨ï¼ˆRADOSGWï¼‰ã€å—å­˜å‚¨RDBä»¥åŠ CephFS æ–‡ä»¶ç³»ç»Ÿè¿™ 3 ç§åŠŸèƒ½ã€‚å¯¹äºè¿™3ç§åŠŸèƒ½ä»‹ç»ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>å¯¹è±¡å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ„ä¹‰çš„é”®å€¼å­˜å‚¨ï¼Œå…¶æ¥å£å°±æ˜¯ç®€å•çš„GETã€PUTã€DEL å’Œå…¶ä»–æ‰©å±•ï¼Œä»£è¡¨ä¸»è¦æœ‰ Swift ã€S3 ä»¥åŠ Gluster ç­‰ï¼›</p>
</li>
<li>
<p>å—å­˜å‚¨ï¼Œè¿™ç§æ¥å£é€šå¸¸ä»¥ QEMU Driver æˆ–è€… Kernel Module çš„æ–¹å¼å­˜åœ¨ï¼Œè¿™ç§æ¥å£éœ€è¦å®ç° Linux çš„ Block Device çš„æ¥å£æˆ–è€… QEMU æä¾›çš„ Block Driver æ¥å£ï¼Œå¦‚ Sheepdogï¼ŒAWS çš„ EBSï¼Œé’äº‘çš„äº‘ç¡¬ç›˜å’Œé˜¿é‡Œäº‘çš„ç›˜å¤ç³»ç»Ÿï¼Œè¿˜æœ‰ Ceph çš„ RBDï¼ˆRBDæ˜¯Cephé¢å‘å—å­˜å‚¨çš„æ¥å£ï¼‰ã€‚åœ¨å¸¸è§çš„å­˜å‚¨ä¸­ DASã€SAN æä¾›çš„ä¹Ÿæ˜¯å—å­˜å‚¨ï¼›</p>
</li>
<li>
<p>æ–‡ä»¶å­˜å‚¨ï¼Œé€šå¸¸æ„ä¹‰æ˜¯æ”¯æŒ POSIX æ¥å£ï¼Œå®ƒè·Ÿä¼ ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå¦‚ Ext4 æ˜¯ä¸€ä¸ªç±»å‹çš„ï¼Œä½†åŒºåˆ«åœ¨äºåˆ†å¸ƒå¼å­˜å‚¨æä¾›äº†å¹¶è¡ŒåŒ–çš„èƒ½åŠ›ï¼Œå¦‚ Ceph çš„ CephFS (CephFSæ˜¯Cephé¢å‘æ–‡ä»¶å­˜å‚¨çš„æ¥å£)ï¼Œä½†æ˜¯æœ‰æ—¶å€™åˆä¼šæŠŠ GlusterFS ï¼ŒHDFS è¿™ç§éPOSIXæ¥å£çš„ç±»æ–‡ä»¶å­˜å‚¨æ¥å£å½’å…¥æ­¤ç±»ã€‚å½“ç„¶ NFSã€NASä¹Ÿæ˜¯å±äºæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼›</p>
</li>
</ol>
<h3 id="å‚è€ƒæ•™ç¨‹">å‚è€ƒæ•™ç¨‹</h3>
<p><a href="https://blog.csdn.net/shida_csdn/article/details/78579043">Kubernetes é›†æˆ Ceph åç«¯å­˜å‚¨æ•™ç¨‹</a>
<a href="https://blog.csdn.net/zcc_heu/article/details/79017624">centos7å®‰è£…cephé›†ç¾¤</a></p>
<h3 id="å‡†å¤‡">å‡†å¤‡</h3>
<h4 id="é…ç½®æº">é…ç½®æº</h4>
<pre><code>cat &gt;/etc/yum.repos.d/ceph.repo&lt;&lt;EOF
[ceph]
name=ceph
baseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/
gpgcheck=0
priority=1

[ceph-noarch]
name=cephnoarch
baseurl=http://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/
gpgcheck=0
priority=1

[ceph-source]
name=Ceph source packages
baseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/SRPMS
enabled=0
gpgcheck=1
type=rpm-md
gpgkey=http://mirrors.163.com/ceph/keys/release.asc
priority=1
EOF

</code></pre><h4 id="å®‰è£…è¿‡å¸è½½">å®‰è£…è¿‡å¸è½½</h4>
<pre><code>ceph-deploy purge dk1-t dk2-t
ceph-deploy purgedata dk1-t dk2-t
ceph-deploy forgetkeys

</code></pre><h3 id="åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤-monæ¨¡å—">åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤ monæ¨¡å—</h3>
<pre><code>yum install ceph-deploy -y
ceph-deploy --version

mkdir /data/ceph
cd /data/ceph
ceph-deploy new dk2-t

# æŸ¥çœ‹é…ç½®æ–‡ä»¶
ls -l

# é…ç½®ceph.conf
[global]
...
# å¦‚æœæœ‰å¤šä¸ªç½‘å¡ï¼Œåº”è¯¥é…ç½®å¦‚ä¸‹é€‰é¡¹ï¼Œ
# public networkæ˜¯å…¬å…±ç½‘ç»œï¼Œè´Ÿè´£é›†ç¾¤å¯¹å¤–æä¾›æœåŠ¡çš„æµé‡
# cluster networkæ˜¯é›†ç¾¤ç½‘ç»œï¼Œè´Ÿè½½é›†ç¾¤ä¸­æ•°æ®å¤åˆ¶ä¼ è¾“é€šä¿¡ç­‰
# æœ¬æ¬¡å®éªŒä½¿ç”¨åŒä¸€å—ç½‘å¡ï¼Œç”Ÿå¢ƒç¯å¢ƒå»ºè®®åˆ†åˆ«ä½¿ç”¨ä¸€å—ç½‘å¡
public network = 192.168.0.0/22
cluster network = 192.168.0.0/22
osd pool default size = 2


# å®‰è£… ceph åŒ…
# å¦‚æœæŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®‰è£…æ–¹æ³• ä¼šé‡æ–°é…ç½®å®‰è£…å®˜æ–¹cephæº
# ç”±äºç½‘ç»œé—®é¢˜ï¼Œå®‰è£…å¯èƒ½ä¼šå‡ºé”™ï¼Œéœ€è¦å¤šæ¬¡æ‰§è¡Œ
# ceph-deploy install å…¶å®åªæ˜¯ä¼šå®‰è£… ceph ceph-radosgw ä¸¤ä¸ªåŒ…
# ceph-deploy install lab1 lab2 lab3
# æ¨èä½¿ç”¨é˜¿é‡Œæºå®‰è£…ï¼Œå› ä¸ºä½¿ç”¨ceph-deployå®‰è£…ä¼šå¾ˆæ…¢
# ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨å®‰è£…åŒ…ï¼Œæ›¿ä»£å®˜æ–¹çš„ ceph-deploy install å‘½ä»¤
# å¦‚ä¸‹æ“ä½œåœ¨æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œ
export CEPH_DEPLOY_REPO_URL=http://mirrors.163.com/ceph/rpm-luminous/el7
export CEPH_DEPLOY_GPG_URL=http://mirrors.163.com/ceph/keys/release.asc

# å…ˆæ‰§è¡Œæ˜¯å› ä¸º ceph-deploy installå¤ªæ…¢
yum install -y ceph ceph-radosgw
ceph-deploy install dk2-t


# éƒ¨ç½²monitorå’Œç”Ÿæˆkeys
ceph-deploy mon create-initial
ls -l *.keyring

# å¤åˆ¶æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹
ceph-deploy dk1-t dk2-t

# é¢å¤–monèŠ‚ç‚¹ï¼ŒmonèŠ‚ç‚¹ä¹Ÿéœ€è¦é«˜å¯ç”¨
ceph-deploy mon add dk1-t
</code></pre><h3 id="åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤-mgræ¨¡å—">åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤ mgræ¨¡å—</h3>
<pre><code># éƒ¨ç½²manager ï¼ˆluminous+ï¼‰12åŠä»¥åçš„ç‰ˆæœ¬éœ€è¦éƒ¨ç½²
# æœ¬æ¬¡éƒ¨ç½² jewel ç‰ˆæœ¬ ï¼Œä¸éœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
 ceph-deploy mgr create dk2-t
</code></pre><h3 id="åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤-osdæ¨¡å—">åœ¨dk2-tèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤ osdæ¨¡å—</h3>
<pre><code># 12çš„ç‰ˆæœ¬(è¿™é‡ŒæŒ‚è½½ä¸€ä¸ª 10Gçš„ç£ç›˜ /dev/sdb)
# create å‘½ä»¤ä¸€æ¬¡å®Œæˆå‡†å¤‡ OSD ã€éƒ¨ç½²åˆ° OSD èŠ‚ç‚¹ã€å¹¶æ¿€æ´»å®ƒã€‚ create å‘½ä»¤æ˜¯ä¾æ¬¡æ‰§è¡Œ prepare å’Œ activate å‘½ä»¤çš„æ·å¾„ã€‚
ceph-deploy osd create --data /dev/sdb dk2-t
ceph-deploy osd create --data /dev/sdc dk1-t
</code></pre><h3 id="å¦‚ä½•å¸è½½osd">å¦‚ä½•å¸è½½osd</h3>
<pre><code># æŸ¥çœ‹
ceph osd tree

# èŠ‚ç‚¹çŠ¶æ€æ ‡è®°ä¸ºout
ceph osd out osd.0

# ä»crushä¸­ç§»é™¤èŠ‚ç‚¹
ceph osd crush remove osd.0

# åˆ é™¤èŠ‚ç‚¹
ceph osd rm osd.0

# åˆ é™¤èŠ‚ç‚¹è®¤è¯ï¼ˆä¸åˆ é™¤ç¼–å·ä¼šå ä½ï¼‰
ceph auth del osd.0
</code></pre><h4 id="æŸ¥çœ‹-mon-ä¿¡æ¯">æŸ¥çœ‹ mon ä¿¡æ¯</h4>
<pre><code>ceph mon dump

dumped monmap epoch 1
epoch 1
fsid 4620d0c7-4458-4ff9-9296-d1318058bafc
last_changed 2019-06-19 14:44:41.361005
created 2019-06-19 14:44:41.361005
0: 192.168.0.134:6789/0 mon.dk2-t
</code></pre><h4 id="é…ç½®æ–‡ä»¶å†…å®¹-etccephcephconf">é…ç½®æ–‡ä»¶å†…å®¹ /etc/ceph/ceph.conf</h4>
<pre><code>[global]
public network = 192.168.0.0/22
cluster network = 192.168.0.0/22
osd pool default size = 2
fsid = 4620d0c7-4458-4ff9-9296-d1318058bafc
mon_initial_members = dk2-t
mon_host = 192.168.0.134
auth_cluster_required = cephx
auth_service_required = cephx
auth_client_required = cephx
mon_max_pg_per_osd = 1000
</code></pre><h3 id="ceph-ä¸€äº›æµ‹è¯•å‘½ä»¤">ceph ä¸€äº›æµ‹è¯•å‘½ä»¤</h3>
<h4 id="åˆ›å»º-rbd-poolåå­—å«åš-kube">åˆ›å»º rbd poolï¼Œåå­—å«åš kube</h4>
<pre><code>ceph osd pool create kube 256 256
</code></pre><h4 id="å¦‚ä½•å–å¾—adminçš„å¯†é’¥">å¦‚ä½•å–å¾—adminçš„å¯†é’¥</h4>
<pre><code>ceph auth get client.admin 2&gt;&amp;1 |grep &quot;key = &quot; |awk '{print  $3}'
AQAn/19bbb21GBAA1kc0HRWoGjeoPTRQziA03A==
</code></pre><h4 id="æµ‹è¯•cephæ˜¯å¦æ­£å¸¸">æµ‹è¯•cephæ˜¯å¦æ­£å¸¸</h4>
<pre><code>rbd create kube/test --size 1024 --image-format 2
rbd ls kube
rbd map kube/test
    # å¦‚æœæŠ¥é”™, è­¦ç”¨
    rbd info kube/test
    rbd feature disable kube/test exclusive-lock object-map fast-diff deep-flatten

rbd map kube/test
rbd showmapped
mkfs.ext4 /dev/rbd0
mkdir /data/rbd0
mount /dev/rbd0 /data/rbd0
cd /data/rbd0 &amp;&amp; echo test &gt; test.txt

</code></pre><hr>
<h3 id="åœ¨k8s-æ‰‹åŠ¨åˆ›å»ºå­˜å‚¨ç±»">åœ¨k8s æ‰‹åŠ¨åˆ›å»ºå­˜å‚¨ç±»</h3>
<h4 id="åˆ›å»ºceph-pg">åˆ›å»ºceph pg</h4>
<pre><code># Total PGs = (Total_number_of_OSD * 100) / max_replication_count
# pg = 1 * 100 /2 ~ 64(å–2çš„æ¬¡æ–¹æ•°)

# è¿™é‡Œå‡†å¤‡åˆ›å»º2ä¸ªpool, æ¯ä¸ªpool
ceph osd pool create rbd-k8s 16

# æŸ¥çœ‹
ceph osd lspools

# åˆ›å»ºimage
rbd create rbd-k8s/cephimageredis --size 500M

# æŸ¥çœ‹list
rbd list rbd-k8s

# å¤„ç†æ–°ç‰¹æ€§
# æŸ¥çœ‹info
rbd info rbd-k8s/cephimageredis

# å…³é—­exclusive-lock object-map fast-diff deep-flatten è¿™äº›ç‰¹æ€§
rbd feature disable  rbd-k8s/cephimageredis exclusive-lock object-map fast-diff deep-flatten
</code></pre><h4 id="é¦–å…ˆåˆ›å»ºsecret">é¦–å…ˆåˆ›å»ºsecret</h4>
<pre><code>#è·å–key
grep key /etc/ceph/ceph.client.admin.keyring |awk '{printf &quot;%s&quot;, $NF}'|base64
</code></pre><ul>
<li><strong>ceph-secret.yaml</strong></li>
</ul>
<pre><code>apiVersion: v1
kind: Secret
metadata:
  name: ceph-secret
type: &quot;kubernetes.io/rbd&quot;
data:
  key: QVFCTFo2dGNGNXFLRnhBQXBGTXJEdm5CY2k2UGtwZmZrN0JSVEE9PQ==
</code></pre><h4 id="å…¶æ¬¡åˆ›å»ºpv-pvæ˜¯æ²¡æœ‰namespaceæ¦‚å¿µçš„">å…¶æ¬¡åˆ›å»ºpv, pvæ˜¯æ²¡æœ‰namespaceæ¦‚å¿µçš„</h4>
<blockquote>
<p>persistentVolumeReclaimPolicyæ˜¯æ¸…ç†è§„åˆ™ (retain: ä¸æ¸…ç†, Recycle: å›æ”¶)</p>
</blockquote>
<ul>
<li><strong>redis-ceph-pv.yml</strong></li>
</ul>
<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis2-ceph-rbd-pv
spec:
  capacity:
    storage: 100Mi
  accessModes:
    - ReadWriteOnce
  rbd:
    monitors:
      - '192.168.0.134:6789'
    pool: rbd-k8s
    image: cephimageredis
    user: admin
    secretRef:
      name: ceph-secret
    fsType: ext4
    readOnly: false
  persistentVolumeReclaimPolicy: Recycle
</code></pre><ul>
<li><strong>æ‰§è¡Œéƒ¨ç½²pv</strong></li>
</ul>
<pre><code>kubectl create -f redis-ceph-pv.yml
</code></pre><h4 id="ç„¶ååˆ›å»ºpvc">ç„¶ååˆ›å»ºpvc</h4>
<ul>
<li><strong>redis-ceph-pvc.yml</strong></li>
</ul>
<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis2-ceph-rbd-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi
</code></pre><ul>
<li><strong>æ‰§è¡Œéƒ¨ç½²pvc</strong></li>
</ul>
<pre><code>kubectl create -f redis-ceph-pvc.yml
</code></pre><h4 id="æœ€ååœ¨rancherä¸Šé€‰æ‹©æŒ‚è½½rbd">æœ€ååœ¨rancherä¸Šé€‰æ‹©æŒ‚è½½rbd</h4>
<p><img src="https://zhangzw001.github.io/images/blog6/rancher-pv.png" alt="rancher-pv"></p>
<hr>
]]></content>
		</item>
		
		<item>
			<title>hexoæ·»åŠ çœ‹æ¿å¨˜</title>
			<link>https://www.ngirl.xyz/posts/5-hexo%E6%B7%BB%E5%8A%A0%E7%9C%8B%E6%9D%BF%E5%A8%98/</link>
			<pubDate>Tue, 24 Sep 2019 17:46:17 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/5-hexo%E6%B7%BB%E5%8A%A0%E7%9C%8B%E6%9D%BF%E5%A8%98/</guid>
			<description>&lt;h3 id=&#34;hexo6-å·¦ä¸‹è§’æ·»åŠ çœ‹æ¿å¨˜&#34;&gt;hexo6 å·¦ä¸‹è§’æ·»åŠ çœ‹æ¿å¨˜&lt;/h3&gt;</description>
			<content type="html"><![CDATA[<h3 id="hexo6-å·¦ä¸‹è§’æ·»åŠ çœ‹æ¿å¨˜">hexo6 å·¦ä¸‹è§’æ·»åŠ çœ‹æ¿å¨˜</h3>
<p>githubåœ°å€: <a href="https://github.com/stevenjoezhang/live2d-widget">å¼ ä¹¦æ¨µå¤§ç¥</a></p>
<h3 id="ä¸‹è½½å¤§ç¥é¡¹ç›®-ä¼šè¯´è¯æ¢äººç‰©å°æ¸¸æˆç­‰åŠŸèƒ½">ä¸‹è½½å¤§ç¥é¡¹ç›® (ä¼šè¯´è¯,æ¢äººç‰©,å°æ¸¸æˆç­‰åŠŸèƒ½)</h3>
<pre><code>cd themes/nextv6/source
git clone https://github.com/stevenjoezhang/live2d-widget.git
</code></pre><h4 id="githubè¯´æ˜æ¯”è¾ƒè¯¦ç»†-è¿™é‡Œç®€å•è¯´æ˜">githubè¯´æ˜æ¯”è¾ƒè¯¦ç»†, è¿™é‡Œç®€å•è¯´æ˜</h4>
<blockquote>
<p>ç”±äºè¿™é‡Œæ˜¯å…‹éš†åˆ°äº†sourceç›®å½•, hexo d -gçš„æ—¶å€™ä¼šç”Ÿæˆåˆ°publicç›®å½•, ç›¸å½“äºç«™ç‚¹æ ¹ç›®å½•äº†</p>
</blockquote>
<pre><code># ç›´æ¥å¼€å¯autoload.jsæ³¨é‡Š
const live2d_path = &quot;/live2d-widget/&quot;;

# ä¿®æ”¹ themes/nextv6/layout/_layout.swig, æœ€åä¸€è¡Œæ·»åŠ å¦‚ä¸‹
&lt;!-- çœ‹æ¿å¨˜ --&gt;
&lt;script src=&quot;/live2d-widget/autoload.js&quot;&gt;&lt;/script&gt;
</code></pre><h3 id="ä¸€èˆ¬å°ç™½ç®€å•æ•™ç¨‹åªæœ‰çœ‹é¼ æ ‡æ–¹å‘åŠŸèƒ½">ä¸€èˆ¬å°ç™½ç®€å•æ•™ç¨‹(åªæœ‰çœ‹é¼ æ ‡æ–¹å‘åŠŸèƒ½)</h3>
<blockquote>
<p>hexo å®˜æ–¹æ”¯æŒç‰ˆ</p>
</blockquote>
<h4 id="éœ€è¦å®‰è£…æ¨¡æ¿">éœ€è¦å®‰è£…æ¨¡æ¿</h4>
<pre><code>npm install --save hexo-helper-live2d
</code></pre><h4 id="ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶">ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</h4>
<p><a href="https://blog.csdn.net/wang_123_zy/article/details/87181892#live2dwidgetmodelchitose_12">å„ç§å® ç‰©é¢„è§ˆ</a></p>
<pre><code># Live2D
## https://github.com/EYHN/hexo-helper-live2d
live2d:
  enable: true
  # enable: false
  scriptFrom: local # é»˜è®¤
  pluginRootPath: live2dw/ # æ’ä»¶åœ¨ç«™ç‚¹ä¸Šçš„æ ¹ç›®å½•(ç›¸å¯¹è·¯å¾„)
  pluginJsPath: lib/ # è„šæœ¬æ–‡ä»¶ç›¸å¯¹ä¸æ’ä»¶æ ¹ç›®å½•è·¯å¾„
  pluginModelPath: assets/ # æ¨¡å‹æ–‡ä»¶ç›¸å¯¹ä¸æ’ä»¶æ ¹ç›®å½•è·¯å¾„
  # scriptFrom: jsdelivr # jsdelivr CDN
  # scriptFrom: unpkg # unpkg CDN
  # scriptFrom: https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js # ä½ çš„è‡ªå®šä¹‰ url
  tagMode: false # æ ‡ç­¾æ¨¡å¼, æ˜¯å¦ä»…æ›¿æ¢ live2d tagæ ‡ç­¾è€Œéæ’å…¥åˆ°æ‰€æœ‰é¡µé¢ä¸­
  debug: false # è°ƒè¯•, æ˜¯å¦åœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—
  model:
    use: live2d-widget-model-haruto # npm-module package name
    # use: wanko # åšå®¢æ ¹ç›®å½•/live2d_models/ ä¸‹çš„ç›®å½•å
    # use: ./wives/wanko # ç›¸å¯¹äºåšå®¢æ ¹ç›®å½•çš„è·¯å¾„
    # use: https://cdn.jsdelivr.net/npm/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json # ä½ çš„è‡ªå®šä¹‰ url
  display:
    position: left
    width: 150
    height: 300
  mobile:
    show: true # æ‰‹æœºä¸­æ˜¯å¦å±•ç¤º
</code></pre>]]></content>
		</item>
		
		<item>
			<title>hexoé¼ æ ‡ç§»åŠ¨å’Œé¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ</title>
			<link>https://www.ngirl.xyz/posts/4-hexo%E9%BC%A0%E6%A0%87%E7%A7%BB%E5%8A%A8%E5%92%8C%E9%BC%A0%E6%A0%87%E7%82%B9%E5%87%BB%E7%89%B9%E6%95%88/</link>
			<pubDate>Tue, 24 Sep 2019 16:34:36 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/4-hexo%E9%BC%A0%E6%A0%87%E7%A7%BB%E5%8A%A8%E5%92%8C%E9%BC%A0%E6%A0%87%E7%82%B9%E5%87%BB%E7%89%B9%E6%95%88/</guid>
			<description>hexo6 é¼ æ ‡æ·»åŠ ç‚¹å‡»å‡ºç°æ¡ƒå¿ƒçš„ç‰¹æ•ˆ æ¥è‡ª: Nextä¸»é¢˜ä¸ªæ€§åŒ–
æ‰€éœ€è¦çš„jsæ–‡ä»¶  æœªå‹ç¼©  ! function(e, t, a) { function n() { c( &amp;quot;.heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: &#39;&#39;;width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}&amp;quot;), o(), r() } function r() { for (var e = 0; e &amp;lt; d.length; e++) d[e].alpha &amp;lt;= 0 ? (t.body.removeChild(d[e].el), d.splice(e, 1)) : (d[e].y--, d[e].scale += .004, d[e].alpha -= .013, d[e].el.style.cssText = &amp;quot;left:&amp;quot; + d[e].x + &amp;quot;px;top:&amp;quot; + d[e].</description>
			<content type="html"><![CDATA[<h3 id="hexo6-é¼ æ ‡æ·»åŠ ç‚¹å‡»å‡ºç°æ¡ƒå¿ƒçš„ç‰¹æ•ˆ">hexo6 é¼ æ ‡æ·»åŠ ç‚¹å‡»å‡ºç°æ¡ƒå¿ƒçš„ç‰¹æ•ˆ</h3>
 <!-- more -->
<p>æ¥è‡ª: <a href="https://www.writebug.site/2019/01/02/Next%E4%B8%BB%E9%A2%98%E4%B8%AA%E6%80%A7%E5%8C%96/">Nextä¸»é¢˜ä¸ªæ€§åŒ–</a></p>
<h4 id="æ‰€éœ€è¦çš„jsæ–‡ä»¶">æ‰€éœ€è¦çš„jsæ–‡ä»¶</h4>
<ul>
<li>æœªå‹ç¼©</li>
</ul>
<pre><code>! function(e, t, a) {
    function n() {
        c(
            &quot;.heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}&quot;), o(), r()
    }
    
    function r() {
        for (var e = 0; e &lt; d.length; e++) d[e].alpha &lt;= 0 ? (t.body.removeChild(d[e].el), d.splice(e, 1)) : (d[e].y--, d[e].scale += .004, d[e].alpha -= .013, d[e].el.style.cssText = &quot;left:&quot; + d[e].x + &quot;px;top:&quot; + d[e].y + &quot;px;opacity:&quot; + d[e].alpha + &quot;;transform:scale(&quot; + d[e].scale + &quot;,&quot; + d[e].scale + &quot;) rotate(45deg);background:&quot; + d[e].color + &quot;;z-index:99999&quot;);
        requestAnimationFrame(r)
    }
    
    function o() {
        var t = &quot;function&quot; == typeof e.onclick &amp;&amp; e.onclick;
        e.onclick = function(e) {
            t &amp;&amp; t(), i(e)
        }
    }
    
    function i(e) {
        var a = t.createElement(&quot;div&quot;);
        a.className = &quot;heart&quot;, d.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: s()
        }), t.body.appendChild(a)
    }

    function c(e) {
        var a = t.createElement(&quot;style&quot;);
        a.type = &quot;text/css&quot;;
        try {
            a.appendChild(t.createTextNode(e))
        } catch (t) {
            a.styleSheet.cssText = e
        }
        t.getElementsByTagName(&quot;head&quot;)[0].appendChild(a)
    }

    function s() {
        return &quot;rgb(&quot; + ~~(255 * Math.random()) + &quot;,&quot; + ~~(255 * Math.random()) + &quot;,&quot; + ~~(255 * Math.random()) + &quot;)&quot;
    }
    var d = [];
    e.requestAnimationFrame = function() {
        return e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function(e) {
            setTimeout(e, 1e3 / 60)
        }
    }(), n()
}(window, document);
</code></pre><ul>
<li>å‹ç¼©å</li>
</ul>
<pre><code>!function(e,t,a){function n(){c(&quot;.heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}&quot;),o(),r()}function r(){for(var e=0;e&lt;d.length;e++)d[e].alpha&lt;=0?(t.body.removeChild(d[e].el),d.splice(e,1)):(d[e].y--,d[e].scale+=.004,d[e].alpha-=.013,d[e].el.style.cssText=&quot;left:&quot;+d[e].x+&quot;px;top:&quot;+d[e].y+&quot;px;opacity:&quot;+d[e].alpha+&quot;;transform:scale(&quot;+d[e].scale+&quot;,&quot;+d[e].scale+&quot;) rotate(45deg);background:&quot;+d[e].color+&quot;;z-index:99999&quot;);requestAnimationFrame(r)}function o(){var t=&quot;function&quot;==typeof e.onclick&amp;&amp;e.onclick;e.onclick=function(e){t&amp;&amp;t(),i(e)}}function i(e){var a=t.createElement(&quot;div&quot;);a.className=&quot;heart&quot;,d.push({el:a,x:e.clientX-5,y:e.clientY-5,scale:1,alpha:1,color:s()}),t.body.appendChild(a)}function c(e){var a=t.createElement(&quot;style&quot;);a.type=&quot;text/css&quot;;try{a.appendChild(t.createTextNode(e))}catch(t){a.styleSheet.cssText=e}t.getElementsByTagName(&quot;head&quot;)[0].appendChild(a)}function s(){return&quot;rgb(&quot;+~~(255*Math.random())+&quot;,&quot;+~~(255*Math.random())+&quot;,&quot;+~~(255*Math.random())+&quot;)&quot;}var d=[];e.requestAnimationFrame=function(){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)}}(),n()}(window,document);
</code></pre><h4 id="å°†ä¸Šé¢çš„å†…å®¹è´´åˆ°æ–°å¢çš„themesnextv6sourcejssrclovejs-æ–‡ä»¶ä¸­">å°†ä¸Šé¢çš„å†…å®¹è´´åˆ°æ–°å¢çš„themes/nextv6/source/js/src/love.js æ–‡ä»¶ä¸­</h4>
<h4 id="ä¿®æ”¹themesnextv6layout_layoutswigæ–‡ä»¶-æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹">ä¿®æ”¹themes/nextv6/layout/_layout.swigæ–‡ä»¶, æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹</h4>
<pre><code>&lt;!-- é¼ æ ‡æ¡ƒå¿ƒåŠ¨ç”» --&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;/js/src/love.js&quot;&gt;&lt;/script&gt;
</code></pre><h3 id="hexo6-é¼ æ ‡ç§»åŠ¨æ·»åŠ æ˜Ÿæ˜Ÿç‰¹æ•ˆ">hexo6 é¼ æ ‡ç§»åŠ¨æ·»åŠ æ˜Ÿæ˜Ÿç‰¹æ•ˆ</h3>
<p>æ¥è‡ª: <a href="https://blog.csdn.net/a201577F0546/article/details/89060017">æ„šäººèŠ‚é¼ æ ‡è·Ÿéšç‰¹æ•ˆ</a></p>
<h4 id="æ–°å¢jsæ–‡ä»¶-themesnextv6sourcejssrclove2js">æ–°å¢jsæ–‡ä»¶ themes/nextv6/source/js/src/love2.js</h4>
<pre><code>
/*!
 * Fairy Dust Cursor.js
 * - 90's cursors collection
 * -- https://github.com/tholman/90s-cursor-effects
 * -- http://codepen.io/tholman/full/jWmZxZ/
 */

(function fairyDustCursor() {
  
  var possibleColors = [&quot;#D61C59&quot;, &quot;#E7D84B&quot;, &quot;#1B8798&quot;]
  var width = window.innerWidth;
  var height = window.innerHeight;
  var cursor = {x: width/2, y: width/2};
  var particles = [];
  
  function init() {
    bindEvents();
    loop();
  }
  
  // Bind events that are needed
  function bindEvents() {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('touchmove', onTouchMove);
    document.addEventListener('touchstart', onTouchMove);
    
    window.addEventListener('resize', onWindowResize);
  }
  
  function onWindowResize(e) {
    width = window.innerWidth;
    height = window.innerHeight;
  }
  
  function onTouchMove(e) {
    if( e.touches.length &gt; 0 ) {
      for( var i = 0; i &lt; e.touches.length; i++ ) {
        addParticle( e.touches[i].clientX, e.touches[i].clientY, possibleColors[Math.floor(Math.random()*possibleColors.length)]);
      }
    }
  }
  
  function onMouseMove(e) {    
    cursor.x = e.clientX;
    cursor.y = e.clientY;
    
    addParticle( cursor.x, cursor.y, possibleColors[Math.floor(Math.random()*possibleColors.length)]);
  }
  
  function addParticle(x, y, color) {
    var particle = new Particle();
    particle.init(x, y, color);
    particles.push(particle);
  }
  
  function updateParticles() {
    
    // Updated
    for( var i = 0; i &lt; particles.length; i++ ) {
      particles[i].update();
    }
    
    // Remove dead particles
    for( var i = particles.length -1; i &gt;= 0; i-- ) {
      if( particles[i].lifeSpan &lt; 0 ) {
        particles[i].die();
        particles.splice(i, 1);
      }
    }
    
  }
  
  function loop() {
    requestAnimationFrame(loop);
    updateParticles();
  }
  
  /**
   * Particles
   */
  
  function Particle() {

    this.character = &quot;*&quot;;
    this.lifeSpan = 120; //ms
    this.initialStyles ={
      &quot;position&quot;: &quot;fixed&quot;,
      &quot;top&quot;: &quot;0&quot;, //å¿…é¡»åŠ 
      &quot;display&quot;: &quot;block&quot;,
      &quot;pointerEvents&quot;: &quot;none&quot;,
      &quot;z-index&quot;: &quot;10000000&quot;,
      &quot;fontSize&quot;: &quot;20px&quot;,
      &quot;will-change&quot;: &quot;transform&quot;
    };

    // Init, and set properties
    this.init = function(x, y, color) {

      this.velocity = {
        x:  (Math.random() &lt; 0.5 ? -1 : 1) * (Math.random() / 2),
        y: 1
      };
      
      this.position = {x: x - 10, y: y - 20};
      this.initialStyles.color = color;
      console.log(color);

      this.element = document.createElement('span');
      this.element.innerHTML = this.character;
      applyProperties(this.element, this.initialStyles);
      this.update();
      
      document.body.appendChild(this.element);
    };
    
    this.update = function() {
      this.position.x += this.velocity.x;
      this.position.y += this.velocity.y;
      this.lifeSpan--;
      
      this.element.style.transform = &quot;translate3d(&quot; + this.position.x + &quot;px,&quot; + this.position.y + &quot;px,0) scale(&quot; + (this.lifeSpan / 120) + &quot;)&quot;;
    }
    
    this.die = function() {
      this.element.parentNode.removeChild(this.element);
    }
    
  }
  
  /**
   * Utils
   */
  
  // Applies css `properties` to an element.
  function applyProperties( target, properties ) {
    for( var key in properties ) {
      target.style[ key ] = properties[ key ];
    }
  }
  
  init();
})();
</code></pre><h4 id="ä¿®æ”¹themesnextv6layout_layoutswigæ–‡ä»¶-æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹-1">ä¿®æ”¹themes/nextv6/layout/_layout.swigæ–‡ä»¶, æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹</h4>
<pre><code>&lt;!-- é¼ æ ‡ç§»åŠ¨æ˜Ÿæ˜Ÿç‰¹æ•ˆ --&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;/js/src/love2.js&quot;&gt;&lt;/script&gt;
</code></pre>]]></content>
		</item>
		
		<item>
			<title>éƒ¨ç½²elk7.2.0</title>
			<link>https://www.ngirl.xyz/posts/2-%E9%83%A8%E7%BD%B2elk7-2-0/</link>
			<pubDate>Thu, 19 Sep 2019 17:59:53 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/2-%E9%83%A8%E7%BD%B2elk7-2-0/</guid>
			<description>è¯´æ˜:
 1 å•å°k8s,æœ¬æœºç›®å½•æŒ‚è½½(æœªé…ç½®cephfs) 2 å¦‚æœreplicaså¤§äº1, å°±ä¼šå‡ºç°å¤šä¸ªesæŒ‚è½½åŒä¸€ä¸ªç›®å½•,ä¼šå‡ºç°æŠ¥é”™(uuid block) 1. esé…ç½®æœ¬åœ°æŒ‚è½½ k8s-es-7.2.0.yml --- apiVersion: v1 kind: ServiceAccount metadata: labels: app: elasticsearch name: elasticsearch7-admin namespace: ns-elastic7 --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: elasticsearch7-admin labels: app: elasticsearch roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: elasticsearch7-admin namespace: ns-elastic7 --- apiVersion: apps/v1 kind: StatefulSet metadata: labels: app: elasticsearch role: master name: elasticsearch-master namespace: ns-elastic7 spec: replicas: 1 serviceName: elasticsearch-master selector: matchLabels: app: elasticsearch role: master template: metadata: labels: app: elasticsearch role: master spec: serviceAccountName: elasticsearch7-admin restartPolicy: Always securityContext: fsGroup: 1000 containers: - name: elasticsearch-master image: hub.</description>
			<content type="html"><![CDATA[<blockquote>
<p>è¯´æ˜:</p>
</blockquote>
<pre><code>1 å•å°k8s,æœ¬æœºç›®å½•æŒ‚è½½(æœªé…ç½®cephfs)
2 å¦‚æœreplicaså¤§äº1, å°±ä¼šå‡ºç°å¤šä¸ªesæŒ‚è½½åŒä¸€ä¸ªç›®å½•,ä¼šå‡ºç°æŠ¥é”™(uuid block)
</code></pre><h3 id="1-esé…ç½®æœ¬åœ°æŒ‚è½½-k8s-es-720yml">1. esé…ç½®æœ¬åœ°æŒ‚è½½ k8s-es-7.2.0.yml</h3>
<pre><code>---
apiVersion: v1
kind: ServiceAccount
metadata:
 labels:
   app: elasticsearch
 name: elasticsearch7-admin
 namespace: ns-elastic7
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
 name: elasticsearch7-admin
 labels:
   app: elasticsearch
roleRef:
 apiGroup: rbac.authorization.k8s.io
 kind: ClusterRole
 name: cluster-admin
subjects:
 - kind: ServiceAccount
   name: elasticsearch7-admin
   namespace: ns-elastic7
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: elasticsearch
    role: master
  name: elasticsearch-master
  namespace: ns-elastic7
spec:
  replicas: 1
  serviceName: elasticsearch-master
  selector:
    matchLabels:
      app: elasticsearch
      role: master
  template:
    metadata:
      labels:
        app: elasticsearch
        role: master
    spec:
      serviceAccountName: elasticsearch7-admin
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
      containers:
        - name: elasticsearch-master
          image: hub.zhangzw.com/bq/elasticsearch:7.2.0
          command: [&quot;bash&quot;, &quot;-c&quot;, &quot;ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh&quot;]
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          ports:
            - containerPort: 9200
              protocol: TCP
            - containerPort: 9300
              protocol: TCP
          resources:
            requests:
              cpu: &quot;50m&quot;
            limits:
              cpu: &quot;800m&quot;
          env:
            - name: cluster.name
              value: &quot;es_cluster&quot;
            - name: node.master
              value: &quot;true&quot;
            - name: node.data
              value: &quot;true&quot;
            - name: cluster.initial_master_nodes
              value: &quot;elasticsearch-master-0&quot; # æ ¹æ®å‰¯æœ¬æ•°å’Œnameé…ç½®
            - name: discovery.zen.ping_timeout
              value: &quot;5s&quot;
            - name: node.ingest
              value: &quot;false&quot;
            - name: ES_JAVA_OPTS
              value: &quot;-Xms1g -Xmx1g&quot;
            - name: &quot;discovery.zen.ping.unicast.hosts&quot;
              value: &quot;elasticsearch-discovery&quot; # Disvocery Service
            - name: &quot;http.cors.enabled&quot;
              value: &quot;true&quot;
            - name: &quot;http.cors.allow-origin&quot;
              value: &quot;*&quot;
          volumeMounts:
            - name: elasticsearch-data-volume
              mountPath: /usr/share/elasticsearch/data
      volumes:
        - name: elasticsearch-data-volume
          hostPath:
            path: /data/k8s-container/elk-7.2.0/es-7.2.0/data
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elasticsearch
  name: elasticsearch-discovery
  namespace: ns-elastic7
spec:
  publishNotReadyAddresses: true
  ports:
  - name: transport
    port: 9300
    targetPort: 9300
  selector:
    app: elasticsearch
    role: master
---
kind: Service
apiVersion: v1
metadata:
 labels:
   app: elasticsearch
 name: elasticsearch-service
 namespace: ns-elastic7
spec:
 type: NodePort
 ports:
   - port: 9200
     targetPort: 9200
     nodePort: 19230
     protocol: TCP
 selector:
   app: elasticsearch
</code></pre><h3 id="2-esé…ç½®nfsåŠ¨æ€æŒ‚è½½-k8s-es-720-nfsyml">2. esé…ç½®nfsåŠ¨æ€æŒ‚è½½ k8s-es-7.2.0-nfs.yml</h3>
<pre><code>---
apiVersion: v1
kind: ServiceAccount
metadata:
 labels:
   app: elasticsearch
 name: elasticsearch-admin
 namespace: ns-elastic
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
 name: elasticsearch-admin
 labels:
   app: elasticsearch
roleRef:
 apiGroup: rbac.authorization.k8s.io
 kind: ClusterRole
 name: cluster-admin
subjects:
 - kind: ServiceAccount
   name: elasticsearch-admin
   namespace: ns-elastic
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: elasticsearch
    role: master
  name: elasticsearch-master
  namespace: ns-elastic
spec:
  replicas: 2
  volumeClaimTemplates:
  - metadata:
      name: elasticsearch-data-nfs
      annotations:
        volume.beta.kubernetes.io/storage-class: &quot;nfs&quot;
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 2Gi
  serviceName: elasticsearch-master
  selector:
    matchLabels:
      app: elasticsearch
      role: master
  template:
    metadata:
      labels:
        app: elasticsearch
        role: master
    spec:
      serviceAccountName: elasticsearch-admin
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
      containers:
        - name: elasticsearch-master
          image: elasticsearch:7.2.0
          command: [&quot;bash&quot;, &quot;-c&quot;, &quot;ulimit -l unlimited &amp;&amp; sysctl -w vm.max_map_count=262144 &amp;&amp; chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data &amp;&amp; exec su elasticsearch docker-entrypoint.sh&quot;]
          imagePullPolicy: IfNotPresent
          volumeMounts:
          - name: elasticsearch-data-nfs
            mountPath: /usr/share/elasticsearch/data
          securityContext:
            privileged: true
          ports:
            - containerPort: 9200
              protocol: TCP
            - containerPort: 9300
              protocol: TCP
          env:
            - name: cluster.name
              value: &quot;es_cluster&quot;
            - name: node.master
              value: &quot;true&quot;
            - name: node.data
              value: &quot;true&quot;
            - name: cluster.initial_master_nodes
              value: &quot;elasticsearch-master-0,elasticsearch-master-1&quot; # æ ¹æ®å‰¯æœ¬æ•°å’Œnameé…ç½®
            - name: discovery.zen.ping_timeout
              value: &quot;5s&quot;
            - name: node.ingest
              value: &quot;false&quot;
            - name: ES_JAVA_OPTS
              value: &quot;-Xms1g -Xmx1g&quot;
            - name: &quot;discovery.zen.ping.unicast.hosts&quot;
              value: &quot;elasticsearch-discovery&quot; # Disvocery Service
            - name: &quot;http.cors.enabled&quot;
              value: &quot;true&quot;
            - name: &quot;http.cors.allow-origin&quot;
              value: &quot;*&quot;
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elasticsearch
  name: elasticsearch-discovery
  namespace: ns-elastic
spec:
  publishNotReadyAddresses: true
  ports:
  - name: transport
    port: 9300
    targetPort: 9300
  selector:
    app: elasticsearch
    role: master
---
kind: Service
apiVersion: v1
metadata:
 labels:
   app: elasticsearch
 name: elasticsearch-service
 namespace: ns-elastic
spec:
 type: NodePort
 ports:
   - port: 9200
     targetPort: 9200
     nodePort: 19220
     protocol: TCP
 selector:
   app: elasticsearch
</code></pre><h3 id="3-kibanaé…ç½®k8s-kibana-720yml">3. kibanaé…ç½®k8s-kibana-7.2.0.yml</h3>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-config
  namespace: ns-elastic7
  labels:
    elastic-app: kibana
data:
  kibana.yml: |
    server.name: kibana
    server.host: &quot;0&quot;
    elasticsearch.hosts: [ &quot;http://elasticsearch-service:9200&quot; ]
    xpack.monitoring.ui.container.elasticsearch.enabled: true
---
kind: Deployment
apiVersion: apps/v1beta2
metadata:
  labels:
    elastic-app: kibana
  name: kibana
  namespace: ns-elastic7
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      elastic-app: kibana
  template:
    metadata:
      labels:
        elastic-app: kibana
    spec:
      containers:
        - name: kibana
          image: hub.zhangzw.com/bq/kibana:7.2.0
          ports:
            - containerPort: 5601
              protocol: TCP
          resources:
            requests:
              cpu: &quot;50m&quot;
            limits:
              cpu: &quot;800m&quot;
          volumeMounts:
            - name: kibana-config
              mountPath: /usr/share/kibana/config
      volumes:
        - name: kibana-config
          configMap:
            name: kibana-config
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule

---
kind: Service
apiVersion: v1
metadata:
  labels:
    elastic-app: kibana
  name: kibana-service
  namespace: ns-elastic7
spec:
  ports:
    - port: 5601
      targetPort: 5601
  selector:
    elastic-app: kibana
  type: NodePort
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
 labels:
   elastic-app: kibana
 name: kibana-ingress
 namespace: ns-elastic7
spec:
 rules:
   - host: elk-kibana-dev.zhangzw.com
     http:
       paths:
         - backend:
             serviceName: kibana-service
             servicePort: 5601
</code></pre><h3 id="4-logstashé…ç½®-æœ¬åœ°æŒ‚è½½-k8s-logstash-720yml">4. logstashé…ç½® æœ¬åœ°æŒ‚è½½ k8s-logstash-7.2.0.yml</h3>
<ul>
<li>4.1 config/pipelines.yml</li>
</ul>
<pre><code>- pipeline.id: main
  path.config: &quot;/usr/share/logstash/config/pipeline/*.conf&quot;
</code></pre><ul>
<li>4.2 é¦–å…ˆé…ç½®grokè§„åˆ™ config/pipeline/logstash.conf</li>
</ul>
<pre><code>input {
    udp {
        port =&gt; &quot;10000&quot;
        }
    }

 filter {
      grok {
          match =&gt; {
            &quot;message&quot; =&gt; &quot;\{\&quot;id\&quot;:\&quot;(?&lt;id&gt;(.)*)\&quot;,\&quot;tag\&quot;:\&quot;(?&lt;tag&gt;(.)*)\&quot;,\&quot;title\&quot;:\&quot;%{GREEDYDATA:title}(?&lt;title&gt;(.|\r|\n)*)\&quot;,\&quot;value\&quot;:\&quot;%{GREEDYDATA:value}(?&lt;value&gt;(.|\r|\n)*)\&quot;,\&quot;createdAt\&quot;:\&quot;(?&lt;createdAt&gt;\S+ \S+)\&quot;,\&quot;Telephone\&quot;:\&quot;(?&lt;Telephone&gt;(.)*)\&quot;,\&quot;uid\&quot;:\&quot;(?&lt;uid&gt;(.)*)\&quot;,\&quot;updateTime\&quot;:\&quot;(?&lt;updateTime&gt;(.)*)\&quot;,\&quot;appVersion\&quot;:\&quot;(?&lt;appVersion&gt;(.)*)\&quot;,\&quot;mobileModel\&quot;:\&quot;(?&lt;mobileModel&gt;(.)*)\&quot;,\&quot;osVersion\&quot;:\&quot;(?&lt;osVersion&gt;(.)*)\&quot;,\&quot;channel\&quot;:\&quot;(?&lt;channel&gt;(.)*)\&quot;,\&quot;UDID\&quot;:\&quot;(?&lt;UDID&gt;(.)*)\&quot;\}&quot;
              }
            }
 }

output {
    elasticsearch {
        hosts =&gt;  [ &quot;http://elasticsearch-service:9200&quot; ]
        index =&gt; &quot;k8s2-dev-%{+YYYY.MM.dd}&quot;

        }

    }
</code></pre><ul>
<li>4.3 é…ç½®æ–‡ä»¶ k8s-logstash-7.2.0.yml</li>
</ul>
<pre><code>---
kind: Deployment
apiVersion: apps/v1beta2
metadata:
  labels:
    elastic-app: logstash
  name: logstash
  namespace: ns-elastic
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      elastic-app: logstash
  template:
    metadata:
      labels:
        elastic-app: logstash
    spec:
      containers:
        - name: logstash
          image: hub.zhangzw.com/bq/logstash:7.2.0
          ports:
            - containerPort: 10000
              protocol: UDP
          volumeMounts:
            - name: logstash-config
              mountPath: /usr/share/logstash/config
      volumes:
        - name: logstash-config
          hostPath:
            path: /data/k8s-pod/elk-7.2.0/logstash-7.2.0/config
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule

---
kind: Service
apiVersion: v1
metadata:
  labels:
    elastic-app: logstash
  name: logstash-service
  namespace: ns-elastic
spec:
  type: NodePort
  ports:
    - port: 10000
      targetPort: 10000
      nodePort: 10000
      protocol: UDP
  selector:
    elastic-app: logstash
  type: NodePort
---
</code></pre>]]></content>
		</item>
		
		<item>
			<title>é¦–æ¬¡æ­å»ºhexoåšå®¢ç³»ç»Ÿ</title>
			<link>https://www.ngirl.xyz/posts/%E9%A6%96%E6%AC%A1%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/</link>
			<pubDate>Thu, 19 Sep 2019 17:24:53 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/%E9%A6%96%E6%AC%A1%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/</guid>
			<description>&lt;p&gt;é¦–æ¬¡æ­å»ºhexoåšå®¢ç³»ç»Ÿ, ç®€å•è®°å½•ä¸€ä¸‹ä¸€äº›ç”¨æ³•å’Œæ³¨æ„äº‹é¡¹&lt;/p&gt;</description>
			<content type="html"><![CDATA[<p>é¦–æ¬¡æ­å»ºhexoåšå®¢ç³»ç»Ÿ, ç®€å•è®°å½•ä¸€ä¸‹ä¸€äº›ç”¨æ³•å’Œæ³¨æ„äº‹é¡¹</p>
<h3 id="1-å®‰è£…hexo">1 å®‰è£…hexo</h3>
<ul>
<li>1.1 åœ¨macä¸Šå®‰è£…</li>
</ul>
<pre><code># å®‰è£…node
brew install node npm
</code></pre><ul>
<li>1.2 åœ¨linuxå®‰è£…</li>
</ul>
<pre><code># å®‰è£…node10
curl -sL https://rpm.nodesource.com/setup_10.x | bash -
yum install -y nodejs
</code></pre><ul>
<li>1.3 å®‰è£…hexo</li>
</ul>
<pre><code># å®‰è£…hexo
npm install -g hexo
</code></pre><h3 id="2-åˆå§‹åŒ–">2 åˆå§‹åŒ–</h3>
<pre><code>cd /data/github/
# åˆå§‹åŒ–

hexo init blog
# æ¡†æ¶å®‰è£…
npm install

#å®‰è£… Hexo å…³äºå¯åŠ¨æœåŠ¡å™¨çš„æ’ä»¶
npm install hexo-server --save

# å¯åŠ¨æœåŠ¡å™¨, æœ¬åœ°æŸ¥çœ‹æ•ˆæœ, å¦‚æœä¸æŒ‡å®šç«¯å£ï¼Œé»˜è®¤ä¸º4000
hexo server

</code></pre><h3 id="3-ä¸»é¢˜å’Œé…ç½®">3 ä¸»é¢˜å’Œé…ç½®</h3>
<ul>
<li>ä¸‹è½½ä¸»é¢˜ï¼š<a href="https://github.com/theme-next/hexo-theme-next">https://github.com/theme-next/hexo-theme-next</a></li>
</ul>
<pre><code>unzip hexo-theme-next-master.zip
mv hexo-theme-next-master $blog/themes/
</code></pre><ul>
<li>ä¿®æ”¹ä¸»é¢˜é…ç½® _config.yml ä¸­çš„å…¶ä»–å±æ€§</li>
</ul>
<pre><code>title: Zhangzhiwei's Blog
...
theme: hexo-theme-next
...
scheme: Mist
</code></pre><h3 id="4-ç¼–å†™æ›´æ–°åšå®¢">4. ç¼–å†™æ›´æ–°åšå®¢</h3>
<ul>
<li>åˆ›å»ºåšå®¢</li>
</ul>
<pre><code>hexo new 'ç¬¬ä¸€ä¸ªåšå®¢'
</code></pre><ul>
<li>cat source/_posts/ç¬¬ä¸€ä¸ªåšå®¢.md</li>
</ul>
<pre><code>title: ç¬¬ä¸€ä¸ªåšå®¢
date: 2019-09-19 16:58:01
tags:
  - hexo
categories:
  - hexoå­¦ä¹ 
</code></pre><ul>
<li>github åˆ›å»ºä¸€ä¸ªRepositoryä»“åº“</li>
</ul>
<pre><code>1. ä»“åº“åå­—å¿…é¡»æ˜¯ xxx.github.io
2. åœ¨settingsä¸­ å‹¾é€‰Template repository
3. è®°å¾—æ·»åŠ è‡ªå·±çš„ssh
</code></pre><ul>
<li>githubé…ç½®</li>
</ul>
<pre><code> # å®‰è£… hexo å…³äº git çš„ç»„ä»¶
npm install hexo-deployer-git --save
</code></pre><ul>
<li>åœ¨_config.yml ä¸­ä¸º git æ·»åŠ é…ç½®</li>
</ul>
<pre><code>deploy:
  type: git
  repository: git@github.com:*/*.github.io.git
  branch: master
</code></pre><ul>
<li>æŸ¥çœ‹æ˜¯å¦èƒ½æäº¤ä»£ç github</li>
</ul>
<pre><code>ssh -T -ai ~/.ssh/id_rsa git@github.com
</code></pre><ul>
<li>éƒ¨ç½²</li>
</ul>
<pre><code>hexo g
hexo d
æˆ–è€…
hexo d -g
</code></pre><h3 id="5-next6è®©é¦–é¡µæ–‡å­—é¢„è§ˆæ˜¾ç¤º">5. next6è®©é¦–é¡µæ–‡å­—é¢„è§ˆæ˜¾ç¤º</h3>
<ul>
<li>5.1 æ–¹æ³•ä¸€: è‡ªåŠ¨å½¢æˆæ‘˜è¦,é»˜è®¤æˆªå–çš„é•¿åº¦ä¸º 150 å­—ç¬¦</li>
</ul>
<pre><code>1. æ‰¾åˆ°ä¸»é¢˜çš„é…ç½®æ–‡ä»¶(themes/next/_config.yml)
2. ä¿®æ”¹auto_excerpt,æŠŠenableæ”¹ä¸ºå¯¹åº”çš„falseæ”¹ä¸ºtrue
3. hexo d -g
</code></pre><ul>
<li>5.2 æ–¹æ³•äºŒ: åšå®¢å†…å®¹ä¸­æ·»åŠ  &lt; !&ndash;more&ndash;&gt;</li>
</ul>
<pre><code># å®‰è£…node
brew install node npm
 &lt;!-- more --&gt;
</code></pre><ul>
<li>5.3 æ–¹æ³•ä¸‰: åœ¨æ–‡ç« ä¸­çš„front-matterä¸­æ·»åŠ descriptionï¼Œå¹¶æä¾›æ–‡ç« æ‘˜å½•,è¿™ç§æ–¹å¼åªä¼šåœ¨é¦–é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºæ–‡ç« çš„æ‘˜è¦å†…å®¹ï¼Œè¿›å…¥æ–‡ç« è¯¦æƒ…åä¸ä¼šå†æ˜¾ç¤ºã€‚</li>
</ul>
<pre><code>title: éƒ¨ç½²elk7.2.0
date: 2019-09-19 17:59:53
copyright: true
tags:
  - k8s
  - elk
  - elk7
categories:
  - æŠ€æœ¯æ–‡æ¡£
  - elk
description: æœ¬æ–‡ä¸»è¦æ˜¯ç®€å•å•æœºç‰ˆéƒ¨ç½²elk7ä½“éªŒ,  å¹¶éé«˜å¯ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½², éƒ¨åˆ†å®‰è£…æ­¥éª¤çœç•¥. ä¸»è¦æ˜¯è®°å½•ymlé…ç½®æ–‡ä»¶, ä»…ä¾›å‚è€ƒ. è¯¦ç»†å†…å®¹è¯·ç‚¹å‡»ä¸‹æ–¹é˜…è¯»å…¨æ–‡, éå¸¸æ„Ÿè°¢!
</code></pre><h3 id="6-next6æ·»åŠ æœç´¢åŠŸèƒ½">6. next6æ·»åŠ æœç´¢åŠŸèƒ½</h3>
<pre><code>1. npm install hexo-generator-searchdb --save
2. å…¨å±€é…ç½®æ–‡ä»¶_config.yml
search:
  path: search.xml
  field: post
  format: html
  limit: 10000
3. ä¿®æ”¹ä¸»é¢˜çš„_config.yml
local_search:
  enable: true
</code></pre><h3 id="7-next6-mistå­—ä½“çš„-é¦–é¡µæ–‡ç« é—´è·å’Œé¦–é¡µé¡µå®½å­—ä½“">7. next6 Mistå­—ä½“çš„ é¦–é¡µæ–‡ç« é—´è·å’Œé¦–é¡µé¡µå®½,å­—ä½“</h3>
<ul>
<li>
<p>7.1 é¦–é¡µæ–‡ç« é—´è·</p>
<pre><code>å¢åŠ ä¸€äº›å†…å®¹: source/css/_schemes/Mist/_posts-expanded.styl
.posts-expand .post {
  margin-top: 30px;
  margin-bottom: 30px;
}
  
</code></pre><pre><code>
</code></pre></li>
<li>
<p>7.2 é¡µå®½</p>
<pre><code>source/css/_variables/base.styl
$content-desktop                = 900px
$content-desktop-large          = 1000px
$content-desktop-largest        = 1100px
</code></pre><pre><code>
</code></pre></li>
<li>
<p>7.3 å­—ä½“å¤§å°</p>
<pre><code>themes/next/source/css/_variables/base.styl
  
$font-size-base           = 0.95em;
$font-size-base           = unit(hexo-config('font.global.size'), em) if hexo-config('font.global.size') is a 'unit';
$font-size-smallest       = .75em;
$font-size-smaller        = .8125em;
$font-size-small          = .855em;
$font-size-medium         = 0.95em;
$font-size-large          = 0.975em;
$font-size-larger         = 1.em;
$font-size-largest        = 1.125em;
</code></pre><pre><code>
</code></pre></li>
</ul>
<h3 id="8-æ·»åŠ ç½‘æ ¼">8. æ·»åŠ ç½‘æ ¼</h3>
<ul>
<li>
<p>8.1 è‡ªå®šä¹‰æ–¹å¼ä¿®æ”¹</p>
<pre><code># æ–°åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶
cat themes/next/source/css/_custom/custom.styl
// ä¸»é¡µæ–‡ç« æ·»åŠ é˜´å½±æ•ˆæœ
.post {
margin-top: 60px;
margin-bottom: 60px;
padding: 25px;
-webkit-box-shadow: 0 0 5px rgba(202, 203, 203, .5);
-moz-box-shadow: 0 0 5px rgba(202, 203, 204, .5);
}

# ä¿®æ”¹configæ–‡ä»¶
vim ./themes/next/_config.yml
custom: custom
</code></pre><p>``</p>
</li>
<li>
<p>8.2 next6ç‰ˆæœ¬ä¿®æ”¹æ–¹å¼</p>
<blockquote>
<p>å‚è€ƒ: <a href="https://www.jianshu.com/p/ec2e6c8a1d89">hexo6&ndash;nextç¾åŒ–æ•´ç†</a></p>
</blockquote>
<ol>
<li>ä¿®æ”¹ themes/next/layout/_layout.swig</li>
</ol>
<pre><code>{% if theme.canvas_nest %}
&lt;script type=&quot;text/javascript&quot; src=&quot;//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js&quot;&gt;
&lt;/script&gt;
{% endif %}
</code></pre><pre><code>
 &gt; å°†ä¸Šè¿°ä»£ç é˜²æ­¢åœ¨&lt; /body&gt; å‰å°±å¯ä»¥äº†(æ³¨æ„ä¸è¦æ”¾åœ¨&lt; /head&gt;çš„åé¢)ã€‚

 2. ä¿®æ”¹ä¸»é¢˜çš„_config.yml

</code></pre><pre><code> canvas_nest: true

 //color: çº¿æ¡é¢œè‰², é»˜è®¤: '0,0,0'ï¼›ä¸‰ä¸ªæ•°å­—åˆ†åˆ«ä¸º(R,G,B)
 //opacity: çº¿æ¡é€æ˜åº¦ï¼ˆ0~1ï¼‰, é»˜è®¤: 0.5
 //count: çº¿æ¡çš„æ€»æ•°é‡, é»˜è®¤: 150
 //zIndex: èƒŒæ™¯çš„z-indexå±æ€§ï¼Œcsså±æ€§ç”¨äºæ§åˆ¶æ‰€åœ¨å±‚çš„ä½ç½®, é»˜è®¤: -1
</code></pre><pre><code></code></pre></li>
</ul>
<blockquote>
<p>æ³¨æ„:
æˆ‘è¿™é‡Œæ‰“å¼€æç¤ºç¼ºå°‘ canvas-nest.min.jsæ–‡ä»¶,è¿™é‡Œæ˜¯æ‰‹åŠ¨copyçš„ä¸€ä»½å†™åˆ° source/lib/canvas-nest/canvas-nest.min.js</p>
</blockquote>
<pre><code>!function(){function o(w,v,i){return w.getAttribute(v)||i}function j(i){return document.getElementsByTagName(i)}function l(){var i=j(&quot;script&quot;),w=i.length,v=i[w-1];return{l:w,z:o(v,&quot;zIndex&quot;,-1),o:o(v,&quot;opacity&quot;,0.5),c:o(v,&quot;color&quot;,&quot;0,0,0&quot;),n:o(v,&quot;count&quot;,99)}}function k(){r=u.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,n=u.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function b(){e.clearRect(0,0,r,n);var w=[f].concat(t);var x,v,A,B,z,y;t.forEach(function(i){i.x+=i.xa,i.y+=i.ya,i.xa*=i.x&gt;r||i.x&lt;0?-1:1,i.ya*=i.y&gt;n||i.y&lt;0?-1:1,e.fillRect(i.x-0.5,i.y-0.5,1,1);for(v=0;v&lt;w.length;v++){x=w[v];if(i!==x&amp;&amp;null!==x.x&amp;&amp;null!==x.y){B=i.x-x.x,z=i.y-x.y,y=B*B+z*z;y&lt;x.max&amp;&amp;(x===f&amp;&amp;y&gt;=x.max/2&amp;&amp;(i.x-=0.03*B,i.y-=0.03*z),A=(x.max-y)/x.max,e.beginPath(),e.lineWidth=A/2,e.strokeStyle=&quot;rgba(&quot;+s.c+&quot;,&quot;+(A+0.2)+&quot;)&quot;,e.moveTo(i.x,i.y),e.lineTo(x.x,x.y),e.stroke())}}w.splice(w.indexOf(i),1)}),m(b)}var u=document.createElement(&quot;canvas&quot;),s=l(),c=&quot;c_n&quot;+s.l,e=u.getContext(&quot;2d&quot;),r,n,m=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i){window.setTimeout(i,1000/45)},a=Math.random,f={x:null,y:null,max:20000};u.id=c;u.style.cssText=&quot;position:fixed;top:0;left:0;z-index:&quot;+s.z+&quot;;opacity:&quot;+s.o;j(&quot;body&quot;)[0].appendChild(u);k(),window.onresize=k;window.onmousemove=function(i){i=i||window.event,f.x=i.clientX,f.y=i.clientY},window.onmouseout=function(){f.x=null,f.y=null};for(var t=[],p=0;s.n&gt;p;p++){var h=a()*r,g=a()*n,q=2*a()-1,d=2*a()-1;t.push({x:h,y:g,xa:q,ya:d,max:6000})}setTimeout(function(){b()},100)}();%

</code></pre><h3 id="9-æ·»åŠ è¯„è®ºåŠŸèƒ½">9. æ·»åŠ è¯„è®ºåŠŸèƒ½</h3>
<ul>
<li>9.1 æ³¨å†Œleancloud</li>
</ul>
<pre><code>æ³¨å†Œ-&gt; éªŒè¯é‚®ç®±-&gt; å®åè®¤è¯ -&gt; è®¾ç½®è·å–appidå’Œappkey
</code></pre><ul>
<li>9.2 ä¿®æ”¹é…ç½®æ–‡ä»¶</li>
</ul>
<pre><code>valine:
  enable: true 
  appid: 'appid' 
  appkey: 'appkey' 
  placeholder: &quot;ãƒ¾ï¾‰â‰§âˆ€â‰¦)o æ¥å‘€ï¼å¿«æ´»å‘€ï¼~å•¦å•¦å•¦~ å•¦å•¦å•¦å•¦~&quot; 
  visitor: true //è¿™ä¸ªæ‰“å¼€é¡µä¼šç»Ÿè®¡æ–‡ç« é˜…è¯»æ•°
</code></pre><h3 id="10-next6æ·»åŠ å­—æ•°ç»Ÿè®¡-å’Œé˜…è¯»æ—¶é•¿">10. next6æ·»åŠ å­—æ•°ç»Ÿè®¡ å’Œé˜…è¯»æ—¶é•¿</h3>
<blockquote>
<p><a href="https://github.com/theme-next/hexo-symbols-count-time">hexo-symbols-count-time</a></p>
</blockquote>
<ul>
<li>10.1 å®‰è£…nodeæ‰©å±•</li>
</ul>
<pre><code>npm install hexo-symbols-count-time --save
</code></pre><ul>
<li>10.2 ä¿®æ”¹å…¨å±€é…ç½® _config.yml</li>
</ul>
<pre><code>symbols_count_time:
  symbols: true
  time: true
  total_symbols: true
  total_time: true
  exclude_codeblock: false
</code></pre><ul>
<li>10.3 ä¿®æ”¹ä¸»é¢˜é…ç½® _config.yml</li>
</ul>
<pre><code>symbols_count_time:
  separated_meta: true
  item_text_post: true
  item_text_total: false
  awl: 4
  wpm: 275
  suffix: mins.
</code></pre><h3 id="11-next6-æ–‡ç« ç½®é¡¶åŠŸèƒ½">11. next6 æ–‡ç« ç½®é¡¶åŠŸèƒ½</h3>
<ul>
<li>11.1 å®‰è£…nodeæ‰©å±•</li>
</ul>
<pre><code>npm uninstall hexo-generator-index --save
npm install hexo-generator-index-pin-top --save
</code></pre><ul>
<li>11.2 åœ¨æ–‡ç« å¼€å¤´æ·»åŠ ç½®é¡¶æ ‡è¯†</li>
</ul>
<pre><code>top: 10
</code></pre><ul>
<li>11.3 é¦–é¡µæ·»åŠ æ˜æ˜¾ç½®é¡¶æ ‡è¯†</li>
</ul>
<pre><code>themes/next/layout/_macro/post.swig åœ¨&lt;div class=&quot;post-meta&quot;&gt; ä¸‹æ·»åŠ å¦‚ä¸‹ä»£ç 
{% if post.top %}
    &lt;i class=&quot;fa fa-thumb-tack&quot;&gt;&lt;/i&gt;
    &lt;font color=green&gt;ç½®é¡¶&lt;/font&gt;
    &lt;span class=&quot;post-meta-divider&quot;&gt;|&lt;/span&gt;
{% endif %}
</code></pre><h3 id="12-next6-å¼€å¯æ ‡ç­¾å’Œåˆ†ç±»">12. next6 å¼€å¯æ ‡ç­¾å’Œåˆ†ç±»</h3>
<ul>
<li>12.1 åˆ›å»ºtagsç›¸å…³ç›®å½•</li>
</ul>
<pre><code>hexo new page tags
hexo new page categories
</code></pre><ul>
<li>12.2 å¼€å¯tagsæ ‡ç­¾å’Œåˆ†ç±»</li>
</ul>
<pre><code>vim themes/next/_config.yml
tags: /tags/ || tags
categories: /categories/ || th
</code></pre><ul>
<li>12.3 ä¿®æ”¹tagsç«™ç‚¹æ–‡ä»¶</li>
</ul>
<pre><code>cat source/tags/index.md
---
title: tags
date: 2019-09-24 10:08:59
type: &quot;tags&quot;
layout: &quot;tags&quot;
comments: false
---
</code></pre><ul>
<li>12.4 ä¿®æ”¹categoriesç«™ç‚¹æ–‡ä»¶</li>
</ul>
<pre><code>cat source/categories/index.md
---
title: categories
date: 2019-09-24 10:09:55
type: &quot;categories&quot;
layout: &quot;categories&quot;
comments: false
---
</code></pre><ul>
<li>12.5 å»æ‰xxx.github.io/tags/ é¡µé¢çš„post-title(å› ä¸ºæˆ‘çš„è¿™ä¸ªcsså·¦å¯¹é½äº†,é»˜è®¤æ˜¯å±…ä¸­,æ‰€ä»¥å¾ˆä¸‘)</li>
</ul>
<pre><code># æ³¨é‡Šä¸‹é¢è¿™æ®µä»£ç 
vim themes/nextv/layout/page.swig 
&lt;!-- {% include '_partials/page/page-header.swig' %} --&gt;
</code></pre><ul>
<li>12.6 æ–‡ç« ä¸­å¤šä¸ªtagå’Œcategories</li>
</ul>
<pre><code>tags:
  - k8s
  - k8så®‰è£…
categories:
  - [k8s,å®‰è£…]
  - [æŠ€æœ¯æ–‡æ¡£]
</code></pre><ul>
<li>12.7 å¯¹äºè‡ªå®šä¹‰çš„htmlä¸æƒ³è½¬æˆhexoçš„æ ¼å¼(æ¯”å¦‚ä¸€äº›baidu,googleçš„æ”¶å½•åˆ†æå·¥å…·çš„éªŒè¯æ–‡ä»¶)</li>
</ul>
<pre><code># hexo clean æ¸…ç†publicç›®å½•

# hexo d -g éƒ¨ç½²å’Œæ›´æ–°, æ­¤æ—¶ä¼šæ ¹æ®sourceç›®å½•ç”Ÿæˆhtml,css,jsç­‰æ–‡ä»¶

# å‡å¦‚æˆ‘æœ‰ä¸€ä¸ª source/baidu_verify_xxx.html æ–‡ä»¶ ä¸æƒ³è¢«æ›´æ”¹

# éœ€è¦ä¿®æ”¹_config.yml
skip_render:
  -  &quot;*.html&quot;

# å¦‚æœéå¿…é¡»åœ¨ / æ ¹ç›®å½•ä¹Ÿå¯ä»¥è‡ªå»ºç›®å½•, skip_render è®¾ç½®è‡ªå®šä¹‰çš„ç›®å½•å³å¯
</code></pre>]]></content>
		</item>
		
		<item>
			<title></title>
			<link>https://www.ngirl.xyz/posts/38-es%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%87%BA%E7%8E%B0overhead%E8%84%B1%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%98/</link>
			<pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
			
			<guid>https://www.ngirl.xyz/posts/38-es%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%87%BA%E7%8E%B0overhead%E8%84%B1%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%98/</guid>
			<description>title: esé›†ç¾¤èŠ‚ç‚¹å‡ºç°overheadè„±æœºçš„é—®é¢˜ copyright: true toc: true date: 2020-03-12 15:23:35 tags:
 elasticsearch5 categories: [elk,elasticsearch5]   elasticsearch æ—¥å¿—æç¤º overhead, å¯¼è‡´é›†ç¾¤å‡ºç°é—®é¢˜
 é—®é¢˜è¯´æ˜   elasticsearch æ—¥å¿—æç¤º overhead [2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&amp;gt;[7.3gb]/[7.9gb], all_pools {[young] [17.5mb]-&amp;gt;[3.3mb]/[532.5mb]}{[survivor] [0b]-&amp;gt;[0b]/[66.5mb]}{[old] [7.3gb]-&amp;gt;[7.3gb]/[7.3gb]} [2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s] [2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008938][256207] duration [24.8s], collections [1]/[25.5s], total [24.8s]/[5.7h], memory [7.3gb]-&amp;gt;[7.3gb]/[7.9gb], all_pools {[young] [8.</description>
			<content type="html"><![CDATA[<p>title: esé›†ç¾¤èŠ‚ç‚¹å‡ºç°overheadè„±æœºçš„é—®é¢˜
copyright: true
toc: true
date: 2020-03-12 15:23:35
tags:</p>
<ul>
<li>elasticsearch5
categories:</li>
<li>[elk,elasticsearch5]</li>
</ul>
<hr>
<p>elasticsearch æ—¥å¿—æç¤º overhead, å¯¼è‡´é›†ç¾¤å‡ºç°é—®é¢˜</p>
<!--more -->
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5>  é—®é¢˜è¯´æ˜ </font>
</center>
<h3 id="elasticsearch-æ—¥å¿—æç¤º-overhead">elasticsearch æ—¥å¿—æç¤º overhead</h3>
<pre><code>[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools {[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]}{[survivor] [0b]-&gt;[0b]/[66.5mb]}{[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]}
[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s]


[2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008938][256207] duration [24.8s], collections [1]/[25.5s], total [24.8s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools {[young] [8.5mb]-&gt;[17.5mb]/[532.5mb]}{[survivor] [0b]-&gt;[0b]/[66.5mb]}{[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]}
[2020-03-12T14:37:44,632][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008938] overhead, spent [24.8s] collecting in the last [25.5s]
</code></pre><p>æŸ¥çœ‹elasticsearch é…ç½® heap size æ˜¯8G</p>
<p>ES å†…å­˜ä½¿ç”¨å’ŒGCæŒ‡æ ‡â€”â€”é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»èŠ‚ç‚¹æ¯30ç§’ä¼šå»æ£€æŸ¥å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœä»»ä½•èŠ‚ç‚¹çš„åƒåœ¾å›æ”¶æ—¶é—´è¶…è¿‡30ç§’ï¼ˆGarbage collection durationï¼‰ï¼Œåˆ™ä¼šå¯¼è‡´ä¸»èŠ‚ç‚¹ä»»åŠ¡è¯¥èŠ‚ç‚¹è„±ç¦»é›†ç¾¤ã€‚</p>
<p>è®¾ç½®è¿‡å¤§çš„heapä¼šå¯¼è‡´GCæ—¶é—´è¿‡é•¿ï¼Œè¿™äº›é•¿æ—¶é—´çš„åœé¡¿ï¼ˆstop-the-worldï¼‰ä¼šè®©é›†ç¾¤é”™è¯¯çš„è®¤ä¸ºè¯¥èŠ‚ç‚¹å·²ç»è„±ç¦»ã€‚</p>
<p>æ‰€ä»¥é€šè¿‡å¢åŠ ping_timeoutçš„æ—¶é—´ï¼Œå’Œå¢åŠ ping_retriesçš„æ¬¡æ•°æ¥é˜²æ­¢èŠ‚ç‚¹é”™è¯¯çš„è„±ç¦»é›†ç¾¤ï¼Œå¯ä»¥ä½¿èŠ‚ç‚¹æœ‰å……è¶³çš„æ—¶é—´è¿›è¡Œfull GCã€‚</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5>  é—®é¢˜è§£å†³ </font>
</center>
<h3 id="è¿™é‡Œå°†é»˜è®¤çš„è¶…æ—¶æ—¶é—´å¢åŠ -å¢åŠ é‡è¯•æ¬¡æ•°-å¢åŠ é—´éš”æ—¶é—´">è¿™é‡Œå°†é»˜è®¤çš„è¶…æ—¶æ—¶é—´å¢åŠ , å¢åŠ é‡è¯•æ¬¡æ•°, å¢åŠ é—´éš”æ—¶é—´</h3>
<pre><code>#è¶…æ—¶æ—¶é—´è®¾ä¸º5åˆ†é’Ÿï¼Œè¶…è¿‡6æ¬¡å¿ƒè·³æ²¡æœ‰å›åº”ï¼Œåˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹è„±ç¦»masterï¼Œæ¯éš”60så‘é€ä¸€æ¬¡å¿ƒè·³ã€‚
 discovery.zen.fd.ping_timeout: 300s
 discovery.zen.fd.ping_retries: 6
 discovery.zen.fd.ping_interval: 60s
</code></pre><center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5>  gc åƒåœ¾å›æ”¶ç®—æ³• </font>
</center>
<blockquote>
<p>æ‘˜è‡ªåŸæ–‡: <a href="https://www.jianshu.com/p/1f450826f62e">https://www.jianshu.com/p/1f450826f62e</a></p>
</blockquote>
<h3 id="æ ‡è®°-æ¸…é™¤-ç®—æ³•mark-sweep">æ ‡è®°-æ¸…é™¤ ç®—æ³•(Mark Sweep)</h3>
<p>è¯¥ç®—æ³•å¾ˆç®€å•ï¼Œä½¿ç”¨é€šè¿‡å¯è¾¾æ€§åˆ†æåˆ†ææ–¹æ³•æ ‡è®°å‡ºåƒåœ¾ï¼Œç„¶åç›´æ¥å›æ”¶æ‰åƒåœ¾åŒºåŸŸã€‚å®ƒçš„ä¸€ä¸ªæ˜¾è‘—é—®é¢˜æ˜¯ä¸€æ®µæ—¶é—´åï¼Œå†…å­˜ä¼šå‡ºç°å¤§é‡ç¢ç‰‡ï¼Œå¯¼è‡´è™½ç„¶ç¢ç‰‡æ€»å’Œå¾ˆå¤§ï¼Œä½†æ— æ³•æ»¡è¶³ä¸€ä¸ªå¤§å¯¹è±¡çš„å†…å­˜ç”³è¯·ï¼Œä»è€Œå¯¼è‡´ OOMï¼Œè€Œè¿‡å¤šçš„å†…å­˜ç¢ç‰‡ï¼ˆéœ€è¦ç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ç»´æŠ¤ï¼‰ï¼Œä¹Ÿä¼šå¯¼è‡´æ ‡è®°å’Œæ¸…é™¤çš„æ“ä½œæˆæœ¬é«˜ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<center>
<img src="//zhangzw001.github.io/images/38/gc1.jpg">
</center>
<h3 id="å¤åˆ¶ç®—æ³•copying">å¤åˆ¶ç®—æ³•(Copying)</h3>
<p>æœ‰äººæå‡ºäº†å¤åˆ¶ç®—æ³•ã€‚å®ƒå°†å¯ç”¨å†…å­˜ä¸€åˆ†ä¸ºäºŒï¼Œæ¯æ¬¡åªç”¨ä¸€å—ï¼Œå½“è¿™ä¸€å—å†…å­˜ä¸å¤Ÿç”¨æ—¶ï¼Œä¾¿è§¦å‘ GCï¼Œå°†å½“å‰å­˜æ´»å¯¹è±¡å¤åˆ¶(Copy)åˆ°å¦ä¸€å—ä¸Šï¼Œä»¥æ­¤å¾€å¤ã€‚è¿™ç§ç®—æ³•é«˜æ•ˆçš„åŸå› åœ¨äºåˆ†é…å†…å­˜æ—¶åªéœ€è¦å°†æŒ‡é’ˆåç§»ï¼Œä¸éœ€è¦ç»´æŠ¤é“¾è¡¨ç­‰ã€‚ä½†å®ƒæœ€å¤§çš„é—®é¢˜æ˜¯å¯¹å†…å­˜çš„æµªè´¹ï¼Œä½¿ç”¨ç‡åªæœ‰ 50%</p>
<center>
<img src="//zhangzw001.github.io/images/38/gc2.jpg">
</center>
<h3 id="æ ‡è®°-æ•´ç†ç®—æ³•mark-compact">æ ‡è®°-æ•´ç†ç®—æ³•(Mark Compact)</h3>
<p>è¯¥ç®—æ³•è§£å†³äº†ç¬¬1ä¸­ç®—æ³•çš„å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå®ƒä¼šåœ¨å›æ”¶é˜¶æ®µå°†æ‰€æœ‰å†…å­˜åšæ•´ç†</p>
<center>
<img src="//zhangzw001.github.io/images/38/gc3.jpg">
</center>
<h3 id="åˆ†ä»£æ”¶é›†ç®—æ³•generation-collection">åˆ†ä»£æ”¶é›†ç®—æ³•(Generation Collection)</h3>
<p>æ—¢ç„¶å¤§éƒ¨åˆ† Java å¯¹è±¡æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å†…å­˜æŒ‰ç…§ Java ç”Ÿå­˜æ—¶é—´åˆ†ä¸º æ–°ç”Ÿä»£(Young) å’Œ è€å¹´ä»£(Old)ï¼Œå‰è€…å­˜æ”¾çŸ­å‘½åƒ§ï¼Œåè€…å­˜æ”¾é•¿å¯¿ä½›ï¼Œå½“ç„¶é•¿å¯¿ä½›ä¹Ÿæ˜¯ç”±çŸ­å‘½åƒ§å‡çº§ä¸Šæ¥çš„ã€‚ç„¶åé’ˆå¯¹ä¸¤è€…å¯ä»¥é‡‡ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ï¼Œæ¯”å¦‚å¯¹äºæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ä¼šæ¯”è¾ƒé«˜æ•ˆï¼Œè€Œå¯¹è€å¹´ä»£å¯ä»¥é‡‡ç”¨æ ‡è®°-æ¸…é™¤æˆ–è€…æ ‡è®°-æ•´ç†ç®—æ³•ã€‚è¿™ç§ç®—æ³•ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ã€‚JVM Heap åˆ†ä»£åçš„åˆ’åˆ†ä¸€èˆ¬å¦‚ä¸‹æ‰€ç¤ºï¼Œæ–°ç”Ÿä»£ä¸€èˆ¬ä¼šåˆ†ä¸º Edenã€Survivor0ã€Survivor1åŒºï¼Œä¾¿äºä½¿ç”¨å¤åˆ¶ç®—æ³•ã€‚</p>
<center>
<img src="//zhangzw001.github.io/images/38/gc4.jpg">
</center>
<p>å°†å†…å­˜åˆ†ä»£åçš„ GC è¿‡ç¨‹ä¸€èˆ¬ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<center>
<img src="//zhangzw001.github.io/images/38/gc5.jpg">
</center>
<p>1 å¯¹è±¡ä¸€èˆ¬éƒ½æ˜¯å…ˆåœ¨ EdenåŒºåˆ›å»º
2 å½“EdenåŒºæ»¡ï¼Œè§¦å‘ Young GCï¼Œæ­¤æ—¶å°† Edenä¸­è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ° S0ä¸­ï¼Œå¹¶æ¸…ç©º EdenåŒºåç»§ç»­ä¸ºæ–°çš„å¯¹è±¡åˆ†é…å†…å­˜
3 å½“EdenåŒºå†æ¬¡æ»¡åï¼Œè§¦å‘åˆä¸€æ¬¡çš„ Young GCï¼Œæ­¤æ—¶ä¼šå°† Edenå’ŒS0ä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ° S1ä¸­ï¼Œç„¶åæ¸…ç©ºEdenå’ŒS0åç»§ç»­ä¸ºæ–°çš„å¯¹è±¡åˆ†é…å†…å­˜
4 æ¯ç»è¿‡ä¸€æ¬¡ Young GCï¼Œå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡éƒ½ä¼šå°†è‡ªå·±å­˜æ´»æ¬¡æ•°åŠ 1ï¼Œå½“è¾¾åˆ°ä¸€å®šæ¬¡æ•°åï¼Œä¼šéšç€ä¸€æ¬¡ Young GC æ™‹å‡åˆ° OldåŒº
5 OldåŒºä¹Ÿä¼šåœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œè‡ªå·±çš„ GC</p>
<center>
<img src="//zhangzw001.github.io/images/dockerniu.jpeg" width = "100" height = "100" style="border: 0"/>
<font color="blue" face="é»‘ä½“" size=5>  elasticsearch gcè¯´æ˜ </font>
</center>
<p>Elasticsearch é»˜è®¤çš„ GC é…ç½®æ˜¯CMS GC ï¼Œå…¶ Young åŒºç”¨ ParNewï¼ŒOld åŒºç”¨CMSï¼Œå¤§å®¶å¯ä»¥åœ¨ config/jvm.optionsä¸­çœ‹åˆ°å¦‚ä¸‹çš„é…ç½®ï¼š</p>
<pre><code>## GC configuration
-XX:+UseConcMarkSweepGC
-XX:CMSInitiatingOccupancyFraction=75
-XX:+UseCMSInitiatingOccupancyOnly
</code></pre><h3 id="ä½•æ—¶è¿›è¡Œå›æ”¶">ä½•æ—¶è¿›è¡Œå›æ”¶</h3>
<pre><code>1 Young åŒºçš„GC éƒ½æ˜¯åœ¨ Eden åŒºæ»¡æ—¶è§¦å‘
2 Serial Old å’Œ Parallel Old åœ¨ Old åŒºæ˜¯åœ¨ Young GC æ—¶é¢„æµ‹Old åŒºæ˜¯å¦å¯ä»¥ä¸º young åŒº promote åˆ° old åŒº çš„ object åˆ†é…ç©ºé—´ï¼Œå¦‚æœä¸å¯ç”¨åˆ™è§¦å‘ Old GCã€‚è¿™ä¸ªä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ OldåŒºæ»¡æ—¶ã€‚
3 CMS GC æ˜¯åœ¨ Old åŒºå¤§å°è¶…è¿‡ä¸€å®šæ¯”ä¾‹åè§¦å‘ï¼Œè€Œä¸æ˜¯ Old åŒºæ»¡ã€‚è¿™ä¸ªåŸå› åœ¨äº CMS GC æ˜¯å¹¶å‘çš„ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ GC çº¿ç¨‹æ”¶é›†åƒåœ¾çš„æ—¶å€™ï¼Œç”¨æˆ·çº¿ç¨‹ä¹Ÿåœ¨è¿è¡Œï¼Œå› æ­¤éœ€è¦é¢„ç•™ä¸€äº› Heap ç©ºé—´ç»™ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨ï¼Œé˜²æ­¢ç”±äºæ— æ³•åˆ†é…ç©ºé—´è€Œå¯¼è‡´ Full GC å‘ç”Ÿã€‚
</code></pre><h3 id="gc-æ—¥å¿—è¯´æ˜">gc æ—¥å¿—è¯´æ˜</h3>
<pre><code>[2020-03-12T14:38:03,565][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][old][3008939][256208] duration [18.4s], collections [1]/[18.9s], total [18.4s]/[5.7h], memory [7.3gb]-&gt;[7.3gb]/[7.9gb], all_pools {[young] [17.5mb]-&gt;[3.3mb]/[532.5mb]}{[survivor] [0b]-&gt;[0b]/[66.5mb]}{[old] [7.3gb]-&gt;[7.3gb]/[7.3gb]}

[2020-03-12T14:38:03,593][WARN ][o.e.m.j.JvmGcMonitorService] [es7-u] [gc][3008939] overhead, spent [18.4s] collecting in the last [18.9s]
</code></pre><p>æœ¬æ¬¡æ˜¯old gc, è¿™æ˜¯ç¬¬3008939æ¬¡GCæ£€æŸ¥, ä»javaå¯åŠ¨è‡³ä»Šè¿™æ˜¯ç¬¬256208æ¬¡ gc å…±èŠ±18.4s, [ä»ä¸Šæ¬¡æ£€æŸ¥è‡³ä»Šå…±å‘ç”Ÿä¸€æ¬¡gc][ä»ä¸Šæ¬¡æ£€æŸ¥è‡³ä»Šå·²ç»è¿‡å»18.9s],[æœ¬æ¬¡gc18.4s]/[ä» JVM å¯åŠ¨è‡³ä»Šå‘ç”Ÿçš„ GC æ€»è€—æ—¶ä¸º5.7h],  [ GC å‰ Heap memory ç©ºé—´]-&gt;[GC å Heap memory ç©ºé—´]/[Heap memory æ€»ç©ºé—´]</p>
<p>{[young åŒº][GC å‰ Memory ]-&gt;[GCå Memory]/[youngåŒº Memory æ€»å¤§å°] } {[survivor åŒº][GC å‰ Memory ]-&gt;[GCå Memory]/[survivoråŒº Memory æ€»å¤§å°] }{[old åŒº][GC å‰ Memory ]-&gt;[GCå Memory]/[oldåŒº Memory æ€»å¤§å°] }</p>
]]></content>
		</item>
		
	</channel>
</rss>
