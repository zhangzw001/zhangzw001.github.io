<!DOCTYPE html>
<html lang="zh-hans">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Linuxè®¡ç®—æœºåŸºç¡€">
<meta itemprop="description" content="è®¡ç®—æœºåŸºç¡€ è¿›ç¨‹ process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬ è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹ ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢? task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼ task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct è¿›ç¨‹åˆ›å»º init çˆ¶å­å…³ç³» è¿›ç¨‹ fork() ,clone() CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶) å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰ è¿›ç¨‹ä¼˜å…ˆçº§(priority) 0-139: 1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜) 100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜) Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§ -20,19(å¯¹åº”100-139) 2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ— è¿›ç¨‹å†…å­˜ page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨ è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´ ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame IPC : inter Process Communication åŒä¸€ä¸»æœºä¸Š: signal shm : shared memory semerphor : ä¸åŒä¸»æœºä¸Š: rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ socket : https://blog.">
<meta itemprop="datePublished" content="2021-03-31T10:47:24+08:00" />
<meta itemprop="dateModified" content="2021-03-31T10:47:24+08:00" />
<meta itemprop="wordCount" content="5026">



<meta itemprop="keywords" content="linux," />
<meta property="og:title" content="Linuxè®¡ç®—æœºåŸºç¡€" />
<meta property="og:description" content="è®¡ç®—æœºåŸºç¡€ è¿›ç¨‹ process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬ è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹ ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢? task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼ task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct è¿›ç¨‹åˆ›å»º init çˆ¶å­å…³ç³» è¿›ç¨‹ fork() ,clone() CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶) å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰ è¿›ç¨‹ä¼˜å…ˆçº§(priority) 0-139: 1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜) 100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜) Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§ -20,19(å¯¹åº”100-139) 2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ— è¿›ç¨‹å†…å­˜ page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨ è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´ ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame IPC : inter Process Communication åŒä¸€ä¸»æœºä¸Š: signal shm : shared memory semerphor : ä¸åŒä¸»æœºä¸Š: rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ socket : https://blog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ngirl.xyz/posts/66-linux%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" />
<meta property="article:published_time" content="2021-03-31T10:47:24+08:00" />
<meta property="article:modified_time" content="2021-03-31T10:47:24+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxè®¡ç®—æœºåŸºç¡€"/>
<meta name="twitter:description" content="è®¡ç®—æœºåŸºç¡€ è¿›ç¨‹ process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬ è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹ ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢? task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼ task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct è¿›ç¨‹åˆ›å»º init çˆ¶å­å…³ç³» è¿›ç¨‹ fork() ,clone() CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶) å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰ è¿›ç¨‹ä¼˜å…ˆçº§(priority) 0-139: 1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜) 100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜) Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§ -20,19(å¯¹åº”100-139) 2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ— è¿›ç¨‹å†…å­˜ page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨ è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´ ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame IPC : inter Process Communication åŒä¸€ä¸»æœºä¸Š: signal shm : shared memory semerphor : ä¸åŒä¸»æœºä¸Š: rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ socket : https://blog."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Linuxè®¡ç®—æœºåŸºç¡€</title>
	<link rel="stylesheet" href="https://www.ngirl.xyz/css/style.min.d3141168199607bf3a517216ce3c263814eecdbc8fca72a9a88700799a838219.css">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.ngirl.xyz">zhangzw</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.ngirl.xyz/golang/">golang</a>
					<a href="https://www.ngirl.xyz/k8s/">k8s</a>
					<a href="https://www.ngirl.xyz/posts/">æ–‡ç« </a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/zhangzw001" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.ngirl.xyz/posts/">æ–‡ç« </a></li>
			<li><a href="https://www.ngirl.xyz/tags/">æ ‡ç­¾</a></li>
			<li><a href="https://www.ngirl.xyz/about/">å…³äº</a></li>
		</ul>
	</div>



	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Mar 31, 2021</span></div>
				<h1>Linuxè®¡ç®—æœºåŸºç¡€</h1>
			</header>
			<div class="content">
				<h2 id="è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€<a href="#è®¡ç®—æœºåŸºç¡€" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="è¿›ç¨‹">è¿›ç¨‹<a href="#è¿›ç¨‹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>process : è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸€ä¸ªå‰¯æœ¬

è¿›ç¨‹ä¸­æ–­ä¼šä¿å­˜ç°åœº,ç„¶åä¸åœåˆ‡æ¢æ‰§è¡Œä¸åŒçš„è¿›ç¨‹
ä¿å­˜ç°åœºä¿å­˜åœ¨å“ªå‘¢?

task struct : linuxå†…æ ¸å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„å›ºå®šæ ¼å¼
task list : é“¾è¡¨æ–¹å¼ä¿å­˜ task struct
</code></pre><p><img src="/images/66/markdown-img-paste-20210624115848639.png" alt=""></p>
<pre><code>è¿›ç¨‹åˆ›å»º
    init
        çˆ¶å­å…³ç³»
        è¿›ç¨‹
            fork() ,clone()
            CoW å†™æ—¶å¤åˆ¶, çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€å¼€å§‹éƒ½æ˜¯åŒæ ·çš„å†…å­˜ç©ºé—´,ä½†æ˜¯éœ€è¦å†™æ•°æ®(æˆå®¶),å°±éœ€è¦åˆ†é…æ–°å†…å­˜ç©ºé—´(åˆ†å®¶)
        å­è¿›ç¨‹å¿…é¡»ç”±çˆ¶è¿›ç¨‹å…³é—­: å­è¿›ç¨‹æ‰§è¡Œå®Œçˆ¶è¿›ç¨‹ä»»åŠ¡å, çˆ¶è¿›ç¨‹å°±æ¸…ç†å­è¿›ç¨‹çš„å†…å­˜ç­‰
    è¿›ç¨‹ä¼˜å…ˆçº§(priority)
        0-139:
            1-99 : å®æ—¶ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜)
            100-139 : é™æ€ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
            Niceå€¼ : è°ƒæ•´niceå€¼æ¥è°ƒæ•´ä¼˜å…ˆçº§,åªèƒ½å˜å¥½,åªèƒ½é™ä½ä¼˜å…ˆçº§
                -20,19(å¯¹åº”100-139)
        2*140ä¸ªè¿è¡Œé˜Ÿåˆ— : ç›¸åŒä¼˜å…ˆçº§æ”¾å…¥åŒæ ·é˜Ÿåˆ—, åªéœ€è¦æ‰«æé¦–éƒ¨, å½“åˆ†é…çš„æ—¶é—´è¾¾åˆ°äº†,éœ€è¦ä¸­æ–­æ˜¯,å°†è¿è¡Œå¦å¤–ä¸€å¯¹é˜Ÿåˆ—

    è¿›ç¨‹å†…å­˜
        page frame : å†…æ ¸å°†ç‰©ç†å†…å­˜æ‹†åˆ†ä¸ºpage frame, ç„¶åç¨‹åºéœ€è¦çš„æ—¶å€™é€šè¿‡page frame ç´¯åŠ åœ¨ä¸€èµ·, ç»„æˆè™šæ‹Ÿå†…å­˜ç©ºé—´æ®µ, æä¾›è¿›ç¨‹ä½¿ç”¨
        è™šæ‹Ÿå†…å­˜: å†…æ ¸é€šè¿‡page frame ç»„æˆçš„çº¿æ€§åœ°å€ç©ºé—´
        ç‰©ç†å†…å­˜: å®é™…çš„ç‰©ç†å†…å­˜å¤§å°, ä¼šè¢«æ‹†åˆ†æˆpage frame

    IPC : inter Process Communication
        åŒä¸€ä¸»æœºä¸Š:
            signal
            shm : shared memory
            semerphor :
        ä¸åŒä¸»æœºä¸Š:
            rpc : remote procecure calling è¿œç¨‹è¿‡ç¨‹è°ƒç”¨
            socket : https://blog.csdn.net/pashanhu6402/article/details/96428887
</code></pre><h4 id="ps">ps<a href="#ps" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>pså‘½ä»¤
    /proc/ å†…æ ¸çŠ¶æ€ä¿¡æ¯
        å†…æ ¸å‚æ•°:
            å¯è®¾ç½®å™¨å€¼çš„å‚æ•°  /proc/sys/
            çŠ¶æ€å˜é‡, ä»…æŸ¥çœ‹
        å‚æ•°: æ¨¡æ‹Ÿæˆæ–‡ä»¶ç³»ç»Ÿç±»å‹
    è¿›ç¨‹:
        /proc/[0-9]+ :
            [0-9]+ : pidç›®å½•

    ä¸‰ç§é£æ ¼:
        1   UNIX options, which may be grouped and must be preceded by a dash.
        2   BSD options, which may be grouped and must not be used with a dash.
        3   GNU long options, which are preceded by two dashes.
    å¯åŠ¨è¿›ç¨‹çš„æ–¹å¼:
        1. ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­è‡ªåŠ¨å¯åŠ¨, ä¸ç»ˆç«¯æ— å…³
        2. ç»ˆç«¯å¯åŠ¨, è¿›ç¨‹ä¼šéšç»ˆç«¯é€€å‡ºè€Œé€€å‡º

    é€‰é¡¹:
        1. a : æ‰€æœ‰ä¸ç»ˆç«¯ç›¸å…³çš„è¿›ç¨‹
        2. x : æ‰€æœ‰ä¸ç»ˆç«¯æ— å…³çš„è¿›ç¨‹
            $ ps ax|head -1
            PID TTY      STAT   TIME COMMAND
            1 ?        Ss    14:26 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
            2 ?        S      0:00 [kthreadd]
                å¸¦ä¸­æ‹¬å·çš„æ˜¯å†…æ ¸çº¿ç¨‹
        3. u : ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒ  ç»„ç»‡çŠ¶æ€ä¿¡æ¯æ˜¾ç¤º
            # å¸¸ç”¨ç»„åˆ1
            $ ps aux|head -1
            USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
                1. VSZ è™šæ‹Ÿå†…å­˜é›†
                2. RSS ResIdent Size å¸¸é©»å†…å­˜;
                3. STAT
                    R : running
                    S : Interruptable sleeping
                    D : UnInterruptable sleeping
                    T : Stopped
                    Z : zomble çˆ¶è¿›ç¨‹æœªæ¸…ç†æ—¶å°±ä¼šä¸€ç›´ä¿æŒåƒµå°¸æ€
                    + : å‰å°è¿›ç¨‹
                    l : å¤šçº¿ç¨‹è¿›ç¨‹
                    N : ä½ä¼˜å…ˆçº§è¿›ç¨‹(nice)
                    &lt; : é«˜ä¼˜å…ˆçº§è¿›ç¨‹
                    s : session leader
        4. -e : æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹
        5. -f : æ˜¾ç¤ºå®Œæ•´æ ¼å¼
            # å¸¸ç”¨ç»„åˆ2
            $ ps -ef |head -1
            UID        PID  PPID  C STIME TTY          TIME CMD
        6. -F : æ˜¾ç¤ºå®Œæ•´æ ¼å¼
            #
            $ ps -eF |head -1
            UID        PID  PPID  C    SZ   RSS PSR STIME TTY          TIME CMD
            C : cpu utillization
            PSR : è¿è¡Œåœ¨å“ªä¸ªcpuä¸Š
        7 -H : ä»¥å±‚çº§ç»“æ„æ˜¾ç¤ºè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯
            # å¸¸ç”¨ç»„åˆ3
            ps -eFH
            $ å¸¸ç”¨ç»„åˆ4 -eo, axo
                o field1,field2: è‡ªå®šä¹‰è¦æ˜¾ç¤ºçš„å­—æ®µåˆ—è¡¨, é€—å·åˆ†éš”
                    å¸¸ç”¨çš„field: pid, ni,pri,psr,pcpu,stat,comm,tty,ppid,rtprio
                    pri : priority ä¼˜å…ˆçº§
                    rtprio read time priority å®æ—¶ä¼˜å…ˆçº§
                ps axo pid,command
</code></pre><h4 id="vmstat">vmstat<a href="#vmstat" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>$ vmstat -w 1
procs -----------------------memory---------------------- ---swap-- -----io---- -system-- --------cpu--------
 r  b         swpd         free         buff        cache   si   so    bi    bo   in   cs  us  sy  id  wa  st
</code></pre><pre><code>memory
    swpd : äº¤æ¢å†…å­˜ä½¿ç”¨æ€»é‡
    free : ç©ºé—²
    buff : ç”¨äºbuffer
    cache : ç”¨æˆ·cache
swap
    si (swap in) : æ¢è¿›,è¿›å…¥swapçš„é€Ÿç‡(kb/s),å†…å­˜è¿›swap
    so (swap out): æ¢å‡º,ç¦»å¼€swapçš„é€Ÿç‡(kb/s),swapå›å†…å­˜
io
    bi (block in): ä»å—è®¾å¤‡è¯»å–åˆ°å†…å­˜çš„é€Ÿç‡(kb/s)
    bo (block out): ä¿å­˜æ•°æ®è‡³å—è®¾å¤‡çš„é€Ÿç‡
system
    in (interrupts) : ä¸­æ–­é€Ÿç‡
    cs (context switch) : ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿç‡
</code></pre><pre><code>-w å®½æ˜¾ç¤º
-s æ˜¾ç¤ºå†…å­˜ç»Ÿè®¡æ•°æ®

</code></pre><h4 id="pmap">pmap<a href="#pmap" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>pmap 1
    -x : æ˜¾ç¤ºè¯¦ç»†æ ¼å¼ä¿¡æ¯

å¦ä¸€ç§æŸ¥çœ‹æ–¹å¼: cat /proc/1/maps
</code></pre><h4 id="dstat-å¼ºå¤§">dstat (å¼ºå¤§ğŸ‘)<a href="#dstat-å¼ºå¤§" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>$ dstat
You did not select any stats, using -cdngy by default.
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw
</code></pre><h3 id="ç½‘ç»œå®¢æˆ·ç«¯">ç½‘ç»œå®¢æˆ·ç«¯<a href="#ç½‘ç»œå®¢æˆ·ç«¯" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="hping">hping<a href="#hping" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<h3 id="linuxå†…æ ¸">Linuxå†…æ ¸<a href="#linuxå†…æ ¸" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="å†…æ ¸è®¾è®¡æµæ´¾">å†…æ ¸è®¾è®¡æµæ´¾<a href="#å†…æ ¸è®¾è®¡æµæ´¾" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>å•å†…æ ¸è®¾è®¡: linux
å¾®å†…æ ¸è®¾è®¡: Winodows,Solaris
</code></pre><h4 id="linuxå†…æ ¸ç‰¹ç‚¹">Linuxå†…æ ¸ç‰¹ç‚¹<a href="#linuxå†…æ ¸ç‰¹ç‚¹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>æ”¯æŒæ¨¡å—åŒ–:  *.ko(kernel object)
&gt; å¦å¤–ä¸€ä¸ªå¯¹è±¡: *.so(share object)

æ”¯æŒæ¨¡å—è¿è¡Œæ—¶åŠ¨æ€è£…è½½æˆ–å¸è½½
</code></pre><h4 id="ç»„æˆéƒ¨åˆ†">ç»„æˆéƒ¨åˆ†<a href="#ç»„æˆéƒ¨åˆ†" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>æ ¸å¿ƒæ–‡ä»¶: /boot/vmlinuz-VERSION-release
ramdisk:
  - centos5: /boot/initrd-VERSION-release.Img
    - å·¥å…·è‡ªåŠ¨åˆ›å»º: mkinitrd
  - centos6,7 : /boot/Initramfs-VERSION-release.Img
    - å·¥å…·è‡ªåŠ¨åˆ›å»º: dracut,mkinitrd(åªæ˜¯ä¸ºäº†å…¼å®¹,å°è£…dracut)

æ¨¡å—æ–‡ä»¶: /lib/modules/VERSION-release
</code></pre><ul>
<li>ramdisk</li>
</ul>
<pre><code>centos5çš„ rd=ramdisk, æ˜¯æŠŠå†…å­˜å½“åšç£ç›˜ä½¿ç”¨
centos6,7çš„ramfs=ramçš„æ–‡ä»¶ç³»ç»Ÿ
ramdiskæ˜¯æŠŠå†…å­˜å½“åšç£ç›˜ä½¿ç”¨, æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ç£ç›˜ä¸€èˆ¬ä¼šå…ˆåŠ è½½åˆ°å†…å­˜(buffer/cache),ç„¶ååœ¨ä½¿ç”¨, ä¸ºäº†è¯»å–æ›´å¿«
ä½†æ˜¯ramdiskçš„æ¨¡å¼ä¸‹ç£ç›˜å°±æ˜¯å†…å­˜,è¯»å–ä¹‹å‰å†æ¬¡åŠ è½½åˆ°bufferå°±æ²¡æœ‰æ„ä¹‰äº†
å› æ­¤centos6,7 ä½¿ç”¨ramçš„æ–‡ä»¶ç³»ç»Ÿ

ramdisk å…¶å®æ˜¯ä¸€ä¸ªç®€è£…ç‰ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
</code></pre><h4 id="centosç³»ç»Ÿmbrå¯åŠ¨æµç¨‹">centosç³»ç»Ÿmbrå¯åŠ¨æµç¨‹:<a href="#centosç³»ç»Ÿmbrå¯åŠ¨æµç¨‹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>1. POST: åŠ ç”µè‡ªæ£€; (è¿™æ˜¯ä¸€æ®µcpuåœ¨ç”Ÿäº§çš„æ—¶å€™çƒ§å†™çš„ç¨‹åº)
    - ROM: CMOS
        - BIOS: Basic Input and Output System
    - ROM+RAM: CPUå¯ä»¥è®¿é—®çš„å¯»å€ç©ºé—´
2. Boot Sequence:
    - æŒ‰æ¬¡åºæŸ¥æ‰¾å„å¼•å¯¼è®¾å¤‡, ç¬¬ä¸€ä¸ªæœ‰å¼•å¯¼ç¨‹åºçš„è®¾å¤‡å³ä¸ºæœ¬æ¬¡å¯åŠ¨è¦ç”¨åˆ°çš„è®¾å¤‡(uç›˜, ç£ç›˜)
    - bootloader: å¼•å¯¼åŠ è½½å™¨,å°±æ˜¯æˆ‘ä»¬å®‰è£…åˆ°ç£ç›˜æˆ–è€…uç›˜ä¸Šçš„ç¨‹åº
            - Windows : ntloader
            - Linux:
            - LILO : LInux LOader (ç£ç›˜å¤§äº1024æŸ±é¢æ— æ³•åŠ è½½,ç›®å‰å®‰å“æ‰‹æœº)
            - GRUB : Grand Uniform Bootloader
                - GRUB 0.X(centos[56]) -&gt; é‡å Grub legacy
                - GRUB 1.X(centos7) -&gt; å®Œå…¨é‡æ–°,é‡å Grub2
                - åŠŸèƒ½: æä¾›ä¸€ä¸ªèœå•,å…è®¸ç”¨æˆ·é€‰æ‹©è¦å¯åŠ¨çš„ç³»ç»Ÿæˆ–ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬;æŠŠå†…æ ¸è£…è½½åˆ°RAMçš„ç‰¹å®šç©ºé—´, è§£å‹,æŠŠç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™å†…æ ¸
        - MBR : Master Boot Record
            - 512bytes:
            - 446bytes : bootloader,ä»£ç é‡å°,ä¸æ”¯æŒåŠ è½½é€»è¾‘åˆ†åŒº
            - 64bytes : fat åˆ†åŒºè¡¨
            - 2bytes : 55AA=æœ‰æ•ˆ,å…¶ä»–XXXX=æ— æ•ˆ
        - GRUB : ç”±äº446byteså¤ªå°äº†, grubé‡æ–°è®¾è®¡
            - bootloader : ç¬¬1é˜¶æ®µ,ä»¥å‰çš„bootloaderç›®çš„éƒ½æ˜¯ç›´æ¥è¯»å–446bytesè£…è½½å†…æ ¸åˆ°ramç©ºé—´,ç„¶åæ§åˆ¶æƒäº¤ç»™å†…æ ¸, grubçš„bootloaderä½œä¸ºç¬¬ä¸€æ­¥,ä¸»è¦å°±æ˜¯ä¸ºäº†ç¬¬äºŒéƒ¨,åŠ è½½/boot/grub,è¿™æ®µç¨‹åºå°±å¯ä»¥ä¸å—MBR446bytesé™åˆ¶,å¯ä»¥æ“ä½œæ€§å¼º, ç”šè‡³å¯ä»¥æä¾›å¯äº¤äº’çš„uiç•Œé¢
            - Partition filesystem driver: 1.5 é˜¶æ®µ ? ä¸ºä»€ä¹ˆéœ€è¦?
            - partition : /boot/grub , ç¬¬2é˜¶æ®µ,æ­¤æ—¶è¯¥æ­¥éª¤çš„uiç•Œé¢é€‰æ‹©å®Œå†…æ ¸ä¹‹å,è§£å‹,æŠŠç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™å†…æ ¸
        - äº†è§£ EFI(UEFI) GPT :
3. åŠ è½½Kernel: å†…æ ¸è·å¾—æ§åˆ¶æƒå
        - è‡ªèº«åˆå§‹åŒ–
            - æ¢æµ‹å¯è¯†åˆ«åˆ°çš„æ‰€æœ‰ç¡¬ä»¶è®¾å¤‡
            - åŠ è½½ç¡¬ä»¶é©±åŠ¨ç¨‹åº(æœ‰å¯èƒ½å€ŸåŠ©äºramdisk)
            - ä»¥åªè¯»æ–¹å¼æŒ‚è½½è·Ÿæ–‡ä»¶ç³»ç»Ÿ(rootfs)
            - è¿è¡Œç”¨æˆ·æ§ä»¶çš„ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº: /sbin/init
                - initç¨‹åºçš„ç±»å‹
                - centos5 : SysV init
                    - é…ç½®æ–‡ä»¶ : /etc/inittab
                - centos6 : Upstart
                    - é…ç½®æ–‡ä»¶ :
                        - /etc/inittab å®é™…ä¸ç”¨,å…¼å®¹5
                        - /etc/init/*.conf
                - centos7 : Systemd
                    - é…ç½®æ–‡ä»¶: /usr/lib/systemd/system, /etc/systemd/system


    ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ç®€å•æ€»ç»“(å†…æ ¸) : åŠ ç”µè‡ªæ£€POST -&gt; BootSequence(BIOS) -&gt; å¼•å¯¼ç¨‹åºBootloader(MBR) -&gt; åŠ è½½Kernel(ramdisk) -&gt; æŒ‚è½½rootfs(readonly) -&gt; åˆå§‹åŒ–/sbin/init


4. åˆå§‹åŒ– /sbin/init
    - centos5 : sysV init
        - è¿è¡Œçº§åˆ«: ä¸ºäº†ç³»ç»Ÿçš„è¿è¡Œæˆ–ç»´æŠ¤ç­‰ç›®çš„è€Œè®¾è®¡çš„æœºåˆ¶;
            - 0-6:
                - 0 : å…³æœº, shutdown
                - 1 : å•ç”¨æˆ·æ¨¡å¼(single user): rootç”¨æˆ·, æ— éœ€è®¤è¯, ç»´æŠ¤æ¨¡å¼
                - 2 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : ä¼šå¯åŠ¨ç½‘ç»œåŠŸèƒ½, ä½†ä¸ä¼šå¯åŠ¨NFS, é¡»è®¤è¯,ç»´æŠ¤æ¨¡å¼
                - 3 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : å®Œå…¨åŠŸèƒ½æ¨¡å¼, æ— æ¡Œé¢
                - 4 : é¢„ç•™æ¨¡å¼ : æ— ç‰¹åˆ«ä½¿ç”¨ç›®çš„, ä¹ æƒ¯åŒ3ç•Œåˆ«åŠŸèƒ½
                - 5 : å¤šç”¨æˆ·æ¨¡å¼(multi user) : å®Œå…¨åŠŸèƒ½æ¨¡å¼, æœ‰æ¡Œé¢
                - 6 : é‡å¯æ¨¡å¼
            - é»˜è®¤çº§åˆ«: 3,5
            - çº§åˆ«åˆ‡æ¢: init [0-6]
            - çº§åˆ«æŸ¥çœ‹: who -r  æˆ– runlevel
        - é…ç½®æ–‡ä»¶: /etc/inittab
            - æ¯ä¸€è¡Œå®šä¹‰ä¸€ç§actionä»¥åŠé˜ˆå€¼å¯¹åº”çš„process
                - id:runlevels:action:process
                    - id: ä¸€ä¸ªä»»åŠ¡çš„æ ‡è¯†ç¬¦
                    - runlevels: åœ¨å“ªäº›çº§åˆ«å¯åŠ¨æ­¤ä»»åŠ¡
                    - action : åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹å¯åŠ¨æ­¤ä»»åŠ¡
                    - process : ç¨‹åº
                - actions:
                    - wait : ç­‰å¾…åˆ‡æ¢è‡³æ­¤ä»»åŠ¡æ‰€åœ¨çš„çº§åˆ«æ—¶æ‰§è¡Œä¸€æ¬¡ (l0:0:wait:/etc/rc.d/rc 0)
                    - respawn : ä¸€æ—¦æ­¤ä»»åŠ¡ç»ˆæ­¢æ—¶,å°±è‡ªåŠ¨é‡æ–°å¯åŠ¨ (1:2345:respawn:/sbin/mingetty tty1)
                    - initdefault : è®¾å®šé»˜è®¤è¿è¡Œçº§åˆ« (id:3:initdefault:)
                    - sysinit : è®¾å®šåˆå§‹åŒ–æ–¹å¼ (si::sysinit:/etc/rc.d/rc.sysinit)
                - /etc/rc.d/rc
                    - è¯¥è„šæœ¬ä¼šåœæ­¢æ‰€æœ‰/etc/rc.d/rc$runlevel.d/K##*è„šæœ¬,
                    - å¯åŠ¨æ‰€æœ‰/etc/rc.d/rc$runlevel.d/S##*è„šæœ¬
                    - K,S åé¢çš„æ•°å­—è¡¨ç¤ºå¯åŠ¨å’Œå…³é—­çš„é¡ºåº
                - chkconfig : ç®¡æ§/etc/init.dæ¯ä¸ªæœåŠ¡è„šæœ¬åœ¨å„ä¸ªçº§åˆ«ä¸‹çš„å¯åŠ¨æˆ–å…³é—­çŠ¶æ€
                    - chkconfig --add nginxd : æ·»åŠ åˆ°chkconfigç®¡ç†, å³ä¾¿è„šæœ¬å†™æˆ2345, ä¹Ÿä¼šåˆ›å»º0-6çº§åˆ«æ‰€æœ‰éƒ½æ˜¯Kxxnginxd
                        - è„šæœ¬æ ¼å¼:
                          - æ–¹æ³•1: é™„å½•1
                          - æ–¹æ³•2: é™„å½•2
                    - chkconfig nginxd on : æ­¤æ—¶ 2345 çº§åˆ«ä¼šåˆ›å»ºSxxnginxd
                    - chkconfig --level 35 nginxd : ä¿®æ”¹35
                    - chkconfig nginxd off: æ­¤æ—¶ 2345 çº§åˆ«ä¼šåˆ›å»ºKxxnginxd
                    - chkconfig --del nginxd
                - ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ : /etc/rc.d/rc.sysinit
                    - 1. è®¾ç½®ä¸»æœºå
                    - 2. è®¾ç½®æ¬¢è¿ä¿¡æ¯
                    - 3. æŒ‚è½½udevå’Œselinux
                    - 4. æŒ‚è½½/etc/fstabæ–‡ä»¶ä¸­å®šä¹‰çš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿ
                    - 5. æ£€æµ‹æ ¹æ–‡ä»¶ç³»ç»Ÿ, å¹¶ä»¥è¯»å†™æ–¹å¼é‡æ–°æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
                    - 6 è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ
                    - 7 æ ¹æ®/etc/sysctl.confè®¾å®šå†…æ ¸å‚æ•°
                    - 8 æ¿€æ´»lvm è½¯raidè®¾å¤‡
                    - 9 æ¿€æ´»swapè®¾å¤‡(/etc/fstab)
                    - 10 åŠ è½½é¢å¤–è®¾å¤‡çš„é©±åŠ¨ç¨‹åº
                    - 11 æ¸…ç†æ“ä½œ

        ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ç®€å•æ€»ç»“(ç”¨æˆ·ç©ºé—´): /sbin/init(/etc/inittab)
            è®¾ç½®é»˜è®¤è¿è¡Œçº§åˆ« -&gt; è¿è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬, å®Œæˆåˆå§‹åŒ– -&gt; å…³é—­å¯¹åº”çº§åˆ«ä¸‹è¦åœæ­¢çš„æœåŠ¡, å¯åŠ¨æœåŠ¡ -&gt; è®¾ç½®ç™»å½•ç»ˆç«¯

    - centos6
        - initç¨‹åº: upstart, ä½†ä¾ç„¶å‘½åä¸º/sbin/init
        - é…ç½®æ–‡ä»¶: /etc/init/*.conf, /etc/inittab(ä¹Ÿä¼šè¯»å–, ä½†ä»…å…è®¸é…ç½®å…è®¸çº§åˆ«)

    - centos7
        - initç¨‹åº: systemd
        - é…ç½®æ–‡ä»¶: /usr/lib/systemd/system/*, /etc/systemd/system/*
        - å®Œå…¨å…¼å®¹sysVè„šæœ¬æœºåˆ¶

</code></pre><blockquote>
<p>é™„å½•1</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span> <span class="c1">#filename: nginxd</span>
 <span class="c1"># nginx - this script starts and stops the nginx daemon</span>
 <span class="c1">#</span>
 <span class="c1"># chkconfig:   - 85 15</span>
 <span class="c1"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span>
 <span class="c1">#               proxy and IMAP/POP3 proxy server</span>
 <span class="c1"># processname: nginx</span>
 <span class="c1"># config:      /etc/nginx/nginx.conf</span>
 <span class="c1"># config:      /etc/sysconfig/nginx</span>
 <span class="c1"># pidfile:     /var/run/nginx.pid</span>

 <span class="c1"># Source function library.</span>
 . /etc/rc.d/init.d/functions

 <span class="c1"># Source networking configuration.</span>
 . /etc/sysconfig/network

</code></pre></div><blockquote>
<p>é™„å½•2</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#! /bin/sh
</span><span class="cp"></span>
<span class="c1">### BEGIN INIT INFO</span>
<span class="c1"># Provides:          php-fpm</span>
<span class="c1"># Required-Start:    $remote_fs $network</span>
<span class="c1"># Required-Stop:     $remote_fs $network</span>
<span class="c1"># Default-Start:     2 3 4 5</span>
<span class="c1"># Default-Stop:      0 1 6</span>
<span class="c1"># Short-Description: starts php-fpm</span>
<span class="c1"># Description:       starts the PHP FastCGI Process Manager daemon</span>
<span class="c1">### END INIT INFO</span>
</code></pre></div><h4 id="grub">grub<a href="#grub" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>grub : grand unified bootloader
    - grub 0.x : grub legacy
    - grub 1.x : grub2

grub legacy:
    stage1 : MBR
    stage1_5 : mbrä¹‹åçš„æ‰‡åŒº,è®©stage1ä¸­çš„bootloèƒ½è¯†åˆ«stage2æ‰€åœ¨çš„åˆ†åŒºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ
    stage2 : ç£ç›˜åˆ†åŒº(/boot/grub)

    é…ç½®æ–‡ä»¶ : /boot/grub/grub.conf &lt;- /etc/grub.conf

    stage2åŠå†…æ ¸ç­‰é€šå¸¸æ”¾ç½®äºä¸€ä¸ªåŸºæœ¬ç£ç›˜åˆ†åŒº:
        (1) æä¾›èœå•,å¹¶æä¾›äº¤äº’å¼æ¥å£
            e: ç¼–è¾‘æ¨¡å¼,ç”¨æˆ·ç¼–è¾‘èœå•
            c: å‘½ä»¤æ¨¡å¼,å‘½ä»¤æ¥å£
        (2) åŠ è½½ç”¨æˆ·æ‰€é€‰æ‹©çš„å†…æ ¸
            å…è®¸ä¼ å‚ç»™å†…æ ¸
            å¯éšè—æ­¤èœå•
        (3) ä¸ºèœå•æä¾›ä¿æŠ¤æœºåˆ¶
            ä¸ºç¼–è¾‘èœå•è¿›è¡Œè®¤è¯
            ä¸ºå¯ç”¨å†…æ ¸æˆ–æ“ä½œç³»ç»Ÿè¿›è¡Œè®¤è¯
    grubçš„å‘½ä»¤æ¥å£:
        help: å¸®åŠ©åˆ—è¡¨
        find (hd0,0)/vmlinux-ä¸¤æ¬¡tab
        root (hd0,0) è®¾ç½® (hd0,0) ä¸ºæ ¹
        kernel /vmlinuz-VERSION-release ro root=/dev/vg0/root, zè¡¨ç¤ºå‹ç¼©æ ¼å¼, æœ¬æ¬¡å¯åŠ¨æ—¶ç”¨åˆ°çš„å†…æ ¸æ–‡ä»¶
        initrd /initrd-VERSION-release.img æˆ– /initramfs-VERSION-release.img
        boot å¼•å¯¼å¯åŠ¨é€‰å®šçš„å†…æ ¸
</code></pre><h4 id="æ¨¡å—module">æ¨¡å—module<a href="#æ¨¡å—module" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>å†…æ ¸æ¨¡å—ç®¡ç† :
    lsmod: æ˜¾ç¤ºå†…æ ¸å·²è£…è½½æ¨¡å—

    åŠ¨æ€è£…å¸è½½æ¨¡å— :
        å¸è½½ : modprobe -r MOD_NAME
        è£…è½½ : modprobe MOD_NAME

        è£…è½½ : insmod /path/to/module_file
        å¸è½½ : rmmod MOD_NAME

    æŸ¥çœ‹æŸæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯ :
        modinfo MOD_NAME

    æ£€æŸ¥å¹¶ç”Ÿæˆæ¨¡å—é—´ä¾èµ–å…³ç³»çš„å‘½ä»¤ :
        depmod
</code></pre><h4 id="sysctl">sysctl<a href="#sysctl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li>/proc</li>
</ul>
<pre><code># è·¯ç”±è½¬å‘åŠŸèƒ½
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
# æ¸…ç†cache
echo 1 &gt; /proc/sys/vm/drop_caches
# å½“å‰ä¸»æœºå
cat /proc/sys/kernel/hostname
# ç¦ping
echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all
</code></pre><ul>
<li>/sysç›®å½•</li>
</ul>
<pre><code>sysfs : è¾“å‡ºå†…æ ¸è¯†åˆ«å‡ºçš„å„ç¡¬ä»¶è®¾å¤‡çš„ç›¸å…³å±æ€§ä¿¡æ¯
udev : é€šè¿‡è¯»å–/sysç›®å½•çš„ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯ æŒ‰éœ€ä¸ºç¡¬ä»¶è®¾å¤‡åˆ›å»ºè®¾å¤‡æ–‡ä»¶
</code></pre><h4 id="ç¼–è¯‘å†…æ ¸è¿‡ç¨‹">ç¼–è¯‘å†…æ ¸è¿‡ç¨‹<a href="#ç¼–è¯‘å†…æ ¸è¿‡ç¨‹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>ä¸‹è½½åˆ°/usr/src/linux-4.19.195.tar.xz
make menuconfig  é…ç½®å†…æ ¸é€‰é¡¹
make
make modules_install å®‰è£…å†…æ ¸æ¨¡å—

screen:
    æ‰“å¼€: screen
    æ‹†é™¤: ctrl+a,d
    åˆ—è¡¨: screen -ls
    è¿æ¥è‡³: screen -r screen_id  
    é€€å‡º: exit
</code></pre><h4 id="sytemd">sytemd<a href="#sytemd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li>systemdçš„æ–°ç‰¹æ€§</li>
</ul>
<pre><code>ç³»ç»Ÿå¼•å¯¼æ—¶å®ç°æœåŠ¡å¹¶è¡Œå¯åŠ¨
æŒ‰éœ€æ¿€æ´»è¿›ç¨‹
ç³»ç»ŸçŠ¶æ€å¿«ç…§
åŸºäºä¾èµ–å…³ç³»å®šä¹‰çš„æœåŠ¡æ§åˆ¶é€»è¾‘
</code></pre><ul>
<li>æ ¸å¿ƒæ¦‚å¿µ-unit</li>
</ul>
<pre><code>ç”±å…¶ç›¸å…³é…ç½®æ–‡ä»¶è¿›è¡Œæ ‡è¯†,è¯†åˆ«å’Œé…ç½®;æ–‡ä»¶ä¸­ä¸»è¦åŒ…å«äº†ç³»ç»ŸæœåŠ¡,ç›‘å¬çš„socket,ä¿å­˜çš„å¿«ç…§,initç›¸å…³çš„ä¿¡æ¯
    /usr/lib/systemd/system
    /etc/systemd/system
    /run/systemd/system(ä¸é‡è¦)
unitåœºå‡ç±»å‹:
    Service uint(x.service): ç”¨äºå®šä¹‰ç³»ç»ŸæœåŠ¡
    Target unit(x.target) : ç”¨äºæ¨¡æ‹Ÿå®ç°&quot;è¿è¡Œçº§åˆ«&quot;,systemdæ˜¯æ²¡æœ‰sysVçš„runlevelæ¦‚å¿µ
    Device uint(x.device) : ç”¨äºå®šä¹‰å†…æ ¸è¯†åˆ«çš„è®¾å¤‡
    Mount uint(x.mount)   : ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
    Socket uint(x.socket) : ç”¨äºè¡¨ç¤ºè¿›ç¨‹é—´é€šä¿¡ç”¨åˆ°çš„socketæ–‡ä»¶
    Snapshot unit(x.snapshot) : ç®¡ç†ç³»ç»Ÿå¿«ç…§
    Swap uint(x.swap) : ç”¨äºç®¡ç†æ ‡è¯†swapè®¾å¤‡
    AutoMount unit(x.automount): æ–‡ä»¶ç³»ç»Ÿè‡ªåŠ¨æŒ‚è½½ç‚¹è®¾å¤‡
    Path unit(.path) : ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€æ–‡ä»¶æˆ–ç›®å½•

å…³é”®ç‰¹æ€§:
    åŸºäºsocketçš„æ¿€æ´»æœºåˆ¶ : socketå’Œç¨‹åºåˆ†ç¦»
    åŸºäºbusçš„æ¿€æ´»æœºåˆ¶
    åŸºäºdeviceçš„æ¿€æ´»æœºåˆ¶
    åŸºäºpathçš„æ¿€æ´»æœºåˆ¶
    ç³»ç»Ÿå¿«ç…§: ä¿å­˜å„unitçš„å½“å‰çŠ¶æ€ä¿¡æ¯ äºåƒé…’å­˜å‚¨è®¾å¤‡ä¸­
    å‘åå…¼å®¹sysv initè„šæœ¬
        /etc/init.d/ ç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥é€šè¿‡systemctlç®¡ç†
ä¸å…¼å®¹:
    systemctlçš„å‘½ä»¤æ˜¯å›ºå®šçš„
    éç”±systemdå¯åŠ¨çš„æœåŠ¡,systemctlæ— æ³•æ§åˆ¶

</code></pre><ul>
<li>å¸¸ç”¨å‘½ä»¤</li>
</ul>
<pre><code># æŸ¥çœ‹æ˜¯å¦æ¿€æ´»
systemctl is-active nginx.service
# æŸ¥çœ‹å·²æ¿€æ´»çš„service
systemctl list-units --type service
# æŸ¥çœ‹æ‰€æœ‰çš„æœåŠ¡
systemctl list-units -t service -a

# è®¾ç½®å¼€æœºå¯åŠ¨(å®é™…å°±æ˜¯é“¾æ¥åˆ°: /etc/systemd/system/multi-user.target.wants)
systemctl enable nginx.service
# æŸ¥çœ‹æ˜¯å¦èƒ½å¼€æœºè‡ªå¯
systemctl is-enabled nginx.service
# ç¦æ­¢/å–æ¶ˆ æŸæœåŠ¡(å°±æ˜¯é“¾æ¥: /etc/systemd/system/nginx.service -&gt; /dev/null)
systemctl mask nginx.service
systemctl unmask nginx.service


</code></pre><ul>
<li>ç®¡ç†target units</li>
</ul>
<pre><code>runlevel0.target -&gt; poweroff.target
runlevel1.target -&gt; rescue.target
runlevel2.target -&gt; multi-user.target
runlevel3.target -&gt; multi-user.target
runlevel4.target -&gt; multi-user.target
runlevel5.target -&gt; graphical.target
runlevel6.target -&gt; reboot.target

åˆ‡æ¢çº§åˆ«: init N -&gt; systemctl isolate NAME.target

æŸ¥çœ‹çº§åˆ«: runlevel -&gt;  systemctl list-units -t target

è·å–é»˜è®¤è¿è¡Œçº§åˆ« : systemctl get-default
ä¿®æ”¹é»˜è®¤è¿è¡Œçº§åˆ« : systemctl set-default NAME.target

åˆ‡æ¢ç´§æ€¥æ•‘æ´æ¨¡å¼(çº§åˆ«1) : systemctl rescue
åˆ‡æ¢ç´§æ€¥emergencyæ¨¡å¼(ä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–è„šæœ¬) : systemctl emergency

å…³æœº: systemctl halt, systemctl powerof
é‡å¯: systemctl reboot
éª¨æ°”: systemctl suspend
å¿«ç…§: systemctl hybrid-sleep
å¿«ç…§å¹¶æŒ‚èµ·: systemctl hybrid-sleep
</code></pre><ul>
<li>service unit file</li>
</ul>
<pre><code>[Unit] : å®šä¹‰ä¸unitç±»å‹æ— å…³çš„é€šç”¨é€‰é¡¹, ç”¨äºæä¾›unitçš„æè¿°ä¿¡æ¯, unitçš„æ¬£æ…°åŠä¾èµ–å…³ç³»ç­‰
    Description : ä¼šæ˜¾ç¤ºåˆ°systemctl status ä¼šæ˜¾ç¤º
    After : å®šä¹‰å¯åŠ¨é¡ºåºå…³ç³»
    Wants : ä¾èµ–åˆ°çš„å…¶ä»–units(å¼±ä¾èµ–,ä¾èµ–ä¸å¯åŠ¨è‡ªå·±å¯ä»¥æ¿€æ´»)
    Requires : ä¾èµ–åˆ°çš„å…¶ä»–units(å¼ºä¾èµ–,ä¾èµ–ä¸å¯åŠ¨è‡ªå·±æ— æ³•æ¿€æ´»)
    BindsTo : ä¸Requiresç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ

[Service] : ä¸Serviceç›¸å…³çš„é€‰é¡¹
    Type : å®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚
        Type=simple : é»˜è®¤å€¼ï¼Œæ‰§è¡ŒExecStartæŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹
        Type=forking : ä»¥ fork æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º
        Type=oneshot : ä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
        Type=dbus : å½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨
        Type=notify : å½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥Systemdï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
        Type=idle : è‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ
    ExecStart : å¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤
    ExecStartPre : å¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
    ExecStartPost : å¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
    ExecReload : é‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
    ExecStop : åœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
    ExecStopPost : åœæ­¢å½“å…¶æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
    RestartSec : è‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°
    Restart : å®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬alwaysï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€on-successã€on-failureã€on-abnormalã€on-abortã€on-watchdog
    TimeoutSec : å®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°
    Environment : æŒ‡å®šç¯å¢ƒå˜é‡

[Install] : å®šä¹‰ç”±&quot;systemctl enable &quot; å’Œ&quot;disable&quot;å‘½ä»¤çš„æ—¶å€™ç”¨åˆ°
    WantedBy : å®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .wantsåç¼€æ„æˆçš„å­ç›®å½•ä¸­
    RequiredBy : å®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .requiredåç¼€æ„æˆçš„å­ç›®å½•ä¸­
    Alias : å½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å
    Also : å½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit

&gt; ä¿®æ”¹äº†unité…ç½®éœ€è¦æ‰§è¡Œ: systemctl daemon-reload
&gt; ç„¶åreloadæˆ–restart
</code></pre><h3 id="è¿ç»´å®‰å…¨">è¿ç»´å®‰å…¨<a href="#è¿ç»´å®‰å…¨" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>å®¢æˆ·ç«¯é€šè¿‡æµè§ˆå™¨è®¿é—®ç½‘é¡µæ—¶, å®¢æˆ·ç«¯ä¸éœ€è¦å‘ç»™æœåŠ¡ç«¯è¯ä¹¦, åªéœ€è¦éªŒè¯æœåŠ¡ç«¯çš„æ­£å¸¸(ä½†æ˜¯å¯¹äºç½‘é“¶æ”¯ä»˜å¯èƒ½ä¼šéœ€è¦å®‰è£…è¯ä¹¦,é“¶è¡Œè‡ªå·±çš„CA,æ¯”å¦‚uç›¾)


ssl : secure sockets layer  
    netscape 1994
    v1(æ²¡å…¬å¼€), v2(95å¹´,å¾ˆå¤šæ¼æ´), v3
tls : transport layer security
    ietf 1999
    v1.0 v1.1 v1.2 v1.3

sslä¼šè¯ä¸»è¦ä¸‰æ­¥
    1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ç´¢è¦å¹¶éªŒè¯è¯ä¹¦
    2. åŒæ–¹åå•†ç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
    3. åŒæ–¹é‡‡ç”¨&quot;ä¼šè¯å¯†é’¥&quot;è¿›è¡ŒåŠ å¯†é€šä¿¡

    ssl handshake protocol :
        ç¬¬ä¸€é˜¶æ®µ å®¢æˆ·ç«¯å‘é€client hello
             æ”¯æŒçš„åè®®ç‰ˆæœ¬, æ¯”å¦‚tls v1.2
             å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°, ç¨åç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
             æ”¯æŒçš„åŠ å¯†ç®—æ³•,æ¯”å¦‚AES(å¯¹ç§°åŠ å¯†ç®—æ³•),RSA(å…¬é’¥åŠ å¯†ç®—æ³•)
             æ”¯æŒçš„å‹ç¼©ç®—æ³•
        ç¬¬äºŒé˜¶æ®µ æœåŠ¡ç«¯å‘é€Server hello
            ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†é€šä¿¡åè®®ç‰ˆæœ¬, æ¯”å¦‚tls v1.2 ;
            æœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°, ç¨åç”Ÿæˆ&quot;ä¼šè¯å¯†é’¥&quot;
            ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†æ–¹æ³•, æ¯”å¦‚ RSA
            æœåŠ¡ç«¯å‘é€è¯ä¹¦
            [å¦‚æœéœ€è¦éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦,ä¼šç´¢è¦å®¢æˆ·ç«¯è¯ä¹¦...]
        ç¬¬ä¸‰é˜¶æ®µ:
            å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨è¯ä¹¦(å‘è¯æœºæ„,å®Œæ•´æ€§,æŒæœ‰è€…,æœ‰æ•ˆæœŸ,åŠé”€åˆ—è¡¨)
            å®¢æˆ·ç«¯å‘é€ä»¥ä¸‹ä¿¡æ¯ç»™æœåŠ¡ç«¯
                ä¸€ä¸ªéšæœºæ•°
                ç¼–ç å˜æ›´é€šçŸ¥,è¡¨ç¤ºéšåçš„ä¿¡æ¯å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹å¼å’Œå¯†é’¥å‘é€
                å®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥
        ç¬¬å››é˜¶æ®µ:
            æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ç»è¿‡pre-master-key æ··åˆå,è®¡ç®—ç”Ÿæˆæœ¬æ¬¡æ‰€å¾—åˆ°çš„çš„&quot;ä¼šè¯å¯†é’¥&quot;
            å‘å®¢æˆ·ç«¯å‘é€å¦‚ä¸‹ä¿¡æ¯
                ç¼–ç å˜æ›´é€šçŸ¥,è¡¨ç¤ºéšåçš„ä¿¡æ¯å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹å¼å’Œå¯†é’¥å‘é€
                æœåŠ¡ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥

PKI: å…¬é’¥åŸºç¡€è®¾æ–½
    ç­¾è¯æœºæ„ CA
    æ³¨å†Œæœºæ„ RA
    è¯ä¹¦åŠé”€åˆ—è¡¨ CRL
    è¯ä¹¦å­˜å–åº“

openssl
    ç»„ä»¶
        libcrypto,libssl,openssl

    openssl (å¤šå­å‘½ä»¤):
        Standard commands
        Message Digest commands (see the `dgst' command for more details)
        Cipher commands (see the `enc' command for more details)

    å¯¹ç§°åŠ å¯†
        å·¥å…·: openssl enc, gpg
        æ”¯æŒç®—æ³•: des3,aes,
        openssl enc å‘½ä»¤:
            åŠ å¯†è§£å¯†:
            # -e encode
            # -a base64 ç¼–ç 
            ~]# openssl enc -e -des3 -a  -in b  -out b.encode
            ~]# openssl enc -d -des3 -a  -in b.encode  -out b.decode
    å•å‘åŠ å¯†
        å·¥å…·: openssl dgst, md5sum,sha1sum,sha224sum...
        dgstå‘½ä»¤:
            ~]# md5sum b
                e6f443c6566d585113d137e0992d8391  b
            ~]# openssl dgst -md5 b
                MD5(b)= e6f443c6566d585113d137e0992d8391
    ç”Ÿæˆç”¨æˆ·å¯†ç :
        å·¥å…·: passwd, openssl passwd

        ~]# openssl passwd -1 -salt 123
            $1$123$ai3PKcU9Q7J3tIviFBaqN0
    éšæœºæ•°ç”Ÿæˆ
        å·¥å…· openssl rand
        ~]# openssl rand -base64 32
        ~]# openssl rand -hex 10
    å…¬é’¥åŠ å¯†:
        å·¥å…·: openssl rsautl, gpg
        åŠ å¯†è§£å¯†:
            ç®—æ³•: RSA , ELGamal
        æ•°å­—ç­¾å:
            ç®—æ³•: RSA, DSA, ELGamal
        å¯†é’¥äº¤æ¢
            ç®—æ³•: DH

        ç”Ÿæˆå¯†é’¥å¯¹:
            # æ”¾åˆ°æ‹¬å·ä»£è¡¨æ˜¯å­shellæ‰§è¡Œçš„, ä¸å½±å“å½“å‰shellçš„umask
            # umask 077 ä¼šè®©é»˜è®¤çš„644-077 =600æƒé™
            ç”Ÿæˆç§é’¥: ~]# (umask 077 ; openssl genrsa -out server.key 2048)
            æå–å…¬é’¥: ~]# openssl rsa -in server.key -pubout -out server.pub


linuxçš„éšæœºç”Ÿæˆå™¨:
    /dev/random : ä»…ä»ç†µæ± ä¸­è¿”å›éšæœºæ•°, éšæœºæ•°ç”¨å°½,(é˜»å¡)
    /dev/urandom : ä»…ä»ç†µæ± ä¸­è¿”å›éšæœºæ•°, éšæœºæ•°ç”¨å°½,ä¼šåˆ©ç”¨è½¯ä»¶ç”Ÿæˆä¼ªéšæœºæ•°,(éé˜»å¡,ä½†ä¸å®‰å…¨)
    ç†µæ±  :
        å†…æ ¸çš„ç©ºé—´
        æ¥æº:
            ç¡¬ç›˜IOä¸­æ–­æ—¶é—´é—´éš”
            é”®ç›˜IOä¸­æ–­æ—¶é—´é—´éš”

CA :
    å»ºç«‹ç§æœ‰CA:
        å·¥å…·: openssl, openca
    openssl :
        é…ç½®æ–‡ä»¶: /etc/pki/tls/openssl.cnf
        æ­¥éª¤:
            1. ç”Ÿæˆç§é’¥;
                ~]# (umask 077; openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)
            2. ç”Ÿæˆè‡ªç­¾è¯ä¹¦;
                # -new : ç”Ÿæˆæ–°è¯ä¹¦éƒ¨ç½²è¯·æ±‚
                # -x509 : ç”Ÿæˆè‡ªç­¾æ ¼å¼è¯ä¹¦,ä¸“ç”¨äºåˆ›å»ºç§æœ‰CA
                # -key : ç”Ÿæˆè¯·æ±‚ç”¨åˆ°çš„ç§æœ‰è·¯å¾„, ä¼šæå–å…¬é’¥
                # -out : ç”Ÿæˆçš„è¯·æ±‚æ–‡ä»¶è·¯å¾„, å¦‚æœæ˜¯è‡ªç­¾æ“ä½œå°†ç›´æ¥ç”Ÿæˆç­¾ç½²è¿‡çš„æ­£å¼
                ~]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650
            3. æä¾›CAæ‰€éœ€çš„ç›®å½•åŠæ–‡ä»¶:
                ~]# mkdir -p /etc/pki/CA/{certs,crl,newcerts}
                ~]# touch  /etc/pki/CA/{serial,index.txt}
                ~]# echo 01 &gt; /etc/pki/CA/serial
    è¦ç”¨åˆ°è¯ä¹¦è¿›è¡Œå®‰å…¨é€šä¿¡çš„æœåŠ¡å™¨, éœ€è¦å‘CAè¯·æ±‚ç­¾ç½²è¯ä¹¦:
        æ­¥éª¤
            1) ç”Ÿæˆç§é’¥:
                ~]# (umask 077; openssl genrsa -out /etc/nginx/ssl/server.key 2048)
            2) ç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚
                ~]# openssl req -new -key /etc/nginx/ssl/server.key -out /etc/nginx/ssl/server.csr -days 365

            3) åœ¨CAæœåŠ¡å™¨ç­¾ç½²è¯ä¹¦:
                ~]# openssl -ca in /etc/nginx/ssl/server.csr -out /etc/pki/CA/certs/server.crt -days 365

            4) æŸ¥çœ‹è¯ä¹¦çš„ä¿¡æ¯:
                ~]# openssl -x509 -in /etc/pki/CA/certs/server.crt -noout -serial -subject

</code></pre><h3 id="dns">DNS<a href="#dns" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="è¯´æ˜">è¯´æ˜<a href="#è¯´æ˜" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>DNS: Domain Name Service : åº”ç”¨å±‚åè®®
    C/S: 53/udp(è§£æ),53/tcp(åŒºåŸŸä¼ é€)
tld : TOP level domain

DNSåè§£ææ–¹å¼:
    åç§°-&gt; ip : æ­£å‘è§£æ
    ip -&gt; åç§°: åå‘è§£æ
    æ³¨æ„: äºŒè€…éåŒä¸€ç©ºé—´,éä¸ºåŒä¸€æ£µæ ‘,ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„å­˜å‚¨æ–¹å¼
DNS è§£æè¿‡ç¨‹:
    ä¾‹å¦‚: è¯·æ±‚www.baidu.com
        1. é¦–å…ˆå®¢æˆ·ç«¯ä¼šæŸ¥æ‰¾è‡ªå·±çš„hostæ–‡ä»¶,
        2. å¦‚æœhostæ²¡æœ‰, å°±è¯·æ±‚æœ¬åœ°ç¼“å­˜,
        3. å¦‚æœç¼“å­˜æ²¡æœ‰, å°±è¯·æ±‚/etc/resolv.confçš„dnsæœåŠ¡å™¨
            3.1 dnsæœåŠ¡å™¨æŸ¥æ‰¾è‡ªå·±çš„åŸŸæ˜¯å¦è´Ÿè´£,æ˜¯å¦èƒ½è§£æ
            3.2 dnsæœåŠ¡å™¨å¦‚æœä¸èƒ½è§£æ,åŒæ ·æŸ¥æ‰¾dnsæœ¬åœ°ç¼“å­˜,
            3.3 dnsæœ¬åœ°ç¼“å­˜ä¹Ÿæ‰¾ä¸åˆ°,å°±å»æ ¹åŸŸåæŸ¥æ‰¾-&gt;comæœåŠ¡å™¨-&gt;baiduæœåŠ¡å™¨-&gt;æ‰¾åˆ°www.baidu.com çš„è§£ææ¡ç›®
        4. /etc/resolv.confçš„dnsæœåŠ¡å™¨æ‹¿åˆ°è¯·æ±‚ä¹‹å,è¿”å›ç»™å®¢æˆ·ç«¯
</code></pre><blockquote>
<p>åå‘è§£ææ ‘:
<img src="/images/66/markdown-img-paste-20210628102440183.png" alt=""></p>
</blockquote>
<pre><code>~]# dig -x 114.114.114.114
114.114.114.114.in-addr.arpa. 524 IN	PTR	public1.114dns.com.
</code></pre><h4 id="åŸºç¡€">åŸºç¡€<a href="#åŸºç¡€" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>åŒºåŸŸ(zone)å’ŒåŸŸ(domain)
    åŒºåŸŸæ˜¯ç‰©ç†æ¦‚å¿µ, åŸŸæ˜¯é€»è¾‘æ¦‚å¿µ
    magedu.comåŸŸ:
        æ­£å‘è§£æåŒºåŸŸ
        åå‘è§£æåŒºåŸŸ
åŒºåŸŸæ•°æ®åº“æ–‡ä»¶
    èµ„æºè®°å½•  : Resource Record
        ç±»å‹ : A, AAAA, PTR, SOA , NS, CNAME, MX
        SOA : Start Of Authority ,èµ·å§‹æˆæƒè®°å½•;ä¸€ä¸ªåŒºåŸŸè§£æåº“åªèƒ½æœ‰ä¸€ä¸ªSOAè®°å½•,å¿…é¡»åœ¨ç¬¬ä¸€æ¡ (å²›å)
        NS  : Name Service , åŸŸåæœåŠ¡è®°å½•; å¯ä»¥æœ‰å¤šä¸ª(å²›ä¸»)
        A   : Address , åœ°å€è®°å½•, FQDN-&gt;IPv4 (32ä½)
        AAAA: Address FQDN-&gt;IPv6 (128ä½)
        CNAME: Canonical Name, åˆ«å
        PTR : Pointer, IP-&gt;FQDN
        MX  : Mail Exchanger, é‚®ä»¶äº¤æ¢å™¨,å¯ä»¥å¤šä¸ª
            ä¼˜å…ˆçº§: 0-99, æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜;

    èµ„æºè®°å½•çš„å®šä¹‰æ ¼å¼:
        åŸŸå: name [TTL] IN  RR_TYPE value
        SOA :
            name: å½“å‰åŒºåŸŸçš„åå­—; &quot;magedu.com.&quot; æˆ–è€…&quot;3.2.1.in-addr.arpa.&quot; (æœ€åä¸€ä¸ªç‚¹ä¸èƒ½å°‘);
            value: å¤šéƒ¨åˆ†
                1): å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°(ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸»DNSæœåŠ¡å™¨åç§°);
                2): å½“å‰åŒºåŸŸç®¡ç†çš„é‚®ç®±åœ°å€; ä½†åœ°å€ä¸­ä¸èƒ½ä½¿ç”¨@ç¬¦å·,ä¸€èˆ¬ä½¿ç”¨ç‚¹å·æ›¿ä»£
                3): (ä¸»ä»æœåŠ¡åè°ƒå±æ€§çš„å®šä¹‰ä»¥åŠå¦å®šç­”æ¡ˆçš„TTL)
                    ä¾‹å¦‚:
                        magedu.com. 86400 IN SOA magedu.com. admin.magedu.com. (
                            2017010801; serial åºåˆ—å·
                            2H ; refresh åˆ·æ–°æ—¶é•¿
                            10M ; retry é‡è¯•æ—¶é•¿
                            1w ; expire è¿‡æœŸæ—¶é•¿
                            1D ; negative answer ttl å¦å®šç­”æ¡ˆçš„ttl

                        )
        NS :
            name: å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°
            value: å½“å‰åŒºåŸŸçš„æŸDNSæœåŠ¡å™¨çš„åå­—, ä¾‹å¦‚ns.magedu.com. ;
                æ³¨æ„: ä¸€ä¸ªåŒºåŸŸå¯ä»¥æœ‰å¤šä¸ªnsè®°å½•
            ä¾‹å¦‚:
                magedu.com. 86400 IN NS ns1.magedu.com.
                magedu.com. 86400 IN NS ns2.magedu.com.
        MX:
            name : å½“å‰åŒºåŸŸçš„åŒºåŸŸåç§°
            value : å½“å‰åŒºåŸŸæŸé‚®ä»¶äº¤æ¢å™¨çš„ä¸»æœºå;
                æ³¨æ„: MXè®°å½•å¯ä»¥æœ‰å¤šä¸ª, æ¯ä¸ªè®°å½•çš„valueä¹‹å‰åº”è¯¥æœ‰ä¸€ä¸ªæ•°å­—, è¡¨ç¤ºä¼˜å…ˆçº§;
            ä¾‹å¦‚:
                magedu.com. 86400 IN MX 10 mx1.magedu.com.
                magedu.com. 86400 IN MX 20 mx2.magedu.com.
        A :
            name: æŸFQDN
            value: ipv4åœ°å€
            ä¾‹å¦‚:
                www.magedu.com. IN A 1.1.1.1
                                IN A 1.1.1.2 (å¯ä»¥çœç•¥www.magedu.com.)
        PTR :
            name : ipåœ°å€, ipåè¿‡æ¥å†™+.in-addr.arpa.
            value : FQDN
            ä¾‹å¦‚:
                4.3.2.1.in-addr.arpa. IN PTR www.magedu.com.
        CNAME:
            name: FQDNæ ¼å¼çš„åˆ«å
            value : FQDN
            ä¾‹å¦‚:
                web.magedu.com. IN CNAME www.magedu.com.

    æ³¨æ„:
        1) TTL å¯ä»¥ä»å…¨å±€ç»§æ‰¿;
        2) @è¡¨ç¤ºå½“å‰åŒºåŸŸçš„åç§°;
        3) ç›¸é‚»çš„ä¸¤ä¸ªè®°å½•å…¶nameç›¸åŒæ—¶ ç¬¬äºŒä¸ªå¯ä»¥çœç•¥
        4) å¯¹äºæ­£å‘åŒºåŸŸæ¥è¯´, MX,NSç­‰è®°å½•çš„valueä¸ºä¸€ä¸ªFQDN,æ­¤FQDNåº”è¯¥æœ‰ä¸€ä¸ªAè®°å½•
</code></pre><h4 id="bind">bind<a href="#bind" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>BIND: Berkeley Internet Name Domain ä¼¯å…‹åˆ©äº’è”ç½‘åç§°åŸŸ, ISCç»´æŠ¤
ç¨‹åºåŒ…:
    bind-libs: (yum info bind-libs) è¢«bindå’Œbind-utilsåŒ…ä¸­çš„ç¨‹åºå…±åŒç”¨åˆ°çš„;
    bind-utils : bind å®¢æˆ·ç«¯ç¨‹åºé›†, ä¾‹å¦‚: dig,host,nslookupç­‰;
    bind: æä¾›dns serverç¨‹åº, æµ‹è¯•ç¨‹åº;
    bind-chroot : é€‰è£…, è®©namedè¿è¡Œäºjailæ¨¡å¼ä¸‹
é…ç½®æ–‡ä»¶: rpm -lq bind|head -10
    ä¸»: /etc/named.conf
    å…¶ä»–:
        /etc/named.iscdlv.key
        /etc/named.rfc1912.zones
        /etc/named.root.key
    è§£æåº“æ–‡ä»¶:
        /var/namedç›®å½•ä¸‹:
            ä¸€èˆ¬åå­—ä¸º: ZONE_NAME.zone
        æ³¨æ„:
            1) å¯ä»¥é…ç½®å¤šä¸ªåŒºåŸŸæä¾›è§£æ
            2) æ ¹åŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.ca
            3) æ­£å‘è§£ælocalhoståŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.localhost
               åå‘è§£ælocalhoståŒºåŸŸè§£æåº“æ–‡ä»¶: /var/named/named.loopback
    rndc: remote name domain contoller
        127.0.0.1:953/tcp
    ä¸»é…ç½®æ–‡ä»¶æ ¼å¼:
        å…¨å±€é…ç½®æ®µ:
            options{...}
        æ—¥å¿—é…ç½®æ®µ
            logging{...}
        åŒºåŸŸé…ç½®æ®µ
            zone{...} : é‚£äº›ç”±æœ¬çº§è´Ÿè´£è§£æçš„åŒºåŸŸ, æˆ–è€…è½¬å‘çš„åŒºåŸŸ

            æ³¨æ„: æ¯ä¸ªé…ç½®è¯­å¥ å¿…é¡»åˆ†å·ç»“å°¾;

        ç¼“å­˜åç§°æœåŠ¡å™¨çš„é…ç½®:
            ç›‘å¬èƒ½ä¸å¤–éƒ¨ä¸»æœºé€šä¿¡çš„åœ°å€;
                listen-on port 53 { 172.16.76.220;127.0.0.1; };
            å­¦ä¹ æ—¶,å»ºè®®å…³é—­
                dnssec-enable no;
                dnssec-validation no;
                dnssec-lookaside no;
            å…³é—­ä»…å…è®¸æœ¬åœ°æŸ¥è¯¢:(æ³¨é‡Šä»¥ä¸‹å†…å®¹)
                allow-query     { localhost; };
        æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯:
            /usr/sbin/named-checkconf [/etc/named.conf]
        å¯åŠ¨:
            systemctl start named

        æµ‹è¯•å·¥å…·
            dig : dig [-t RR_TYPE] name [@SERVER] [query options]

                æŸ¥è¯¢é€‰é¡¹:
                    +[no]trace : è·Ÿè¸ªè§£æè¿‡ç¨‹
                    +[no]recurese : è¿›è¡Œé€’å½’è§£æ;

                    # è¿½è¸ªæŸ¥è¯¢è§£æçš„å…¨è¿‡ç¨‹
                    dig +trace -t A www.baidu.com
                æ³¨æ„: åå‘è§£ææµ‹è¯•
                    dig -x 140.205.41.17

                æ¨¡æ‹Ÿå®Œå…¨åŒºåŸŸä¼ é€:
                    dig -t axfr DOMAIN [@SERVER]
            host : host [-t RR_TYPE] name [SERVER]
            nslookup : nslookup [-options] [name] [server]
                &gt; äº¤äº’å¼
                &gt; server 114.114.114.114
                &gt; set q=A

            rndcå‘½ä»¤: named æœåŠ¡æ§åˆ¶å‘½ä»¤
                status : ç»Ÿè®¡
                flush  : æ¸…ç©ºç¼“å­˜
                reload [zone]


        é…ç½®è§£æä¸€ä¸ªæ­£å‘åŒºåŸŸ:
            1) å®šä¹‰åŒºåŸŸ:
                zone &quot;ZONE_NAME&quot; IN {
                    type {master|slave|hint|forward};    //ä¸»|ä»|è·Ÿ|è½¬å‘
                    file &quot;ZONE_NAME.zone&quot;;
                };

                ~]# tail -4 /etc/named.rfc1912.zones
                zone &quot;test.com&quot; IN {
                	type master;
                	file &quot;test.com.zone&quot;;
                };

                æ³¨æ„: åŒºåŸŸåå­—å³åŸŸå

            2) å»ºç«‹åŒºåŸŸæ•°æ®æ–‡ä»¶(/var/named, å†…å®¹ä¸»è¦æ˜¯Aè®°å½•)
                ~]# cat /var/named/test.com.zone
                $TTL 600
                $ORIGIN test.com.               //åé¢ç®€å†™çš„ç»“æœè‡ªåŠ¨è¿½åŠ è¯¥å†…å®¹
                @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                        2021062801 1H 10M 3D 1D )
                    IN NS    ns1                    // è¿™é‡Œå¯ä»¥ç®€å†™, ä¸èƒ½å¸¦.
                    IN NS    ns2.test.com.          // å¿…é¡»æœ€åä¸€ä½åŠ .
                    IN MX 10 mx1                    
                    IN MX 20 mx2.test.com.      
                ns1 IN A     172.16.76.220
                ns2 IN A     172.16.76.220
                mx1 IN A     172.16.76.220
                mx2 IN A     172.16.76.220
                www IN A     172.16.76.220
                web IN CNAME www

                ~]# chmod 640 test.com.zone
                ~]# chown :named test.com.zone
            3) æ£€æŸ¥zoneé…ç½®
                ~]# named-checkzone test.com /var/named/test.com.zone
                ~]# systemctl reload named

        é…ç½®è§£æä¸€ä¸ªåå‘åŒºåŸŸ:
            1) å®šä¹‰åŒºåŸŸ:
                zone &quot;ZONE_NAME&quot; IN {
                    type {master|slave|hint|forward};    //ä¸»|ä»|è·Ÿ|è½¬å‘
                    file &quot;ZONE_NAME.zone&quot;;
                };
                æ³¨æ„: åå‘åŸŸåçš„åå­—
                    åå†™çš„ç½‘æ®µåœ°å€: .in-addr.arpa
                    76.16.172.in-addr.arpa

            2) å»ºç«‹åŒºåŸŸæ•°æ®æ–‡ä»¶(/var/named, å†…å®¹ä¸»è¦æ˜¯Aè®°å½•)
            ~]# cat /var/named/172.16.76.zone
                $TTL 600
                $ORIGIN 76.16.172.in-addr.arpa.               //åé¢ç®€å†™çš„ç»“æœè‡ªåŠ¨è¿½åŠ è¯¥å†…å®¹
                @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                        2021062801 1H 10M 3D 1D )
                    IN NS    ns1                    // è¿™é‡Œå¯ä»¥ç®€å†™, ä¸èƒ½å¸¦.
                    IN NS    ns2.test.com.          // å¿…é¡»æœ€åä¸€ä½åŠ .
                220 IN PTR   ns1.test.com.  
                220 IN PTR   ns2.test.com.         

</code></pre><h4 id="bindä¸»ä»">bindä¸»ä»<a href="#bindä¸»ä»" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<blockquote>
<p>ä»…ä»…æ˜¯æŸä¸ªåŒºåŸŸçº§åˆ«ä½œä¸ºä»</p>
</blockquote>
<pre><code>å¦‚ä½•é…ç½®ä»åŒºåŸŸ:
  On Slave:
    1) å®šä¹‰åŒºåŸŸ;
        zone &quot;ZONE_NAME&quot; IN {
            type slave;
            file &quot;slaves/ZONE_NAME.zone&quot;;
            master { master_ip; };
        é…ç½®è¯­æ³•æ£€æŸ¥: named-checkconf
    2) é‡è½½
        rndc reload æˆ–è€…systemctl reload named
    }
  On Master :
    1) ç¡®ä¿åŒºåŸŸæ•°æ®æ–‡ä»¶ä¸­ ä¸ºæ¯ä¸ªä»æœåŠ¡å™¨é…ç½®NSè®°å½•,å¹¶ä¸”åœ¨æ­£å‘åŒºåŸŸæ–‡ä»¶ä¸­éœ€è¦é…ç½®NSè®°å½•çš„Aè®°å½•, ä¸”Aè®°å½•åœ°å€å°±æ˜¯ä»æœåŠ¡å™¨ip
            @   IN SOA @  mail.test.com. (    // @ ä»£è¡¨ test.com.
                2021062802 1H 10M 3D 1D )
                IN NS    ns2
            ns2 IN A     172.16.76.221

        &gt; åºåˆ—å·+1,æ”¹å˜äº†åºåˆ—å·, ä»åº“æ‰æ›´æ–°
    2) é‡è½½

æ‰‹å·¥ä¼ é€é…ç½®:( ä»172.16.76.220ä¸ŠåŒæ­¥é…ç½® )
    ~]# dig -t axfr test.com @172.16.76.220
</code></pre><h4 id="å­åŸŸæˆæƒ">å­åŸŸæˆæƒ<a href="#å­åŸŸæˆæƒ" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<blockquote>
<p>magedu.com -&gt; ops.magedu.com</p>
</blockquote>
<pre><code>æ­£å‘è§£æåŒºåŸŸæˆæƒå­åŸŸçš„æ–¹æ³•:
    ops.magedu.com.      IN NS ns1.ops.magedu.com.
    ns1.ops.magedu.com.  IN A  IPAddress1
    ops.magedu.com.      IN NS ns2.ops.magedu.com.
    ns2.ops.magedu.com.  IN A  IPAddress2

å®šä¹‰è½¬å‘:
    æ³¨æ„: è¢«è½¬å‘çš„æœåŠ¡å™¨, å¿…é¡»å…è®¸ä¸ºå½“å‰æœåŠ¡å™¨åšé€’å½’
    1) åŒºåŸŸè½¬å‘: ä»…è½¬å‘æŸç‰¹å®šåŒºåŸŸ
        zone &quot;ZONE_NAME&quot; {
            type forward;
            forward { first|only };
            forwarders { server_ip; };
        };

        first: é¦–å…ˆè½¬å‘,æ‰¾ä¸åˆ°, å°±è‡ªå·±å»è¿­ä»£æ‰¾æ ¹
        only: åªè½¬å‘,ä¸€èˆ¬æ˜¯å†…éƒ¨ä½¿ç”¨çš„åŸŸå

    2) å…¨å±€è½¬å‘: åªè¦ä¸æ˜¯è‡ªå·±çš„éƒ½è½¬å‘
        ç¼–è¾‘named.conf-&gt;options{
            forward only;
            forwarders { server_ip; }
        }
</code></pre><h4 id="bindä¸­çš„å®‰å…¨ç›¸å…³çš„é…ç½®">bindä¸­çš„å®‰å…¨ç›¸å…³çš„é…ç½®<a href="#bindä¸­çš„å®‰å…¨ç›¸å…³çš„é…ç½®" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>acl : è®¿é—®æ§åˆ¶åˆ—è¡¨; æŠŠä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€å½’å¹¶ä¸ºä¸€ä¸ªå‘½åçš„ç»“åˆ,éšåé€šè¿‡æ­¤åç§°å³å¯å¯¹æ­¤ç»“åˆå†…çš„æ‰€æœ‰ä¸»æœºç»Ÿä¸€è°ƒç”¨;
    é…ç½®æ–‡ä»¶: /etc/named.conf
    acl acl_name {
        ip;
        net/prelen;
    }
    ç¤ºä¾‹:
        acl mynet {
            172.16.0.0/16;
            192.168.0.1/24;
        }
bindå››ä¸ªå†…ç½®çš„acl
    none:
    any: ä»»æ„
    local: æœ¬æœº
    localnet : æœ¬æœºæ‰€åœ¨çš„ipæ‰€å±çš„ç½‘ç»œ
è®¿é—®æ§åˆ¶æŒ‡ä»¤:(options,zone)
    allow-query { mynet; }; å…è®¸æŸ¥è¯¢çš„ä¸»æœº; ç™½åå•
    allow-transfer { myslaves; }; å…è®¸å‘é‚£äº›ä¸»æœºåšåŒºåŸŸä¼ é€;é»˜è®¤æ˜¯æ‰€æœ‰; åº”è¯¥é…ç½®ä¸ºä»æœåŠ¡å™¨
    allow-recursion { mynet; }; å…è®¸å“ªäº›ä¸»æœºå‘å½“å‰dnsæœåŠ¡å™¨è¿›è¡Œé€’å½’æŸ¥è¯¢(recursion yes ä¼šä¿®æ”¹æˆå…è®¸æ‰€æœ‰)
    allow-update { none; }; DDNS,å…è®¸åŠ¨æ€æ›´æ–°åŒºåŸŸæ•°æ®åº“æ–‡ä»¶ä¸­çš„å†…å®¹;
</code></pre><h4 id="bind-view-">bind view :<a href="#bind-view-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>è§†å›¾:
    view VIEW_NAME {
        zone
        zone
    }
    # æ¯”å¦‚æ ¹æ®ip(ç”µä¿¡çš„),è®¿é—®è¯¥è§†å›¾
    view internal {
        match-clients { 172.16.0.0/8; };
        zone &quot;magedu.com&quot; IN {
            type master;
            file &quot;magedu.com/internal&quot;;
        };
    };
    # è§†å›¾ä¼šæŒ‰ç…§é…ç½®é¡ºåº,æ²¡æœ‰åŒ¹é…åˆ°çš„èµ°è¯¥è§†å›¾
    view external {
        match-cients { any; };
        zone &quot;magedu.com&quot; IN {
            type master;
            file &quot;magedu.com/external&quot;;
        };
    }
</code></pre><h3 id="httpåè®®">httpåè®®<a href="#httpåè®®" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="tcpåè®®çš„ç‰¹æ€§">TCPåè®®çš„ç‰¹æ€§<a href="#tcpåè®®çš„ç‰¹æ€§" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>å»ºç«‹è¿æ¥:
å°†æ•°æ®æ‰“åŒ…æˆæ®µ: æ ¡éªŒå’Œ(CRC32)
ç¡®è®¤,é‡ä¼ å’Œè¶…æ—¶:
æ’åº: é€»è¾‘åºå·
æµé‡æ§åˆ¶: æ»‘åŠ¨çª—å£win
æ‹¥å¡æ§åˆ¶: æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…ç®—æ³•
</code></pre><h4 id="http-hyper-text-transfer-protocol-æ–‡æœ¬åè®®">http: hyper text transfer protocol ,æ–‡æœ¬åè®®<a href="#http-hyper-text-transfer-protocol-æ–‡æœ¬åè®®" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>&gt; html: hyper text mark language è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€
&gt; css : Cascading style sheet
&gt; js : javascript, å®¢æˆ·ç«¯è„šæœ¬;

æ–‡æœ¬åè®®:  å°†å†…å®¹ç¼–ç æˆasciiä¼ è¾“, ä½†æ˜¯å¯¹äºå›¾ç‰‡ä½¿ç”¨æ–‡æœ¬åè®®ç›´æ¥ä¼ è¾“ä¼šä¹±ç 
åè®®ç‰ˆæœ¬:
    http/0.9 : åŸå‹ç‰ˆæœ¬,åŠŸèƒ½ç®€é™‹
        method : ä»…get
    http/1.0 : cache, MIME, method,
        MIME : Multipurpose Internet Mail Extesion  å¯ä»¥ä¼ è¾“éæ–‡æœ¬å†…å®¹,
        method : get, post, head, put, delete, trace , options
    http/1.1 : å¢å¼ºäº†ç¼“å­˜åŠŸèƒ½;
    SPDY     : Google
    http/2   : rfc

httpå·¥ä½œæ¨¡å¼:
    httpè¯·æ±‚æŠ¥æ–‡: request
    httpå“åº”æŠ¥æ–‡: response
        ä¸€æ¬¡httpäº‹åŠ¡: è¯·æ±‚ &lt;--&gt; å“åº”
    webèµ„æº: web resource
        é™æ€èµ„æº(æ— éœ€æœåŠ¡ç«¯åšå‡ºé¢å¤–å¤„ç†)
        åŠ¨æ€èµ„æº(æœåŠ¡ç«¯éœ€è¦é€šè¿‡æ‰§è¡Œç¨‹åºåšå‡ºå¤„ç†,è€Œåå‘é€ç»™å®¢æˆ·ç«¯çš„æ˜¯ç¨‹åºçš„è¿è¡Œç»“æœ)
    URI = URL+URN
    èµ„æºçš„æ ‡è¯†æœºåˆ¶: URL (Uniform Resource Locator)
</code></pre><h3 id="iptables-åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™">iptables: åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™<a href="#iptables-åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>5ä¸ªé’©å­:
    1. prerouting : åœ¨å…¥è·¯ç”±ä¹‹å‰
    2. å…¥route(ä¸¤ç§æƒ…å†µ)
        2.1 input: è·¯ç”±åˆ°æœ¬æœºçš„è¯·æ±‚
            2.1.1 output : æœ¬æœºè¯·æ±‚è¿”å›å‡ºå»çš„
        2.2 forward: è·¯ç”±è½¬å‘åˆ°å…¶ä»–æœºå™¨çš„è¯·æ±‚
    3. å‡ºroute
    4. postrouting : å‡ºè·¯ç”±ä¹‹å

-&gt; prerouting -&gt; route -&gt; input -&gt;  route -&gt; output -&gt;  postrouting -&gt;
                    \     -&gt;         forward        -&gt;      /



---&gt;[NF_IP_PRE_ROUTING]---&gt;[ROUTE]---&gt;[NF_IP_FORWARD]---&gt;[NF_IP_POST_ROUTING]---&gt;
                              |                        ^
                              |                        |
                              |                     [ROUTE]
                              v                        |
                       [NF_IP_LOCAL_IN]        [NF_IP_LOCAL_OUT]
                              |                        ^
                              |                        |
                              v                        |
</code></pre><blockquote>
<p>ä»¥ä¸‹å›¾å³è¾¹è·¯ç”±æœ‰ç‚¹é—®é¢˜, forward -&gt;postrouting,  output -&gt; postrouting</p>
</blockquote>
<p><img src="/images/66/markdown-img-paste-20210629112733417.png" alt=""></p>
<h4 id="ç†è®ºè¯´æ˜">ç†è®ºè¯´æ˜<a href="#ç†è®ºè¯´æ˜" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>Firewall:
    ä¸»æœºé˜²ç«å¢™ï¼š
    ç½‘ç»œé˜²ç«å¢™ï¼š

    è½¯ä»¶é˜²ç«å¢™(è½¯ä»¶é€»è¾‘)
    ç¡¬ä»¶é˜²ç«å¢™(ç¡¬ä»¶å’Œè½¯ä»¶é€»è¾‘)

iptables: ç½‘ç»œå±‚é˜²ç«å¢™
	iptables/netfilter

	ipfw --&gt; ipchains --&gt; iptables
		è®©ç”¨æˆ·ç¼–å†™è§„åˆ™

	netfilter: framework
		hook function
			PREROUTINGï¼šè·¯ç”±å‰
			INPUTï¼šåˆ°è¾¾æœ¬æœºå†…éƒ¨çš„æŠ¥æ–‡å¿…ç»ä¹‹è·¯
			FORWARDï¼šç”±æœ¬æœºè½¬å‘çš„æŠ¥æ–‡å¿…ç»ä¹‹è·¯
			OUTPUTï¼šç”±æœ¬æœºå‘å‡ºçš„æŠ¥æ–‡çš„å¿…ç»ä¹‹è·¯
			POSTROUTINGï¼šè·¯ç”±å

    è§„åˆ™çš„åŠŸèƒ½ï¼š
		raw, mangle, nat, filter

		filter: è¿‡æ»¤ï¼Œå®šä¹‰æ˜¯å¦å…è®¸é€šè¿‡é˜²ç«å¢™
		nat: åœ°å€è½¬æ¢ï¼Œå¯ç”¨connection_track;(ç›®çš„æ˜¯ä¸ºäº†éšè—å†…éƒ¨ä¸»æœº)
			SNAT æºåœ°å€è½¬æ¢
			DNAT ç›®æ ‡åœ°å€
			PNAT ç›®æ ‡ç«¯å£
		mangle: æ‹†è§£æŠ¥æ–‡,ä½œå‡ºä¿®æ”¹, é‡æ–°å°è£…
		raw: å…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªåŠŸèƒ½ï¼› è¿æ¥è¿½è¸ªè¡¨,

    è¡¨å’Œé“¾çš„å¯¹åº”å…³ç³»ï¼š
        raw: PREROUTING, OUTPUT
        mangle: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING
        nat: PREROUTINGï¼ˆSNATï¼‰ï¼ŒPOSTROUTINGï¼ˆDNATï¼‰ï¼Œ[INPUTï¼Œ] OUTPUT
        filter: INPUT, FORWARD, OUTPUT

    æ•°æ®æŠ¥æ–‡æµç¨‹ï¼š
        è·Ÿæœ¬æœºå†…éƒ¨è¿›ç¨‹é€šä¿¡ï¼š
            è¿›å…¥ï¼šPREROUTING, INPUT
            å‡ºå»ï¼šOUTPUT, POSTROUTING

        ç”±æœ¬æœºè½¬å‘ï¼š
            PREROUTING, FORWARD, POSTROUTING


        æ•°æ®æŠ¥æ–‡çš„æµå‘ï¼š
            æºIPå’Œç›®æ ‡IPç”±æµå‘å†³å®šï¼›
            æµå…¥æŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šPREROUTING --&gt; INPUT
            æµå‡ºæŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šOUTPUT --&gt; POSTROUTING
            è½¬å‘æŠ¥æ–‡ç»ç”±è·¯å¾„ï¼šPREROUTING --&gt; FORWARD --&gt; POSTROUTING

    æ€»ç»“ï¼šiptables/netfilter
        5ä¸ªé’©å­ï¼šç”Ÿæˆ5ä¸ªå†…ç½®é“¾
</code></pre><p><img src="/images/66/markdown-img-paste-20210629150606899.png" alt=""></p>
<h4 id="iptables-ä½¿ç”¨">iptables ä½¿ç”¨<a href="#iptables-ä½¿ç”¨" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p><img src="/images/66/markdown-img-paste-2021062917492962.png" alt=""></p>
<pre><code>
iptables: ç”¨æˆ·ç©ºé—´çš„å·¥å…·ï¼Œå†™è§„åˆ™ï¼Œå¹¶è‡ªåŠ¨å‘å¾€netfilterï¼Œç«‹å³ç”Ÿæ•ˆï¼› è§„åˆ™éƒ½æ˜¯å†™åœ¨é“¾ä¸Š
netfilter: æ¥æ”¶å¹¶ç”Ÿæ•ˆè§„åˆ™ï¼›

é“¾: é“¾ä¸Šçš„è§„åˆ™æ¬¡åº, å³ä¸ºæ£€æŸ¥çš„æ¬¡åº,å› æ­¤éšå«ä¸€å®šçš„åº”ç”¨æ³•åˆ™
    1) åŒç±»è§„åˆ™(è®¿é—®åŒä¸€åº”ç”¨), åŒ¹é…èŒƒå›´å°çš„æ”¾ä¸Šé¢
    2) ä¸åŒç±»è§„åˆ™(è®¿é—®ä¸åŒåº”ç”¨),åŒ¹é…åˆ°æŠ¥æ–‡é¢‘ç‡è¾ƒå¤§çš„æ”¾ä¸Šé¢
    3) å°†é‚£äº›å¯ç”±ä¸€æ¡è§„åˆ™æè¿°çš„å¤šä¸ªè§„åˆ™åˆå¹¶
    4) è®¾ç½®é»˜è®¤ç­–ç•¥

åŸºæœ¬è¯­æ³•ï¼š
    é«˜åº¦æ¨¡å—åŒ–,ç”±è¯¸å¤šæ‰©å±•æ¨¡å—å®ç°å…¶æ£€æµ‹æ¡ä»¶æˆ–å¤„ç†åŠ¨ä½œçš„å®šä¹‰
        rpm -ql iptables :
            ipv6: /usr/lib64/xtables/libip6t
            ipv4: /usr/lib64/xtables/libipt,/usr/lib64/xtables/libxt


    iptables [-t TABLE] COMMAND CHAIN  CRETIRIA -j TARGET
    Iptables [-t table] COMMAND chain [-m matchname [per-match-options]] - targetname [per-target-options]

    -t TABLE:
        nat, mangle, raw, filter
        é»˜è®¤ä¸ºfilter

    COMMAND: ç®¡ç†å‘½ä»¤
        é“¾ï¼š
            -Nï¼šnew, è‡ªå»ºä¸€æ¡é“¾
                iptables -N in_web_rules
            -X: delete, åˆ é™¤ä¸€æ¡è‡ªå®šä¹‰çš„ç©ºé“¾
                æ³¨æ„: ä»…èƒ½åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„ å¼•ç”¨è®¡æ•°ä¸º0çš„ç©ºçš„é“¾;
                iptables -X in_web_rules
            -Pï¼špolicyï¼Œè®¾ç½®é»˜è®¤ç­–ç•¥ï¼Œå¯¹filterè¡¨æ¥è®²ï¼Œé»˜è®¤è§„åˆ™ä¸ºACCEPTæˆ–DROPï¼›
            -Eï¼šé‡å‘½åè‡ªå®šä¹‰é“¾
                iptables -E in_web_rules in_web_rules2

        é“¾ä¸­çš„è§„åˆ™ï¼š
            -A: append è¿½åŠ 
            -I: insert æ’å…¥,æŒ‡æ˜ä½ç½®,çœç•¥è¡¨ç¤ºç¬¬ä¸€æ¡
            -D: delete
                1) æŒ‡å®šè§„åˆ™åºå·
                    iptables -D FORWARD 1
                2) æŒ‡å®šè§„åˆ™æœ¬èº«
            -R: replace
            -Fï¼šflush, æ¸…ç©ºè§„åˆ™é“¾ï¼›
            -Zï¼šzeroï¼Œè®¡æ•°å™¨å½’é›¶

        æŸ¥è¯¢ï¼š
            -L
                -n: æ•°å­—æ ¼å¼æ˜¾ç¤ºä¸»æœºåœ°å€å’Œç«¯å£ï¼›
                -v: è¯¦ç»†æ ¼å¼ï¼Œ-vv, -vvv
                --line-numbers: æ˜¾ç¤ºè§„åˆ™ç¼–å·

                    pkts bytes  target     prot opt in        out         source               destination
                    åŒ…æ•° å­—èŠ‚æ•°   ç›®æ ‡       åè®®  æµå…¥çš„æ¥å£  æµå‡ºçš„æ¥å£   æºåœ°å€               ç›®æ ‡åœ°å€

                -x: exactlyï¼Œä¸è¦å¯¹è®¡æ•°å™¨çš„è®¡æ•°ç»“æœåšå•ä½æ¢ç®—ï¼Œè€Œæ˜¾ç¤ºå…¶ç²¾ç¡®å€¼

                ä¾‹å¦‚:( Læ˜¯å‘½ä»¤, å¿…é¡»æ”¾åœ¨æœ€å, å…¶ä»–çš„æ˜¯ä¿®é¥°Lçš„)
                    iptables -n nat -nvxL --line-numbers
                    iptables -nxvL INPUT --line-numbers

    iptables [-t TABLE] -A é“¾å åŒ¹é…æ¡ä»¶ -j å¤„ç†ç›®æ ‡
        åŒ¹é…æ¡ä»¶ï¼š
            é€šç”¨åŒ¹é…: æ— éœ€åŠ è½½ä»»ä½•æ¨¡å—
                [!] -s åœ°å€ï¼šæŒ‡å®šæŠ¥æ–‡æºIPåœ°å€åŒ¹é…çš„èŒƒå›´ï¼›å¯ä»¥æ˜¯IPï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œåœ°å€ï¼›å¯ä½¿ç”¨!å–åï¼›
                    --src, --source
                [!] -d åœ°å€ï¼šæŒ‡å®šæŠ¥æ–‡ç›®æ ‡IPåœ°å€åŒ¹é…çš„èŒƒå›´ï¼›
                    --dst, --destination
                [!] -p åè®®ï¼šæŒ‡å®šåŒ¹é…æŠ¥æ–‡çš„åè®®ç±»å‹ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§tcp, udpå’Œicmp;
                [!] -i INTERFACE: æ•°æ®æŠ¥æ–‡æµå…¥çš„æ¥å£ï¼›PREROUTING, INPUT, FORWARD
                [!] -o INTERFACE: æ•°æ®æŠ¥æ–‡æµå‡ºçš„æ¥å£ï¼›OUTPUT, FORWARD, POSTROUITING

                ä¾‹å¦‚:
                    # è®¾ç½®é»˜è®¤åªèƒ½è¢«172.16.0.0/16 ç½‘æ®µè®¿é—®
                    iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -j ACCEPT
                    # è®¾ç½®é»˜è®¤åªèƒ½è®¿é—®172.16.0.0/16 ç½‘æ®µ
                    iptables -t filter -A OUTPUT -s 172.16.76.220 -d 172.16.0.0/16 -p tcp -j ACCEPT
                    # è®¾ç½®é»˜è®¤å…¥å£å’Œå‡ºå£ä¸ºDROP
                    iptables -P INPUT DROP
                    iptables -P OUTPUT DROP

                    # ä»…å…è®¸172.16.76.0/24 ç½‘æ®µping
                    iptables -A INPUT ! -s 172.16.76.0/24 -d 172.16.76.220 -p icmp -j DROP

            æ‰©å±•åŒ¹é…
                éšå¼æ‰©å±•ï¼šå½“ä½¿ç”¨-p {tcp|udp|icmp}ä¸­çš„ä¸€ç§æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ä¸“ç”¨é€‰é¡¹ï¼›
                    -p tcp:
                        [!] --sport PORT[-PORT]: æŒ‡å®šæºç«¯å£,å¯ä»¥æ˜¯èŒƒå›´
                        [!] --dport PORT[-PORT]: æŒ‡å®šç›®æ ‡ç«¯å£,å¯ä»¥æ˜¯èŒƒå›´
                        [!] --tcp-flags mask comp
                            ä¾‹å¦‚:
                                # ä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ¬¡: FIN=1,ACK=0,FIN=0,RST=0
                                &quot;--tcp-flags SYN,ACK,FIN,RST FIN&quot; : è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°å››ä¸ªè¡¨ç¤ºä½æ˜¯éœ€è¦æ£€æŸ¥çš„, ç¬¬äºŒä¸ªå‚æ•°FINåˆ™å¿…é¡»æ˜¯1
                        [!] --syn : å¸¸ç”¨,ç®€å†™; ç›¸å½“äº&quot;--tcp-flags SYN,ACK,FIN,RST FIN&quot;

                    -p udp:
                        [!] --sport
                        [!] --dport
                    -p icmp
                        [!] --icmp-type 8 : ping çš„è¯·æ±‚åŒ…
                        [!] --icmp-type 0 : ping çš„è¿”å›åŒ…

                        ä¾‹å¦‚:
                            # æˆ‘ä»¬æƒ³è¦è®©å±€åŸŸç½‘å¯ä»¥pingæœ¬æœº, ä½†æ˜¯ä¸å…è®¸æœ¬æœºpingå¤–ç½‘
                            #1. é¦–å…ˆåŠ ä¸Šç¦æ­¢è§„åˆ™
                            iptables -A INPUT -d 172.16.76.220 -p icmp -j REJECT
                            iptables -A OUTPUT -s 172.16.76.220 -p icmp -j REJECT
                            #2. é¦–å…ˆå…è®¸ æ¥æ”¶ --icmp-type 8 çš„è¯·æ±‚ (æ­¤æ—¶pingæ•°æ®åªèƒ½è¿›ä¸èƒ½å‡º)
                            iptables -I INPUT 1 -s 172.16.76.0/24 -d 172.16.76.220 -p icmp --icmp-type 8 -j ACCEPT
                            #3. å†å…è®¸å‡º
                            iptables -I OUTPUT 1 -s 172.16.76.220 -d 172.16.76.0/24 -p icmp --icmp-type 0 -j ACCEPT

                æ˜¾å¼æ‰©å±•(è£…å…¥æ¨¡å—)ï¼šå¿…é¡»æ˜ç¡®è¯´æ˜ä½¿ç”¨å“ªä¸ªæ¨¡å—è¿›è¡Œæ‰©å±•ï¼Œè€Œåæ‰èƒ½ä½¿ç”¨å…¶æ‰©å±•ä¸“ç”¨é€‰é¡¹ï¼›
                    -m æ‰©å±•æ¨¡å—åç§°

                    æ¨¡å—ï¼šiptablesï¼Œnetfilterå„æ‹¥æœ‰ä¸€éƒ¨åˆ†ä»£ç 

                    1. multiport: å¤šç«¯å£åŒ¹é…
                        å¯ç”¨äºåŒ¹é…éè¿ç»­æˆ–è¿ç»­ç«¯å£ï¼›æœ€å¤šæŒ‡å®š15ä¸ªç«¯å£ï¼›

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --source-ports, --sports port[,port,port:port]
                            [!] --destination-ports, --dports
                            [!] --ports

                        ä¾‹å­ï¼š
                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp -m multiport --dports 22,80 -j ACCEPT
                            ~]# iptables -I OUTPUT -s 172.16.100.7 -p tcp -m multiport --sports 22,80 -j ACCEPT
                            ~]# iptables -I INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp -m multiport --dports 30000:31000,22,80 -j ACCEPT

                    2. iprange: åŒ¹é…æŒ‡å®šèŒƒå›´å†…çš„åœ°å€ï¼›
                        åŒ¹é…ä¸€æ®µè¿ç»­çš„åœ°å€è€Œéæ•´ä¸ªç½‘ç»œæ—¶æœ‰ç”¨ï¼›

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --src-ragne IP[-IP]
                            [!] --dst-range

                        ~]# iptables -A INPUT -d 172.16.100.7 -p tcp --dport 23 -m iprange --src-range 172.16.100.1-172.16.100.100 -j ACCEPT
                        ~]# iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 23 -m iprange --dst-range 172.16.100.1-172.16.100.100 -j ACCEPT

                    3. time: åŸºäºæ—¶é—´åšè®¿é—®æ§åˆ¶
                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --datestart YYYY[-MM][-DD[Thh[:mm[:ss]]]]
                            --datestop

                            [!] --timestart hh:mm[:ss]
                            [!] --timestop hh:mm[:ss]

                            --weekdays day[,day]
                                Mon, Tue,
                            --kerneltz : ä½¿ç”¨å†…æ ¸é…ç½®çš„æ—¶åŒºè€Œéé»˜è®¤çš„UTC ;

                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -m time --timestart 08:20 --timestop 18:40 --weekdays Mon,Tue,Thu,Fri -j REJECT
                            ~]# iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -m time --timestart 08:20 --timestop 18:40 --weekdays 1,2,3,4,5 --kerneltz -j REJECT

                    4. string: å­—ç¬¦ä¸²åŒ¹é…ï¼Œèƒ½å¤Ÿæ£€æµ‹æŠ¥æ–‡åº”ç”¨å±‚ä¸­çš„å­—ç¬¦ä¸²
                        æ³¨æ„: åªèƒ½æ£€æµ‹æ˜æ–‡, å¯¹äºhttps,sshåè®®çš„ç¼–ç çš„æ— æ³•è¿‡æ»¤

                        å­—ç¬¦åŒ¹é…æ£€æŸ¥é«˜æ•ˆç®—æ³•
                            kmp, bm

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --algo {kmp|bm}
                            [!] --string &quot;STRING&quot;
                            [!] --hex-string &quot;HEX_STRING&quot;: HEX_STRINGä¸ºç¼–ç æˆ16è¿›åˆ¶æ ¼å¼çš„å­—ä¸²ï¼›

                        ~]# iptables -I OUTPUT -m string --algo kmp --string &quot;sex&quot; -j DROP

                    5. connlimit: è¿æ¥æ•°é™åˆ¶ï¼Œå¯¹æ¯IPæ‰€èƒ½å¤Ÿå‘èµ·å¹¶å‘è¿æ¥æ•°åšé™åˆ¶ï¼›
                        ä¸“ç”¨é€‰é¡¹ï¼š
                            [!] --connlimit-above [n] å¤§äºç­‰äº æ‹’ç»
                            [!] --connlimit-upto [n]  å°äºç­‰äºå…è®¸
                            ~]# iptables -I INPUT -d 172.16.76.220 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j DROP
                            ~]# iptables -R INPUT 1 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp --dport 22 -m connlimit --connlimit-upto 2 -j ACCEPT

                    6. limit: é€Ÿç‡é™åˆ¶; é™åˆ¶çš„æ˜¯æ¯ç§’çš„æŠ¥æ–‡

                        æ³¨æ„: ä»¤ç‰Œæ¡¶çš„æ–¹å¼é™åˆ¶é€Ÿç‡, æ¯”å¦‚å‘5ä¸ªä»¤ç‰Œ, æ‹¿ä¸€ä¸ªé€šè¿‡ä¸€ä¸ª,æ²¡æœ‰ä»¤ç‰Œäº†å°±é˜»å¡

                        ä¸“ç”¨é€‰é¡¹ï¼š
                            --limit n[/second|/minute|/hour|/day]
                            --limit-burst n

                        ä¾‹å­ï¼š
                        # iptables -A INPUT -d 172.16.76.220 -p icmp --icmp-type 8 -m limit --limit 20/minute --limit-burst 5 -j ACCEPT
                        # é™åˆ¶ æœ¬æœºæŸtcpæœåŠ¡æ¥æ”¶æ–°è¯·æ±‚çš„é€Ÿç‡: ä½¿ç”¨--syn + -m limit

                    7. state: çŠ¶æ€æ£€æŸ¥,è¿æ¥è¿½è¸ª
                        &gt; å†…æ ¸å†…å­˜ç©ºé—´ä¿å­˜ å®¢æˆ·ç«¯çš„è®¿é—®è®°å½•

						ä¸“ç”¨é€‰é¡¹ï¼š
							--state

						è¿æ¥è¿½è¸ªä¸­çš„çŠ¶æ€ï¼š
							NEW: æ–°å»ºç«‹ä¸€ä¸ªä¼šè¯(è·Ÿåè®®æ— å…³, å¯ä»¥è¿½è¸ªtcp,udp,icmp )
							ESTABLISHEDï¼šå·²å»ºç«‹çš„è¿æ¥
                            UNTRACKED: æœªè¿½è¸ªçš„
							RELATED: æœ‰å…³è”å…³ç³»çš„è¿æ¥
							INVALID: æ— æ³•è¯†åˆ«çš„è¿æ¥


						è°ƒæ•´è¿æ¥è¿½è¸ªåŠŸèƒ½æ‰€èƒ½å®¹çº³çš„è¿æ¥çš„æœ€å¤§æ•°ç›®ï¼š
							/proc/sys/net/nf_conntrack_max

						å½“å‰è¿½è¸ªçš„æ‰€æœ‰è¿æ¥
							/proc/net/nf_conntrack

						ä¸åŒåè®®æˆ–è¿æ¥ç±»å‹è¿½è¸ªæ—¶çš„å±æ€§ï¼š
							/proc/sys/net/netfilterç›®å½•ï¼š

						æ”¾è¡Œè¢«åŠ¨æ¨¡å¼ä¸‹çš„FTPæœåŠ¡ï¼š
							1ã€è£…è½½æ¨¡å—/lib/modules/KERNEL_VERSION/kernel/net/netfilter/
								æ¨¡å—ï¼šnf_conntrack_ftp
                                å‘½ä»¤: modprobe nf_conntrack_ftp

							2ã€æ”¾è¡Œè¯·æ±‚æŠ¥æ–‡ï¼š
							 	1ï¼‰æ”¾è¡ŒNEWçŠ¶æ€å¯¹21ç«¯å£è¯·æ±‚çš„æŠ¥æ–‡ï¼›
							 	2) æ”¾è¡ŒESTABLISHEDä»¥åŠRELATEDçŠ¶æ€çš„æŠ¥æ–‡

							 3ã€æ—…è¡Œå“åº”æŠ¥æ–‡ï¼š
							 	(1) æ”¾è¡ŒESTABLISHEDä»¥åŠRELATEDçŠ¶æ€çš„æŠ¥æ–‡

                        ä¾‹å¦‚:
                            ~]# iptables -A INPUT -d 172.16.76.220 -p tcp -m multiport --dports 22,8011,80,3306 -m state --state NEW -j ACCEPT
                            ~]# iptables -A INPUT -d 172.16.76.220 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
                            ~]# iptables -A OUTPUT -s 172.16.76.220 -m state --state ESTABLISHED,RELATED -j ACCEPT

        å¤„ç†åŠ¨ä½œ:
            åŸºæœ¬å¤„ç†åŠ¨ä½œ: ACCEPT, DROP
            æ‰©å±•å¤„ç†åŠ¨ä½œ: REJECT, RETURN , LOG, REDIRECT ,...
                REJECT:
                    --reject-with type
                    The type  given  can  be  icmp-net-unreachable,  icmp-host-unreachable,  icmp-port-unreachable,  icmp-proto-unreachable,  icmp-net-prohibited,icmp-host-prohibited,  or  icmp-admin-prohibited  (*), which return the appropriate ICMP error message (icmp-port-unreachable is the default).

                LOG :
                    --log-level
                    --log-prefix
                    é»˜è®¤æ—¥å¿—ä¿å­˜äº/var/log/message
                    ~]# iptables -R INPUT 1 -d 172.16.76.220 -p tcp ! --dport 22 -j LOG --log-prefix &quot;mylog &quot; --log-level 2
            ç”¨æˆ·è‡ªå®šä¹‰é“¾:

                ~]# iptables -N in_ping_rules
                ~]# iptables -A in_ping_rules -s 172.16.76.0/24 -d 172.16.76.220 -p icmp --icmp-type 8 -j ACCEPT
                ~]# iptables -A in_ping_rules  -d 172.16.76.220 -p icmp  -j REJECT
                ~]# iptables -A INPUT -d 172.16.76.220 -j in_ping_rules


    centos6:
        ä¿å­˜å¯ç”¨ä¸­çš„è§„åˆ™äºè§„åˆ™æ–‡ä»¶ä¸­ï¼š
                1ã€# iptables-save &gt; /etc/sysconfig/iptables
                2ã€# service iptables save

        ç”Ÿæ•ˆè§„åˆ™æ–‡ä»¶ä¸­çš„è§„åˆ™ï¼š
                1ã€# iptables-restore &lt; /etc/sysconfig/iptables
                2ã€# service iptables restart
                    æ‰§è¡Œçš„æ“ä½œï¼šæ¸…ç©ºç°æœ‰è§„åˆ™ï¼Œè¯»å–å¹¶ç”Ÿæ•ˆè§„åˆ™æ–‡ä»¶ä¸­çš„è§„åˆ™
    centos7:
        1) è‡ªå®šä¹‰unit file, è¿›è¡Œiptables-restore
        2) firewalldæœåŠ¡
        3) è‡ªå®šä¹‰è„šæœ¬

</code></pre><h4 id="ç»ƒä¹ ">ç»ƒä¹ <a href="#ç»ƒä¹ " class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>
ç»ƒä¹ ï¼šINPUTå’ŒOUTPUTé»˜è®¤ç­–ç•¥ä¸ºDROPï¼›

	1ã€é™åˆ¶æœ¬åœ°ä¸»æœºçš„webæœåŠ¡å™¨åœ¨å‘¨ä¸€ä¸å…è®¸è®¿é—®ï¼›æ–°è¯·æ±‚çš„é€Ÿç‡ä¸èƒ½è¶…è¿‡100ä¸ªæ¯ç§’ï¼›webæœåŠ¡å™¨åŒ…å«äº†adminå­—ç¬¦ä¸²çš„é¡µé¢ä¸å…è®¸è®¿é—®ï¼›webæœåŠ¡å™¨ä»…å…è®¸å“åº”æŠ¥æ–‡ç¦»å¼€æœ¬æœºï¼›
		iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m time --weekdays 2,3,4,5,6,7 -j ACCEPT  

        iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m state --state NEW -m limit --limit 100/second -j ACCEPT

        iptables -I INPUT -d 172.16.76.220 -p tcp -m multiport --dports 8011,80,443 -m string --algo kmp --string &quot;admin&quot; -j REJECT

        iptables -I OUTPUT -s 172.16.76.220 -tcp -m multiport --dports 8011,80,443 -m state --state ESTABLISHED,RELATED -j ACCEPT

	2ã€åœ¨å·¥ä½œæ—¶é—´ï¼Œå³å‘¨ä¸€åˆ°å‘¨äº”çš„8:30-18:00ï¼Œå¼€æ”¾æœ¬æœºçš„ftpæœåŠ¡ç»™172.16.0.0ç½‘ç»œä¸­çš„ä¸»æœºè®¿é—®ï¼›æ•°æ®ä¸‹è½½è¯·æ±‚çš„æ¬¡æ•°æ¯åˆ†é’Ÿä¸å¾—è¶…è¿‡5ä¸ªï¼›
        iptables -I  INPUT 3 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -m multiport --dports 21,1024:65535 -m time --timestart 8:30 --timestop 18:00 --kerneltz -j ACCEPT  

        iptables -I INPUT 4 -s 172.16.0.0/16 -d 172.16.76.220 -p tcp -m multiport --dports 1024: -m limit --limit 5/minute -j ACCEPT

	3ã€å¼€æ”¾æœ¬æœºçš„sshæœåŠ¡ç»™172.16.x.1-172.16.x.100ä¸­çš„ä¸»æœºï¼Œxä¸ºä½ çš„åº§ä½å·ï¼Œæ–°è¯·æ±‚å»ºç«‹çš„é€Ÿç‡ä¸€åˆ†é’Ÿä¸å¾—è¶…è¿‡2ä¸ªï¼›ä»…å…è®¸å“åº”æŠ¥æ–‡é€šè¿‡å…¶æœåŠ¡ç«¯å£ç¦»å¼€æœ¬æœºï¼›

        iptables -I INPUT -p tcp -m iprange --src-range 172.16.x.1-172.16.x.100 -m state --state NEW -m limit --limit 2/minute -j ACCEPT
        iptables -I OUTPUT -p tcp --sport 22 -j ACCEPT

	4ã€æ‹’ç»TCPæ ‡å¿—ä½å…¨éƒ¨ä¸º1åŠå…¨éƒ¨ä¸º0çš„æŠ¥æ–‡è®¿é—®æœ¬æœºï¼›
        iptales -I INPUT -d 172.16.76.220 -p tcp --tcp-flags SYN,ACK,FIN,RST SYN,ACK,FIN,RST  -j REJECT
        iptales -I INPUT -d 172.16.76.220 -p tcp --tcp-flags SYN,ACK,FIN,RST   -j REJECT

        [root@centos7 ~]#iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
        [root@centos7 ~]#iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP

	5ã€å…è®¸æœ¬æœºpingåˆ«çš„ä¸»æœºï¼›ä½†ä¸å¼€æ”¾åˆ«çš„ä¸»æœºpingæœ¬æœºï¼›

        iptables -I INPUT -p icmp --icmp-type 8 -j REJECT
        iptables -I INPUT -p icmp --icmp-type 0 -j ACCEPT  
        iptables -I OUTPUT  -p icmp --icmp-type 8 -j ACCEPT





	ç»ƒä¹ ï¼šåˆ¤æ–­ä¸‹è¿°è§„åˆ™çš„æ„ä¹‰ï¼š
	# iptables -N clean_in
        åˆ›å»ºè‡ªå®šä¹‰é“¾ clean_in
	# iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP
        è‡ªå®šä¹‰é“¾clean_in æœ€åä¸€è¡Œè¿½åŠ è§„åˆ™, ç¦æ­¢ç›®æ ‡åœ°å€æ˜¯255.255.255.255çš„icmpæŠ¥æ–‡
	# iptables -A clean_in -d 172.16.255.255 -p icmp -j DROP
        ç¦æ­¢ç›®æ ‡åœ°å€æ˜¯172.16.255.255çš„icmpæŠ¥æ–‡
	# iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP
        æ‰€æœ‰æ–°å»ºè¿æ¥ ä¸æ˜¯ä¸‰æ¬¡æ¡æ‰‹ç¬¬ä¸€æ¬¡çš„ éƒ½æ‹’ç»
	# iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP
        æ‹’ç»tcpæŠ¥æ–‡æ ‡å¿—ä½æ˜¯å…¨1çš„æŠ¥æ–‡
	# iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP
        æ‹’ç»tcpæŠ¥æ–‡æ ‡å¿—ä½æ˜¯å…¨0çš„æŠ¥æ–‡
	# iptables -A clean_in -d 172.16.100.7 -j RETURN
        ç›®æ ‡åœ°å€æ˜¯172.16.100.7çš„ç›´æ¥è¿”å›
	# iptables -A INPUT -d 172.16.100.7 -j clean_in
        ç›®æ ‡åœ°å€æ˜¯172.16.100.7 çš„åŒ¹é…è‡ªå®šä¹‰é“¾clean_inä¸­çš„è§„åˆ™

	# iptables -A INPUT  -i lo -j ACCEPT
        æœ¬åœ°å›ç¯ç½‘å¡è¾“å…¥è¯·æ±‚å…¨éƒ¨é€šè¿‡
	# iptables -A OUTPUT -o lo -j ACCEPT
        æœ¬åœ°å›ç¯ç½‘å¡è¾“å‡ºè¯·æ±‚å…¨éƒ¨é€šè¿‡


	# iptables -A INPUT  -i eth0 -m multiport -p tcp --dports 53,113,135,137,139,445 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 53,113,135,137,139,445ç«¯å£çš„tcpè¯·æ±‚å…¨éƒ¨æ‹’ç»
	# iptables -A INPUT  -i eth0 -m multiport -p udp --dports 53,113,135,137,139,445 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 53,113,135,137,139,445ç«¯å£çš„udpè¯·æ±‚å…¨éƒ¨æ‹’ç»
	# iptables -A INPUT  -i eth0 -p udp --dport 1026 -j DROP
        æœ¬åœ°eth0ç½‘å¡ 1026ç«¯å£çš„udpè¯·æ±‚æ‹’ç»
	# iptables -A INPUT  -p icmp -m limit --limit 10/second -j ACCEPT
        ä»…å…è®¸æ¯ç§’10æ¬¡çš„pingæŠ¥æ–‡
</code></pre><h4 id="å‘½ä»¤æ€»ç»“">å‘½ä»¤æ€»ç»“<a href="#å‘½ä»¤æ€»ç»“" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>iptables:
    [-t table ] COMMAND [chain] rule-specification
        -m matchname [per-match-options]
        -t targetname [per-target-options]
        [options]
    åŒ¹é…æ¡ä»¶ï¼š
    	åŸºæœ¬åŒ¹é…æ¡ä»¶ï¼š-sï¼Œ-dï¼Œ-pï¼Œ-m-ï¼Œ-æ‰©å±•åŒ¹é…æ¡ä»¶ï¼š
    		éšå¼æ‰©å±•ï¼š
    	 		-p tcp: --dport, --sport, -tcp-flags,--syn
    	 		-p udp:--dport,--sport
    	 		-p imcp:--icmp-type
    		æ˜¾å¼æ‰©å±•ï¼š
    	 		multiport: --sports, --dports
    	 		iprange: --src-range,-dst-range
    	 		time: -timestart, -timestop, --weekdays, -monthdays, --datestart,--datestop
    	 		string: --algo {bm kmp), --string
    	 		connlimit: --connlimit-upto, -connllimit-above
    	 		limit: --limit, --limit-burst
    	 		state: --state
    	 			NEW, ESTABLISHED, RELATED, INVALID, UNTRACKED

    Target:
    	-j:
    		ACCEPT/DROP
    		REJECT: --reject-with
    		LOG: --log-level, -log-prefix
            è‡ªå®šä¹‰é“¾
            RETURN
</code></pre><h4 id="iptables-forwardé“¾">iptables forwardé“¾<a href="#iptables-forwardé“¾" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p><img src="/images/66/markdown-img-paste-20210702134647247.png" alt=""></p>
<pre><code>iptalbes -A FORWARD -j REJECT
# å› ä¸ºforward åœ¨å…¥å’Œå‡ºéƒ½æ˜¯ç»è¿‡çš„é“¾è·¯
iptables -I FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT
iptables -I FORWARD -d 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT

#  é»˜è®¤è®¾ç½®å…è®¸å‡º
iptables -I FORWARD -m state --state ESTABLISHED -j ACCEPT
# å…è®¸ç½‘ç»œ 192.168.10.0/24 è®¿é—® (172.16.0.67) 80 ç«¯å£
iptables -I FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT
# å…è®¸ è®¿é—®192.168.10.2çš„80
iptables -I FORWARD -d 192.168.10.2 -p tcp --dprot 80 -m state --state NEW -j ACCEPT
</code></pre><h4 id="iptables-nat">iptables NAT<a href="#iptables-nat" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>ä¸ºäº†è§£å†³å†…ç½‘ipä¸æš´éœ²ç»™å¤–ç½‘
åŒäº‹è§£å†³äº†ipv4ä¸è¶³çš„é—®é¢˜

# SNAT : å®¢æˆ·ç«¯å‡ºå»çš„æ—¶å€™, è·¯ç”±ä¿®æ”¹æºipåœ°å€(ä¿æŠ¤å®¢æˆ·ç«¯çš„æœ¬åœ°ip)
# DNAT : æœåŠ¡ç«¯è¢«è¯·æ±‚çš„æ—¶å€™, æœåŠ¡ç«¯çš„è·¯ç”±ä¿®æ”¹æŠ¥æ–‡çš„ç›®çš„ip(ä¿æŠ¤æœåŠ¡ç«¯çš„å†…ç½‘ip)
# PAT  : ç«¯å£åœ°å€è½¬æ¢(æ›´å¤šæ˜¯ä¿®æ”¹ç›®æ ‡ç«¯å£)

DNAT æ˜¯åº”è¯¥åœ¨iptablesçš„å“ªä¸ªé“¾è·¯ä¿®æ”¹å‘¢?
æ¯”å¦‚ client =&gt; server -&gt; prerouting -&gt; router -&gt; input   âŒè¿™å°±ä¼šè·¯ç”±æœ¬æœºè¯·æ±‚äº†
                                |            \_&gt; forward âŒè¿™å°±æ˜¯ç›´æ¥è·¯ç”±äº†, åªæ˜¯ä¿®æ”¹macåœ°å€
                                 \_&gt; âœ… åœ¨pretouringçš„æ—¶å€™ä¿®æ”¹å°±å¯ä»¥äº†

SNAT åº”è¯¥æ˜¯åœ¨iptables  POSTROUTINGçš„æ—¶å€™ä¿®æ”¹


    SNAT
        --to-sourece è½¬åˆ°é™æ€ip
        --random  å®ç°è´Ÿè½½å‡è¡¡
        --persistent
    MASQUERADE (SNATåŠŸèƒ½, åŠ¨æ€ipçš„åœºæ™¯)
    DNAT
        --to-destination [addr:port] è½¬åˆ°é™æ€ip
        --random  å®ç°è´Ÿè½½å‡è¡¡
        --persistent
    REDIRECT
        --to-ports port

&gt; ä½†æ˜¯ç°åœ¨æˆ‘ä»¬éƒ½ä¸ä½¿ç”¨iptablesæ¥å®ç°äº†,æœ‰ä¸“é—¨çš„lvs

&gt; æ³¨æ„: è™½ç„¶è·¯ç”±å™¨ä¸Šæ²¡æœ‰ç›‘å¬å¯¹åº”çš„ç«¯å£æ¥è½¬å‘, ä½†æ˜¯å®ƒåœ¨å†…æ ¸å·²ç»å…·æœ‰äº†è½¬å‘åŠŸèƒ½, ä¸éœ€è¦åœ¨ç”¨æˆ·æ€å‡è£…å¼€å¯äº†æŸä¸ªç«¯å£ä½œä¸ºè½¬å‘

</code></pre><p><img src="/images/66/markdown-img-paste-20210702134647247.png" alt=""></p>
<pre><code># ä¾‹å­ éšè—å†…éƒ¨ç½‘ç»œå®¢æˆ·ç«¯ip -&gt; SNAT
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.0.6
</code></pre><p><img src="/images/66/markdown-img-paste-20210702143310515.png" alt=""></p>
<pre><code># ä¾‹å­ å› æ­¤å†…éƒ¨å¾€æ¥æœåŠ¡å™¨ip -&gt; DNAT
iptables -t nat -A PREROUTING -d 172.16.0.67 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.2
# æ­¤æ—¶å¦‚æœè¦æ‹’ç», ç”±äºdnatå·²ç»ä¿®æ”¹äº†ç›®æ ‡åœ°å€,æ‰€ä»¥-d ä¸æ˜¯172, è€Œæ˜¯192
iptables -A FORWARD -s 172.16.0.200 -p tcp --dport 80 -d 192.168.10.2 -j REJECT
</code></pre><h3 id="ioæ¨¡å‹">IOæ¨¡å‹<a href="#ioæ¨¡å‹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>I/Oæ¨¡å‹ï¼š
    æ¨¡å‹:
	   é˜»å¡å‹ã€ ä¸€èˆ¬ioé˜»å¡æ˜¯ä¸å¯ä¸­æ–­çš„çŠ¶æ€
       éé˜»å¡å‹ã€
       å¤ç”¨å‹ã€
       ä¿¡å·é©±åŠ¨å‹ã€
       å¼‚æ­¥

    ä¸€æ¬¡æ–‡ä»¶Oè¯·æ±‚ï¼Œéƒ½ä¼šç”±ä¸¤é˜¶æ®µç»„æˆï¼š
       ç¬¬ä¸€æ­¥ï¼šç­‰å¾…æ•°æ®ï¼Œå³æ•°æ®ä»ç£ç›˜åˆ°å†…æ ¸å†…å­˜(æ¶ˆè€—æ—¶é—´)
       ç¬¬äºŒæ­¥ï¼šå¤åˆ¶æ•°æ®ï¼Œå³æ•°æ®å†…æ ¸å†…å­˜åˆ°è¿›ç¨‹å†…å­˜

       æ³¨æ„:
           é˜»å¡å‹: ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ éƒ½æ˜¯é˜»å¡
           éé˜»å¡å‹: ç¬¬ä¸€æ­¥éé˜»å¡,ç¬¬äºŒæ­¥æ˜¯é˜»å¡

	åŒæ­¥/å¼‚æ­¥ï¼š
		å…³æ³¨æ¶ˆæ¯é€šçŸ¥æœºåˆ¶
		æ¶ˆæ¯é€šçŸ¥ï¼š
			åŒæ­¥ï¼šç­‰å¾…å¯¹æ–¹è¿”å›æ¶ˆæ¯
			å¼‚æ­¥ï¼šè¢«è°ƒç”¨è€…é€šè¿‡çŠ¶æ€ã€é€šçŸ¥æˆ–å›è°ƒæœºåˆ¶é€šçŸ¥è°ƒç”¨è€…è¢«è°ƒç”¨è€…çš„è¿è¡ŒçŠ¶æ€
	é˜»å¡/éé˜»å¡ï¼š
		å…³æ³¨è°ƒç”¨è€…åœ¨ç­‰å¾…ç»“æœè¿”å›ä¹‹å‰æ‰€å¤„çš„çŠ¶æ€
			é˜»å¡ï¼š blockingï¼Œè°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…è¢«æŒ‚èµ·
			éé˜»å¡ï¼š nonblockingï¼Œè°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…ä¸ä¼šè¢«æŒ‚èµ·

	å¤ç”¨å‹ioè°ƒç”¨ï¼š
        &gt; åœ¨ç‰¹æ®Šçš„ç»„ä»¶ä¸Šé˜»å¡,ioå¤ç”¨å™¨å¯ä»¥å¸®åŠ©æŸä¸ªç”¨æˆ·è¿›ç¨‹ç›‘æ§ioé˜»å¡, åªä¸è¿‡ä¸ä¼šé˜»å¡ç”¨æˆ·è¿›ç¨‹, é˜»å¡çš„ä½ç½®ä¸åŒ
 		select(): æœ€é«˜å¹¶å‘1024
 		poll():

        event-driven: (ä¿¡å·é©±åŠ¨å‹)
            epoll(linux): libevent
            kqueue(bsd)
            /dev/poll(solaris)
</code></pre><p><img src="/images/66/markdown-img-paste-2021070215362884.png" alt=""></p>
<h3 id="ç¼“å­˜">ç¼“å­˜<a href="#ç¼“å­˜" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>äºŒå…«æ¨¡å‹
ä½¿ç”¨çº¿ä¸Šæ•°æ®å…ˆå¯¹ç¼“å­˜è¿›è¡Œå‹æµ‹, ç­‰å¾…ç¼“å­˜æœåŠ¡å™¨warm up

ç¼“å­˜å‘½ä¸­ç‡
    é¡µé¢å‘½ä¸­ç‡
    å­—èŠ‚å‘½ä¸­ç‡
ç¼“å­˜ä¸å¦
    ç§æœ‰æ•°æ®
    å…¬å…±æ•°æ®
ç¼“å­˜æ¨¡å¼
    ä»£ç†å¼ç¼“å­˜:
        æœªå‘½ä¸­, ç¼“å­˜æœåŠ¡å™¨å»æ‰¾åç«¯RS
        http+ç¼“å­˜ (squid,varnish )
        squid å’Œvarnishçš„å…³ç³»å°±åƒ apache å’Œnginx
    æ—æŒ‚å¼ç¼“å­˜:
        æœªå‘½ä¸­, å®¢æˆ·ç«¯è‡ªå·±å»æ‰¾åç«¯RS
        ä¸“ç”¨ç¼“å­˜(memorycache,redis )


cache-response-directive =
      &quot;public&quot;                               
    | &quot;private&quot; [ &quot;=&quot; &lt;&quot;&gt; 1#field-name &lt;&quot;&gt; ]
    | &quot;no-cache&quot; [ &quot;=&quot; &lt;&quot;&gt; 1#field-name &lt;&quot;&gt; ] ,å¯ä»¥ç¼“å­˜,ä½†æ˜¯å“åº”ç»™å®¢æˆ·ç«¯ä¹‹å‰éœ€è¦è¯·æ±‚æœåŠ¡ç«¯æ¡ä»¶å¼éªŒè¯ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ,
    | &quot;no-store&quot;   , ä¸å…è®¸å­˜å‚¨å“åº”å†…å®¹äºç¼“å­˜ä¸­                         
    | &quot;no-transform&quot;                         
    | &quot;must-revalidate&quot; åŒ no-cache                     
    | &quot;proxy-revalidate&quot;                    
    | &quot;max-age&quot; &quot;=&quot; delta-seconds            
    | &quot;s-maxage&quot; &quot;=&quot; delta-seconds           
    | cache-extension            
</code></pre><p><img src="/images/66/markdown-img-paste-20210709182934970.png" alt=""></p>
<p><img src="/images/66/markdown-img-paste-20210709183834825.png" alt="">
<img src="/images/66/markdown-img-paste-20210709184000155.png" alt="">
<img src="/images/66/markdown-img-paste-20210709183933301.png" alt=""></p>
<h4 id="varnish">varnish<a href="#varnish" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<pre><code>æ“ä½œç¬¦:
    ==,!=,~,&gt;,&gt;=,&lt;,&lt;=
    é€»è¾‘ &amp;&amp;,||,!
    èµ‹å€¼ =

å†…å»ºå˜é‡
    req.*   : å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚æŠ¥æ–‡
        (be)req.http.*
            req.http.User-Agent ~ &quot;chrome&quot;
            req.http.Cookie
            (be)req.http.Reffer
            (be)req.http.HEADERS
        (be)req.request : è¯·æ±‚æ–¹æ³•
        (be)req.url  è¯·æ±‚url
        (be)req.proto
        (be)req.backend
    resp.*   : varnishå‘é€ç»™client
        (be)resp.http.HEADERS
        (be)resp.status
        (be)resp.backend.name backendä¸»æœºå
        (be)resp.ttl
        (be)resp.proto
    bereq.*  : ç”±varnishå‘ç»™backendä¸»æœºçš„httpdè¯·æ±‚
    beresp.* : ç”±backendå“åº”ç»™varnishçš„æŠ¥æ–‡
    obj.*    : ä¿å­˜åœ¨ç¼“å­˜ç©ºé—´çš„ç¼“å­˜å¯¹è±¡
        ojb.hits
        obj.ttl
    server.*
        server.ip
        server.hostname
    client.*
        client.ip
å†…å»ºå‡½æ•°
    regsub(str,regex,sub)
    regsuball(str,regex,sub)
    ban(boolean expression)
    hash_data(input)
client side :
    vcl_deliver: ç›´æ¥å‘é€å®¢æˆ·ç«¯
    vcl_pipe: æ²¡æœ‰åŒ¹é…åˆ°çš„è§„åˆ™
    vcl_pass:

</code></pre><ul>
<li>
<p>å†…ç½®å˜é‡æ˜¯å¦å¯ä»¥ä¿®æ”¹
<img src="/images/66/markdown-img-paste-20210712110939380.png" alt=""></p>
</li>
<li>
<p>ç¤ºä¾‹1 obj.hits å†…å»ºå˜é‡</p>
</li>
</ul>
<pre><code>sub vcl_deliver {
    if (obj.hits &gt; 0 ) {
        set resp.http.X-cache = &quot;Hit via &quot;+server.ip;
        set resp.http.X-hit-count =  &quot;Hit &quot;+obj.hits ;
    } else {
        set resp.http.X-cache = &quot;Miss from &quot;+server.ip;
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹2 æ˜¯å¦åŒºåˆ†å¤§å°å†™</li>
</ul>
<pre><code>sub vcl_recv {
    # ç¦ç”¨curlè¯·æ±‚
    if (req.http.User-Agent ~ &quot;(?i)curl&quot;) {
		return(synth(403));
	}
    # loginæˆ–è€…adminå¼€å¤´çš„ä¸ç¼“å­˜
    if (req.url ~ &quot;(?i)^/(login|admin)&quot; ) {
    		return(pass);
    	}
}

</code></pre><ul>
<li>ç¤ºä¾‹3 ç‰¹å®šç±»å‹çš„èµ„æº,ä¾‹å¦‚å…¬å¼€çš„å›¾ç‰‡ç­‰,å–æ¶ˆå…¶ç§æœ‰æ ‡è¯†,å¹¶å¼ºè¡Œè®¾å®šå…¶å¯ä»¥ç”±varnishç¼“å­˜çš„æ—¶é•¿</li>
</ul>
<pre><code>sub vcl_backend_response {
    if (beresp.http.Cache-Control !~ &quot;(?i)s-maxage&quot;) {
        if (bereq.url ~ &quot;(?i)\.(jpg|jpeg|png|gif|css|js)&quot;) {
            unset beresp.http.Set-Cookie ;
            set beresp.ttl = 3600s;
        }
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹4 é€ä¼ çœŸå®å®¢æˆ·ç«¯ip</li>
</ul>
<pre><code>#
sub vcl_recv {
    # æ˜¯å¦æ˜¯æ–°è¿æ¥
    if (req.restarts == 0) {
        if (req.http.X-Fowarded-For) {
            set req.http.X-Forwarded-For = req.http.X-Forwarded-For + &quot;,&quot;+client.ip;
        }else {
            set req.http.X-Forwarded-For = client.ip;
        }
    }
}
</code></pre><ul>
<li>ç¤ºä¾‹5 æ¸…ç†ç¼“å­˜,ä¿®å»ºæ–¹å¼</li>
</ul>
<blockquote>
<p><a href="https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html">https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html</a></p>
</blockquote>
<ul>
<li>purgeé…ç½®</li>
</ul>
<pre><code>#å®šä¹‰å…è®¸æ¸…ç†ç¼“å­˜çš„IP
acl purgeip {
    &quot;127.0.0.1&quot;;
    &quot;localhost&quot;;
    &quot;10.10.53.197&quot;;
}

sub vcl_recv {
     #åŒ¹é…æ¸…ç†ç¼“å­˜çš„è¯·æ±‚
     if (req.method == &quot;PURGE&quot;) {
        #å¦‚æœå‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯IP ä¸æ˜¯åœ¨acl purgeé‡Œé¢å®šä¹‰çš„ å°±æ‹’ç»
         if (client.ip ~ purgeip) {
	            return (purge);  #æ¸…é™¤ç¼“å­˜
         }
         return (synth(405, &quot;This IP is not allowed to send PURGE requests.&quot;));
     }
sub vcl_purge {
     return (synth(200, &quot;Purged&quot;));
}

# æµ‹è¯•
curl -X PURGE http://xxx
</code></pre><ul>
<li>banningé…ç½®</li>
</ul>
<pre><code>1. å‘½ä»¤è¡Œæ‰§è¡Œ(ä¸´æ—¶æ‰¹é‡æ“ä½œ)
# æ¸…ç†^/javascriptçš„ç¼“å­˜
ban req.url ~ ^/javascript
# è¯·æ±‚ .jsç»“å°¾çš„ç¼“å­˜
ban req.url ~ .js$

2. å†™å…¥åˆ°é…ç½®æ–‡ä»¶,ä½¿ç”¨ban() å‡½æ•°
sub vcl_recv {
    if (req.method == &quot;BAN&quot;) {
        ban(&quot;req.http.host == &quot; + req.http.host + &quot; &amp;&amp; req.url == &quot; + req.url);
        # Throw a synthetic page so the request won't go to the backend.
        return(synth(200, &quot;Ban added&quot;));
    }
}
# ç„¶åæ‰§è¡Œå‘½ä»¤
# æ¸…ç†http://www.ngirl.xyz/javascript çš„æ‰€æœ‰ç¼“å­˜
ban req.http.host == &quot;www.ngirl.xyz&quot; &amp;&amp; req.url == &quot;/javascript&quot;

</code></pre><ul>
<li>é…ç½®å¤šä¸ªåç«¯æœåŠ¡å™¨</li>
</ul>
<pre><code>backend imgsrv1 {
    .host = &quot;192.168.0.11&quot;;
    .port = &quot;80&quot;;
}
backend imgsrv2 {
    .host = &quot;192.168.0.12&quot;;
    .port = &quot;80&quot;;
}
backend appsrv1 {
    .host = &quot;192.168.0.111&quot;;
    .port = &quot;80&quot;;
}
backend appsrv2 {
    .host = &quot;192.168.0.112&quot;;
    .port = &quot;80&quot;;
}
sub vcl_init {
    new imgsrvs = directors.random();
    imgsrvs.add_backend(imgsrv1,10);
    imgsrvs.add_backend(imgsrv2,10);

    new appsrvs = directors.round_robin();
    imgsrvs.add_backend(appsrv1);
    imgsrvs.add_backend(appsrv2);

    ...
}

sub vcl_recv {
    if (req.url ~ &quot;(?i)\.(js|css)$&quot;) {
        set req.backend_hint = staticksrv.backend();
    }
    if (req.url ~ &quot;(?i)\.(jpg|jpeg|png|gif)&quot;) {
        set req.backend_hint = imgsrvs.backend();
    } else {
        set req.backend_hint = appsrvs.backend();
    }
}
</code></pre><ul>
<li>åŸºäºcookieçš„session sticky</li>
</ul>
<pre><code>sub vcl_init {
    new h = directors.hash();
    h.add_backend(one, 1);   // backend 'one' with weight '1'
    h.add_backend(two, 1);   // backend 'two' with weight '1'
}

sub vcl_recv {
    // pick a backend based on the cookie header of the client
    set req.backend_hint = h.backend(req.http.cookie);
}
</code></pre><ul>
<li>å®˜æ–¹ç¤ºä¾‹åœ°å€</li>
</ul>
<ul>
<li><a href="https://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html">é…ç½®ç¼“å­˜ä¿®å‡</a></li>
<li><a href="https://book.varnish-software.com/4.0/chapters/Saving_a_Request.html">é…ç½®å¤šä¸ªåç«¯æœåŠ¡å™¨</a></li>
</ul>

			</div>
   

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.ngirl.xyz/tags/linux">linux</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>5026 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-03-31 10:47 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc" class="show-toc">
			<div class="toc-title">â†’Linuxè®¡ç®—æœºåŸºç¡€â†</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€</a>
      <ul>
        <li><a href="#è¿›ç¨‹">è¿›ç¨‹</a></li>
        <li><a href="#ç½‘ç»œå®¢æˆ·ç«¯">ç½‘ç»œå®¢æˆ·ç«¯</a></li>
        <li><a href="#linuxå†…æ ¸">Linuxå†…æ ¸</a></li>
        <li><a href="#è¿ç»´å®‰å…¨">è¿ç»´å®‰å…¨</a></li>
        <li><a href="#dns">DNS</a></li>
        <li><a href="#httpåè®®">httpåè®®</a></li>
        <li><a href="#iptables-åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™">iptables: åŒ…è¿‡æ»¤å‹çš„é˜²ç«å¢™</a></li>
        <li><a href="#ioæ¨¡å‹">IOæ¨¡å‹</a></li>
        <li><a href="#ç¼“å­˜">ç¼“å­˜</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.ngirl.xyz/posts/67-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>ç½‘ç»œåŸºç¡€</span>
			</a>
			<a class="prev-post" href="https://www.ngirl.xyz/posts/65-docker%E9%83%A8%E7%BD%B2jira8%E5%85%A8%E5%AE%B6%E6%A1%B6%E7%A0%B4%E8%A7%A3/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Dockeréƒ¨ç½²jira8å…¨å®¶æ¡¶ç ´è§£</span>
			</a>
		</div>
		<div id="comments" class="thin">
						<script src="https://utteranc.es/client.js"
							repo="zhangzw001/blog-hugo"
							issue-term="pathname"
							theme="github-light"
							crossorigin="anonymous"
							async>
			</script>

		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 - 2022 <a href="https://www.ngirl.xyz">zhangzw</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.ngirl.xyz/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.ngirl.xyz/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-180942795-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
